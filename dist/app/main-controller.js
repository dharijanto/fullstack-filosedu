"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),sequelize_service_1=require("../services/sequelize-service"),path=require("path");let express=require("express"),getSlug=require("speakingurl"),log=require("npmlog"),marked=require("marked"),moment=require("moment-timezone"),AppConfig=require(path.join(__dirname,"../app-config")),BaseController=require(path.join(__dirname,"controllers/base-controller")),CourseController=require(path.join(__dirname,"controllers/course-controller")),CredentialController=require(path.join(__dirname,"controllers/credential-controller")),ExerciseController=require(path.join(__dirname,"controllers/exercise-controller")),SubtopicController=require(path.join(__dirname,"controllers/subtopic-controller")),SyncController=require(path.join(__dirname,"controllers/sync-controller")),PassportManager=require(path.join(__dirname,"../lib/passport-manager"));const TAG="FiloseduAppController";class Controller extends BaseController{constructor(e){super(e),PassportManager.initialize(),moment.tz.setDefault("UTC"),this.addInterceptor((e,r,o)=>{log.verbose(TAG,"req.path="+e.path),log.verbose(TAG,"loggedIn="+e.isAuthenticated()),log.verbose(TAG,"req.on="+JSON.stringify(e.session)),log.verbose(TAG,"req.headers.cookie="+JSON.stringify(e.headers.cookie)),r.locals.marked=marked,r.locals.getSlug=getSlug,r.locals.site=e.site,r.locals.user=e.user,r.locals.loggedIn=e.isAuthenticated(),r.locals.cloudServer=AppConfig.CLOUD_SERVER,o()}),sequelize_service_1.default.initialize(this.getDb().sequelize,this.getDb().models),this.credentialController=new CredentialController(e),this.exerciseController=new ExerciseController(e),this.courseController=new CourseController(e),this.subtopicController=new SubtopicController(e),this.syncController=new SyncController(e),this.routeUse(AppConfig.VIDEO_MOUNT_PATH,express.static(AppConfig.VIDEO_PATH,{maxAge:"1h"})),this.routeUse(AppConfig.IMAGE_MOUNT_PATH,express.static(AppConfig.IMAGE_PATH,{maxAge:"1h"})),this.routeUse(this.credentialController.getRouter()),this.routeUse(this.exerciseController.getRouter()),this.routeUse(this.courseController.getRouter()),this.routeUse(this.subtopicController.getRouter()),this.routeUse(this.syncController.getRouter())}initialize(){return Promise.join(this.credentialController.initialize(),this.courseController.initialize(),this.subtopicController.initialize(),this.exerciseController.initialize(),this.syncController.initialize())}}module.exports=Controller;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbWFpbi1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwic2VxdWVsaXplX3NlcnZpY2VfMSIsInBhdGgiLCJleHByZXNzIiwiZ2V0U2x1ZyIsImxvZyIsIm1hcmtlZCIsIm1vbWVudCIsIkFwcENvbmZpZyIsImpvaW4iLCJfX2Rpcm5hbWUiLCJCYXNlQ29udHJvbGxlciIsIkNvdXJzZUNvbnRyb2xsZXIiLCJDcmVkZW50aWFsQ29udHJvbGxlciIsIkV4ZXJjaXNlQ29udHJvbGxlciIsIlN1YnRvcGljQ29udHJvbGxlciIsIlN5bmNDb250cm9sbGVyIiwiUGFzc3BvcnRNYW5hZ2VyIiwiVEFHIiwiQ29udHJvbGxlciIsIltvYmplY3QgT2JqZWN0XSIsImluaXREYXRhIiwic3VwZXIiLCJpbml0aWFsaXplIiwidHoiLCJzZXREZWZhdWx0IiwidGhpcyIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsInZlcmJvc2UiLCJpc0F1dGhlbnRpY2F0ZWQiLCJKU09OIiwic3RyaW5naWZ5Iiwic2Vzc2lvbiIsImhlYWRlcnMiLCJjb29raWUiLCJsb2NhbHMiLCJzaXRlIiwidXNlciIsImxvZ2dlZEluIiwiY2xvdWRTZXJ2ZXIiLCJDTE9VRF9TRVJWRVIiLCJkZWZhdWx0IiwiZ2V0RGIiLCJzZXF1ZWxpemUiLCJtb2RlbHMiLCJjcmVkZW50aWFsQ29udHJvbGxlciIsImV4ZXJjaXNlQ29udHJvbGxlciIsImNvdXJzZUNvbnRyb2xsZXIiLCJzdWJ0b3BpY0NvbnRyb2xsZXIiLCJzeW5jQ29udHJvbGxlciIsInJvdXRlVXNlIiwiVklERU9fTU9VTlRfUEFUSCIsInN0YXRpYyIsIlZJREVPX1BBVEgiLCJtYXhBZ2UiLCJJTUFHRV9NT1VOVF9QQVRIIiwiSU1BR0VfUEFUSCIsImdldFJvdXRlciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFBQSxNQUFBQSxRQUFBQyxRQUFBLFlBQ0FDLG9CQUFBRCxRQUFBLGlDQUVNRSxLQUFPRixRQUFRLFFBRXJCLElBQUlHLFFBQVVILFFBQVEsV0FDbEJJLFFBQVVKLFFBQVEsZUFDbEJLLElBQU1MLFFBQVEsVUFDZE0sT0FBU04sUUFBUSxVQUNqQk8sT0FBU1AsUUFBUSxtQkFFakJRLFVBQVlSLFFBQVFFLEtBQUtPLEtBQUtDLFVBQVcsa0JBQ3pDQyxlQUFpQlgsUUFBUUUsS0FBS08sS0FBS0MsVUFBVyxnQ0FDOUNFLGlCQUFtQlosUUFBUUUsS0FBS08sS0FBS0MsVUFBVyxrQ0FDaERHLHFCQUF1QmIsUUFBUUUsS0FBS08sS0FBS0MsVUFBVyxzQ0FDcERJLG1CQUFxQmQsUUFBUUUsS0FBS08sS0FBS0MsVUFBVyxvQ0FDbERLLG1CQUFxQmYsUUFBUUUsS0FBS08sS0FBS0MsVUFBVyxvQ0FDbERNLGVBQWlCaEIsUUFBUUUsS0FBS08sS0FBS0MsVUFBVyxnQ0FDOUNPLGdCQUFrQmpCLFFBQVFFLEtBQUtPLEtBQUtDLFVBQVcsNEJBRW5ELE1BQU1RLElBQU0sOEJBRVpDLG1CQUF5QlIsZUFDdkJTLFlBQWFDLEdBQ1hDLE1BQU1ELEdBQ05KLGdCQUFnQk0sYUFHaEJoQixPQUFPaUIsR0FBR0MsV0FBVyxPQUVyQkMsS0FBS0MsZUFBZSxDQUFDQyxFQUFLQyxFQUFLQyxLQUM3QnpCLElBQUkwQixRQUFRYixJQUFLLFlBQWNVLEVBQUkxQixNQUNuQ0csSUFBSTBCLFFBQVFiLElBQUssWUFBY1UsRUFBSUksbUJBQ25DM0IsSUFBSTBCLFFBQVFiLElBQUssVUFBWWUsS0FBS0MsVUFBVU4sRUFBSU8sVUFDaEQ5QixJQUFJMEIsUUFBUWIsSUFBSyxzQkFBd0JlLEtBQUtDLFVBQVVOLEVBQUlRLFFBQVFDLFNBQ3BFUixFQUFJUyxPQUFPaEMsT0FBU0EsT0FDcEJ1QixFQUFJUyxPQUFPbEMsUUFBVUEsUUFDckJ5QixFQUFJUyxPQUFPQyxLQUFPWCxFQUFJVyxLQUN0QlYsRUFBSVMsT0FBT0UsS0FBT1osRUFBSVksS0FDdEJYLEVBQUlTLE9BQU9HLFNBQVdiLEVBQUlJLGtCQUMxQkgsRUFBSVMsT0FBT0ksWUFBY2xDLFVBQVVtQyxhQUNuQ2IsTUFFRjdCLG9CQUFBMkMsUUFBaUJyQixXQUFXRyxLQUFLbUIsUUFBUUMsVUFBV3BCLEtBQUttQixRQUFRRSxRQUVqRXJCLEtBQUtzQixxQkFBdUIsSUFBSW5DLHFCQUFxQlEsR0FDckRLLEtBQUt1QixtQkFBcUIsSUFBSW5DLG1CQUFtQk8sR0FDakRLLEtBQUt3QixpQkFBbUIsSUFBSXRDLGlCQUFpQlMsR0FDN0NLLEtBQUt5QixtQkFBcUIsSUFBSXBDLG1CQUFtQk0sR0FDakRLLEtBQUswQixlQUFpQixJQUFJcEMsZUFBZUssR0FFekNLLEtBQUsyQixTQUFTN0MsVUFBVThDLGlCQUFrQm5ELFFBQVFvRCxPQUFPL0MsVUFBVWdELFlBQWNDLE9BQVEsUUFDekYvQixLQUFLMkIsU0FBUzdDLFVBQVVrRCxpQkFBa0J2RCxRQUFRb0QsT0FBTy9DLFVBQVVtRCxZQUFjRixPQUFRLFFBQ3pGL0IsS0FBSzJCLFNBQVMzQixLQUFLc0IscUJBQXFCWSxhQUN4Q2xDLEtBQUsyQixTQUFTM0IsS0FBS3VCLG1CQUFtQlcsYUFDdENsQyxLQUFLMkIsU0FBUzNCLEtBQUt3QixpQkFBaUJVLGFBQ3BDbEMsS0FBSzJCLFNBQVMzQixLQUFLeUIsbUJBQW1CUyxhQUN0Q2xDLEtBQUsyQixTQUFTM0IsS0FBSzBCLGVBQWVRLGFBR3BDeEMsYUFDRSxPQUFPckIsUUFBUVUsS0FDYmlCLEtBQUtzQixxQkFBcUJ6QixhQUMxQkcsS0FBS3dCLGlCQUFpQjNCLGFBQ3RCRyxLQUFLeUIsbUJBQW1CNUIsYUFDeEJHLEtBQUt1QixtQkFBbUIxQixhQUN4QkcsS0FBSzBCLGVBQWU3QixlQUsxQnNDLE9BQU9DLFFBQVUzQyIsImZpbGUiOiJhcHAvbWFpbi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBTZXF1ZWxpemVTZXJ2aWNlIGZyb20gJy4uL3NlcnZpY2VzL3NlcXVlbGl6ZS1zZXJ2aWNlJ1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpXG5sZXQgZ2V0U2x1ZyA9IHJlcXVpcmUoJ3NwZWFraW5ndXJsJylcbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxubGV0IG1hcmtlZCA9IHJlcXVpcmUoJ21hcmtlZCcpXG5sZXQgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50LXRpbWV6b25lJylcblxubGV0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC1jb25maWcnKSlcbmxldCBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NvbnRyb2xsZXJzL2Jhc2UtY29udHJvbGxlcicpKVxubGV0IENvdXJzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdjb250cm9sbGVycy9jb3Vyc2UtY29udHJvbGxlcicpKVxubGV0IENyZWRlbnRpYWxDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvY3JlZGVudGlhbC1jb250cm9sbGVyJykpXG5sZXQgRXhlcmNpc2VDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlcicpKVxubGV0IFN1YnRvcGljQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NvbnRyb2xsZXJzL3N1YnRvcGljLWNvbnRyb2xsZXInKSlcbmxldCBTeW5jQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NvbnRyb2xsZXJzL3N5bmMtY29udHJvbGxlcicpKVxubGV0IFBhc3Nwb3J0TWFuYWdlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xpYi9wYXNzcG9ydC1tYW5hZ2VyJykpXG5cbmNvbnN0IFRBRyA9ICdGaWxvc2VkdUFwcENvbnRyb2xsZXInXG5cbmNsYXNzIENvbnRyb2xsZXIgZXh0ZW5kcyBCYXNlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yIChpbml0RGF0YSkge1xuICAgIHN1cGVyKGluaXREYXRhKVxuICAgIFBhc3Nwb3J0TWFuYWdlci5pbml0aWFsaXplKClcbiAgICAvLyBTaW5jZSB0aGUgU1FMIHNlcnZlciBpcyBjb25maWd1cmVkIHRvIHN0b3JlIHRoZSBkYXRlIGluIFVUQyBmb3JtYXQsIHdlXG4gICAgLy8gZG8gZXZlcnl0aGluZyBpbiBVVEMgYXMgd2VsbFxuICAgIG1vbWVudC50ei5zZXREZWZhdWx0KCdVVEMnKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3JlcS5wYXRoPScgKyByZXEucGF0aClcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ2xvZ2dlZEluPScgKyByZXEuaXNBdXRoZW50aWNhdGVkKCkpXG4gICAgICBsb2cudmVyYm9zZShUQUcsICdyZXEub249JyArIEpTT04uc3RyaW5naWZ5KHJlcS5zZXNzaW9uKSlcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3JlcS5oZWFkZXJzLmNvb2tpZT0nICsgSlNPTi5zdHJpbmdpZnkocmVxLmhlYWRlcnMuY29va2llKSlcbiAgICAgIHJlcy5sb2NhbHMubWFya2VkID0gbWFya2VkXG4gICAgICByZXMubG9jYWxzLmdldFNsdWcgPSBnZXRTbHVnXG4gICAgICByZXMubG9jYWxzLnNpdGUgPSByZXEuc2l0ZVxuICAgICAgcmVzLmxvY2Fscy51c2VyID0gcmVxLnVzZXJcbiAgICAgIHJlcy5sb2NhbHMubG9nZ2VkSW4gPSByZXEuaXNBdXRoZW50aWNhdGVkKClcbiAgICAgIHJlcy5sb2NhbHMuY2xvdWRTZXJ2ZXIgPSBBcHBDb25maWcuQ0xPVURfU0VSVkVSXG4gICAgICBuZXh0KClcbiAgICB9KVxuICAgIFNlcXVlbGl6ZVNlcnZpY2UuaW5pdGlhbGl6ZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuXG4gICAgdGhpcy5jcmVkZW50aWFsQ29udHJvbGxlciA9IG5ldyBDcmVkZW50aWFsQ29udHJvbGxlcihpbml0RGF0YSlcbiAgICB0aGlzLmV4ZXJjaXNlQ29udHJvbGxlciA9IG5ldyBFeGVyY2lzZUNvbnRyb2xsZXIoaW5pdERhdGEpXG4gICAgdGhpcy5jb3Vyc2VDb250cm9sbGVyID0gbmV3IENvdXJzZUNvbnRyb2xsZXIoaW5pdERhdGEpXG4gICAgdGhpcy5zdWJ0b3BpY0NvbnRyb2xsZXIgPSBuZXcgU3VidG9waWNDb250cm9sbGVyKGluaXREYXRhKVxuICAgIHRoaXMuc3luY0NvbnRyb2xsZXIgPSBuZXcgU3luY0NvbnRyb2xsZXIoaW5pdERhdGEpXG5cbiAgICB0aGlzLnJvdXRlVXNlKEFwcENvbmZpZy5WSURFT19NT1VOVF9QQVRILCBleHByZXNzLnN0YXRpYyhBcHBDb25maWcuVklERU9fUEFUSCwgeyBtYXhBZ2U6ICcxaCcgfSkpXG4gICAgdGhpcy5yb3V0ZVVzZShBcHBDb25maWcuSU1BR0VfTU9VTlRfUEFUSCwgZXhwcmVzcy5zdGF0aWMoQXBwQ29uZmlnLklNQUdFX1BBVEgsIHsgbWF4QWdlOiAnMWgnIH0pKVxuICAgIHRoaXMucm91dGVVc2UodGhpcy5jcmVkZW50aWFsQ29udHJvbGxlci5nZXRSb3V0ZXIoKSlcbiAgICB0aGlzLnJvdXRlVXNlKHRoaXMuZXhlcmNpc2VDb250cm9sbGVyLmdldFJvdXRlcigpKVxuICAgIHRoaXMucm91dGVVc2UodGhpcy5jb3Vyc2VDb250cm9sbGVyLmdldFJvdXRlcigpKVxuICAgIHRoaXMucm91dGVVc2UodGhpcy5zdWJ0b3BpY0NvbnRyb2xsZXIuZ2V0Um91dGVyKCkpXG4gICAgdGhpcy5yb3V0ZVVzZSh0aGlzLnN5bmNDb250cm9sbGVyLmdldFJvdXRlcigpKVxuICB9XG5cbiAgaW5pdGlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIFByb21pc2Uuam9pbihcbiAgICAgIHRoaXMuY3JlZGVudGlhbENvbnRyb2xsZXIuaW5pdGlhbGl6ZSgpLFxuICAgICAgdGhpcy5jb3Vyc2VDb250cm9sbGVyLmluaXRpYWxpemUoKSxcbiAgICAgIHRoaXMuc3VidG9waWNDb250cm9sbGVyLmluaXRpYWxpemUoKSxcbiAgICAgIHRoaXMuZXhlcmNpc2VDb250cm9sbGVyLmluaXRpYWxpemUoKSxcbiAgICAgIHRoaXMuc3luY0NvbnRyb2xsZXIuaW5pdGlhbGl6ZSgpXG4gICAgKVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ29udHJvbGxlclxuIl19
