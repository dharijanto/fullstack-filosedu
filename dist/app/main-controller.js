"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),sequelize_service_1=require("../services/sequelize-service"),path=require("path");let express=require("express"),getSlug=require("speakingurl"),log=require("npmlog"),marked=require("marked"),moment=require("moment-timezone"),AppConfig=require(path.join(__dirname,"../app-config")),BaseController=require(path.join(__dirname,"controllers/base-controller")),CourseController=require(path.join(__dirname,"controllers/course-controller")),CredentialController=require(path.join(__dirname,"controllers/credential-controller")),ExerciseController=require(path.join(__dirname,"controllers/exercise-controller"));const competency_exercise_controller_1=require("./controllers/competency-exercise-controller");let SubtopicController=require(path.join(__dirname,"controllers/subtopic-controller")),SyncController=require(path.join(__dirname,"controllers/sync-controller")),PassportManager=require(path.join(__dirname,"../lib/passport-manager"));const TAG="FiloseduAppController";class Controller extends BaseController{constructor(e){super(e),PassportManager.initialize(),moment.tz.setDefault("UTC"),this.routeUse((e,r,o)=>{log.verbose(TAG,"req.path="+e.path),log.verbose(TAG,"loggedIn="+e.isAuthenticated()),log.verbose(TAG,"req.on="+JSON.stringify(e.session)),log.verbose(TAG,"req.headers.cookie="+JSON.stringify(e.headers.cookie)),r.locals.marked=marked,r.locals.getSlug=getSlug,r.locals.site=e.site,r.locals.user=e.user,r.locals.loggedIn=e.isAuthenticated(),r.locals.cloudServer=AppConfig.CLOUD_SERVER,log.verbose(TAG,"cloudServer="+r.locals.cloudServer),o()}),sequelize_service_1.default.initialize(this.getDb().sequelize,this.getDb().models),this.credentialController=new CredentialController(e),this.exerciseController=new ExerciseController(e),this.competencyExerciseController=new competency_exercise_controller_1.default(e),this.courseController=new CourseController(e),this.subtopicController=new SubtopicController(e),this.syncController=new SyncController(e),this.routeUse(AppConfig.VIDEO_MOUNT_PATH,express.static(AppConfig.VIDEO_PATH,{maxAge:"1h"})),this.routeUse(AppConfig.IMAGE_MOUNT_PATH,express.static(AppConfig.IMAGE_PATH,{maxAge:"1h"})),this.routeUse(this.credentialController.getRouter()),this.routeUse(this.courseController.getRouter()),this.routeUse(this.exerciseController.getRouter()),this.routeUse(this.subtopicController.getRouter()),this.routeUse(this.syncController.getRouter()),this.routeUse("/competency-exercise",this.competencyExerciseController.getRouter())}initialize(){return Promise.join(this.credentialController.initialize(),this.courseController.initialize(),this.subtopicController.initialize(),this.exerciseController.initialize(),this.competencyExerciseController.initialize(),this.syncController.initialize())}}module.exports=Controller;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvbWFpbi1jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwic2VxdWVsaXplX3NlcnZpY2VfMSIsInBhdGgiLCJleHByZXNzIiwiZ2V0U2x1ZyIsImxvZyIsIm1hcmtlZCIsIm1vbWVudCIsIkFwcENvbmZpZyIsImpvaW4iLCJfX2Rpcm5hbWUiLCJCYXNlQ29udHJvbGxlciIsIkNvdXJzZUNvbnRyb2xsZXIiLCJDcmVkZW50aWFsQ29udHJvbGxlciIsIkV4ZXJjaXNlQ29udHJvbGxlciIsImNvbXBldGVuY3lfZXhlcmNpc2VfY29udHJvbGxlcl8xIiwiU3VidG9waWNDb250cm9sbGVyIiwiU3luY0NvbnRyb2xsZXIiLCJQYXNzcG9ydE1hbmFnZXIiLCJUQUciLCJDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsImluaXRpYWxpemUiLCJ0eiIsInNldERlZmF1bHQiLCJ0aGlzIiwicm91dGVVc2UiLCJyZXEiLCJyZXMiLCJuZXh0IiwidmVyYm9zZSIsImlzQXV0aGVudGljYXRlZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJzZXNzaW9uIiwiaGVhZGVycyIsImNvb2tpZSIsImxvY2FscyIsInNpdGUiLCJ1c2VyIiwibG9nZ2VkSW4iLCJjbG91ZFNlcnZlciIsIkNMT1VEX1NFUlZFUiIsImRlZmF1bHQiLCJnZXREYiIsInNlcXVlbGl6ZSIsIm1vZGVscyIsImNyZWRlbnRpYWxDb250cm9sbGVyIiwiZXhlcmNpc2VDb250cm9sbGVyIiwiY29tcGV0ZW5jeUV4ZXJjaXNlQ29udHJvbGxlciIsImNvdXJzZUNvbnRyb2xsZXIiLCJzdWJ0b3BpY0NvbnRyb2xsZXIiLCJzeW5jQ29udHJvbGxlciIsIlZJREVPX01PVU5UX1BBVEgiLCJzdGF0aWMiLCJWSURFT19QQVRIIiwibWF4QWdlIiwiSU1BR0VfTU9VTlRfUEFUSCIsIklNQUdFX1BBVEgiLCJnZXRSb3V0ZXIiLCJtb2R1bGUiLCJl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Q3hCRyxLQUFLdUIsbUJBQW1CMUIsYUFDeEJHLEtBQUt3Qiw2QkFBNkIzQixhQUNsQ0csS0FBSzJCLGVBQWU5QixlQUsxQnNDLE9BQU9DLFFBQVUzQyIsImZpbGUiOiJhcHAvbWFpbi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBTZXF1ZWxpemVTZXJ2aWNlIGZyb20gJy4uL3NlcnZpY2VzL3NlcXVlbGl6ZS1zZXJ2aWNlJ1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpXG5sZXQgZ2V0U2x1ZyA9IHJlcXVpcmUoJ3NwZWFraW5ndXJsJylcbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxubGV0IG1hcmtlZCA9IHJlcXVpcmUoJ21hcmtlZCcpXG5sZXQgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50LXRpbWV6b25lJylcblxubGV0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC1jb25maWcnKSlcbmxldCBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NvbnRyb2xsZXJzL2Jhc2UtY29udHJvbGxlcicpKVxubGV0IENvdXJzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdjb250cm9sbGVycy9jb3Vyc2UtY29udHJvbGxlcicpKVxubGV0IENyZWRlbnRpYWxDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvY3JlZGVudGlhbC1jb250cm9sbGVyJykpXG5sZXQgRXhlcmNpc2VDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlcicpKVxuaW1wb3J0IENvbXBldGVuY3lFeGVyY2lzZUNvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVycy9jb21wZXRlbmN5LWV4ZXJjaXNlLWNvbnRyb2xsZXInXG5sZXQgU3VidG9waWNDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvc3VidG9waWMtY29udHJvbGxlcicpKVxubGV0IFN5bmNDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY29udHJvbGxlcnMvc3luYy1jb250cm9sbGVyJykpXG5sZXQgUGFzc3BvcnRNYW5hZ2VyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbGliL3Bhc3Nwb3J0LW1hbmFnZXInKSlcblxuY29uc3QgVEFHID0gJ0ZpbG9zZWR1QXBwQ29udHJvbGxlcidcblxuY2xhc3MgQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG4gICAgUGFzc3BvcnRNYW5hZ2VyLmluaXRpYWxpemUoKVxuICAgIC8vIFNpbmNlIHRoZSBTUUwgc2VydmVyIGlzIGNvbmZpZ3VyZWQgdG8gc3RvcmUgdGhlIGRhdGUgaW4gVVRDIGZvcm1hdCwgd2VcbiAgICAvLyBkbyBldmVyeXRoaW5nIGluIFVUQyBhcyB3ZWxsXG4gICAgbW9tZW50LnR6LnNldERlZmF1bHQoJ1VUQycpXG5cbiAgICB0aGlzLnJvdXRlVXNlKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAncmVxLnBhdGg9JyArIHJlcS5wYXRoKVxuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnbG9nZ2VkSW49JyArIHJlcS5pc0F1dGhlbnRpY2F0ZWQoKSlcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3JlcS5vbj0nICsgSlNPTi5zdHJpbmdpZnkocmVxLnNlc3Npb24pKVxuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAncmVxLmhlYWRlcnMuY29va2llPScgKyBKU09OLnN0cmluZ2lmeShyZXEuaGVhZGVycy5jb29raWUpKVxuICAgICAgcmVzLmxvY2Fscy5tYXJrZWQgPSBtYXJrZWRcbiAgICAgIHJlcy5sb2NhbHMuZ2V0U2x1ZyA9IGdldFNsdWdcbiAgICAgIHJlcy5sb2NhbHMuc2l0ZSA9IHJlcS5zaXRlXG4gICAgICByZXMubG9jYWxzLnVzZXIgPSByZXEudXNlclxuICAgICAgcmVzLmxvY2Fscy5sb2dnZWRJbiA9IHJlcS5pc0F1dGhlbnRpY2F0ZWQoKVxuICAgICAgcmVzLmxvY2Fscy5jbG91ZFNlcnZlciA9IEFwcENvbmZpZy5DTE9VRF9TRVJWRVJcblxuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnY2xvdWRTZXJ2ZXI9JyArIHJlcy5sb2NhbHMuY2xvdWRTZXJ2ZXIpXG4gICAgICBuZXh0KClcbiAgICB9KVxuICAgIFNlcXVlbGl6ZVNlcnZpY2UuaW5pdGlhbGl6ZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuXG4gICAgdGhpcy5jcmVkZW50aWFsQ29udHJvbGxlciA9IG5ldyBDcmVkZW50aWFsQ29udHJvbGxlcihpbml0RGF0YSlcbiAgICB0aGlzLmV4ZXJjaXNlQ29udHJvbGxlciA9IG5ldyBFeGVyY2lzZUNvbnRyb2xsZXIoaW5pdERhdGEpXG4gICAgdGhpcy5jb21wZXRlbmN5RXhlcmNpc2VDb250cm9sbGVyID0gbmV3IENvbXBldGVuY3lFeGVyY2lzZUNvbnRyb2xsZXIoaW5pdERhdGEpXG4gICAgdGhpcy5jb3Vyc2VDb250cm9sbGVyID0gbmV3IENvdXJzZUNvbnRyb2xsZXIoaW5pdERhdGEpXG4gICAgdGhpcy5zdWJ0b3BpY0NvbnRyb2xsZXIgPSBuZXcgU3VidG9waWNDb250cm9sbGVyKGluaXREYXRhKVxuICAgIHRoaXMuc3luY0NvbnRyb2xsZXIgPSBuZXcgU3luY0NvbnRyb2xsZXIoaW5pdERhdGEpXG5cbiAgICB0aGlzLnJvdXRlVXNlKEFwcENvbmZpZy5WSURFT19NT1VOVF9QQVRILCBleHByZXNzLnN0YXRpYyhBcHBDb25maWcuVklERU9fUEFUSCwgeyBtYXhBZ2U6ICcxaCcgfSkpXG4gICAgdGhpcy5yb3V0ZVVzZShBcHBDb25maWcuSU1BR0VfTU9VTlRfUEFUSCwgZXhwcmVzcy5zdGF0aWMoQXBwQ29uZmlnLklNQUdFX1BBVEgsIHsgbWF4QWdlOiAnMWgnIH0pKVxuICAgIHRoaXMucm91dGVVc2UodGhpcy5jcmVkZW50aWFsQ29udHJvbGxlci5nZXRSb3V0ZXIoKSlcbiAgICB0aGlzLnJvdXRlVXNlKHRoaXMuY291cnNlQ29udHJvbGxlci5nZXRSb3V0ZXIoKSlcbiAgICB0aGlzLnJvdXRlVXNlKHRoaXMuZXhlcmNpc2VDb250cm9sbGVyLmdldFJvdXRlcigpKVxuICAgIHRoaXMucm91dGVVc2UodGhpcy5zdWJ0b3BpY0NvbnRyb2xsZXIuZ2V0Um91dGVyKCkpXG4gICAgdGhpcy5yb3V0ZVVzZSh0aGlzLnN5bmNDb250cm9sbGVyLmdldFJvdXRlcigpKVxuICAgIHRoaXMucm91dGVVc2UoJy9jb21wZXRlbmN5LWV4ZXJjaXNlJywgdGhpcy5jb21wZXRlbmN5RXhlcmNpc2VDb250cm9sbGVyLmdldFJvdXRlcigpKVxuICB9XG5cbiAgaW5pdGlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIFByb21pc2Uuam9pbihcbiAgICAgIHRoaXMuY3JlZGVudGlhbENvbnRyb2xsZXIuaW5pdGlhbGl6ZSgpLFxuICAgICAgdGhpcy5jb3Vyc2VDb250cm9sbGVyLmluaXRpYWxpemUoKSxcbiAgICAgIHRoaXMuc3VidG9waWNDb250cm9sbGVyLmluaXRpYWxpemUoKSxcbiAgICAgIHRoaXMuZXhlcmNpc2VDb250cm9sbGVyLmluaXRpYWxpemUoKSxcbiAgICAgIHRoaXMuY29tcGV0ZW5jeUV4ZXJjaXNlQ29udHJvbGxlci5pbml0aWFsaXplKCksXG4gICAgICB0aGlzLnN5bmNDb250cm9sbGVyLmluaXRpYWxpemUoKVxuICAgIClcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvbnRyb2xsZXJcbiJdfQ==
