"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_helper_1=require("../utils/exercise-helper"),topic_exercise_service_1=require("../../services/topic-exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),BaseController=require(path.join(__dirname,"base-controller")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),Utils=require(path.join(__dirname,"../../lib/utils"));const TAG="CourseController";class CourseController extends BaseController{constructor(e){super(e),this.addInterceptor((e,t,r)=>{r()}),this.routeGet("/",(e,t,r)=>{course_service_1.default.getTopicDetails(e.user?e.user.id:null).then(e=>{e.status&&e.data?(t.locals.topics=e.data.topics,t.render("topics")):r(e.errMessage)}).catch(e=>{r(e)})}),this.routeGet("/topics/:topicId/:topicSlug/review",PassportHelper.ensureLoggedIn(),(e,t,r)=>{let s=e.params.topicId,i=e.user.id;topic_exercise_service_1.default.getFormattedExercise(s,i).then(e=>{e.status&&e.data?(console.dir("Elapsed time="+e.data.elapsedTime),t.locals.idealTime=e.data.idealTime,t.locals.elapsedTime=e.data.elapsedTime,t.locals.topicName=e.data.topicName,t.locals.bundle=this.topicExerciseFrontendJS,t.locals.formattedExercises=e.data.formattedExercises,t.render("topic-exercise")):r(e.errMessage)}).catch(e=>{r(e)})}),this.routeGet("/topics/:topicId/getLeaderboard",(e,t,r)=>{let s=e.params.topicId;void 0===s?t.json({status:!1,errMessage:"topicId is needed"}):e.isAuthenticated?topic_exercise_service_1.default.getRenderedLeaderboard(s).then(e=>{t.json(e)}).catch(e=>{r(e)}):t.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/topics/:topicId/:topicSlug/review",(e,t,r)=>{let s=e.body.userAnswers,i=e.params.topicId,a=e.user.id;return log.verbose(TAG,`submitAnswer.POST(): userId=${a} topicId=${i} userAnswers=${s}`),topic_exercise_service_1.default.getGeneratedTopicExercise(a,i).then(e=>{if(e.status&&e.data){const r=e.data,o=e.data.id;let c=JSON.parse(e.data.exerciseDetail);return topic_exercise_service_1.default.gradeExercise(c,s).then(e=>{if(e.status&&e.data){const d=e.data,n=exercise_helper_1.default.countTimeFinish(r.createdAt);return topic_exercise_service_1.default.finishExercise(o,d.score,n,c,s).then(e=>{if(!e.status)return t.json({status:!1,errMessage:e.errMessage});Promise.join(topic_exercise_service_1.default.getStarBadges(a,i),topic_exercise_service_1.default.getCurrentRanking(n,i),topic_exercise_service_1.default.getTotalRanking(i),topic_exercise_service_1.default.getRenderedLeaderboard(i),topic_exercise_service_1.default.getTimerBadges(a,i)).spread((e,r,s,i,a)=>{t.json({status:!0,data:{grade:d,starsHTML:e.data,timersHTML:a.data,ranking:i.data,timeFinish:n,currentRanking:r.data.count,totalRanking:s.data.count}})})})}return t.json({status:!1,errMessage:e.errMessage})})}throw new Error(e.errMessage)})})}initialize(){return new Promise((e,t)=>{PathFormatter.hashAsset("app","/assets/js/topic-exercise-app-bundle.js").then(t=>{this.topicExerciseFrontendJS=t,e()}).catch(e=>{t(e)})})}}module.exports=CourseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvY291cnNlLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJjb3Vyc2Vfc2VydmljZV8xIiwiZXhlcmNpc2VfaGVscGVyXzEiLCJ0b3BpY19leGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwiQmFzZUNvbnRyb2xsZXIiLCJqb2luIiwiX19kaXJuYW1lIiwiUGF0aEZvcm1hdHRlciIsIlBhc3Nwb3J0SGVscGVyIiwiVXRpbHMiLCJUQUciLCJDb3Vyc2VDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsInRoaXMiLCJhZGRJbnRlcmNlcHRvciIsInJlcSIsInJlcyIsIm5leHQiLCJyb3V0ZUdldCIsImRlZmF1bHQiLCJnZXRUb3BpY0RldGFpbHMiLCJ1c2VyIiwiaWQiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsImRhdGEiLCJsb2NhbHMiLCJ0b3BpY3MiLCJyZW5kZXIiLCJlcnJNZXNzYWdlIiwiY2F0Y2giLCJlcnIiLCJlbnN1cmVMb2dnZWRJbiIsInRvcGljSWQiLCJwYXJhbXMiLCJ1c2VySWQiLCJnZXRGb3JtYXR0ZWRFeGVyY2lzZSIsImNvbnNvbGUiLCJkaXIiLCJlbGFwc2VkVGltZSIsImlkZWFsVGltZSIsInRvcGljTmFtZSIsImJ1bmRsZSIsInRvcGljRXhlcmNpc2VGcm9udGVuZEpTIiwiZm9ybWF0dGVkRXhlcmNpc2VzIiwidW5kZWZpbmVkIiwianNvbiIsImlzQXV0aGVudGljYXRlZCIsImdldFJlbmRlcmVkTGVhZGVyYm9hcmQiLCJyb3V0ZVBvc3QiLCJ1c2VyQW5zd2VycyIsImJvZHkiLCJ2ZXJib3NlIiwiZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQiLCJleGVyY2lzZURldGFpbHMiLCJKU09OIiwicGFyc2UiLCJleGVyY2lzZURldGFpbCIsImdyYWRlRXhlcmNpc2UiLCJyZXNwMiIsImdyYWRlIiwidGltZUZpbmlzaCIsImNvdW50VGltZUZpbmlzaCIsImNyZWF0ZWRBdCIsImZpbmlzaEV4ZXJjaXNlIiwic2NvcmUiLCJyZXNwMyIsImdldFN0YXJCYWRnZXMiLCJnZXRDdXJyZW50UmFua2luZyIsImdldFRvdGFsUmFua2luZyIsImdldFRpbWVyQmFkZ2VzIiwic3ByZWFkIiwicmVzcDExIiwicmVzcDEyIiwicmVzcDEzIiwicmVzcDE0IiwicmVzcDE1Iiwic3RhcnNIVE1MIiwidGltZXJzSFRNTCIsInJhbmtpbmciLCJjdXJyZW50UmFua2luZyIsImNvdW50IiwidG90YWxSYW5raW5nIiwiRXJyb3IiLCJyZXNvbHZlIiwicmVqZWN0IiwiaGFzaEFzc2V0IiwicmVzdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsaUJBQUFELFFBQUEsaUNBQ0FFLGtCQUFBRixRQUFBLDRCQUNBRyx5QkFBQUgsUUFBQSx5Q0FFQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFBQVEsVUFDZE0sSUFBTU4sUUFBUSxPQUVkTyxlQUFpQlAsUUFBUUksS0FBS0ksS0FBS0MsVUFBVyxvQkFDOUNDLGNBQWdCVixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLDZCQUM3Q0UsZUFBaUJYLFFBQVFJLEtBQUtJLEtBQUtDLFVBQVcsNkJBQzlDRyxNQUFRWixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLG9CQUV6QyxNQUFNSSxJQUFNLHlCQUdaQyx5QkFBK0JQLGVBTTdCUSxZQUFhQyxHQUNYQyxNQUFNRCxHQUVORSxLQUFLQyxlQUFlLENBQUNDLEVBQUtDLEVBQUtDLEtBQzdCQSxNQUlGSixLQUFLSyxTQUFTLElBQUssQ0FBQ0gsRUFBS0MsRUFBS0MsS0FDNUJyQixpQkFBQXVCLFFBQWNDLGdCQUFnQkwsRUFBSU0sS0FBT04sRUFBSU0sS0FBS0MsR0FBSyxNQUFNQyxLQUFLQyxJ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RUFDekJDLEtBRUEvRCxFQUFJK0IsTUFDRnRCLFFBQVEsRUFDUkMsTUFDRXFDLE1BQUFBLEVBQ0FpQixVQUFXTCxFQUFPakQsS0FDbEJ1RCxXQUFZRixFQUFPckQsS0FDbkJ3RCxRQUFTSixFQUFPcEQsS0FDaEJzQyxXQUFBQSxFQUNBbUIsZUFBZ0JQLEVBQU9sRCxLQUFLMEQsTUFDNUJDLGFBQWNSLEVBQU9uRCxLQUFLMEQsYUFZcEMsT0FBT3BFLEVBQUkrQixNQUNUdEIsUUFBUSxFQUNSSyxXQUFZZ0MsRUFBTWhDLGVBS3hCLE1BQU0sSUFBS3dELE1BQU05RCxFQUFLTSxnQkFNOUJwQixhQUNFLE9BQU8sSUFBSWhCLFFBQVEsQ0FBQzZGLEVBQVNDLEtBQzNCbkYsY0FBY29GLFVBQVUsTUFBTywyQ0FBMkNsRSxLQUFLbUUsSUFDN0U3RSxLQUFLK0Isd0JBQTBCOEMsRUFDL0JILE1BQ0N4RCxNQUFNQyxJQUNQd0QsRUFBT3hELFFBTWYyRCxPQUFPQyxRQUFVbkYiLCJmaWxlIjoiYXBwL2NvbnRyb2xsZXJzL2NvdXJzZS1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IENvdXJzZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvY291cnNlLXNlcnZpY2UnXG5pbXBvcnQgRXhlcmNpc2VIZWxwZXIgZnJvbSAnLi4vdXRpbHMvZXhlcmNpc2UtaGVscGVyJ1xuaW1wb3J0IFRvcGljRXhlcmNpc2VTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL3RvcGljLWV4ZXJjaXNlLXNlcnZpY2UnXG5cbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxubGV0IHB1ZyA9IHJlcXVpcmUoJ3B1ZycpXG5cbmxldCBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2Jhc2UtY29udHJvbGxlcicpKVxubGV0IFBhdGhGb3JtYXR0ZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvcGF0aC1mb3JtYXR0ZXInKSlcbmxldCBQYXNzcG9ydEhlbHBlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3V0aWxzL3Bhc3Nwb3J0LWhlbHBlcicpKVxubGV0IFV0aWxzID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vbGliL3V0aWxzJykpXG5cbmNvbnN0IFRBRyA9ICdDb3Vyc2VDb250cm9sbGVyJ1xuXG4vLyBUT0RPOiBTaG91bGQgbW92ZSBUb3BpYyBFeGVyY2lzZS1yZWxhdGVkIGNvZGUgdG8gZGlmZmVyZW50IGNvbnRyb2xsZXJcbmNsYXNzIENvdXJzZUNvbnRyb2xsZXIgZXh0ZW5kcyBCYXNlQ29udHJvbGxlciB7XG4gIC8vIFNpbmNlIHdlJ3JlIGNhY2hpbmcgc3RhdGljIGZpbGVzLCB3ZSBuZWVkIHRvIGhhc2hcbiAgLy8gYnVuZGxlZCBKUyBzbyB0aGF0IHRoZXkncmUgcmVuZXdlZFxuICAvLyBUT0RPOiBCZXR0ZXIgYXBwcm9hY2ggaXMgdG8gY3JlYXRlIHB1ZyB1dGxpdHkgZnVuY3Rpb25cbiAgLy8gICAgICAgdGhhdCBkb2VzIHRoZSBjYWNoaW5nIHRoZXJlLlxuICBwcml2YXRlIHRvcGljRXhlcmNpc2VGcm9udGVuZEpTOiBzdHJpbmdcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG5cbiAgICB0aGlzLmFkZEludGVyY2VwdG9yKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbmV4dCgpXG4gICAgfSlcblxuICAgIC8vIExhbmRpbmcgcGFnZVxuICAgIHRoaXMucm91dGVHZXQoJy8nLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIENvdXJzZVNlcnZpY2UuZ2V0VG9waWNEZXRhaWxzKHJlcS51c2VyID8gcmVxLnVzZXIuaWQgOiBudWxsKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy50b3BpY3MgPSByZXNwLmRhdGEudG9waWNzXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzcC5kYXRhLCBudWxsLCAyKSlcbiAgICAgICAgICByZXMucmVuZGVyKCd0b3BpY3MnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5leHQocmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIC8vIFRvcGljIEV4ZXJjaXNlXG4gICAgdGhpcy5yb3V0ZUdldCgnL3RvcGljcy86dG9waWNJZC86dG9waWNTbHVnL3JldmlldycsIFBhc3Nwb3J0SGVscGVyLmVuc3VyZUxvZ2dlZEluKCksIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbGV0IHRvcGljSWQgPSByZXEucGFyYW1zLnRvcGljSWRcbiAgICAgIGxldCB1c2VySWQgPSByZXEudXNlci5pZFxuICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0Rm9ybWF0dGVkRXhlcmNpc2UodG9waWNJZCwgdXNlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc29sZS5kaXIoJ0VsYXBzZWQgdGltZT0nICsgcmVzcC5kYXRhLmVsYXBzZWRUaW1lKVxuICAgICAgICAgIHJlcy5sb2NhbHMuaWRlYWxUaW1lID0gcmVzcC5kYXRhLmlkZWFsVGltZVxuICAgICAgICAgIHJlcy5sb2NhbHMuZWxhcHNlZFRpbWUgPSByZXNwLmRhdGEuZWxhcHNlZFRpbWVcbiAgICAgICAgICByZXMubG9jYWxzLnRvcGljTmFtZSA9IHJlc3AuZGF0YS50b3BpY05hbWVcbiAgICAgICAgICByZXMubG9jYWxzLmJ1bmRsZSA9IHRoaXMudG9waWNFeGVyY2lzZUZyb250ZW5kSlNcbiAgICAgICAgICByZXMubG9jYWxzLmZvcm1hdHRlZEV4ZXJjaXNlcyA9IHJlc3AuZGF0YS5mb3JtYXR0ZWRFeGVyY2lzZXNcbiAgICAgICAgICByZXMucmVuZGVyKCd0b3BpYy1leGVyY2lzZScpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbmV4dChyZXNwLmVyck1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgLy8gVG9waWNFeGVyY2lzZSBsZWFkZXJib2FyZFxuICAgIHRoaXMucm91dGVHZXQoJy90b3BpY3MvOnRvcGljSWQvZ2V0TGVhZGVyYm9hcmQnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG4gICAgICBpZiAodG9waWNJZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYHRvcGljSWQgaXMgbmVlZGVkYCB9KVxuICAgICAgfSBlbHNlIGlmICghcmVxLmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBVbmF1dGhvcml6ZWRgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRSZW5kZXJlZExlYWRlcmJvYXJkKHRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgLy8gVG9waWNFeGVyY2lzZSBzdWJtaXNzaW9uXG4gICAgLy8gVE9ETzogUGVyaGFwcyB3ZSBzaG91bGQgY2FsbCBnZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIGFuZCBncmFkZUV4ZXJjaXNlIGluc2lkZSBvZiBmaW5pc2hFeGVyY2lzZSB0byBtYWtlXG4gICAgLy8gICAgICAgdGhlIGNvZGUgY2xlYW5lcj9cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3RvcGljcy86dG9waWNJZC86dG9waWNTbHVnL3JldmlldycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgLy8gW3tcInhcIjpcIjVcIixcInlcIjpcIjFcIn0se1wieFwiOlwiMlwiLFwieVwiOlwiM1wifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn1dXG4gICAgICBsZXQgdXNlckFuc3dlcnMgPSByZXEuYm9keS51c2VyQW5zd2Vyc1xuICAgICAgbGV0IHRvcGljSWQgPSByZXEucGFyYW1zLnRvcGljSWRcbiAgICAgIGxldCB1c2VySWQgPSByZXEudXNlci5pZFxuICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgc3VibWl0QW5zd2VyLlBPU1QoKTogdXNlcklkPSR7dXNlcklkfSB0b3BpY0lkPSR7dG9waWNJZH0gdXNlckFuc3dlcnM9JHt1c2VyQW5zd2Vyc31gKVxuICAgICAgcmV0dXJuIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEdlbmVyYXRlZFRvcGljRXhlcmNpc2UodXNlcklkLCB0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSA9IHJlc3AuZGF0YVxuICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZCA9IHJlc3AuZGF0YS5pZFxuICAgICAgICAgIGxldCBleGVyY2lzZURldGFpbHM6IFBhcnRpYWw8R2VuZXJhdGVkRXhlcmNpc2U+W10gPSBKU09OLnBhcnNlKHJlc3AuZGF0YS5leGVyY2lzZURldGFpbClcbiAgICAgICAgICByZXR1cm4gVG9waWNFeGVyY2lzZVNlcnZpY2UuZ3JhZGVFeGVyY2lzZShleGVyY2lzZURldGFpbHMsIHVzZXJBbnN3ZXJzKS50aGVuKHJlc3AyID0+IHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlc3AyLCBudWxsLCAyKSlcbiAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgICBjb25zdCBncmFkZSA9IHJlc3AyLmRhdGFcbiAgICAgICAgICAgICAgY29uc3QgdGltZUZpbmlzaCA9IEV4ZXJjaXNlSGVscGVyLmNvdW50VGltZUZpbmlzaChnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLmNyZWF0ZWRBdClcbiAgICAgICAgICAgICAgcmV0dXJuIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmZpbmlzaEV4ZXJjaXNlKFxuICAgICAgICAgICAgICAgIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZCwgZ3JhZGUuc2NvcmUsXG4gICAgICAgICAgICAgICAgdGltZUZpbmlzaCwgZXhlcmNpc2VEZXRhaWxzLCB1c2VyQW5zd2Vyc1xuICAgICAgICAgICAgICApLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwMy5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgIFByb21pc2Uuam9pbihcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0U3RhckJhZGdlcyh1c2VySWQsIHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRDdXJyZW50UmFua2luZyh0aW1lRmluaXNoLCB0b3BpY0lkKSxcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0VG90YWxSYW5raW5nKHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRSZW5kZXJlZExlYWRlcmJvYXJkKHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRUaW1lckJhZGdlcyh1c2VySWQsIHRvcGljSWQpXG4gICAgICAgICAgICAgICAgICApLnNwcmVhZCgoXG4gICAgICAgICAgICAgICAgICAgIHJlc3AxMTogTkNSZXNwb25zZTxhbnk+LCByZXNwMTI6IE5DUmVzcG9uc2U8YW55PixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDEzOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AxNDogTkNSZXNwb25zZTxhbnk+LFxuICAgICAgICAgICAgICAgICAgICByZXNwMTU6IE5DUmVzcG9uc2U8YW55PlxuICAgICAgICAgICAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFyc0hUTUw6IHJlc3AxMS5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJzSFRNTDogcmVzcDE1LmRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5raW5nOiByZXNwMTQuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGaW5pc2gsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmFua2luZzogcmVzcDEyLmRhdGEuY291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFJhbmtpbmc6IHJlc3AxMy5kYXRhLmNvdW50XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZXJyTWVzc2FnZTogcmVzcDMuZXJyTWVzc2FnZVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgICAgICAgIHN0YXR1czogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyTWVzc2FnZTogcmVzcDIuZXJyTWVzc2FnZVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihyZXNwLmVyck1lc3NhZ2UpKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBpbml0aWFsaXplICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgUGF0aEZvcm1hdHRlci5oYXNoQXNzZXQoJ2FwcCcsICcvYXNzZXRzL2pzL3RvcGljLWV4ZXJjaXNlLWFwcC1idW5kbGUuanMnKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHRoaXMudG9waWNFeGVyY2lzZUZyb250ZW5kSlMgPSByZXN1bHRcbiAgICAgICAgcmVzb2x2ZSgpXG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICByZWplY3QoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ291cnNlQ29udHJvbGxlclxuIl19
