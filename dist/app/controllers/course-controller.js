"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_helper_1=require("../utils/exercise-helper"),topic_exercise_service_1=require("../../services/topic-exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),BaseController=require(path.join(__dirname,"base-controller")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),Utils=require(path.join(__dirname,"../../lib/utils"));const TAG="CourseController";class CourseController extends BaseController{constructor(e){super(e),this.addInterceptor((e,t,r)=>{log.verbose(TAG,"req.path="+e.path),r()}),this.routeGet("/",(e,t,r)=>{course_service_1.default.getTopicDetails(e.user?e.user.id:null).then(e=>{e.status&&e.data?(t.locals.topics=e.data.topics,t.render("topics")):r(e.errMessage)}).catch(e=>{r(e)})}),this.routeGet("/topics/:topicId/:topicSlug/review",PassportHelper.ensureLoggedIn(),(e,t,r)=>{let s=e.params.topicId,i=e.user.id;topic_exercise_service_1.default.getFormattedExercise(s,i).then(e=>{e.status&&e.data?(console.dir("Elapsed time="+e.data.elapsedTime),t.locals.idealTime=e.data.idealTime,t.locals.elapsedTime=e.data.elapsedTime,t.locals.topicName=e.data.topicName,t.locals.bundle=this.topicExerciseFrontendJS,t.locals.formattedExercises=e.data.formattedExercises,t.render("topic-exercise")):r(e.errMessage)}).catch(e=>{r(e)})}),this.routeGet("/topics/:topicId/getLeaderboard",(e,t,r)=>{let s=e.params.topicId;void 0===s?t.json({status:!1,errMessage:"topicId is needed"}):e.isAuthenticated?topic_exercise_service_1.default.getRenderedLeaderboard(s).then(e=>{t.json(e)}).catch(e=>{r(e)}):t.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/topics/:topicId/:topicSlug/review",(e,t,r)=>{let s=e.body.userAnswers,i=e.params.topicId,a=e.user.id;return log.verbose(TAG,`submitAnswer.POST(): userId=${a} topicId=${i} userAnswers=${s}`),topic_exercise_service_1.default.getGeneratedTopicExercise(a,i).then(e=>{if(e.status&&e.data){const r=e.data,o=e.data.id;let c=JSON.parse(e.data.exerciseDetail);return topic_exercise_service_1.default.gradeExercise(c,s).then(e=>{if(e.status&&e.data){const d=e.data,n=exercise_helper_1.default.countTimeFinish(r.createdAt);return topic_exercise_service_1.default.finishExercise(o,d.score,n,c,s).then(e=>{if(!e.status)return t.json({status:!1,errMessage:e.errMessage});Promise.join(topic_exercise_service_1.default.getStarBadges(a,i),topic_exercise_service_1.default.getCurrentRanking(n,i),topic_exercise_service_1.default.getTotalRanking(i),topic_exercise_service_1.default.getRenderedLeaderboard(i),topic_exercise_service_1.default.getTimerBadges(a,i)).spread((e,r,s,i,a)=>{t.json({status:!0,data:{grade:d,starsHTML:e.data,timersHTML:a.data,ranking:i.data,timeFinish:n,currentRanking:r.data.count,totalRanking:s.data.count}})})})}return t.json({status:!1,errMessage:e.errMessage})})}throw new Error(e.errMessage)})})}initialize(){return new Promise((e,t)=>{PathFormatter.hashAsset("app","/assets/js/topic-exercise-app-bundle.js").then(t=>{this.topicExerciseFrontendJS=t,e()}).catch(e=>{t(e)})})}}module.exports=CourseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvY291cnNlLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJjb3Vyc2Vfc2VydmljZV8xIiwiZXhlcmNpc2VfaGVscGVyXzEiLCJ0b3BpY19leGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwiQmFzZUNvbnRyb2xsZXIiLCJqb2luIiwiX19kaXJuYW1lIiwiUGF0aEZvcm1hdHRlciIsIlBhc3Nwb3J0SGVscGVyIiwiVXRpbHMiLCJUQUciLCJDb3Vyc2VDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsInRoaXMiLCJhZGRJbnRlcmNlcHRvciIsInJlcSIsInJlcyIsIm5leHQiLCJ2ZXJib3NlIiwicm91dGVHZXQiLCJkZWZhdWx0IiwiZ2V0VG9waWNEZXRhaWxzIiwidXNlciIsImlkIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJkYXRhIiwibG9jYWxzIiwidG9waWNzIiwicmVuZGVyIiwiZXJyTWVzc2FnZSIsImNhdGNoIiwiZXJyIiwiZW5zdXJlTG9nZ2VkSW4iLCJ0b3BpY0lkIiwicGFyYW1zIiwidXNlcklkIiwiZ2V0Rm9ybWF0dGVkRXhlcmNpc2UiLCJjb25zb2xlIiwiZGlyIiwiZWxhcHNlZFRpbWUiLCJpZGVhbFRpbWUiLCJ0b3BpY05hbWUiLCJidW5kbGUiLCJ0b3BpY0V4ZXJjaXNlRnJvbnRlbmRKUyIsImZvcm1hdHRlZEV4ZXJjaXNlcyIsInVuZGVmaW5lZCIsImpzb24iLCJpc0F1dGhlbnRpY2F0ZWQiLCJnZXRSZW5kZXJlZExlYWRlcmJvYXJkIiwicm91dGVQb3N0IiwidXNlckFuc3dlcnMiLCJib2R5IiwiZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQiLCJleGVyY2lzZURldGFpbHMiLCJKU09OIiwicGFyc2UiLCJleGVyY2lzZURldGFpbCIsImdyYWRlRXhlcmNpc2UiLCJyZXNwMiIsImdyYWRlIiwidGltZUZpbmlzaCIsImNvdW50VGltZUZpbmlzaCIsImNyZWF0ZWRBdCIsImZpbmlzaEV4ZXJjaXNlIiwic2NvcmUiLCJyZXNwMyIsImdldFN0YXJCYWRnZXMiLCJnZXRDdXJyZW50UmFua2luZyIsImdldFRvdGFsUmFua2luZyIsImdldFRpbWVyQmFkZ2VzIiwic3ByZWFkIiwicmVzcDExIiwicmVzcDEyIiwicmVzcDEzIiwicmVzcDE0IiwicmVzcDE1Iiwic3RhcnNIVE1MIiwidGltZXJzSFRNTCIsInJhbmtpbmciLCJjdXJyZW50UmFua2luZyIsImNvdW50IiwidG90YWxSYW5raW5nIiwiRXJyb3IiLCJyZXNvbHZlIiwicmVqZWN0IiwiaGFzaEFzc2V0IiwicmVzdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsaUJBQUFELFFBQUEsaUNBQ0FFLGtCQUFBRixRQUFBLDRCQUNBRyx5QkFBQUgsUUFBQSx5Q0FFQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFBQVEsVUFDZE0sSUFBTU4sUUFBUSxPQUVkTyxlQUFpQlAsUUFBUUksS0FBS0ksS0FBS0MsVUFBVyxvQkFDOUNDLGNBQWdCVixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLDZCQUM3Q0UsZUFBaUJYLFFBQVFJLEtBQUtJLEtBQUtDLFVBQVcsNkJBQzlDRyxNQUFRWixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLG9CQUV6QyxNQUFNSSxJQUFNLHlCQUdaQyx5QkFBK0JQLGVBTTdCUSxZQUFhQyxHQUNYQyxNQUFNRCxHQUVORSxLQUFLQyxlQUFlLENBQUNDLEVBQUtDLEVBQUtDLEtBQzdCakIsSUFBSWtCLFFBQVFWLElBQUssWUFBY08sRUFBSWhCLE1BQ25Da0IsTUFJRkosS0FBS00sU0FBUyxJQUFLLENBQUNKLEVBQUtDLEVBQUtDLEtBQzVCckIsaUJBQUF3QixRQUFjQyxnQkFBZ0JOLEVB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RUFBUUYsSUFDNUN1QyxPQUFPLENBQ1BDLEVBQXlCQyxFQUN6QkMsRUFBeUJDLEVBQ3pCQyxLQUVBL0QsRUFBSWdDLE1BQ0Z0QixRQUFRLEVBQ1JDLE1BQ0VvQyxNQUFBQSxFQUNBaUIsVUFBV0wsRUFBT2hELEtBQ2xCc0QsV0FBWUYsRUFBT3BELEtBQ25CdUQsUUFBU0osRUFBT25ELEtBQ2hCcUMsV0FBQUEsRUFDQW1CLGVBQWdCUCxFQUFPakQsS0FBS3lELE1BQzVCQyxhQUFjUixFQUFPbEQsS0FBS3lELGFBWXBDLE9BQU9wRSxFQUFJZ0MsTUFDVHRCLFFBQVEsRUFDUkssV0FBWStCLEVBQU0vQixlQUt4QixNQUFNLElBQUt1RCxNQUFNN0QsRUFBS00sZ0JBTTlCckIsYUFDRSxPQUFPLElBQUloQixRQUFRLENBQUM2RixFQUFTQyxLQUMzQm5GLGNBQWNvRixVQUFVLE1BQU8sMkNBQTJDakUsS0FBS2tFLElBQzdFN0UsS0FBS2dDLHdCQUEwQjZDLEVBQy9CSCxNQUNDdkQsTUFBTUMsSUFDUHVELEVBQU92RCxRQU1mMEQsT0FBT0MsUUFBVW5GIiwiZmlsZSI6ImFwcC9jb250cm9sbGVycy9jb3Vyc2UtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5cbmltcG9ydCBDb3Vyc2VTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL2NvdXJzZS1zZXJ2aWNlJ1xuaW1wb3J0IEV4ZXJjaXNlSGVscGVyIGZyb20gJy4uL3V0aWxzL2V4ZXJjaXNlLWhlbHBlcidcbmltcG9ydCBUb3BpY0V4ZXJjaXNlU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90b3BpYy1leGVyY2lzZS1zZXJ2aWNlJ1xuXG5sZXQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbmxldCBwdWcgPSByZXF1aXJlKCdwdWcnKVxuXG5sZXQgQmFzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdiYXNlLWNvbnRyb2xsZXInKSlcbmxldCBQYXRoRm9ybWF0dGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vbGliL3BhdGgtZm9ybWF0dGVyJykpXG5sZXQgUGFzc3BvcnRIZWxwZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi91dGlscy9wYXNzcG9ydC1oZWxwZXInKSlcbmxldCBVdGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi91dGlscycpKVxuXG5jb25zdCBUQUcgPSAnQ291cnNlQ29udHJvbGxlcidcblxuLy8gVE9ETzogU2hvdWxkIG1vdmUgVG9waWMgRXhlcmNpc2UtcmVsYXRlZCBjb2RlIHRvIGRpZmZlcmVudCBjb250cm9sbGVyXG5jbGFzcyBDb3Vyc2VDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xuICAvLyBTaW5jZSB3ZSdyZSBjYWNoaW5nIHN0YXRpYyBmaWxlcywgd2UgbmVlZCB0byBoYXNoXG4gIC8vIGJ1bmRsZWQgSlMgc28gdGhhdCB0aGV5J3JlIHJlbmV3ZWRcbiAgLy8gVE9ETzogQmV0dGVyIGFwcHJvYWNoIGlzIHRvIGNyZWF0ZSBwdWcgdXRsaXR5IGZ1bmN0aW9uXG4gIC8vICAgICAgIHRoYXQgZG9lcyB0aGUgY2FjaGluZyB0aGVyZS5cbiAgcHJpdmF0ZSB0b3BpY0V4ZXJjaXNlRnJvbnRlbmRKUzogc3RyaW5nXG4gIGNvbnN0cnVjdG9yIChpbml0RGF0YSkge1xuICAgIHN1cGVyKGluaXREYXRhKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3JlcS5wYXRoPScgKyByZXEucGF0aClcbiAgICAgIG5leHQoKVxuICAgIH0pXG5cbiAgICAvLyBMYW5kaW5nIHBhZ2VcbiAgICB0aGlzLnJvdXRlR2V0KCcvJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBDb3Vyc2VTZXJ2aWNlLmdldFRvcGljRGV0YWlscyhyZXEudXNlciA/IHJlcS51c2VyLmlkIDogbnVsbCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIHJlcy5sb2NhbHMudG9waWNzID0gcmVzcC5kYXRhLnRvcGljc1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlc3AuZGF0YSwgbnVsbCwgMikpXG4gICAgICAgICAgcmVzLnJlbmRlcigndG9waWNzJylcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXh0KHJlc3AuZXJyTWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICAvLyBUb3BpYyBFeGVyY2lzZVxuICAgIHRoaXMucm91dGVHZXQoJy90b3BpY3MvOnRvcGljSWQvOnRvcGljU2x1Zy9yZXZpZXcnLCBQYXNzcG9ydEhlbHBlci5lbnN1cmVMb2dnZWRJbigpLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG4gICAgICBsZXQgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEZvcm1hdHRlZEV4ZXJjaXNlKHRvcGljSWQsIHVzZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnNvbGUuZGlyKCdFbGFwc2VkIHRpbWU9JyArIHJlc3AuZGF0YS5lbGFwc2VkVGltZSlcbiAgICAgICAgICByZXMubG9jYWxzLmlkZWFsVGltZSA9IHJlc3AuZGF0YS5pZGVhbFRpbWVcbiAgICAgICAgICByZXMubG9jYWxzLmVsYXBzZWRUaW1lID0gcmVzcC5kYXRhLmVsYXBzZWRUaW1lXG4gICAgICAgICAgcmVzLmxvY2Fscy50b3BpY05hbWUgPSByZXNwLmRhdGEudG9waWNOYW1lXG4gICAgICAgICAgcmVzLmxvY2Fscy5idW5kbGUgPSB0aGlzLnRvcGljRXhlcmNpc2VGcm9udGVuZEpTXG4gICAgICAgICAgcmVzLmxvY2Fscy5mb3JtYXR0ZWRFeGVyY2lzZXMgPSByZXNwLmRhdGEuZm9ybWF0dGVkRXhlcmNpc2VzXG4gICAgICAgICAgcmVzLnJlbmRlcigndG9waWMtZXhlcmNpc2UnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5leHQocmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIC8vIFRvcGljRXhlcmNpc2UgbGVhZGVyYm9hcmRcbiAgICB0aGlzLnJvdXRlR2V0KCcvdG9waWNzLzp0b3BpY0lkL2dldExlYWRlcmJvYXJkJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsZXQgdG9waWNJZCA9IHJlcS5wYXJhbXMudG9waWNJZFxuICAgICAgaWYgKHRvcGljSWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGB0b3BpY0lkIGlzIG5lZWRlZGAgfSlcbiAgICAgIH0gZWxzZSBpZiAoIXJlcS5pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgVW5hdXRob3JpemVkYCB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRMZWFkZXJib2FyZCh0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgIHJlcy5qc29uKHJlc3ApXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgbmV4dChlcnIpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIC8vIFRvcGljRXhlcmNpc2Ugc3VibWlzc2lvblxuICAgIC8vIFRPRE86IFBlcmhhcHMgd2Ugc2hvdWxkIGNhbGwgZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSBhbmQgZ3JhZGVFeGVyY2lzZSBpbnNpZGUgb2YgZmluaXNoRXhlcmNpc2UgdG8gbWFrZVxuICAgIC8vICAgICAgIHRoZSBjb2RlIGNsZWFuZXI/XG4gICAgdGhpcy5yb3V0ZVBvc3QoJy90b3BpY3MvOnRvcGljSWQvOnRvcGljU2x1Zy9yZXZpZXcnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIC8vIFt7XCJ4XCI6XCI1XCIsXCJ5XCI6XCIxXCJ9LHtcInhcIjpcIjJcIixcInlcIjpcIjNcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9XVxuICAgICAgbGV0IHVzZXJBbnN3ZXJzID0gcmVxLmJvZHkudXNlckFuc3dlcnNcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG4gICAgICBsZXQgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgYHN1Ym1pdEFuc3dlci5QT1NUKCk6IHVzZXJJZD0ke3VzZXJJZH0gdG9waWNJZD0ke3RvcGljSWR9IHVzZXJBbnN3ZXJzPSR7dXNlckFuc3dlcnN9YClcbiAgICAgIHJldHVybiBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKHVzZXJJZCwgdG9waWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgICBjb25zdCBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQgPSByZXNwLmRhdGEuaWRcbiAgICAgICAgICBsZXQgZXhlcmNpc2VEZXRhaWxzOiBQYXJ0aWFsPEdlbmVyYXRlZEV4ZXJjaXNlPltdID0gSlNPTi5wYXJzZShyZXNwLmRhdGEuZXhlcmNpc2VEZXRhaWwpXG4gICAgICAgICAgcmV0dXJuIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdyYWRlRXhlcmNpc2UoZXhlcmNpc2VEZXRhaWxzLCB1c2VyQW5zd2VycykudGhlbihyZXNwMiA9PiB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXNwMiwgbnVsbCwgMikpXG4gICAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEpIHtcbiAgICAgICAgICAgICAgY29uc3QgZ3JhZGUgPSByZXNwMi5kYXRhXG4gICAgICAgICAgICAgIGNvbnN0IHRpbWVGaW5pc2ggPSBFeGVyY2lzZUhlbHBlci5jb3VudFRpbWVGaW5pc2goZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5jcmVhdGVkQXQpXG4gICAgICAgICAgICAgIHJldHVybiBUb3BpY0V4ZXJjaXNlU2VydmljZS5maW5pc2hFeGVyY2lzZShcbiAgICAgICAgICAgICAgICBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQsIGdyYWRlLnNjb3JlLFxuICAgICAgICAgICAgICAgIHRpbWVGaW5pc2gsIGV4ZXJjaXNlRGV0YWlscywgdXNlckFuc3dlcnNcbiAgICAgICAgICAgICAgKS50aGVuKHJlc3AzID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcDMuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICBQcm9taXNlLmpvaW4oXG4gICAgICAgICAgICAgICAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldFN0YXJCYWRnZXModXNlcklkLCB0b3BpY0lkKSxcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0Q3VycmVudFJhbmtpbmcodGltZUZpbmlzaCwgdG9waWNJZCksXG4gICAgICAgICAgICAgICAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldFRvdGFsUmFua2luZyh0b3BpY0lkKSxcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRMZWFkZXJib2FyZCh0b3BpY0lkKSxcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0VGltZXJCYWRnZXModXNlcklkLCB0b3BpY0lkKVxuICAgICAgICAgICAgICAgICAgKS5zcHJlYWQoKFxuICAgICAgICAgICAgICAgICAgICByZXNwMTE6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDEyOiBOQ1Jlc3BvbnNlPGFueT4sXG4gICAgICAgICAgICAgICAgICAgIHJlc3AxMzogTkNSZXNwb25zZTxhbnk+LCByZXNwMTQ6IE5DUmVzcG9uc2U8YW55PixcbiAgICAgICAgICAgICAgICAgICAgcmVzcDE1OiBOQ1Jlc3BvbnNlPGFueT5cbiAgICAgICAgICAgICAgICAgICkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXMuanNvbih7XG4gICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnNIVE1MOiByZXNwMTEuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyc0hUTUw6IHJlc3AxNS5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmFua2luZzogcmVzcDE0LmRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lRmluaXNoLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFJhbmtpbmc6IHJlc3AxMi5kYXRhLmNvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxSYW5raW5nOiByZXNwMTMuZGF0YS5jb3VudFxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGVyck1lc3NhZ2U6IHJlc3AzLmVyck1lc3NhZ2VcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVyck1lc3NhZ2U6IHJlc3AyLmVyck1lc3NhZ2VcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IChuZXcgRXJyb3IocmVzcC5lcnJNZXNzYWdlKSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgaW5pdGlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIFBhdGhGb3JtYXR0ZXIuaGFzaEFzc2V0KCdhcHAnLCAnL2Fzc2V0cy9qcy90b3BpYy1leGVyY2lzZS1hcHAtYnVuZGxlLmpzJykudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICB0aGlzLnRvcGljRXhlcmNpc2VGcm9udGVuZEpTID0gcmVzdWx0XG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmVqZWN0KGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvdXJzZUNvbnRyb2xsZXJcbiJdfQ==
