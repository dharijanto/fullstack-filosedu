"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_helper_1=require("../utils/exercise-helper"),topic_exercise_service_1=require("../../services/topic-exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),BaseController=require(path.join(__dirname,"base-controller")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),Utils=require(path.join(__dirname,"../../lib/utils"));const TAG="CourseController";class CourseController extends BaseController{constructor(e){super(e),this.addInterceptor((e,t,r)=>{r()}),this.routeGet("/",(e,t,r)=>{course_service_1.default.getTopicDetails(e.user?e.user.id:null).then(e=>{e.status&&e.data?(t.locals.topics=e.data.topics,t.render("topics")):r(e.errMessage)}).catch(e=>{r(e)})}),this.routeGet("/topics/:topicId/:topicSlug/review",PassportHelper.ensureLoggedIn(),(e,t,r)=>{let s=e.params.topicId,i=e.user.id;topic_exercise_service_1.default.getFormattedExercise(s,i).then(e=>{e.status&&e.data?(t.locals.idealTime=e.data.idealTime,t.locals.elapsedTime=e.data.elapsedTime,t.locals.topicName=e.data.topicName,t.locals.bundle=this._assetBundle,t.locals.formattedExercises=e.data.formattedExercises,t.render("topic-exercise")):r(e.errMessage)}).catch(e=>{r(e)})}),this.routeGet("/topics/:topicId/getLeaderboard",(e,t,r)=>{let s=e.params.topicId;void 0===s?t.json({status:!1,errMessage:"topicId is needed"}):e.isAuthenticated?topic_exercise_service_1.default.getExerciseLeaderboard(s).then(e=>{t.json(e)}).catch(e=>{r(e)}):t.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/topics/:topicId/:topicSlug/review",(e,t,r)=>{let s=e.body.userAnswers,i=e.params.topicId,a=e.user.id;return log.verbose(TAG,`submitAnswer.POST(): userId=${a} topicId=${i} userAnswers=${s}`),topic_exercise_service_1.default.getGeneratedTopicExercise(a,i).then(e=>{if(e.status&&e.data){const r=e.data,o=e.data.id;let c=JSON.parse(e.data.exerciseDetail);return topic_exercise_service_1.default.gradeExercise(c,s).then(e=>{if(e.status&&e.data){const d=e.data,u=exercise_helper_1.default.countTimeFinish(r.createdAt);return topic_exercise_service_1.default.finishExercise(o,d.score,u,c,s).then(e=>{if(!e.status)return t.json({status:!1,errMessage:e.errMessage});Promise.join(topic_exercise_service_1.default.getExerciseStars(a,i),topic_exercise_service_1.default.getCurrentRanking(u,i),topic_exercise_service_1.default.getTotalRanking(i),topic_exercise_service_1.default.getExerciseLeaderboard(i),topic_exercise_service_1.default.getExerciseTimers(a,i)).spread((e,r,s,i,a)=>{t.json({status:!0,data:{grade:d,starsHTML:e.data,timersHTML:a.data,ranking:i.data,timeFinish:u,currentRanking:r.data.count,totalRanking:s.data.count}})})})}return t.json({status:!1,errMessage:e.errMessage})})}throw new Error(e.errMessage)})})}initialize(){return new Promise((e,t)=>{PathFormatter.hashAsset("app","/assets/js/topic-exercise-app-bundle.js").then(t=>{this._assetBundle=t,e()}).catch(e=>{t(e)})})}}module.exports=CourseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvY291cnNlLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJjb3Vyc2Vfc2VydmljZV8xIiwiZXhlcmNpc2VfaGVscGVyXzEiLCJ0b3BpY19leGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwiQmFzZUNvbnRyb2xsZXIiLCJqb2luIiwiX19kaXJuYW1lIiwiUGF0aEZvcm1hdHRlciIsIlBhc3Nwb3J0SGVscGVyIiwiVXRpbHMiLCJUQUciLCJDb3Vyc2VDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsInRoaXMiLCJhZGRJbnRlcmNlcHRvciIsInJlcSIsInJlcyIsIm5leHQiLCJyb3V0ZUdldCIsImRlZmF1bHQiLCJnZXRUb3BpY0RldGFpbHMiLCJ1c2VyIiwiaWQiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsImRhdGEiLCJsb2NhbHMiLCJ0b3BpY3MiLCJyZW5kZXIiLCJlcnJNZXNzYWdlIiwiY2F0Y2giLCJlcnIiLCJlbnN1cmVMb2dnZWRJbiIsInRvcGljSWQiLCJwYXJhbXMiLCJ1c2VySWQiLCJnZXRGb3JtYXR0ZWRFeGVyY2lzZSIsImlkZWFsVGltZSIsImVsYXBzZWRUaW1lIiwidG9waWNOYW1lIiwiYnVuZGxlIiwiX2Fzc2V0QnVuZGxlIiwiZm9ybWF0dGVkRXhlcmNpc2VzIiwidW5kZWZpbmVkIiwianNvbiIsImlzQXV0aGVudGljYXRlZCIsImdldEV4ZXJjaXNlTGVhZGVyYm9hcmQiLCJyb3V0ZVBvc3QiLCJ1c2VyQW5zd2VycyIsImJvZHkiLCJ2ZXJib3NlIiwiZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQiLCJleGVyY2lzZURldGFpbHMiLCJKU09OIiwicGFyc2UiLCJleGVyY2lzZURldGFpbCIsImdyYWRlRXhlcmNpc2UiLCJyZXNwMiIsImdyYWRlIiwidGltZUZpbmlzaCIsImNvdW50VGltZUZpbmlzaCIsImNyZWF0ZWRBdCIsImZpbmlzaEV4ZXJjaXNlIiwic2NvcmUiLCJyZXNwMyIsImdldEV4ZXJjaXNlU3RhcnMiLCJnZXRDdXJyZW50UmFua2luZyIsImdldFRvdGFsUmFua2luZyIsImdldEV4ZXJjaXNlVGltZXJzIiwic3ByZWFkIiwicmVzcDExIiwicmVzcDEyIiwicmVzcDEzIiwicmVzcDE0IiwicmVzcDE1Iiwic3RhcnNIVE1MIiwidGltZXJzSFRNTCIsInJhbmtpbmciLCJjdXJyZW50UmFua2luZyIsImNvdW50IiwidG90YWxSYW5raW5nIiwiRXJyb3IiLCJyZXNvbHZlIiwicmVqZWN0IiwiaGFzaEFzc2V0IiwicmVzdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsaUJBQUFELFFBQUEsaUNBQ0FFLGtCQUFBRixRQUFBLDRCQUNBRyx5QkFBQUgsUUFBQSx5Q0FFQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFBQVEsVUFDZE0sSUFBTU4sUUFBUSxPQUVkTyxlQUFpQlAsUUFBUUksS0FBS0ksS0FBS0MsVUFBVyxvQkFDOUNDLGNBQWdCVixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLDZCQUM3Q0UsZUFBaUJYLFFBQVFJLEtBQUtJLEtBQUtDLFVBQVcsNkJBQzlDRyxNQUFRWixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLG9CQUV6QyxNQUFNSSxJQUFNLHlCQUVaQyx5QkFBK0JQLGVBQzdCUSxZQUFhQyxHQUNYQyxNQUFNRCxHQUVORSxLQUFLQyxlQUFlLENBQUNDLEVBQUtDLEVBQUtDLEtBQzdCQSxNQUdGSixLQUFLSyxTQUFTLElBQUssQ0FBQ0gsRUFBS0MsRUFBS0MsS0FDNUJyQixpQkFBQXVCLFFBQWNDLGdCQUFnQkwsRUFBSU0sS0FBT04sRUFBSU0sS0FBS0MsR0FBSyxNQUFNQyxLQUFLQyxJQUM1REEsRUFBS0MsUUFBVUQsRUFB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LEVBQU8vQyxLQUNsQnFELFdBQVlGLEVBQU9uRCxLQUNuQnNELFFBQVNKLEVBQU9sRCxLQUNoQm9DLFdBQUFBLEVBQ0FtQixlQUFnQlAsRUFBT2hELEtBQUt3RCxNQUM1QkMsYUFBY1IsRUFBT2pELEtBQUt3RCxhQVlwQyxPQUFPbEUsRUFBSTZCLE1BQ1RwQixRQUFRLEVBQ1JLLFdBQVk4QixFQUFNOUIsZUFLeEIsTUFBTSxJQUFLc0QsTUFBTTVELEVBQUtNLGdCQU05QnBCLGFBQ0UsT0FBTyxJQUFJaEIsUUFBUSxDQUFDMkYsRUFBU0MsS0FDM0JqRixjQUFja0YsVUFBVSxNQUFPLDJDQUEyQ2hFLEtBQUtpRSxJQUM3RTNFLEtBQUs2QixhQUFlOEMsRUFDcEJILE1BQ0N0RCxNQUFNQyxJQUNQc0QsRUFBT3RELFFBTWZ5RCxPQUFPQyxRQUFVakYiLCJmaWxlIjoiYXBwL2NvbnRyb2xsZXJzL2NvdXJzZS1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IENvdXJzZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvY291cnNlLXNlcnZpY2UnXG5pbXBvcnQgRXhlcmNpc2VIZWxwZXIgZnJvbSAnLi4vdXRpbHMvZXhlcmNpc2UtaGVscGVyJ1xuaW1wb3J0IFRvcGljRXhlcmNpc2VTZXJ2aWNlLCB7IEdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWwgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90b3BpYy1leGVyY2lzZS1zZXJ2aWNlJ1xuXG5sZXQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbmxldCBwdWcgPSByZXF1aXJlKCdwdWcnKVxuXG5sZXQgQmFzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdiYXNlLWNvbnRyb2xsZXInKSlcbmxldCBQYXRoRm9ybWF0dGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vbGliL3BhdGgtZm9ybWF0dGVyJykpXG5sZXQgUGFzc3BvcnRIZWxwZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi91dGlscy9wYXNzcG9ydC1oZWxwZXInKSlcbmxldCBVdGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi91dGlscycpKVxuXG5jb25zdCBUQUcgPSAnQ291cnNlQ29udHJvbGxlcidcblxuY2xhc3MgQ291cnNlQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG5cbiAgICB0aGlzLmFkZEludGVyY2VwdG9yKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbmV4dCgpXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy8nLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIENvdXJzZVNlcnZpY2UuZ2V0VG9waWNEZXRhaWxzKHJlcS51c2VyID8gcmVxLnVzZXIuaWQgOiBudWxsKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy50b3BpY3MgPSByZXNwLmRhdGEudG9waWNzXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzcC5kYXRhLCBudWxsLCAyKSlcbiAgICAgICAgICByZXMucmVuZGVyKCd0b3BpY3MnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5leHQocmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy90b3BpY3MvOnRvcGljSWQvOnRvcGljU2x1Zy9yZXZpZXcnLCBQYXNzcG9ydEhlbHBlci5lbnN1cmVMb2dnZWRJbigpLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG4gICAgICBsZXQgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEZvcm1hdHRlZEV4ZXJjaXNlKHRvcGljSWQsIHVzZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIHJlcy5sb2NhbHMuaWRlYWxUaW1lID0gcmVzcC5kYXRhLmlkZWFsVGltZVxuICAgICAgICAgIHJlcy5sb2NhbHMuZWxhcHNlZFRpbWUgPSByZXNwLmRhdGEuZWxhcHNlZFRpbWVcbiAgICAgICAgICByZXMubG9jYWxzLnRvcGljTmFtZSA9IHJlc3AuZGF0YS50b3BpY05hbWVcbiAgICAgICAgICByZXMubG9jYWxzLmJ1bmRsZSA9IHRoaXMuX2Fzc2V0QnVuZGxlXG4gICAgICAgICAgcmVzLmxvY2Fscy5mb3JtYXR0ZWRFeGVyY2lzZXMgPSByZXNwLmRhdGEuZm9ybWF0dGVkRXhlcmNpc2VzXG4gICAgICAgICAgcmVzLnJlbmRlcigndG9waWMtZXhlcmNpc2UnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5leHQocmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy90b3BpY3MvOnRvcGljSWQvZ2V0TGVhZGVyYm9hcmQnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG5cbiAgICAgIGlmICh0b3BpY0lkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgdG9waWNJZCBpcyBuZWVkZWRgIH0pXG4gICAgICB9IGVsc2UgaWYgKCFyZXEuaXNBdXRoZW50aWNhdGVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYFVuYXV0aG9yaXplZGAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlTGVhZGVyYm9hcmQodG9waWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIG5leHQoZXJyKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3RvcGljcy86dG9waWNJZC86dG9waWNTbHVnL3JldmlldycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgLy8gW3tcInhcIjpcIjVcIixcInlcIjpcIjFcIn0se1wieFwiOlwiMlwiLFwieVwiOlwiM1wifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn1dXG4gICAgICBsZXQgdXNlckFuc3dlcnMgPSByZXEuYm9keS51c2VyQW5zd2Vyc1xuICAgICAgbGV0IHRvcGljSWQgPSByZXEucGFyYW1zLnRvcGljSWRcbiAgICAgIGxldCB1c2VySWQgPSByZXEudXNlci5pZFxuICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgc3VibWl0QW5zd2VyLlBPU1QoKTogdXNlcklkPSR7dXNlcklkfSB0b3BpY0lkPSR7dG9waWNJZH0gdXNlckFuc3dlcnM9JHt1c2VyQW5zd2Vyc31gKVxuICAgICAgcmV0dXJuIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEdlbmVyYXRlZFRvcGljRXhlcmNpc2UodXNlcklkLCB0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSA9IHJlc3AuZGF0YVxuICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZCA9IHJlc3AuZGF0YS5pZFxuICAgICAgICAgIGxldCBleGVyY2lzZURldGFpbHM6IEdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWxbXSA9IEpTT04ucGFyc2UocmVzcC5kYXRhLmV4ZXJjaXNlRGV0YWlsKVxuICAgICAgICAgIHJldHVybiBUb3BpY0V4ZXJjaXNlU2VydmljZS5ncmFkZUV4ZXJjaXNlKGV4ZXJjaXNlRGV0YWlscywgdXNlckFuc3dlcnMpLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzcDIsIG51bGwsIDIpKVxuICAgICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGdyYWRlID0gcmVzcDIuZGF0YVxuICAgICAgICAgICAgICBjb25zdCB0aW1lRmluaXNoID0gRXhlcmNpc2VIZWxwZXIuY291bnRUaW1lRmluaXNoKGdlbmVyYXRlZFRvcGljRXhlcmNpc2UuY3JlYXRlZEF0KVxuICAgICAgICAgICAgICByZXR1cm4gVG9waWNFeGVyY2lzZVNlcnZpY2UuZmluaXNoRXhlcmNpc2UoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZUlkLCBncmFkZS5zY29yZSwgdGltZUZpbmlzaCwgZXhlcmNpc2VEZXRhaWxzLCB1c2VyQW5zd2VycykudGhlbihyZXNwMyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3AzLnN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgUHJvbWlzZS5qb2luKFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZVN0YXJzKHVzZXJJZCwgdG9waWNJZCksXG4gICAgICAgICAgICAgICAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEN1cnJlbnRSYW5raW5nKHRpbWVGaW5pc2gsIHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRUb3RhbFJhbmtpbmcodG9waWNJZCksXG4gICAgICAgICAgICAgICAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlTGVhZGVyYm9hcmQodG9waWNJZCksXG4gICAgICAgICAgICAgICAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlVGltZXJzKHVzZXJJZCwgdG9waWNJZClcbiAgICAgICAgICAgICAgICAgICkuc3ByZWFkKChyZXNwMTE6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDEyOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AxMzogTkNSZXNwb25zZTxhbnk+LCByZXNwMTQ6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDE1OiBOQ1Jlc3BvbnNlPGFueT4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzLmpzb24oe1xuICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBncmFkZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJzSFRNTDogcmVzcDExLmRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lcnNIVE1MOiByZXNwMTUuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmtpbmc6IHJlc3AxNC5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZUZpbmlzaCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSYW5raW5nOiByZXNwMTIuZGF0YS5jb3VudCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsUmFua2luZzogcmVzcDEzLmRhdGEuY291bnRcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJNZXNzYWdlOiByZXNwMy5lcnJNZXNzYWdlXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlcnJNZXNzYWdlOiByZXNwMi5lcnJNZXNzYWdlXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyAobmV3IEVycm9yKHJlc3AuZXJyTWVzc2FnZSkpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGluaXRpYWxpemUgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBQYXRoRm9ybWF0dGVyLmhhc2hBc3NldCgnYXBwJywgJy9hc3NldHMvanMvdG9waWMtZXhlcmNpc2UtYXBwLWJ1bmRsZS5qcycpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgdGhpcy5fYXNzZXRCdW5kbGUgPSByZXN1bHRcbiAgICAgICAgcmVzb2x2ZSgpXG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICByZWplY3QoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ291cnNlQ29udHJvbGxlclxuIl19
