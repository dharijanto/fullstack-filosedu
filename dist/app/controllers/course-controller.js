"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_helper_1=require("../utils/exercise-helper"),topic_exercise_service_1=require("../../services/topic-exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),BaseController=require(path.join(__dirname,"base-controller")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),Utils=require(path.join(__dirname,"../../lib/utils"));const TAG="CourseController";class CourseController extends BaseController{constructor(e){super(e),this.addInterceptor((e,r,t)=>{t()}),this.routeGet("/",(e,r,t)=>{course_service_1.default.getTopicDetails(e.user?e.user.id:null).then(e=>{e.status&&e.data?(r.locals.topics=e.data.topics,r.render("topics")):t(e.errMessage)})}),this.routeGet("/topics/:topicId/:topicSlug/review",PassportHelper.ensureLoggedIn(),(e,r,t)=>{let s=e.params.topicId,i=e.user.id;topic_exercise_service_1.default.getFormattedExercise(s,i).then(e=>{e.status&&e.data?(r.locals.idealTime=e.data.idealTime,r.locals.elapsedTime=e.data.elapsedTime,r.locals.topicName=e.data.topicName,r.locals.bundle=this._assetBundle,r.locals.formattedExercises=e.data.formattedExercises,r.render("topic-exercise")):t(e.errMessage)}).catch(e=>{console.error(e),t(e)})}),this.routeGet("/topics/:topicId/getLeaderboard",(e,r,t)=>{let s=e.params.topicId;void 0===s?r.json({status:!1,errMessage:"topicId is needed"}):e.isAuthenticated?topic_exercise_service_1.default.getExerciseLeaderboard(s).then(e=>{r.json(e)}).catch(e=>{t(e)}):r.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/topics/:topicId/:topicSlug/review",(e,r,t)=>{let s=e.body.userAnswers,i=e.params.topicId,a=e.user.id;return log.verbose(TAG,`submitAnswer.POST(): userId=${a} topicId=${i} userAnswers=${s}`),topic_exercise_service_1.default.getGeneratedTopicExercise(a,i).then(e=>{if(e.status&&e.data){const t=e.data,o=e.data.id;let c=JSON.parse(e.data.exerciseDetail);return topic_exercise_service_1.default.gradeExercise(c,s).then(e=>{if(console.log(JSON.stringify(e,null,2)),e.status&&e.data){const d=e.data,u=exercise_helper_1.default.countTimeFinish(t.createdAt);return topic_exercise_service_1.default.finishExercise(o,d.score,u,c,s).then(e=>{if(!e.status)return r.json({status:!1,errMessage:e.errMessage});Promise.join(topic_exercise_service_1.default.getExerciseStars(a,i),topic_exercise_service_1.default.getCurrentRanking(u,i),topic_exercise_service_1.default.getTotalRanking(i),topic_exercise_service_1.default.getExerciseLeaderboard(i),topic_exercise_service_1.default.getExerciseTimers(a,i)).spread((e,t,s,i,a)=>{r.json({status:!0,data:{grade:d,starsHTML:e.data,timersHTML:a.data,ranking:i.data,timeFinish:u,currentRanking:t.data.count,totalRanking:s.data.count}})})})}return r.json({status:!1,errMessage:e.errMessage})})}throw new Error(e.errMessage)})})}initialize(){return new Promise((e,r)=>{PathFormatter.hashAsset("app","/assets/js/topic-exercise-app-bundle.js").then(r=>{this._assetBundle=r,e()}).catch(e=>{r(e)})})}}module.exports=CourseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvY291cnNlLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJjb3Vyc2Vfc2VydmljZV8xIiwiZXhlcmNpc2VfaGVscGVyXzEiLCJ0b3BpY19leGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwiQmFzZUNvbnRyb2xsZXIiLCJqb2luIiwiX19kaXJuYW1lIiwiUGF0aEZvcm1hdHRlciIsIlBhc3Nwb3J0SGVscGVyIiwiVXRpbHMiLCJUQUciLCJDb3Vyc2VDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsInRoaXMiLCJhZGRJbnRlcmNlcHRvciIsInJlcSIsInJlcyIsIm5leHQiLCJyb3V0ZUdldCIsImRlZmF1bHQiLCJnZXRUb3BpY0RldGFpbHMiLCJ1c2VyIiwiaWQiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsImRhdGEiLCJsb2NhbHMiLCJ0b3BpY3MiLCJyZW5kZXIiLCJlcnJNZXNzYWdlIiwiZW5zdXJlTG9nZ2VkSW4iLCJ0b3BpY0lkIiwicGFyYW1zIiwidXNlcklkIiwiZ2V0Rm9ybWF0dGVkRXhlcmNpc2UiLCJpZGVhbFRpbWUiLCJlbGFwc2VkVGltZSIsInRvcGljTmFtZSIsImJ1bmRsZSIsIl9hc3NldEJ1bmRsZSIsImZvcm1hdHRlZEV4ZXJjaXNlcyIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwidW5kZWZpbmVkIiwianNvbiIsImlzQXV0aGVudGljYXRlZCIsImdldEV4ZXJjaXNlTGVhZGVyYm9hcmQiLCJyb3V0ZVBvc3QiLCJ1c2VyQW5zd2VycyIsImJvZHkiLCJ2ZXJib3NlIiwiZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQiLCJleGVyY2lzZURldGFpbHMiLCJKU09OIiwicGFyc2UiLCJleGVyY2lzZURldGFpbCIsImdyYWRlRXhlcmNpc2UiLCJyZXNwMiIsInN0cmluZ2lmeSIsImdyYWRlIiwidGltZUZpbmlzaCIsImNvdW50VGltZUZpbmlzaCIsImNyZWF0ZWRBdCIsImZpbmlzaEV4ZXJjaXNlIiwic2NvcmUiLCJyZXNwMyIsImdldEV4ZXJjaXNlU3RhcnMiLCJnZXRDdXJyZW50UmFua2luZyIsImdldFRvdGFsUmFua2luZyIsImdldEV4ZXJjaXNlVGltZXJzIiwic3ByZWFkIiwicmVzcDExIiwicmVzcDEyIiwicmVzcDEzIiwicmVzcDE0IiwicmVzcDE1Iiwic3RhcnNIVE1MIiwidGltZXJzSFRNTCIsInJhbmtpbmciLCJjdXJyZW50UmFua2luZyIsImNvdW50IiwidG90YWxSYW5raW5nIiwiRXJyb3IiLCJyZXNvbHZlIiwicmVqZWN0IiwiaGFzaEFzc2V0IiwicmVzdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsaUJBQUFELFFBQUEsaUNBQ0FFLGtCQUFBRixRQUFBLDRCQUNBRyx5QkFBQUgsUUFBQSx5Q0FFQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFBQVEsVUFDZE0sSUFBTU4sUUFBUSxPQUVkTyxlQUFpQlAsUUFBUUksS0FBS0ksS0FBS0MsVUFBVyxvQkFDOUNDLGNBQWdCVixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLDZCQUM3Q0UsZUFBaUJYLFFBQVFJLEtBQUtJLEtBQUtDLFVBQVcsNkJBQzlDRyxNQUFRWixRQUFRSSxLQUFLSSxLQUFLQyxVQUFXLG9CQUV6QyxNQUFNSSxJQUFNLHlCQUVaQyx5QkFBK0JQLGVBQzdCUSxZQUFhQyxHQUNYQyxNQUFNRCxHQUVORSxLQUFLQyxlQUFlLENBQUNDLEVBQUtDLEVBQUtDLEtBQzdCQSxNQUdGSixLQUFLSyxTQUFTLElBQUssQ0FBQ0gsRUFBS0MsRUFBS0MsS0FDNUJyQixpQkFBQXVCLFFBQWNDLGdCQUFnQkwsRUFBSU0sS0FBT04sRUFBSU0sS0FBS0MsR0FBSyxNQUFN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QyxFQUF5QkMsRUFBeUJDLEtBQzVHaEUsRUFBSStCLE1BQ0Z0QixRQUFRLEVBQ1JDLE1BQ0VzQyxNQUFBQSxFQUNBaUIsVUFBV0wsRUFBT2xELEtBQ2xCd0QsV0FBWUYsRUFBT3RELEtBQ25CeUQsUUFBU0osRUFBT3JELEtBQ2hCdUMsV0FBQUEsRUFDQW1CLGVBQWdCUCxFQUFPbkQsS0FBSzJELE1BQzVCQyxhQUFjUixFQUFPcEQsS0FBSzJELGFBWXBDLE9BQU9yRSxFQUFJK0IsTUFDVHRCLFFBQVEsRUFDUkssV0FBWWdDLEVBQU1oQyxlQUt4QixNQUFNLElBQUt5RCxNQUFNL0QsRUFBS00sZ0JBTTlCcEIsYUFDRSxPQUFPLElBQUloQixRQUFRLENBQUM4RixFQUFTQyxLQUMzQnBGLGNBQWNxRixVQUFVLE1BQU8sMkNBQTJDbkUsS0FBS29FLElBQzdFOUUsS0FBSzJCLGFBQWVtRCxFQUNwQkgsTUFDQzlDLE1BQU1DLElBQ1A4QyxFQUFPOUMsUUFNZmlELE9BQU9DLFFBQVVwRiIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvY291cnNlLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuXG5pbXBvcnQgQ291cnNlU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jb3Vyc2Utc2VydmljZSdcbmltcG9ydCBFeGVyY2lzZUhlbHBlciBmcm9tICcuLi91dGlscy9leGVyY2lzZS1oZWxwZXInXG5pbXBvcnQgVG9waWNFeGVyY2lzZVNlcnZpY2UsIHsgR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbCB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RvcGljLWV4ZXJjaXNlLXNlcnZpY2UnXG5cbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxubGV0IHB1ZyA9IHJlcXVpcmUoJ3B1ZycpXG5cbmxldCBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2Jhc2UtY29udHJvbGxlcicpKVxubGV0IFBhdGhGb3JtYXR0ZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvcGF0aC1mb3JtYXR0ZXInKSlcbmxldCBQYXNzcG9ydEhlbHBlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3V0aWxzL3Bhc3Nwb3J0LWhlbHBlcicpKVxubGV0IFV0aWxzID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vbGliL3V0aWxzJykpXG5cbmNvbnN0IFRBRyA9ICdDb3Vyc2VDb250cm9sbGVyJ1xuXG5jbGFzcyBDb3Vyc2VDb250cm9sbGVyIGV4dGVuZHMgQmFzZUNvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvciAoaW5pdERhdGEpIHtcbiAgICBzdXBlcihpbml0RGF0YSlcblxuICAgIHRoaXMuYWRkSW50ZXJjZXB0b3IoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBuZXh0KClcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZUdldCgnLycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgQ291cnNlU2VydmljZS5nZXRUb3BpY0RldGFpbHMocmVxLnVzZXIgPyByZXEudXNlci5pZCA6IG51bGwpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICByZXMubG9jYWxzLnRvcGljcyA9IHJlc3AuZGF0YS50b3BpY3NcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXNwLmRhdGEsIG51bGwsIDIpKVxuICAgICAgICAgIHJlcy5yZW5kZXIoJ3RvcGljcycpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbmV4dChyZXNwLmVyck1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy90b3BpY3MvOnRvcGljSWQvOnRvcGljU2x1Zy9yZXZpZXcnLCBQYXNzcG9ydEhlbHBlci5lbnN1cmVMb2dnZWRJbigpLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG4gICAgICBsZXQgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmdldEZvcm1hdHRlZEV4ZXJjaXNlKHRvcGljSWQsIHVzZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIHJlcy5sb2NhbHMuaWRlYWxUaW1lID0gcmVzcC5kYXRhLmlkZWFsVGltZVxuICAgICAgICAgIHJlcy5sb2NhbHMuZWxhcHNlZFRpbWUgPSByZXNwLmRhdGEuZWxhcHNlZFRpbWVcbiAgICAgICAgICByZXMubG9jYWxzLnRvcGljTmFtZSA9IHJlc3AuZGF0YS50b3BpY05hbWVcbiAgICAgICAgICByZXMubG9jYWxzLmJ1bmRsZSA9IHRoaXMuX2Fzc2V0QnVuZGxlXG4gICAgICAgICAgcmVzLmxvY2Fscy5mb3JtYXR0ZWRFeGVyY2lzZXMgPSByZXNwLmRhdGEuZm9ybWF0dGVkRXhlcmNpc2VzXG4gICAgICAgICAgcmVzLnJlbmRlcigndG9waWMtZXhlcmNpc2UnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5leHQocmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvdG9waWNzLzp0b3BpY0lkL2dldExlYWRlcmJvYXJkJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsZXQgdG9waWNJZCA9IHJlcS5wYXJhbXMudG9waWNJZFxuXG4gICAgICBpZiAodG9waWNJZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYHRvcGljSWQgaXMgbmVlZGVkYCB9KVxuICAgICAgfSBlbHNlIGlmICghcmVxLmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBVbmF1dGhvcml6ZWRgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZUxlYWRlcmJvYXJkKHRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy90b3BpY3MvOnRvcGljSWQvOnRvcGljU2x1Zy9yZXZpZXcnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIC8vIFt7XCJ4XCI6XCI1XCIsXCJ5XCI6XCIxXCJ9LHtcInhcIjpcIjJcIixcInlcIjpcIjNcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9LHtcInhcIjpcIlwifSx7XCJ4XCI6XCJcIn0se1wieFwiOlwiXCJ9XVxuICAgICAgbGV0IHVzZXJBbnN3ZXJzID0gcmVxLmJvZHkudXNlckFuc3dlcnNcbiAgICAgIGxldCB0b3BpY0lkID0gcmVxLnBhcmFtcy50b3BpY0lkXG4gICAgICBsZXQgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgYHN1Ym1pdEFuc3dlci5QT1NUKCk6IHVzZXJJZD0ke3VzZXJJZH0gdG9waWNJZD0ke3RvcGljSWR9IHVzZXJBbnN3ZXJzPSR7dXNlckFuc3dlcnN9YClcbiAgICAgIHJldHVybiBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKHVzZXJJZCwgdG9waWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgICBjb25zdCBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQgPSByZXNwLmRhdGEuaWRcbiAgICAgICAgICBsZXQgZXhlcmNpc2VEZXRhaWxzOiBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlRGV0YWlsW10gPSBKU09OLnBhcnNlKHJlc3AuZGF0YS5leGVyY2lzZURldGFpbClcbiAgICAgICAgICByZXR1cm4gVG9waWNFeGVyY2lzZVNlcnZpY2UuZ3JhZGVFeGVyY2lzZShleGVyY2lzZURldGFpbHMsIHVzZXJBbnN3ZXJzKS50aGVuKHJlc3AyID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlc3AyLCBudWxsLCAyKSlcbiAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgICBjb25zdCBncmFkZSA9IHJlc3AyLmRhdGFcbiAgICAgICAgICAgICAgY29uc3QgdGltZUZpbmlzaCA9IEV4ZXJjaXNlSGVscGVyLmNvdW50VGltZUZpbmlzaChnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLmNyZWF0ZWRBdClcbiAgICAgICAgICAgICAgcmV0dXJuIFRvcGljRXhlcmNpc2VTZXJ2aWNlLmZpbmlzaEV4ZXJjaXNlKGdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZCwgZ3JhZGUuc2NvcmUsIHRpbWVGaW5pc2gsIGV4ZXJjaXNlRGV0YWlscywgdXNlckFuc3dlcnMpLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwMy5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgIFByb21pc2Uuam9pbihcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2VTdGFycyh1c2VySWQsIHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRDdXJyZW50UmFua2luZyh0aW1lRmluaXNoLCB0b3BpY0lkKSxcbiAgICAgICAgICAgICAgICAgICAgVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2V0VG90YWxSYW5raW5nKHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZUxlYWRlcmJvYXJkKHRvcGljSWQpLFxuICAgICAgICAgICAgICAgICAgICBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZVRpbWVycyh1c2VySWQsIHRvcGljSWQpXG4gICAgICAgICAgICAgICAgICApLnNwcmVhZCgocmVzcDExOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AxMjogTkNSZXNwb25zZTxhbnk+LCByZXNwMTM6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDE0OiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AxNTogTkNSZXNwb25zZTxhbnk+KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFyc0hUTUw6IHJlc3AxMS5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJzSFRNTDogcmVzcDE1LmRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5raW5nOiByZXNwMTQuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVGaW5pc2gsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmFua2luZzogcmVzcDEyLmRhdGEuY291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFJhbmtpbmc6IHJlc3AxMy5kYXRhLmNvdW50XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZXJyTWVzc2FnZTogcmVzcDMuZXJyTWVzc2FnZVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICAgICAgICAgIHN0YXR1czogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyTWVzc2FnZTogcmVzcDIuZXJyTWVzc2FnZVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgKG5ldyBFcnJvcihyZXNwLmVyck1lc3NhZ2UpKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBpbml0aWFsaXplICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgUGF0aEZvcm1hdHRlci5oYXNoQXNzZXQoJ2FwcCcsICcvYXNzZXRzL2pzL3RvcGljLWV4ZXJjaXNlLWFwcC1idW5kbGUuanMnKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHRoaXMuX2Fzc2V0QnVuZGxlID0gcmVzdWx0XG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmVqZWN0KGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IENvdXJzZUNvbnRyb2xsZXJcbiJdfQ==
