var path=require("path"),_=require("lodash"),log=require("npmlog"),Promise=require("bluebird"),Sequelize=require("sequelize"),BaseController=require(path.join(__dirname,"base-controller")),SyncService=require(path.join(__dirname,"../../services/sync-server-service"));const TAG="SyncController";class SyncController extends BaseController{constructor(e){super(e);const t=new SyncService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,t,r)=>{r()}),this.routeGet("/synchronization/histories",(e,r,n)=>{const o=e.query.schoolIdentifier;t.getSyncHistories(o).then(e=>{r.json(e)}).catch(e=>{n(e)})}),this.routeGet("/synchronization/readyToSync",(e,r,n)=>{const o=e.query.schoolIdentifier;t.isReadyToSync(o).then(e=>{r.json(e)}).catch(n)}),this.routePost("/synchronization/start",(e,r,n)=>{var o=e.body.data;return log.verbose(TAG,`synchronization.POST(): ${JSON.stringify(o)}`),this.getDb().sequelize.transaction({isolationLevel:Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE},e=>{const n=o.school.identifier;return t.findSchoolIdByIdentifier(n).then(i=>{if(i.status){const s=i.data.id;return t.isReadyToSync(n,e).then(i=>i.status?t.createSyncHistory(n,o.syncTime).then(n=>{const i=n.data.id;return r.json({status:!0}),t.syncData(s,o,e).then(()=>t.updateSyncHistory(i,!0)).catch(e=>t.updateSyncHistory(i,!1).then(()=>{throw e}))}):i)}throw new Error(i.errMessage)})}).then(()=>{log.info(TAG,"synchronization.POST(): Success!")}).catch(e=>{log.error(TAG,e)})})}initialize(){return new Promise((e,t)=>{e()})}}module.exports=SyncController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvc3luYy1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiXyIsImxvZyIsIlByb21pc2UiLCJTZXF1ZWxpemUiLCJCYXNlQ29udHJvbGxlciIsImpvaW4iLCJfX2Rpcm5hbWUiLCJTeW5jU2VydmljZSIsIlRBRyIsIlN5bmNDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsInN5bmNTZXJ2aWNlIiwidGhpcyIsImdldERiIiwic2VxdWVsaXplIiwibW9kZWxzIiwiYWRkSW50ZXJjZXB0b3IiLCJyZXEiLCJyZXMiLCJuZXh0Iiwicm91dGVHZXQiLCJzY2hvb2xJZGVudGlmaWVyIiwicXVlcnkiLCJnZXRTeW5jSGlzdG9yaWVzIiwidGhlbiIsInJlc3AiLCJqc29uIiwiY2F0Y2giLCJlcnIiLCJpc1JlYWR5VG9TeW5jIiwicm91dGVQb3N0Iiwic3luY0RhdGEiLCJib2R5IiwiZGF0YSIsInZlcmJvc2UiLCJKU09OIiwic3RyaW5naWZ5IiwidHJhbnNhY3Rpb24iLCJpc29sYXRpb25MZXZlbCIsIlRyYW5zYWN0aW9uIiwiSVNPTEFUSU9OX0xFVkVMUyIsIlNFUklBTElaQUJMRSIsInRyeCIsInNjaG9vbCIsImlkZW50aWZpZXIiLCJmaW5kU2Nob29sSWRCeUlkZW50aWZpZXIiLCJzdGF0dXMiLCJzY2hvb2xJZCIsImlkIiwiY3JlYXRlU3luY0hpc3RvcnkiLCJzeW5jVGltZSIsInN5bmNIaXN0b3J5SWQiLCJ1cGRhdGVTeW5jSGlzdG9yeSIsIkVycm9yIiwiZXJyTWVzc2FnZSIsImluZm8iLCJlcnJvciIsInJlc29sdmUiLCJyZWplY3QiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxJQUFJQSxLQUFPQyxRQUFRLFFBRWZDLEVBQUlELFFBQVEsVUFDWkUsSUFBTUYsUUFBUSxVQUNkRyxRQUFVSCxRQUFRLFlBQ2xCSSxVQUFZSixRQUFRLGFBRXBCSyxlQUFpQkwsUUFBUUQsS0FBS08sS0FBS0MsVUFBVyxvQkFFOUNDLFlBQWNSLFFBQVFELEtBQUtPLEtBQUtDLFVBQVcsdUNBRS9DLE1BQU1FLElBQU0sdUJBRVpDLHVCQUE2QkwsZUFDM0JNLFlBQWFDLEdBQ1hDLE1BQU1ELEdBQ04sTUFBTUUsRUFBYyxJQUFJTixZQUFZTyxLQUFLQyxRQUFRQyxVQUFXRixLQUFLQyxRQUFRRSxRQUV6RUgsS0FBS0ksZUFBZSxDQUFDQyxFQUFLQyxFQUFLQyxLQUM3QkEsTUFHRlAsS0FBS1EsU0FBUyw2QkFBOEIsQ0FBQ0gsRUFBS0MsRUFBS0MsS0FDckQsTUFBTUUsRUFBbUJKLEVBQUlLLE1BQU1ELGlCQUNuQ1YsRUFBWVksaUJBQWlCRixHQUFrQkcsS0FBS0MsSUFDbERQLEVBQUlRLEtBQUtELEtBQ1JFLE1BQU1DLElBQ1BULEVBQUtTLE9BWVRoQixLQUFLUSxTQUFTLCtCQUFnQyxDQUFDSCxFQUFLQyxFQUFLQyxLQUN2RCxNQUFNRSxFQUFtQkosRUFBSUssTUFBTUQsaUJBQ25DVixFQUFZa0IsY0FBY1IsR0FBa0JHLEtBQUtDLElBQy9DUCxFQUFJUSxLQUFLRCxLQUNSRSxNQUFNUixLQStEWFAsS0FBS2tCLFVBQVUseUJBQTBCLENBQUNiLEVBQUtDLEVBQUtDLEtBQ2xELElBQUlZLEVBQVdkLEVBQUllLEtBQUtDLEtBRXhCLE9BREFsQyxJQUFJbUMsUUFBUTVCLCtCQUFnQzZCLEtBQUtDLFVBQVVMLE1BQ3BEbkIsS0FBS0MsUUFBUUMsVUFBVXVCLGFBQWFDLGVBQWdCckMsVUFBVXNDLFlBQVlDLGlCQUFpQkMsY0FBZUMsSUFDL0csTUFBTXJCLEVBQW1CVSxFQUFTWSxPQUFPQyxXQUN6QyxPQUFPakMsRUFBWWtDLHlCQUF5QnhCLEdBQWtCRyxLQUFLQyxJQUNqRSxHQUFJQSxFQUFLcUIsT0FBUSxDQUNmLE1BQU1DLEVBQVd0QixFQUFLUSxLQUFLZSxHQUMzQixPQUFPckMsRUFBWWtCLGNBQWNSLEVBQWtCcUIsR0FBS2xCLEtBQUtDLEdBQ3ZEQSxFQUFLcUIsT0FDQW5DLEVBQVlzQyxrQkFBa0I1QixFQUFrQlUsRUFBU21CLFVBQVUxQixLQUFLQyxJQUM3RSxNQUFNMEIsRUFBZ0IxQixFQUFLUSxLQUFLZSxHQUdoQyxPQUZBOUIsRUFBSVEsTUFBTW9CLFFBQVEsSUFFWG5DLEVBQVlvQixTQUFTZ0IsRUFBVWhCLEVBQVVXLEdBQUtsQixLQUFLLElBQ2pEYixFQUFZeUMsa0JBQWtCRCxHQUFlLElBQ25EeEIsTUFBTUMsR0FDQWpCLEVBQVl5QyxrQkFBa0JELEdBQWUsR0FBTzNCLEtBQUssS0FDOUQsTUFBTUksT0FLTEgsR0FJWCxNQUFNLElBQUk0QixNQUFNNUIsRUFBSzZCLGdCQUd4QjlCLEtBQUssS0FDTnpCLElBQUl3RCxLQUFLakQsSUFBSyxzQ0FDYnFCLE1BQU1DLElBQ1A3QixJQUFJeUQsTUFBTWxELElBQUtzQixPQUtyQnBCLGFBQ0UsT0FBTyxJQUFJUixRQUFRLENBQUN5RCxFQUFTQyxLQUMzQkQsT0FLTkUsT0FBT0MsUUFBVXJEIiwiZmlsZSI6ImFwcC9jb250cm9sbGVycy9zeW5jLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG52YXIgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbnZhciBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKVxudmFyIFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpXG5cbnZhciBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2Jhc2UtY29udHJvbGxlcicpKVxuXG52YXIgU3luY1NlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy9zeW5jLXNlcnZlci1zZXJ2aWNlJykpXG5cbmNvbnN0IFRBRyA9ICdTeW5jQ29udHJvbGxlcidcblxuY2xhc3MgU3luY0NvbnRyb2xsZXIgZXh0ZW5kcyBCYXNlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yIChpbml0RGF0YSkge1xuICAgIHN1cGVyKGluaXREYXRhKVxuICAgIGNvbnN0IHN5bmNTZXJ2aWNlID0gbmV3IFN5bmNTZXJ2aWNlKHRoaXMuZ2V0RGIoKS5zZXF1ZWxpemUsIHRoaXMuZ2V0RGIoKS5tb2RlbHMpXG5cbiAgICB0aGlzLmFkZEludGVyY2VwdG9yKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbmV4dCgpXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy9zeW5jaHJvbml6YXRpb24vaGlzdG9yaWVzJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBzY2hvb2xJZGVudGlmaWVyID0gcmVxLnF1ZXJ5LnNjaG9vbElkZW50aWZpZXJcbiAgICAgIHN5bmNTZXJ2aWNlLmdldFN5bmNIaXN0b3JpZXMoc2Nob29sSWRlbnRpZmllcikudGhlbihyZXNwID0+IHtcbiAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgLypcbiAgICAgIFRoZSBjbGllbnQgc2VuZCBhIEdFVCByZXF1ZXN0IHRvIHRoaXMgcGF0aCBhbmQgd2UgcmV0dXJuIHdoZXRoZXIgd2UncmUgcmVhZHkgdG8gc3luYyBvciBub3QuXG4gICAgICBXZSdyZSByZWFkeSBpZjpcbiAgICAgIDEuIFdlIGNoZWNrIG9uIHRoZSBsYXN0IHN5bmNIaXN0b3JpZXMgdGFibGUgZW50cnlcbiAgICAgIDIuIElmIGl0J3MgZW1wdHksIHRoaXMgc2Nob29sIGhhcyBuZXZlciBzeW5jZWQuIFdlJ3JlIGdvb2RcbiAgICAgIDMuIElmIHRoZXJlJ3MgZW50cnkuIFdlJ3JlIHJlYWR5IHRvIHN5bmMgaWYgc3RhdHVzICE9PSAnU3luY2luZycgKGkuZSBGYWlsZWQgb3IgUmVhZHkpXG5cbiAgICAqL1xuICAgIHRoaXMucm91dGVHZXQoJy9zeW5jaHJvbml6YXRpb24vcmVhZHlUb1N5bmMnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IHNjaG9vbElkZW50aWZpZXIgPSByZXEucXVlcnkuc2Nob29sSWRlbnRpZmllclxuICAgICAgc3luY1NlcnZpY2UuaXNSZWFkeVRvU3luYyhzY2hvb2xJZGVudGlmaWVyKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2gobmV4dClcbiAgICB9KVxuXG4gICAgLypcbiAgICAgIFRoaXMgaXMgc2VydmVyIHNpZGUgb2YgdGhlIHN5bmNocm9uaXphdGlvbiBtZWNoYW5pc20uIFRoaXMgcGF0aCBpcyBjYWxsZWQgb24gdGhlIHNlcnZlci5cbiAgICAgIDEuIENsaWVudCB1c2VyIGRhdGEgaXMgUE9TVGVkIHdpdGggdGhlIGZvbGxvd2luZyBmb3JtYXQ6XG4gICAgICAgIHtcbiAgICAgICAgICAnc3RhdHVzJzogdHJ1ZVxuICAgICAgICAgICdkYXRhJzoge1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgJ3NjaG9vbCc6IHtcbiAgICAgICAgICAgICAgJ2lkZW50aWZpZXInOiAnc2Vrb2xhaF9jZW5kcmF3YXNpaF9jZW5na2FyZW5nJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdkYXRhcyc6IFt7XG4gICAgICAgICAgICAgICd1c2VyJzoge1xuICAgICAgICAgICAgICAgICAgJ2lkJzogMTQsXG4gICAgICAgICAgICAgICAgICAndXNlcm5hbWUnOiAndGVzdCcsXG4gICAgICAgICAgICAgICAgICAnc2FsdGVkUGFzcyc6ICcxMzIyOTdiMDI2NjE4Y2ZiMmI0MjgxY2Q2OWJmNGVkMzVhMjUwY2IzYjIxZDZlYzhkNDRkZjA4ZmVkMzYzZDdjYWQ3MTljZDAxMjkyNzJiOGQzMDljMDIwYzRiNGQ3Yjg3YTNkMWMxMjAxNmY3MDZjMTJhNjEyOGE5Njg1ZDU2ZScsXG4gICAgICAgICAgICAgICAgICAnc2FsdCc6ICdlZjkyMmQwMDg4OTAwMGFjJyxcbiAgICAgICAgICAgICAgICAgICdlbWFpbCc6ICd0ZXN0QHRlc3QuY29tJyxcbiAgICAgICAgICAgICAgICAgICdmdWxsTmFtZSc6ICd0ZXN0JyxcbiAgICAgICAgICAgICAgICAgICdncmFkZSc6ICcxJyxcbiAgICAgICAgICAgICAgICAgICdjcmVhdGVkQXQnOiAnMjAxOC0wMy0yMlQwODowMDoxMy4wMDBaJyxcbiAgICAgICAgICAgICAgICAgICd1cGRhdGVkQXQnOiAnMjAxOC0wMy0yMlQwODowMDoxMy4wMDBaJyxcbiAgICAgICAgICAgICAgICAgICdzY2hvb2xJZCc6IDJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgJ3N1Ym1pdHRlZEdlbmVyYXRlZEV4ZXJjaXNlcyc6IFt7XG4gICAgICAgICAgICAgICAgICAnaWQnOiAxLFxuICAgICAgICAgICAgICAgICAgJ2V4ZXJjaXNlSGFzaCc6ICc2YThkYjZiMGYzZDk4NTI0MzhmNTFjNjE1OGNhNjc2ZCcsXG4gICAgICAgICAgICAgICAgICAna25vd25zJzogJ1xcJ1t7XFxcXFxcJ2FcXFxcXFwnOjR9LHtcXFxcXFwnYVxcXFxcXCc6M30se1xcXFxcXCdhXFxcXFxcJzoxfSx7XFxcXFxcJ2FcXFxcXFwnOjJ9LHtcXFxcXFwnYVxcXFxcXCc6NX1dXFwnJyxcbiAgICAgICAgICAgICAgICAgICd1bmtub3ducyc6ICdcXCdbe1xcXFxcXCd4XFxcXFxcJzo0fSx7XFxcXFxcJ3hcXFxcXFwnOjN9LHtcXFxcXFwneFxcXFxcXCc6MX0se1xcXFxcXCd4XFxcXFxcJzoyfSx7XFxcXFxcJ3hcXFxcXFwnOjV9XVxcJycsXG4gICAgICAgICAgICAgICAgICAndXNlckFuc3dlcic6ICdbe1xcJ3hcXCc6XFwnXFwnfSx7XFwneFxcJzpcXCdcXCd9LHtcXCd4XFwnOlxcJ1xcJ30se1xcJ3hcXCc6XFwnXFwnfSx7XFwneFxcJzpcXCdcXCd9XScsXG4gICAgICAgICAgICAgICAgICAnc3VibWl0dGVkJzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICdzY29yZSc6IDAsXG4gICAgICAgICAgICAgICAgICAndGltZUZpbmlzaCc6IDEyOTUuMzMsXG4gICAgICAgICAgICAgICAgICAnY3JlYXRlZEF0JzogJzIwMTgtMDQtMDRUMDQ6MjQ6NDYuMDAwWicsXG4gICAgICAgICAgICAgICAgICAndXBkYXRlZEF0JzogJzIwMTgtMDQtMDRUMDQ6NDY6MjEuMDAwWicsXG4gICAgICAgICAgICAgICAgICAnZXhlcmNpc2VJZCc6IDIyLFxuICAgICAgICAgICAgICAgICAgJ3VzZXJJZCc6IDE0XG4gICAgICAgICAgICAgIH1dLFxuICAgICAgICAgICAgICAnc3VibWl0dGVkR2VuZXJhdGVkVG9waWNFeGVyY2lzZXMnOiBbe1xuICAgICAgICAgICAgICAgICAgICAnaWQnOiAxLFxuICAgICAgICAgICAgICAgICAgICAnc3VibWl0dGVkJzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgJ3Njb3JlJzogMCxcbiAgICAgICAgICAgICAgICAgICAgJ3RpbWVGaW5pc2gnOiA4MzAuMTUsXG4gICAgICAgICAgICAgICAgICAgICd0b3BpY0V4ZXJjaXNlSGFzaCc6ICc5OTk5NGJlMWM1NjBhNGMwNDM2NzhmNjQ1NjI0YjY4MicsXG4gICAgICAgICAgICAgICAgICAgICdleGVyY2lzZURldGFpbCc6ICdbe1xcJ2tub3duc1xcJzpcXCdbe1xcXFxcXCdhXFxcXFxcJzozLFxcXFxcXCdiXFxcXFxcJzoyfV1cXCcsXFwndW5rbm93bnNcXCc6XFwnW3tcXFxcXFwneFxcXFxcXCc6NX1dXFwnLFxcJ3VzZXJBbnN3ZXJcXCc6W3tcXCd4XFwnOlxcJ1xcJ31dLFxcJ2V4ZXJjaXNlSWRcXCc6MjV9LHtcXCdrbm93bnNcXCc6XFwnW3tcXFxcXFwnYVxcXFxcXCc6MyxcXFxcXFwnYlxcXFxcXCc6MX1dXFwnLFxcJ3Vua25vd25zXFwnOlxcJ1t7XFxcXFxcJ3hcXFxcXFwnOjR9XVxcJyxcXCd1c2VyQW5zd2VyXFwnOlt7XFwneFxcJzpcXCdcXCd9XSxcXCdleGVyY2lzZUlkXFwnOjI2fSx7XFwna25vd25zXFwnOlxcJ1t7XFxcXFxcJ2FcXFxcXFwnOjEsXFxcXFxcJ2JcXFxcXFwnOjR9XVxcJyxcXCd1bmtub3duc1xcJzpcXCdbe1xcXFxcXCd4XFxcXFxcJzpcXFxcXFwnTGltYVxcXFxcXCd9XVxcJyxcXCd1c2VyQW5zd2VyXFwnOlt7XFwneFxcJzpcXCdcXCd9XSxcXCdleGVyY2lzZUlkXFwnOjMxfSx7XFwna25vd25zXFwnOlxcJ1t7XFxcXFxcJ2FcXFxcXFwnOjEsXFxcXFxcJ2JcXFxcXFwnOjZ9XVxcJyxcXCd1bmtub3duc1xcJzpcXCdbe1xcXFxcXCd4XFxcXFxcJzo3fV1cXCcsXFwndXNlckFuc3dlclxcJzpbe1xcJ3hcXCc6XFwnXFwnfV0sXFwnZXhlcmNpc2VJZFxcJzoyOX0se1xcJ2tub3duc1xcJzpcXCdbe1xcXFxcXCdhXFxcXFxcJzozLFxcXFxcXCdiXFxcXFxcJzo0fV1cXCcsXFwndW5rbm93bnNcXCc6XFwnW3tcXFxcXFwneFxcXFxcXCc6XFxcXFxcJ1R1anVoXFxcXFxcJ31dXFwnLFxcJ3VzZXJBbnN3ZXJcXCc6W3tcXCd4XFwnOlxcJ1xcJ31dLFxcJ2V4ZXJjaXNlSWRcXCc6MzJ9LHtcXCdrbm93bnNcXCc6XFwnW3tcXFxcXFwnYVxcXFxcXCc6MTEsXFxcXFxcJ2JcXFxcXFwnOjI0fV1cXCcsXFwndW5rbm93bnNcXCc6XFwnW3tcXFxcXFwneFxcXFxcXCc6MzV9XVxcJyxcXCd1c2VyQW5zd2VyXFwnOlt7XFwneFxcJzpcXCdcXCd9XSxcXCdleGVyY2lzZUlkXFwnOjZ9LHtcXCdrbm93bnNcXCc6XFwnW3tcXFxcXFwnYVxcXFxcXCc6MzksXFxcXFxcJ2JcXFxcXFwnOjUxfV1cXCcsXFwndW5rbm93bnNcXCc6XFwnW3tcXFxcXFwneFxcXFxcXCc6OTB9XVxcJyxcXCd1c2VyQW5zd2VyXFwnOlt7XFwneFxcJzpcXCdcXCd9XSxcXCdleGVyY2lzZUlkXFwnOjd9LHtcXCdrbm93bnNcXCc6XFwnW3tcXFxcXFwnYVxcXFxcXCc6NDYsXFxcXFxcJ2JcXFxcXFwnOjExfV1cXCcsXFwndW5rbm93bnNcXCc6XFwnW3tcXFxcXFwneFxcXFxcXCc6NTd9XVxcJyxcXCd1c2VyQW5zd2VyXFwnOlt7XFwneFxcJzpcXCc1NTU1XFwnfV0sXFwnZXhlcmNpc2VJZFxcJzo4fV0nLFxuICAgICAgICAgICAgICAgICAgICAnY3JlYXRlZEF0JzogJzIwMTgtMDMtMjhUMDk6MDg6NTYuMDAwWicsXG4gICAgICAgICAgICAgICAgICAgICd1cGRhdGVkQXQnOiAnMjAxOC0wMy0yOFQwOToyMjo0Ni4wMDBaJyxcbiAgICAgICAgICAgICAgICAgICAgJ3RvcGljSWQnOiAxMixcbiAgICAgICAgICAgICAgICAgICAgJ3VzZXJJZCc6IDE0XG4gICAgICAgICAgICAgICAgfV1cbiAgICAgICAgICAgIH1dXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAyLiBDaGVjayBkYXRhYmFzZSBpZiB0aGVyZSdzIHNjaG9vbCB3aXRoIHRoZSBzYW1lIGlkZW50aWZpZXIuXG4gICAgICAzLiBDaGVjayB3aXRoIHN5bmNocm9uaXphdGlvbnMgdGFibGUgdG8gZ2V0IG1hcHBpbmcgZnJvbSBjbGllbnQncyBpZCB0byBzZXJ2ZXIncyBpZFxuICAgICAgNC4gSWYgdGhlcmUncyBhbHJlYWR5IG1hcHBpbmcsIHVwZGF0ZSB0aGUgZGF0YVxuICAgICAgNS4gSWYgdGhlcmUncyBubyBtYXBwaW5nLCBhZGQgbmV3IGRhdGEsIHNhdmUgdGhlIG1hcHBpbmcgdG8gc3luY2hyb25pemF0aW9uIHRhYmxlXG4gICAgICA2LiBJZiBldmVyeSBpcyBzdWNjZXNzZnVsLCBjb21taXQgdGhlIHRyYW5zYWN0aW9uLiBPdGhlcndpc2UsIGFib3J0XG4gICAgICA3LiBSZXNwb25kIHRvIGNsaWVudFxuXG4gICAgKi9cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3N5bmNocm9uaXphdGlvbi9zdGFydCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgdmFyIHN5bmNEYXRhID0gcmVxLmJvZHkuZGF0YVxuICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgc3luY2hyb25pemF0aW9uLlBPU1QoKTogJHtKU09OLnN0cmluZ2lmeShzeW5jRGF0YSl9YClcbiAgICAgIHJldHVybiB0aGlzLmdldERiKCkuc2VxdWVsaXplLnRyYW5zYWN0aW9uKHtpc29sYXRpb25MZXZlbDogU2VxdWVsaXplLlRyYW5zYWN0aW9uLklTT0xBVElPTl9MRVZFTFMuU0VSSUFMSVpBQkxFfSwgdHJ4ID0+IHtcbiAgICAgICAgY29uc3Qgc2Nob29sSWRlbnRpZmllciA9IHN5bmNEYXRhLnNjaG9vbC5pZGVudGlmaWVyXG4gICAgICAgIHJldHVybiBzeW5jU2VydmljZS5maW5kU2Nob29sSWRCeUlkZW50aWZpZXIoc2Nob29sSWRlbnRpZmllcikudGhlbihyZXNwID0+IHsgXG4gICAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICBjb25zdCBzY2hvb2xJZCA9IHJlc3AuZGF0YS5pZFxuICAgICAgICAgICAgcmV0dXJuIHN5bmNTZXJ2aWNlLmlzUmVhZHlUb1N5bmMoc2Nob29sSWRlbnRpZmllciwgdHJ4KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3luY1NlcnZpY2UuY3JlYXRlU3luY0hpc3Rvcnkoc2Nob29sSWRlbnRpZmllciwgc3luY0RhdGEuc3luY1RpbWUpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBzeW5jSGlzdG9yeUlkID0gcmVzcC5kYXRhLmlkXG4gICAgICAgICAgICAgICAgICByZXMuanNvbih7c3RhdHVzOiB0cnVlfSlcbiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IFBhcyByZWFkLCBtYXUgZGkga2FzaSB0cngganVnYVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bmNTZXJ2aWNlLnN5bmNEYXRhKHNjaG9vbElkLCBzeW5jRGF0YSwgdHJ4KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bmNTZXJ2aWNlLnVwZGF0ZVN5bmNIaXN0b3J5KHN5bmNIaXN0b3J5SWQsIHRydWUpXG4gICAgICAgICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3luY1NlcnZpY2UudXBkYXRlU3luY0hpc3Rvcnkoc3luY0hpc3RvcnlJZCwgZmFsc2UpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIHRocm93IGVyclxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZXNwLmVyck1lc3NhZ2UpXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSkudGhlbigoKSA9PiB7XG4gICAgICAgIGxvZy5pbmZvKFRBRywgJ3N5bmNocm9uaXphdGlvbi5QT1NUKCk6IFN1Y2Nlc3MhJylcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGxvZy5lcnJvcihUQUcsIGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGluaXRpYWxpemUgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICByZXNvbHZlKClcbiAgICB9KVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3luY0NvbnRyb2xsZXJcbiJdfQ==
