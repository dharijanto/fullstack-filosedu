"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_service_1=require("../../services/exercise-service");let path=require("path"),moment=require("moment-timezone"),log=require("npmlog"),AnalyticsService=require(path.join(__dirname,"../../services/analytics-service")),BaseController=require(path.join(__dirname,"base-controller")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),Formatter=require(path.join(__dirname,"../../lib/utils/formatter")),Utils=require(path.join(__dirname,"../utils/utils"));const TAG="ExerciseController";class ExerciseController extends BaseController{initialize(){return new Promise((e,r)=>{PathFormatter.hashAsset("app","/assets/js/exercise-app-bundle.js").then(r=>{this.exerciseFrontendJS=r,e()}).catch(e=>{r(e)})})}constructor(e){super(e);const r=new AnalyticsService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,r,s)=>{s()}),this.routeGet("/:topicId/:topicSlug/:subtopicId/:subtopicSlug/:exerciseId/:exerciseSlug",PassportHelper.ensureLoggedIn(),(e,r,s)=>{const t=e.user.id,i=e.params.exerciseId,a=e.params.subtopicId;Promise.join(exercise_service_1.default.getFormattedExercise(i,t),exercise_service_1.default.getRenderedExerciseStars(t,i),exercise_service_1.default.getRenderedExerciseTimers(t,i),course_service_1.default.getPreviousAndNextExercise(a,i),course_service_1.default.getPreviousAndNextSubtopic(a),course_service_1.default.getSubtopic(a)).spread((e,t,i,a,c,o)=>{if(e.status&&e.data&&a.status&&a.data&&c.status&&c.data&&o.status&&o.data){const s=a.data,d=c.data;r.locals.formattedExercise=e.data.formattedExercise,r.locals.elapsedTime=e.data.elapsedTime,r.locals.idealTime=e.data.idealTime,r.locals.exerciseId=e.data.exerciseId,r.locals.prevLink=s&&s.prev?Formatter.getExerciseURL(s.prev):d&&d.prev?Formatter.getSubtopicURL(d.prev):null,r.locals.nextLink=s&&s.next?Formatter.getExerciseURL(s.next):d&&d.next?Formatter.getSubtopicURL(d.next):null,r.locals.starsHTML=t.status?t.data:'<p style="color:red;"> Unable to retrieve stars... </p>',r.locals.timersHTML=i.status?i.data:'<p style="color:red;"> Unable to retrieve timers... </p>',r.locals.subtopic=o.data,r.locals.bundle=this.exerciseFrontendJS,r.render("exercise")}else s(new Error(e.errMessage||a.errMessage||c.errMessage||o.errMessage))}).catch(s)}),this.routeGet("/getExerciseStars",PassportHelper.ensureLoggedIn(),(e,r,s)=>{const t=parseInt(e.query.exerciseId,10);void 0===t?r.json({status:!1,errMessage:"exerciseId is needed"}):e.isAuthenticated?exercise_service_1.default.getExerciseStars(e.user.id,t).then(e=>{r.json(e)}).catch(e=>{s(e)}):r.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/exercise/getLeaderboard",(e,r,s)=>{const t=parseInt(e.body.exerciseId,10);void 0===t?r.json({status:!1,errMessage:"exerciseId is needed"}):e.isAuthenticated?exercise_service_1.default.getExerciseLeaderboard(t).then(e=>{r.json(e)}).catch(e=>{s(e)}):r.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/:topicId/:topicSlug/:subtopicId/:subtopicSlug/:exerciseId/:exerciseSlug",PassportHelper.ensureLoggedIn(),(e,s,t)=>{const i=e.user.id,a=e.body.exerciseId,c=e.body.answers;console.dir(e.body),exercise_service_1.default.finishExercise(a,i,c).then(e=>{if(s.status&&e.data){const t=e.data,o=c.reduce((e,r)=>{return Object.values(r).reduce((e,r)=>e||r.length>0,!1)?e+1:0},0)/c.length*100;r.addExerciseSubmissionStats(t.score,o,a,i).then(e=>{e.status||log.error(TAG,"submitAnswer.POST(): failed to add analytics: "+JSON.stringify(e))}).catch(e=>log.error(TAG,e)),Promise.join(exercise_service_1.default.getRenderedExerciseStars(i,a),exercise_service_1.default.getExerciseLeaderboard(a),exercise_service_1.default.getCurrentRanking(t.timeFinish,a),exercise_service_1.default.getTotalRanking(a),exercise_service_1.default.getRenderedExerciseTimers(i,a)).spread((e,r,i,a,c)=>{s.json({status:!0,data:{correctAnswers:t.correctAnswers,isCorrect:t.isCorrect,score:t.score,starsHTML:e.data,timersHTML:c.data,ranking:r.data,timeFinish:t.timeFinish,currentRanking:i.data.count,totalRanking:a.data.count}})})}})}),this.routePost("/exercise/analytics",(e,s,t)=>{const i=e.body.key,a=e.body.exerciseId,c=e.user&&e.user.id||-1,o=e.body.value;r.addExerciseData(i,o,a,c).then(e=>{s.json(e)}).catch(e=>{t(e)})})}}module.exports=ExerciseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsImNvdXJzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibW9tZW50IiwibG9nIiwiQW5hbHl0aWNzU2VydmljZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJCYXNlQ29udHJvbGxlciIsIlBhc3Nwb3J0SGVscGVyIiwiUGF0aEZvcm1hdHRlciIsIkZvcm1hdHRlciIsIlV0aWxzIiwiVEFHIiwiRXhlcmNpc2VDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwicmVzb2x2ZSIsInJlamVjdCIsImhhc2hBc3NldCIsInRoZW4iLCJyZXN1bHQiLCJ0aGlzIiwiZXhlcmNpc2VGcm9udGVuZEpTIiwiY2F0Y2giLCJlcnIiLCJpbml0RGF0YSIsInN1cGVyIiwiYW5hbHl0aWNzU2VydmljZSIsImdldERiIiwic2VxdWVsaXplIiwibW9kZWxzIiwiYWRkSW50ZXJjZXB0b3IiLCJyZXEiLCJyZXMiLCJuZXh0Iiwicm91dGVHZXQiLCJlbnN1cmVMb2dnZWRJbiIsInVzZXJJZCIsInVzZXIiLCJpZCIsImV4ZXJjaXNlSWQiLCJwYXJhbXMiLCJzdWJ0b3BpY0lkIiwiZGVmYXVsdCIsImdldEZvcm1hdHRlZEV4ZXJjaXNlIiwiZ2V0UmVuZGVyZWRFeGVyY2lzZVN0YXJzIiwiZ2V0UmVuZGVyZWRFeGVyY2lzZVRpbWVycyIsImdldFByZXZpb3VzQW5kTmV4dEV4ZXJjaXNlIiwiZ2V0UHJldmlvdXNBbmROZXh0U3VidG9waWMiLCJnZXRTdWJ0b3BpYyIsInNwcmVhZCIsInJlc3AxIiwicmVzcDIiLCJyZXNwMyIsInJlc3A0IiwicmVzcDUiLCJyZXNwNiIsInN0YXR1cyIsImRhdGEiLCJwcmV2QW5kTmV4dEV4ZXJjaXNlIiwicHJldkFuZE5leHRTdWJ0b3BpYyIsImxvY2FscyIsImZvcm1hdHRlZEV4ZXJjaXNlIiwiZWxhcHNlZFRpbWUiLCJpZGVhbFRpbWUiLCJwcmV2TGluayIsInByZXYiLCJnZXRFeGVyY2lzZVVSTCIsImdldFN1YnRvcGljVVJMIiwibmV4dExpbmsiLCJzdGFyc0hUTUwiLCJ0aW1lcnNIVE1MIiwic3VidG9waWMiLCJidW5kbGUiLCJyZW5kZXIiLCJFcnJvciIsImVyck1lc3NhZ2UiLCJwYXJzZUludCIsInF1ZXJ5IiwidW5kZWZpbmVkIiwianNvbiIsImlzQXV0aGVudGljYXRlZCIsImdldEV4ZXJjaXNlU3RhcnMiLCJyZXNwIiwicm91dGVQb3N0IiwiYm9keSIsImdldEV4ZXJjaXNlTGVhZGVyYm9hcmQiLCJhbnN3ZXJzIiwiY29uc29sZSIsImRpciIsImZpbmlzaEV4ZXJjaXNlIiwiZ3JhZGUiLCJhdHRlbXB0c1BlcmNlbnRhZ2UiLCJyZWR1Y2UiLCJjb3VudCIsImFuc3dlciIsIk9iamVjdCIsInZhbHVlcyIsImFjYyIsInVzZXJJbnB1dCIsImxlbmd0aCIsImFkZEV4ZXJjaXNlU3VibWlzc2lvblN0YXRzIiwic2NvcmUiLCJlcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXRDdXJyZW50UmFua2luZyIsInRpbWVGaW5pc2giLCJnZXRUb3RhbFJhbmtpbmciLCJjb3JyZWN0QW5zd2VycyIsImlzQ29ycmVjdCIsInJhbmtpbmciLCJjdXJyZW50UmFua2luZyIsInRvdGFsUmFua2luZyIsImtleSIsInZhbHVlIiwiYWRkRXhlcmNpc2VEYXRhIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFDQUMsaUJBQUFELFFBQUEsaUNBQ0FFLG1CQUFBRixRQUFBLG1DQUlBLElBQUlHLEtBQU9ILFFBQVEsUUFFZkksT0FBU0osUUFBUSxtQkFFakJLLElBQU1MLFFBQVEsVUFFZE0saUJBQW1CTixRQUFRRyxLQUFLSSxLQUFLQyxVQUFXLHFDQUNoREMsZUFBaUJULFFBQVFHLEtBQUtJLEtBQUtDLFVBQVcsb0JBQzlDRSxlQUFpQlYsUUFBUUcsS0FB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RSxJQUNwRWxELEVBQUkrQyxLQUFLRyxLQUNSNUQsTUFBTUMsSUFDUFUsRUFBS1YsUUFNYjZGLE9BQU9DLFFBQVV4RyIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgQ291cnNlU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jb3Vyc2Utc2VydmljZSdcbmltcG9ydCBFeGVyY2lzZVNlcnZpY2UsIHsgRXhlcmNpc2VBbnN3ZXIgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9leGVyY2lzZS1zZXJ2aWNlJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uLy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IEV4ZXJjaXNlSGVscGVyIGZyb20gJy4uL3V0aWxzL2V4ZXJjaXNlLWhlbHBlcidcblxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxubGV0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudC10aW1lem9uZScpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxuXG5sZXQgQW5hbHl0aWNzU2VydmljZSA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL3NlcnZpY2VzL2FuYWx5dGljcy1zZXJ2aWNlJykpXG5sZXQgQmFzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdiYXNlLWNvbnRyb2xsZXInKSlcbmxldCBQYXNzcG9ydEhlbHBlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3V0aWxzL3Bhc3Nwb3J0LWhlbHBlcicpKVxubGV0IFBhdGhGb3JtYXR0ZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvcGF0aC1mb3JtYXR0ZXInKSlcblxubGV0IEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi91dGlscy9mb3JtYXR0ZXInKSlcbmxldCBVdGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3V0aWxzL3V0aWxzJykpXG5cbmNvbnN0IFRBRyA9ICdFeGVyY2lzZUNvbnRyb2xsZXInXG5cbmNsYXNzIEV4ZXJjaXNlQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgcHJpdmF0ZSBleGVyY2lzZUZyb250ZW5kSlM6IHN0cmluZ1xuICBpbml0aWFsaXplICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgUGF0aEZvcm1hdHRlci5oYXNoQXNzZXQoJ2FwcCcsICcvYXNzZXRzL2pzL2V4ZXJjaXNlLWFwcC1idW5kbGUuanMnKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHRoaXMuZXhlcmNpc2VGcm9udGVuZEpTID0gcmVzdWx0XG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmVqZWN0KGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0cnVjdG9yIChpbml0RGF0YSkge1xuICAgIHN1cGVyKGluaXREYXRhKVxuICAgIGNvbnN0IGFuYWx5dGljc1NlcnZpY2UgPSBuZXcgQW5hbHl0aWNzU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuICAgIHRoaXMuYWRkSW50ZXJjZXB0b3IoKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBuZXh0KClcbiAgICB9KVxuXG4gICAgLy8gQ29udGludWUvc3RhcnQgYW4gZXhlcmNpc2VcbiAgICB0aGlzLnJvdXRlR2V0KCcvOnRvcGljSWQvOnRvcGljU2x1Zy86c3VidG9waWNJZC86c3VidG9waWNTbHVnLzpleGVyY2lzZUlkLzpleGVyY2lzZVNsdWcnLCBQYXNzcG9ydEhlbHBlci5lbnN1cmVMb2dnZWRJbigpLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkXG4gICAgICBjb25zdCBleGVyY2lzZUlkID0gcmVxLnBhcmFtcy5leGVyY2lzZUlkXG4gICAgICBjb25zdCBzdWJ0b3BpY0lkID0gcmVxLnBhcmFtcy5zdWJ0b3BpY0lkXG5cbiAgICAgIFByb21pc2Uuam9pbjxhbnk+KFxuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0Rm9ybWF0dGVkRXhlcmNpc2UoZXhlcmNpc2VJZCwgdXNlcklkKSxcbiAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldFJlbmRlcmVkRXhlcmNpc2VTdGFycyh1c2VySWQsIGV4ZXJjaXNlSWQpLFxuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRFeGVyY2lzZVRpbWVycyh1c2VySWQsIGV4ZXJjaXNlSWQpLFxuICAgICAgICBDb3Vyc2VTZXJ2aWNlLmdldFByZXZpb3VzQW5kTmV4dEV4ZXJjaXNlKHN1YnRvcGljSWQsIGV4ZXJjaXNlSWQpLFxuICAgICAgICBDb3Vyc2VTZXJ2aWNlLmdldFByZXZpb3VzQW5kTmV4dFN1YnRvcGljKHN1YnRvcGljSWQpLFxuICAgICAgICBDb3Vyc2VTZXJ2aWNlLmdldFN1YnRvcGljKHN1YnRvcGljSWQpXG4gICAgICApLnNwcmVhZCgocmVzcDE6IE5DUmVzcG9uc2U8Rm9ybWF0dGVkU3VidG9waWNFeGVyY2lzZT4sXG4gICAgICAgICAgICAgICAgcmVzcDI6IE5DUmVzcG9uc2U8c3RyaW5nPixcbiAgICAgICAgICAgICAgICByZXNwMzogTkNSZXNwb25zZTxzdHJpbmc+LFxuICAgICAgICAgICAgICAgIHJlc3A0OiBOQ1Jlc3BvbnNlPHsgbmV4dD86IEV4ZXJjaXNlLCBwcmV2PzogRXhlcmNpc2V9PixcbiAgICAgICAgICAgICAgICByZXNwNTogTkNSZXNwb25zZTx7IG5leHQ/OiBTdWJ0b3BpYywgcHJldj86IFN1YnRvcGljfT4sXG4gICAgICAgICAgICAgICAgcmVzcDY6IE5DUmVzcG9uc2U8U3VidG9waWM+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwMS5zdGF0dXMgJiYgcmVzcDEuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDQuc3RhdHVzICYmIHJlc3A0LmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3A1LnN0YXR1cyAmJiByZXNwNS5kYXRhICYmXG4gICAgICAgICAgICByZXNwNi5zdGF0dXMgJiYgcmVzcDYuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IHByZXZBbmROZXh0RXhlcmNpc2UgPSByZXNwNC5kYXRhXG4gICAgICAgICAgY29uc3QgcHJldkFuZE5leHRTdWJ0b3BpYyA9IHJlc3A1LmRhdGFcbiAgICAgICAgICByZXMubG9jYWxzLmZvcm1hdHRlZEV4ZXJjaXNlID0gcmVzcDEuZGF0YS5mb3JtYXR0ZWRFeGVyY2lzZVxuICAgICAgICAgIHJlcy5sb2NhbHMuZWxhcHNlZFRpbWUgPSByZXNwMS5kYXRhLmVsYXBzZWRUaW1lXG4gICAgICAgICAgcmVzLmxvY2Fscy5pZGVhbFRpbWUgPSByZXNwMS5kYXRhLmlkZWFsVGltZVxuICAgICAgICAgIHJlcy5sb2NhbHMuZXhlcmNpc2VJZCA9IHJlc3AxLmRhdGEuZXhlcmNpc2VJZFxuICAgICAgICAgIHJlcy5sb2NhbHMucHJldkxpbmsgPSBwcmV2QW5kTmV4dEV4ZXJjaXNlICYmIHByZXZBbmROZXh0RXhlcmNpc2UucHJldlxuICAgICAgICAgICAgICA/IEZvcm1hdHRlci5nZXRFeGVyY2lzZVVSTChwcmV2QW5kTmV4dEV4ZXJjaXNlLnByZXYpXG4gICAgICAgICAgICAgIDogKHByZXZBbmROZXh0U3VidG9waWMgJiYgcHJldkFuZE5leHRTdWJ0b3BpYy5wcmV2ID9cbiAgICAgICAgICAgICAgICAgICAgRm9ybWF0dGVyLmdldFN1YnRvcGljVVJMKHByZXZBbmROZXh0U3VidG9waWMucHJldikgOiBudWxsKVxuICAgICAgICAgIHJlcy5sb2NhbHMubmV4dExpbmsgPSBwcmV2QW5kTmV4dEV4ZXJjaXNlICYmIHByZXZBbmROZXh0RXhlcmNpc2UubmV4dFxuICAgICAgICAgICAgICA/IEZvcm1hdHRlci5nZXRFeGVyY2lzZVVSTChwcmV2QW5kTmV4dEV4ZXJjaXNlLm5leHQpXG4gICAgICAgICAgICAgIDogKHByZXZBbmROZXh0U3VidG9waWMgJiYgcHJldkFuZE5leHRTdWJ0b3BpYy5uZXh0ID9cbiAgICAgICAgICAgICAgICAgICAgRm9ybWF0dGVyLmdldFN1YnRvcGljVVJMKHByZXZBbmROZXh0U3VidG9waWMubmV4dCkgOiBudWxsKVxuICAgICAgICAgIHJlcy5sb2NhbHMuc3RhcnNIVE1MID0gcmVzcDIuc3RhdHVzID8gcmVzcDIuZGF0YSA6ICc8cCBzdHlsZT1cImNvbG9yOnJlZDtcIj4gVW5hYmxlIHRvIHJldHJpZXZlIHN0YXJzLi4uIDwvcD4nXG4gICAgICAgICAgcmVzLmxvY2Fscy50aW1lcnNIVE1MID0gcmVzcDMuc3RhdHVzID8gcmVzcDMuZGF0YSA6ICc8cCBzdHlsZT1cImNvbG9yOnJlZDtcIj4gVW5hYmxlIHRvIHJldHJpZXZlIHRpbWVycy4uLiA8L3A+J1xuICAgICAgICAgIHJlcy5sb2NhbHMuc3VidG9waWMgPSByZXNwNi5kYXRhXG5cbiAgICAgICAgICByZXMubG9jYWxzLmJ1bmRsZSA9IHRoaXMuZXhlcmNpc2VGcm9udGVuZEpTXG4gICAgICAgICAgcmVzLnJlbmRlcignZXhlcmNpc2UnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5leHQobmV3IEVycm9yKHJlc3AxLmVyck1lc3NhZ2UgfHwgcmVzcDQuZXJyTWVzc2FnZSB8fCByZXNwNS5lcnJNZXNzYWdlIHx8IHJlc3A2LmVyck1lc3NhZ2UpKVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChuZXh0KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvZ2V0RXhlcmNpc2VTdGFycycsIFBhc3Nwb3J0SGVscGVyLmVuc3VyZUxvZ2dlZEluKCksIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgZXhlcmNpc2VJZCA9IHBhcnNlSW50KHJlcS5xdWVyeS5leGVyY2lzZUlkLCAxMClcbiAgICAgIGlmIChleGVyY2lzZUlkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgZXhlcmNpc2VJZCBpcyBuZWVkZWRgIH0pXG4gICAgICB9IGVsc2UgaWYgKCFyZXEuaXNBdXRoZW50aWNhdGVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYFVuYXV0aG9yaXplZGAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHN1YnRvcGljIHN0YXJzXG4gICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZVN0YXJzKHJlcS51c2VyLmlkLCBleGVyY2lzZUlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgIHJlcy5qc29uKHJlc3ApXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgbmV4dChlcnIpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMucm91dGVQb3N0KCcvZXhlcmNpc2UvZ2V0TGVhZGVyYm9hcmQnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSBwYXJzZUludChyZXEuYm9keS5leGVyY2lzZUlkLCAxMClcbiAgICAgIGlmIChleGVyY2lzZUlkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgZXhlcmNpc2VJZCBpcyBuZWVkZWRgIH0pXG4gICAgICB9IGVsc2UgaWYgKCFyZXEuaXNBdXRoZW50aWNhdGVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYFVuYXV0aG9yaXplZGAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZUxlYWRlcmJvYXJkKGV4ZXJjaXNlSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgLy8gRXhlcmNpc2Ugc3VibWlzc2lvblxuICAgIHRoaXMucm91dGVQb3N0KFxuICAgICAgJy86dG9waWNJZC86dG9waWNTbHVnLzpzdWJ0b3BpY0lkLzpzdWJ0b3BpY1NsdWcvOmV4ZXJjaXNlSWQvOmV4ZXJjaXNlU2x1ZycsXG4gICAgICBQYXNzcG9ydEhlbHBlci5lbnN1cmVMb2dnZWRJbigpLFxuICAgICAgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkXG4gICAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSByZXEuYm9keS5leGVyY2lzZUlkXG4gICAgICAgIGNvbnN0IGFuc3dlcnM6IEV4ZXJjaXNlQW5zd2VyID0gcmVxLmJvZHkuYW5zd2Vyc1xuICAgICAgICBjb25zb2xlLmRpcihyZXEuYm9keSlcbiAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmZpbmlzaEV4ZXJjaXNlKGV4ZXJjaXNlSWQsIHVzZXJJZCwgYW5zd2VycykudGhlbihyZXNwID0+IHtcbiAgICAgICAgICBpZiAocmVzLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyYWRlID0gcmVzcC5kYXRhXG5cbiAgICAgICAgICAgIC8vIERvZXMgdGhlIHN0dWRlbnQgZXZlbiB0cnk/XG4gICAgICAgICAgICBjb25zdCBhdHRlbXB0c1BlcmNlbnRhZ2UgPSBhbnN3ZXJzLnJlZHVjZSgoY291bnQsIGFuc3dlcikgPT4ge1xuICAgICAgICAgICAgICBjb25zdCB1c2VySW5wdXRzID0gT2JqZWN0LnZhbHVlczxzdHJpbmc+KGFuc3dlcilcbiAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGF0IGxlYXN0IG9uZSBpbnB1dCBpcyBub3QgZW1wdHlcbiAgICAgICAgICAgICAgbGV0IGF0dGVtcHRlZCA9IHVzZXJJbnB1dHMucmVkdWNlKChhY2MsIHVzZXJJbnB1dCkgPT4gYWNjIHx8IHVzZXJJbnB1dC5sZW5ndGggPiAwLCBmYWxzZSlcbiAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRlZCA/IGNvdW50ICsgMSA6IDBcbiAgICAgICAgICAgIH0sIDApIC8gYW5zd2Vycy5sZW5ndGggKiAxMDBcblxuICAgICAgICAgICAgYW5hbHl0aWNzU2VydmljZS5hZGRFeGVyY2lzZVN1Ym1pc3Npb25TdGF0cyhcbiAgICAgICAgICAgICAgZ3JhZGUuc2NvcmUsXG4gICAgICAgICAgICAgIGF0dGVtcHRzUGVyY2VudGFnZSxcbiAgICAgICAgICAgICAgZXhlcmNpc2VJZCxcbiAgICAgICAgICAgICAgdXNlcklkXG4gICAgICAgICAgICApLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICAgIGlmICghcmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoVEFHLCAnc3VibWl0QW5zd2VyLlBPU1QoKTogZmFpbGVkIHRvIGFkZCBhbmFseXRpY3M6ICcgKyBKU09OLnN0cmluZ2lmeShyZXNwKSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IGxvZy5lcnJvcihUQUcsIGVycikpXG5cbiAgICAgICAgICAgIFByb21pc2Uuam9pbihcbiAgICAgICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldFJlbmRlcmVkRXhlcmNpc2VTdGFycyh1c2VySWQsIGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2VMZWFkZXJib2FyZChleGVyY2lzZUlkKSxcbiAgICAgICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEN1cnJlbnRSYW5raW5nKGdyYWRlLnRpbWVGaW5pc2gsIGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0VG90YWxSYW5raW5nKGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRFeGVyY2lzZVRpbWVycyh1c2VySWQsIGV4ZXJjaXNlSWQpXG4gICAgICAgICAgICApLnNwcmVhZCgocmVzcDI6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDM6IE5DUmVzcG9uc2U8YW55PixcbiAgICAgICAgICAgICAgICAgICAgICByZXNwNDogTkNSZXNwb25zZTxhbnk+LCByZXNwNTogTkNSZXNwb25zZTxhbnk+LCByZXNwNjogTkNSZXNwb25zZTxhbnk+KSA9PiB7XG4gICAgICAgICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgY29ycmVjdEFuc3dlcnM6IGdyYWRlLmNvcnJlY3RBbnN3ZXJzLFxuICAgICAgICAgICAgICAgICAgaXNDb3JyZWN0OiBncmFkZS5pc0NvcnJlY3QsXG4gICAgICAgICAgICAgICAgICBzY29yZTogZ3JhZGUuc2NvcmUsXG4gICAgICAgICAgICAgICAgICBzdGFyc0hUTUw6IHJlc3AyLmRhdGEsXG4gICAgICAgICAgICAgICAgICB0aW1lcnNIVE1MOiByZXNwNi5kYXRhLFxuICAgICAgICAgICAgICAgICAgcmFua2luZzogcmVzcDMuZGF0YSxcbiAgICAgICAgICAgICAgICAgIHRpbWVGaW5pc2g6IGdyYWRlLnRpbWVGaW5pc2gsXG4gICAgICAgICAgICAgICAgICBjdXJyZW50UmFua2luZzogcmVzcDQuZGF0YS5jb3VudCxcbiAgICAgICAgICAgICAgICAgIHRvdGFsUmFua2luZzogcmVzcDUuZGF0YS5jb3VudFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSlcblxuICAgIHRoaXMucm91dGVQb3N0KCcvZXhlcmNpc2UvYW5hbHl0aWNzJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAvLyBFdmVudCB0eXBlXG4gICAgICBjb25zdCBrZXkgPSByZXEuYm9keS5rZXlcbiAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSByZXEuYm9keS5leGVyY2lzZUlkXG4gICAgICBjb25zdCB1c2VySWQgPSAocmVxLnVzZXIgJiYgcmVxLnVzZXIuaWQpIHx8IC0xXG4gICAgICBjb25zdCB2YWx1ZSA9IHJlcS5ib2R5LnZhbHVlXG4gICAgICBhbmFseXRpY3NTZXJ2aWNlLmFkZEV4ZXJjaXNlRGF0YShrZXksIHZhbHVlLCBleGVyY2lzZUlkLCB1c2VySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIHJlcy5qc29uKHJlc3ApXG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEV4ZXJjaXNlQ29udHJvbGxlclxuIl19
