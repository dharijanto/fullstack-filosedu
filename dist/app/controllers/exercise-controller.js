"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_service_1=require("../../services/exercise-service"),exercise_generator_1=require("../../lib/exercise_generator/exercise-generator"),exercise_helper_1=require("../utils/exercise-helper");let path=require("path"),moment=require("moment-timezone"),log=require("npmlog"),AnalyticsService=require(path.join(__dirname,"../../services/analytics-service")),BaseController=require(path.join(__dirname,"base-controller")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),Formatter=require(path.join(__dirname,"../../lib/utils/formatter")),Utils=require(path.join(__dirname,"../utils/utils"));const TAG="ExerciseController";class ExerciseController extends BaseController{constructor(e){super(e);const s=new AnalyticsService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,s,r)=>{r()}),this.routeGet("/:topicId/:topicSlug/:subtopicId/:subtopicSlug/:exerciseId/:exerciseSlug",PassportHelper.ensureLoggedIn(),(e,s,r)=>{let t=e.params.exerciseId,i=e.params.subtopicId,a=e.params.topicId;Promise.join(exercise_service_1.default.getExercise(t),exercise_service_1.default.getGeneratedExercise({userId:e.user.id,exerciseId:t}),course_service_1.default.getPreviousAndNextExercise(i,t),exercise_service_1.default.getRenderedExerciseStars(e.user.id,t),exercise_service_1.default.getRenderedExerciseTimers(e.user.id,t),course_service_1.default.getPreviousAndNextSubtopic(i)).spread((s,r,t,o,n,c)=>{if(s.status){const i=exercise_generator_1.default.getHash(s.data.data),a=exercise_generator_1.default.getExerciseSolver(s.data.data),d=o.status?o.data:'<p style="color:red;"> Unable to retrieve stars... </p>',u=o.status?o.data.stars:0,l=n.status?n.data:'<p style="color:red;"> Unable to retrieve timers... </p>',x=s.data.subtopic.topic,g=s.data.subtopic,p=t.data,m=c.data,_=p&&p.prev?Formatter.getExerciseURL(p.prev):m&&m.prev?Formatter.getSubtopicURL(m.prev):null,h=p&&p.next?Formatter.getExerciseURL(p.next):m&&m.next?Formatter.getSubtopicURL(m.next):null;if(r.status&&r.data.exerciseHash===i)return exercise_service_1.default.formatExercise(r.data,a).then(e=>Object.assign({elapsedTime:Utils.getElapsedTime(r.data.createdAt)},{formatted:e.formatted,exerciseId:e.exerciseId,idealTime:e.idealTime,topic:x,subtopic:g,starsHTML:d,stars:u,timersHTML:l,prevLink:_,nextLink:h}));if(r.status&&r.data.exerciseHash!==i||!r.status)return exercise_service_1.default.generateExercise(s.data).then(r=>{if(r.status)return exercise_service_1.default.saveGeneratedExercise(e.user.id,r.data.exerciseData,i).then(e=>{if(e.status)return Object.assign({elapsedTime:Utils.getElapsedTime(r.data.createdAt)},{formatted:r.data.formatted,exerciseId:s.data.id,idealTime:r.data.exerciseData.idealTime,topic:x,subtopic:g,starsHTML:d,stars:u,timersHTML:l,prevLink:_,nextLink:h});throw new Error("Could not create new generatedExercise!")});throw new Error("Exercise does not exists:"+r.errMessage)});throw new Error("Unknown error!")}throw new Error(`exercseId${e.params.exerciseId} or subtopicId=${i} or topicId=${a} does not exist!`)}).then(e=>{Object.assign(s.locals,e),s.locals.bundle=this._assetBundle,s.render("exercise")})}),this.routeGet("/getExerciseStars",PassportHelper.ensureLoggedIn(),(e,s,r)=>{const t=parseInt(e.query.exerciseId,10);void 0===t?s.json({status:!1,errMessage:"exerciseId is needed"}):e.isAuthenticated?exercise_service_1.default.getExerciseStars(e.user.id,t).then(e=>{s.json(e)}).catch(e=>{r(e)}):s.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/exercise/getLeaderboard",(e,s,r)=>{const t=parseInt(e.body.exerciseId,10);void 0===t?s.json({status:!1,errMessage:"exerciseId is needed"}):e.isAuthenticated?exercise_service_1.default.getExerciseLeaderboard(t).then(e=>{s.json(e)}).catch(e=>{r(e)}):s.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/:topicId/:topicSlug/:subtopicId/:subtopicSlug/:exerciseId/:exerciseSlug",PassportHelper.ensureLoggedIn(),(e,r,t)=>{const i=e.user.id,a=e.body.exerciseId;log.verbose(TAG,`submitAnswer.POST(): userId=${i} exerciseId=${a}`),e.isAuthenticated?Promise.join(exercise_service_1.default.getGeneratedExercise({userId:i,exerciseId:a}),exercise_service_1.default.getSubmittedExercises({userId:i,exerciseId:a}),exercise_service_1.default.getExercise(a)).spread((t,o,n)=>{if(t.status){if(n.status){const c=t.data;let d=JSON.parse(c.knowns);const u=o.status?o.data:[],l=exercise_generator_1.default.getExerciseSolver(n.data.data),x=e.body.userAnswers;if(log.verbose(TAG,`submitAnswer.POST(): userAnswer=${JSON.stringify(x)}`),log.verbose(TAG,`submitAnswer.POST(): generatedQuestions=${JSON.stringify(d)}`),x.length!==d.length)return r.json({status:!1,errMessage:"Number of submitted answers doesn't match number of questions!"});{const e=x.reduce((e,s)=>{const r=Object.keys(s);let t=!1;return r.forEach(e=>{s[e].length>0&&(t=!0)}),t?e+1:e},0)/parseFloat(d.length)*100;log.verbose(TAG,"submitAnswer.POST(): attemptedAnswers= "+e);const t=[],o=d.reduce((e,s,r)=>{const i=x;log.verbose(TAG,`submitAnswer.POST(): knowns=${JSON.stringify(s)}, unknowns=${JSON.stringify(i[r])} isAnswer=${l.isAnswer(s,i[r])}`);const a=l.isAnswer(s,i[r]);return t.push(a),a?e+1:e},0)/parseFloat(d.length)*100,n=u.reduce((e,s)=>s.score>e?s.score:e,0);Promise.join(s.addExerciseData("correctAnswers",o,a,i),s.addExerciseData("attemptedAnswers",e,a,i)).spread((e,s)=>{e.status||log.error(TAG,"submitAnswer.POST(): addExerciseData.resp="+JSON.stringify(e)),s.status||log.error(TAG,"submitAnswer.POST(): addExerciseData.resp2="+JSON.stringify(s))}).catch(e=>{log.error(TAG,e)});const g=exercise_helper_1.default.countTimeFinish(c.createdAt);return exercise_service_1.default.updateGeneratedExercise({id:c.id,score:o,userAnswer:JSON.stringify(x),submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),timeFinish:g}).then(e=>{e.status?Promise.join(exercise_service_1.default.getRenderedExerciseStars(i,a),exercise_service_1.default.getExerciseLeaderboard(a),exercise_service_1.default.getCurrentRanking(g,a),exercise_service_1.default.getTotalRanking(a),exercise_service_1.default.getRenderedExerciseTimers(i,a)).spread((e,s,i,a,d)=>{r.json({status:!0,data:{realAnswers:JSON.parse(c.unknowns),isAnswerCorrect:t,currentScore:o,bestScore:n,starsHTML:e.data,timersHTML:d.data,ranking:s.data,currentTimeFinish:g,currentRanking:i.data.count,totalRanking:a.data.count,isPerfectScore:100===o}})}):r.json({status:!1,errMessage:"Failed to save generated exercise"})})}}return r.json({status:!1,errMessage:"Exercise information be found"})}return log.error(TAG,"geResp.status="+t.status+" geResp.errMessage="+t.errMessage),r.json({status:!1,errMessage:"Current exercise cannot be found"})}).catch(e=>{log.error(TAG,e),r.json({status:!1,errMessage:e.message})}):(log.verbose(TAG,"submitAnswer.POST: request is not authenticated!"),r.status(500).send("Request not authenticated!"))}),this.routePost("/exercise/analytics",(e,r,t)=>{const i=e.body.key,a=e.body.exerciseId,o=e.user&&e.user.id||-1,n=e.body.value;s.addExerciseData(i,n,a,o).then(e=>{r.json(e)}).catch(e=>{t(e)})})}initialize(){return new Promise((e,s)=>{PathFormatter.hashAsset("app","/assets/js/exercise-app-bundle.js").then(s=>{this._assetBundle=s,e()}).catch(e=>{s(e)})})}}module.exports=ExerciseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsImNvdXJzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9nZW5lcmF0b3JfMSIsImV4ZXJjaXNlX2hlbHBlcl8xIiwicGF0aCIsIm1vbWVudCIsImxvZyIsIkFuYWx5dGljc1NlcnZpY2UiLCJqb2luIiwiX19kaXJuYW1lIiwiQmFzZUNvbnRyb2xsZXIiLCJQYXNzcG9ydEhlbHBlciIsIlBhdGhGb3JtYXR0ZXIiLCJGb3JtYXR0ZXIiLCJVdGlscyIsIlRBRyIsIkV4ZXJjaXNlQ29udHJvbGxlciIsIltvYmplY3QgT2JqZWN0XSIsImluaXREYXRhIiwic3VwZXIiLCJhbmFseXRpY3NTZXJ2aWNlIiwidGhpcyIsImdldERiIiwic2VxdWVsaXplIiwibW9kZWxzIiwiYWRkSW50ZXJjZXB0b3IiLCJyZXEiLCJyZXMiLCJuZXh0Iiwicm91dGVHZXQiLCJlbnN1cmVMb2dnZWRJbiIsImV4ZXJjaXNlSWQiLCJwYXJhbXMiLCJzdWJ0b3BpY0lkIiwidG9waWNJZCIsImRlZmF1bHQiLCJnZXRFeGVyY2lzZSIsImdldEdlbmVyYXRlZEV4ZXJjaXNlIiwidXNlcklkIiwidXNlciIsImlkIiwiZ2V0UHJldmlvdXNBbmROZXh0RXhlcmNpc2UiLCJnZXRSZW5kZXJlZEV4ZXJjaXNlU3RhcnMiLCJnZXRSZW5kZXJlZEV4ZXJjaXNlVGltZXJzIiwiZ2V0UHJldmlvdXNBbmROZXh0U3VidG9waWMiLCJzcHJlYWQiLCJyZXNwIiwicmVzcDIiLCJyZXNwNiIsInJlc3A5IiwicmVzcDEwIiwicmVzcDExIiwic3RhdHVzIiwiZXhlcmNpc2VIYXNoIiwiZ2V0SGFzaCIsImRhdGEiLCJleGVyY2lzZVNvbHZlciIsImdldEV4ZXJjaXNlU29sdmVyIiwic3RhcnNIVE1MIiwic3RhcnMiLCJ0aW1lcnNIVE1MIiwidG9waWMiLCJzdWJ0b3BpYyIsInByZXZBbmROZXh0RXhlcmNpc2UiLCJwcmV2QW5kTmV4dFN1YnRvcGljIiwicHJldkxpbmsiLCJwcmV2IiwiZ2V0RXhlcmNpc2VVUkwiLCJnZXRTdWJ0b3BpY1VSTCIsIm5leHRMaW5rIiwiZm9ybWF0RXhlcmNpc2UiLCJ0aGVuIiwiT2JqZWN0IiwiYXNzaWduIiwiZWxhcHNlZFRpbWUiLCJnZXRFbGFwc2VkVGltZSIsImNyZWF0ZWRBdCIsImZvcm1hdHRlZCIsImlkZWFsVGltZSIsImdlbmVyYXRlRXhlcmNpc2UiLCJyZXNwMyIsInNhdmVHZW5lcmF0ZWRFeGVyY2lzZSIsImV4ZXJjaXNlRGF0YSIsInJlc3A0IiwiRXJyb3IiLCJlcnJNZXNzYWdlIiwicHJlcGFyZWRFeGVyY2lzZSIsImxvY2FscyIsImJ1bmRsZSIsIl9hc3NldEJ1bmRsZSIsInJlbmRlciIsInBhcnNlSW50IiwicXVlcnkiLCJ1bmRlZmluZWQiLCJqc29uIiwiaXNBdXRoZW50aWNhdGVkIiwiZ2V0RXhlcmNpc2VTdGFycyIsImNhdGNoIiwiZXJyIiwicm91dGVQb3N0IiwiYm9keSIsImdldEV4ZXJjaXNlTGVhZGVyYm9hcmQiLCJ2ZXJib3NlIiwiZ2V0U3VibWl0dGVkRXhlcmNpc2VzIiwiZ2VSZXNwIiwic2dlUmVzcCIsImVSZXNwIiwiZ2VuZXJhdGVkRXhlcmNpc2UiLCJnZW5lcmF0ZWRRdWVzdGlvbnMiLCJKU09OIiwicGFyc2UiLCJrbm93bnMiLCJzdWJtaXR0ZWRFeGVyY2lzZXMiLCJ1c2VyQW5zd2VycyIsInN0cmluZ2lmeSIsImxlbmd0aCIsImF0dGVtcHRlZEFuc3dlcnMiLCJyZWR1Y2UiLCJhbnN3ZXIiLCJrZXlzIiwiYXR0ZW1wdGVkIiwiZm9yRWFjaCIsImtleSIsInBhcnNlRmxvYXQiLCJpc0Fuc3dlckNvcnJlY3QiLCJjdXJyZW50U2NvcmUiLCJudW1Db3JyZWN0IiwiaW5kZXgiLCJ1bmtub3ducyIsImlzQW5zd2VyIiwiaXNDb3JyZWN0IiwicHVzaCIsImJlc3RTY29yZSIsInN1Ym1pdGVkRXhlcmNpc2UiLCJzY29yZSIsImFkZEV4ZXJjaXNlRGF0YSIsImVycm9yIiwidGltZUZpbmlzaCIsImNvdW50VGltZUZpbmlzaCIsInVwZGF0ZUdlbmVyYXRlZEV4ZXJjaXNlIiwidXNlckFuc3dlciIsInN1Ym1pdHRlZCIsInN1Ym1pdHRlZEF0IiwibG9jYWwiLCJmb3JtYXQiLCJnZXRDdXJyZW50UmFua2luZyIsImdldFRvdGFsUmFua2luZyIsInJlc3A1IiwicmVhbEFuc3dlcnMiLCJyYW5raW5nIiwiY3VycmVudFRpbWVGaW5pc2giLCJjdXJyZW50UmFua2luZyIsImNvdW50IiwidG90YWxSYW5raW5nIiwiaXNQZXJmZWN0U2NvcmUiLCJtZXNzYWdlIiwic2VuZCIsInZhbHVlIiwicmVzb2x2ZSIsInJlamVjdCIsImhhc2hBc3NldCIsInJlc3VsdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFBQSxNQUFBQSxRQUFBQyxRQUFBLFlBQ0FDLGlCQUFBRCxRQUFBLGlDQUNBRSxtQkFBQUYsUUFBQSxtQ0FDQUcscUJBQUFILFFBQUEsbURBQ0FJLGtCQUFBSixRQUFBLDRCQUVBLElBQUlLLEtBQU9MLFFBQVEsUUFFZk0sT0FBU04sUUFBUSxtQkFFakJPLElBQU1QLFFBQVEsVUFFZFEsaUJBQW1CUixRQUFRSyxLQUFLSSxLQUFLQyxVQUFXLHFDQUNoREMsZUFBaUJYLFFBQVFLLEtBQUtJLEtBQUtDLFVBQVcsb0JBQzlDRSxlQUFpQlosUUFBUUssS0FBS0ksS0FBS0MsVUFBVyw2QkFDOUNHLGNBQWdCYixRQUFRSyxLQUFLSSxLQUFLQyxVQUFXLDZCQUU3Q0ksVUFBWWQsUUFBUUssS0FBS0ksS0FBS0MsVUFBVyw4QkFDekNLLE1BQVFmLFFBQVFLLEtBQUtJLEtBQUtDLFVBQVcsbUJBRXpDLE1BQU1NLElBQU0sMkJBRVpDLDJCQUFpQ04sZUFDL0JPLFlBQWFDLEdBQ1hDLE1BQU1ELEdBQ04sTUFBTUUsRUFBbUIsSUFBSWIsaUJBQWlCYyxLQUFLQyxRQUFRQyxVQUFXRixLQUFLQyxRQUFR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QUssb0RBQ2pCWSxFQUFJeUIsT0FBTyxLQUFLd0csS0FBSyxpQ0F5SHpCdkksS0FBSzhFLFVBQVUsc0JBQXVCLENBQUN6RSxFQUFLQyxFQUFLQyxLQUUvQyxNQUFNOEYsRUFBTWhHLEVBQUkwRSxLQUFLc0IsSUFDZjNGLEVBQWFMLEVBQUkwRSxLQUFLckUsV0FDdEJPLEVBQVVaLEVBQUlhLE1BQVFiLEVBQUlhLEtBQUtDLEtBQVEsRUFDdkNxSCxFQUFRbkksRUFBSTBFLEtBQUt5RCxNQUN2QnpJLEVBQWlCbUgsZ0JBQWdCYixFQUFLbUMsRUFBTzlILEVBQVlPLEdBQVFpQyxLQUFLekIsSUFDcEVuQixFQUFJbUUsS0FBS2hELEtBQ1JtRCxNQUFNQyxJQUNQdEUsRUFBS3NFLE9BS1hqRixhQUNFLE9BQU8sSUFBSW5CLFFBQVEsQ0FBQ2dLLEVBQVNDLEtBQzNCbkosY0FBY29KLFVBQVUsTUFBTyxxQ0FBcUN6RixLQUFLMEYsSUFDdkU1SSxLQUFLb0UsYUFBZXdFLEVBQ3BCSCxNQUNDN0QsTUFBTUMsSUFDUDZELEVBQU83RCxRQU1mZ0UsT0FBT0MsUUFBVW5KIiwiZmlsZSI6ImFwcC9jb250cm9sbGVycy9leGVyY2lzZS1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBDb3Vyc2VTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL2NvdXJzZS1zZXJ2aWNlJ1xuaW1wb3J0IEV4ZXJjaXNlU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9leGVyY2lzZS1zZXJ2aWNlJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uLy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IEV4ZXJjaXNlSGVscGVyIGZyb20gJy4uL3V0aWxzL2V4ZXJjaXNlLWhlbHBlcidcblxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxubGV0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudC10aW1lem9uZScpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxuXG5sZXQgQW5hbHl0aWNzU2VydmljZSA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL3NlcnZpY2VzL2FuYWx5dGljcy1zZXJ2aWNlJykpXG5sZXQgQmFzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdiYXNlLWNvbnRyb2xsZXInKSlcbmxldCBQYXNzcG9ydEhlbHBlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3V0aWxzL3Bhc3Nwb3J0LWhlbHBlcicpKVxubGV0IFBhdGhGb3JtYXR0ZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvcGF0aC1mb3JtYXR0ZXInKSlcblxubGV0IEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi91dGlscy9mb3JtYXR0ZXInKSlcbmxldCBVdGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3V0aWxzL3V0aWxzJykpXG5cbmNvbnN0IFRBRyA9ICdFeGVyY2lzZUNvbnRyb2xsZXInXG5cbmNsYXNzIEV4ZXJjaXNlQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG4gICAgY29uc3QgYW5hbHl0aWNzU2VydmljZSA9IG5ldyBBbmFseXRpY3NTZXJ2aWNlKHRoaXMuZ2V0RGIoKS5zZXF1ZWxpemUsIHRoaXMuZ2V0RGIoKS5tb2RlbHMpXG5cbiAgICB0aGlzLmFkZEludGVyY2VwdG9yKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbmV4dCgpXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy86dG9waWNJZC86dG9waWNTbHVnLzpzdWJ0b3BpY0lkLzpzdWJ0b3BpY1NsdWcvOmV4ZXJjaXNlSWQvOmV4ZXJjaXNlU2x1ZycsIFBhc3Nwb3J0SGVscGVyLmVuc3VyZUxvZ2dlZEluKCksIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbGV0IGV4ZXJjaXNlSWQgPSByZXEucGFyYW1zLmV4ZXJjaXNlSWRcbiAgICAgIGxldCBzdWJ0b3BpY0lkID0gcmVxLnBhcmFtcy5zdWJ0b3BpY0lkXG4gICAgICBsZXQgdG9waWNJZCA9IHJlcS5wYXJhbXMudG9waWNJZFxuICAgICAgUHJvbWlzZS5qb2luKFxuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2UoZXhlcmNpc2VJZCksXG4gICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRHZW5lcmF0ZWRFeGVyY2lzZSh7IHVzZXJJZDogcmVxLnVzZXIuaWQsIGV4ZXJjaXNlSWQgfSksXG4gICAgICAgIENvdXJzZVNlcnZpY2UuZ2V0UHJldmlvdXNBbmROZXh0RXhlcmNpc2Uoc3VidG9waWNJZCwgZXhlcmNpc2VJZCksXG4gICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRSZW5kZXJlZEV4ZXJjaXNlU3RhcnMocmVxLnVzZXIuaWQsIGV4ZXJjaXNlSWQpLFxuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRFeGVyY2lzZVRpbWVycyhyZXEudXNlci5pZCwgZXhlcmNpc2VJZCksXG4gICAgICAgIENvdXJzZVNlcnZpY2UuZ2V0UHJldmlvdXNBbmROZXh0U3VidG9waWMoc3VidG9waWNJZClcbiAgICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AyOiBOQ1Jlc3BvbnNlPGFueT4sXG4gICAgICAgICAgICAgICAgcmVzcDY6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDk6IE5DUmVzcG9uc2U8YW55PixcbiAgICAgICAgICAgICAgICByZXNwMTA6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDExKSA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgIGNvbnN0IGV4ZXJjaXNlSGFzaCA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEhhc2gocmVzcC5kYXRhLmRhdGEpXG4gICAgICAgICAgY29uc3QgZXhlcmNpc2VTb2x2ZXIgPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRFeGVyY2lzZVNvbHZlcihyZXNwLmRhdGEuZGF0YSlcbiAgICAgICAgICBjb25zdCBzdGFyc0hUTUwgPSByZXNwOS5zdGF0dXMgPyByZXNwOS5kYXRhIDogJzxwIHN0eWxlPVwiY29sb3I6cmVkO1wiPiBVbmFibGUgdG8gcmV0cmlldmUgc3RhcnMuLi4gPC9wPidcbiAgICAgICAgICBjb25zdCBzdGFycyA9IHJlc3A5LnN0YXR1cyA/IHJlc3A5LmRhdGEuc3RhcnMgOiAwXG4gICAgICAgICAgY29uc3QgdGltZXJzSFRNTCA9IHJlc3AxMC5zdGF0dXMgPyByZXNwMTAuZGF0YSA6ICc8cCBzdHlsZT1cImNvbG9yOnJlZDtcIj4gVW5hYmxlIHRvIHJldHJpZXZlIHRpbWVycy4uLiA8L3A+J1xuICAgICAgICAgIGNvbnN0IHRvcGljID0gcmVzcC5kYXRhLnN1YnRvcGljLnRvcGljXG4gICAgICAgICAgY29uc3Qgc3VidG9waWMgPSByZXNwLmRhdGEuc3VidG9waWNcbiAgICAgICAgICBjb25zdCBwcmV2QW5kTmV4dEV4ZXJjaXNlID0gcmVzcDYuZGF0YVxuICAgICAgICAgIGNvbnN0IHByZXZBbmROZXh0U3VidG9waWMgPSByZXNwMTEuZGF0YVxuICAgICAgICAgIGNvbnN0IHByZXZMaW5rID0gcHJldkFuZE5leHRFeGVyY2lzZSAmJiBwcmV2QW5kTmV4dEV4ZXJjaXNlLnByZXZcbiAgICAgICAgICAgICAgPyBGb3JtYXR0ZXIuZ2V0RXhlcmNpc2VVUkwocHJldkFuZE5leHRFeGVyY2lzZS5wcmV2KVxuICAgICAgICAgICAgICA6IChwcmV2QW5kTmV4dFN1YnRvcGljICYmIHByZXZBbmROZXh0U3VidG9waWMucHJldiA/IEZvcm1hdHRlci5nZXRTdWJ0b3BpY1VSTChwcmV2QW5kTmV4dFN1YnRvcGljLnByZXYpIDogbnVsbClcbiAgICAgICAgICBjb25zdCBuZXh0TGluayA9IHByZXZBbmROZXh0RXhlcmNpc2UgJiYgcHJldkFuZE5leHRFeGVyY2lzZS5uZXh0XG4gICAgICAgICAgICAgID8gRm9ybWF0dGVyLmdldEV4ZXJjaXNlVVJMKHByZXZBbmROZXh0RXhlcmNpc2UubmV4dClcbiAgICAgICAgICAgICAgOiAocHJldkFuZE5leHRTdWJ0b3BpYyAmJiBwcmV2QW5kTmV4dFN1YnRvcGljLm5leHQgPyBGb3JtYXR0ZXIuZ2V0U3VidG9waWNVUkwocHJldkFuZE5leHRTdWJ0b3BpYy5uZXh0KSA6IG51bGwpXG5cbiAgICAgICAgICAvLyBJZiB0aGVyZSdzIGV4ZXJjaXNlIHRvIGJlIHJlc3RvcmVkIGFuZCBpdCdzIHN0aWxsIHZhbGlkXG4gICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhLmV4ZXJjaXNlSGFzaCA9PT0gZXhlcmNpc2VIYXNoKSB7XG4gICAgICAgICAgICByZXR1cm4gRXhlcmNpc2VTZXJ2aWNlLmZvcm1hdEV4ZXJjaXNlKHJlc3AyLmRhdGEsIGV4ZXJjaXNlU29sdmVyKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgICAgICAgICAgZWxhcHNlZFRpbWU6IFV0aWxzLmdldEVsYXBzZWRUaW1lKHJlc3AyLmRhdGEuY3JlYXRlZEF0KVxuICAgICAgICAgICAgICB9LCB7XG4gICAgICAgICAgICAgICAgZm9ybWF0dGVkOiBkYXRhLmZvcm1hdHRlZCxcbiAgICAgICAgICAgICAgICBleGVyY2lzZUlkOiBkYXRhLmV4ZXJjaXNlSWQsXG4gICAgICAgICAgICAgICAgaWRlYWxUaW1lOiBkYXRhLmlkZWFsVGltZSxcbiAgICAgICAgICAgICAgICB0b3BpYyxcbiAgICAgICAgICAgICAgICBzdWJ0b3BpYyxcbiAgICAgICAgICAgICAgICBzdGFyc0hUTUwsXG4gICAgICAgICAgICAgICAgc3RhcnMsXG4gICAgICAgICAgICAgICAgdGltZXJzSFRNTCxcbiAgICAgICAgICAgICAgICBwcmV2TGluayxcbiAgICAgICAgICAgICAgICBuZXh0TGlua1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2UgaWYgKChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YS5leGVyY2lzZUhhc2ggIT09IGV4ZXJjaXNlSGFzaCkgfHwgIXJlc3AyLnN0YXR1cykge1xuICAgICAgICAgICAgLy8gSWYgdGhlcmUncyBubyBleGVyY2lzZSBvciB0aGVyZSdzIGJ1dCBhbHJlYWR5IGV4cGlyZWRcbiAgICAgICAgICAgIC8vIFRPRE86IFdlIHdhbm5hIGNvbWJpbmUgZ2VuZXJhdGVFeGVyY2lzZSBhbmQgc2F2ZUdlbmVyYXRlZEV4ZXJjaXNlIGFsdG9nZXRoZXJcbiAgICAgICAgICAgIHJldHVybiBFeGVyY2lzZVNlcnZpY2UuZ2VuZXJhdGVFeGVyY2lzZShyZXNwLmRhdGEpLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzcDMuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEV4ZXJjaXNlU2VydmljZS5zYXZlR2VuZXJhdGVkRXhlcmNpc2UoXG4gICAgICAgICAgICAgICAgICByZXEudXNlci5pZCxcbiAgICAgICAgICAgICAgICAgIHJlc3AzLmRhdGEuZXhlcmNpc2VEYXRhLFxuICAgICAgICAgICAgICAgICAgZXhlcmNpc2VIYXNoXG4gICAgICAgICAgICAgICAgKS50aGVuKHJlc3A0ID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmIChyZXNwNC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lOiBVdGlscy5nZXRFbGFwc2VkVGltZShyZXNwMy5kYXRhLmNyZWF0ZWRBdClcbiAgICAgICAgICAgICAgICAgICAgfSwge1xuICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZDogcmVzcDMuZGF0YS5mb3JtYXR0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgZXhlcmNpc2VJZDogcmVzcC5kYXRhLmlkLFxuICAgICAgICAgICAgICAgICAgICAgIGlkZWFsVGltZTogcmVzcDMuZGF0YS5leGVyY2lzZURhdGEuaWRlYWxUaW1lLFxuICAgICAgICAgICAgICAgICAgICAgIHRvcGljLFxuICAgICAgICAgICAgICAgICAgICAgIHN1YnRvcGljLFxuICAgICAgICAgICAgICAgICAgICAgIHN0YXJzSFRNTCxcbiAgICAgICAgICAgICAgICAgICAgICBzdGFycyxcbiAgICAgICAgICAgICAgICAgICAgICB0aW1lcnNIVE1MLFxuICAgICAgICAgICAgICAgICAgICAgIHByZXZMaW5rLFxuICAgICAgICAgICAgICAgICAgICAgIG5leHRMaW5rXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBjcmVhdGUgbmV3IGdlbmVyYXRlZEV4ZXJjaXNlIScpXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4ZXJjaXNlIGRvZXMgbm90IGV4aXN0czonICsgcmVzcDMuZXJyTWVzc2FnZSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVycm9yIScpXG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZXhlcmNzZUlkJHtyZXEucGFyYW1zLmV4ZXJjaXNlSWR9IG9yIHN1YnRvcGljSWQ9JHtzdWJ0b3BpY0lkfSBvciB0b3BpY0lkPSR7dG9waWNJZH0gZG9lcyBub3QgZXhpc3QhYClcbiAgICAgICAgfVxuICAgICAgfSkudGhlbihwcmVwYXJlZEV4ZXJjaXNlID0+IHtcbiAgICAgICAgLypcbiAgICAgICAgICBwcmVwYXJlZEV4ZXJjaXNlOiB7XG4gICAgICAgICAgICB0b3BpYyxcbiAgICAgICAgICAgIHN1YnRvcGljLFxuICAgICAgICAgICAgZXhlcmNpc2VJZCxcbiAgICAgICAgICAgIGZvcm1hdHRlZCxcbiAgICAgICAgICAgIGlkZWFsVGltZSxcbiAgICAgICAgICAgIGVsYXBzZWRUaW1lLFxuICAgICAgICAgICAgc3RhcnNIVE1MLFxuICAgICAgICAgICAgdGltZXJzSFRNTFxuICAgICAgICAgIH1cbiAgICAgICAgKi9cblxuICAgICAgICBPYmplY3QuYXNzaWduKHJlcy5sb2NhbHMsIHByZXBhcmVkRXhlcmNpc2UpXG4gICAgICAgIHJlcy5sb2NhbHMuYnVuZGxlID0gdGhpcy5fYXNzZXRCdW5kbGVcbiAgICAgICAgcmVzLnJlbmRlcignZXhlcmNpc2UnKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZUdldCgnL2dldEV4ZXJjaXNlU3RhcnMnLCBQYXNzcG9ydEhlbHBlci5lbnN1cmVMb2dnZWRJbigpLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSBwYXJzZUludChyZXEucXVlcnkuZXhlcmNpc2VJZCwgMTApXG4gICAgICBpZiAoZXhlcmNpc2VJZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYGV4ZXJjaXNlSWQgaXMgbmVlZGVkYCB9KVxuICAgICAgfSBlbHNlIGlmICghcmVxLmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBVbmF1dGhvcml6ZWRgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBzdWJ0b3BpYyBzdGFyc1xuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2VTdGFycyhyZXEudXNlci5pZCwgZXhlcmNpc2VJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIG5leHQoZXJyKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL2V4ZXJjaXNlL2dldExlYWRlcmJvYXJkJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBleGVyY2lzZUlkID0gcGFyc2VJbnQocmVxLmJvZHkuZXhlcmNpc2VJZCwgMTApXG4gICAgICBpZiAoZXhlcmNpc2VJZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYGV4ZXJjaXNlSWQgaXMgbmVlZGVkYCB9KVxuICAgICAgfSBlbHNlIGlmICghcmVxLmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBVbmF1dGhvcml6ZWRgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2VMZWFkZXJib2FyZChleGVyY2lzZUlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgIHJlcy5qc29uKHJlc3ApXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgbmV4dChlcnIpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIC8vIEdyYWRpbmdcbiAgICB0aGlzLnJvdXRlUG9zdCgnLzp0b3BpY0lkLzp0b3BpY1NsdWcvOnN1YnRvcGljSWQvOnN1YnRvcGljU2x1Zy86ZXhlcmNpc2VJZC86ZXhlcmNpc2VTbHVnJywgUGFzc3BvcnRIZWxwZXIuZW5zdXJlTG9nZ2VkSW4oKSwgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZFxuICAgICAgY29uc3QgZXhlcmNpc2VJZCA9IHJlcS5ib2R5LmV4ZXJjaXNlSWRcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgYHN1Ym1pdEFuc3dlci5QT1NUKCk6IHVzZXJJZD0ke3VzZXJJZH0gZXhlcmNpc2VJZD0ke2V4ZXJjaXNlSWR9YClcblxuICAgICAgaWYgKCFyZXEuaXNBdXRoZW50aWNhdGVkKSB7XG4gICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3N1Ym1pdEFuc3dlci5QT1NUOiByZXF1ZXN0IGlzIG5vdCBhdXRoZW50aWNhdGVkIScpXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5zZW5kKCdSZXF1ZXN0IG5vdCBhdXRoZW50aWNhdGVkIScpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBQcm9taXNlLmpvaW48YW55PihcbiAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0R2VuZXJhdGVkRXhlcmNpc2UoeyB1c2VySWQsIGV4ZXJjaXNlSWQgfSksIC8vIEV4ZXJjaXNlIHRoYXQncyBjdXJyZW50bHkgYmVpbmcgZ3JhZGVkXG4gICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldFN1Ym1pdHRlZEV4ZXJjaXNlcyh7IHVzZXJJZCwgZXhlcmNpc2VJZCB9KSxcbiAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2UoZXhlcmNpc2VJZClcbiAgICAgICAgKS5zcHJlYWQoKGdlUmVzcDogTkNSZXNwb25zZTxhbnk+LCBzZ2VSZXNwOiBOQ1Jlc3BvbnNlPGFueT4sIGVSZXNwOiBOQ1Jlc3BvbnNlPGFueT4pID0+IHtcbiAgICAgICAgICBpZiAoIWdlUmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcihUQUcsICdnZVJlc3Auc3RhdHVzPScgKyBnZVJlc3Auc3RhdHVzICsgJyBnZVJlc3AuZXJyTWVzc2FnZT0nICsgZ2VSZXNwLmVyck1lc3NhZ2UpXG4gICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnQ3VycmVudCBleGVyY2lzZSBjYW5ub3QgYmUgZm91bmQnIH0pXG4gICAgICAgICAgfSBlbHNlIGlmICghZVJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRXhlcmNpc2UgaW5mb3JtYXRpb24gYmUgZm91bmQnIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlID0gZ2VSZXNwLmRhdGFcbiAgICAgICAgICAgIGxldCBnZW5lcmF0ZWRRdWVzdGlvbnMgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEV4ZXJjaXNlLmtub3ducylcbiAgICAgICAgICAgIGNvbnN0IHN1Ym1pdHRlZEV4ZXJjaXNlcyA9IHNnZVJlc3Auc3RhdHVzID8gc2dlUmVzcC5kYXRhIDogW11cbiAgICAgICAgICAgIGNvbnN0IGV4ZXJjaXNlU29sdmVyID0gRXhlcmNpc2VHZW5lcmF0b3IuZ2V0RXhlcmNpc2VTb2x2ZXIoZVJlc3AuZGF0YS5kYXRhKVxuICAgICAgICAgICAgY29uc3QgdXNlckFuc3dlcnMgPSByZXEuYm9keS51c2VyQW5zd2VycyAvLyBbeyd4JzogJzInLCAneSc6ICczJ30sIHsneCc6ICcxJywgJ3knOiAnMyd9XS4gVGhpcyBpcyBzdHJpbmcgYmFzZWRcblxuICAgICAgICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgc3VibWl0QW5zd2VyLlBPU1QoKTogdXNlckFuc3dlcj0ke0pTT04uc3RyaW5naWZ5KHVzZXJBbnN3ZXJzKX1gKVxuICAgICAgICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgc3VibWl0QW5zd2VyLlBPU1QoKTogZ2VuZXJhdGVkUXVlc3Rpb25zPSR7SlNPTi5zdHJpbmdpZnkoZ2VuZXJhdGVkUXVlc3Rpb25zKX1gKVxuICAgICAgICAgICAgaWYgKHVzZXJBbnN3ZXJzLmxlbmd0aCAhPT0gZ2VuZXJhdGVkUXVlc3Rpb25zLmxlbmd0aCkge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnTnVtYmVyIG9mIHN1Ym1pdHRlZCBhbnN3ZXJzIGRvZXNuXFwndCBtYXRjaCBudW1iZXIgb2YgcXVlc3Rpb25zIScgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIEdldCB0aGUgbnVtYmVyIG9mIG5vbi1lbXB0eSBhbnN3ZXIuIChpLmUuIHRoZSBzdHVkZW50IHRyaWVzIHRvIGFuc3dlciBldmVudGhvdWdoIGl0J3Mgd3JvbmcpXG4gICAgICAgICAgICAgIGNvbnN0IGF0dGVtcHRlZEFuc3dlcnMgPSB1c2VyQW5zd2Vycy5yZWR1Y2UoKGF0dGVtcHRlZEFuc3dlcnMsIGFuc3dlcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhbnN3ZXIpXG4gICAgICAgICAgICAgICAgbGV0IGF0dGVtcHRlZCA9IGZhbHNlXG4gICAgICAgICAgICAgICAga2V5cy5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoYW5zd2VyW2tleV0ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBhdHRlbXB0ZWQgPSB0cnVlXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdGVkKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gYXR0ZW1wdGVkQW5zd2VycyArIDFcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRlZEFuc3dlcnNcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0sIDApIC8gcGFyc2VGbG9hdChnZW5lcmF0ZWRRdWVzdGlvbnMubGVuZ3RoKSAqIDEwMFxuXG4gICAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3N1Ym1pdEFuc3dlci5QT1NUKCk6IGF0dGVtcHRlZEFuc3dlcnM9ICcgKyBhdHRlbXB0ZWRBbnN3ZXJzKVxuXG4gICAgICAgICAgICAgIC8vIEZsYWcgYXJyYXkgaWRlbnRpZnlpbmcgd2hpY2ggdXNlciBhbnN3ZXIgaXMgY29ycmVjdC93cm9uZ1xuICAgICAgICAgICAgICBjb25zdCBpc0Fuc3dlckNvcnJlY3Q6IGJvb2xlYW5bXSA9IFtdXG4gICAgICAgICAgICAgIC8vIENvbXB1dGUgdGhlIHNjb3JlIG9mIGN1cnJlbnQgZXhlcmNpc2VcbiAgICAgICAgICAgICAgY29uc3QgY29ycmVjdEFuc3dlcnMgPSBnZW5lcmF0ZWRRdWVzdGlvbnMucmVkdWNlKChudW1Db3JyZWN0LCBrbm93bnMsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdW5rbm93bnMgPSB1c2VyQW5zd2Vyc1xuICAgICAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgYHN1Ym1pdEFuc3dlci5QT1NUKCk6IGtub3ducz0ke0pTT04uc3RyaW5naWZ5KGtub3ducyl9LCB1bmtub3ducz0ke0pTT04uc3RyaW5naWZ5KHVua25vd25zW2luZGV4XSl9IGlzQW5zd2VyPSR7ZXhlcmNpc2VTb2x2ZXIuaXNBbnN3ZXIoa25vd25zLCB1bmtub3duc1tpbmRleF0pfWApXG4gICAgICAgICAgICAgICAgY29uc3QgaXNDb3JyZWN0ID0gZXhlcmNpc2VTb2x2ZXIuaXNBbnN3ZXIoa25vd25zLCB1bmtub3duc1tpbmRleF0pXG4gICAgICAgICAgICAgICAgaXNBbnN3ZXJDb3JyZWN0LnB1c2goaXNDb3JyZWN0KVxuICAgICAgICAgICAgICAgIHJldHVybiBpc0NvcnJlY3QgPyBudW1Db3JyZWN0ICsgMSA6IG51bUNvcnJlY3RcbiAgICAgICAgICAgICAgfSwgMClcbiAgICAgICAgICAgICAgY29uc3QgY3VycmVudFNjb3JlID0gY29ycmVjdEFuc3dlcnMgLyBwYXJzZUZsb2F0KGdlbmVyYXRlZFF1ZXN0aW9ucy5sZW5ndGgpICogMTAwXG4gICAgICAgICAgICAgIC8vIENvbXB1dGUgdGhlIGJlc3Qgc2NvcmVcbiAgICAgICAgICAgICAgY29uc3QgYmVzdFNjb3JlID0gc3VibWl0dGVkRXhlcmNpc2VzLnJlZHVjZSgoYmVzdFNjb3JlLCBzdWJtaXRlZEV4ZXJjaXNlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1Ym1pdGVkRXhlcmNpc2Uuc2NvcmUgPiBiZXN0U2NvcmUgPyBzdWJtaXRlZEV4ZXJjaXNlLnNjb3JlIDogYmVzdFNjb3JlXG4gICAgICAgICAgICAgIH0sIDApXG5cbiAgICAgICAgICAgICAgLy8gS2VlcCB0cmFjayBvZiB0aGUgbnVtYmVyIG9mIGNvcnJlY3QgYW5kIGF0dGVtcHRlZCBhbnN3ZXJzXG4gICAgICAgICAgICAgIFByb21pc2Uuam9pbihcbiAgICAgICAgICAgICAgICBhbmFseXRpY3NTZXJ2aWNlLmFkZEV4ZXJjaXNlRGF0YSgnY29ycmVjdEFuc3dlcnMnLCBjdXJyZW50U2NvcmUsIGV4ZXJjaXNlSWQsIHVzZXJJZCksXG4gICAgICAgICAgICAgICAgYW5hbHl0aWNzU2VydmljZS5hZGRFeGVyY2lzZURhdGEoJ2F0dGVtcHRlZEFuc3dlcnMnLCBhdHRlbXB0ZWRBbnN3ZXJzLCBleGVyY2lzZUlkLCB1c2VySWQpXG4gICAgICAgICAgICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AyOiBOQ1Jlc3BvbnNlPGFueT4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoVEFHLCAnc3VibWl0QW5zd2VyLlBPU1QoKTogYWRkRXhlcmNpc2VEYXRhLnJlc3A9JyArIEpTT04uc3RyaW5naWZ5KHJlc3ApKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXJlc3AyLnN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKFRBRywgJ3N1Ym1pdEFuc3dlci5QT1NUKCk6IGFkZEV4ZXJjaXNlRGF0YS5yZXNwMj0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDIpKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoVEFHLCBlcnIpXG4gICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgY29uc3QgdGltZUZpbmlzaCA9IEV4ZXJjaXNlSGVscGVyLmNvdW50VGltZUZpbmlzaChnZW5lcmF0ZWRFeGVyY2lzZS5jcmVhdGVkQXQpXG4gICAgICAgICAgICAgIHJldHVybiBFeGVyY2lzZVNlcnZpY2UudXBkYXRlR2VuZXJhdGVkRXhlcmNpc2Uoe1xuICAgICAgICAgICAgICAgIGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5pZCxcbiAgICAgICAgICAgICAgICBzY29yZTogY3VycmVudFNjb3JlLFxuICAgICAgICAgICAgICAgIHVzZXJBbnN3ZXI6IEpTT04uc3RyaW5naWZ5KHVzZXJBbnN3ZXJzKSxcbiAgICAgICAgICAgICAgICBzdWJtaXR0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgc3VibWl0dGVkQXQ6IG1vbWVudCgpLmxvY2FsKCkuZm9ybWF0KCdZWVlZLU1NLUREIEhIOm1tOnNzJyksXG4gICAgICAgICAgICAgICAgdGltZUZpbmlzaFxuICAgICAgICAgICAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgUHJvbWlzZS5qb2luKFxuICAgICAgICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRFeGVyY2lzZVN0YXJzKHVzZXJJZCwgZXhlcmNpc2VJZCksXG4gICAgICAgICAgICAgICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZUxlYWRlcmJvYXJkKGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0Q3VycmVudFJhbmtpbmcodGltZUZpbmlzaCwgZXhlcmNpc2VJZCksXG4gICAgICAgICAgICAgICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRUb3RhbFJhbmtpbmcoZXhlcmNpc2VJZCksXG4gICAgICAgICAgICAgICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRSZW5kZXJlZEV4ZXJjaXNlVGltZXJzKHVzZXJJZCwgZXhlcmNpc2VJZClcbiAgICAgICAgICAgICAgICAgICkuc3ByZWFkKChyZXNwMjogTkNSZXNwb25zZTxhbnk+LCByZXNwMzogTkNSZXNwb25zZTxhbnk+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3A0OiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3A1OiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3A2OiBOQ1Jlc3BvbnNlPGFueT4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzLmpzb24oe1xuICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWFsQW5zd2VyczogSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS51bmtub3ducyksXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0Fuc3dlckNvcnJlY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U2NvcmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBiZXN0U2NvcmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFyc0hUTUw6IHJlc3AyLmRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lcnNIVE1MOiByZXNwNi5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmFua2luZzogcmVzcDMuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lRmluaXNoOiB0aW1lRmluaXNoLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFJhbmtpbmc6IHJlc3A0LmRhdGEuY291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFJhbmtpbmc6IHJlc3A1LmRhdGEuY291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc1BlcmZlY3RTY29yZTogY3VycmVudFNjb3JlID09PSAxMDBcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdGYWlsZWQgdG8gc2F2ZSBnZW5lcmF0ZWQgZXhlcmNpc2UnIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBsb2cuZXJyb3IoVEFHLCBlcnIpXG4gICAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBlcnIubWVzc2FnZSB9KVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL2V4ZXJjaXNlL2FuYWx5dGljcycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgLy8gRXZlbnQgdHlwZVxuICAgICAgY29uc3Qga2V5ID0gcmVxLmJvZHkua2V5XG4gICAgICBjb25zdCBleGVyY2lzZUlkID0gcmVxLmJvZHkuZXhlcmNpc2VJZFxuICAgICAgY29uc3QgdXNlcklkID0gKHJlcS51c2VyICYmIHJlcS51c2VyLmlkKSB8fCAtMVxuICAgICAgY29uc3QgdmFsdWUgPSByZXEuYm9keS52YWx1ZVxuICAgICAgYW5hbHl0aWNzU2VydmljZS5hZGRFeGVyY2lzZURhdGEoa2V5LCB2YWx1ZSwgZXhlcmNpc2VJZCwgdXNlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBpbml0aWFsaXplICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgUGF0aEZvcm1hdHRlci5oYXNoQXNzZXQoJ2FwcCcsICcvYXNzZXRzL2pzL2V4ZXJjaXNlLWFwcC1idW5kbGUuanMnKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHRoaXMuX2Fzc2V0QnVuZGxlID0gcmVzdWx0XG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmVqZWN0KGVycilcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEV4ZXJjaXNlQ29udHJvbGxlclxuIl19
