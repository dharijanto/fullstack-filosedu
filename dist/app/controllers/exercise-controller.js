"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_service_1=require("../../services/exercise-service"),exercise_generator_1=require("../../lib/exercise_generator/exercise-generator"),exercise_helper_1=require("../utils/exercise-helper");let path=require("path"),moment=require("moment-timezone"),log=require("npmlog"),AnalyticsService=require(path.join(__dirname,"../../services/analytics-service")),BaseController=require(path.join(__dirname,"base-controller")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),Formatter=require(path.join(__dirname,"../../lib/utils/formatter")),Utils=require(path.join(__dirname,"../utils/utils"));const TAG="ExerciseController";class ExerciseController extends BaseController{initialize(){return new Promise((e,s)=>{PathFormatter.hashAsset("app","/assets/js/exercise-app-bundle.js").then(s=>{this.exerciseFrontendJS=s,e()}).catch(e=>{s(e)})})}constructor(e){super(e);const s=new AnalyticsService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,s,r)=>{r()}),this.routeGet("/:topicId/:topicSlug/:subtopicId/:subtopicSlug/:exerciseId/:exerciseSlug",PassportHelper.ensureLoggedIn(),(e,s,r)=>{const t=e.user.id,i=e.params.exerciseId,a=e.params.subtopicId;Promise.join(exercise_service_1.default.getFormattedExercise(i,t),exercise_service_1.default.getRenderedExerciseStars(t,i),exercise_service_1.default.getRenderedExerciseTimers(t,i),course_service_1.default.getPreviousAndNextExercise(a,i),course_service_1.default.getPreviousAndNextSubtopic(a),course_service_1.default.getSubtopic(a)).spread((e,t,i,a,o,n)=>{if(e.status&&e.data&&a.status&&a.data&&o.status&&o.data&&n.status&&n.data){const r=a.data,c=o.data;s.locals.formattedExercise=e.data.formattedExercise,s.locals.elapsedTime=e.data.elapsedTime,s.locals.idealTime=e.data.idealTime,s.locals.exerciseId=e.data.exerciseId,s.locals.prevLink=r&&r.prev?Formatter.getExerciseURL(r.prev):c&&c.prev?Formatter.getSubtopicURL(c.prev):null,s.locals.nextLink=r&&r.next?Formatter.getExerciseURL(r.next):c&&c.next?Formatter.getSubtopicURL(c.next):null,s.locals.starsHTML=t.status?t.data:'<p style="color:red;"> Unable to retrieve stars... </p>',s.locals.timersHTML=i.status?i.data:'<p style="color:red;"> Unable to retrieve timers... </p>',s.locals.subtopic=n.data,s.locals.bundle=this.exerciseFrontendJS,s.render("exercise")}else r(new Error(e.errMessage||a.errMessage||o.errMessage||n.errMessage))}).catch(r)}),this.routeGet("/getExerciseStars",PassportHelper.ensureLoggedIn(),(e,s,r)=>{const t=parseInt(e.query.exerciseId,10);void 0===t?s.json({status:!1,errMessage:"exerciseId is needed"}):e.isAuthenticated?exercise_service_1.default.getExerciseStars(e.user.id,t).then(e=>{s.json(e)}).catch(e=>{r(e)}):s.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/exercise/getLeaderboard",(e,s,r)=>{const t=parseInt(e.body.exerciseId,10);void 0===t?s.json({status:!1,errMessage:"exerciseId is needed"}):e.isAuthenticated?exercise_service_1.default.getExerciseLeaderboard(t).then(e=>{s.json(e)}).catch(e=>{r(e)}):s.json({status:!1,errMessage:"Unauthorized"})}),this.routePost("/:topicId/:topicSlug/:subtopicId/:subtopicSlug/:exerciseId/:exerciseSlug",PassportHelper.ensureLoggedIn(),(e,r,t)=>{const i=e.user.id,a=e.body.exerciseId;log.verbose(TAG,`submitAnswer.POST(): userId=${i} exerciseId=${a}`),e.isAuthenticated?Promise.join(exercise_service_1.default.getGeneratedExercise({userId:i,exerciseId:a}),exercise_service_1.default.getSubmittedExercises({userId:i,exerciseId:a}),exercise_service_1.default.getExercise(a)).spread((t,o,n)=>{if(t.status){if(n.status){const c=t.data;let d=JSON.parse(c.knowns);const u=o.status?o.data:[],l=exercise_generator_1.default.getExerciseSolver(n.data.data),g=e.body.userAnswers;if(log.verbose(TAG,`submitAnswer.POST(): userAnswer=${JSON.stringify(g)}`),log.verbose(TAG,`submitAnswer.POST(): generatedQuestions=${JSON.stringify(d)}`),g.length!==d.length)return r.json({status:!1,errMessage:"Number of submitted answers doesn't match number of questions!"});{const e=g.reduce((e,s)=>{const r=Object.keys(s);let t=!1;return r.forEach(e=>{s[e].length>0&&(t=!0)}),t?e+1:e},0)/parseFloat(d.length)*100;log.verbose(TAG,"submitAnswer.POST(): attemptedAnswers= "+e);const t=[],o=d.reduce((e,s,r)=>{const i=g;log.verbose(TAG,`submitAnswer.POST(): knowns=${JSON.stringify(s)}, unknowns=${JSON.stringify(i[r])} isAnswer=${l.isAnswer(s,i[r])}`);const a=l.isAnswer(s,i[r]);return t.push(a),a?e+1:e},0)/parseFloat(d.length)*100,n=u.reduce((e,s)=>s.score>e?s.score:e,0);Promise.join(s.addExerciseData("correctAnswers",o,a,i),s.addExerciseData("attemptedAnswers",e,a,i)).spread((e,s)=>{e.status||log.error(TAG,"submitAnswer.POST(): addExerciseData.resp="+JSON.stringify(e)),s.status||log.error(TAG,"submitAnswer.POST(): addExerciseData.resp2="+JSON.stringify(s))}).catch(e=>{log.error(TAG,e)});const x=exercise_helper_1.default.countTimeFinish(c.createdAt);return exercise_service_1.default.updateGeneratedExercise({id:c.id,score:o,userAnswer:JSON.stringify(g),submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),timeFinish:x}).then(e=>{e.status?Promise.join(exercise_service_1.default.getRenderedExerciseStars(i,a),exercise_service_1.default.getExerciseLeaderboard(a),exercise_service_1.default.getCurrentRanking(x,a),exercise_service_1.default.getTotalRanking(a),exercise_service_1.default.getRenderedExerciseTimers(i,a)).spread((e,s,i,a,d)=>{r.json({status:!0,data:{realAnswers:JSON.parse(c.unknowns),isAnswerCorrect:t,currentScore:o,bestScore:n,starsHTML:e.data,timersHTML:d.data,ranking:s.data,currentTimeFinish:x,currentRanking:i.data.count,totalRanking:a.data.count,isPerfectScore:100===o}})}):r.json({status:!1,errMessage:"Failed to save generated exercise"})})}}return r.json({status:!1,errMessage:"Exercise information be found"})}return log.error(TAG,"geResp.status="+t.status+" geResp.errMessage="+t.errMessage),r.json({status:!1,errMessage:"Current exercise cannot be found"})}).catch(e=>{log.error(TAG,e),r.json({status:!1,errMessage:e.message})}):(log.verbose(TAG,"submitAnswer.POST: request is not authenticated!"),r.status(500).send("Request not authenticated!"))}),this.routePost("/exercise/analytics",(e,r,t)=>{const i=e.body.key,a=e.body.exerciseId,o=e.user&&e.user.id||-1,n=e.body.value;s.addExerciseData(i,n,a,o).then(e=>{r.json(e)}).catch(e=>{t(e)})})}}module.exports=ExerciseController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsImNvdXJzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9nZW5lcmF0b3JfMSIsImV4ZXJjaXNlX2hlbHBlcl8xIiwicGF0aCIsIm1vbWVudCIsImxvZyIsIkFuYWx5dGljc1NlcnZpY2UiLCJqb2luIiwiX19kaXJuYW1lIiwiQmFzZUNvbnRyb2xsZXIiLCJQYXNzcG9ydEhlbHBlciIsIlBhdGhGb3JtYXR0ZXIiLCJGb3JtYXR0ZXIiLCJVdGlscyIsIlRBRyIsIkV4ZXJjaXNlQ29udHJvbGxlciIsIltvYmplY3QgT2JqZWN0XSIsInJlc29sdmUiLCJyZWplY3QiLCJoYXNoQXNzZXQiLCJ0aGVuIiwicmVzdWx0IiwidGhpcyIsImV4ZXJjaXNlRnJvbnRlbmRKUyIsImNhdGNoIiwiZXJyIiwiaW5pdERhdGEiLCJzdXBlciIsImFuYWx5dGljc1NlcnZpY2UiLCJnZXREYiIsInNlcXVlbGl6ZSIsIm1vZGVscyIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsInJvdXRlR2V0IiwiZW5zdXJlTG9nZ2VkSW4iLCJ1c2VySWQiLCJ1c2VyIiwiaWQiLCJleGVyY2lzZUlkIiwicGFyYW1zIiwic3VidG9waWNJZCIsImRlZmF1bHQiLCJnZXRGb3JtYXR0ZWRFeGVyY2lzZSIsImdldFJlbmRlcmVkRXhlcmNpc2VTdGFycyIsImdldFJlbmRlcmVkRXhlcmNpc2VUaW1lcnMiLCJnZXRQcmV2aW91c0FuZE5leHRFeGVyY2lzZSIsImdldFByZXZpb3VzQW5kTmV4dFN1YnRvcGljIiwiZ2V0U3VidG9waWMiLCJzcHJlYWQiLCJyZXNwMSIsInJlc3AyIiwicmVzcDMiLCJyZXNwNCIsInJlc3A1IiwicmVzcDYiLCJzdGF0dXMiLCJkYXRhIiwicHJldkFuZE5leHRFeGVyY2lzZSIsInByZXZBbmROZXh0U3VidG9waWMiLCJsb2NhbHMiLCJmb3JtYXR0ZWRFeGVyY2lzZSIsImVsYXBzZWRUaW1lIiwiaWRlYWxUaW1lIiwicHJldkxpbmsiLCJwcmV2IiwiZ2V0RXhlcmNpc2VVUkwiLCJnZXRTdWJ0b3BpY1VSTCIsIm5leHRMaW5rIiwic3RhcnNIVE1MIiwidGltZXJzSFRNTCIsInN1YnRvcGljIiwiYnVuZGxlIiwicmVuZGVyIiwiRXJyb3IiLCJlcnJNZXNzYWdlIiwicGFyc2VJbnQiLCJxdWVyeSIsInVuZGVmaW5lZCIsImpzb24iLCJpc0F1dGhlbnRpY2F0ZWQiLCJnZXRFeGVyY2lzZVN0YXJzIiwicmVzcCIsInJvdXRlUG9zdCIsImJvZHkiLCJnZXRFeGVyY2lzZUxlYWRlcmJvYXJkIiwidmVyYm9zZSIsImdldEdlbmVyYXRlZEV4ZXJjaXNlIiwiZ2V0U3VibWl0dGVkRXhlcmNpc2VzIiwiZ2V0RXhlcmNpc2UiLCJnZVJlc3AiLCJzZ2VSZXNwIiwiZVJlc3AiLCJnZW5lcmF0ZWRFeGVyY2lzZSIsImdlbmVyYXRlZFF1ZXN0aW9ucyIsIkpTT04iLCJwYXJzZSIsImtub3ducyIsInN1Ym1pdHRlZEV4ZXJjaXNlcyIsImV4ZXJjaXNlU29sdmVyIiwiZ2V0RXhlcmNpc2VTb2x2ZXIiLCJ1c2VyQW5zd2VycyIsInN0cmluZ2lmeSIsImxlbmd0aCIsImF0dGVtcHRlZEFuc3dlcnMiLCJyZWR1Y2UiLCJhbnN3ZXIiLCJrZXlzIiwiT2JqZWN0IiwiYXR0ZW1wdGVkIiwiZm9yRWFjaCIsImtleSIsInBhcnNlRmxvYXQiLCJpc0Fuc3dlckNvcnJlY3QiLCJjdXJyZW50U2NvcmUiLCJudW1Db3JyZWN0IiwiaW5kZXgiLCJ1bmtub3ducyIsImlzQW5zd2VyIiwiaXNDb3JyZWN0IiwicHVzaCIsImJlc3RTY29yZSIsInN1Ym1pdGVkRXhlcmNpc2UiLCJzY29yZSIsImFkZEV4ZXJjaXNlRGF0YSIsImVycm9yIiwidGltZUZpbmlzaCIsImNvdW50VGltZUZpbmlzaCIsImNyZWF0ZWRBdCIsInVwZGF0ZUdlbmVyYXRlZEV4ZXJjaXNlIiwidXNlckFuc3dlciIsInN1Ym1pdHRlZCIsInN1Ym1pdHRlZEF0IiwibG9jYWwiLCJmb3JtYXQiLCJnZXRDdXJyZW50UmFua2luZyIsImdldFRvdGFsUmFua2luZyIsInJlYWxBbnN3ZXJzIiwicmFua2luZyIsImN1cnJlbnRUaW1lRmluaXNoIiwiY3VycmVudFJhbmtpbmciLCJjb3VudCIsInRvdGFsUmFua2luZyIsImlzUGVyZmVjdFNjb3JlIiwibWVzc2FnZSIsInNlbmQiLCJ2YWx1ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFBQSxNQUFBQSxRQUFBQyxRQUFBLFlBQ0FDLGlCQUFBRCxRQUFBLGlDQUNBRSxtQkFBQUYsUUFBQSxtQ0FDQUcscUJBQUFILFFBQUEsbURBQ0FJLGtCQUFBSixRQUFBLDRCQUVBLElBQUlLLEtBQU9MLFFBQVEsUUFFZk0sT0FBU04sUUFBUSxtQkFFakJPLElBQU1QLFFBQVEsVUFFZFEsaUJBQW1CUixRQUFRSyxLQUFLSSxLQUFLQyxVQUFXLHFDQUNoREMsZUFBaUJYLFFBQVFLLEtBQUtJLEtBQUtDLFVBQVcsb0JBQzlDRSxlQUFpQlosUUFBUUssS0FBS0ksS0FBS0MsVUFBVyw2QkFDOUNHLGNBQWdCYixRQUFRSyxLQUFLSSxLQUFLQyxVQUFXLDZCQUU3Q0ksVUFBWWQsUUFBUUssS0FBS0ksS0FBS0MsVUFBVyw4QkFDekNLLE1BQVFmLFFBQVFLLEtBQUtJLEtBQUtDLFVBQVcsbUJBRXpDLE1BQU1NLElBQU0sMkJBRVpDLDJCQUFpQ04sZUFFL0JPLGFBQ0UsT0FBTyxJQUFJbkIsUUFBUSxDQUFDb0IsRUFBU0MsS0FDM0JQLGNBQWNRLFVBQVUsTUFBTyxxQ0FBcUNDLEtBQUtDLElBQ3ZFQyxLQUFLQyxtQkFBcUJGLEVBQzFCSixNQUNDTyxNQUFNQyxJQUNQUCxFQUFPTyxPQUtiVCxZQUFhVSxHQUNYQyxNQUFNRCxHQUNOLE1BQU1FLEVBQW1CLElBQUl0QixpQkFBaUJnQixLQUFLTyxRQUFRQyxVQUFXUixLQUFLTyxRQUFRRSxRQUNu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RCxNQUFNQyxJQUNQcEIsSUFBSTBILE1BQU1qSCxJQUFLVyxHQUNmUyxFQUFJK0MsTUFBT3ZCLFFBQVEsRUFBT21CLFdBQVlwRCxFQUFJeUgsYUFySDVDN0ksSUFBSW1GLFFBQVExRSxJQUFLLG9EQUNqQm9CLEVBQUl3QixPQUFPLEtBQUt5RixLQUFLLGlDQXlIekI3SCxLQUFLK0QsVUFBVSxzQkFBdUIsQ0FBQ3BELEVBQUtDLEVBQUtDLEtBRS9DLE1BQU04RSxFQUFNaEYsRUFBSXFELEtBQUsyQixJQUNmeEUsRUFBYVIsRUFBSXFELEtBQUs3QyxXQUN0QkgsRUFBVUwsRUFBSU0sTUFBUU4sRUFBSU0sS0FBS0MsS0FBUSxFQUN2QzRHLEVBQVFuSCxFQUFJcUQsS0FBSzhELE1BQ3ZCeEgsRUFBaUJrRyxnQkFBZ0JiLEVBQUttQyxFQUFPM0csRUFBWUgsR0FBUWxCLEtBQUtnRSxJQUNwRWxELEVBQUkrQyxLQUFLRyxLQUNSNUQsTUFBTUMsSUFDUFUsRUFBS1YsUUFNYjRILE9BQU9DLFFBQVV2SSIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvZXhlcmNpc2UtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgQ291cnNlU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jb3Vyc2Utc2VydmljZSdcbmltcG9ydCBFeGVyY2lzZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvZXhlcmNpc2Utc2VydmljZSdcbmltcG9ydCBFeGVyY2lzZUdlbmVyYXRvciBmcm9tICcuLi8uLi9saWIvZXhlcmNpc2VfZ2VuZXJhdG9yL2V4ZXJjaXNlLWdlbmVyYXRvcidcbmltcG9ydCBFeGVyY2lzZUhlbHBlciBmcm9tICcuLi91dGlscy9leGVyY2lzZS1oZWxwZXInXG5cbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQtdGltZXpvbmUnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcblxubGV0IEFuYWx5dGljc1NlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy9hbmFseXRpY3Mtc2VydmljZScpKVxubGV0IEJhc2VDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnYmFzZS1jb250cm9sbGVyJykpXG5sZXQgUGFzc3BvcnRIZWxwZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi91dGlscy9wYXNzcG9ydC1oZWxwZXInKSlcbmxldCBQYXRoRm9ybWF0dGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vbGliL3BhdGgtZm9ybWF0dGVyJykpXG5cbmxldCBGb3JtYXR0ZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvdXRpbHMvZm9ybWF0dGVyJykpXG5sZXQgVXRpbHMgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi91dGlscy91dGlscycpKVxuXG5jb25zdCBUQUcgPSAnRXhlcmNpc2VDb250cm9sbGVyJ1xuXG5jbGFzcyBFeGVyY2lzZUNvbnRyb2xsZXIgZXh0ZW5kcyBCYXNlQ29udHJvbGxlciB7XG4gIHByaXZhdGUgZXhlcmNpc2VGcm9udGVuZEpTOiBzdHJpbmdcbiAgaW5pdGlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIFBhdGhGb3JtYXR0ZXIuaGFzaEFzc2V0KCdhcHAnLCAnL2Fzc2V0cy9qcy9leGVyY2lzZS1hcHAtYnVuZGxlLmpzJykudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICB0aGlzLmV4ZXJjaXNlRnJvbnRlbmRKUyA9IHJlc3VsdFxuICAgICAgICByZXNvbHZlKClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJlamVjdChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBjb25zdHJ1Y3RvciAoaW5pdERhdGEpIHtcbiAgICBzdXBlcihpbml0RGF0YSlcbiAgICBjb25zdCBhbmFseXRpY3NTZXJ2aWNlID0gbmV3IEFuYWx5dGljc1NlcnZpY2UodGhpcy5nZXREYigpLnNlcXVlbGl6ZSwgdGhpcy5nZXREYigpLm1vZGVscylcbiAgICB0aGlzLmFkZEludGVyY2VwdG9yKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbmV4dCgpXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy86dG9waWNJZC86dG9waWNTbHVnLzpzdWJ0b3BpY0lkLzpzdWJ0b3BpY1NsdWcvOmV4ZXJjaXNlSWQvOmV4ZXJjaXNlU2x1ZycsIFBhc3Nwb3J0SGVscGVyLmVuc3VyZUxvZ2dlZEluKCksIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSByZXEucGFyYW1zLmV4ZXJjaXNlSWRcbiAgICAgIGNvbnN0IHN1YnRvcGljSWQgPSByZXEucGFyYW1zLnN1YnRvcGljSWRcblxuICAgICAgUHJvbWlzZS5qb2luPGFueT4oXG4gICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRGb3JtYXR0ZWRFeGVyY2lzZShleGVyY2lzZUlkLCB1c2VySWQpLFxuICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRFeGVyY2lzZVN0YXJzKHVzZXJJZCwgZXhlcmNpc2VJZCksXG4gICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRSZW5kZXJlZEV4ZXJjaXNlVGltZXJzKHVzZXJJZCwgZXhlcmNpc2VJZCksXG4gICAgICAgIENvdXJzZVNlcnZpY2UuZ2V0UHJldmlvdXNBbmROZXh0RXhlcmNpc2Uoc3VidG9waWNJZCwgZXhlcmNpc2VJZCksXG4gICAgICAgIENvdXJzZVNlcnZpY2UuZ2V0UHJldmlvdXNBbmROZXh0U3VidG9waWMoc3VidG9waWNJZCksXG4gICAgICAgIENvdXJzZVNlcnZpY2UuZ2V0U3VidG9waWMoc3VidG9waWNJZClcbiAgICAgICkuc3ByZWFkKChyZXNwMTogTkNSZXNwb25zZTxGb3JtYXR0ZWRTdWJ0b3BpY0V4ZXJjaXNlPixcbiAgICAgICAgICAgICAgICByZXNwMjogTkNSZXNwb25zZTxzdHJpbmc+LFxuICAgICAgICAgICAgICAgIHJlc3AzOiBOQ1Jlc3BvbnNlPHN0cmluZz4sXG4gICAgICAgICAgICAgICAgcmVzcDQ6IE5DUmVzcG9uc2U8eyBuZXh0PzogRXhlcmNpc2UsIHByZXY/OiBFeGVyY2lzZX0+LFxuICAgICAgICAgICAgICAgIHJlc3A1OiBOQ1Jlc3BvbnNlPHsgbmV4dD86IFN1YnRvcGljLCBwcmV2PzogU3VidG9waWN9PixcbiAgICAgICAgICAgICAgICByZXNwNjogTkNSZXNwb25zZTxTdWJ0b3BpYz4pID0+IHtcbiAgICAgICAgaWYgKHJlc3AxLnN0YXR1cyAmJiByZXNwMS5kYXRhICYmXG4gICAgICAgICAgICByZXNwNC5zdGF0dXMgJiYgcmVzcDQuZGF0YSAmJlxuICAgICAgICAgICAgcmVzcDUuc3RhdHVzICYmIHJlc3A1LmRhdGEgJiZcbiAgICAgICAgICAgIHJlc3A2LnN0YXR1cyAmJiByZXNwNi5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgcHJldkFuZE5leHRFeGVyY2lzZSA9IHJlc3A0LmRhdGFcbiAgICAgICAgICBjb25zdCBwcmV2QW5kTmV4dFN1YnRvcGljID0gcmVzcDUuZGF0YVxuICAgICAgICAgIHJlcy5sb2NhbHMuZm9ybWF0dGVkRXhlcmNpc2UgPSByZXNwMS5kYXRhLmZvcm1hdHRlZEV4ZXJjaXNlXG4gICAgICAgICAgcmVzLmxvY2Fscy5lbGFwc2VkVGltZSA9IHJlc3AxLmRhdGEuZWxhcHNlZFRpbWVcbiAgICAgICAgICByZXMubG9jYWxzLmlkZWFsVGltZSA9IHJlc3AxLmRhdGEuaWRlYWxUaW1lXG4gICAgICAgICAgcmVzLmxvY2Fscy5leGVyY2lzZUlkID0gcmVzcDEuZGF0YS5leGVyY2lzZUlkXG4gICAgICAgICAgcmVzLmxvY2Fscy5wcmV2TGluayA9IHByZXZBbmROZXh0RXhlcmNpc2UgJiYgcHJldkFuZE5leHRFeGVyY2lzZS5wcmV2XG4gICAgICAgICAgICAgID8gRm9ybWF0dGVyLmdldEV4ZXJjaXNlVVJMKHByZXZBbmROZXh0RXhlcmNpc2UucHJldilcbiAgICAgICAgICAgICAgOiAocHJldkFuZE5leHRTdWJ0b3BpYyAmJiBwcmV2QW5kTmV4dFN1YnRvcGljLnByZXYgP1xuICAgICAgICAgICAgICAgICAgICBGb3JtYXR0ZXIuZ2V0U3VidG9waWNVUkwocHJldkFuZE5leHRTdWJ0b3BpYy5wcmV2KSA6IG51bGwpXG4gICAgICAgICAgcmVzLmxvY2Fscy5uZXh0TGluayA9IHByZXZBbmROZXh0RXhlcmNpc2UgJiYgcHJldkFuZE5leHRFeGVyY2lzZS5uZXh0XG4gICAgICAgICAgICAgID8gRm9ybWF0dGVyLmdldEV4ZXJjaXNlVVJMKHByZXZBbmROZXh0RXhlcmNpc2UubmV4dClcbiAgICAgICAgICAgICAgOiAocHJldkFuZE5leHRTdWJ0b3BpYyAmJiBwcmV2QW5kTmV4dFN1YnRvcGljLm5leHQgP1xuICAgICAgICAgICAgICAgICAgICBGb3JtYXR0ZXIuZ2V0U3VidG9waWNVUkwocHJldkFuZE5leHRTdWJ0b3BpYy5uZXh0KSA6IG51bGwpXG4gICAgICAgICAgcmVzLmxvY2Fscy5zdGFyc0hUTUwgPSByZXNwMi5zdGF0dXMgPyByZXNwMi5kYXRhIDogJzxwIHN0eWxlPVwiY29sb3I6cmVkO1wiPiBVbmFibGUgdG8gcmV0cmlldmUgc3RhcnMuLi4gPC9wPidcbiAgICAgICAgICByZXMubG9jYWxzLnRpbWVyc0hUTUwgPSByZXNwMy5zdGF0dXMgPyByZXNwMy5kYXRhIDogJzxwIHN0eWxlPVwiY29sb3I6cmVkO1wiPiBVbmFibGUgdG8gcmV0cmlldmUgdGltZXJzLi4uIDwvcD4nXG4gICAgICAgICAgcmVzLmxvY2Fscy5zdWJ0b3BpYyA9IHJlc3A2LmRhdGFcblxuICAgICAgICAgIHJlcy5sb2NhbHMuYnVuZGxlID0gdGhpcy5leGVyY2lzZUZyb250ZW5kSlNcbiAgICAgICAgICByZXMucmVuZGVyKCdleGVyY2lzZScpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbmV4dChuZXcgRXJyb3IocmVzcDEuZXJyTWVzc2FnZSB8fCByZXNwNC5lcnJNZXNzYWdlIHx8IHJlc3A1LmVyck1lc3NhZ2UgfHwgcmVzcDYuZXJyTWVzc2FnZSkpXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKG5leHQpXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy9nZXRFeGVyY2lzZVN0YXJzJywgUGFzc3BvcnRIZWxwZXIuZW5zdXJlTG9nZ2VkSW4oKSwgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBleGVyY2lzZUlkID0gcGFyc2VJbnQocmVxLnF1ZXJ5LmV4ZXJjaXNlSWQsIDEwKVxuICAgICAgaWYgKGV4ZXJjaXNlSWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBleGVyY2lzZUlkIGlzIG5lZWRlZGAgfSlcbiAgICAgIH0gZWxzZSBpZiAoIXJlcS5pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgVW5hdXRob3JpemVkYCB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gc3VidG9waWMgc3RhcnNcbiAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlU3RhcnMocmVxLnVzZXIuaWQsIGV4ZXJjaXNlSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy9leGVyY2lzZS9nZXRMZWFkZXJib2FyZCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgZXhlcmNpc2VJZCA9IHBhcnNlSW50KHJlcS5ib2R5LmV4ZXJjaXNlSWQsIDEwKVxuICAgICAgaWYgKGV4ZXJjaXNlSWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBleGVyY2lzZUlkIGlzIG5lZWRlZGAgfSlcbiAgICAgIH0gZWxzZSBpZiAoIXJlcS5pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgVW5hdXRob3JpemVkYCB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlTGVhZGVyYm9hcmQoZXhlcmNpc2VJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIG5leHQoZXJyKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICAvLyBHcmFkaW5nXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy86dG9waWNJZC86dG9waWNTbHVnLzpzdWJ0b3BpY0lkLzpzdWJ0b3BpY1NsdWcvOmV4ZXJjaXNlSWQvOmV4ZXJjaXNlU2x1ZycsIFBhc3Nwb3J0SGVscGVyLmVuc3VyZUxvZ2dlZEluKCksIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWRcbiAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSByZXEuYm9keS5leGVyY2lzZUlkXG4gICAgICBsb2cudmVyYm9zZShUQUcsIGBzdWJtaXRBbnN3ZXIuUE9TVCgpOiB1c2VySWQ9JHt1c2VySWR9IGV4ZXJjaXNlSWQ9JHtleGVyY2lzZUlkfWApXG5cbiAgICAgIGlmICghcmVxLmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgICBsb2cudmVyYm9zZShUQUcsICdzdWJtaXRBbnN3ZXIuUE9TVDogcmVxdWVzdCBpcyBub3QgYXV0aGVudGljYXRlZCEnKVxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuc2VuZCgnUmVxdWVzdCBub3QgYXV0aGVudGljYXRlZCEnKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgUHJvbWlzZS5qb2luPGFueT4oXG4gICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEdlbmVyYXRlZEV4ZXJjaXNlKHsgdXNlcklkLCBleGVyY2lzZUlkIH0pLCAvLyBFeGVyY2lzZSB0aGF0J3MgY3VycmVudGx5IGJlaW5nIGdyYWRlZFxuICAgICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRTdWJtaXR0ZWRFeGVyY2lzZXMoeyB1c2VySWQsIGV4ZXJjaXNlSWQgfSksXG4gICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlKGV4ZXJjaXNlSWQpXG4gICAgICAgICkuc3ByZWFkKChnZVJlc3A6IE5DUmVzcG9uc2U8YW55Piwgc2dlUmVzcDogTkNSZXNwb25zZTxhbnk+LCBlUmVzcDogTkNSZXNwb25zZTxhbnk+KSA9PiB7XG4gICAgICAgICAgaWYgKCFnZVJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICBsb2cuZXJyb3IoVEFHLCAnZ2VSZXNwLnN0YXR1cz0nICsgZ2VSZXNwLnN0YXR1cyArICcgZ2VSZXNwLmVyck1lc3NhZ2U9JyArIGdlUmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0N1cnJlbnQgZXhlcmNpc2UgY2Fubm90IGJlIGZvdW5kJyB9KVxuICAgICAgICAgIH0gZWxzZSBpZiAoIWVSZXNwLnN0YXR1cykge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0V4ZXJjaXNlIGluZm9ybWF0aW9uIGJlIGZvdW5kJyB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBnZW5lcmF0ZWRFeGVyY2lzZSA9IGdlUmVzcC5kYXRhXG4gICAgICAgICAgICBsZXQgZ2VuZXJhdGVkUXVlc3Rpb25zID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS5rbm93bnMpXG4gICAgICAgICAgICBjb25zdCBzdWJtaXR0ZWRFeGVyY2lzZXMgPSBzZ2VSZXNwLnN0YXR1cyA/IHNnZVJlc3AuZGF0YSA6IFtdXG4gICAgICAgICAgICBjb25zdCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKGVSZXNwLmRhdGEuZGF0YSlcbiAgICAgICAgICAgIGNvbnN0IHVzZXJBbnN3ZXJzID0gcmVxLmJvZHkudXNlckFuc3dlcnMgLy8gW3sneCc6ICcyJywgJ3knOiAnMyd9LCB7J3gnOiAnMScsICd5JzogJzMnfV0uIFRoaXMgaXMgc3RyaW5nIGJhc2VkXG5cbiAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgYHN1Ym1pdEFuc3dlci5QT1NUKCk6IHVzZXJBbnN3ZXI9JHtKU09OLnN0cmluZ2lmeSh1c2VyQW5zd2Vycyl9YClcbiAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgYHN1Ym1pdEFuc3dlci5QT1NUKCk6IGdlbmVyYXRlZFF1ZXN0aW9ucz0ke0pTT04uc3RyaW5naWZ5KGdlbmVyYXRlZFF1ZXN0aW9ucyl9YClcbiAgICAgICAgICAgIGlmICh1c2VyQW5zd2Vycy5sZW5ndGggIT09IGdlbmVyYXRlZFF1ZXN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ051bWJlciBvZiBzdWJtaXR0ZWQgYW5zd2VycyBkb2VzblxcJ3QgbWF0Y2ggbnVtYmVyIG9mIHF1ZXN0aW9ucyEnIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAvLyBHZXQgdGhlIG51bWJlciBvZiBub24tZW1wdHkgYW5zd2VyLiAoaS5lLiB0aGUgc3R1ZGVudCB0cmllcyB0byBhbnN3ZXIgZXZlbnRob3VnaCBpdCdzIHdyb25nKVxuICAgICAgICAgICAgICBjb25zdCBhdHRlbXB0ZWRBbnN3ZXJzID0gdXNlckFuc3dlcnMucmVkdWNlKChhdHRlbXB0ZWRBbnN3ZXJzLCBhbnN3ZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoYW5zd2VyKVxuICAgICAgICAgICAgICAgIGxldCBhdHRlbXB0ZWQgPSBmYWxzZVxuICAgICAgICAgICAgICAgIGtleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKGFuc3dlcltrZXldLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdGVkID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRlZCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRlZEFuc3dlcnMgKyAxXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBhdHRlbXB0ZWRBbnN3ZXJzXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9LCAwKSAvIHBhcnNlRmxvYXQoZ2VuZXJhdGVkUXVlc3Rpb25zLmxlbmd0aCkgKiAxMDBcblxuICAgICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdzdWJtaXRBbnN3ZXIuUE9TVCgpOiBhdHRlbXB0ZWRBbnN3ZXJzPSAnICsgYXR0ZW1wdGVkQW5zd2VycylcblxuICAgICAgICAgICAgICAvLyBGbGFnIGFycmF5IGlkZW50aWZ5aW5nIHdoaWNoIHVzZXIgYW5zd2VyIGlzIGNvcnJlY3Qvd3JvbmdcbiAgICAgICAgICAgICAgY29uc3QgaXNBbnN3ZXJDb3JyZWN0OiBib29sZWFuW10gPSBbXVxuICAgICAgICAgICAgICAvLyBDb21wdXRlIHRoZSBzY29yZSBvZiBjdXJyZW50IGV4ZXJjaXNlXG4gICAgICAgICAgICAgIGNvbnN0IGNvcnJlY3RBbnN3ZXJzID0gZ2VuZXJhdGVkUXVlc3Rpb25zLnJlZHVjZSgobnVtQ29ycmVjdCwga25vd25zLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVua25vd25zID0gdXNlckFuc3dlcnNcbiAgICAgICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsIGBzdWJtaXRBbnN3ZXIuUE9TVCgpOiBrbm93bnM9JHtKU09OLnN0cmluZ2lmeShrbm93bnMpfSwgdW5rbm93bnM9JHtKU09OLnN0cmluZ2lmeSh1bmtub3duc1tpbmRleF0pfSBpc0Fuc3dlcj0ke2V4ZXJjaXNlU29sdmVyLmlzQW5zd2VyKGtub3ducywgdW5rbm93bnNbaW5kZXhdKX1gKVxuICAgICAgICAgICAgICAgIGNvbnN0IGlzQ29ycmVjdCA9IGV4ZXJjaXNlU29sdmVyLmlzQW5zd2VyKGtub3ducywgdW5rbm93bnNbaW5kZXhdKVxuICAgICAgICAgICAgICAgIGlzQW5zd2VyQ29ycmVjdC5wdXNoKGlzQ29ycmVjdClcbiAgICAgICAgICAgICAgICByZXR1cm4gaXNDb3JyZWN0ID8gbnVtQ29ycmVjdCArIDEgOiBudW1Db3JyZWN0XG4gICAgICAgICAgICAgIH0sIDApXG4gICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY29yZSA9IGNvcnJlY3RBbnN3ZXJzIC8gcGFyc2VGbG9hdChnZW5lcmF0ZWRRdWVzdGlvbnMubGVuZ3RoKSAqIDEwMFxuICAgICAgICAgICAgICAvLyBDb21wdXRlIHRoZSBiZXN0IHNjb3JlXG4gICAgICAgICAgICAgIGNvbnN0IGJlc3RTY29yZSA9IHN1Ym1pdHRlZEV4ZXJjaXNlcy5yZWR1Y2UoKGJlc3RTY29yZSwgc3VibWl0ZWRFeGVyY2lzZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdWJtaXRlZEV4ZXJjaXNlLnNjb3JlID4gYmVzdFNjb3JlID8gc3VibWl0ZWRFeGVyY2lzZS5zY29yZSA6IGJlc3RTY29yZVxuICAgICAgICAgICAgICB9LCAwKVxuXG4gICAgICAgICAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBjb3JyZWN0IGFuZCBhdHRlbXB0ZWQgYW5zd2Vyc1xuICAgICAgICAgICAgICBQcm9taXNlLmpvaW4oXG4gICAgICAgICAgICAgICAgYW5hbHl0aWNzU2VydmljZS5hZGRFeGVyY2lzZURhdGEoJ2NvcnJlY3RBbnN3ZXJzJywgY3VycmVudFNjb3JlLCBleGVyY2lzZUlkLCB1c2VySWQpLFxuICAgICAgICAgICAgICAgIGFuYWx5dGljc1NlcnZpY2UuYWRkRXhlcmNpc2VEYXRhKCdhdHRlbXB0ZWRBbnN3ZXJzJywgYXR0ZW1wdGVkQW5zd2VycywgZXhlcmNpc2VJZCwgdXNlcklkKVxuICAgICAgICAgICAgICApLnNwcmVhZCgocmVzcDogTkNSZXNwb25zZTxhbnk+LCByZXNwMjogTkNSZXNwb25zZTxhbnk+KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXNwLnN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgbG9nLmVycm9yKFRBRywgJ3N1Ym1pdEFuc3dlci5QT1NUKCk6IGFkZEV4ZXJjaXNlRGF0YS5yZXNwPScgKyBKU09OLnN0cmluZ2lmeShyZXNwKSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFyZXNwMi5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgIGxvZy5lcnJvcihUQUcsICdzdWJtaXRBbnN3ZXIuUE9TVCgpOiBhZGRFeGVyY2lzZURhdGEucmVzcDI9JyArIEpTT04uc3RyaW5naWZ5KHJlc3AyKSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgbG9nLmVycm9yKFRBRywgZXJyKVxuICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgIGNvbnN0IHRpbWVGaW5pc2ggPSBFeGVyY2lzZUhlbHBlci5jb3VudFRpbWVGaW5pc2goZ2VuZXJhdGVkRXhlcmNpc2UuY3JlYXRlZEF0KVxuICAgICAgICAgICAgICByZXR1cm4gRXhlcmNpc2VTZXJ2aWNlLnVwZGF0ZUdlbmVyYXRlZEV4ZXJjaXNlKHtcbiAgICAgICAgICAgICAgICBpZDogZ2VuZXJhdGVkRXhlcmNpc2UuaWQsXG4gICAgICAgICAgICAgICAgc2NvcmU6IGN1cnJlbnRTY29yZSxcbiAgICAgICAgICAgICAgICB1c2VyQW5zd2VyOiBKU09OLnN0cmluZ2lmeSh1c2VyQW5zd2VycyksXG4gICAgICAgICAgICAgICAgc3VibWl0dGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHN1Ym1pdHRlZEF0OiBtb21lbnQoKS5sb2NhbCgpLmZvcm1hdCgnWVlZWS1NTS1ERCBISDptbTpzcycpLFxuICAgICAgICAgICAgICAgIHRpbWVGaW5pc2hcbiAgICAgICAgICAgICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgIFByb21pc2Uuam9pbihcbiAgICAgICAgICAgICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldFJlbmRlcmVkRXhlcmNpc2VTdGFycyh1c2VySWQsIGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0RXhlcmNpc2VMZWFkZXJib2FyZChleGVyY2lzZUlkKSxcbiAgICAgICAgICAgICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEN1cnJlbnRSYW5raW5nKHRpbWVGaW5pc2gsIGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0VG90YWxSYW5raW5nKGV4ZXJjaXNlSWQpLFxuICAgICAgICAgICAgICAgICAgICBFeGVyY2lzZVNlcnZpY2UuZ2V0UmVuZGVyZWRFeGVyY2lzZVRpbWVycyh1c2VySWQsIGV4ZXJjaXNlSWQpXG4gICAgICAgICAgICAgICAgICApLnNwcmVhZCgocmVzcDI6IE5DUmVzcG9uc2U8YW55PiwgcmVzcDM6IE5DUmVzcG9uc2U8YW55PixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwNDogTkNSZXNwb25zZTxhbnk+LCByZXNwNTogTkNSZXNwb25zZTxhbnk+LCByZXNwNjogTkNSZXNwb25zZTxhbnk+KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVhbEFuc3dlcnM6IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UudW5rbm93bnMpLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNBbnN3ZXJDb3JyZWN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFNjb3JlLFxuICAgICAgICAgICAgICAgICAgICAgICAgYmVzdFNjb3JlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnNIVE1MOiByZXNwMi5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXJzSFRNTDogcmVzcDYuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmtpbmc6IHJlc3AzLmRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZUZpbmlzaDogdGltZUZpbmlzaCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRSYW5raW5nOiByZXNwNC5kYXRhLmNvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxSYW5raW5nOiByZXNwNS5kYXRhLmNvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNQZXJmZWN0U2NvcmU6IGN1cnJlbnRTY29yZSA9PT0gMTAwXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIHNhdmUgZ2VuZXJhdGVkIGV4ZXJjaXNlJyB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgbG9nLmVycm9yKFRBRywgZXJyKVxuICAgICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogZXJyLm1lc3NhZ2UgfSlcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy9leGVyY2lzZS9hbmFseXRpY3MnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIC8vIEV2ZW50IHR5cGVcbiAgICAgIGNvbnN0IGtleSA9IHJlcS5ib2R5LmtleVxuICAgICAgY29uc3QgZXhlcmNpc2VJZCA9IHJlcS5ib2R5LmV4ZXJjaXNlSWRcbiAgICAgIGNvbnN0IHVzZXJJZCA9IChyZXEudXNlciAmJiByZXEudXNlci5pZCkgfHwgLTFcbiAgICAgIGNvbnN0IHZhbHVlID0gcmVxLmJvZHkudmFsdWVcbiAgICAgIGFuYWx5dGljc1NlcnZpY2UuYWRkRXhlcmNpc2VEYXRhKGtleSwgdmFsdWUsIGV4ZXJjaXNlSWQsIHVzZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRXhlcmNpc2VDb250cm9sbGVyXG4iXX0=
