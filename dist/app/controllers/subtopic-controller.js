"use strict";const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_service_1=require("../../services/exercise-service");let path=require("path"),log=require("npmlog"),AnalyticsService=require(path.join(__dirname,"../../services/analytics-service")),AppConfig=require(path.join(__dirname,"../../app-config")),BaseController=require(path.join(__dirname,"base-controller")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),Formatter=require(path.join(__dirname,"../../lib/utils/formatter")),VideoService=require(path.join(__dirname,"../../services/video-service"));const TAG="SubtopicController";class SubtopicController extends BaseController{constructor(e){super(e);const s=new VideoService(this.getDb().sequelize,this.getDb().models),t=new AnalyticsService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,s,t)=>{t()}),this.routePost("/video/analytics",(e,s,i)=>{const r=e.body.key,a=e.body.videoId,o=e.user&&e.user.id||-1,c=e.body.value;t.addVideoData(r,c,a,o).then(e=>{s.json(e)}).catch(e=>{i(e)})}),this.routePost("/video/finishedWatching",(e,t,i)=>{const r=e.body.videoId,a=e.user.id;a&&s.addFinishedWatching(r,a).then(e=>{t.json(e)}).catch(e=>{i(e)})}),this.routeGet("/:topicId/:topicSlug/:subtopicId/:subtopicSlug",(e,t,i)=>{let r=e.params.topicId,a=e.params.subtopicId;a?Promise.join(course_service_1.default.readOne({modelName:"Subtopic",searchClause:{id:a}}),course_service_1.default.read({modelName:"Exercise",searchClause:{subtopicId:a}}),course_service_1.default.readOne({modelName:"Topic",searchClause:{id:r}}),s.getVideo(a),course_service_1.default.getPreviousAndNextSubtopic(a)).spread((s,r,a,o,c)=>{if(s.status&&a.status&&o.status){const i=s.data;t.locals.prevLink=c.status&&c.data.prev?Formatter.getSubtopicURL(c.data.prev):null,t.locals.nextLink=c.status&&c.data.next?Formatter.getSubtopicURL(c.data.next):null,t.locals.topic=a.data,t.locals.subtopic=i,t.locals.subtopicData=JSON.parse(i.data),t.locals.exercises=r.data||[],t.locals.isAuthenticated=e.isAuthenticated(),t.locals.bundle=this._assetBundle,log.verbose(TAG,"subtopic.GET(): resp4="+JSON.stringify(o));const d=`<video class="video-js vjs-fluid vjs-default-skin vjs-big-play-centered" id="video-player" data-id=${o.data.id} controls data-setup='{}'>`,l="<div class='text-center text-danger'>Video does not exist</div>";if(AppConfig.CLOUD_SERVER){const e=o.status&&o.data.remoteHostedURL;t.locals.videoSource=e?`${d}\n  <source src="${o.data.remoteHostedURL.HD}" type="video/mp4" label="HD" res="720"/>\n  <source src="${o.data.remoteHostedURL.nonHD}" type="video/mp4" label="SD" res="360"/>\n</video>`:l}else{const e=o.status&&o.data.selfHostedURL;t.locals.videoSource=e?`${d}<source src=${e}></video>`:l}return e.isAuthenticated()?Promise.map(t.locals.exercises,(s,i)=>Promise.join(exercise_service_1.default.getExerciseStars(e.user.id,s.id),exercise_service_1.default.getExerciseTimers(e.user.id,s.id),(e,s)=>{log.verbose(TAG,"subtopic.GET(): star="+e.data.stars),log.verbose(TAG,"subtopic.GET(): timer="+s.data.timers),t.locals.exercises[i].stars=e.data.stars,t.locals.exercises[i].timers=s.data.timers})).then(e=>{t.render("subtopic")}):(e.session.returnTo=e.originalUrl||e.url,t.render("subtopic"))}i()}).catch(e=>{i(e)}):i()})}initialize(){return new Promise((e,s)=>{PathFormatter.hashAsset("app","/assets/js/subtopic-app-bundle.js").then(s=>{this._assetBundle=s,e()}).catch(e=>{s(e)})})}}module.exports=SubtopicController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvc3VidG9waWMtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsImNvdXJzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwiQW5hbHl0aWNzU2VydmljZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJBcHBDb25maWciLCJCYXNlQ29udHJvbGxlciIsIlBhdGhGb3JtYXR0ZXIiLCJGb3JtYXR0ZXIiLCJWaWRlb1NlcnZpY2UiLCJUQUciLCJTdWJ0b3BpY0NvbnRyb2xsZXIiLCJbb2JqZWN0IE9iamVjdF0iLCJpbml0RGF0YSIsInN1cGVyIiwidmlkZW9TZXJ2aWNlIiwidGhpcyIsImdldERiIiwic2VxdWVsaXplIiwibW9kZWxzIiwiYW5hbHl0aWNzU2VydmljZSIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsInJvdXRlUG9zdCIsImtleSIsImJvZHkiLCJ2aWRlb0lkIiwidXNlcklkIiwidXNlciIsImlkIiwidmFsdWUiLCJhZGRWaWRlb0RhdGEiLCJ0aGVuIiwicmVzcCIsImpzb24iLCJjYXRjaCIsImVyciIsImFkZEZpbmlzaGVkV2F0Y2hpbmciLCJyb3V0ZUdldCIsInRvcGljSWQiLCJwYXJhbXMiLCJzdWJ0b3BpY0lkIiwiZGVmYXVsdCIsInJlYWRPbmUiLCJtb2RlbE5hbWUiLCJzZWFyY2hDbGF1c2UiLCJyZWFkIiwiZ2V0VmlkZW8iLCJnZXRQcmV2aW91c0FuZE5leHRTdWJ0b3BpYyIsInNwcmVhZCIsInJlc3AyIiwicmVzcDMiLCJyZXNwNCIsInJlc3A1Iiwic3RhdHVzIiwic3VidG9waWMiLCJkYXRhIiwibG9jYWxzIiwicHJldkxpbmsiLCJwcmV2IiwiZ2V0U3VidG9waWNVUkwiLCJuZXh0TGluayIsInRvcGljIiwic3VidG9waWNEYXRhIiwiSlNPTiIsInBhcnNlIiwiZXhlcmNpc2VzIiwiaXNBdXRoZW50aWNhdGVkIiwiYnVuZGxlIiwiX2Fzc2V0QnVuZGxlIiwidmVyYm9zZSIsInN0cmluZ2lmeSIsInZpZGVvVGFnIiwibWlzc2luZ1ZpZGVvIiwiQ0xPVURfU0VSVkVSIiwic3JjIiwicmVtb3RlSG9zdGVkVVJMIiwidmlkZW9Tb3VyY2UiLCJIRCIsIm5vbkhEIiwic2VsZkhvc3RlZFVSTCIsIm1hcCIsImV4ZXJjaXNlIiwiaW5kZXgiLCJnZXRFeGVyY2lzZVN0YXJzIiwiZ2V0RXhlcmNpc2VUaW1lcnMiLCJyZXNwU3RhcnMiLCJyZXNwVGltZXJzIiwic3RhcnMiLCJ0aW1lcnMiLCJyZXN1bHRzIiwicmVuZGVyIiwic2Vzc2lvbiIsInJldHVyblRvIiwib3JpZ2luYWxVcmwiLCJ1cmwiLCJyZXNvbHZlIiwicmVqZWN0IiwiaGFzaEFzc2V0IiwicmVzdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6ImFBQUEsTUFBQUEsUUFBQUMsUUFBQSxZQUVBQyxpQkFBQUQsUUFBQSxpQ0FDQUUsbUJBQUFGLFFBQUEsbUNBRUEsSUFBSUcsS0FBT0gsUUFBUSxRQUNmSSxJQUFNSixRQUFRLFVBRWRLLGlCQUFtQkwsUUFBUUcsS0FBS0csS0FBS0MsVUFBVyxxQ0FDaERDLFVBQVlSLFFBQVFHLEtBQUtHLEtBQUtDLFVBQVcscUJBQ3pDRSxlQUFpQlQsUUFBUUcsS0FBS0csS0FBS0MsVUFBVyxvQkFDOUNHLGNBQWdCVixRQUFRRyxLQUFLRyxLQUFLQyxVQUFXLDZCQUM3Q0ksVUFBWVgsUUFBUUcsS0FBS0csS0FBS0MsVUFBVyw4QkFDekNLLGFBQWVaLFFBQVFHLEtBQUtHLEtBQUtDLFVBQVcsaUNBRWhELE1BQU1NLElBQU0sMkJBRVpDLDJCQUFpQ0wsZUFDL0JNLFlBQWFDLEdBQ1hDLE1BQU1ELEdBQ04sTUFBTUUsRUFBZSxJQUFJTixhQUFhTyxLQUFLQyxRQUFRQyxVQUFXRixLQUFLQyxRQUFRRSxRQUNyRUMsRUFBbUIsSUFBSWxCLGlCQUFpQmMsS0FBS0MsUUFBUUMsVUFBV0YsS0FBS0MsUUFBUUUsUUFFbkZILEtBQUtL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aUJoRSxFQUFJUSxLQUFLQyxHQUFJcUQsRUFBU3JELElBQ3ZEaEMsbUJBQUE2QyxRQUFnQjJDLGtCQUFrQmpFLEVBQUlRLEtBQUtDLEdBQUlxRCxFQUFTckQsSUFDeEQsQ0FBQ3lELEVBQVdDLEtBQ1Z4RixJQUFJdUUsUUFBUTlELElBQUssd0JBQTBCOEUsRUFBVTlCLEtBQUtnQyxPQUMxRHpGLElBQUl1RSxRQUFROUQsSUFBSyx5QkFBMkIrRSxFQUFXL0IsS0FBS2lDLFFBQzVEcEUsRUFBSW9DLE9BQU9TLFVBQVVpQixHQUFPSyxNQUFRRixFQUFVOUIsS0FBS2dDLE1BQ25EbkUsRUFBSW9DLE9BQU9TLFVBQVVpQixHQUFPTSxPQUFTRixFQUFXL0IsS0FBS2lDLFVBR3hEekQsS0FBSzBELElBQ05yRSxFQUFJc0UsT0FBTyxlQWZidkUsRUFBSXdFLFFBQVFDLFNBQVd6RSxFQUFJMEUsYUFBZTFFLEVBQUkyRSxJQUN2QzFFLEVBQUlzRSxPQUFPLGFBbUJwQnJFLE1BRURhLE1BQU1DLElBQ1BkLEVBQUtjLEtBR1BkLE1BS05aLGFBQ0UsT0FBTyxJQUFJaEIsUUFBUSxDQUFDc0csRUFBU0MsS0FDM0I1RixjQUFjNkYsVUFBVSxNQUFPLHFDQUFxQ2xFLEtBQUttRSxJQUN2RXJGLEtBQUt1RCxhQUFlOEIsRUFDcEJILE1BQ0M3RCxNQUFNQyxJQUNQNkQsRUFBTzdELFFBTWZnRSxPQUFBQyxRQUFTNUYiLCJmaWxlIjoiYXBwL2NvbnRyb2xsZXJzL3N1YnRvcGljLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuXG5pbXBvcnQgQ291cnNlU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jb3Vyc2Utc2VydmljZSdcbmltcG9ydCBFeGVyY2lzZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvZXhlcmNpc2Utc2VydmljZSdcblxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxuXG5sZXQgQW5hbHl0aWNzU2VydmljZSA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL3NlcnZpY2VzL2FuYWx5dGljcy1zZXJ2aWNlJykpXG5sZXQgQXBwQ29uZmlnID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vYXBwLWNvbmZpZycpKVxubGV0IEJhc2VDb250cm9sbGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnYmFzZS1jb250cm9sbGVyJykpXG5sZXQgUGF0aEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi9wYXRoLWZvcm1hdHRlcicpKVxubGV0IEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi91dGlscy9mb3JtYXR0ZXInKSlcbmxldCBWaWRlb1NlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy92aWRlby1zZXJ2aWNlJykpXG5cbmNvbnN0IFRBRyA9ICdTdWJ0b3BpY0NvbnRyb2xsZXInXG5cbmNsYXNzIFN1YnRvcGljQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG4gICAgY29uc3QgdmlkZW9TZXJ2aWNlID0gbmV3IFZpZGVvU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuICAgIGNvbnN0IGFuYWx5dGljc1NlcnZpY2UgPSBuZXcgQW5hbHl0aWNzU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIG5leHQoKVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3ZpZGVvL2FuYWx5dGljcycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgLy8gRXZlbnQgdHlwZVxuICAgICAgY29uc3Qga2V5ID0gcmVxLmJvZHkua2V5XG4gICAgICBjb25zdCB2aWRlb0lkID0gcmVxLmJvZHkudmlkZW9JZFxuICAgICAgY29uc3QgdXNlcklkID0gKHJlcS51c2VyICYmIHJlcS51c2VyLmlkKSB8fCAtMVxuICAgICAgY29uc3QgdmFsdWUgPSByZXEuYm9keS52YWx1ZVxuICAgICAgYW5hbHl0aWNzU2VydmljZS5hZGRWaWRlb0RhdGEoa2V5LCB2YWx1ZSwgdmlkZW9JZCwgdXNlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3ZpZGVvL2ZpbmlzaGVkV2F0Y2hpbmcnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IHZpZGVvSWQgPSByZXEuYm9keS52aWRlb0lkXG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZFxuICAgICAgLy8gV2Ugb25seSB3YW50IHRvIHRyYWNrIHZpZGVvIHdhdGNoZWQgYnkgdXNlci4gRm9yIHRob3NlIHdobyBkb24ndCBsb2dpbiwgd2UgYWxyZWFkeSBoYXZlIGFuYWx5dGljcyBzZXJ2aWNlXG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHZpZGVvU2VydmljZS5hZGRGaW5pc2hlZFdhdGNoaW5nKHZpZGVvSWQsIHVzZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIG5leHQoZXJyKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvOnRvcGljSWQvOnRvcGljU2x1Zy86c3VidG9waWNJZC86c3VidG9waWNTbHVnJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsZXQgdG9waWNJZCA9IHJlcS5wYXJhbXMudG9waWNJZFxuICAgICAgbGV0IHN1YnRvcGljSWQgPSByZXEucGFyYW1zLnN1YnRvcGljSWRcbiAgICAgIGlmIChzdWJ0b3BpY0lkKSB7XG4gICAgICAgIFByb21pc2Uuam9pbjxhbnk+KFxuICAgICAgICAgIENvdXJzZVNlcnZpY2UucmVhZE9uZSh7IG1vZGVsTmFtZTogJ1N1YnRvcGljJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBzdWJ0b3BpY0lkIH0gfSksXG4gICAgICAgICAgQ291cnNlU2VydmljZS5yZWFkPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IHN1YnRvcGljSWQgfSB9KSxcbiAgICAgICAgICBDb3Vyc2VTZXJ2aWNlLnJlYWRPbmUoeyBtb2RlbE5hbWU6ICdUb3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogdG9waWNJZCB9IH0pLFxuICAgICAgICAgIHZpZGVvU2VydmljZS5nZXRWaWRlbyhzdWJ0b3BpY0lkKSxcbiAgICAgICAgICBDb3Vyc2VTZXJ2aWNlLmdldFByZXZpb3VzQW5kTmV4dFN1YnRvcGljKHN1YnRvcGljSWQpXG4gICAgICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AyOiBOQ1Jlc3BvbnNlPGFueT4sXG4gICAgICAgICAgICAgICAgICByZXNwMzogTkNSZXNwb25zZTxhbnk+LCByZXNwNDogTkNSZXNwb25zZTxhbnk+LFxuICAgICAgICAgICAgICAgICAgcmVzcDU6IE5DUmVzcG9uc2U8YW55PikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwMy5zdGF0dXMgJiYgcmVzcDQuc3RhdHVzKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJ0b3BpYyA9IHJlc3AuZGF0YVxuICAgICAgICAgICAgcmVzLmxvY2Fscy5wcmV2TGluayA9IHJlc3A1LnN0YXR1cyAmJiByZXNwNS5kYXRhLnByZXYgPyBGb3JtYXR0ZXIuZ2V0U3VidG9waWNVUkwocmVzcDUuZGF0YS5wcmV2KSA6IG51bGxcbiAgICAgICAgICAgIHJlcy5sb2NhbHMubmV4dExpbmsgPSByZXNwNS5zdGF0dXMgJiYgcmVzcDUuZGF0YS5uZXh0ID8gRm9ybWF0dGVyLmdldFN1YnRvcGljVVJMKHJlc3A1LmRhdGEubmV4dCkgOiBudWxsXG4gICAgICAgICAgICByZXMubG9jYWxzLnRvcGljID0gcmVzcDMuZGF0YVxuICAgICAgICAgICAgcmVzLmxvY2Fscy5zdWJ0b3BpYyA9IHN1YnRvcGljXG4gICAgICAgICAgICAvLyBJbmZvcm1hdGlvbiBhYm91dCBzdWJ0b3BpYyBpcyBzdG9yZWQgYXMgSlNPTiBpbiAnZGF0YScgY29sdW1uXG4gICAgICAgICAgICByZXMubG9jYWxzLnN1YnRvcGljRGF0YSA9IEpTT04ucGFyc2Uoc3VidG9waWMuZGF0YSlcbiAgICAgICAgICAgIHJlcy5sb2NhbHMuZXhlcmNpc2VzID0gcmVzcDIuZGF0YSB8fCBbXVxuICAgICAgICAgICAgcmVzLmxvY2Fscy5pc0F1dGhlbnRpY2F0ZWQgPSByZXEuaXNBdXRoZW50aWNhdGVkKClcbiAgICAgICAgICAgIHJlcy5sb2NhbHMuYnVuZGxlID0gdGhpcy5fYXNzZXRCdW5kbGVcbiAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3N1YnRvcGljLkdFVCgpOiByZXNwND0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDQpKVxuICAgICAgICAgICAgY29uc3QgdmlkZW9UYWcgPSBgPHZpZGVvIGNsYXNzPVwidmlkZW8tanMgdmpzLWZsdWlkIHZqcy1kZWZhdWx0LXNraW4gdmpzLWJpZy1wbGF5LWNlbnRlcmVkXCIgaWQ9XCJ2aWRlby1wbGF5ZXJcIiBkYXRhLWlkPSR7cmVzcDQuZGF0YS5pZH0gY29udHJvbHMgZGF0YS1zZXR1cD0ne30nPmBcbiAgICAgICAgICAgIGNvbnN0IG1pc3NpbmdWaWRlbyA9IGA8ZGl2IGNsYXNzPSd0ZXh0LWNlbnRlciB0ZXh0LWRhbmdlcic+VmlkZW8gZG9lcyBub3QgZXhpc3Q8L2Rpdj5gXG4gICAgICAgICAgICAvLyBXaGVuIEZpbG9zIGlzIGNsb3VkLWhvc3RlZCwgd2UgdXNlIEFXUyBhcyB2aWRlbyBzb3VyY2VcbiAgICAgICAgICAgIGlmIChBcHBDb25maWcuQ0xPVURfU0VSVkVSKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHNyYyA9IHJlc3A0LnN0YXR1cyAmJiByZXNwNC5kYXRhLnJlbW90ZUhvc3RlZFVSTFxuICAgICAgICAgICAgICBpZiAoc3JjKSB7XG4gICAgICAgICAgICAgICAgcmVzLmxvY2Fscy52aWRlb1NvdXJjZSA9XG5gJHt2aWRlb1RhZ31cbiAgPHNvdXJjZSBzcmM9XCIke3Jlc3A0LmRhdGEucmVtb3RlSG9zdGVkVVJMLkhEfVwiIHR5cGU9XCJ2aWRlby9tcDRcIiBsYWJlbD1cIkhEXCIgcmVzPVwiNzIwXCIvPlxuICA8c291cmNlIHNyYz1cIiR7cmVzcDQuZGF0YS5yZW1vdGVIb3N0ZWRVUkwubm9uSER9XCIgdHlwZT1cInZpZGVvL21wNFwiIGxhYmVsPVwiU0RcIiByZXM9XCIzNjBcIi8+XG48L3ZpZGVvPmBcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXMubG9jYWxzLnZpZGVvU291cmNlID0gbWlzc2luZ1ZpZGVvXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgd2UgdXNlIGxvY2FsIGNvcHlcbiAgICAgICAgICAgICAgY29uc3Qgc3JjID0gcmVzcDQuc3RhdHVzICYmIHJlc3A0LmRhdGEuc2VsZkhvc3RlZFVSTFxuICAgICAgICAgICAgICBpZiAoc3JjKSB7XG4gICAgICAgICAgICAgICAgcmVzLmxvY2Fscy52aWRlb1NvdXJjZSA9IGAke3ZpZGVvVGFnfTxzb3VyY2Ugc3JjPSR7c3JjfT48L3ZpZGVvPmBcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXMubG9jYWxzLnZpZGVvU291cmNlID0gbWlzc2luZ1ZpZGVvXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gSWYgdXNlciBpc24ndCBsb2dnZWQgaW4sIHdlIHRlbGwgdGhlbSB0aGV5IG5lZWQgdG8gbG9naW4vcmVnaXN0ZXIgdG9cbiAgICAgICAgICAgIC8vIGFjY2VzcyBleGVyY2lzZS4gQW5kIHdoZW4gdGhleSBkbywgd2Ugd2FudCB0byByZWRpcmVjdCBoZXJlXG4gICAgICAgICAgICBpZiAoIXJlcS5pc0F1dGhlbnRpY2F0ZWQoKSkge1xuICAgICAgICAgICAgICByZXEuc2Vzc2lvbi5yZXR1cm5UbyA9IHJlcS5vcmlnaW5hbFVybCB8fCByZXEudXJsXG4gICAgICAgICAgICAgIHJldHVybiByZXMucmVuZGVyKCdzdWJ0b3BpYycpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5tYXAocmVzLmxvY2Fscy5leGVyY2lzZXMsIChleGVyY2lzZTogRXhlcmNpc2UsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2Uuam9pbjxhbnk+KFxuICAgICAgICAgICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlU3RhcnMocmVxLnVzZXIuaWQsIGV4ZXJjaXNlLmlkKSxcbiAgICAgICAgICAgICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZVRpbWVycyhyZXEudXNlci5pZCwgZXhlcmNpc2UuaWQpLFxuICAgICAgICAgICAgICAgICAgKHJlc3BTdGFycywgcmVzcFRpbWVycykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdzdWJ0b3BpYy5HRVQoKTogc3Rhcj0nICsgcmVzcFN0YXJzLmRhdGEuc3RhcnMpXG4gICAgICAgICAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3N1YnRvcGljLkdFVCgpOiB0aW1lcj0nICsgcmVzcFRpbWVycy5kYXRhLnRpbWVycylcbiAgICAgICAgICAgICAgICAgICAgcmVzLmxvY2Fscy5leGVyY2lzZXNbaW5kZXhdLnN0YXJzID0gcmVzcFN0YXJzLmRhdGEuc3RhcnNcbiAgICAgICAgICAgICAgICAgICAgcmVzLmxvY2Fscy5leGVyY2lzZXNbaW5kZXhdLnRpbWVycyA9IHJlc3BUaW1lcnMuZGF0YS50aW1lcnNcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIH0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgICAgICAgcmVzLnJlbmRlcignc3VidG9waWMnKVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmV4dCgpIC8vIDQwNFxuICAgICAgICAgIH1cbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKSAvLyA0MDRcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgaW5pdGlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIFBhdGhGb3JtYXR0ZXIuaGFzaEFzc2V0KCdhcHAnLCAnL2Fzc2V0cy9qcy9zdWJ0b3BpYy1hcHAtYnVuZGxlLmpzJykudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICB0aGlzLl9hc3NldEJ1bmRsZSA9IHJlc3VsdFxuICAgICAgICByZXNvbHZlKClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJlamVjdChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0ID0gU3VidG9waWNDb250cm9sbGVyXG4iXX0=
