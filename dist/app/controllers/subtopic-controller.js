"use strict";const Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_service_1=require("../../services/exercise-service");let path=require("path"),log=require("npmlog"),AnalyticsService=require(path.join(__dirname,"../../services/analytics-service")),AppConfig=require(path.join(__dirname,"../../app-config")),BaseController=require(path.join(__dirname,"base-controller")),Formatter=require(path.join(__dirname,"../../lib/utils/formatter")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),PassportHelper=require(path.join(__dirname,"../utils/passport-helper")),VideoService=require(path.join(__dirname,"../../services/video-service"));const TAG="SubtopicController";class SubtopicController extends BaseController{constructor(e){super(e);const s=new VideoService(this.getDb().sequelize,this.getDb().models),t=new AnalyticsService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,s,t)=>{t()}),this.routePost("/video/analytics",(e,s,r)=>{const i=e.body.key,a=e.body.videoId,o=e.user&&e.user.id||-1,c=e.body.value;t.addVideoData(i,c,a,o).then(e=>{s.json(e)}).catch(e=>{r(e)})}),this.routePost("/video/finishedWatching",(e,t,r)=>{const i=e.body.videoId,a=e.user.id;a&&s.addFinishedWatching(i,a).then(e=>{t.json(e)}).catch(e=>{r(e)})}),this.routeGet("/:topicId/:topicSlug/:subtopicId/:subtopicSlug",PassportHelper.ensureLoggedIn(),(e,t,r)=>{let i=e.params.topicId,a=e.params.subtopicId;a?Promise.join(course_service_1.default.readOne({modelName:"Subtopic",searchClause:{id:a}}),course_service_1.default.read({modelName:"Exercise",searchClause:{subtopicId:a}}),course_service_1.default.readOne({modelName:"Topic",searchClause:{id:i}}),s.getVideo(a),course_service_1.default.getPreviousAndNextSubtopic(a)).spread((s,i,a,o,c)=>{if(s.status&&a.status&&o.status){const r=s.data;t.locals.prevLink=c.status&&c.data.prev?Formatter.getSubtopicURL(c.data.prev):null,t.locals.nextLink=c.status&&c.data.next?Formatter.getSubtopicURL(c.data.next):null,t.locals.topic=a.data,t.locals.subtopic=r,t.locals.subtopicData=JSON.parse(r.data),t.locals.exercises=i.data||[],t.locals.isAuthenticated=e.isAuthenticated(),t.locals.bundle=this._assetBundle,log.verbose(TAG,"subtopic.GET(): resp4="+JSON.stringify(o));const d=`<video class="video-js vjs-fluid vjs-default-skin vjs-big-play-centered" id="video-player" data-id=${o.data.id} controls data-setup='{}'>`,l="<div class='text-center text-danger'>Video does not exist</div>";if(AppConfig.CLOUD_SERVER){const e=o.status&&o.data.remoteHostedURL;t.locals.videoSource=e?`${d}\n  <source src="${o.data.remoteHostedURL.HD}" type="video/mp4" label="HD" res="720"/>\n  <source src="${o.data.remoteHostedURL.nonHD}" type="video/mp4" label="SD" res="360"/>\n</video>`:l}else{const e=o.status&&o.data.selfHostedURL;t.locals.videoSource=e?`${d}<source src=${e}></video>`:l}return e.isAuthenticated()?Promise.map(t.locals.exercises,(s,r)=>Promise.join(exercise_service_1.default.getExerciseStars(e.user.id,s.id),exercise_service_1.default.getExerciseTimers(e.user.id,s.id),(e,s)=>{log.verbose(TAG,"subtopic.GET(): star="+e.data.stars),log.verbose(TAG,"subtopic.GET(): timer="+s.data.timers),t.locals.exercises[r].stars=e.data.stars,t.locals.exercises[r].timers=s.data.timers})).then(e=>{t.render("subtopic")}):(e.session.returnTo=e.originalUrl||e.url,t.render("subtopic"))}r()}).catch(e=>{r(e)}):r()})}initialize(){return new Promise((e,s)=>{PathFormatter.hashAsset("app","/assets/js/subtopic-app-bundle.js").then(s=>{this._assetBundle=s,e()}).catch(e=>{s(e)})})}}module.exports=SubtopicController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcHAvY29udHJvbGxlcnMvc3VidG9waWMtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsImNvdXJzZV9zZXJ2aWNlXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwiQW5hbHl0aWNzU2VydmljZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJBcHBDb25maWciLCJCYXNlQ29udHJvbGxlciIsIkZvcm1hdHRlciIsIlBhdGhGb3JtYXR0ZXIiLCJQYXNzcG9ydEhlbHBlciIsIlZpZGVvU2VydmljZSIsIlRBRyIsIlN1YnRvcGljQ29udHJvbGxlciIsIltvYmplY3QgT2JqZWN0XSIsImluaXREYXRhIiwic3VwZXIiLCJ2aWRlb1NlcnZpY2UiLCJ0aGlzIiwiZ2V0RGIiLCJzZXF1ZWxpemUiLCJtb2RlbHMiLCJhbmFseXRpY3NTZXJ2aWNlIiwiYWRkSW50ZXJjZXB0b3IiLCJyZXEiLCJyZXMiLCJuZXh0Iiwicm91dGVQb3N0Iiwia2V5IiwiYm9keSIsInZpZGVvSWQiLCJ1c2VySWQiLCJ1c2VyIiwiaWQiLCJ2YWx1ZSIsImFkZFZpZGVvRGF0YSIsInRoZW4iLCJyZXNwIiwianNvbiIsImNhdGNoIiwiZXJyIiwiYWRkRmluaXNoZWRXYXRjaGluZyIsInJvdXRlR2V0IiwiZW5zdXJlTG9nZ2VkSW4iLCJ0b3BpY0lkIiwicGFyYW1zIiwic3VidG9waWNJZCIsImRlZmF1bHQiLCJyZWFkT25lIiwibW9kZWxOYW1lIiwic2VhcmNoQ2xhdXNlIiwicmVhZCIsImdldFZpZGVvIiwiZ2V0UHJldmlvdXNBbmROZXh0U3VidG9waWMiLCJzcHJlYWQiLCJyZXNwMiIsInJlc3AzIiwicmVzcDQiLCJyZXNwNSIsInN0YXR1cyIsInN1YnRvcGljIiwiZGF0YSIsImxvY2FscyIsInByZXZMaW5rIiwicHJldiIsImdldFN1YnRvcGljVVJMIiwibmV4dExpbmsiLCJ0b3BpYyIsInN1YnRvcGljRGF0YSIsIkpTT04iLCJwYXJzZSIsImV4ZXJjaXNlcyIsImlzQXV0aGVudGljYXRlZCIsImJ1bmRsZSIsIl9hc3NldEJ1bmRsZSIsInZlcmJvc2UiLCJzdHJpbmdpZnkiLCJ2aWRlb1RhZyIsIm1pc3NpbmdWaWRlbyIsIkNMT1VEX1NFUlZFUiIsInNyYyIsInJlbW90ZUhvc3RlZFVSTCIsInZpZGVvU291cmNlIiwiSEQiLCJub25IRCIsInNlbGZIb3N0ZWRVUkwiLCJtYXAiLCJleGVyY2lzZSIsImluZGV4IiwiZ2V0RXhlcmNpc2VTdGFycyIsImdldEV4ZXJjaXNlVGltZXJzIiwicmVzcFN0YXJzIiwicmVzcFRpbWVycyIsInN0YXJzIiwidGltZXJzIiwicmVzdWx0cyIsInJlbmRlciIsInNlc3Npb24iLCJyZXR1cm5UbyIsIm9yaWdpbmFsVXJsIiwidXJsIiwicmVzb2x2ZSIsInJlamVjdCIsImhhc2hBc3NldCIsInJlc3VsdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJhQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsaUJBQUFELFFBQUEsaUNBQ0FFLG1CQUFBRixRQUFBLG1DQUVBLElBQUlHLEtBQU9ILFFBQVEsUUFDZkksSUFBTUosUUFBUSxVQUVkSyxpQkFBbUJMLFFBQVFHLEtBQUtHLEtBQUtDLFVBQVcscUNBQ2hEQyxVQUFZUixRQUFRRyxLQUFLRyxLQUFLQyxVQUFXLHFCQUN6Q0UsZUFBaUJULFFBQVFHLEtBQUtHLEtBQUtDLFVBQVcsb0JBQzlDRyxVQUFZVixRQUFRRyxLQUFLRyxLQUFLQyxVQUFXLDhCQUN6Q0ksY0FBZ0JYLFFBQVFHLEtBQUtHLEtBQUtDLFVBQVcsNkJBQzdDSyxlQUFpQlosUUFBUUcsS0FBS0csS0FBS0MsVUFBVyw2QkFDOUNNLGFBQWViLFFBQVFHLEtBQUtHLEtBQUtDLFVBQVcsaUNBRWhELE1BQU1PLElBQU0sMkJBRVpDLDJCQUFpQ04sZUFDL0JPLFlBQWFDLEdBQ1hDLE1BQU1ELEdBQ04sTUFBTUUsRUFBZSxJQUFJTixhQUFhTyxLQUFLQyxRQUFRQyxVQUFXRixLQUFLQyxRQUFR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RSxRQUFReUYsSUFBSTdELEVBQUlxQyxPQUFPUyxVQUFXLENBQUNnQixFQUFvQkMsSUFDckQzRixRQUFRTyxLQUNiSixtQkFBQStDLFFBQWdCMEMsaUJBQWlCakUsRUFBSVEsS0FBS0MsR0FBSXNELEVBQVN0RCxJQUN2RGpDLG1CQUFBK0MsUUFBZ0IyQyxrQkFBa0JsRSxFQUFJUSxLQUFLQyxHQUFJc0QsRUFBU3RELElBQ3hELENBQUMwRCxFQUFXQyxLQUNWMUYsSUFBSXlFLFFBQVEvRCxJQUFLLHdCQUEwQitFLEVBQVU5QixLQUFLZ0MsT0FDMUQzRixJQUFJeUUsUUFBUS9ELElBQUsseUJBQTJCZ0YsRUFBVy9CLEtBQUtpQyxRQUM1RHJFLEVBQUlxQyxPQUFPUyxVQUFVaUIsR0FBT0ssTUFBUUYsRUFBVTlCLEtBQUtnQyxNQUNuRHBFLEVBQUlxQyxPQUFPUyxVQUFVaUIsR0FBT00sT0FBU0YsRUFBVy9CLEtBQUtpQyxVQUd4RDFELEtBQUsyRCxJQUNOdEUsRUFBSXVFLE9BQU8sZUFmYnhFLEVBQUl5RSxRQUFRQyxTQUFXMUUsRUFBSTJFLGFBQWUzRSxFQUFJNEUsSUFDdkMzRSxFQUFJdUUsT0FBTyxhQW1CcEJ0RSxNQUVEYSxNQUFNQyxJQUNQZCxFQUFLYyxLQUdQZCxNQUtOWixhQUNFLE9BQU8sSUFBSWpCLFFBQVEsQ0FBQ3dHLEVBQVNDLEtBQzNCN0YsY0FBYzhGLFVBQVUsTUFBTyxxQ0FBcUNuRSxLQUFLb0UsSUFDdkV0RixLQUFLd0QsYUFBZThCLEVBQ3BCSCxNQUNDOUQsTUFBTUMsSUFDUDhELEVBQU85RCxRQU1maUUsT0FBQUMsUUFBUzdGIiwiZmlsZSI6ImFwcC9jb250cm9sbGVycy9zdWJ0b3BpYy1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IENvdXJzZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvY291cnNlLXNlcnZpY2UnXG5pbXBvcnQgRXhlcmNpc2VTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL2V4ZXJjaXNlLXNlcnZpY2UnXG5cbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcblxubGV0IEFuYWx5dGljc1NlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy9hbmFseXRpY3Mtc2VydmljZScpKVxubGV0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2FwcC1jb25maWcnKSlcbmxldCBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2Jhc2UtY29udHJvbGxlcicpKVxubGV0IEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi91dGlscy9mb3JtYXR0ZXInKSlcbmxldCBQYXRoRm9ybWF0dGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vbGliL3BhdGgtZm9ybWF0dGVyJykpXG5sZXQgUGFzc3BvcnRIZWxwZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi91dGlscy9wYXNzcG9ydC1oZWxwZXInKSlcbmxldCBWaWRlb1NlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy92aWRlby1zZXJ2aWNlJykpXG5cbmNvbnN0IFRBRyA9ICdTdWJ0b3BpY0NvbnRyb2xsZXInXG5cbmNsYXNzIFN1YnRvcGljQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG4gICAgY29uc3QgdmlkZW9TZXJ2aWNlID0gbmV3IFZpZGVvU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuICAgIGNvbnN0IGFuYWx5dGljc1NlcnZpY2UgPSBuZXcgQW5hbHl0aWNzU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIG5leHQoKVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3ZpZGVvL2FuYWx5dGljcycsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgLy8gRXZlbnQgdHlwZVxuICAgICAgY29uc3Qga2V5ID0gcmVxLmJvZHkua2V5XG4gICAgICBjb25zdCB2aWRlb0lkID0gcmVxLmJvZHkudmlkZW9JZFxuICAgICAgY29uc3QgdXNlcklkID0gKHJlcS51c2VyICYmIHJlcS51c2VyLmlkKSB8fCAtMVxuICAgICAgY29uc3QgdmFsdWUgPSByZXEuYm9keS52YWx1ZVxuICAgICAgYW5hbHl0aWNzU2VydmljZS5hZGRWaWRlb0RhdGEoa2V5LCB2YWx1ZSwgdmlkZW9JZCwgdXNlcklkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3ZpZGVvL2ZpbmlzaGVkV2F0Y2hpbmcnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IHZpZGVvSWQgPSByZXEuYm9keS52aWRlb0lkXG4gICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZFxuICAgICAgLy8gV2Ugb25seSB3YW50IHRvIHRyYWNrIHZpZGVvIHdhdGNoZWQgYnkgdXNlci4gRm9yIHRob3NlIHdobyBkb24ndCBsb2dpbiwgd2UgYWxyZWFkeSBoYXZlIGFuYWx5dGljcyBzZXJ2aWNlXG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHZpZGVvU2VydmljZS5hZGRGaW5pc2hlZFdhdGNoaW5nKHZpZGVvSWQsIHVzZXJJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIG5leHQoZXJyKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvOnRvcGljSWQvOnRvcGljU2x1Zy86c3VidG9waWNJZC86c3VidG9waWNTbHVnJywgUGFzc3BvcnRIZWxwZXIuZW5zdXJlTG9nZ2VkSW4oKSwgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsZXQgdG9waWNJZCA9IHJlcS5wYXJhbXMudG9waWNJZFxuICAgICAgbGV0IHN1YnRvcGljSWQgPSByZXEucGFyYW1zLnN1YnRvcGljSWRcbiAgICAgIGlmIChzdWJ0b3BpY0lkKSB7XG4gICAgICAgIFByb21pc2Uuam9pbjxhbnk+KFxuICAgICAgICAgIENvdXJzZVNlcnZpY2UucmVhZE9uZSh7IG1vZGVsTmFtZTogJ1N1YnRvcGljJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBzdWJ0b3BpY0lkIH0gfSksXG4gICAgICAgICAgQ291cnNlU2VydmljZS5yZWFkPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IHN1YnRvcGljSWQgfSB9KSxcbiAgICAgICAgICBDb3Vyc2VTZXJ2aWNlLnJlYWRPbmUoeyBtb2RlbE5hbWU6ICdUb3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogdG9waWNJZCB9IH0pLFxuICAgICAgICAgIHZpZGVvU2VydmljZS5nZXRWaWRlbyhzdWJ0b3BpY0lkKSxcbiAgICAgICAgICBDb3Vyc2VTZXJ2aWNlLmdldFByZXZpb3VzQW5kTmV4dFN1YnRvcGljKHN1YnRvcGljSWQpXG4gICAgICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPGFueT4sIHJlc3AyOiBOQ1Jlc3BvbnNlPGFueT4sXG4gICAgICAgICAgICAgICAgICByZXNwMzogTkNSZXNwb25zZTxhbnk+LCByZXNwNDogTkNSZXNwb25zZTxhbnk+LFxuICAgICAgICAgICAgICAgICAgcmVzcDU6IE5DUmVzcG9uc2U8YW55PikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwMy5zdGF0dXMgJiYgcmVzcDQuc3RhdHVzKSB7XG4gICAgICAgICAgICBjb25zdCBzdWJ0b3BpYyA9IHJlc3AuZGF0YVxuICAgICAgICAgICAgcmVzLmxvY2Fscy5wcmV2TGluayA9IHJlc3A1LnN0YXR1cyAmJiByZXNwNS5kYXRhLnByZXYgPyBGb3JtYXR0ZXIuZ2V0U3VidG9waWNVUkwocmVzcDUuZGF0YS5wcmV2KSA6IG51bGxcbiAgICAgICAgICAgIHJlcy5sb2NhbHMubmV4dExpbmsgPSByZXNwNS5zdGF0dXMgJiYgcmVzcDUuZGF0YS5uZXh0ID8gRm9ybWF0dGVyLmdldFN1YnRvcGljVVJMKHJlc3A1LmRhdGEubmV4dCkgOiBudWxsXG4gICAgICAgICAgICByZXMubG9jYWxzLnRvcGljID0gcmVzcDMuZGF0YVxuICAgICAgICAgICAgcmVzLmxvY2Fscy5zdWJ0b3BpYyA9IHN1YnRvcGljXG4gICAgICAgICAgICAvLyBJbmZvcm1hdGlvbiBhYm91dCBzdWJ0b3BpYyBpcyBzdG9yZWQgYXMgSlNPTiBpbiAnZGF0YScgY29sdW1uXG4gICAgICAgICAgICByZXMubG9jYWxzLnN1YnRvcGljRGF0YSA9IEpTT04ucGFyc2Uoc3VidG9waWMuZGF0YSlcbiAgICAgICAgICAgIHJlcy5sb2NhbHMuZXhlcmNpc2VzID0gcmVzcDIuZGF0YSB8fCBbXVxuICAgICAgICAgICAgcmVzLmxvY2Fscy5pc0F1dGhlbnRpY2F0ZWQgPSByZXEuaXNBdXRoZW50aWNhdGVkKClcbiAgICAgICAgICAgIHJlcy5sb2NhbHMuYnVuZGxlID0gdGhpcy5fYXNzZXRCdW5kbGVcbiAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3N1YnRvcGljLkdFVCgpOiByZXNwND0nICsgSlNPTi5zdHJpbmdpZnkocmVzcDQpKVxuICAgICAgICAgICAgY29uc3QgdmlkZW9UYWcgPSBgPHZpZGVvIGNsYXNzPVwidmlkZW8tanMgdmpzLWZsdWlkIHZqcy1kZWZhdWx0LXNraW4gdmpzLWJpZy1wbGF5LWNlbnRlcmVkXCIgaWQ9XCJ2aWRlby1wbGF5ZXJcIiBkYXRhLWlkPSR7cmVzcDQuZGF0YS5pZH0gY29udHJvbHMgZGF0YS1zZXR1cD0ne30nPmBcbiAgICAgICAgICAgIGNvbnN0IG1pc3NpbmdWaWRlbyA9IGA8ZGl2IGNsYXNzPSd0ZXh0LWNlbnRlciB0ZXh0LWRhbmdlcic+VmlkZW8gZG9lcyBub3QgZXhpc3Q8L2Rpdj5gXG4gICAgICAgICAgICAvLyBXaGVuIEZpbG9zIGlzIGNsb3VkLWhvc3RlZCwgd2UgdXNlIEFXUyBhcyB2aWRlbyBzb3VyY2VcbiAgICAgICAgICAgIGlmIChBcHBDb25maWcuQ0xPVURfU0VSVkVSKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHNyYyA9IHJlc3A0LnN0YXR1cyAmJiByZXNwNC5kYXRhLnJlbW90ZUhvc3RlZFVSTFxuICAgICAgICAgICAgICBpZiAoc3JjKSB7XG4gICAgICAgICAgICAgICAgcmVzLmxvY2Fscy52aWRlb1NvdXJjZSA9XG5gJHt2aWRlb1RhZ31cbiAgPHNvdXJjZSBzcmM9XCIke3Jlc3A0LmRhdGEucmVtb3RlSG9zdGVkVVJMLkhEfVwiIHR5cGU9XCJ2aWRlby9tcDRcIiBsYWJlbD1cIkhEXCIgcmVzPVwiNzIwXCIvPlxuICA8c291cmNlIHNyYz1cIiR7cmVzcDQuZGF0YS5yZW1vdGVIb3N0ZWRVUkwubm9uSER9XCIgdHlwZT1cInZpZGVvL21wNFwiIGxhYmVsPVwiU0RcIiByZXM9XCIzNjBcIi8+XG48L3ZpZGVvPmBcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXMubG9jYWxzLnZpZGVvU291cmNlID0gbWlzc2luZ1ZpZGVvXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgd2UgdXNlIGxvY2FsIGNvcHlcbiAgICAgICAgICAgICAgY29uc3Qgc3JjID0gcmVzcDQuc3RhdHVzICYmIHJlc3A0LmRhdGEuc2VsZkhvc3RlZFVSTFxuICAgICAgICAgICAgICBpZiAoc3JjKSB7XG4gICAgICAgICAgICAgICAgcmVzLmxvY2Fscy52aWRlb1NvdXJjZSA9IGAke3ZpZGVvVGFnfTxzb3VyY2Ugc3JjPSR7c3JjfT48L3ZpZGVvPmBcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXMubG9jYWxzLnZpZGVvU291cmNlID0gbWlzc2luZ1ZpZGVvXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gSWYgdXNlciBpc24ndCBsb2dnZWQgaW4sIHdlIHRlbGwgdGhlbSB0aGV5IG5lZWQgdG8gbG9naW4vcmVnaXN0ZXIgdG9cbiAgICAgICAgICAgIC8vIGFjY2VzcyBleGVyY2lzZS4gQW5kIHdoZW4gdGhleSBkbywgd2Ugd2FudCB0byByZWRpcmVjdCBoZXJlXG4gICAgICAgICAgICBpZiAoIXJlcS5pc0F1dGhlbnRpY2F0ZWQoKSkge1xuICAgICAgICAgICAgICByZXEuc2Vzc2lvbi5yZXR1cm5UbyA9IHJlcS5vcmlnaW5hbFVybCB8fCByZXEudXJsXG4gICAgICAgICAgICAgIHJldHVybiByZXMucmVuZGVyKCdzdWJ0b3BpYycpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5tYXAocmVzLmxvY2Fscy5leGVyY2lzZXMsIChleGVyY2lzZTogRXhlcmNpc2UsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2Uuam9pbjxhbnk+KFxuICAgICAgICAgICAgICAgICAgRXhlcmNpc2VTZXJ2aWNlLmdldEV4ZXJjaXNlU3RhcnMocmVxLnVzZXIuaWQsIGV4ZXJjaXNlLmlkKSxcbiAgICAgICAgICAgICAgICAgIEV4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZVRpbWVycyhyZXEudXNlci5pZCwgZXhlcmNpc2UuaWQpLFxuICAgICAgICAgICAgICAgICAgKHJlc3BTdGFycywgcmVzcFRpbWVycykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICdzdWJ0b3BpYy5HRVQoKTogc3Rhcj0nICsgcmVzcFN0YXJzLmRhdGEuc3RhcnMpXG4gICAgICAgICAgICAgICAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3N1YnRvcGljLkdFVCgpOiB0aW1lcj0nICsgcmVzcFRpbWVycy5kYXRhLnRpbWVycylcbiAgICAgICAgICAgICAgICAgICAgcmVzLmxvY2Fscy5leGVyY2lzZXNbaW5kZXhdLnN0YXJzID0gcmVzcFN0YXJzLmRhdGEuc3RhcnNcbiAgICAgICAgICAgICAgICAgICAgcmVzLmxvY2Fscy5leGVyY2lzZXNbaW5kZXhdLnRpbWVycyA9IHJlc3BUaW1lcnMuZGF0YS50aW1lcnNcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIH0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgICAgICAgcmVzLnJlbmRlcignc3VidG9waWMnKVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbmV4dCgpIC8vIDQwNFxuICAgICAgICAgIH1cbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKSAvLyA0MDRcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgaW5pdGlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIFBhdGhGb3JtYXR0ZXIuaGFzaEFzc2V0KCdhcHAnLCAnL2Fzc2V0cy9qcy9zdWJ0b3BpYy1hcHAtYnVuZGxlLmpzJykudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICB0aGlzLl9hc3NldEJ1bmRsZSA9IHJlc3VsdFxuICAgICAgICByZXNvbHZlKClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJlamVjdChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0ID0gU3VidG9waWNDb250cm9sbGVyXG4iXX0=
