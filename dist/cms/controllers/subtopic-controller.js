"use strict";const path=require("path"),Promise=require("bluebird"),course_service_1=require("../../services/course-service"),exercise_generator_1=require("../../lib/exercise_generator/exercise-generator"),log=require("npmlog"),marked=require("marked"),BaseController=require(path.join(__dirname,"base-controller")),ImageService=require(path.join(__dirname,"../../services/image-service")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),VideoService=require(path.join(__dirname,"../../services/video-service")),AppConfig=require(path.join(__dirname,"../../app-config")),TAG="SubtopicController";class SubtopicController extends BaseController{constructor(e){super(e);const s=new VideoService(this.getDb().sequelize,this.getDb().models),t=new ImageService(this.getDb().sequelize,this.getDb().models);function a(e,s,t){s.setTimeout(48e4),t()}this.addInterceptor((e,s,t)=>{log.verbose(TAG,"SubtopicController: req.path="+e.path),s.locals.site=e.site,s.locals.user=e.user,s.locals.marked=marked,t()}),this.routeGet("/subtopic/:id",(e,s,t)=>{log.verbose(TAG,"subtopic/[id]/GET");const a=e.params.id;Promise.join(course_service_1.default.read({modelName:"Subtopic",searchClause:{id:a}}),course_service_1.default.getExercises(a)).spread((e,a)=>e.status&&e.data?(s.locals.subtopic=e.data[0],s.locals.exercises=a.data||[],s.locals.subtopicData=s.locals.subtopic.data?JSON.parse(s.locals.subtopic.data):{},course_service_1.default.read({modelName:"Topic",searchClause:{id:s.locals.subtopic.topicId}}).then(e=>{e.status&&e.data?(s.locals.topic=e.data[0],s.render("subtopic")):t()})):t()).catch(e=>{t(e)})}),this.routePost("/subtopic/:id/submit",(e,s,t)=>{log.verbose(this.getTag(),"req.body="+JSON.stringify(e.body));const a=e.params.id;let r=Object.keys(e.body||{}),o=[],i=[];r.forEach(s=>{if(s.startsWith("new-exercise")&&o.push({subtopicId:a,data:e.body[s],frontendKey:s}),s.startsWith("exercise-")){const t=s.split("-")[1];i.push({subtopicId:a,id:t,data:e.body[s]})}});const c=course_service_1.default.update({modelName:"Subtopic",data:{id:a,data:JSON.stringify(e.body.subtopicData)}}),d=Promise.map(o,e=>course_service_1.default.create({modelName:"Exercise",data:e})),u=Promise.map(i,e=>course_service_1.default.update({modelName:"Exercise",data:e}));log.verbose(this.getTag(),`newExercises = ${JSON.stringify(o)}`),log.verbose(this.getTag(),`existingExercises = ${JSON.stringify(i)}`),Promise.join(c,d,u).spread((e,t,a)=>{if(e.status){let e={newExerciseIds:{}},r=!0,c=null;o.length&&(r=t.reduce((s,t,a)=>{c=!1===t.status?t.errMessage:c;const r=o[a].frontendKey;return e.newExerciseIds[r]=t.data.id,s&&t.status},r)),i.length&&(r=a.reduce((e,s)=>(c=!1===s.status?s.errMessage:c,e&&s.status),r)),s.send(Object.assign({status:r,data:e},c&&{errMessage:c}))}else s.send({status:!1,errMessage:e.errMessage})})}),this.routePost("/generateExercise",(e,s,t)=>{let a=e.body.code;try{let e=exercise_generator_1.default.getExerciseSolver(a),t=e.generateQuestions();Promise.map(t,s=>e.formatQuestion(s.knowns).then(e=>({question:e,answer:s.unknowns}))).then(e=>{s.json({status:!0,data:e})}).catch(e=>{s.json({status:!1,errMessage:e.message||e})})}catch(e){s.json({status:!1,errMessage:e.message||e})}}),this.routePost("/subtopic/:id/videoUpload",a,(e,t,a)=>{log.verbose(TAG,"videoUpload.POST(): req.path="+e.path);const r=e.params.id;VideoService.getUploadMiddleware()(e,t,o=>{o?t.json({status:!1,errMessage:o.message}):s.uploadAndSaveVideoToDB(e.file.filename,r).then(e=>{t.json(e)}).catch(e=>{a(e)})})}),this.routeGet("/subtopic/:id/video",(e,t,a)=>{const r=e.params.id;s.getVideo(r).then(e=>{t.json(e)}).catch(e=>{a(e)})}),this.routeGet("/subtopic/images",(e,s,a)=>{log.verbose(TAG,`req.path = ${e.path}`),t.getImages().then(e=>e.status?s.json({status:!0,data:e.data}):s.json({status:!1})).catch(e=>{a(e)})}),this.routePost("/subtopic/images/add",a,(e,s,a)=>{log.verbose(TAG,`req.path = ${e.path}`),ImageService.uploadImageMiddleware()(e,s,r=>{r?s.json({status:!1,errMessage:r.message}):t.uploadAndSaveImageToDB(e.file.filename).then(e=>{e.status?s.json({status:!0,data:{url:super.rootifyPath(AppConfig.IMAGE_MOUNT_PATH+e.data.filename),public_id:e.data.filename,originalName:e.data.filename,created_at:e.data.filename.split("_")[0]}}):s.json({status:!0,data:{}})}).catch(e=>{console.error(e),a(e)})})}),this.routePost("/subtopic/images/delete",(e,s,a)=>{log.verbose(TAG,`req.path = ${e.path}`),t.deleteImage(e.query.publicId).then(e=>{s.json(e)}).catch(e=>{a(e)})})}getRouter(){return this._router}}module.exports=SubtopicController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbXMvY29udHJvbGxlcnMvc3VidG9waWMtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlByb21pc2UiLCJjb3Vyc2Vfc2VydmljZV8xIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJsb2ciLCJtYXJrZWQiLCJCYXNlQ29udHJvbGxlciIsImpvaW4iLCJfX2Rpcm5hbWUiLCJJbWFnZVNlcnZpY2UiLCJQYXRoRm9ybWF0dGVyIiwiVmlkZW9TZXJ2aWNlIiwiQXBwQ29uZmlnIiwiVEFHIiwiU3VidG9waWNDb250cm9sbGVyIiwiW29iamVjdCBPYmplY3RdIiwiaW5pdERhdGEiLCJzdXBlciIsInZpZGVvU2VydmljZSIsInRoaXMiLCJnZXREYiIsInNlcXVlbGl6ZSIsIm1vZGVscyIsImltYWdlU2VydmljZSIsImV4dGVuZFRpbWVvdXQiLCJyZXEiLCJyZXMiLCJuZXh0Iiwic2V0VGltZW91dCIsImFkZEludGVyY2VwdG9yIiwidmVyYm9zZSIsImxvY2FscyIsInNpdGUiLCJ1c2VyIiwicm91dGVHZXQiLCJzdWJ0b3BpY0lkIiwicGFyYW1zIiwiaWQiLCJkZWZhdWx0IiwicmVhZCIsIm1vZGVsTmFtZSIsInNlYXJjaENsYXVzZSIsImdldEV4ZXJjaXNlcyIsInNwcmVhZCIsInNSZXNwIiwiZVJlc3AiLCJzdGF0dXMiLCJkYXRhIiwic3VidG9waWMiLCJleGVyY2lzZXMiLCJzdWJ0b3BpY0RhdGEiLCJKU09OIiwicGFyc2UiLCJ0b3BpY0lkIiwidGhlbiIsInRSZXNwIiwidG9waWMiLCJyZW5kZXIiLCJjYXRjaCIsImVyciIsInJvdXRlUG9zdCIsImdldFRhZyIsInN0cmluZ2lmeSIsImJvZHkiLCJyZXFCb2R5S2V5cyIsIk9iamVjdCIsImtleXMiLCJuZXdFeGVyY2lzZXMiLCJleGlzdGluZ0V4ZXJjaXNlcyIsImZvckVhY2giLCJrZXkiLCJzdGFydHNXaXRoIiwicHVzaCIsImZyb250ZW5kS2V5IiwiZXhlcmNpc2VJZCIsInNwbGl0IiwidXBkYXRlU3VidG9waWNQcm9taXNlIiwidXBkYXRlIiwiY3JlYXRlRXhlcmNpc2VQcm9taXNlIiwibWFwIiwibmV3RXhlcmNpc2UiLCJjcmVhdGUiLCJ1cGRhdGVFeGVyY2lzZVByb21pc2VzIiwiZXhpc3RpbmdFeGVyY2lzZSIsInJlc3AxIiwicmVzcDIiLCJyZXNwMyIsIm5ld0V4ZXJjaXNlSWRzIiwic3VjY2VzcyIsImVyck1lc3NhZ2UiLCJsZW5ndGgiLCJyZWR1Y2UiLCJhY2MiLCJyZXNwIiwiaW5kZXgiLCJzZW5kIiwiYXNzaWduIiwiY29kZSIsImV4ZXJjaXNlU29sdmVyIiwiZ2V0RXhlcmNpc2VTb2x2ZXIiLCJxdWVzdGlvbnMiLCJnZW5lcmF0ZVF1ZXN0aW9ucyIsInF1ZXN0aW9uIiwiZm9ybWF0UXVlc3Rpb24iLCJrbm93bnMiLCJmb3JtYXR0ZWRRdWVzdGlvbiIsImFuc3dlciIsInVua25vd25zIiwianNvbiIsIm1lc3NhZ2UiLCJnZXRVcGxvYWRNaWRkbGV3YXJlIiwidXBsb2FkQW5kU2F2ZVZpZGVvVG9EQiIsImZpbGUiLCJmaWxlbmFtZSIsImdldFZpZGVvIiwiZ2V0SW1hZ2VzIiwidXBsb2FkSW1hZ2VNaWRkbGV3YXJlIiwidXBsb2FkQW5kU2F2ZUltYWdlVG9EQiIsInVybCIsInJvb3RpZnlQYXRoIiwiSU1BR0VfTU9VTlRfUEFUSCIsInB1YmxpY19pZCIsIm9yaWdpbmFsTmFtZSIsImNyZWF0ZWRfYXQiLCJjb25zb2xlIiwiZXJyb3IiLCJkZWxldGVJbWFnZSIsInF1ZXJ5IiwicHVibGljSWQiLCJfcm91dGVyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6ImFBQUEsTUFBQUEsS0FBQUMsUUFBQSxRQUVBQyxRQUFBRCxRQUFBLFlBRUFFLGlCQUFBRixRQUFBLGlDQUNBRyxxQkFBQUgsUUFBQSxtREFFTUksSUFBTUosUUFBUSxVQUNkSyxPQUFTTCxRQUFRLFVBRWpCTSxlQUFpQk4sUUFBUUQsS0FBS1EsS0FBS0MsVUFBVyxvQkFDOUNDLGFBQWVU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QyxPQUVwQ3JCLEVBQUlrRixNQUFPOUQsUUFBUSxLQUUzQlksTUFBTUMsSUFDUGhDLEVBQUtnQyxPQUlUeEMsS0FBS3lDLFVBQVUsdUJBQXdCcEMsRUFBZSxDQUFDQyxFQUFLQyxFQUFLQyxLQUMvRHZCLElBQUkwQixRQUFRakIsa0JBQW1CWSxFQUFJMUIsUUFDbkNVLGFBQWEyRyx1QkFBYjNHLENBQXFDZ0IsRUFBS0MsRUFBS2lDLElBQ3pDQSxFQUNGakMsRUFBSWtGLE1BQU85RCxRQUFRLEVBQU8yQyxXQUFZOUIsRUFBSWtELFVBRTFDdEYsRUFBYThGLHVCQUF1QjVGLEVBQUl1RixLQUFLQyxVQUFVM0QsS0FBS3VDLElBQ3REQSxFQUFLL0MsT0FDUHBCLEVBQUlrRixNQUNGOUQsUUFBUSxFQUNSQyxNQUNFdUUsSUFBS3JHLE1BQU1zRyxZQUFZM0csVUFBVTRHLGlCQUFtQjNCLEVBQUs5QyxLQUFLa0UsVUFDOURRLFVBQVc1QixFQUFLOUMsS0FBS2tFLFNBQ3JCUyxhQUFjN0IsRUFBSzlDLEtBQUtrRSxTQUN4QlUsV0FBWTlCLEVBQUs5QyxLQUFLa0UsU0FBU3RDLE1BQU0sS0FBSyxNQUk5Q2pELEVBQUlrRixNQUNGOUQsUUFBUSxFQUNSQyxZQUdIVyxNQUFNQyxJQUNQaUUsUUFBUUMsTUFBTWxFLEdBQ2RoQyxFQUFLZ0MsU0FNYnhDLEtBQUt5QyxVQUFVLDBCQUEyQixDQUFDbkMsRUFBS0MsRUFBS0MsS0FDbkR2QixJQUFJMEIsUUFBUWpCLGtCQUFtQlksRUFBSTFCLFFBRW5Dd0IsRUFBYXVHLFlBQVlyRyxFQUFJc0csTUFBTUMsVUFBVTFFLEtBQUt1QyxJQUNoRG5FLEVBQUlrRixLQUFLZixLQUNSbkMsTUFBTUMsSUFDUGhDLEVBQUtnQyxPQUlYNUMsWUFDRSxPQUFPSSxLQUFLOEcsU0FJaEJDLE9BQUFDLFFBQVNySCIsImZpbGUiOiJjbXMvY29udHJvbGxlcnMvc3VidG9waWMtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcblxuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuaW1wb3J0IENvdXJzZVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvY291cnNlLXNlcnZpY2UnXG5pbXBvcnQgRXhlcmNpc2VHZW5lcmF0b3IgZnJvbSAnLi4vLi4vbGliL2V4ZXJjaXNlX2dlbmVyYXRvci9leGVyY2lzZS1nZW5lcmF0b3InXG5cbmNvbnN0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5jb25zdCBtYXJrZWQgPSByZXF1aXJlKCdtYXJrZWQnKVxuXG5jb25zdCBCYXNlQ29udHJvbGxlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2Jhc2UtY29udHJvbGxlcicpKVxuY29uc3QgSW1hZ2VTZXJ2aWNlID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vc2VydmljZXMvaW1hZ2Utc2VydmljZScpKVxuY29uc3QgUGF0aEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2xpYi9wYXRoLWZvcm1hdHRlcicpKVxuY29uc3QgVmlkZW9TZXJ2aWNlID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vc2VydmljZXMvdmlkZW8tc2VydmljZScpKVxuXG5jb25zdCBBcHBDb25maWcgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9hcHAtY29uZmlnJykpXG5cbmNvbnN0IFRBRyA9ICdTdWJ0b3BpY0NvbnRyb2xsZXInXG5cbmNsYXNzIFN1YnRvcGljQ29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG4gICAgY29uc3QgdmlkZW9TZXJ2aWNlID0gbmV3IFZpZGVvU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuICAgIGNvbnN0IGltYWdlU2VydmljZSA9IG5ldyBJbWFnZVNlcnZpY2UodGhpcy5nZXREYigpLnNlcXVlbGl6ZSwgdGhpcy5nZXREYigpLm1vZGVscylcbiAgICB0aGlzLmFkZEludGVyY2VwdG9yKChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCAnU3VidG9waWNDb250cm9sbGVyOiByZXEucGF0aD0nICsgcmVxLnBhdGgpXG4gICAgICByZXMubG9jYWxzLnNpdGUgPSByZXEuc2l0ZVxuICAgICAgcmVzLmxvY2Fscy51c2VyID0gcmVxLnVzZXJcbiAgICAgIHJlcy5sb2NhbHMubWFya2VkID0gbWFya2VkXG4gICAgICBuZXh0KClcbiAgICB9KVxuXG4gICAgLy8gUmV0cmlldmUgaW5mb3JtYXRpb24gYWJvdXQgc3VidG9waWNcbiAgICB0aGlzLnJvdXRlR2V0KCcvc3VidG9waWMvOmlkJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsICdzdWJ0b3BpYy9baWRdL0dFVCcpXG4gICAgICBjb25zdCBzdWJ0b3BpY0lkID0gcmVxLnBhcmFtcy5pZFxuICAgICAgUHJvbWlzZS5qb2luKFxuICAgICAgICBDb3Vyc2VTZXJ2aWNlLnJlYWQoeyBtb2RlbE5hbWU6ICdTdWJ0b3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogc3VidG9waWNJZCB9IH0pLFxuICAgICAgICBDb3Vyc2VTZXJ2aWNlLmdldEV4ZXJjaXNlcyhzdWJ0b3BpY0lkKVxuICAgICAgKS5zcHJlYWQoKHNSZXNwOiBOQ1Jlc3BvbnNlPFN1YnRvcGljPiwgZVJlc3A6IE5DUmVzcG9uc2U8RXhlcmNpc2VbXT4pID0+IHtcbiAgICAgICAgaWYgKHNSZXNwLnN0YXR1cyAmJiBzUmVzcC5kYXRhKSB7XG4gICAgICAgICAgcmVzLmxvY2Fscy5zdWJ0b3BpYyA9IHNSZXNwLmRhdGFbMF1cbiAgICAgICAgICByZXMubG9jYWxzLmV4ZXJjaXNlcyA9IGVSZXNwLmRhdGEgfHwgW11cbiAgICAgICAgICByZXMubG9jYWxzLnN1YnRvcGljRGF0YSA9IHJlcy5sb2NhbHMuc3VidG9waWMuZGF0YSA/IEpTT04ucGFyc2UocmVzLmxvY2Fscy5zdWJ0b3BpYy5kYXRhKSA6IHt9XG4gICAgICAgICAgcmV0dXJuIENvdXJzZVNlcnZpY2UucmVhZCh7IG1vZGVsTmFtZTogJ1RvcGljJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiByZXMubG9jYWxzLnN1YnRvcGljLnRvcGljSWQgfSB9KS50aGVuKHRSZXNwID0+IHtcbiAgICAgICAgICAgIGlmICh0UmVzcC5zdGF0dXMgJiYgdFJlc3AuZGF0YSkge1xuICAgICAgICAgICAgICByZXMubG9jYWxzLnRvcGljID0gdFJlc3AuZGF0YVswXVxuICAgICAgICAgICAgICByZXMucmVuZGVyKCdzdWJ0b3BpYycpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBuZXh0KCkgLy8gNDA0IG5vdCBmb3VuZFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG5leHQoKSAvLyA0MDQgbm90IGZvdW5kXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgLy8gV2hlbiBzdWJ0b3BpYyBpcyBzdWJtaXR0ZWQsIHRoZXJlIDMgaW5mb3JtYXRpb25zOlxuICAgIC8vIDEuIFVwZGF0ZWQgc3VidG9waWMgZGV0YWlsOiByZXEuYm9keS5zdWJ0b3BpY0RhdGFcbiAgICAvLyAyLiBOZXcgZXhlcmNpc2VzOiByZXEuYm9keS5uZXctZXhlcmNpc2UtKlxuICAgIC8vIDMuIFVwZGF0ZWQgZXhlcmNpc2VzOiByZXEuYm9keS5leGVyY2lzZS0qXG4gICAgLy8gVE9ETzogUmVmYWN0b3IgdGhpcyBzdXBlciB1Z2x5IGNvZGUhISFcbiAgICB0aGlzLnJvdXRlUG9zdCgnL3N1YnRvcGljLzppZC9zdWJtaXQnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKHRoaXMuZ2V0VGFnKCksICdyZXEuYm9keT0nICsgSlNPTi5zdHJpbmdpZnkocmVxLmJvZHkpKVxuICAgICAgY29uc3Qgc3VidG9waWNJZCA9IHJlcS5wYXJhbXMuaWRcbiAgICAgIGxldCByZXFCb2R5S2V5cyA9IE9iamVjdC5rZXlzKHJlcS5ib2R5IHx8IHt9KVxuICAgICAgbGV0IG5ld0V4ZXJjaXNlczogYW55W10gPSBbXVxuICAgICAgbGV0IGV4aXN0aW5nRXhlcmNpc2VzOiBhbnlbXSA9IFtdXG5cbiAgICAgIC8vIFByb2Nlc3MgZXhlcmNpc2VzXG4gICAgICByZXFCb2R5S2V5cy5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIC8vIE5ldyBleGVyY2lzZSBpcyBpZGVudGlmaWVkIHdpdGgga2V5IG5ldy1leGVyY2lzZS1bSURdXG4gICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnbmV3LWV4ZXJjaXNlJykpIHtcbiAgICAgICAgICAvLyBmcm9udGVuZEtleSBpcyB1c2VkIHRvIG1hcCBQT1NUJ3Mga2V5IHRvIGFjdHVhbCBxdWVzdGlvbiBrZXlcbiAgICAgICAgICBuZXdFeGVyY2lzZXMucHVzaCh7IHN1YnRvcGljSWQsIGRhdGE6IHJlcS5ib2R5W2tleV0sIGZyb250ZW5kS2V5OiBrZXkgfSlcbiAgICAgICAgfVxuICAgICAgICAvLyBFeGlzdGluZyBleGVyY2lzZSBpcyBpZGVudGlmaWVkIHdpdGgga2V5IGV4ZXJjaXNlLVtJRF1cbiAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCdleGVyY2lzZS0nKSkge1xuICAgICAgICAgIGNvbnN0IGV4ZXJjaXNlSWQgPSBrZXkuc3BsaXQoJy0nKVsxXVxuICAgICAgICAgIGV4aXN0aW5nRXhlcmNpc2VzLnB1c2goeyBzdWJ0b3BpY0lkLCBpZDogZXhlcmNpc2VJZCwgZGF0YTogcmVxLmJvZHlba2V5XSB9KVxuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICBjb25zdCB1cGRhdGVTdWJ0b3BpY1Byb21pc2UgPSBDb3Vyc2VTZXJ2aWNlLnVwZGF0ZTxTdWJ0b3BpYz4oe21vZGVsTmFtZTogJ1N1YnRvcGljJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlkOiBzdWJ0b3BpY0lkLFxuICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHJlcS5ib2R5LnN1YnRvcGljRGF0YSlcbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgY29uc3QgY3JlYXRlRXhlcmNpc2VQcm9taXNlID0gUHJvbWlzZS5tYXAobmV3RXhlcmNpc2VzLCBuZXdFeGVyY2lzZSA9PiB7XG4gICAgICAgIHJldHVybiBDb3Vyc2VTZXJ2aWNlLmNyZWF0ZSh7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgZGF0YTogbmV3RXhlcmNpc2UgfSlcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IHVwZGF0ZUV4ZXJjaXNlUHJvbWlzZXMgPSBQcm9taXNlLm1hcChleGlzdGluZ0V4ZXJjaXNlcywgZXhpc3RpbmdFeGVyY2lzZSA9PiB7XG4gICAgICAgIHJldHVybiBDb3Vyc2VTZXJ2aWNlLnVwZGF0ZSh7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgZGF0YTogZXhpc3RpbmdFeGVyY2lzZSB9KVxuICAgICAgfSlcblxuICAgICAgbG9nLnZlcmJvc2UodGhpcy5nZXRUYWcoKSwgYG5ld0V4ZXJjaXNlcyA9ICR7SlNPTi5zdHJpbmdpZnkobmV3RXhlcmNpc2VzKX1gKVxuICAgICAgbG9nLnZlcmJvc2UodGhpcy5nZXRUYWcoKSwgYGV4aXN0aW5nRXhlcmNpc2VzID0gJHtKU09OLnN0cmluZ2lmeShleGlzdGluZ0V4ZXJjaXNlcyl9YClcblxuICAgICAgLy8gUHJlLXJlcXVpc2l0ZSBvZiByZXR1cm5pbmcgJ3N0YXR1czogdHJ1ZSdcbiAgICAgIC8vIDEuIHVwZGF0ZVN1YnRvcGljUHJvbWlzZSAocmVzcDEpIGhhcyB0byBzdWNjZWVkXG4gICAgICAvLyAyLiBjcmVhdGVFeGVyY2lzZVByb21pc2UgKHJlc3AyKSBhbmQgdXBkYXRlRXhlcmNpc2VQcm9taXNlcyAocmVzcDMpIGhhcyB0byBlaXRoZXIgYmUgbnVsbCBvciBhbGwgc3VjY2VlZGVkXG4gICAgICAvL1xuICAgICAgLy8gUmV0dXJuOiB7c3RhdHVzOiB0cnVlLCBkYXRhOiB7bmV3RXhlcmNpc2VJZHM6IHtuZXctZXhlcmNpc2UtMzogNX19fVxuICAgICAgLy8gbmV3RXhlcmNpc2VJZHMgaXMgdXNlZCBieSBmcm9udGVuZCB0byBtYXAgdGVtcG9yYXJ5IGlkIHRvIHJlYWwgaWRcbiAgICAgIFByb21pc2Uuam9pbjxhbnk+KHVwZGF0ZVN1YnRvcGljUHJvbWlzZSxjcmVhdGVFeGVyY2lzZVByb21pc2UsIHVwZGF0ZUV4ZXJjaXNlUHJvbWlzZXMpXG4gICAgICAgIC5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPFN1YnRvcGljPiwgcmVzcDI6IEFycmF5PGFueT4sIHJlc3AzOiBBcnJheTxhbnk+KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3AxLnN0YXR1cykge1xuICAgICAgICAgICAgbGV0IGRhdGEgPSB7IG5ld0V4ZXJjaXNlSWRzOiB7fSB9IC8vIG5ld0V4ZXJjaXNlczoge2Zyb250ZW5kS2V5OiBleGVyY2lzZUlkfSwgdGhpcyBpcyB1c2VkIGJ5IGZyb250ZW5kIHRvIG1hcCB0ZW1wb3Jhcnkga2V5IHRvIGFjdHVhbCBrZXlcbiAgICAgICAgICAgIGxldCBzdWNjZXNzID0gdHJ1ZVxuICAgICAgICAgICAgbGV0IGVyck1lc3NhZ2UgPSBudWxsXG4gICAgICAgICAgICAvLyBJZiBuZXcgZXhlcmNpc2UocykgaXMgYWRkZWQsIGFsbCBvZiB0aGVtIGhhcyB0byBzdWNjZWVkXG4gICAgICAgICAgICBpZiAobmV3RXhlcmNpc2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICBzdWNjZXNzID0gcmVzcDIucmVkdWNlKChhY2MsIHJlc3AsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgZXJyTWVzc2FnZSA9IHJlc3Auc3RhdHVzID09PSBmYWxzZSA/IHJlc3AuZXJyTWVzc2FnZSA6IGVyck1lc3NhZ2VcbiAgICAgICAgICAgICAgICBjb25zdCBmcm9udGVuZEtleSA9IG5ld0V4ZXJjaXNlc1tpbmRleF0uZnJvbnRlbmRLZXlcbiAgICAgICAgICAgICAgICBkYXRhLm5ld0V4ZXJjaXNlSWRzW2Zyb250ZW5kS2V5XSA9IHJlc3AuZGF0YS5pZFxuICAgICAgICAgICAgICAgIHJldHVybiBhY2MgJiYgcmVzcC5zdGF0dXNcbiAgICAgICAgICAgICAgfSwgc3VjY2VzcylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIElmIGFueSBleGVyY2lzZShzKSBpcyB1cGRhdGVkLCBhbGwgb2YgdGhlbSBoYXMgdG8gc3VjY2VlZFxuICAgICAgICAgICAgaWYgKGV4aXN0aW5nRXhlcmNpc2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICBzdWNjZXNzID0gcmVzcDMucmVkdWNlKChhY2MsIHJlc3ApID0+IHtcbiAgICAgICAgICAgICAgICBlcnJNZXNzYWdlID0gcmVzcC5zdGF0dXMgPT09IGZhbHNlID8gcmVzcC5lcnJNZXNzYWdlIDogZXJyTWVzc2FnZVxuICAgICAgICAgICAgICAgIHJldHVybiBhY2MgJiYgcmVzcC5zdGF0dXNcbiAgICAgICAgICAgICAgfSwgc3VjY2VzcylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGVyck1lc3NhZ2UgaXMgb25lIG9mIHRoZSByZXR1cm5lZFxuICAgICAgICAgICAgcmVzLnNlbmQoT2JqZWN0LmFzc2lnbih7IHN0YXR1czogc3VjY2VzcywgZGF0YSB9LCBlcnJNZXNzYWdlICYmIHsgZXJyTWVzc2FnZSB9KSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogZmFsc2UsXG4gICAgICAgICAgICAgIGVyck1lc3NhZ2U6IHJlc3AxLmVyck1lc3NhZ2V9KVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy9nZW5lcmF0ZUV4ZXJjaXNlJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsZXQgY29kZSA9IHJlcS5ib2R5LmNvZGVcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKGNvZGUpXG4gICAgICAgIGxldCBxdWVzdGlvbnMgPSBleGVyY2lzZVNvbHZlci5nZW5lcmF0ZVF1ZXN0aW9ucygpXG4gICAgICAgIFByb21pc2UubWFwKHF1ZXN0aW9ucywgcXVlc3Rpb24gPT4ge1xuICAgICAgICAgIHJldHVybiBleGVyY2lzZVNvbHZlci5mb3JtYXRRdWVzdGlvbihxdWVzdGlvbi5rbm93bnMpLnRoZW4oZm9ybWF0dGVkUXVlc3Rpb24gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHsgcXVlc3Rpb246IGZvcm1hdHRlZFF1ZXN0aW9uLCBhbnN3ZXI6IHF1ZXN0aW9uLnVua25vd25zIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9KS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiB0cnVlLCBkYXRhIH0pXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgcmVzLmpzb24oeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBlcnIubWVzc2FnZSB8fCBlcnIgfSlcbiAgICAgICAgfSlcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGVyci5tZXNzYWdlIHx8IGVyciB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICAvLyBCZWNhdXNlIHVwbG9hZGluZyB2aWRlb3MgY2FuIHRha2Ugc29tZXRpbWVcbiAgICBmdW5jdGlvbiBleHRlbmRUaW1lb3V0IChyZXEsIHJlcywgbmV4dCkge1xuICAgICAgcmVzLnNldFRpbWVvdXQoNDgwMDAwKVxuICAgICAgbmV4dCgpXG4gICAgfVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy9zdWJ0b3BpYy86aWQvdmlkZW9VcGxvYWQnLCBleHRlbmRUaW1lb3V0LCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3ZpZGVvVXBsb2FkLlBPU1QoKTogcmVxLnBhdGg9JyArIHJlcS5wYXRoKVxuICAgICAgY29uc3Qgc3VidG9waWNJZCA9IHJlcS5wYXJhbXMuaWRcbiAgICAgIFZpZGVvU2VydmljZS5nZXRVcGxvYWRNaWRkbGV3YXJlKCkocmVxLCByZXMsIGVyciA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGVyci5tZXNzYWdlIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdmlkZW9TZXJ2aWNlLnVwbG9hZEFuZFNhdmVWaWRlb1RvREIocmVxLmZpbGUuZmlsZW5hbWUsIHN1YnRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvc3VidG9waWMvOmlkL3ZpZGVvJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBjb25zdCBzdWJ0b3BpY0lkID0gcmVxLnBhcmFtcy5pZFxuICAgICAgdmlkZW9TZXJ2aWNlLmdldFZpZGVvKHN1YnRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIHJlcy5qc29uKHJlc3ApXG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVHZXQoJy9zdWJ0b3BpYy9pbWFnZXMnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgYHJlcS5wYXRoID0gJHtyZXEucGF0aH1gKVxuICAgICAgaW1hZ2VTZXJ2aWNlLmdldEltYWdlcygpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgIHJldHVybiByZXMuanNvbih7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcC5kYXRhIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiBmYWxzZSB9KVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHRoaXMucm91dGVQb3N0KCcvc3VidG9waWMvaW1hZ2VzL2FkZCcsIGV4dGVuZFRpbWVvdXQsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgcmVxLnBhdGggPSAke3JlcS5wYXRofWApXG4gICAgICBJbWFnZVNlcnZpY2UudXBsb2FkSW1hZ2VNaWRkbGV3YXJlKCkocmVxLCByZXMsIGVyciA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZXMuanNvbih7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGVyci5tZXNzYWdlIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaW1hZ2VTZXJ2aWNlLnVwbG9hZEFuZFNhdmVJbWFnZVRvREIocmVxLmZpbGUuZmlsZW5hbWUpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgcmVzLmpzb24oe1xuICAgICAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICB1cmw6IHN1cGVyLnJvb3RpZnlQYXRoKEFwcENvbmZpZy5JTUFHRV9NT1VOVF9QQVRIICsgcmVzcC5kYXRhLmZpbGVuYW1lKSxcbiAgICAgICAgICAgICAgICAgIHB1YmxpY19pZDogcmVzcC5kYXRhLmZpbGVuYW1lLFxuICAgICAgICAgICAgICAgICAgb3JpZ2luYWxOYW1lOiByZXNwLmRhdGEuZmlsZW5hbWUsXG4gICAgICAgICAgICAgICAgICBjcmVhdGVkX2F0OiByZXNwLmRhdGEuZmlsZW5hbWUuc3BsaXQoJ18nKVswXVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgICAgICAgZGF0YToge31cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICAgICAgICBuZXh0KGVycilcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3N1YnRvcGljL2ltYWdlcy9kZWxldGUnLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgYHJlcS5wYXRoID0gJHtyZXEucGF0aH1gKVxuICAgICAgLy8gcHVibGljSWQgaGVyZSBtZWFucyBmaWxlbmFtZVxuICAgICAgaW1hZ2VTZXJ2aWNlLmRlbGV0ZUltYWdlKHJlcS5xdWVyeS5wdWJsaWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuICB9XG4gIGdldFJvdXRlciAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JvdXRlclxuICB9XG59XG5cbmV4cG9ydCA9IFN1YnRvcGljQ29udHJvbGxlclxuIl19
