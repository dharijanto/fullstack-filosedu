const path=require("path"),log=require("npmlog"),AppConfig=require(path.join(__dirname,"../../app-config")),BaseController=require(path.join(__dirname,"base-controller")),ImageService=require(path.join(__dirname,"../../services/image-service")),PathFormatter=require(path.join(__dirname,"../../lib/path-formatter")),SchoolService=require(path.join(__dirname,"../../services/school-service")),TAG="SchoolManagementController";class SchoolManagementController extends BaseController{constructor(e){super(e);const t=new SchoolService(this.getDb().sequelize,this.getDb().models),a=new ImageService(this.getDb().sequelize,this.getDb().models);this.addInterceptor((e,t,a)=>{log.verbose(TAG,"req.path="+e.path),a()}),this.routeGet("/schoolmanagement",(e,t,a)=>{t.render("school-management")}),this.routeGet("/school/management/get",(e,a,o)=>{t.getAll().then(e=>{a.json(e)})}),this.routePost("/school/management/add",(e,a,o)=>{t.create({modelName:"School",data:e.body}).then(e=>{a.json(e)}).catch(e=>{o(e)})}),this.routePost("/school/management/edit",(e,a,o)=>{t.update({modelName:"School",data:e.body}).then(e=>{a.json(e)}).catch(e=>{o(e)})}),this.routePost("/school/management/delete",(e,a,o)=>{t.deleteById(e.body.id).then(e=>{a.json({status:!0})}).catch(e=>{o(e)})}),this.routeGet("/school/images/get",(e,t,o)=>{log.verbose(TAG,`req.path = ${e.path}`),a.getImages().then(e=>e.status?t.json({status:!0,data:e.data}):t.json({status:!1})).catch(e=>{o(e)})}),this.routePost("/school/images/add",function(e,t,a){t.setTimeout(48e4),a()},(e,t,o)=>{log.verbose(TAG,`req.path = ${e.path}`),ImageService.uploadImageMiddleware()(e,t,s=>{s?t.json({status:!1,errMessage:s.message}):a.uploadAndSaveImageToDB(e.file.filename).then(e=>{e.status?t.json({status:!0,data:{url:AppConfig.IMAGE_MOUNT_PATH+e.data.filename,public_id:e.data.filename,originalName:e.data.filename,created_at:e.data.filename.split("_")[0]}}):t.json({status:!0,data:{}})}).catch(e=>{console.error(e),o(e)})})}),this.routePost("/school/images/delete",(e,t,o)=>{log.verbose(TAG,`req.path = ${e.path}`),a.deleteImage(e.query.publicId).then(e=>{t.json(e)}).catch(e=>{o(e)})})}}module.exports=SchoolManagementController;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbXMvY29udHJvbGxlcnMvc2Nob29sLW1hbmFnZW1lbnQtY29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImxvZyIsIkFwcENvbmZpZyIsImpvaW4iLCJfX2Rpcm5hbWUiLCJCYXNlQ29udHJvbGxlciIsIkltYWdlU2VydmljZSIsIlBhdGhGb3JtYXR0ZXIiLCJTY2hvb2xTZXJ2aWNlIiwiVEFHIiwiU2Nob29sTWFuYWdlbWVudENvbnRyb2xsZXIiLCJbb2JqZWN0IE9iamVjdF0iLCJpbml0RGF0YSIsInN1cGVyIiwic2Nob29sU2VydmljZSIsInRoaXMiLCJnZXREYiIsInNlcXVlbGl6ZSIsIm1vZGVscyIsImltYWdlU2VydmljZSIsImFkZEludGVyY2VwdG9yIiwicmVxIiwicmVzIiwibmV4dCIsInZlcmJvc2UiLCJyb3V0ZUdldCIsInJlbmRlciIsImdldEFsbCIsInRoZW4iLCJyZXNwIiwianNvbiIsInJvdXRlUG9zdCIsImNyZWF0ZSIsIm1vZGVsTmFtZSIsImRhdGEiLCJib2R5IiwiY2F0Y2giLCJlcnIiLCJ1cGRhdGUiLCJkZWxldGVCeUlkIiwiaWQiLCJzdGF0dXMiLCJnZXRJbWFnZXMiLCJzZXRUaW1lb3V0IiwidXBsb2FkSW1hZ2VNaWRkbGV3YXJlIiwiZXJyTWVzc2FnZSIsIm1lc3NhZ2UiLCJ1cGxvYWRBbmRTYXZlSW1hZ2VUb0RCIiwiZmlsZSIsImZpbGVuYW1lIiwidXJsIiwiSU1BR0VfTU9VTlRfUEFUSCIsInB1YmxpY19pZCIsIm9yaWdpbmFsTmFtZSIsImNyZWF0ZWRfYXQiLCJzcGxpdCIsImNvbnNvbGUiLCJlcnJvciIsImRlbGV0ZUltYWdlIiwicXVlcnkiLCJwdWJsaWNJZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLEtBQU9DLFFBQVEsUUFFZkMsSUFBTUQsUUFBUSxVQUVkRSxVQUFZRixRQUFRRCxLQUFLSSxLQUFLQyxVQUFXLHFCQUV6Q0MsZUFBaUJM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QyxVQUFVaEMsS0FBS0MsSUFDaERQLEVBQUlRLEtBQUtELEtBQ1JPLE1BQU1DLElBQ1BkLEVBQUtjLFFBTWJ3QixPQUFPQyxRQUFVcEQiLCJmaWxlIjoiY21zL2NvbnRyb2xsZXJzL3NjaG9vbC1tYW5hZ2VtZW50LWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmNvbnN0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5cbmNvbnN0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2FwcC1jb25maWcnKSlcblxuY29uc3QgQmFzZUNvbnRyb2xsZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdiYXNlLWNvbnRyb2xsZXInKSlcbmNvbnN0IEltYWdlU2VydmljZSA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL3NlcnZpY2VzL2ltYWdlLXNlcnZpY2UnKSlcbmNvbnN0IFBhdGhGb3JtYXR0ZXIgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9saWIvcGF0aC1mb3JtYXR0ZXInKSlcbmNvbnN0IFNjaG9vbFNlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy9zY2hvb2wtc2VydmljZScpKVxuXG5jb25zdCBUQUcgPSAnU2Nob29sTWFuYWdlbWVudENvbnRyb2xsZXInXG5jbGFzcyBTY2hvb2xNYW5hZ2VtZW50Q29udHJvbGxlciBleHRlbmRzIEJhc2VDb250cm9sbGVyIHtcbiAgY29uc3RydWN0b3IgKGluaXREYXRhKSB7XG4gICAgc3VwZXIoaW5pdERhdGEpXG4gICAgY29uc3Qgc2Nob29sU2VydmljZSA9IG5ldyBTY2hvb2xTZXJ2aWNlKHRoaXMuZ2V0RGIoKS5zZXF1ZWxpemUsIHRoaXMuZ2V0RGIoKS5tb2RlbHMpXG4gICAgY29uc3QgaW1hZ2VTZXJ2aWNlID0gbmV3IEltYWdlU2VydmljZSh0aGlzLmdldERiKCkuc2VxdWVsaXplLCB0aGlzLmdldERiKCkubW9kZWxzKVxuXG4gICAgdGhpcy5hZGRJbnRlcmNlcHRvcigocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgJ3JlcS5wYXRoPScgKyByZXEucGF0aClcbiAgICAgIG5leHQoKVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvc2Nob29sbWFuYWdlbWVudCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgcmVzLnJlbmRlcignc2Nob29sLW1hbmFnZW1lbnQnKVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlR2V0KCcvc2Nob29sL21hbmFnZW1lbnQvZ2V0JywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBzY2hvb2xTZXJ2aWNlLmdldEFsbCgpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIHJlcy5qc29uKHJlc3ApXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3NjaG9vbC9tYW5hZ2VtZW50L2FkZCcsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgc2Nob29sU2VydmljZS5jcmVhdGUoe21vZGVsTmFtZTogJ1NjaG9vbCcsIGRhdGE6IHJlcS5ib2R5fSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgcmVzLmpzb24ocmVzcClcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy9zY2hvb2wvbWFuYWdlbWVudC9lZGl0JywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBzY2hvb2xTZXJ2aWNlLnVwZGF0ZSh7bW9kZWxOYW1lOiAnU2Nob29sJywgZGF0YTogcmVxLmJvZHl9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICB0aGlzLnJvdXRlUG9zdCgnL3NjaG9vbC9tYW5hZ2VtZW50L2RlbGV0ZScsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgc2Nob29sU2VydmljZS5kZWxldGVCeUlkKHJlcS5ib2R5LmlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbih7c3RhdHVzOiB0cnVlfSlcbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIG5leHQoZXJyKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZUdldCgnL3NjaG9vbC9pbWFnZXMvZ2V0JywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICBsb2cudmVyYm9zZShUQUcsIGByZXEucGF0aCA9ICR7cmVxLnBhdGh9YClcbiAgICAgIGltYWdlU2VydmljZS5nZXRJbWFnZXMoKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe3N0YXR1czogdHJ1ZSwgZGF0YTogcmVzcC5kYXRhfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzLmpzb24oe3N0YXR1czogZmFsc2V9KVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBuZXh0KGVycilcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIC8vIEJlY2F1c2UgdXBsb2FkaW5nIGNhbiB0YWtlIHNvbWV0aW1lXG4gICAgZnVuY3Rpb24gZXh0ZW5kVGltZW91dCAocmVxLCByZXMsIG5leHQpIHtcbiAgICAgIHJlcy5zZXRUaW1lb3V0KDQ4MDAwMClcbiAgICAgIG5leHQoKVxuICAgIH1cblxuICAgIHRoaXMucm91dGVQb3N0KCcvc2Nob29sL2ltYWdlcy9hZGQnLCBleHRlbmRUaW1lb3V0LCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGxvZy52ZXJib3NlKFRBRywgYHJlcS5wYXRoID0gJHtyZXEucGF0aH1gKVxuICAgICAgSW1hZ2VTZXJ2aWNlLnVwbG9hZEltYWdlTWlkZGxld2FyZSgpKHJlcSwgcmVzLCBlcnIgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmVzLmpzb24oe3N0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGVyci5tZXNzYWdlfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbWFnZVNlcnZpY2UudXBsb2FkQW5kU2F2ZUltYWdlVG9EQihyZXEuZmlsZS5maWxlbmFtZSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgICAgICByZXMuanNvbih7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgIHVybDogQXBwQ29uZmlnLklNQUdFX01PVU5UX1BBVEggKyByZXNwLmRhdGEuZmlsZW5hbWUsXG4gICAgICAgICAgICAgICAgICBwdWJsaWNfaWQ6IHJlc3AuZGF0YS5maWxlbmFtZSxcbiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsTmFtZTogcmVzcC5kYXRhLmZpbGVuYW1lLFxuICAgICAgICAgICAgICAgICAgY3JlYXRlZF9hdDogcmVzcC5kYXRhLmZpbGVuYW1lLnNwbGl0KCdfJylbMF1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXMuanNvbih7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGRhdGE6IHt9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgbmV4dChlcnIpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgdGhpcy5yb3V0ZVBvc3QoJy9zY2hvb2wvaW1hZ2VzL2RlbGV0ZScsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgbG9nLnZlcmJvc2UoVEFHLCBgcmVxLnBhdGggPSAke3JlcS5wYXRofWApXG4gICAgICAvLyBwdWJsaWNJZCBoZXJlIG1lYW5zIGZpbGVuYW1lXG4gICAgICBpbWFnZVNlcnZpY2UuZGVsZXRlSW1hZ2UocmVxLnF1ZXJ5LnB1YmxpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICByZXMuanNvbihyZXNwKVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgbmV4dChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTY2hvb2xNYW5hZ2VtZW50Q29udHJvbGxlclxuIl19
