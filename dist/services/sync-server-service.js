const path=require("path"),zlib=require("zlib"),_=require("lodash"),axios=require("axios"),Sequelize=require("sequelize"),Promise=require("bluebird"),AppConfig=require(path.join(__dirname,"../app-config")),CRUDService=require(path.join(__dirname,"crud-service")),KEY_TO_TABLE={user:{tableName:"users",modelName:"User"},submittedGeneratedExercises:{tableName:"generatedExercises",modelName:"GeneratedExercise"},submittedGeneratedTopicExercises:{tableName:"generatedTopicExercises",modelName:"GeneratedTopicExercise"},analytics:{tableName:"analytics",modelName:"Analytics"},watchedVideos:{tableName:"watchedVideos",modelName:"WatchedVideo"}},TAG="SyncService";class SyncService extends CRUDService{findSchoolIdByIdentifier(e){return this.readOne({modelName:"School",searchClause:{identifier:e}}).then(t=>t.status?t:{status:!1,errMessage:"Unrecognized school: "+e})}_getSyncMapping(e,t,r,s,a){return this.readOne({modelName:"Synchronization",searchClause:{localId:e,schoolIdentifier:t,serverHash:r,tableName:s},trx:a})}_insertToSyncTable(e,t,r,s,a,i){return this.create({modelName:"Synchronization",data:{localId:e,cloudId:a,schoolIdentifier:t,serverHash:r,tableName:s},trx:i})}insertRow(e,t,r,s=null,a){var i=null;return i="User"===t?Object.assign({},e,{schoolId:r}):Object.assign({},e,{userId:s,onCloud:!0}),this.create({modelName:t,data:i,trx:a})}updateTable(e,t,r,s,a=null){const i=Object.assign({},e,{id:r,userId:a,onCloud:!0});return this.update({modelName:t,data:i,trx:s})}getTableName(e){if(KEY_TO_TABLE[e])return KEY_TO_TABLE[e].tableName;throw new Error("Unknown key="+e)}getModelName(e){if(KEY_TO_TABLE[e])return KEY_TO_TABLE[e].modelName;throw new Error("Unknown key="+e)}_processUser(e,t,r,s,a){return this.readOne({modelName:"User",searchClause:{username:e.username,schoolId:s}}).then(i=>{if(i.status){var n=i.data.id;return this.updateTable(e,"User",n,a).then(e=>{if(e.status)return n;throw new Error("Failed to update user table:"+e.errMessage)})}return this._getSyncMapping(e.id,t,r,"users",a).then(i=>{if(i.status){var n=i.data.cloudId;return this.updateTable(e,"User",n,a).then(e=>{if(e.status)return n;throw new Error("Failed to update user table:"+e.errMessage)})}return this.insertRow(e,"User",s,null,a).then(s=>{if(s.status)return this._insertToSyncTable(e.id,t,r,"users",s.data.id,a).then(e=>{if(e.status)return e.data.cloudId;throw new Error("Failed to insert sync table:"+e.errMessage)});throw new Error("Failed to insert to user table: "+s.errMessage)})})})}isReadyToSync(e,t){return this.readOne({modelName:"SyncHistory",searchClause:{schoolIdentifier:e},order:[["updatedAt","desc"]],trx:t}).then(r=>{if(r.status){if("Success"===r.data.status){return{status:!0,data:{lastSync:r.data.date}}}return"Syncing"===r.data.status?{status:!1,errMessage:"School is currently syncing!"}:this.readOne({modelName:"SyncHistory",searchClause:{schoolIdentifier:e,status:"Success"},order:[["updatedAt","desc"]],trx:t}).then(e=>{if(e.status){return{status:!0,data:{lastSync:e.data.date}}}return{status:!0,data:{lastSync:"2000-01-01 00:00:00"}}})}return{status:!0,data:{lastSync:"2000-01-01 00:00:00"}}})}createSyncHistory(e,t,r){return this.create({modelName:"SyncHistory",data:{schoolIdentifier:e,date:t,status:"Syncing"},trx:r})}updateSyncHistory(e,t,r){return this.update({modelName:"SyncHistory",data:{id:e,status:t?"Success":"Failed"},trx:r})}getSyncHistories(e){return this.read({modelName:"SyncHistory",searchClause:{schoolIdentifier:e},order:[["updatedAt","desc"]]}).then(e=>e.status?e:{status:!0,data:[]})}getLastSynced(e){this.readOne({modelName:"SyncHistory",searchClause:{}})}syncData(e,t,r){const s=t.school.identifier,a=t.school.serverHash;if(s&&a)return Promise.each(t.users,(t,i)=>this._processUser(t.user,s,a,e,r).then(i=>(t=_.omit(t,"user"),Promise.map(Object.keys(t),n=>{const d=this.getTableName(n),o=this.getModelName(n);return Promise.each(t[n],t=>this._getSyncMapping(t.id,s,a,d,r).then(n=>{if(n.status){var u=n.data.cloudId;return this.updateTable(t,o,u,r,i).then(e=>{if(!e.status)throw new Error(`Failed to update ${d} table: ${e.errMessage}`)})}return this.insertRow(t,o,e,i,r).then(e=>{if(e.status)return this._insertToSyncTable(t.id,s,a,d,e.data.id,r).then(e=>{if(!e.status)throw new Error(`Failed to insert sync table: ${e.errMessage}`)});throw new Error(`Failed to insert ${d} table: ${e.errMessage}`)})}))}))));throw new Error("schoolIdentifier or serverHash is not defined!")}}module.exports=SyncService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9zeW5jLXNlcnZlci1zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiemxpYiIsIl8iLCJheGlvcyIsIlNlcXVlbGl6ZSIsIlByb21pc2UiLCJBcHBDb25maWciLCJqb2luIiwiX19kaXJuYW1lIiwiQ1JVRFNlcnZpY2UiLCJLRVlfVE9fVEFCTEUiLCJ1c2VyIiwidGFibGVOYW1lIiwibW9kZWxOYW1lIiwic3VibWl0dGVkR2VuZXJhdGVkRXhlcmNpc2VzIiwic3VibWl0dGVkR2VuZXJhdGVkVG9waWNFeGVyY2lzZXMiLCJhbmFseXRpY3MiLCJ3YXRjaGVkVmlkZW9zIiwiVEFHIiwiU3luY1NlcnZpY2UiLCJbb2JqZWN0IE9iamVjdF0iLCJpZGVudGlmaWVyIiwidGhpcyIsInJlYWRPbmUiLCJzZWFyY2hDbGF1c2UiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsImVyck1lc3NhZ2UiLCJsb2NhbElkIiwic2Nob29sSWRlbnRpZmllciIsInNlcnZlckhhc2giLCJ0cngiLCJjbG91ZElkIiwiY3JlYXRlIiwiZGF0YSIsInNjaG9vbElkIiwidXNlckNsb3VkSWQiLCJtb2RpZmllZERhdGEiLCJPYmplY3QiLCJhc3NpZ24iLCJ1c2VySWQiLCJvbkNsb3VkIiwiaWQiLCJ1cGRhdGUiLCJrZXkiLCJFcnJvciIsInVzZXJuYW1lIiwidXBkYXRlVGFibGUiLCJyZXNwMyIsIl9nZXRTeW5jTWFwcGluZyIsImluc2VydFJvdyIsIl9pbnNlcnRUb1N5bmNUYWJsZSIsInJlc3A0Iiwib3JkZXIiLCJsYXN0U3luYyIsImRhdGUiLCJzeW5jVGltZSIsInN1Y2Nlc3NPckZhaWxlZCIsInJlYWQiLCJzY2hvb2wiLCJlYWNoIiwidXNlcnMiLCJpbmRleCIsIl9wcm9jZXNzVXNlciIsIm9taXQiLCJtYXAiLCJrZXlzIiwiZ2V0VGFibGVOYW1lIiwiZ2V0TW9kZWxOYW1lIiwicmVzcDIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBp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LE9BQVEsQ0FDaEIsSUFBSU0sRUFBVXFDLEVBQU1uQyxLQUFLRixRQUV6QixPQUFPWCxLQUFLMEIsWUFBWWIsRUFBTXRCLEVBQVdvQixFQUFTRCxFQUFLUyxHQUFRaEIsS0FBS3dCLElBQ2xFLElBQUlBLEVBQU10QixPQUdSLE1BQU0sSUFBSW1CLDBCQUEwQmxDLFlBQW9CcUMsRUFBTXJCLGdCQUlsRSxPQUFPTixLQUFLNkIsVUFBVWhCLEVBQU10QixFQUFXdUIsRUFBVUssRUFBUVQsR0FBS1AsS0FBS3dCLElBQ2pFLEdBQUlBLEVBQU10QixPQUNSLE9BQU9MLEtBQUs4QixtQkFDVmpCLEVBQUtRLEdBQ0xiLEVBQ0FDLEVBQ0FuQixFQUNBcUMsRUFBTWQsS0FBS1EsR0FDWFgsR0FBS1AsS0FBSzRCLElBQ1IsSUFBSUEsRUFBTTFCLE9BR1IsTUFBTSxJQUFJbUIsc0NBQXNDTyxFQUFNekIsZ0JBSTVELE1BQU0sSUFBSWtCLDBCQUEwQmxDLFlBQW9CcUMsRUFBTXJCLHdCQXZDOUUsTUFBTSxJQUFJa0IsTUFBTSxtREFvRHRCeUIsT0FBT0MsUUFBVXJEIiwiZmlsZSI6InNlcnZpY2VzL3N5bmMtc2VydmVyLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5jb25zdCB6bGliID0gcmVxdWlyZSgnemxpYicpXG5cbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxuY29uc3QgYXhpb3MgPSByZXF1aXJlKCdheGlvcycpXG5jb25zdCBTZXF1ZWxpemUgPSByZXF1aXJlKCdzZXF1ZWxpemUnKVxuY29uc3QgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJylcblxuY29uc3QgQXBwQ29uZmlnID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwLWNvbmZpZycpKVxuY29uc3QgQ1JVRFNlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICdjcnVkLXNlcnZpY2UnKSlcblxuY29uc3QgS0VZX1RPX1RBQkxFID0ge1xuICB1c2VyOiB7XG4gICAgdGFibGVOYW1lOiAndXNlcnMnLFxuICAgIG1vZGVsTmFtZTogJ1VzZXInXG4gIH0sXG4gIHN1Ym1pdHRlZEdlbmVyYXRlZEV4ZXJjaXNlczoge1xuICAgIHRhYmxlTmFtZTogJ2dlbmVyYXRlZEV4ZXJjaXNlcycsXG4gICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkRXhlcmNpc2UnXG4gIH0sXG4gIHN1Ym1pdHRlZEdlbmVyYXRlZFRvcGljRXhlcmNpc2VzOiB7XG4gICAgdGFibGVOYW1lOiAnZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMnLFxuICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZFRvcGljRXhlcmNpc2UnXG4gIH0sXG4gIGFuYWx5dGljczoge1xuICAgIHRhYmxlTmFtZTogJ2FuYWx5dGljcycsXG4gICAgbW9kZWxOYW1lOiAnQW5hbHl0aWNzJ1xuICB9LFxuICB3YXRjaGVkVmlkZW9zOiB7XG4gICAgdGFibGVOYW1lOiAnd2F0Y2hlZFZpZGVvcycsXG4gICAgbW9kZWxOYW1lOiAnV2F0Y2hlZFZpZGVvJ1xuICB9XG59XG5cbmNvbnN0IFRBRyA9ICdTeW5jU2VydmljZSdcblxuLypcbiAgRXZlcnkgYXR0ZW1wdCB0byBzeW5jIGlzIHJlcHJlc2VudGVkIGJ5IGFuIGVudHJ5IGluIHN5bmNIaXN0b3JpZXMgdGFibGUuXG4gIDEuIFdoZW4gYSBzeW5jIHN0YXJ0cywgYSBuZXcgcm93IGlzIGFkZGVkXG4gIDIuIFRoYXQgcm93IHN0YXR1cyBpcyBzZXQgdG8gU3luY2luZ1xuICAzLiBXaGVuIHRoYXQgc3luY3MgZmFpbGVkL3N1Y2Nlc3MsIGl0cyBzdGF0dXMgaXMgdXBkYXRlZCB0byBGYWlsZWQgb3IgU3VjY2Vzc1xuICA0LiAnZGF0ZScgY29sdW1uIHJlcHJlc2VudHMgdGhlIGxhc3QgZGF0ZSBvZiBkYXRhIG9uIHRoYXQgc3luY1xuXG4gIE5vdGVzOlxuICAxLiBSZW1lbWJlciB0byBzZXQgb25DbG91ZCA9IHRydWUgd2hlbiBhZGRpbmcvdXBkYXRpbmcgcm93IHNvIHRoYXRcbiAgICAgd2hlbiB0aGUgZGF0YSBpcyByZXN0b3JlZCB0byBsb2NhbCBzZXJ2ZXIsIHRoZXkgd291bGRuJ3QgYmUgc2VuZCB0byBzZXJ2ZXIuXG4qL1xuY2xhc3MgU3luY1NlcnZpY2UgZXh0ZW5kcyBDUlVEU2VydmljZSB7XG5cbiAgZmluZFNjaG9vbElkQnlJZGVudGlmaWVyIChpZGVudGlmaWVyKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZSh7XG4gICAgICBtb2RlbE5hbWU6ICdTY2hvb2wnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7XG4gICAgICAgIGlkZW50aWZpZXJcbiAgICAgIH1cbiAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge3N0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdVbnJlY29nbml6ZWQgc2Nob29sOiAnICsgaWRlbnRpZmllcn1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgX2dldFN5bmNNYXBwaW5nIChsb2NhbElkLCBzY2hvb2xJZGVudGlmaWVyLCBzZXJ2ZXJIYXNoLCB0YWJsZU5hbWUsIHRyeCkge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmUoe1xuICAgICAgbW9kZWxOYW1lOiAnU3luY2hyb25pemF0aW9uJyxcbiAgICAgIHNlYXJjaENsYXVzZToge1xuICAgICAgICBsb2NhbElkLFxuICAgICAgICBzY2hvb2xJZGVudGlmaWVyLFxuICAgICAgICBzZXJ2ZXJIYXNoLFxuICAgICAgICB0YWJsZU5hbWVcbiAgICAgIH0sIHRyeFxuICAgIH0pXG4gIH1cblxuICBfaW5zZXJ0VG9TeW5jVGFibGUgKGxvY2FsSWQsIHNjaG9vbElkZW50aWZpZXIsIHNlcnZlckhhc2gsIHRhYmxlTmFtZSwgY2xvdWRJZCwgdHJ4KSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlKHtcbiAgICAgIG1vZGVsTmFtZTogJ1N5bmNocm9uaXphdGlvbicsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGxvY2FsSWQsXG4gICAgICAgIGNsb3VkSWQsXG4gICAgICAgIHNjaG9vbElkZW50aWZpZXIsXG4gICAgICAgIHNlcnZlckhhc2gsXG4gICAgICAgIHRhYmxlTmFtZVxuICAgICAgfSxcbiAgICAgIHRyeFxuICAgIH0pXG4gIH1cblxuICBpbnNlcnRSb3cgKGRhdGEsIG1vZGVsTmFtZSwgc2Nob29sSWQsIHVzZXJDbG91ZElkID0gbnVsbCwgdHJ4KSB7XG4gICAgdmFyIG1vZGlmaWVkRGF0YSA9IG51bGxcbiAgICBpZiAobW9kZWxOYW1lID09PSAnVXNlcicpIHtcbiAgICAgIG1vZGlmaWVkRGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGEsIHtzY2hvb2xJZH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIG1vZGlmaWVkRGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGEsIHt1c2VySWQ6IHVzZXJDbG91ZElkLCBvbkNsb3VkOiB0cnVlfSlcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5jcmVhdGUoe1xuICAgICAgbW9kZWxOYW1lLFxuICAgICAgZGF0YTogbW9kaWZpZWREYXRhLFxuICAgICAgdHJ4XG4gICAgfSlcbiAgfVxuXG4gIHVwZGF0ZVRhYmxlIChkYXRhLCBtb2RlbE5hbWUsIGNsb3VkSWQsIHRyeCwgdXNlcklkID0gbnVsbCkge1xuICAgIC8vIE5vdGU6IFwib25DbG91ZDogdHJ1ZVwiIGhlcmUgaXMgdG8gb3ZlcnJpZGVzIHdoYXQncyByZWNlaXZlZCBmcm9tIGxvY2FsIHNlcnZlclxuICAgIGNvbnN0IG1vZGlmaWVkRGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGEsIHtpZDogY2xvdWRJZCwgdXNlcklkLCBvbkNsb3VkOiB0cnVlfSlcbiAgICByZXR1cm4gdGhpcy51cGRhdGUoe1xuICAgICAgbW9kZWxOYW1lLFxuICAgICAgZGF0YTogbW9kaWZpZWREYXRhLFxuICAgICAgdHJ4XG4gICAgfSlcbiAgfVxuXG4gIGdldFRhYmxlTmFtZSAoa2V5KSB7XG4gICAgaWYgKEtFWV9UT19UQUJMRVtrZXldKSB7XG4gICAgICByZXR1cm4gS0VZX1RPX1RBQkxFW2tleV0udGFibGVOYW1lXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBrZXk9JyArIGtleSlcbiAgICB9XG4gIH1cblxuICBnZXRNb2RlbE5hbWUgKGtleSkge1xuICAgIGlmIChLRVlfVE9fVEFCTEVba2V5XSkge1xuICAgICAgcmV0dXJuIEtFWV9UT19UQUJMRVtrZXldLm1vZGVsTmFtZVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24ga2V5PScgKyBrZXkpXG4gICAgfVxuICB9XG5cbiAgLypcbiAgICBJbnB1dDpcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgaWQsXG4gICAgICAgIHVzZXJuYW1lXG4gICAgICAgIHNhbHRlZFBhc3MsXG4gICAgICAgIHNhbHQsXG4gICAgICAgIC4uLlxuICAgICAgfSxcbiAgICAgIHNjaG9vbElkZW50aWZpZXI6ICdzZWtvbGFoX1NNQV8xOScsXG4gICAgICBzY2hvb2xJZDogMVxuICAqL1xuICAvLyBUT0RPOiBXaGVuIHN5bmNpbmcsIHdlIHNob3VsZG4ndCBzZWFyY2ggYmFzZWQgb24gdXNlck5hbWUgYW5kIHNjaG9vbElkLCBidXQgaW5zdGVhZCB3ZSBzaG91bGRcbiAgLy8gdXNlIHN5bmNUYWJsZS4gVGhlIHJlYXNvbiBpcyBiZWNhdXNlIGN1cnJlbnQgbWV0aG9kIHdvdWxkbid0IGFjY29tbW9kYXRlIHVzZXJuYW1lIGJlaW5nIGNoYW5nZWQuXG4gIC8vIGkuZSBpZiBhZGVubnloIGlzIHVwZGF0ZWQgdG8gZGVubnloLCB0aGVuIHRoZSBzb21lIGRhdGEgaXMgbG9zdCBkdXJpbmcgc3luY2luZy4uLlxuICBfcHJvY2Vzc1VzZXIgKGRhdGEsIHNjaG9vbElkZW50aWZpZXIsIHNlcnZlckhhc2gsIHNjaG9vbElkLCB0cngpIHtcbiAgICBjb25zdCB0YWJsZU5hbWUgPSAndXNlcnMnXG4gICAgY29uc3QgbW9kZWxOYW1lID0gJ1VzZXInXG5cbiAgICAvLyBDaGVjayBpZiB0aGUgdXNlciBpcyBhbHJlYWR5IGluIGRhdGFiYXNlXG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZSh7bW9kZWxOYW1lOiAnVXNlcicsIHNlYXJjaENsYXVzZToge3VzZXJuYW1lOiBkYXRhLnVzZXJuYW1lLCBzY2hvb2xJZH19KS50aGVuKHJlc3AgPT4ge1xuICAgICAgLy8gVXNlciBhbHJlYWR5IGV4aXN0ZWQgaW4gdGhlIGRhdGFiYXNlLCB3ZSBqdXN0IG5lZWQgdG8gdXBkYXRlIGl0XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgdmFyIGNsb3VkSWQgPSByZXNwLmRhdGEuaWRcbiAgICAgICAgLy8gaWYgZXhpc3RzXG4gICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVRhYmxlKGRhdGEsIG1vZGVsTmFtZSwgY2xvdWRJZCwgdHJ4KS50aGVuKHJlc3AzID0+IHtcbiAgICAgICAgICBpZiAocmVzcDMuc3RhdHVzKSB7XG4gICAgICAgICAgICByZXR1cm4gY2xvdWRJZFxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byB1cGRhdGUgdXNlciB0YWJsZTonICsgcmVzcDMuZXJyTWVzc2FnZSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0U3luY01hcHBpbmcoZGF0YS5pZCwgc2Nob29sSWRlbnRpZmllciwgc2VydmVySGFzaCwgdGFibGVOYW1lLCB0cngpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgdGhpcyBpZiBzdGF0ZW1lbnQ/IFdlIHNob3VsZG4ndCBiZWNhdXNlIGlmIHRoZXJlJ3Mgbm8gdXNlciB3aXRoIHVzZXJuYW1lIGFuZCBzY2hvb2xJZCxcbiAgICAgICAgICAvLyB3ZSdyZSBzdXBwb3NlZCB0byBjcmVhdGUgYSBuZXcgb25lXG4gICAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICB2YXIgY2xvdWRJZCA9IHJlc3AuZGF0YS5jbG91ZElkXG4gICAgICAgICAgICAvLyBpZiBleGlzdHNcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVRhYmxlKGRhdGEsIG1vZGVsTmFtZSwgY2xvdWRJZCwgdHJ4KS50aGVuKHJlc3AzID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3AzLnN0YXR1cykge1xuICAgICAgICAgICAgICAgIHJldHVybiBjbG91ZElkXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gdXBkYXRlIHVzZXIgdGFibGU6JyArIHJlc3AzLmVyck1lc3NhZ2UpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciB1c2VyQ2xvdWRJZCA9IG51bGxcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zZXJ0Um93KGRhdGEsIG1vZGVsTmFtZSwgc2Nob29sSWQsIHVzZXJDbG91ZElkLCB0cngpLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzcDMuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luc2VydFRvU3luY1RhYmxlKGRhdGEuaWQsIHNjaG9vbElkZW50aWZpZXIsIHNlcnZlckhhc2gsIHRhYmxlTmFtZSwgcmVzcDMuZGF0YS5pZCwgdHJ4KS50aGVuKHJlc3A0ID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmIChyZXNwNC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3A0LmRhdGEuY2xvdWRJZFxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gaW5zZXJ0IHN5bmMgdGFibGU6JyArIHJlc3A0LmVyck1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBpbnNlcnQgdG8gdXNlciB0YWJsZTogJyArIHJlc3AzLmVyck1lc3NhZ2UpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBpc1JlYWR5VG9TeW5jIChzY2hvb2xJZGVudGlmaWVyLCB0cngpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lKHttb2RlbE5hbWU6ICdTeW5jSGlzdG9yeScsIHNlYXJjaENsYXVzZToge3NjaG9vbElkZW50aWZpZXJ9LCBvcmRlcjogW1sndXBkYXRlZEF0JywgJ2Rlc2MnXV0sIHRyeH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgLy8gU3luYyBpc24ndCBpbiBwcm9ncmVzcywgd2UgY2FuIHN5bmMuXG4gICAgICAgIGlmIChyZXNwLmRhdGEuc3RhdHVzID09PSAnU3VjY2VzcycpIHtcbiAgICAgICAgICAvLyBXZSB3YW50IGNsaWVudCB0byBvbmx5IHNlbmRcbiAgICAgICAgICBjb25zdCBsYXN0U3luYyA9IHJlc3AuZGF0YS5kYXRlXG4gICAgICAgICAgcmV0dXJuIHtzdGF0dXM6IHRydWUsIGRhdGE6IHtsYXN0U3luY319XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcC5kYXRhLnN0YXR1cyA9PT0gJ1N5bmNpbmcnKSB7XG4gICAgICAgICAgLy8gVGhpcyBtZWFucyB3ZSBoYXZlIG5ldmVyIHN5bmNlZCBiZWZvcmUsXG4gICAgICAgICAgcmV0dXJuIHtzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnU2Nob29sIGlzIGN1cnJlbnRseSBzeW5jaW5nISd9XG4gICAgICAgIH0gZWxzZSB7IC8vIEZhaWxlZFxuICAgICAgICAgIHJldHVybiB0aGlzLnJlYWRPbmUoe21vZGVsTmFtZTogJ1N5bmNIaXN0b3J5Jywgc2VhcmNoQ2xhdXNlOiB7c2Nob29sSWRlbnRpZmllciwgc3RhdHVzOiAnU3VjY2Vzcyd9LCBvcmRlcjogW1sndXBkYXRlZEF0JywgJ2Rlc2MnXV0sIHRyeH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgY29uc3QgbGFzdFN5bmMgPSByZXNwLmRhdGEuZGF0ZVxuICAgICAgICAgICAgICByZXR1cm4ge3N0YXR1czogdHJ1ZSwgZGF0YToge2xhc3RTeW5jfX1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiB7c3RhdHVzOiB0cnVlLCBkYXRhOiB7bGFzdFN5bmM6ICcyMDAwLTAxLTAxIDAwOjAwOjAwJ319XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVGhlIHNjaG9vbCBoYXMgbmV2ZXIgc3luY2VkLCBnb29kIHRvIGdvIVxuICAgICAgICByZXR1cm4ge3N0YXR1czogdHJ1ZSwgZGF0YToge2xhc3RTeW5jOiAnMjAwMC0wMS0wMSAwMDowMDowMCd9fVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBjcmVhdGVTeW5jSGlzdG9yeSAoc2Nob29sSWRlbnRpZmllciwgc3luY1RpbWUsIHRyeCkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZSh7bW9kZWxOYW1lOiAnU3luY0hpc3RvcnknLCBkYXRhOiB7c2Nob29sSWRlbnRpZmllciwgZGF0ZTogc3luY1RpbWUsIHN0YXR1czogJ1N5bmNpbmcnfSwgdHJ4fSlcbiAgfVxuXG4gIHVwZGF0ZVN5bmNIaXN0b3J5IChpZCwgc3VjY2Vzc09yRmFpbGVkLCB0cngpIHtcbiAgICByZXR1cm4gdGhpcy51cGRhdGUoe21vZGVsTmFtZTogJ1N5bmNIaXN0b3J5JywgZGF0YToge2lkLCBzdGF0dXM6IHN1Y2Nlc3NPckZhaWxlZCA/ICdTdWNjZXNzJyA6ICdGYWlsZWQnfSwgdHJ4fSlcbiAgfVxuXG4gIGdldFN5bmNIaXN0b3JpZXMgKHNjaG9vbElkZW50aWZpZXIpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkKHttb2RlbE5hbWU6ICdTeW5jSGlzdG9yeScsIHNlYXJjaENsYXVzZToge3NjaG9vbElkZW50aWZpZXJ9LCBvcmRlcjogW1sndXBkYXRlZEF0JywgJ2Rlc2MnXV19KS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge3N0YXR1czogdHJ1ZSwgZGF0YTogW119XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldExhc3RTeW5jZWQgKHNjaG9vbElkZW50aWZpZXIpIHtcbiAgICB0aGlzLnJlYWRPbmUoe21vZGVsTmFtZTogJ1N5bmNIaXN0b3J5Jywgc2VhcmNoQ2xhdXNlOiB7fX0pXG4gIH1cblxuICAvLyBLZWVwaW5nIHRyYWNrIG9mIHN0YXR1cyBoZXJlIGlzIHByZXR0eSB0b3VnaCwgc28gdG8gZWFzZSB0aGluZ3Mgb3V0LCB3ZSdsbFxuICAvLyBqdXN0IHRocm93IEVycm9yIGlmIHNvbWV0aGluZyBmYWlsc1xuICBzeW5jRGF0YSAoc2Nob29sSWQsIGRhdGEsIHRyeCkge1xuICAgIGNvbnN0IHNjaG9vbElkZW50aWZpZXIgPSBkYXRhLnNjaG9vbC5pZGVudGlmaWVyXG4gICAgY29uc3Qgc2VydmVySGFzaCA9IGRhdGEuc2Nob29sLnNlcnZlckhhc2hcblxuICAgIGlmICghc2Nob29sSWRlbnRpZmllciB8fCAhc2VydmVySGFzaCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzY2hvb2xJZGVudGlmaWVyIG9yIHNlcnZlckhhc2ggaXMgbm90IGRlZmluZWQhJylcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UuZWFjaChkYXRhLnVzZXJzLCAoZGF0YSwgaW5kZXgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2Nlc3NVc2VyKGRhdGFbJ3VzZXInXSwgc2Nob29sSWRlbnRpZmllciwgc2VydmVySGFzaCwgc2Nob29sSWQsIHRyeCkudGhlbih1c2VySWQgPT4ge1xuICAgICAgICAgIC8vIFRoaXMgaXMgd2hlcmUgd2UgdHJ5aW5nIHRvIHJlbW92ZSBkYXRhIHRoYXQgY29udGFpbiBvYmplY3QgdXNlci5cbiAgICAgICAgICAvLyBSZW1lbWJlciB0aGF0IHdlIHByb2Nlc3MgZGF0YSBzb3J0ZWQgYnkgdXNlciBmaXJzdFxuICAgICAgICAgIGRhdGEgPSBfLm9taXQoZGF0YSwgJ3VzZXInKVxuICAgICAgICAgIHJldHVybiBQcm9taXNlLm1hcChPYmplY3Qua2V5cyhkYXRhKSwga2V5ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRhYmxlTmFtZSA9IHRoaXMuZ2V0VGFibGVOYW1lKGtleSlcbiAgICAgICAgICAgIGNvbnN0IG1vZGVsTmFtZSA9IHRoaXMuZ2V0TW9kZWxOYW1lKGtleSlcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmVhY2goZGF0YVtrZXldLCBkYXRhID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFN5bmNNYXBwaW5nKGRhdGEuaWQsIHNjaG9vbElkZW50aWZpZXIsIHNlcnZlckhhc2gsIHRhYmxlTmFtZSwgdHJ4KS50aGVuKHJlc3AyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICB2YXIgY2xvdWRJZCA9IHJlc3AyLmRhdGEuY2xvdWRJZFxuICAgICAgICAgICAgICAgICAgLy8gaWYgZXhpc3RzXG4gICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVUYWJsZShkYXRhLCBtb2RlbE5hbWUsIGNsb3VkSWQsIHRyeCwgdXNlcklkKS50aGVuKHJlc3AzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3AzLnN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHVwZGF0ZSAke3RhYmxlTmFtZX0gdGFibGU6ICR7cmVzcDMuZXJyTWVzc2FnZX1gKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnNlcnRSb3coZGF0YSwgbW9kZWxOYW1lLCBzY2hvb2xJZCwgdXNlcklkLCB0cngpLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcDMuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luc2VydFRvU3luY1RhYmxlKFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjaG9vbElkZW50aWZpZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJIYXNoLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcDMuZGF0YS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeCkudGhlbihyZXNwNCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwNC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBpbnNlcnQgc3luYyB0YWJsZTogJHtyZXNwNC5lcnJNZXNzYWdlfWApXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gaW5zZXJ0ICR7dGFibGVOYW1lfSB0YWJsZTogJHtyZXNwMy5lcnJNZXNzYWdlfWApXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTeW5jU2VydmljZVxuIl19
