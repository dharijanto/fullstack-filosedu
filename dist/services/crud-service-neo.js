"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const sequelize_service_1=require("./sequelize-service");let _=require("lodash"),log=require("npmlog");const TAG="CRUDService";class CRUDService{getModels(e){return sequelize_service_1.default.getInstance().models[e]}getSequelize(){return sequelize_service_1.default.getInstance().sequelize}rawReadQuery(e){return this.getSequelize().query(e,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}rawReadOneQuery(e){return this.rawReadQuery(e).then(e=>e.status?e.data.length?e:{status:!1,errMessage:"Data not found!"}:e)}create({modelName:e,data:r,trx:t}){if(log.verbose(TAG,`create(): modelName=${e} data=${JSON.stringify(r)}`),!(r=_.omit(r,"id")))throw new Error("Data has to be specified!");return this.getModels(e).create(r,{transaction:t}).then(e=>({status:!0,data:e.get({plain:!0})})).catch(e=>{if("SequelizeUniqueConstraintError"===e.name)return{status:!1,errMessage:"Unique Constraint Error"};if("SequelizeForeignKeyConstraintError"===e.name)return{status:!1,errMessage:"Foreign Key Constraint Error!"};throw e})}read({modelName:e,searchClause:r,order:t=[],include:a,limit:s,trx:i}){if(!r)throw new Error("searchClause has to be specified!");return log.verbose(TAG,`read(): modelName=${e} searchClause=${JSON.stringify(r)}`),this.getModels(e).findAll({where:r,order:t,include:a,limit:s,transaction:i}).then(e=>e.length>0?{status:!0,data:e.map(e=>e.get({plain:!0}))}:{status:!1,errMessage:"Data not found"})}readOne({modelName:e,searchClause:r,order:t,include:a,trx:s}){return this.read({modelName:e,searchClause:r,order:t,include:a,trx:s}).then(e=>e.status&&e.data?{status:!0,data:e.data[0]}:{status:!1,errMessage:e.errMessage})}update({modelName:e,data:r,trx:t}){if(log.verbose(TAG,`update(): modelName=${e} data=${JSON.stringify(r)}`),r.id)return this.getModels(e).update(r,{where:{id:r.id},transaction:t}).spread(e=>({status:!0})).catch(e=>{if("SequelizeUniqueConstraintError"===e.name)return{status:!1,errMessage:"Unique Constraint Error"};if("SequelizeForeignKeyConstraintError"===e.name)return{status:!1,errMessage:"Foreign Key Constraint Error!"};throw e});throw new Error("Data needs to have id!")}delete({modelName:e,data:r}){if(log.verbose(TAG,`delete(): modelName=${e} data=${JSON.stringify(r)}`),r.id)return this.getModels(e).destroy({where:{id:r.id}}).then(e=>e>0?{status:!0}:{status:!1,errMessage:"Data Not Found!"}).catch(e=>{if("SequelizeUniqueConstraintError"===e.name)return{status:!1,errMessage:"Unique Constraint Error"};if("SequelizeForeignKeyConstraintError"===e.name)return{status:!1,errMessage:"Foreign Key Constraint Error!"};throw e});throw new Error("Data needs to have id!")}}exports.default=CRUDService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9jcnVkLXNlcnZpY2UtbmVvLnRzIl0sIm5hbWVzIjpbInNlcXVlbGl6ZV9zZXJ2aWNlXzEiLCJyZXF1aXJlIiwiXyIsImxvZyIsIlRBRyIsIkNSVURTZXJ2aWNlIiwiW29iamVjdCBPYmplY3RdIiwibmFtZSIsImRlZmF1bHQiLCJnZXRJbnN0YW5jZSIsIm1vZGVscyIsInNlcXVlbGl6ZSIsInF1ZXJ5IiwidGhpcyIsImdldFNlcXVlbGl6ZSIsInR5cGUiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwidGhlbiIsInJlc3VsdCIsInN0YXR1cyIsImRhdGEiLCJyYXdSZWFkUXVlcnkiLCJyZXNwIiwibGVuZ3RoIiwiZXJyTWVzc2FnZSIsIm1vZGVsTmFtZSIsInRyeCIsInZlcmJvc2UiLCJKU09OIiwic3RyaW5naWZ5Iiwib21pdCIsIkVycm9yIiwiZ2V0TW9kZWxzIiwiY3JlYXRlIiwidHJhbnNhY3Rpb24iLCJjcmVhdGVkRGF0YSIsImdldCIsInBsYWluIiwiY2F0Y2giLCJlcnIiLCJzZWFyY2hDbGF1c2UiLCJvcmRlciIsImluY2x1ZGUiLCJsaW1pdCIsImZpbmRBbGwiLCJ3aGVyZSIsInJlYWREYXRhIiwibWFwIiwicmVhZCIsImlkIiwidXBkYXRlIiwic3ByZWFkIiwiY291bnQiLCJkZXN0cm95IiwibnVtRGVsZXRlZCIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFFQSxNQUFBQSxvQkFBQUMsUUFBQSx1QkFFQSxJQUFJQyxFQUFJRCxRQUFRLFVBQ1pFLElBQU1GLFFBQVEsVUFFbEIsTUFBTUcsSUFBTSxvQkFFWkMsWUFDWUMsVUFBV0MsR0FDbkIsT0FBT1Asb0JBQUFRLFFBQWlCQyxjQUFjQyxPQUFPSCxHQUdyQ0QsZUFDUixPQUFPTixvQkFBQVEsUUFBaUJDLGNBQWNFLFVBR3hDTCxhQUFjTSxHQUNaLE9BQU9DLEtBQUtDLGVBQWVGLE1BQU1BLEdBQVNHLEtBQU1GLEtBQUtDLGVBQWVFLFdBQVdDLFNBQVVDLEtBQUtDLEtB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TixPQUFTYSxRQUFRLEVBQU9LLFdBQVksMkJBQy9CLEdBQWlCLHVDQUFiZSxFQUFJakMsS0FDYixPQUFTYSxRQUFRLEVBQU9LLFdBQVksaUNBRXBDLE1BQU1lLElBSVYsTUFBTSxJQUFJUixNQUFNLDJCQWxJdEJ3QixRQUFBaEQsUUFBQUgiLCJmaWxlIjoic2VydmljZXMvY3J1ZC1zZXJ2aWNlLW5lby5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgeyBTZXF1ZWxpemUsIE1vZGVscywgTW9kZWwsIFRyYW5zYWN0aW9uLCBJbnN0YW5jZSwgSW5jbHVkZU9wdGlvbnMsIFdoZXJlT3B0aW9ucyB9IGZyb20gJ3NlcXVlbGl6ZSdcbmltcG9ydCBTZXF1ZWxpemVTZXJ2aWNlIGZyb20gJy4vc2VxdWVsaXplLXNlcnZpY2UnXG5cbmxldCBfID0gcmVxdWlyZSgnbG9kYXNoJylcbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxuXG5jb25zdCBUQUcgPSAnQ1JVRFNlcnZpY2UnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENSVURTZXJ2aWNlIHtcbiAgcHJvdGVjdGVkIGdldE1vZGVscyAobmFtZSkge1xuICAgIHJldHVybiBTZXF1ZWxpemVTZXJ2aWNlLmdldEluc3RhbmNlKCkubW9kZWxzW25hbWVdXG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0U2VxdWVsaXplICgpIHtcbiAgICByZXR1cm4gU2VxdWVsaXplU2VydmljZS5nZXRJbnN0YW5jZSgpLnNlcXVlbGl6ZVxuICB9XG5cbiAgcmF3UmVhZFF1ZXJ5IChxdWVyeSk6IFByb21pc2U8TkNSZXNwb25zZTxhbnk+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnksIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3VsdCB9XG4gICAgfSlcbiAgfVxuXG4gIHJhd1JlYWRPbmVRdWVyeSAocXVlcnkpIHtcbiAgICByZXR1cm4gdGhpcy5yYXdSZWFkUXVlcnkocXVlcnkpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgaWYgKCFyZXNwLmRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0RhdGEgbm90IGZvdW5kIScgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXNwXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGNyZWF0ZSA8VCBleHRlbmRzIEJhc2VNb2RlbD4gKHsgbW9kZWxOYW1lLCBkYXRhLCB0cnggfTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBtb2RlbE5hbWU6IHN0cmluZywgZGF0YTogUGFydGlhbDxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cng/OiBUcmFuc2FjdGlvbiB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFQ+PiB7XG4gICAgbG9nLnZlcmJvc2UoVEFHLCBgY3JlYXRlKCk6IG1vZGVsTmFtZT0ke21vZGVsTmFtZX0gZGF0YT0ke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApXG4gICAgZGF0YSA9IF8ub21pdChkYXRhLCAnaWQnKSAvLyBXZSB3YW50IHRvIGFsbG93IGVhc3kgZHVwbGljYXRpb24sIHNvIHdlIGFzc3VtZSB0aGF0IGFkZGluZyBkYXRhIHdpdGggdGhlIHNhbWUgaWQgbWVhbnMgY3JlYXRpbmcgYSBkdXBsaWNhdGVcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YSBoYXMgdG8gYmUgc3BlY2lmaWVkIScpXG4gICAgfVxuICAgIHJldHVybiAodGhpcy5nZXRNb2RlbHMobW9kZWxOYW1lKSBhcyBNb2RlbDxJbnN0YW5jZTxUPiwgUGFydGlhbDxUPj4pLmNyZWF0ZShkYXRhLCB7IHRyYW5zYWN0aW9uOiB0cnggfSkudGhlbihjcmVhdGVkRGF0YSA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGNyZWF0ZWREYXRhLmdldCh7IHBsYWluOiB0cnVlIH0pIH1cbiAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgaWYgKGVyci5uYW1lID09PSAnU2VxdWVsaXplVW5pcXVlQ29uc3RyYWludEVycm9yJykge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnVW5pcXVlIENvbnN0cmFpbnQgRXJyb3InIH1cbiAgICAgIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVGb3JlaWduS2V5Q29uc3RyYWludEVycm9yJykge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRm9yZWlnbiBLZXkgQ29uc3RyYWludCBFcnJvciEnIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVyclxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBJZiB0aGVyZSdzIGRhdGEgdG8gYmUgcmVhZDpcbiAgLy8ge3N0YXR1czogdHJ1ZSwgZGF0YTogW119XG4gIC8vXG4gIC8vIElmIHRoZXJlJ3Mgbm8gZGF0YTpcbiAgLy8ge3N0YXR1czogZmFsc2UsIGVyckNvZGU6IC4uLiwgZXJyTWVzc2FnZTogLi4uLCBlcnJEYXRhfVxuICByZWFkPFQgZXh0ZW5kcyBCYXNlTW9kZWw+ICh7IG1vZGVsTmFtZSwgc2VhcmNoQ2xhdXNlLCBvcmRlciA9IFtdLCBpbmNsdWRlLCBsaW1pdCwgdHJ4IH06XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbW9kZWxOYW1lOiBzdHJpbmcsIHNlYXJjaENsYXVzZTogV2hlcmVPcHRpb25zPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyPzogQXJyYXk8QXJyYXk8c3RyaW5nPj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZT86IEFycmF5PE1vZGVsPGFueSwgYW55PiB8IEluY2x1ZGVPcHRpb25zPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbWl0PzogbnVtYmVyLCB0cng/OiBUcmFuc2FjdGlvbiB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFRbXT4+IHtcbiAgICBpZiAoIXNlYXJjaENsYXVzZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzZWFyY2hDbGF1c2UgaGFzIHRvIGJlIHNwZWNpZmllZCEnKVxuICAgIH1cbiAgICBsb2cudmVyYm9zZShUQUcsIGByZWFkKCk6IG1vZGVsTmFtZT0ke21vZGVsTmFtZX0gc2VhcmNoQ2xhdXNlPSR7SlNPTi5zdHJpbmdpZnkoc2VhcmNoQ2xhdXNlKX1gKVxuICAgIHJldHVybiB0aGlzLmdldE1vZGVscyhtb2RlbE5hbWUpLmZpbmRBbGwoeyB3aGVyZTogc2VhcmNoQ2xhdXNlLCBvcmRlciwgaW5jbHVkZSwgbGltaXQsIHRyYW5zYWN0aW9uOiB0cnggfSkudGhlbihyZWFkRGF0YSA9PiB7XG4gICAgICBpZiAocmVhZERhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlYWREYXRhLm1hcChkYXRhID0+IGRhdGEuZ2V0KHsgcGxhaW46IHRydWUgfSkpIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdEYXRhIG5vdCBmb3VuZCcgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICByZWFkT25lIDxUIGV4dGVuZHMgQmFzZU1vZGVsPiAoeyBtb2RlbE5hbWUsIHNlYXJjaENsYXVzZSwgb3JkZXIsIGluY2x1ZGUsIHRyeCB9OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBtb2RlbE5hbWU6IHN0cmluZywgc2VhcmNoQ2xhdXNlOiBXaGVyZU9wdGlvbnM8VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyPzogQXJyYXk8QXJyYXk8c3RyaW5nPj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGU/OiBBcnJheTxNb2RlbDxhbnksIGFueT4gfCBJbmNsdWRlT3B0aW9ucz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbWl0PzogbnVtYmVyLCB0cng/OiBUcmFuc2FjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk6IFByb21pc2U8TkNSZXNwb25zZTxUPj4ge1xuICAgIGNvbnN0IG9wdHMgPSB7IG1vZGVsTmFtZSwgc2VhcmNoQ2xhdXNlLCBvcmRlciB9XG4gICAgcmV0dXJuIHRoaXMucmVhZCh7IG1vZGVsTmFtZSwgc2VhcmNoQ2xhdXNlLCBvcmRlciwgaW5jbHVkZSwgdHJ4IH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcC5kYXRhWzBdIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHVwZGF0ZSA8VCBleHRlbmRzIEJhc2VNb2RlbD4gKHsgbW9kZWxOYW1lLCBkYXRhLCB0cnggfTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBtb2RlbE5hbWU6IHN0cmluZywgZGF0YTogUGFydGlhbDxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cng/OiBUcmFuc2FjdGlvbiB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICBsb2cudmVyYm9zZShUQUcsIGB1cGRhdGUoKTogbW9kZWxOYW1lPSR7bW9kZWxOYW1lfSBkYXRhPSR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YClcbiAgICBpZiAoZGF0YS5pZCkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKG1vZGVsTmFtZSkudXBkYXRlKGRhdGEsIHsgd2hlcmU6IHsgaWQ6IGRhdGEuaWQgfSwgdHJhbnNhY3Rpb246IHRyeCB9KS5zcHJlYWQoKGNvdW50KSA9PiB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVVbmlxdWVDb25zdHJhaW50RXJyb3InKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ1VuaXF1ZSBDb25zdHJhaW50IEVycm9yJyB9XG4gICAgICAgIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVGb3JlaWduS2V5Q29uc3RyYWludEVycm9yJykge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdGb3JlaWduIEtleSBDb25zdHJhaW50IEVycm9yIScgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGVyclxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGEgbmVlZHMgdG8gaGF2ZSBpZCEnKVxuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZSA8VCBleHRlbmRzIEJhc2VNb2RlbD4gKHsgbW9kZWxOYW1lLCBkYXRhIH06XG4gICAgICAgICAgeyBtb2RlbE5hbWU6IHN0cmluZywgZGF0YTogUGFydGlhbDxUPn0pOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIGxvZy52ZXJib3NlKFRBRywgYGRlbGV0ZSgpOiBtb2RlbE5hbWU9JHttb2RlbE5hbWV9IGRhdGE9JHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKVxuICAgIGlmIChkYXRhLmlkKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRNb2RlbHMobW9kZWxOYW1lKS5kZXN0cm95KHsgd2hlcmU6IHsgaWQ6IGRhdGEuaWQgfSB9KS50aGVuKG51bURlbGV0ZWQgPT4ge1xuICAgICAgICBpZiAobnVtRGVsZXRlZCA+IDApIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdEYXRhIE5vdCBGb3VuZCEnIH1cbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgaWYgKGVyci5uYW1lID09PSAnU2VxdWVsaXplVW5pcXVlQ29uc3RyYWludEVycm9yJykge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdVbmlxdWUgQ29uc3RyYWludCBFcnJvcicgfVxuICAgICAgICB9IGVsc2UgaWYgKGVyci5uYW1lID09PSAnU2VxdWVsaXplRm9yZWlnbktleUNvbnN0cmFpbnRFcnJvcicpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRm9yZWlnbiBLZXkgQ29uc3RyYWludCBFcnJvciEnIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBlcnJcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhIG5lZWRzIHRvIGhhdmUgaWQhJylcbiAgICB9XG4gIH1cbn1cbiJdfQ==
