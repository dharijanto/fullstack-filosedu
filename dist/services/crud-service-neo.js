"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const sequelize_service_1=require("./sequelize-service");let _=require("lodash"),log=require("npmlog");const TAG="CRUDService";class CRUDService{getModels(e){return sequelize_service_1.default.getInstance().models[e]}getSequelize(){return sequelize_service_1.default.getInstance().sequelize}rawReadQuery(e,r=!1){return this.getSequelize().query(e,{type:this.getSequelize().QueryTypes.SELECT,nest:r}).then(e=>({status:!0,data:e}))}rawReadOneQuery(e,r=!1){return this.rawReadQuery(e,r).then(e=>e.status&&e.data?e.data.length?e:{status:!1,errMessage:"Data not found!"}:e)}create({modelName:e,data:r,trx:t}){if(log.verbose(TAG,`create(): modelName=${e} data=${JSON.stringify(r)}`),!(r=_.omit(r,"id")))throw new Error("Data has to be specified!");return this.getModels(e).create(r,{transaction:t}).then(e=>({status:!0,data:e.get({plain:!0})})).catch(e=>{if("SequelizeUniqueConstraintError"===e.name)return{status:!1,errMessage:"Unique Constraint Error"};if("SequelizeForeignKeyConstraintError"===e.name)return{status:!1,errMessage:"Foreign Key Constraint Error!"};throw e})}read({modelName:e,searchClause:r,order:t=[],include:a,limit:s,trx:i}){if(!r)throw new Error("searchClause has to be specified!");return log.verbose(TAG,`read(): modelName=${e} searchClause=${JSON.stringify(r)}`),this.getModels(e).findAll({where:r,order:t,include:a,limit:s,transaction:i}).then(e=>e.length>0?{status:!0,data:e.map(e=>e.get({plain:!0}))}:{status:!1,errMessage:"Data not found"})}readOne({modelName:e,searchClause:r,order:t,include:a,trx:s}){return this.read({modelName:e,searchClause:r,order:t,include:a,trx:s}).then(e=>e.status&&e.data?{status:!0,data:e.data[0]}:{status:!1,errMessage:e.errMessage})}update({modelName:e,data:r,trx:t}){if(log.verbose(TAG,`update(): modelName=${e} data=${JSON.stringify(r)}`),r.id)return this.getModels(e).update(r,{where:{id:r.id},transaction:t}).spread(e=>({status:!0})).catch(e=>{if("SequelizeUniqueConstraintError"===e.name)return{status:!1,errMessage:"Unique Constraint Error"};if("SequelizeForeignKeyConstraintError"===e.name)return{status:!1,errMessage:"Foreign Key Constraint Error!"};throw e});throw new Error("Data needs to have id!")}delete({modelName:e,data:r}){if(log.verbose(TAG,`delete(): modelName=${e} data=${JSON.stringify(r)}`),r.id)return this.getModels(e).destroy({where:{id:r.id}}).then(e=>e>0?{status:!0}:{status:!1,errMessage:"Data Not Found!"}).catch(e=>{if("SequelizeUniqueConstraintError"===e.name)return{status:!1,errMessage:"Unique Constraint Error"};if("SequelizeForeignKeyConstraintError"===e.name)return{status:!1,errMessage:"Foreign Key Constraint Error!"};throw e});throw new Error("Data needs to have id!")}}exports.default=CRUDService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9jcnVkLXNlcnZpY2UtbmVvLnRzIl0sIm5hbWVzIjpbInNlcXVlbGl6ZV9zZXJ2aWNlXzEiLCJyZXF1aXJlIiwiXyIsImxvZyIsIlRBRyIsIkNSVURTZXJ2aWNlIiwiW29iamVjdCBPYmplY3RdIiwibmFtZSIsImRlZmF1bHQiLCJnZXRJbnN0YW5jZSIsIm1vZGVscyIsInNlcXVlbGl6ZSIsInF1ZXJ5IiwibmVzdCIsInRoaXMiLCJnZXRTZXF1ZWxpemUiLCJ0eXBlIiwiUXVlcnlUeXBlcyIsIlNFTEVDVCIsInRoZW4iLCJyZXN1bHQiLCJzdGF0dXMiLCJkYXRhIiwicmF3UmVhZFF1ZXJ5IiwicmVzcCIsImxlbmd0aCIsImVyck1lc3NhZ2UiLCJtb2RlbE5hbWUiLCJ0cngiLCJ2ZXJib3NlIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9taXQiLCJFcnJvciIsImdldE1vZGVscyIsImNyZWF0ZSIsInRyYW5zYWN0aW9uIiwiY3JlYXRlZERhdGEiLCJnZXQiLCJwbGFpbiIsImNhdGNoIiwiZXJyIiwic2VhcmNoQ2xhdXNlIiwib3JkZXIiLCJpbmNsdWRlIiwibGltaXQiLCJmaW5kQWxsIiwid2hlcmUiLCJyZWFkRGF0YSIsIm1hcCIsInJlYWQiLCJpZCIsInVwZGF0ZSIsInNwcmVhZCIsImNvdW50IiwiZGVzdHJveSIsIm51bURlbGV0ZWQiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBRUEsTUFBQUEsb0JBQUFDLFFBQUEsdUJBRUEsSUFBSUMsRUFBSUQsUUFBUSxVQUNaRSxJQUFNRixRQUFRLFVBRWxCLE1BQU1HLElBQU0sb0JBRVpDLFlBQ1lDLFVBQVdDLEdBQ25CLE9BQU9QLG9CQUFBUSxRQUFpQkMsY0FBY0MsT0FBT0gsR0FHckNELGVBQ1IsT0FBT04sb0JBQUFRLFFBQWlCQyxjQUFjRSxVQUd4Q0wsYUFBY00sRUFBT0MsR0FBTyxHQUMxQixPQUFPQyxLQUFLQyxlQUFlSCxNQUFNQSxHQUFTSSxLQUFNRixLQUFLQyxlQUFlRSxXQUFXQyxPQUFRTCxLQUFBQSxJQUFRTSxLQUFLQyxLQUN6RkMsUUFBUSxFQUFNQyxLQUFNRixLQUlqQ2QsZ0JBQWlCTSxFQUFPQyxHQUFPLEdBQzdCLE9BQU9DLEtBQUtTLGFBQWFYLEVBQU9DLEdBQU1NLEtBQUtLLEdBQ3JDQSxFQUFLSCxRQUFVRyxFQUFLRixLQUNqQkUsRUFBS0YsS0FBS0csT0FHTkQsR0FGRUgsUUFBUSxFQUFPSyxXQUFZLG1CQUsvQkYsR0FLYmxCLFFBQThCcUIsVUFBRUEsRUFBU0wsS0FBRUEsRUFBSU0sSUFBRUEsSUFLL0MsR0FGQXpCLElBQUkwQixRQUFRekIsMkJBQTRCdUIsVUFBa0JHLEtBQUtDLFVBQVVULFFBQ3pFQSxFQUFPcEIsRUFBRThCLEtBQUtWLEVBQU0sT0FFbEIsTUFBTSxJQUFJVyxNQUFNLDZCQUVsQixPQUFRbkIsS0FBS29CLFVBQVVQLEdBQThDUSxPQUFPYixHQUFRYyxZQUFhUixJQUFPVCxLQUFLa0IsS0FDbEdoQixRQUFRLEVBQU1DLEtBQU1lLEVBQVlDLEtBQU1DLE9BQU8sT0FDckRDLE1BQU1DLElBQ1AsR0FBaUIsbUNBQWJBLEVBQUlsQyxLQUNOLE9BQVNjLFFBQVEsRUFBT0ssV0FBWSwyQkFDL0IsR0FBaUIsdUNBQWJlLEVBQUlsQyxLQUNiLE9BQVNjLFFBQVEsRUFBT0ssV0FBWSxpQ0FFcEMsTUFBTWUsSUFVWm5DLE1BQTJCcUIsVUFBRUEsRUFBU2UsYUFBRUEsRUFBWUMsTUFBRUEsS0FBVUMsUUFBRUEsRUFBT0MsTUFBRUEsRUFBS2pCLElBQUVBLElBS2hGLElBQUtjLEVBQ0gsTUFBTSxJQUFJVCxNQUFNLHFDQUdsQixPQURBOUIsSUFBSTBCLFFBQVF6Qix5QkFBMEJ1QixrQkFBMEJHLEtBQUtDLFVBQVVXLE1BQ3hFNUIsS0FBS29CLFVBQVVQLEdBQVdtQixTQUFVQyxNQUFPTCxFQUFjQyxNQUFBQSxFQUFPQyxRQUFBQSxFQUFTQyxNQUFBQSxFQUFPVCxZQUFhUixJQUFPVCxLQUFLNkIsR0FDMUdBLEVBQVN2QixPQUFTLEdBQ1hKLFFBQVEsRUFBTUMsS0FBTTBCLEVBQVNDLElBQUkzQixHQUFRQSxFQUFLZ0IsS0FBTUMsT0FBTyxPQUUzRGxCLFFBQVEsRUFBT0ssV0FBWSxtQkFLMUNwQixTQUErQnFCLFVBQUVBLEVBQVNlLGFBQUVBLEVBQVlDLE1BQUVBLEVBQUtDLFFBQUVBLEVBQU9oQixJQUFFQSxJQU94RSxPQUFPZCxLQUFLb0MsTUFBT3ZCLFVBQUFBLEVBQVdlLGFBQUFBLEVBQWNDLE1BQUFBLEVBQU9DLFFBQUFBLEVBQVNoQixJQUFBQSxJQUFPVCxLQUFLSyxHQUNsRUEsRUFBS0gsUUFBVUcsRUFBS0YsTUFDYkQsUUFBUSxFQUFNQyxLQUFNRSxFQUFLRixLQUFLLEtBRTlCRCxRQUFRLEVBQU9LLFdBQVlGLEVBQUtFLGFBTS9DcEIsUUFBOEJxQixVQUFFQSxFQUFTTCxLQUFFQSxFQUFJTSxJQUFFQSxJQUkvQyxHQURBekIsSUFBSTBCLFFBQVF6QiwyQkFBNEJ1QixVQUFrQkcsS0FBS0MsVUFBVVQsTUFDckVBLEVBQUs2QixHQUNQLE9BQU9yQyxLQUFLb0IsVUFBVVAsR0FBV3lCLE9BQU85QixHQUFReUIsT0FBU0ksR0FBSTdCLEVBQUs2QixJQUFNZixZQUFhUixJQUFPeUIsT0FBUUMsS0FDekZqQyxRQUFRLEtBQ2hCbUIsTUFBTUMsSUFDUCxHQUFpQixtQ0FBYkEsRUFBSWxDLEtBQ04sT0FBU2MsUUFBUSxFQUFPSyxXQUFZLDJCQUMvQixHQUFpQix1Q0FBYmUsRUFBSWxDLEtBQ2IsT0FBU2MsUUFBUSxFQUFPSyxXQUFZLGlDQUVwQyxNQUFNZSxJQUlWLE1BQU0sSUFBSVIsTUFBTSwwQkFJcEIzQixRQUE4QnFCLFVBQUVBLEVBQVNMLEtBQUVBLElBR3pDLEdBREFuQixJQUFJMEIsUUFBUXpCLDJCQUE0QnVCLFVBQWtCRyxLQUFLQyxVQUFVVCxNQUNyRUEsRUFBSzZCLEdBQ1AsT0FBT3JDLEtBQUtvQixVQUFVUCxHQUFXNEIsU0FBVVIsT0FBU0ksR0FBSTdCLEVBQUs2QixNQUFRaEMsS0FBS3FDLEdBQ3BFQSxFQUFhLEdBQ05uQyxRQUFRLElBRVJBLFFBQVEsRUFBT0ssV0FBWSxvQkFFckNjLE1BQU1DLElBQ1AsR0FBaUIsbUNBQWJBLEVBQUlsQyxLQUNOLE9BQVNjLFFBQVEsRUFBT0ssV0FBWSwyQkFDL0IsR0FBaUIsdUNBQWJlLEVBQUlsQyxLQUNiLE9BQVNjLFFBQVEsRUFBT0ssV0FBWSxpQ0FFcEMsTUFBTWUsSUFJVixNQUFNLElBQUlSLE1BQU0sMkJBbkl0QndCLFFBQUFqRCxRQUFBSCIsImZpbGUiOiJzZXJ2aWNlcy9jcnVkLXNlcnZpY2UtbmVvLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCB7IFNlcXVlbGl6ZSwgTW9kZWxzLCBNb2RlbCwgVHJhbnNhY3Rpb24sIEluc3RhbmNlLCBJbmNsdWRlT3B0aW9ucywgV2hlcmVPcHRpb25zIH0gZnJvbSAnc2VxdWVsaXplJ1xuaW1wb3J0IFNlcXVlbGl6ZVNlcnZpY2UgZnJvbSAnLi9zZXF1ZWxpemUtc2VydmljZSdcblxubGV0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxubGV0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5cbmNvbnN0IFRBRyA9ICdDUlVEU2VydmljZSdcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ1JVRFNlcnZpY2Uge1xuICBwcm90ZWN0ZWQgZ2V0TW9kZWxzIChuYW1lKSB7XG4gICAgcmV0dXJuIFNlcXVlbGl6ZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5tb2RlbHNbbmFtZV1cbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRTZXF1ZWxpemUgKCkge1xuICAgIHJldHVybiBTZXF1ZWxpemVTZXJ2aWNlLmdldEluc3RhbmNlKCkuc2VxdWVsaXplXG4gIH1cblxuICByYXdSZWFkUXVlcnkgKHF1ZXJ5LCBuZXN0ID0gZmFsc2UpOiBQcm9taXNlPE5DUmVzcG9uc2U8YW55W10+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnksIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCwgbmVzdCB9KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3VsdCB9XG4gICAgfSlcbiAgfVxuXG4gIHJhd1JlYWRPbmVRdWVyeSAocXVlcnksIG5lc3QgPSBmYWxzZSkge1xuICAgIHJldHVybiB0aGlzLnJhd1JlYWRRdWVyeShxdWVyeSwgbmVzdCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgaWYgKCFyZXNwLmRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0RhdGEgbm90IGZvdW5kIScgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXNwXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGNyZWF0ZSA8VCBleHRlbmRzIEJhc2VNb2RlbD4gKHsgbW9kZWxOYW1lLCBkYXRhLCB0cnggfTpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBtb2RlbE5hbWU6IHN0cmluZywgZGF0YTogUGFydGlhbDxUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cng/OiBUcmFuc2FjdGlvbiB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFQ+PiB7XG4gICAgbG9nLnZlcmJvc2UoVEFHLCBgY3JlYXRlKCk6IG1vZGVsTmFtZT0ke21vZGVsTmFtZX0gZGF0YT0ke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApXG4gICAgZGF0YSA9IF8ub21pdChkYXRhLCAnaWQnKSAvLyBXZSB3YW50IHRvIGFsbG93IGVhc3kgZHVwbGljYXRpb24sIHNvIHdlIGFzc3VtZSB0aGF0IGFkZGluZyBkYXRhIHdpdGggdGhlIHNhbWUgaWQgbWVhbnMgY3JlYXRpbmcgYSBkdXBsaWNhdGVcbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YSBoYXMgdG8gYmUgc3BlY2lmaWVkIScpXG4gICAgfVxuICAgIHJldHVybiAodGhpcy5nZXRNb2RlbHMobW9kZWxOYW1lKSBhcyBNb2RlbDxJbnN0YW5jZTxUPiwgUGFydGlhbDxUPj4pLmNyZWF0ZShkYXRhLCB7IHRyYW5zYWN0aW9uOiB0cnggfSkudGhlbihjcmVhdGVkRGF0YSA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGNyZWF0ZWREYXRhLmdldCh7IHBsYWluOiB0cnVlIH0pIH1cbiAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgaWYgKGVyci5uYW1lID09PSAnU2VxdWVsaXplVW5pcXVlQ29uc3RyYWludEVycm9yJykge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnVW5pcXVlIENvbnN0cmFpbnQgRXJyb3InIH1cbiAgICAgIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVGb3JlaWduS2V5Q29uc3RyYWludEVycm9yJykge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRm9yZWlnbiBLZXkgQ29uc3RyYWludCBFcnJvciEnIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVyclxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBJZiB0aGVyZSdzIGRhdGEgdG8gYmUgcmVhZDpcbiAgLy8ge3N0YXR1czogdHJ1ZSwgZGF0YTogW119XG4gIC8vXG4gIC8vIElmIHRoZXJlJ3Mgbm8gZGF0YTpcbiAgLy8ge3N0YXR1czogZmFsc2UsIGVyckNvZGU6IC4uLiwgZXJyTWVzc2FnZTogLi4uLCBlcnJEYXRhfVxuICByZWFkPFQgZXh0ZW5kcyBCYXNlTW9kZWw+ICh7IG1vZGVsTmFtZSwgc2VhcmNoQ2xhdXNlLCBvcmRlciA9IFtdLCBpbmNsdWRlLCBsaW1pdCwgdHJ4IH06XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbW9kZWxOYW1lOiBzdHJpbmcsIHNlYXJjaENsYXVzZTogV2hlcmVPcHRpb25zPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyPzogQXJyYXk8QXJyYXk8c3RyaW5nPj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jbHVkZT86IEFycmF5PE1vZGVsPGFueSwgYW55PiB8IEluY2x1ZGVPcHRpb25zPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbWl0PzogbnVtYmVyLCB0cng/OiBUcmFuc2FjdGlvbiB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFRbXT4+IHtcbiAgICBpZiAoIXNlYXJjaENsYXVzZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzZWFyY2hDbGF1c2UgaGFzIHRvIGJlIHNwZWNpZmllZCEnKVxuICAgIH1cbiAgICBsb2cudmVyYm9zZShUQUcsIGByZWFkKCk6IG1vZGVsTmFtZT0ke21vZGVsTmFtZX0gc2VhcmNoQ2xhdXNlPSR7SlNPTi5zdHJpbmdpZnkoc2VhcmNoQ2xhdXNlKX1gKVxuICAgIHJldHVybiB0aGlzLmdldE1vZGVscyhtb2RlbE5hbWUpLmZpbmRBbGwoeyB3aGVyZTogc2VhcmNoQ2xhdXNlLCBvcmRlciwgaW5jbHVkZSwgbGltaXQsIHRyYW5zYWN0aW9uOiB0cnggfSkudGhlbihyZWFkRGF0YSA9PiB7XG4gICAgICBpZiAocmVhZERhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlYWREYXRhLm1hcChkYXRhID0+IGRhdGEuZ2V0KHsgcGxhaW46IHRydWUgfSkpIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdEYXRhIG5vdCBmb3VuZCcgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICByZWFkT25lIDxUIGV4dGVuZHMgQmFzZU1vZGVsPiAoeyBtb2RlbE5hbWUsIHNlYXJjaENsYXVzZSwgb3JkZXIsIGluY2x1ZGUsIHRyeCB9OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBtb2RlbE5hbWU6IHN0cmluZywgc2VhcmNoQ2xhdXNlOiBXaGVyZU9wdGlvbnM8VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyPzogQXJyYXk8QXJyYXk8c3RyaW5nPj4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluY2x1ZGU/OiBBcnJheTxNb2RlbDxhbnksIGFueT4gfCBJbmNsdWRlT3B0aW9ucz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeD86IFRyYW5zYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFQ+PiB7XG4gICAgY29uc3Qgb3B0cyA9IHsgbW9kZWxOYW1lLCBzZWFyY2hDbGF1c2UsIG9yZGVyIH1cbiAgICByZXR1cm4gdGhpcy5yZWFkKHsgbW9kZWxOYW1lLCBzZWFyY2hDbGF1c2UsIG9yZGVyLCBpbmNsdWRlLCB0cnggfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwLmRhdGFbMF0gfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gVE9ETzogV2Ugc2hvdWxkIG9ubHkgcmV0dXJuIHRydWUgaWYgYXQgbGVhc3Qgb25lIHJvdyBpcyB1cGRhdGVkIChpLmUuIGNoZWNrIHRoZSBjb3VudClcbiAgdXBkYXRlIDxUIGV4dGVuZHMgQmFzZU1vZGVsPiAoeyBtb2RlbE5hbWUsIGRhdGEsIHRyeCB9OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IG1vZGVsTmFtZTogc3RyaW5nLCBkYXRhOiBQYXJ0aWFsPFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeD86IFRyYW5zYWN0aW9uIH0pOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIGxvZy52ZXJib3NlKFRBRywgYHVwZGF0ZSgpOiBtb2RlbE5hbWU9JHttb2RlbE5hbWV9IGRhdGE9JHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKVxuICAgIGlmIChkYXRhLmlkKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRNb2RlbHMobW9kZWxOYW1lKS51cGRhdGUoZGF0YSwgeyB3aGVyZTogeyBpZDogZGF0YS5pZCB9LCB0cmFuc2FjdGlvbjogdHJ4IH0pLnNwcmVhZCgoY291bnQpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGlmIChlcnIubmFtZSA9PT0gJ1NlcXVlbGl6ZVVuaXF1ZUNvbnN0cmFpbnRFcnJvcicpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnVW5pcXVlIENvbnN0cmFpbnQgRXJyb3InIH1cbiAgICAgICAgfSBlbHNlIGlmIChlcnIubmFtZSA9PT0gJ1NlcXVlbGl6ZUZvcmVpZ25LZXlDb25zdHJhaW50RXJyb3InKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0ZvcmVpZ24gS2V5IENvbnN0cmFpbnQgRXJyb3IhJyB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgZXJyXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YSBuZWVkcyB0byBoYXZlIGlkIScpXG4gICAgfVxuICB9XG5cbiAgZGVsZXRlIDxUIGV4dGVuZHMgQmFzZU1vZGVsPiAoeyBtb2RlbE5hbWUsIGRhdGEgfTpcbiAgICAgICAgICB7IG1vZGVsTmFtZTogc3RyaW5nLCBkYXRhOiBQYXJ0aWFsPFQ+fSk6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgbG9nLnZlcmJvc2UoVEFHLCBgZGVsZXRlKCk6IG1vZGVsTmFtZT0ke21vZGVsTmFtZX0gZGF0YT0ke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApXG4gICAgaWYgKGRhdGEuaWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldE1vZGVscyhtb2RlbE5hbWUpLmRlc3Ryb3koeyB3aGVyZTogeyBpZDogZGF0YS5pZCB9IH0pLnRoZW4obnVtRGVsZXRlZCA9PiB7XG4gICAgICAgIGlmIChudW1EZWxldGVkID4gMCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0RhdGEgTm90IEZvdW5kIScgfVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVVbmlxdWVDb25zdHJhaW50RXJyb3InKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ1VuaXF1ZSBDb25zdHJhaW50IEVycm9yJyB9XG4gICAgICAgIH0gZWxzZSBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVGb3JlaWduS2V5Q29uc3RyYWludEVycm9yJykge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdGb3JlaWduIEtleSBDb25zdHJhaW50IEVycm9yIScgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IGVyclxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGEgbmVlZHMgdG8gaGF2ZSBpZCEnKVxuICAgIH1cbiAgfVxufVxuIl19
