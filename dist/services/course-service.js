"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),path=require("path"),crud_service_neo_1=require("./crud-service-neo"),Formatter=require(path.join(__dirname,"../lib/utils/formatter"));let log=require("npmlog"),Sequelize=require("sequelize");const TAG="CourseService";class CourseService extends crud_service_neo_1.default{getTopicDetails(e=-1){return super.rawReadQuery(`\nSELECT\n  topics.id AS \`topics.id\`, topics.topicNo AS \`topics.topicNo\`, topics.topic AS \`topics.topic\`,\n  IFNULL(starBadge.\`count\`, 0) AS \`topics.starBadge\`,\n  IFNULL(timeBadge.\`count\`, 0) AS \`topics.timeBadge\`,\n  subtopicsView.id AS \`topics.subtopics.id\`, subtopicsView.subtopicNo AS \`topics.subtopics.subtopicNo\`,\n  subtopicsView.subtopic AS \`topics.subtopics.subtopic\`,\n  IFNULL(subtopicsView.starBadge, 0) AS \`topics.subtopics.starBadge\`,\n  IFNULL(subtopicsView.timeBadge, 0) AS \`topics.subtopics.timeBadge\`,\n  IFNULL(subtopicsView.watchBadge, 0) AS \`topics.subtopics.watchBadge\`\nFROM topics\nLEFT OUTER JOIN (\n  SELECT COUNT(*) AS count, topicId\n  FROM generatedTopicExercises\n  WHERE userId = ${e} AND submitted = 1 AND score >= 80\n  GROUP BY topicId\n) AS starBadge ON starBadge.topicId = topics.id\nLEFT OUTER JOIN (\n  SELECT COUNT(*) AS count, topicId\n  FROM generatedTopicExercises\n  WHERE submitted = 1 AND userId = ${e} AND timeFinish < idealTime AND score = 100\n  GROUP BY topicId\n) AS timeBadge ON timeBadge.topicId = topics.id\nINNER JOIN (\n  SELECT\n    subtopics.id AS id, subtopics.topicId AS topicId, subtopics.subtopic AS subtopic, subtopics.subtopicNo AS subtopicNo,\n    (starBadge.\`count\` / exercisesView.count) AS starBadge,\n    (timeBadge.\`count\` / exercisesView.count) AS timeBadge,\n    watchBadge.\`count\` AS watchBadge\n  FROM subtopics\n  LEFT OUTER JOIN (\n    SELECT\n      exercises.subtopicId AS subtopicId,\n      COUNT(*) AS count,\n      COUNT(distinct exercises.id) AS test\n    FROM generatedExercises\n    INNER JOIN exercises ON exercises.id = generatedExercises.exerciseId\n        AND generatedExercises.submitted = 1 AND generatedExercises.score >= 80\n        AND generatedExercises.userId = ${e}\n    GROUP BY exercises.subtopicId, generatedExercises.userId\n  ) AS starBadge ON starBadge.subtopicId = subtopics.id\n  LEFT OUTER JOIN (\n    SELECT\n      exercises.subtopicId AS subtopicId,\n      COUNT(*) AS count\n    FROM generatedExercises\n    INNER JOIN exercises ON exercises.id = generatedExercises.exerciseId\n        AND generatedExercises.submitted = 1 AND generatedExercises.score = 100 AND timeFinish < idealTime\n        AND generatedExercises.userId = ${e}\n    GROUP BY exercises.subtopicId, generatedExercises.userId\n  ) AS timeBadge ON timeBadge.subtopicId = subtopics.id\n  LEFT OUTER JOIN (\n    SELECT videos.subtopicId AS subtopicId, 1 AS count\n    FROM videos\n    INNER JOIN watchedVideos on watchedVideos.videoId = videos.id AND watchedVideos.userId = ${e}\n    LIMIT 1\n  ) AS watchBadge ON watchBadge.subtopicId = subtopics.id\n  LEFT OUTER JOIN (\n    SELECT subtopicId, COUNT(id) AS count\n    FROM exercises\n    GROUP BY subtopicId\n  ) AS exercisesView ON exercisesView.subtopicId = subtopics.id\n) AS subtopicsView ON subtopicsView.topicId = topics.id\nORDER BY topicNo, subtopicNo ASC\n`).then(e=>e.status?{status:!0,data:Formatter.objectify(e.data)[0]}:{status:!1,errMessage:e.errMessage})}getAllTopics(){return this.getModels("Topic").findAll({order:[["topicNo","ASC"]]}).then(e=>({status:!0,data:e}))}getAllSubtopics(){return this.getModels("Subtopic").findAll({order:[["subtopicNo","ASC"]]}).then(e=>({status:!0,data:e}))}getTopicDependencies(e){return this.getSequelize().query(`SELECT topicDependencies.id, topicDependencies.description, topicDependencies.updatedAt, topics.topic as dependencyName FROM topicDependencies INNER JOIN topics ON topics.id = topicDependencies.dependencyId WHERE topicDependencies.topicId=${e}`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}addTopicDependency(e,t,i){return this.read({modelName:"Topic",searchClause:{topic:t}}).then(s=>{if(s.status&&s.data){const t=s.data[0];return t.id===parseInt(e,10)?{status:!1,errMessage:"A topic could not depend on itself!"}:this.create({modelName:"TopicDependency",data:{topicId:e,dependencyId:t.id,description:i}})}return{status:!1,errMessage:`Could not find topic with name "${t}"`}})}getSubtopicByTopicId(e){return this.getModels("Subtopic").findAll({where:{topicId:e},order:[["subtopicNo","ASC"]]}).then(e=>({status:!0,data:e}))}getExerciseBySubtopicId(e){return this.getModels("Exercise").findAll({where:{subtopicId:e},order:[["id","ASC"]]}).then(e=>({status:!0,data:e}))}getSubtopic(e){return this.readOne({modelName:"Subtopic",searchClause:{id:e},include:[{model:this.getModels("Topic")}]})}getTopic(e){return this.readOne({modelName:"Topic",searchClause:{id:e}})}getExercises(e){return this.read({modelName:"Exercise",searchClause:{subtopicId:e},order:[["id","ASC"]]})}getPreviousAndNextExercise(e,t){return Promise.join(this.readOne({modelName:"Exercise",searchClause:{[Sequelize.Op.and]:{id:{[Sequelize.Op.lt]:t},subtopicId:e}},order:[["id","DESC"]],include:[{model:this.getModels("Subtopic"),include:[{model:this.getModels("Topic")}]}]}),this.readOne({modelName:"Exercise",searchClause:{[Sequelize.Op.and]:{id:{[Sequelize.Op.gt]:t},subtopicId:e}},order:[["id","ASC"]],include:[{model:this.getModels("Subtopic"),include:[{model:this.getModels("Topic")}]}]})).spread((e,t)=>({status:!0,data:{prev:e.data,next:t.data}}))}getPreviousAndNextSubtopic(e){return this.getSubtopic(e).then(e=>{if(e.status&&e.data){const t=e.data.subtopicNo;return Promise.join(this.readOne({modelName:"Subtopic",searchClause:{subtopicNo:{[Sequelize.Op.lt]:t}},include:[{model:this.getModels("Topic")}],order:[["subtopicNo","DESC"]],limit:1}),this.readOne({modelName:"Subtopic",searchClause:{subtopicNo:{[Sequelize.Op.gt]:t}},include:[{model:this.getModels("Topic")}],order:[["subtopicNo","ASC"]],limit:1})).spread((e,t)=>({status:!0,data:{prev:e.data,next:t.data}}))}return{status:!1,errMessage:e.errMessage}})}isSubtopicVideoWatched(e,t){return this.getSequelize().query(`\n  SELECT subtopics.id AS subtopicId, true AS watched\n   FROM subtopics\n   INNER JOIN videos ON videos.subtopicId = subtopics.id\n   INNER JOIN watchedVideos on watchedVideos.videoId = videos.id\n   WHERE subtopics.id = ${e} AND watchedVideos.userId = ${t}\n   LIMIT 1;\n`,{type:this.getSequelize().QueryTypes.SELECT}).then(e=>{let t=!1;return e.length>0&&(t=!0),{status:!0,data:{watched:t}}})}}exports.default=new CourseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9jb3Vyc2Utc2VydmljZS50cyJdLCJuYW1lcyI6WyJQcm9taXNlIiwicmVxdWlyZSIsInBhdGgiLCJjcnVkX3NlcnZpY2VfbmVvXzEiLCJGb3JtYXR0ZXIiLCJqb2luIiwiX19kaXJuYW1lIiwibG9nIiwiU2VxdWVsaXplIiwiVEFHIiwiQ291cnNlU2VydmljZSIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJ1c2VySWQiLCJzdXBlciIsInJhd1JlYWRRdWVyeSIsInRoZW4iLCJyZXNwIiwic3RhdHVzIiwiZGF0YSIsIm9iamVjdGlmeSIsImVyck1lc3NhZ2UiLCJ0aGlzIiwiZ2V0TW9kZWxzIiwiZmluZEFsbCIsIm9yZGVyIiwidG9waWNJZCIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJkZXBlbmRlbmN5TmFtZSIsImRlc2NyaXB0aW9uIiwicmVhZCIsIm1vZGVsTmFtZSIsInNlYXJjaENsYXVzZSIsInRvcGljIiwiZGVwZW5kZW5jeVRvcGljIiwiaWQiLCJwYXJzZUludCIsImNyZWF0ZSIsImRlcGVuZGVuY3lJZCIsIndoZXJlIiwic3VidG9waWNJZCIsInJlYWRPbmUiLCJpbmNsdWRlIiwibW9kZWwiLCJleGVyY2lzZUlkIiwiT3AiLCJhbmQiLCJsdCIsImd0Iiwic3ByZWFkIiwicmVzcDEiLCJyZXNwMiIsInByZXYiLCJuZXh0IiwiZ2V0U3VidG9waWMiLCJzdWJ0b3BpY05vIiwibGltaXQiLCJyZXNwMyIsIndhdGNoZWQiLCJsZW5ndGgiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoib0VBQUEsTUFBQUEsUUFBQUMsUUFBQSxZQUNBQyxLQUFBRCxRQUFBLFFBRUFFLG1CQUFBRixRQUFBLHNCQUVNRyxVQUFZSCxRQUFRQyxLQUFLRyxLQUFLQyxVQUFXLDJCQUMvQyxJQUFJQyxJQUFNTixRQUFRLFVBQ2RPLFVBQVlQLFFBQVEsYUFJeEIsTUFBTVEsSUFBTSxzQkFvQlpD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R0FDMUIsT0FBT3RCLEtBQUtvQyxZQUFZZCxHQUFZNUIsS0FBS0MsSUFDdkMsR0FBSUEsRUFBS0MsUUFBVUQsRUFBS0UsS0FBTSxDQUM1QixNQUFNd0MsRUFBYTFDLEVBQUtFLEtBQUt3QyxXQUM3QixPQUFPM0QsUUFBUUssS0FDYmlCLEtBQUt1QixTQUNIVixVQUFXLFdBQ1hDLGNBQWdCdUIsWUFBYy9DLENBQUNKLFVBQVV5QyxHQUFHRSxJQUFLUSxJQUNqRGIsVUFBWUMsTUFBT3pCLEtBQUtDLFVBQVUsV0FDbENFLFFBQVMsYUFBYyxTQUN2Qm1DLE1BQU8sSUFDVHRDLEtBQUt1QixTQUNIVixVQUFXLFdBQ1hDLGNBQWdCdUIsWUFBYy9DLENBQUNKLFVBQVV5QyxHQUFHRyxJQUFLTyxJQUNqRGIsVUFBWUMsTUFBT3pCLEtBQUtDLFVBQVUsV0FDbENFLFFBQVMsYUFBYyxRQUN2Qm1DLE1BQU8sS0FDVFAsT0FBTyxDQUFDRSxFQUE2Qk0sTUFDNUIzQyxRQUFRLEVBQU1DLE1BQVFxQyxLQUFNRCxFQUFNcEMsS0FBTXNDLEtBQU1JLEVBQU0xQyxTQUcvRCxPQUFTRCxRQUFRLEVBQU9HLFdBQVlKLEVBQUtJLGNBUS9DVCx1QkFBd0JnQyxFQUFZL0IsR0FDbEMsT0FBT1MsS0FBS0ssZUFBZUMsd09BTUxnQixnQ0FBeUMvQixvQkFFOURnQixLQUFNUCxLQUFLSyxlQUFlRyxXQUFXQyxTQUFVZixLQUFLRyxJQUN2RCxJQUFJMkMsR0FBVSxFQUlkLE9BSEkzQyxFQUFLNEMsT0FBUyxJQUNoQkQsR0FBVSxJQUVINUMsUUFBUSxFQUFNQyxNQUFRMkMsUUFBQUEsT0FLakNFLFFBQUFyRCxRQUFlLElBQUlEIiwiZmlsZSI6InNlcnZpY2VzL2NvdXJzZS1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcblxuaW1wb3J0IENSVURTZXJ2aWNlIGZyb20gJy4vY3J1ZC1zZXJ2aWNlLW5lbydcblxuY29uc3QgRm9ybWF0dGVyID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbGliL3V0aWxzL2Zvcm1hdHRlcicpKVxubGV0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5sZXQgU2VxdWVsaXplID0gcmVxdWlyZSgnc2VxdWVsaXplJylcblxuLyogbGV0IENSVURTZXJ2aWNlID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY3J1ZC1zZXJ2aWNlJykpICovXG5cbmNvbnN0IFRBRyA9ICdDb3Vyc2VTZXJ2aWNlJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFRvcGljRGV0YWlscyB7XG4gIHRvcGljczoge1xuICAgIHRvcGljSWQ6IG51bWJlclxuICAgIHRvcGljTm86IG51bWJlclxuICAgIHRvcGljOiBQYXJ0aWFsPFRvcGljPlxuICAgIHN0YXJCYWRnZTogbnVtYmVyXG4gICAgdGltZUJhZGdlOiBudW1iZXJcbiAgICBzdWJ0b3BpY3M6IHtcbiAgICAgIHN1YnRvcGljSWQ6IG51bWJlclxuICAgICAgc3VidG9waWNObzogbnVtYmVyXG4gICAgICBzdWJ0b3BpYzogUGFydGlhbDxTdWJ0b3BpYz5cbiAgICAgIHN0YXJCYWRnZTogbnVtYmVyXG4gICAgICB0aW1lQmFkZ2U6IG51bWJlclxuICAgICAgd2F0Y2hCYWRnZTogYm9vbGVhblxuICAgIH1bXVxuICB9W11cbn1cblxuY2xhc3MgQ291cnNlU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgLy8gRGV0YWlsZWQgaW5mb3JtYXRpb24gYWJvdXQgVG9waWNzIC0+IFN1YnRvcGljc1xuICAvLyBJbmNsdWRpbmcgYmFkZ2VzIGFjcXVpcmVkIGZvciBlYWNoIG9mIHRoZW1cbiAgLy8gVE9ETzogUGVyaGFwcyB3ZSBzaG91bGQgcHVzaCBzb21lIG9mIHRoZSBxdWVyeSBpbnRvIHNlcGFyYXRlIHZpZXdzP1xuICBnZXRUb3BpY0RldGFpbHMgKHVzZXJJZCA9IC0xKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFRvcGljRGV0YWlscz4+IHtcbiAgICByZXR1cm4gc3VwZXIucmF3UmVhZFF1ZXJ5KFxuYFxuU0VMRUNUXG4gIHRvcGljcy5pZCBBUyBcXGB0b3BpY3MuaWRcXGAsIHRvcGljcy50b3BpY05vIEFTIFxcYHRvcGljcy50b3BpY05vXFxgLCB0b3BpY3MudG9waWMgQVMgXFxgdG9waWNzLnRvcGljXFxgLFxuICBJRk5VTEwoc3RhckJhZGdlLlxcYGNvdW50XFxgLCAwKSBBUyBcXGB0b3BpY3Muc3RhckJhZGdlXFxgLFxuICBJRk5VTEwodGltZUJhZGdlLlxcYGNvdW50XFxgLCAwKSBBUyBcXGB0b3BpY3MudGltZUJhZGdlXFxgLFxuICBzdWJ0b3BpY3NWaWV3LmlkIEFTIFxcYHRvcGljcy5zdWJ0b3BpY3MuaWRcXGAsIHN1YnRvcGljc1ZpZXcuc3VidG9waWNObyBBUyBcXGB0b3BpY3Muc3VidG9waWNzLnN1YnRvcGljTm9cXGAsXG4gIHN1YnRvcGljc1ZpZXcuc3VidG9waWMgQVMgXFxgdG9waWNzLnN1YnRvcGljcy5zdWJ0b3BpY1xcYCxcbiAgSUZOVUxMKHN1YnRvcGljc1ZpZXcuc3RhckJhZGdlLCAwKSBBUyBcXGB0b3BpY3Muc3VidG9waWNzLnN0YXJCYWRnZVxcYCxcbiAgSUZOVUxMKHN1YnRvcGljc1ZpZXcudGltZUJhZGdlLCAwKSBBUyBcXGB0b3BpY3Muc3VidG9waWNzLnRpbWVCYWRnZVxcYCxcbiAgSUZOVUxMKHN1YnRvcGljc1ZpZXcud2F0Y2hCYWRnZSwgMCkgQVMgXFxgdG9waWNzLnN1YnRvcGljcy53YXRjaEJhZGdlXFxgXG5GUk9NIHRvcGljc1xuTEVGVCBPVVRFUiBKT0lOIChcbiAgU0VMRUNUIENPVU5UKCopIEFTIGNvdW50LCB0b3BpY0lkXG4gIEZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXNcbiAgV0hFUkUgdXNlcklkID0gJHt1c2VySWR9IEFORCBzdWJtaXR0ZWQgPSAxIEFORCBzY29yZSA+PSA4MFxuICBHUk9VUCBCWSB0b3BpY0lkXG4pIEFTIHN0YXJCYWRnZSBPTiBzdGFyQmFkZ2UudG9waWNJZCA9IHRvcGljcy5pZFxuTEVGVCBPVVRFUiBKT0lOIChcbiAgU0VMRUNUIENPVU5UKCopIEFTIGNvdW50LCB0b3BpY0lkXG4gIEZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXNcbiAgV0hFUkUgc3VibWl0dGVkID0gMSBBTkQgdXNlcklkID0gJHt1c2VySWR9IEFORCB0aW1lRmluaXNoIDwgaWRlYWxUaW1lIEFORCBzY29yZSA9IDEwMFxuICBHUk9VUCBCWSB0b3BpY0lkXG4pIEFTIHRpbWVCYWRnZSBPTiB0aW1lQmFkZ2UudG9waWNJZCA9IHRvcGljcy5pZFxuSU5ORVIgSk9JTiAoXG4gIFNFTEVDVFxuICAgIHN1YnRvcGljcy5pZCBBUyBpZCwgc3VidG9waWNzLnRvcGljSWQgQVMgdG9waWNJZCwgc3VidG9waWNzLnN1YnRvcGljIEFTIHN1YnRvcGljLCBzdWJ0b3BpY3Muc3VidG9waWNObyBBUyBzdWJ0b3BpY05vLFxuICAgIChzdGFyQmFkZ2UuXFxgY291bnRcXGAgLyBleGVyY2lzZXNWaWV3LmNvdW50KSBBUyBzdGFyQmFkZ2UsXG4gICAgKHRpbWVCYWRnZS5cXGBjb3VudFxcYCAvIGV4ZXJjaXNlc1ZpZXcuY291bnQpIEFTIHRpbWVCYWRnZSxcbiAgICB3YXRjaEJhZGdlLlxcYGNvdW50XFxgIEFTIHdhdGNoQmFkZ2VcbiAgRlJPTSBzdWJ0b3BpY3NcbiAgTEVGVCBPVVRFUiBKT0lOIChcbiAgICBTRUxFQ1RcbiAgICAgIGV4ZXJjaXNlcy5zdWJ0b3BpY0lkIEFTIHN1YnRvcGljSWQsXG4gICAgICBDT1VOVCgqKSBBUyBjb3VudCxcbiAgICAgIENPVU5UKGRpc3RpbmN0IGV4ZXJjaXNlcy5pZCkgQVMgdGVzdFxuICAgIEZST00gZ2VuZXJhdGVkRXhlcmNpc2VzXG4gICAgSU5ORVIgSk9JTiBleGVyY2lzZXMgT04gZXhlcmNpc2VzLmlkID0gZ2VuZXJhdGVkRXhlcmNpc2VzLmV4ZXJjaXNlSWRcbiAgICAgICAgQU5EIGdlbmVyYXRlZEV4ZXJjaXNlcy5zdWJtaXR0ZWQgPSAxIEFORCBnZW5lcmF0ZWRFeGVyY2lzZXMuc2NvcmUgPj0gODBcbiAgICAgICAgQU5EIGdlbmVyYXRlZEV4ZXJjaXNlcy51c2VySWQgPSAke3VzZXJJZH1cbiAgICBHUk9VUCBCWSBleGVyY2lzZXMuc3VidG9waWNJZCwgZ2VuZXJhdGVkRXhlcmNpc2VzLnVzZXJJZFxuICApIEFTIHN0YXJCYWRnZSBPTiBzdGFyQmFkZ2Uuc3VidG9waWNJZCA9IHN1YnRvcGljcy5pZFxuICBMRUZUIE9VVEVSIEpPSU4gKFxuICAgIFNFTEVDVFxuICAgICAgZXhlcmNpc2VzLnN1YnRvcGljSWQgQVMgc3VidG9waWNJZCxcbiAgICAgIENPVU5UKCopIEFTIGNvdW50XG4gICAgRlJPTSBnZW5lcmF0ZWRFeGVyY2lzZXNcbiAgICBJTk5FUiBKT0lOIGV4ZXJjaXNlcyBPTiBleGVyY2lzZXMuaWQgPSBnZW5lcmF0ZWRFeGVyY2lzZXMuZXhlcmNpc2VJZFxuICAgICAgICBBTkQgZ2VuZXJhdGVkRXhlcmNpc2VzLnN1Ym1pdHRlZCA9IDEgQU5EIGdlbmVyYXRlZEV4ZXJjaXNlcy5zY29yZSA9IDEwMCBBTkQgdGltZUZpbmlzaCA8IGlkZWFsVGltZVxuICAgICAgICBBTkQgZ2VuZXJhdGVkRXhlcmNpc2VzLnVzZXJJZCA9ICR7dXNlcklkfVxuICAgIEdST1VQIEJZIGV4ZXJjaXNlcy5zdWJ0b3BpY0lkLCBnZW5lcmF0ZWRFeGVyY2lzZXMudXNlcklkXG4gICkgQVMgdGltZUJhZGdlIE9OIHRpbWVCYWRnZS5zdWJ0b3BpY0lkID0gc3VidG9waWNzLmlkXG4gIExFRlQgT1VURVIgSk9JTiAoXG4gICAgU0VMRUNUIHZpZGVvcy5zdWJ0b3BpY0lkIEFTIHN1YnRvcGljSWQsIDEgQVMgY291bnRcbiAgICBGUk9NIHZpZGVvc1xuICAgIElOTkVSIEpPSU4gd2F0Y2hlZFZpZGVvcyBvbiB3YXRjaGVkVmlkZW9zLnZpZGVvSWQgPSB2aWRlb3MuaWQgQU5EIHdhdGNoZWRWaWRlb3MudXNlcklkID0gJHt1c2VySWR9XG4gICAgTElNSVQgMVxuICApIEFTIHdhdGNoQmFkZ2UgT04gd2F0Y2hCYWRnZS5zdWJ0b3BpY0lkID0gc3VidG9waWNzLmlkXG4gIExFRlQgT1VURVIgSk9JTiAoXG4gICAgU0VMRUNUIHN1YnRvcGljSWQsIENPVU5UKGlkKSBBUyBjb3VudFxuICAgIEZST00gZXhlcmNpc2VzXG4gICAgR1JPVVAgQlkgc3VidG9waWNJZFxuICApIEFTIGV4ZXJjaXNlc1ZpZXcgT04gZXhlcmNpc2VzVmlldy5zdWJ0b3BpY0lkID0gc3VidG9waWNzLmlkXG4pIEFTIHN1YnRvcGljc1ZpZXcgT04gc3VidG9waWNzVmlldy50b3BpY0lkID0gdG9waWNzLmlkXG5PUkRFUiBCWSB0b3BpY05vLCBzdWJ0b3BpY05vIEFTQ1xuYFxuICAgICkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IEZvcm1hdHRlci5vYmplY3RpZnkocmVzcC5kYXRhKVswXSB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRBbGxUb3BpY3MgKCkge1xuICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnVG9waWMnKS5maW5kQWxsKHsgb3JkZXI6IFtbJ3RvcGljTm8nLCAnQVNDJ11dIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3AgfVxuICAgIH0pXG4gIH1cblxuICBnZXRBbGxTdWJ0b3BpY3MgKCkge1xuICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnU3VidG9waWMnKS5maW5kQWxsKHsgb3JkZXI6IFtbJ3N1YnRvcGljTm8nLCAnQVNDJ11dIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3AgfVxuICAgIH0pXG4gIH1cblxuICBnZXRUb3BpY0RlcGVuZGVuY2llcyAodG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuICAgICAgYFNFTEVDVCB0b3BpY0RlcGVuZGVuY2llcy5pZCwgdG9waWNEZXBlbmRlbmNpZXMuZGVzY3JpcHRpb24sIHRvcGljRGVwZW5kZW5jaWVzLnVwZGF0ZWRBdCwgdG9waWNzLnRvcGljIGFzIGRlcGVuZGVuY3lOYW1lIEZST00gdG9waWNEZXBlbmRlbmNpZXMgSU5ORVIgSk9JTiB0b3BpY3MgT04gdG9waWNzLmlkID0gdG9waWNEZXBlbmRlbmNpZXMuZGVwZW5kZW5jeUlkIFdIRVJFIHRvcGljRGVwZW5kZW5jaWVzLnRvcGljSWQ9JHt0b3BpY0lkfWAsXG4gICAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KVxuICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YSB9XG4gICAgICB9KVxuICB9XG5cbiAgYWRkVG9waWNEZXBlbmRlbmN5ICh0b3BpY0lkLCBkZXBlbmRlbmN5TmFtZSwgZGVzY3JpcHRpb24pIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkPFRvcGljPih7IG1vZGVsTmFtZTogJ1RvcGljJywgc2VhcmNoQ2xhdXNlOiB7IHRvcGljOiBkZXBlbmRlbmN5TmFtZSB9IH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGRlcGVuZGVuY3lUb3BpYyA9IHJlc3AuZGF0YVswXVxuICAgICAgICBpZiAoZGVwZW5kZW5jeVRvcGljLmlkID09PSBwYXJzZUludCh0b3BpY0lkLCAxMCkpIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnQSB0b3BpYyBjb3VsZCBub3QgZGVwZW5kIG9uIGl0c2VsZiEnIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGU8VG9waWNEZXBlbmRlbmN5Pih7IG1vZGVsTmFtZTogJ1RvcGljRGVwZW5kZW5jeScsIGRhdGE6IHsgdG9waWNJZCwgZGVwZW5kZW5jeUlkOiBkZXBlbmRlbmN5VG9waWMuaWQsIGRlc2NyaXB0aW9uIH0gfSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYENvdWxkIG5vdCBmaW5kIHRvcGljIHdpdGggbmFtZSBcIiR7ZGVwZW5kZW5jeU5hbWV9XCJgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0U3VidG9waWNCeVRvcGljSWQgKHRvcGljSWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRNb2RlbHMoJ1N1YnRvcGljJykuZmluZEFsbCh7IHdoZXJlOiB7IHRvcGljSWQgfSwgb3JkZXI6IFtbJ3N1YnRvcGljTm8nLCAnQVNDJ11dIH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGEgfVxuICAgIH0pXG4gIH1cblxuICBnZXRFeGVyY2lzZUJ5U3VidG9waWNJZCAoc3VidG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnRXhlcmNpc2UnKS5maW5kQWxsKHsgd2hlcmU6IHsgc3VidG9waWNJZCB9LCBvcmRlcjogW1snaWQnLCAnQVNDJ11dIH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGEgfVxuICAgIH0pXG4gIH1cblxuICBnZXRTdWJ0b3BpYyAoc3VidG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxTdWJ0b3BpYz4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPFN1YnRvcGljPih7XG4gICAgICBtb2RlbE5hbWU6ICdTdWJ0b3BpYycsXG4gICAgICBzZWFyY2hDbGF1c2U6IHsgaWQ6IHN1YnRvcGljSWQgfSxcbiAgICAgIGluY2x1ZGU6IFt7IG1vZGVsOiB0aGlzLmdldE1vZGVscygnVG9waWMnKSB9XVxuICAgIH0pXG4gIH1cblxuICBnZXRUb3BpYyAodG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmU8VG9waWM+KHsgbW9kZWxOYW1lOiAnVG9waWMnLCBzZWFyY2hDbGF1c2U6IHsgaWQ6IHRvcGljSWQgfSB9KVxuICB9XG5cbiAgZ2V0RXhlcmNpc2VzIChzdWJ0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZDxFeGVyY2lzZT4oeyBtb2RlbE5hbWU6ICdFeGVyY2lzZScsIHNlYXJjaENsYXVzZTogeyBzdWJ0b3BpY0lkIH0sIG9yZGVyOiBbWydpZCcsICdBU0MnXV0gfSlcbiAgfVxuXG4gIGdldFByZXZpb3VzQW5kTmV4dEV4ZXJjaXNlIChzdWJ0b3BpY0lkLCBleGVyY2lzZUlkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPGFueT4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5qb2luKFxuICAgICAgdGhpcy5yZWFkT25lKHtcbiAgICAgICAgbW9kZWxOYW1lOiAnRXhlcmNpc2UnLFxuICAgICAgICBzZWFyY2hDbGF1c2U6IHtcbiAgICAgICAgICBbU2VxdWVsaXplLk9wLmFuZF06IHtcbiAgICAgICAgICAgIGlkOiB7XG4gICAgICAgICAgICAgIFtTZXF1ZWxpemUuT3AubHRdOiBleGVyY2lzZUlkXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3VidG9waWNJZFxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgb3JkZXI6IFtbJ2lkJywgJ0RFU0MnXV0sXG4gICAgICAgIGluY2x1ZGU6IFt7XG4gICAgICAgICAgbW9kZWw6IHRoaXMuZ2V0TW9kZWxzKCdTdWJ0b3BpYycpLFxuICAgICAgICAgIGluY2x1ZGU6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbW9kZWw6IHRoaXMuZ2V0TW9kZWxzKCdUb3BpYycpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICB9XVxuICAgICAgfSksXG4gICAgICB0aGlzLnJlYWRPbmUoe1xuICAgICAgICBtb2RlbE5hbWU6ICdFeGVyY2lzZScsXG4gICAgICAgIHNlYXJjaENsYXVzZToge1xuICAgICAgICAgIFtTZXF1ZWxpemUuT3AuYW5kXToge1xuICAgICAgICAgICAgaWQ6IHtcbiAgICAgICAgICAgICAgW1NlcXVlbGl6ZS5PcC5ndF06IGV4ZXJjaXNlSWRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdWJ0b3BpY0lkXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBvcmRlcjogW1snaWQnLCAnQVNDJ11dLFxuICAgICAgICBpbmNsdWRlOiBbe1xuICAgICAgICAgIG1vZGVsOiB0aGlzLmdldE1vZGVscygnU3VidG9waWMnKSxcbiAgICAgICAgICBpbmNsdWRlOiBbeyBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1RvcGljJykgfV1cbiAgICAgICAgfV1cbiAgICAgIH0pKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPEV4ZXJjaXNlPiwgcmVzcDI6IE5DUmVzcG9uc2U8RXhlcmNpc2U+KSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHByZXY6IHJlc3AxLmRhdGEsXG4gICAgICAgICAgICBuZXh0OiByZXNwMi5kYXRhXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICB9XG5cbiAgZ2V0UHJldmlvdXNBbmROZXh0U3VidG9waWMgKHN1YnRvcGljSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8YW55Pj4ge1xuICAgIHJldHVybiB0aGlzLmdldFN1YnRvcGljKHN1YnRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IHN1YnRvcGljTm8gPSByZXNwLmRhdGEuc3VidG9waWNOb1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5qb2luKFxuICAgICAgICAgIHRoaXMucmVhZE9uZTxTdWJ0b3BpYz4oe1xuICAgICAgICAgICAgbW9kZWxOYW1lOiAnU3VidG9waWMnLFxuICAgICAgICAgICAgc2VhcmNoQ2xhdXNlOiB7IHN1YnRvcGljTm86IHsgW1NlcXVlbGl6ZS5PcC5sdF06IHN1YnRvcGljTm8gfSB9LFxuICAgICAgICAgICAgaW5jbHVkZTogW3sgbW9kZWw6IHRoaXMuZ2V0TW9kZWxzKCdUb3BpYycpIH1dLFxuICAgICAgICAgICAgb3JkZXI6IFtbJ3N1YnRvcGljTm8nLCAnREVTQyddXSxcbiAgICAgICAgICAgIGxpbWl0OiAxfSksXG4gICAgICAgICAgdGhpcy5yZWFkT25lPFN1YnRvcGljPih7XG4gICAgICAgICAgICBtb2RlbE5hbWU6ICdTdWJ0b3BpYycsXG4gICAgICAgICAgICBzZWFyY2hDbGF1c2U6IHsgc3VidG9waWNObzogeyBbU2VxdWVsaXplLk9wLmd0XTogc3VidG9waWNObyB9IH0sXG4gICAgICAgICAgICBpbmNsdWRlOiBbeyBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1RvcGljJykgfV0sXG4gICAgICAgICAgICBvcmRlcjogW1snc3VidG9waWNObycsICdBU0MnXV0sXG4gICAgICAgICAgICBsaW1pdDogMX0pXG4gICAgICAgICkuc3ByZWFkKChyZXNwMjogTkNSZXNwb25zZTxTdWJ0b3BpYz4sIHJlc3AzOiBOQ1Jlc3BvbnNlPFN1YnRvcGljPikgPT4ge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBwcmV2OiByZXNwMi5kYXRhLCBuZXh0OiByZXNwMy5kYXRhIH0gfSBhcyBOQ1Jlc3BvbnNlPGFueT5cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEFsdGhvdWdoIHRoZXJlIG9uZSBzdWJ0b3BpYyBjYW4gaGF2ZSBtdWx0aXBsZSB2aWRlb3MgKHJlY29yZCBvZiBwYXN0IHVwbG9hZHMpLFxuICAvLyB3ZSBjYXJlIG9ubHkgaWYgYXQgbGVhc3Qgb25lIGhhZCBiZWVuIHdhdGNoZWRcbiAgLy8gcmV0dXJuOiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB3YXRjaGVkOiB0cnVlIH19XG4gIGlzU3VidG9waWNWaWRlb1dhdGNoZWQgKHN1YnRvcGljSWQsIHVzZXJJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuYFxuICBTRUxFQ1Qgc3VidG9waWNzLmlkIEFTIHN1YnRvcGljSWQsIHRydWUgQVMgd2F0Y2hlZFxuICAgRlJPTSBzdWJ0b3BpY3NcbiAgIElOTkVSIEpPSU4gdmlkZW9zIE9OIHZpZGVvcy5zdWJ0b3BpY0lkID0gc3VidG9waWNzLmlkXG4gICBJTk5FUiBKT0lOIHdhdGNoZWRWaWRlb3Mgb24gd2F0Y2hlZFZpZGVvcy52aWRlb0lkID0gdmlkZW9zLmlkXG4gICBXSEVSRSBzdWJ0b3BpY3MuaWQgPSAke3N1YnRvcGljSWR9IEFORCB3YXRjaGVkVmlkZW9zLnVzZXJJZCA9ICR7dXNlcklkfVxuICAgTElNSVQgMTtcbmAsIHsgdHlwZTogdGhpcy5nZXRTZXF1ZWxpemUoKS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKGRhdGEgPT4ge1xuICBsZXQgd2F0Y2hlZCA9IGZhbHNlXG4gIGlmIChkYXRhLmxlbmd0aCA+IDApIHtcbiAgICB3YXRjaGVkID0gdHJ1ZVxuICB9XG4gIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB3YXRjaGVkIH0gfVxufSlcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgQ291cnNlU2VydmljZSgpXG4iXX0=
