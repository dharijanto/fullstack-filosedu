var path=require("path"),AWS=require("aws-sdk"),fs=require("fs"),log=require("npmlog"),multer=require("multer"),Promise=require("bluebird"),url=require("url");const AppConfig=require(path.join(__dirname,"../app-config"));var CRUDService=require(path.join(__dirname,"crud-service"));const TAG="VideoService";class VideoService extends CRUDService{addVideo(e,r=null,i){return this.create({modelName:"Videos",data:{filename:e,sourceLink:r,subtopicId:i}}).then(r=>r.status?{status:!0,data:{selfHostedURL:url.resolve(AppConfig.VIDEO_MOUNT_PATH,e)}}:r)}addFeedback(e,r,i){return this.create({modelName:"Feedbacks",data:{videoId:e,userId:r,value:i}})}getVideo(e){return this._models.Videos.findOne({where:{subtopicId:e},order:[["createdAt","DESC"]]}).then(e=>e?{status:!0,data:{id:e.id,selfHostedURL:url.resolve(AppConfig.VIDEO_MOUNT_PATH,e.filename),filename:e.filename,remoteHostedURL:JSON.parse(e.sourceLink)}}:{status:!1,errCode:0,errMessage:"Data not found"})}getAllVideos(){return this.read({modelName:"Videos",searchClause:{}})}static getUploadMiddleware(){return multer({storage:multer.diskStorage({destination:(e,r,i)=>{i(null,AppConfig.VIDEO_PATH)},filename:(e,r,i)=>{var t=r.originalname.split(" ").join("_");i(null,Date.now()+"_"+t)}}),limits:{files:1}}).single("video")}uploadVideoToS3(e){return new Promise((r,i)=>{fs.readFile(path.join(AppConfig.VIDEO_PATH,e),(t,o)=>{t&&i(t);var s=new AWS.S3;AWS.config.update({region:AppConfig.AWS_REGION});var a=Buffer.from(o,"binary"),n={Bucket:AppConfig.AWS_VIDEO_CONF.AWS_BUCKET_NAME,Key:e,Body:a,ACL:"public-read"};s.putObject(n,function(t,o){if(t)fs.unlink(path.join(AppConfig.VIDEO_PATH,e),(e,r)=>{i(t)});else{var s=new AWS.ElasticTranscoder,a={PipelineId:AppConfig.AWS_VIDEO_CONF.AWS_PIPELINE_ID,Input:{Key:e},OutputKeyPrefix:AppConfig.AWS_VIDEO_CONF.AWS_PREFIX_FOLDER_VIDEO_NAME,Outputs:[{Key:url.resolve(AppConfig.AWS_VIDEO_CONF.AWS_360P_FOLDER,e),PresetId:AppConfig.AWS_VIDEO_CONF.AWS_360P_PRESET_ID},{Key:url.resolve(AppConfig.AWS_VIDEO_CONF.AWS_720P_FOLDER,e),PresetId:AppConfig.AWS_VIDEO_CONF.AWS_720P_PRESET_ID}]};log.verbose(TAG,"uploadVideoToS3(): paramElastic="+JSON.stringify(a)),s.createJob(a,function(t,o){if(t)fs.unlink(path.join(AppConfig.VIDEO_PATH,e),(e,r)=>{i(t)});else{log.verbose(TAG,"uploadVideoToS3(): data3="+JSON.stringify(o));const e=o.Job.Outputs;if(!e||e.length<2)log.error(TAG,"uploadVideoToS3(): ElasticTranscoder result is less than expected!"),r({status:!1,errMessage:"ElasticTranscoder returns unexpected response"});else{const i=url.resolve(AppConfig.AWS_VIDEO_CONF.AWS_LINK,path.join(AppConfig.AWS_VIDEO_CONF.AWS_BUCKET_NAME,o.Job.OutputKeyPrefix||"")),t=url.resolve(i,e[0].Key),s=url.resolve(i,e[1].Key);r({status:!0,data:{URL:{nonHD:t,HD:s}}})}}})}})})})}uploadAndSaveVideoToDB(e,r){return new Promise((i,t)=>{if(!AppConfig.CLOUD_SERVER)return this.addVideo(e,null,r).then(e=>{e.status?i(e):i({status:!1})}).catch(e=>{t(e)});this.uploadVideoToS3(e).then(t=>{if(t.status)return this.addVideo(e,JSON.stringify(t.data.URL),r).then(e=>{e.status?i(e):i({status:!1})});i({status:!1})}).catch(e=>{t(e)})})}addFinishedWatching(e,r){return e&&r?this.create({modelName:"WatchedVideo",data:{videoId:e,userId:r,onCloud:AppConfig.CLOUD_SERVER}}):Promise.resolve({status:!1,errMessage:"videoId and userId are required!"})}}module.exports=VideoService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy92aWRlby1zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiQVdTIiwiZnMiLCJsb2ciLCJtdWx0ZXIiLCJQcm9taXNlIiwidXJsIiwiQXBwQ29uZmlnIiwiam9pbiIsIl9fZGlybmFtZSIsIkNSVURTZXJ2aWNlIiwiVEFHIiwiVmlkZW9TZXJ2aWNlIiwiW29iamVjdCBPYmplY3RdIiwiZmlsZW5hbWUiLCJzb3VyY2VMaW5rIiwic3VidG9waWNJZCIsInRoaXMiLCJjcmVhdGUiLCJtb2RlbE5hbWUiLCJkYXRhIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJzZWxmSG9zdGVkVVJMIiwicmVzb2x2ZSIsIlZJREVPX01PVU5UX1BBVEgiLCJ2aWRlb0lkIiwidXNlcklkIiwidmFsdWUiLCJfbW9kZWxzIiwiZmluZE9uZSIsIndoZXJlIiwib3JkZXIiLCJpZCIsInJlbW90ZUhvc3RlZFVSTCIsIkpTT04iLCJwYXJzZSIsImVyckNvZGUiLCJlcnJNZXNzYWdlIiwicmVhZCIsInNlYXJjaENsYXVzZSIsInN0b3JhZ2UiLCJkaXNrU3RvcmFnZSIsImRlc3RpbmF0aW9uIiwicmVxIiwiZmlsZSIsImNhbGxiYWNrIiwiVklERU9fUEFUSCIsIm9yaWdpbmFsTmFtZSIsIm9yaWdpbmFsbmFtZSIsInNwbGl0IiwiRGF0ZSIsIm5vdyIsImxpbWl0cyIsImZpbGVzIiwic2luZ2xlIiwiZmlsZU5hbWUiLCJyZWplY3QiLCJyZWFkRmlsZSIsImVyciIsInMzIiwiUzMiLCJjb25maWciLCJ1cGRhdGUiLCJyZWdpb24iLCJBV1NfUkVHSU9OIiwiYmFzZTY0ZGF0YSIsIkJ1ZmZlciIsImZyb20iLCJwYXJhbXMiLCJCdWNrZXQiLCJBV1NfVklERU9fQ09ORiIsIkFXU19CVUNLRVRfTkFNRSIsIktleSIsIkJvZHkiLCJBQ0wiLCJwdXRPYmplY3QiLCJlcnIxIiwiZGF0YTEiLCJ1bmxpbmsiLCJlcnIyIiwiZGF0YTIiLCJlbGFzdGljdHJhbnNjb2RlciIsIkVsYXN0aWNUcmFuc2NvZGVyIiwicGFyYW1FbGFzdGljIiwiUGlwZWxpbmVJZCIsIkFXU19QSVBFTElORV9JRCIsIklucHV0IiwiT3V0cHV0S2V5UHJlZml4IiwiQVdTX1BSRUZJWF9GT0xERVJfVklERU9fTkFNRSIsIk91dHB1dHMiLCJBV1NfMzYwUF9GT0xERVIiLCJQcmVzZXRJZCIsIkFXU18zNjBQX1BSRVNFVF9JRCIsIkFXU183MjBQX0ZPTERFUiIsIkFXU183MjBQX1BSRVNFVF9JRCIsInZlcmJvc2UiLCJzdHJpbmdpZnkiLCJjcmVhdGVKb2IiLCJlcnIzIiwiZGF0YTMiLCJyZXN1bHRzIiwiSm9iIiwibGVuZ3RoIiwiZXJyb3IiLCJhd3NVUkxQYXRoIiwiQVdTX0xJTksiLCJhd3MzNjBwVVJMIiwiYXdzNzIwcFVSTCIsIlVSTCIsIm5vbkhEIiwiSEQiLCJDTE9VRF9TRVJWRVIiLCJhZGRWaWRlbyIsInJlc3AyIiwiY2F0Y2giLCJ1cGxvYWRWaWRlb1RvUzMiLCJvbkNsb3VkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSUEsS0FBT0MsUUFBUSxRQUVmQyxJQUFNRCxRQUFRLFdBQ2RFLEdBQUtGLFFBQVEsTUFDYkcsSUFBTUgsUUFBUSxVQUNkSSxPQUFTSixRQUFRLFVBQ2pCSyxRQUFVTCxRQUFRLFlBQ2xCTSxJQUFNTixRQUFRLE9BRWxCLE1BQU1PLFVBQVlQLFFBQVFELEtBQUtTLEtBQUtDLFVBQVcsa0JBQy9DLElBQUlDLFlBQWNWLFFBQVFELEtBQUtTLEtBQUtDLFVBQVcsaUJBRS9DLE1BQU1FLElBQU0scUJBRVpDLHFCQUEyQkYsWUFDekJHLFNBQVVDLEVBQVVDLEVBQWEsS0FBTUMsR0FDckMsT0FBT0MsS0FBS0MsUUFDVkMsVUFBVyxTQUNYQyxNQUNFTixTQUFBQSxFQUNBQyxXQUFBQSxFQUNBQyxXQUFBQSxLQUVESyxLQUFLQyxHQUNGQSxFQUFLQyxRQUVMQSxRQUFRLEVBQ1JILE1BQ0VJLGNBQWVsQixJQUFJbUIsUUFBUWxCLFVBQVVt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ZW1DLFNBQ3pCNUcsS0FBS1MsS0FDSEQsVUFBVWlFLGVBQWVDLGdCQUN6QjRCLEVBQU1FLElBQUlkLGlCQUFtQixLQUMzQm1CLEVBQWF0RyxJQUFJbUIsUUFBUWlGLEVBQVlKLEVBQVEsR0FBRzVCLEtBQ2hEbUMsRUFBYXZHLElBQUltQixRQUFRaUYsRUFBWUosRUFBUSxHQUFHNUIsS0FDdERqRCxHQUFTRixRQUFRLEVBQ2ZILE1BQ0UwRixLQUNFQyxNQUFTSCxFQUNUSSxHQUFNSCxpQkFhNUJoRyx1QkFBd0I0QyxFQUFVekMsR0FDaEMsT0FBTyxJQUFJWCxRQUFRLENBQUNvQixFQUFTaUMsS0FDM0IsSUFBSW5ELFVBQVUwRyxhQWlCWixPQUFPaEcsS0FBS2lHLFNBQVN6RCxFQUFVLEtBQU16QyxHQUFZSyxLQUFLOEYsSUFDaERBLEVBQU01RixPQUNSRSxFQUFRMEYsR0FFUjFGLEdBQVNGLFFBQVEsTUFFbEI2RixNQUFNeEQsSUFDUEYsRUFBT0UsS0F2QlQzQyxLQUFLb0csZ0JBQWdCNUQsR0FBVXBDLEtBQUtDLElBQ2xDLEdBQUlBLEVBQUtDLE9BQ1AsT0FBT04sS0FBS2lHLFNBQVN6RCxFQUFVckIsS0FBSzhELFVBQVU1RSxFQUFLRixLQUFLMEYsS0FBTTlGLEdBQVlLLEtBQUs4RixJQUN6RUEsRUFBTTVGLE9BQ1JFLEVBQVEwRixHQUVSMUYsR0FBU0YsUUFBUSxNQUlyQkUsR0FBU0YsUUFBUSxNQUVsQjZGLE1BQU14RCxJQUNQRixFQUFPRSxPQWdCZi9DLG9CQUFxQmMsRUFBU0MsR0FDNUIsT0FBSUQsR0FBV0MsRUFDTlgsS0FBS0MsUUFBUUMsVUFBVyxlQUFnQkMsTUFDN0NPLFFBQUFBLEVBQ0FDLE9BQUFBLEVBQ0EwRixRQUFTL0csVUFBVTBHLGdCQUdkNUcsUUFBUW9CLFNBQVNGLFFBQVEsRUFBT2dCLFdBQVksc0NBS3pEZ0YsT0FBT0MsUUFBVTVHIiwiZmlsZSI6InNlcnZpY2VzL3ZpZGVvLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG52YXIgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpXG52YXIgZnMgPSByZXF1aXJlKCdmcycpXG52YXIgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbnZhciBtdWx0ZXIgPSByZXF1aXJlKCdtdWx0ZXInKVxudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpXG52YXIgdXJsID0gcmVxdWlyZSgndXJsJylcblxuY29uc3QgQXBwQ29uZmlnID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwLWNvbmZpZycpKVxudmFyIENSVURTZXJ2aWNlID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnY3J1ZC1zZXJ2aWNlJykpXG5cbmNvbnN0IFRBRyA9ICdWaWRlb1NlcnZpY2UnXG5cbmNsYXNzIFZpZGVvU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgYWRkVmlkZW8gKGZpbGVuYW1lLCBzb3VyY2VMaW5rID0gbnVsbCwgc3VidG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZSh7XG4gICAgICBtb2RlbE5hbWU6ICdWaWRlb3MnLFxuICAgICAgZGF0YToge1xuICAgICAgICBmaWxlbmFtZSxcbiAgICAgICAgc291cmNlTGluayxcbiAgICAgICAgc3VidG9waWNJZFxuICAgICAgfVxuICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgc2VsZkhvc3RlZFVSTDogdXJsLnJlc29sdmUoQXBwQ29uZmlnLlZJREVPX01PVU5UX1BBVEgsIGZpbGVuYW1lKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3BcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgYWRkRmVlZGJhY2sgKHZpZGVvSWQsIHVzZXJJZCwgdmFsdWUpIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGUoe1xuICAgICAgbW9kZWxOYW1lOiAnRmVlZGJhY2tzJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdmlkZW9JZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB2YWx1ZVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRWaWRlbyAoc3VidG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLl9tb2RlbHNbJ1ZpZGVvcyddLmZpbmRPbmUoe3doZXJlOiB7c3VidG9waWNJZH0sIG9yZGVyOiBbWydjcmVhdGVkQXQnLCAnREVTQyddXX0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICBpZiAoZGF0YSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBpZDogZGF0YS5pZCxcbiAgICAgICAgICAgIHNlbGZIb3N0ZWRVUkw6IHVybC5yZXNvbHZlKEFwcENvbmZpZy5WSURFT19NT1VOVF9QQVRILCBkYXRhLmZpbGVuYW1lKSxcbiAgICAgICAgICAgIGZpbGVuYW1lOiBkYXRhLmZpbGVuYW1lLFxuICAgICAgICAgICAgcmVtb3RlSG9zdGVkVVJMOiBKU09OLnBhcnNlKGRhdGEuc291cmNlTGluaylcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7c3RhdHVzOiBmYWxzZSwgZXJyQ29kZTogMCwgZXJyTWVzc2FnZTogJ0RhdGEgbm90IGZvdW5kJ31cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0QWxsVmlkZW9zICgpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkKHttb2RlbE5hbWU6ICdWaWRlb3MnLCBzZWFyY2hDbGF1c2U6IHt9fSlcbiAgfVxuXG4gIHN0YXRpYyBnZXRVcGxvYWRNaWRkbGV3YXJlICgpIHtcbiAgICB2YXIgZmlsZU5hbWUgPSAnJ1xuICAgIGNvbnN0IHVwbG9hZCA9IG11bHRlcih7XG4gICAgICBzdG9yYWdlOiBtdWx0ZXIuZGlza1N0b3JhZ2Uoe1xuICAgICAgICBkZXN0aW5hdGlvbjogKHJlcSwgZmlsZSwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCBBcHBDb25maWcuVklERU9fUEFUSClcbiAgICAgICAgfSxcbiAgICAgICAgZmlsZW5hbWU6IChyZXEsIGZpbGUsIGNhbGxiYWNrKSA9PiB7XG4gICAgICAgICAgdmFyIG9yaWdpbmFsTmFtZSA9IGZpbGUub3JpZ2luYWxuYW1lLnNwbGl0KCcgJykuam9pbignXycpXG4gICAgICAgICAgZmlsZU5hbWUgPSBEYXRlLm5vdygpICsgJ18nICsgb3JpZ2luYWxOYW1lXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgZmlsZU5hbWUpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgbGltaXRzOiB7XG4gICAgICAgIGZpbGVzOiAxXG4gICAgICB9XG4gICAgfSkuc2luZ2xlKCd2aWRlbycpXG4gICAgcmV0dXJuIHVwbG9hZFxuICB9XG5cbiAgdXBsb2FkVmlkZW9Ub1MzIChmaWxlTmFtZSkge1xuICAgIC8vIGV4YW1wbGUgY29udGVudCBmaWxlTmFtZSA6IDE1MTczOTIzOTg4MDhfNjAxX0FydGlfUGVjYWhhbi5tcDRcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZnMucmVhZEZpbGUocGF0aC5qb2luKEFwcENvbmZpZy5WSURFT19QQVRILCBmaWxlTmFtZSksIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgIH1cbiAgICAgICAgdmFyIHMzID0gbmV3IEFXUy5TMygpXG4gICAgICAgIEFXUy5jb25maWcudXBkYXRlKHtyZWdpb246IEFwcENvbmZpZy5BV1NfUkVHSU9OfSlcbiAgICAgICAgLy8gQ2hhbmdpbmcgZnJvbSBuZXcgQnVmZmVyIHRvIEJ1ZmZlci5mcm9tIGJlY2F1c2UgaXQncyBkZXByZWNhdGVkIGluIG5vZGUgdjZcbiAgICAgICAgdmFyIGJhc2U2NGRhdGEgPSBCdWZmZXIuZnJvbShkYXRhLCAnYmluYXJ5JylcbiAgICAgICAgdmFyIHBhcmFtcyA9IHtcbiAgICAgICAgICBCdWNrZXQ6IEFwcENvbmZpZy5BV1NfVklERU9fQ09ORi5BV1NfQlVDS0VUX05BTUUsXG4gICAgICAgICAgS2V5OiBmaWxlTmFtZSxcbiAgICAgICAgICBCb2R5OiBiYXNlNjRkYXRhLFxuICAgICAgICAgIEFDTDogJ3B1YmxpYy1yZWFkJ1xuICAgICAgICB9XG5cbiAgICAgICAgczMucHV0T2JqZWN0KHBhcmFtcywgZnVuY3Rpb24gKGVycjEsIGRhdGExKSB7XG4gICAgICAgICAgaWYgKGVycjEpIHtcbiAgICAgICAgICAgIC8qIHdoZW4gZXJyb3IsIHdlIGRlbGV0ZSBsb2NhbCBmaWxlLCBpdHMgZWl0aGVyIHN1Y2Nlc3Mgb3IgZmFpbCAqL1xuICAgICAgICAgICAgZnMudW5saW5rKHBhdGguam9pbihBcHBDb25maWcuVklERU9fUEFUSCwgZmlsZU5hbWUpLCAoZXJyMiwgZGF0YTIpID0+IHtcbiAgICAgICAgICAgICAgcmVqZWN0KGVycjEpXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgZWxhc3RpY3RyYW5zY29kZXIgPSBuZXcgQVdTLkVsYXN0aWNUcmFuc2NvZGVyKClcbiAgICAgICAgICAgIHZhciBwYXJhbUVsYXN0aWMgPSB7XG4gICAgICAgICAgICAgIFBpcGVsaW5lSWQ6IEFwcENvbmZpZy5BV1NfVklERU9fQ09ORi5BV1NfUElQRUxJTkVfSUQsIC8qIHJlcXVpcmVkICovXG4gICAgICAgICAgICAgIElucHV0OiB7XG4gICAgICAgICAgICAgICAgS2V5OiBmaWxlTmFtZVxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBPdXRwdXRLZXlQcmVmaXg6IEFwcENvbmZpZy5BV1NfVklERU9fQ09ORi5BV1NfUFJFRklYX0ZPTERFUl9WSURFT19OQU1FLFxuICAgICAgICAgICAgICBPdXRwdXRzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgS2V5OiB1cmwucmVzb2x2ZShBcHBDb25maWcuQVdTX1ZJREVPX0NPTkYuQVdTXzM2MFBfRk9MREVSLCBmaWxlTmFtZSksXG4gICAgICAgICAgICAgICAgICBQcmVzZXRJZDogQXBwQ29uZmlnLkFXU19WSURFT19DT05GLkFXU18zNjBQX1BSRVNFVF9JRFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgS2V5OiB1cmwucmVzb2x2ZShBcHBDb25maWcuQVdTX1ZJREVPX0NPTkYuQVdTXzcyMFBfRk9MREVSLCBmaWxlTmFtZSksXG4gICAgICAgICAgICAgICAgICBQcmVzZXRJZDogQXBwQ29uZmlnLkFXU19WSURFT19DT05GLkFXU183MjBQX1BSRVNFVF9JRFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICd1cGxvYWRWaWRlb1RvUzMoKTogcGFyYW1FbGFzdGljPScgKyBKU09OLnN0cmluZ2lmeShwYXJhbUVsYXN0aWMpKVxuXG4gICAgICAgICAgICBlbGFzdGljdHJhbnNjb2Rlci5jcmVhdGVKb2IocGFyYW1FbGFzdGljLCBmdW5jdGlvbiAoZXJyMywgZGF0YTMpIHtcbiAgICAgICAgICAgICAgaWYgKGVycjMpIHtcbiAgICAgICAgICAgICAgICBmcy51bmxpbmsocGF0aC5qb2luKEFwcENvbmZpZy5WSURFT19QQVRILCBmaWxlTmFtZSksIChlcnIyLCBkYXRhMikgPT4ge1xuICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycjMpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2cudmVyYm9zZShUQUcsICd1cGxvYWRWaWRlb1RvUzMoKTogZGF0YTM9JyArIEpTT04uc3RyaW5naWZ5KGRhdGEzKSlcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRzID0gZGF0YTMuSm9iLk91dHB1dHNcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdHMgfHwgcmVzdWx0cy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgICBsb2cuZXJyb3IoVEFHLCAndXBsb2FkVmlkZW9Ub1MzKCk6IEVsYXN0aWNUcmFuc2NvZGVyIHJlc3VsdCBpcyBsZXNzIHRoYW4gZXhwZWN0ZWQhJylcbiAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJNZXNzYWdlOiAnRWxhc3RpY1RyYW5zY29kZXIgcmV0dXJucyB1bmV4cGVjdGVkIHJlc3BvbnNlJ1xuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgY29uc3QgYXdzVVJMUGF0aCA9IHVybC5yZXNvbHZlKFxuICAgICAgICAgICAgICAgICAgICBBcHBDb25maWcuQVdTX1ZJREVPX0NPTkYuQVdTX0xJTkssXG4gICAgICAgICAgICAgICAgICAgIHBhdGguam9pbihcbiAgICAgICAgICAgICAgICAgICAgICBBcHBDb25maWcuQVdTX1ZJREVPX0NPTkYuQVdTX0JVQ0tFVF9OQU1FLFxuICAgICAgICAgICAgICAgICAgICAgIGRhdGEzLkpvYi5PdXRwdXRLZXlQcmVmaXggfHwgJycpKVxuICAgICAgICAgICAgICAgICAgY29uc3QgYXdzMzYwcFVSTCA9IHVybC5yZXNvbHZlKGF3c1VSTFBhdGgsIHJlc3VsdHNbMF0uS2V5KVxuICAgICAgICAgICAgICAgICAgY29uc3QgYXdzNzIwcFVSTCA9IHVybC5yZXNvbHZlKGF3c1VSTFBhdGgsIHJlc3VsdHNbMV0uS2V5KVxuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7c3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgVVJMOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnbm9uSEQnOiBhd3MzNjBwVVJMLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ0hEJzogYXdzNzIwcFVSTFxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgdXBsb2FkQW5kU2F2ZVZpZGVvVG9EQiAoZmlsZU5hbWUsIHN1YnRvcGljSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKEFwcENvbmZpZy5DTE9VRF9TRVJWRVIpIHtcbiAgICAgICAgdGhpcy51cGxvYWRWaWRlb1RvUzMoZmlsZU5hbWUpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hZGRWaWRlbyhmaWxlTmFtZSwgSlNPTi5zdHJpbmdpZnkocmVzcC5kYXRhLlVSTCksIHN1YnRvcGljSWQpLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwMilcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6IGZhbHNlfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZSh7c3RhdHVzOiBmYWxzZX0pXG4gICAgICAgICAgfVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRWaWRlbyhmaWxlTmFtZSwgbnVsbCwgc3VidG9waWNJZCkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cykge1xuICAgICAgICAgICAgcmVzb2x2ZShyZXNwMilcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZSh7c3RhdHVzOiBmYWxzZX0pXG4gICAgICAgICAgfVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGFkZEZpbmlzaGVkV2F0Y2hpbmcgKHZpZGVvSWQsIHVzZXJJZCkge1xuICAgIGlmICh2aWRlb0lkICYmIHVzZXJJZCkge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHttb2RlbE5hbWU6ICdXYXRjaGVkVmlkZW8nLCBkYXRhOiB7XG4gICAgICAgIHZpZGVvSWQsXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgfX0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3N0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICd2aWRlb0lkIGFuZCB1c2VySWQgYXJlIHJlcXVpcmVkISd9KVxuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFZpZGVvU2VydmljZVxuIl19
