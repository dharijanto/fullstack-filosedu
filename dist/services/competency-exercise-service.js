"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),moment=require("moment-timezone"),crud_service_neo_1=require("./crud-service-neo"),course_service_1=require("./course-service"),exercise_generator_1=require("../lib/exercise_generator/exercise-generator"),exercise_helper_1=require("../app/utils/exercise-helper"),topic_exercise_service_1=require("./topic-exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),Sequelize=require("sequelize");const AppConfig=require(path.join(__dirname,"../app-config")),TAG="CompetencyExerciseService";class CompetencyExerciseService extends crud_service_neo_1.default{getExerciseCodes(){return super.read({modelName:"CompetencyExerciseCode",searchClause:{}})}addExerciseCode(e){return super.create({modelName:"CompetencyExerciseCode",data:{code:e.toLowerCase()}})}deleteExerciseCode(e){return super.delete({modelName:"CompetencyExerciseCode",data:{id:e}})}submitExerciseCode(e){return e?super.readOne({modelName:"CompetencyExerciseCode",searchClause:{code:e.toLowerCase()}}).then(e=>{if(e.status&&e.data){const t=e.data;return super.update({modelName:"CompetencyExerciseCode",data:{id:t.id,hits:t.hits+1}})}return{status:!1,errMessage:"Code tidak terdaftar"}}):Promise.resolve({status:!1,errMessage:"Code harus diisi"})}getGeneratedExercise(e){return e?super.readOne({modelName:"GeneratedCompetencyExercise",searchClause:{id:e}}):Promise.resolve({status:!1,errMessage:"competencyExerciseId is required!"})}getTopicExerciseByState(e,t){let s;switch(e){case"exercising":return void 0!==(s=t.find(e=>!e.submitted&&"createdAt"in e))?{status:!0,data:s}:{status:!1,errMessage:"No topic with 'exercising' state!"};case"pendingExercise":return void 0!==(s=t.find(e=>!(e.submitted||"createdAt"in e)))?{status:!0,data:s}:{status:!1,errMessage:"No topic with 'pendingExercise' state!"};default:return{status:!1,errMessage:`Unexpected state: ${e}`}}}getTopicState(e){let t;if(e.createdAt&&e.submitted)t="finished";else if("createdAt"in e||!e.submitted){if("createdAt"in e||e.submitted)return{status:!1,errMessage:"Unexpected state!"};t="pending"}else t="skipped";return{status:!0,data:t}}getExerciseState(e){let t;const s=JSON.parse(e.exerciseDetail||"");if(log.verbose(TAG,"getExerciseState: topics="+JSON.stringify(s,null,2)),e.submitted)t="submitted";else if(e.abandoned)t="abandoned";else if(this.getTopicExerciseByState("exercising",s).status)t="exercising";else if(this.getTopicExerciseByState("pendingExercise",s).status)t="pendingExercise";else{if(void 0!==s.find(e=>!e.submitted))return{status:!1,errMessage:"generatedCompetencyExercise has an invalid state!"};t="finished"}return{status:!0,data:t}}getExerciseStateById(e){return super.readOne({modelName:"GeneratedCompetencyExercise",searchClause:{id:e}}).then(e=>e.status&&e.data?this.getExerciseState(e.data):{status:!1,errMessage:"generatedCompetencyExercise could not be found: "+e.errMessage})}getSubmittedExerciseInformation(e){const t=this.getExerciseState(e);if(t.status&&t.data){if("submitted"===t.data){const t=JSON.parse(e.exerciseDetail||"");return Promise.map(t,e=>{const t=this.getTopicState(e);if(t.status)return course_service_1.default.getTopic(e.topicId).then(s=>{if(s.status&&s.data)return{topicName:s.data.topic,skipped:"skipped"===t.data,score:parseInt(""+e.score,10),idealTime:parseInt(""+e.idealTime,10),timeFinish:""+parseInt(""+e.timeFinish,10),timeScore:function(e,t){return t<=e?100:t>e&&t<=2*e?75:t>2*e&&t<=3*e?50:t>3*e&&t<=4*e?25:0}(e.idealTime,e.timeFinish)};throw new Error(`Failed to get topic information: ${s.errMessage}`)});throw new Error("Failed to get topic state: "+t.errMessage)}).then(e=>({status:!0,data:e}))}return Promise.resolve({status:!1,errMessage:"Only 'submitted' exercise can be processed!"})}return Promise.resolve({status:!1,errMessage:`Failed to get exercise state: ${t.errMessage}`})}getPendingTopicInformation(e){const t=this.getExerciseState(e);if(!t.status||!t.data)return Promise.resolve({status:!1,errMessage:`Failed to get exercise state: ${t.errMessage}`});if("pendingExercise"!==t.data)return Promise.resolve({status:!1,errMessage:"Only information about 'pendingExercise' can be retrieved!"});{const t=JSON.parse(e.exerciseDetail||"");let s,r=null;for(s=0;s<t.length;s++){const e=t[s];if(!e.submitted&&void 0===e.createdAt){r=t[s];break}}if(null===r)return Promise.resolve({status:!1,errMessage:"Couldn't retrieve pending generatedTopicExercise!"});try{const e=JSON.parse(r.exerciseDetail||""),{questionQuantity:i,idealTime:a}=e.reduce(({questionQuantity:e,idealTime:t},s)=>({questionQuantity:e+JSON.parse(s.knowns).length,idealTime:t+s.idealTime}),{questionQuantity:0,idealTime:0});return course_service_1.default.getTopic(r.topicId).then(e=>e.status&&e.data?{status:!0,data:{topicName:e.data.topic,topicNo:s+1,topicQuantity:t.length,questionQuantity:i,idealTime:a}}:{status:!1,errMessage:`Failed to retrieve topic: ${e.errMessage}`})}catch(e){return Promise.reject(e)}}}startExercise(e){const t=this.getExerciseState(e);if(t.status&&t.data){if("pendingExercise"===t.data){const t=JSON.parse(e.exerciseDetail),s=t.findIndex(e=>!(e.submitted||"createdAt"in e));return-1!==s?(t[s].createdAt=moment().local().format("YYYY-MM-DD HH:mm:ss"),console.dir("Updateing generatedTopicExercises to be: "+JSON.stringify(t,null,2)),super.update({modelName:"GeneratedCompetencyExercise",data:{id:e.id,exerciseDetail:JSON.stringify(t)}}).then(t=>t.status?this.getGeneratedExercise(e.id).then(e=>e.status&&e.data?this.continueExercise(e.data):{status:!1,errMessage:"Failed to get generatedExercise!"}):{status:!1,errMessage:"Failed to update generatedCompetencyExercise!"})):Promise.resolve({status:!1,errMessage:"There is no topic exercise to start!"})}return Promise.resolve({status:!1,errMessage:"Only 'pendingExercise' can be started!"})}return Promise.resolve({status:!1,errMessage:`Failed to get exercise state: ${t.errMessage}`})}continueExercise(e){const t=this.getExerciseState(e);return t.status&&t.data?"exercising"===t.data?this.formatExercise(e):Promise.resolve({status:!1,errMessage:`Only 'exercising' can be continued! Exercise state=${t.data}`}):Promise.resolve({status:!1,errMessage:`Failed to get exercise state: ${t.errMessage}`})}submitExercise(e,{name:t,phone:s,email:r}){return this.getGeneratedExercise(e).then(i=>{if(i.status&&i.data){const e=i.data,a=this.getExerciseState(e);if(a.status&&a.data){if("finished"===a.data){const i=JSON.parse(e.exerciseDetail).reduce((e,t)=>e+(t.score||0),0);return super.update({modelName:"GeneratedCompetencyExercise",data:{id:e.id,score:i,submitted:!0,name:t,phone:s,email:r}})}return Promise.resolve({status:!1,errMessage:"Unexpected exercise state: 'resp2.data'"})}return Promise.resolve({status:!1,errMessage:"Failed to get exercise state: "+a.errMessage})}return{status:!1,errMessage:`Failed to getGeneratedExercise: ${e}`}})}abandonExercise(e,t){const s=this.getExerciseState(e);return s.status&&s.data?"finished"!==s.data?super.update({modelName:"GeneratedCompetencyExercise",data:{id:e.id,abandoned:!0,submitted:!1,userId:t}}):Promise.resolve({status:!1,errMessage:"'finished' exercise can't be abandoned!"}):Promise.resolve({status:!1,errMessage:`Failed to get exercise state: ${s.errMessage}`})}skipTopic(e){const t=this.getExerciseState(e);if(t.status&&t.data){if("pendingExercise"===t.data){const t=JSON.parse(e.exerciseDetail),s=this.getTopicExerciseByState("pendingExercise",t);if(s.status&&s.data){return s.data.submitted=!0,super.update({modelName:"GeneratedCompetencyExercise",data:{id:e.id,exerciseDetail:JSON.stringify(t)}})}return Promise.resolve({status:!1,errMessage:`Failed to get pending exercise: ${s.errMessage}`})}return Promise.resolve({status:!1,errMessage:"Only exercie with 'pendingExercise' state can be skipped!"})}return Promise.resolve({status:!1,errMessage:`Failed to get exercise state: ${t.errMessage}`})}formatExercise(e){const t=JSON.parse(e.exerciseDetail),s=this.getTopicExerciseByState("exercising",t);if(s.status&&s.data){const e=s.data;return topic_exercise_service_1.default.formatExercise(e).then(e=>e.status&&e.data?e:{status:!1,errMessage:`Failed to format generatedTopicExercise: ${e.errMessage}`})}return Promise.resolve({status:!1,errMessage:"Unable to find topic exercise with 'exercising' state!"})}submitTopicAnswer(e,t){throw new Error("Not implemented yet!")}getExerciseHash(){return course_service_1.default.getOrderedTopics().then(e=>{if(e.status&&e.data){const t=e.data;return Promise.map(t,e=>topic_exercise_service_1.default.getExercisesHash(e.id).then(t=>{if(t.status&&t.data)return t.data;throw new Error(`Failed to get hash for topic with id=${e.id}: ${t.errMessage}`)})).then(e=>({status:!0,data:this.getHashFromTopicHashes(e)}))}return{status:!1,errMessage:`Failed to retrieved topics: ${e.errMessage}`}})}getHashFromTopicHashes(e){const t=e.reduce((e,t)=>e+t,"");return exercise_generator_1.default.getHash(t)}generateAndSaveExercise(e){return this.generateExercise().then(t=>{if(t.status&&t.data){const s=t.data;return this.create({modelName:"GeneratedCompetencyExercise",data:{submitted:!1,abandoned:!1,hash:s.hash,onCloud:AppConfig.CLOUD_SERVER,exerciseDetail:s.exerciseDetail,userId:e}})}return{status:!1,errMessage:`Failed to generate exercise: ${t.errMessage}`}})}generateExercise(){return course_service_1.default.getOrderedTopics().then(e=>{if(e.status&&e.data){const t=e.data;return Promise.map(t,e=>topic_exercise_service_1.default.generateExercise(e.id,"competencyQuantity").then(t=>{if(t.data&&t.status){const s=t.data;return{topicId:e.id,topicExerciseHash:s.topicExerciseHash,idealTime:s.idealTime,exerciseDetail:s.exerciseDetail}}throw new Error(`Failed to generate exercise for topic: ${e.id}: ${t.errMessage}`)})).then(e=>{const t=e.filter(e=>{return JSON.parse(e.exerciseDetail||"").length>0});return{status:!0,data:{hash:this.getHashFromTopicHashes(e.map(e=>e.topicExerciseHash||"")),topics:e,exerciseDetail:JSON.stringify(t)}}})}return{status:!1,errMessage:`Failed to retrieve topics: ${e.errMessage}`}})}submitTopicExercise(e,t){return this.getGeneratedExercise(e).then(e=>{if(e.status&&e.data){const s=e.data,r=this.getExerciseState(s);if(r.status&&r.data){const e=r.data;if(console.log("Exercise state="+e),"exercising"===e){const e=JSON.parse(s.exerciseDetail),r=this.getTopicExerciseByState("exercising",e);if(r.status&&r.data){const i=r.data,a=JSON.parse(i.exerciseDetail);return topic_exercise_service_1.default.gradeExercise(a,t).then(r=>r.status&&r.data?(i.submitted=!0,i.submittedAt=moment().local().format("YYYY-MM-DD HH:mm:ss"),i.score=r.data.score,i.timeFinish=exercise_helper_1.default.countTimeFinish(i.createdAt),i.exerciseDetail=JSON.stringify(topic_exercise_service_1.default.insertAnswers(a,t)),super.update({modelName:"GeneratedCompetencyExercise",data:{id:s.id,exerciseDetail:JSON.stringify(e)}})):{status:!1,errMessage:`Failed to grade exercise: ${r.errMessage}`})}return{status:!1,errMessage:`Failed to get 'exercising' exercise: ${r.errMessage}`}}return{status:!1,errMessage:`Expecting 'exercising' state, but get '${e}' instead!`}}return{status:!1,errMessage:`Failed to getExerciseState: ${r.errMessage}`}}return{status:!1,errMessage:`Failed to getGeneratedExercise: ${e.errMessage}`}})}}exports.default=new CompetencyExerciseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9jb21wZXRlbmN5LWV4ZXJjaXNlLXNlcnZpY2UudHMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJtb21lbnQiLCJjcnVkX3NlcnZpY2VfbmVvXzEiLCJjb3Vyc2Vfc2VydmljZV8xIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJleGVyY2lzZV9oZWxwZXJfMSIsInRvcGljX2V4ZXJjaXNlX3NlcnZpY2VfMSIsInBhdGgiLCJsb2ciLCJwdWciLCJTZXF1ZWxpemUiLCJBcHBDb25maWciLCJqb2luIiwiX19kaXJuYW1lIiwiVEFHIiwiQ29tcGV0ZW5jeUV4ZXJjaXNlU2VydmljZSIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJzdXBlciIsInJlYWQiLCJtb2RlbE5hbWUiLCJzZWFyY2hDbGF1c2UiLCJjb2RlIiwiY3JlYXRlIiwiZGF0YSIsInRvTG93ZXJDYXNlIiwiaWQiLCJkZWxldGUiLCJyZWFkT25lIiwidGhlbiIsInJlc3AiLCJzdGF0dXMiLCJjb21wRXhlcmNpc2VDb2RlIiwidXBkYXRlIiwiaGl0cyIsImVyck1lc3NhZ2UiLCJyZXNvbHZlIiwiY29tcGV0ZW5jeUV4ZXJjaXNlSWQiLCJzdGF0ZSIsInRvcGljcyIsInRvcGljIiwidW5kZWZpbmVkIiwiZmluZCIsInN1Ym1pdHRlZCIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJjcmVhdGVkQXQiLCJnZW5lcmF0ZWRFeGVyY2lzZSIsIkpTT04iLCJwYXJzZSIsImV4ZXJjaXNlRGV0YWlsIiwidmVyYm9zZSIsInN0cmluZ2lmeSIsImFiYW5kb25lZCIsInRoaXMiLCJnZXRUb3BpY0V4ZXJjaXNlQnlTdGF0ZSIsImdldEV4ZXJjaXNlU3RhdGUiLCJyZXNwMiIsIm1hcCIsImdldFRvcGljU3RhdGUiLCJnZXRUb3BpYyIsInRvcGljSWQiLCJ0b3BpY05hbWUiLCJza2lwcGVkIiwic2NvcmUiLCJwYXJzZUludCIsImlkZWFsVGltZSIsInRpbWVGaW5pc2giLCJ0aW1lU2NvcmUiLCJjb21wdXRlVGltZVNjb3JlIiwiRXJyb3IiLCJyZXN1bHRzIiwiaWR4IiwibGVuZ3RoIiwiZ2VuZXJhdGVkRXhlcmNpc2VzIiwicXVlc3Rpb25RdWFudGl0eSIsInJlZHVjZSIsImdlbkV4ZXJjaXNlIiwia25vd25zIiwidG9waWNObyIsInRvcGljUXVhbnRpdHkiLCJlcnIiLCJyZWplY3QiLCJnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlcyIsImV4ZXJjaXNlSW5kZXgiLCJmaW5kSW5kZXgiLCJsb2NhbCIsImZvcm1hdCIsImNvbnNvbGUiLCJkaXIiLCJnZXRHZW5lcmF0ZWRFeGVyY2lzZSIsImNvbnRpbnVlRXhlcmNpc2UiLCJmb3JtYXRFeGVyY2lzZSIsIm5hbWUiLCJwaG9uZSIsImVtYWlsIiwiYWNjIiwidXNlcklkIiwicmVzcDMiLCJnZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UiLCJhbnN3ZXJzIiwiZ2V0T3JkZXJlZFRvcGljcyIsImdldEV4ZXJjaXNlc0hhc2giLCJoYXNoZXMiLCJnZXRIYXNoRnJvbVRvcGljSGFzaGVzIiwidG9waWNFeGVyY2lzZUhhc2hlcyIsImFsbEhhc2hlcyIsImhhc2giLCJnZXRIYXNoIiwiZ2VuZXJhdGVFeGVyY2lzZSIsIm9uQ2xvdWQiLCJDTE9VRF9TRVJWRVIiLCJ0b3BpY0V4ZXJjaXNlSGFzaCIsImZpbHRlcmVkUmVzdWx0cyIsImZpbHRlciIsInJlc3VsdCIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWwiLCJncmFkZUV4ZXJjaXNlIiwic3VibWl0dGVkQXQiLCJjb3VudFRpbWVGaW5pc2giLCJpbnNlcnRBbnN3ZXJzIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFDQUMsT0FBQUQsUUFBQSxtQkFFQUUsbUJBQUFGLFFBQUEsc0JBQ0FHLGlCQUFBSCxRQUFBLG9CQUNBSSxxQkFBQUosUUFBQSxnREFFQUssa0JBQUFMLFFBQUEsZ0NBQ0FNLHlCQUFBTixRQUFBLDRCQUdBLElBQUlPLEtB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SSxrQkFBb0I4QixHQUNsQixlQUFWQSxFQUF3QixDQUMxQixNQUFNQyxFQUFTUSxLQUFLQyxNQUFNRixFQUFrQkcsZ0JBQ3RDZ0QsRUFBUTVDLEtBQUtDLHdCQUF3QixhQUFjZixHQUN6RCxHQUFJMEQsRUFBTWxFLFFBQVVrRSxFQUFNekUsS0FBTSxDQUM5QixNQUFNZ0IsRUFBUXlELEVBQU16RSxLQUNkMkYsRUFBK0JwRSxLQUFLQyxNQUFNUixFQUFNUyxnQkFDdEQsT0FBTzNDLHlCQUFBVSxRQUFxQm9HLGNBQWNELEVBQThCaEIsR0FBU3RFLEtBQUsyQixHQUNoRkEsRUFBTXpCLFFBQVV5QixFQUFNaEMsTUFDeEJnQixFQUFNRyxXQUFZLEVBQ2xCSCxFQUFNNkUsWUFBY3BILFNBQVNvRixRQUFRQyxPQUFPLHVCQUM1QzlDLEVBQU11QixNQUFRUCxFQUFNaEMsS0FBS3VDLE1BQ3pCdkIsRUFBTTBCLFdBQWE3RCxrQkFBQVcsUUFBZXNHLGdCQUFnQjlFLEVBQU1LLFdBQ3hETCxFQUFNUyxlQUFpQkYsS0FBS0ksVUFBVTdDLHlCQUFBVSxRQUFxQnVHLGNBQWNKLEVBQThCaEIsSUFDaEdqRixNQUFNZSxRQUNYYixVQUFXLDhCQUNYSSxNQUNFRSxHQUFJb0IsRUFBa0JwQixHQUN0QnVCLGVBQWdCRixLQUFLSSxVQUFVWixRQUkxQlIsUUFBUSxFQUFPSSx3Q0FBeUNxQixFQUFNckIsZUFJM0UsT0FBU0osUUFBUSxFQUFPSSxtREFBb0Q4RCxFQUFNOUQsY0FHcEYsT0FBU0osUUFBUSxFQUFPSSxxREFBc0RHLGVBR2hGLE9BQVNQLFFBQVEsRUFBT0ksMENBQTJDcUIsRUFBTXJCLGNBRzNFLE9BQVNKLFFBQVEsRUFBT0ksOENBQStDTCxFQUFLSyxpQkFNcEZxRixRQUFBeEcsUUFBZSxJQUFJRCIsImZpbGUiOiJzZXJ2aWNlcy9jb21wZXRlbmN5LWV4ZXJjaXNlLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudC10aW1lem9uZSdcbmltcG9ydCBCcnV0ZWZvcmNlU29sdmVyLCB7IEdlbmVyYXRlZFF1ZXN0aW9uRGF0YSB9IGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2Vfc29sdmVycy9icnV0ZWZvcmNlLXNvbHZlcidcbmltcG9ydCBDUlVEU2VydmljZSBmcm9tICcuL2NydWQtc2VydmljZS1uZW8nXG5pbXBvcnQgQ291cnNlU2VydmljZSBmcm9tICcuL2NvdXJzZS1zZXJ2aWNlJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IEV4ZXJjaXNlU2VydmljZSBmcm9tICcuL2V4ZXJjaXNlLXNlcnZpY2UnXG5pbXBvcnQgRXhlcmNpc2VIZWxwZXIgZnJvbSAnLi4vYXBwL3V0aWxzL2V4ZXJjaXNlLWhlbHBlcidcbmltcG9ydCBUb3BpY0V4ZXJjaXNlU2VydmljZSwgeyBUb3BpY0V4ZXJjaXNlQW5zd2VyIH0gZnJvbSAnLi90b3BpYy1leGVyY2lzZS1zZXJ2aWNlJ1xuaW1wb3J0ICogYXMgVXRpbHMgZnJvbSAnLi4vbGliL3V0aWxzJ1xuXG5sZXQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5sZXQgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbmxldCBwdWcgPSByZXF1aXJlKCdwdWcnKVxubGV0IFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpXG5cbmNvbnN0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC1jb25maWcnKSlcblxuY29uc3QgVEFHID0gJ0NvbXBldGVuY3lFeGVyY2lzZVNlcnZpY2UnXG5cbi8qXG5EZXNpZ246XG5TaW5jZSBjb21wZXRlbmN5IHRlc3QgY2FuIGJlIHF1aXRlIHRpbWVseSAodGhlcmUgYXJlIDEyMCBzdWJ0b3BpY3MpLCB3ZSBkb24ndCB3YW50IHN0dWRlbnRzXG5oYXZpbmcgdG8gZmluaXNoIGl0IGltbWVkaWF0ZWx5LiBJbnN0ZWFkLCB0aGVyZSBhcmUgY2hlY2twb2ludHMgYXQgZXZlcnkgdG9waWNzLlxuQWZ0ZXIgZXZlcnkgdG9waWMsIGEgXCJ0aW1lIHRvIHRha2UgYSBicmVha1wiIHBhZ2Ugd2lsbCBiZSBzaG93bi4gVGVsbCBzdHVkZW50cyB0aGF0LCBvbmNlIHRoZVxuXCJzdGFydFwiIGJ1dHRvbiBpcyBwcmVzc2VkLCB0aW1lciBpcyBzdGFydGVkIHVudGlsIGFub3RoZXIgXCJ0aW1lIHRvIHRha2UgYSBicmVha1wiIHBhZ2UgaXMgc2hvd24uXG5TbyBtYWtlIHN1cmUgdG8gZG8gaXQgaW4gYW4gZW52aXJvbm1lbnQgd2l0aG91dCBkaXN0cmFjdGlvbi4gVGhlcmUncyBhbHNvIFwiYWJhbmRvbiB0ZXN0XCIgYnV0dG9uXG5pbiBjYXNlIHN0dWRlbnQgZG9lc24ndCB3YW50IHRvIGNvbnRpbnVlIGl0LlxuXG5TdGVwOlxuMS4gUm93IGVudHJ5IGlzIGxvb2tlZCB1cCBmcm9tIHJlcS5zZXNzaW9uLmNvbXBldGVuY3lFeGVyY2lzZUlkID09PSBjb21wZXRlbmN5RXhlY2lzZS5pZFxuMi4gQ2hlY2sgaWYgc3VibWl0dGVkID09PT0gZmFsc2UgJiYgYWJhbmRvbmVkID09PSBmYWxzZVxuMy4gQ2hlY2sgY29tcGV0ZW5jeSBleGVyY2lzZSBoYXNoLiBJZiBpdCBoYXMgY2hhbmdlZCwgcmUtY3JlYXRlLlxuNC4gU2hvdyBcInRpbWUgdG8gdGFrZSBhIGJyZWFrXCIgcGFnZVxuICovXG5cbmludGVyZmFjZSBUb3BpY0luZm9ybWF0aW9uIHtcbiAgdG9waWNOYW1lOiBzdHJpbmdcbiAgdG9waWNObzogbnVtYmVyXG4gIHRvcGljUXVhbnRpdHk6IG51bWJlclxuICBxdWVzdGlvblF1YW50aXR5OiBudW1iZXJcbiAgaWRlYWxUaW1lOiBudW1iZXJcbn1cblxuaW50ZXJmYWNlIFRvcGljUmVzdWx0IHtcbiAgdG9waWNOYW1lOiBzdHJpbmdcbiAgc2tpcHBlZDogYm9vbGVhblxuICBzY29yZTogbnVtYmVyXG4gIGlkZWFsVGltZTogbnVtYmVyXG4gIHRpbWVGaW5pc2g6IHN0cmluZ1xuICB0aW1lU2NvcmU6IG51bWJlciAvLyBYIDw9IGlkZWFsVGltZTogIDEwMC4gaWRlYWxUaW1lIDwgWCA8PSAyICogaWRlYWxUaW1lOiA3NSUuIDIgKiBpZGVhbFRpbWUgPCBYIDw9IDMgKiBpZGVhbFRpbWU6IDUwJS5cbn1cblxuZXhwb3J0IHR5cGUgQ29tcGV0ZW5jeUV4ZXJjaXNlQW5zd2VyID0gQXJyYXk8e1trZXk6IHN0cmluZ106IGFueX0+XG5cbi8qXG4gIFRoZXNlIGFyZSB0aGUgZGlmZmVyZW50IHN0YXRlcyBhbiBleGVyY2lzZSBjYW4gYmUgYXQuXG4gIFRoaXMgc3RhdGUgaXMgaW5mZXJyZWQgZnJvbSBHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UsIGJ1dCBpcyBwcmVzZW50ZWRcbiAgaW4gYSBtb3JlIHVzZXItZnJpZW5kbHkgd2F5IGZvciBjb250cm9sbGVyIHRvIHVzZS5cblxuICBzdWJtaXR0ZWQ6IEhhcyBiZWVuIHN1Ym1pdHRlZCwgcmVwb3J0IHBhZ2UgYW5kIHNjb3JlIGFyZSB0byBiZSBzaG93bi5cbiAgICAgICAgICAgICBUaGlzIGlzIGlkZW50aWZpZWQgYnkgc3VibWl0dGVkIGNvbHVtbiA9IHRydWVcbiAgYWJhbmRvbmVkOiBIYXMgYmVlbiBhYmFuZG9uZWQsIGFiYW5kb25lZCBwYWdlIHdoZXJlIHVzZXIgY2FuIHJlLXRha2UgaXMgdG8gYmUgc2hvd24uXG4gICAgICAgICAgICAgVGhpcyBpcyBpZGVudGlmaWVkIGJ5IGFiYW5kb25lZCBjb2x1bW4gPSB0cnVlXG4gICAgICAgICAgICAgZmluaXNoZWQ6IGV4ZXJjaXNlcyBoYXMgYmVlbiBjb21wbGV0ZWQsIGJ1dCBub3QgeWV0IHN1Ym1pdHRlZCwgc3VibWlzc2lvbiBwYWdlIGlzIHRvIGJlIHNob3duLlxuICAgICAgICAgICAgIFRoaXMgaXMgaWRlbnRpZmllZCBieSBhbGwgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMnIHN1Ym1pdHRlZCA9IHRydWVcbiAgZXhlcmNpc2luZzogSW4gdGhlIG1pZGRsZSBvZiBhIHRvcGljIGV4ZXJjaXNlLlxuICAgICAgICAgICAgICBUaGlzIGlzIGlkZW50aWZpZWQgYnkgYXQgbGVhc3Qgb25lIGdlbmVyYXRlZFRvcGljRXhlcmNpc2Ugd2l0aCBzdWJtaXR0ZWQgPSBmYWxzZSB0aGF0XG4gICAgICAgICAgICAgIGhhcyBjcmVhdGVkQXQgZmllbGQgZGVmaW5lZC5cbiAgcGVuZGluZ0V4ZXJjaXNlOiBUaGVyZSdzIGEgdG9waWMgZXhlcmNpc2UgdG8gZG8sIGJ1dCBub3Qgc3RhcnRlZFxuICAgICAgICAgICAgICAgICAgIFRoaXMgaXMgaWRlbnRpZmllZCBieSB0aGUgYXQgbGVhc3Qgb25lIGdlbmVyYXRlZFRvcGljRXhlcmNpc2Ugd2l0aCBzdWJtaXR0ZWQgPSB0cnVlIHRoYXRcbiAgICAgICAgICAgICAgICAgICBkb2Vzbid0IGhhdmUgY3JlYXRlZEF0IGZpZWxkIGRlZmluZWQuXG4gIHNraXBwZWQ6IFwiQmVsdW0gYmVsYWphclwiIGJ1dHRvbiBpcyBwcmVzc2VkLiBJbnRlcm5hbGx5IGlkZW50aWZpZWQgd2l0aCBzdWJtaXR0ZWQgPSB0cnVlLCBidXQgbm8gY3JlYXRlZEF0XG5cblRoZSBtb3N0IHVuaW50dWl0aXZlIHRoaW5ncyBhcmUgcHJvYmFibHkgZXhlcmNpc2luZyBhbmQgcGVuZGluZ0V4ZXJjaXNlIHN0YXRlLlxuKi9cbmV4cG9ydCB0eXBlIEV4ZXJjaXNlU3RhdGUgPSAnc3VibWl0dGVkJyB8ICdhYmFuZG9uZWQnIHwgJ2ZpbmlzaGVkJyB8ICdleGVyY2lzaW5nJyB8ICdwZW5kaW5nRXhlcmNpc2UnIHwgJ3NraXBwZWQnXG50eXBlIFRvcGljU3RhdGUgPSAnZmluaXNoZWQnIHwgJ3NraXBwZWQnIHwgJ3BlbmRpbmcnXG5cbmNsYXNzIENvbXBldGVuY3lFeGVyY2lzZVNlcnZpY2UgZXh0ZW5kcyBDUlVEU2VydmljZSB7XG4gIGdldEV4ZXJjaXNlQ29kZXMgKCkge1xuICAgIHJldHVybiBzdXBlci5yZWFkPENvbXBldGVuY3lFeGVyY2lzZUNvZGU+KHtcbiAgICAgIG1vZGVsTmFtZTogJ0NvbXBldGVuY3lFeGVyY2lzZUNvZGUnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7fVxuICAgIH0pXG4gIH1cblxuICBhZGRFeGVyY2lzZUNvZGUgKGNvZGU6IHN0cmluZykge1xuICAgIHJldHVybiBzdXBlci5jcmVhdGU8Q29tcGV0ZW5jeUV4ZXJjaXNlQ29kZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnQ29tcGV0ZW5jeUV4ZXJjaXNlQ29kZScsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGNvZGU6IGNvZGUudG9Mb3dlckNhc2UoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBkZWxldGVFeGVyY2lzZUNvZGUgKGlkOiBudW1iZXIpIHtcbiAgICByZXR1cm4gc3VwZXIuZGVsZXRlKHtcbiAgICAgIG1vZGVsTmFtZTogJ0NvbXBldGVuY3lFeGVyY2lzZUNvZGUnLFxuICAgICAgZGF0YToge1xuICAgICAgICBpZFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBzdWJtaXRFeGVyY2lzZUNvZGUgKGNvZGU6IHN0cmluZyk6IFByb21pc2U8TkNSZXNwb25zZTxhbnk+PiB7XG4gICAgaWYgKGNvZGUpIHtcbiAgICAgIHJldHVybiBzdXBlci5yZWFkT25lPENvbXBldGVuY3lFeGVyY2lzZUNvZGU+KHtcbiAgICAgICAgbW9kZWxOYW1lOiAnQ29tcGV0ZW5jeUV4ZXJjaXNlQ29kZScsXG4gICAgICAgIHNlYXJjaENsYXVzZToge1xuICAgICAgICAgIGNvZGU6IGNvZGUudG9Mb3dlckNhc2UoKVxuICAgICAgICB9XG4gICAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgY29tcEV4ZXJjaXNlQ29kZSA9IHJlc3AuZGF0YVxuICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8Q29tcGV0ZW5jeUV4ZXJjaXNlQ29kZT4oe1xuICAgICAgICAgICAgbW9kZWxOYW1lOiAnQ29tcGV0ZW5jeUV4ZXJjaXNlQ29kZScsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIGlkOiBjb21wRXhlcmNpc2VDb2RlLmlkLFxuICAgICAgICAgICAgICBoaXRzOiBjb21wRXhlcmNpc2VDb2RlLmhpdHMgKyAxXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnQ29kZSB0aWRhayB0ZXJkYWZ0YXInIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdDb2RlIGhhcnVzIGRpaXNpJyB9KVxuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBhbiBleGVyY2lzZSB0aGF0IGlzIG5vdCB5ZXQgZmluaXNoZWRcbiAgZ2V0R2VuZXJhdGVkRXhlcmNpc2UgKGNvbXBldGVuY3lFeGVyY2lzZUlkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8R2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlPj4ge1xuICAgIGlmIChjb21wZXRlbmN5RXhlcmNpc2VJZCkge1xuICAgICAgcmV0dXJuIHN1cGVyLnJlYWRPbmU8R2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlPih7XG4gICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZScsXG4gICAgICAgIHNlYXJjaENsYXVzZToge1xuICAgICAgICAgIGlkOiBjb21wZXRlbmN5RXhlcmNpc2VJZFxuICAgICAgICB9fVxuICAgICAgKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ2NvbXBldGVuY3lFeGVyY2lzZUlkIGlzIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cblxuICAvLyBUaGlzIGZ1bmN0aW9uIGlzIHN1cHBvc2VkIHRvIHJldHVybiB0aGUgb3JpZ2luYWwgcmVmZXJlbmNlIHRvIHRoZSBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLFxuICAvLyBpbnN0ZWFkIG9mIGEgY2xvbmUgb2YgaXQuIFRoaXMgYmVoYXZpb3IgaXMgZXhwZWN0ZWQgYnkgb3RoZXIgZnVuY3Rpb25zIHRoYXQgdXNlIHRoaXMuXG4gIGdldFRvcGljRXhlcmNpc2VCeVN0YXRlIChzdGF0ZTogRXhlcmNpc2VTdGF0ZSwgdG9waWNzOiBQYXJ0aWFsPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+W10pOiBOQ1Jlc3BvbnNlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+IHtcbiAgICAvLyBjb25zdCB0b3BpY3MgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEV4ZXJjaXNlLmV4ZXJjaXNlRGV0YWlsIHx8ICcnKSBhcyBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlW11cbiAgICBsZXQgdG9waWNcbiAgICBzd2l0Y2ggKHN0YXRlKSB7XG4gICAgICBjYXNlICdleGVyY2lzaW5nJzpcbiAgICAgICAgdG9waWMgPSB0b3BpY3MuZmluZCh0b3BpYyA9PiAhdG9waWMuc3VibWl0dGVkICYmICdjcmVhdGVkQXQnIGluIHRvcGljKVxuICAgICAgICBpZiAodG9waWMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogdG9waWMgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBObyB0b3BpYyB3aXRoICdleGVyY2lzaW5nJyBzdGF0ZSFgIH1cbiAgICAgICAgfVxuICAgICAgY2FzZSAncGVuZGluZ0V4ZXJjaXNlJzpcbiAgICAgICAgdG9waWMgPSB0b3BpY3MuZmluZCh0b3BpYyA9PiAhdG9waWMuc3VibWl0dGVkICYmICEoJ2NyZWF0ZWRBdCcgaW4gdG9waWMpKVxuICAgICAgICBpZiAodG9waWMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogdG9waWMgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBObyB0b3BpYyB3aXRoICdwZW5kaW5nRXhlcmNpc2UnIHN0YXRlIWAgfVxuICAgICAgICB9XG4gICAgICAvKiBjYXNlICdza2lwcGVkJzpcbiAgICAgICAgdG9waWMgPSB0b3BpY3MuZmluZCh0b3BpYyA9PiB0b3BpYy5zdWJtaXR0ZWQgPT09IHRydWUgJiYgISgnY3JlYXRlZEF0JyBpbiB0b3BpYykpXG4gICAgICAgIGlmICh0b3BpYyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB0b3BpYyB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYE5vIHRvcGljIHdpdGggJ3BlbmRpbmdFeGVyY2lzZScgc3RhdGUhYCB9XG4gICAgICAgIH0gKi9cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBVbmV4cGVjdGVkIHN0YXRlOiAke3N0YXRlfWAgfVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAgTk9URTogVGhpcyByZXR1cm5zIHRoZSBzdGF0ZSBmb3IgYSB0b3BpYywgbm90IGZvciB0aGUgZW50aXJlIGNvbXBldGVuY3kgZXhlcmNpc2UuXG4gICAgICAgICAgRm9yIGV4YW1wbGUsIGFuIGV4ZXJjaXNlIGlzICdmaW5pc2hlZCcgaWYgaXQncyByZWFkeSB0byBiZSBzdWJtaXR0ZWQuIEJ1dCBhIHRvcGljXG4gICAgICAgICAgaXMgZmluaXNoZWQgaWYgaXQgaXMgYWxyZWFkeSBzdWJtaXR0ZWQuIFRoZSBzZW1hbnRpY3MgYXJlIGEgYml0IGRpZmZlcmVudFxuICAqL1xuICBwcml2YXRlIGdldFRvcGljU3RhdGUgKGdlbmVyYXRlZFRvcGljRXhlcmNpc2U6IFBhcnRpYWw8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4pOiBOQ1Jlc3BvbnNlPFRvcGljU3RhdGU+IHtcbiAgICBsZXQgc3RhdGU6IFRvcGljU3RhdGVcbiAgICBpZiAoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5jcmVhdGVkQXQgJiYgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5zdWJtaXR0ZWQpIHtcbiAgICAgIHN0YXRlID0gJ2ZpbmlzaGVkJ1xuICAgIH0gZWxzZSBpZiAoISgnY3JlYXRlZEF0JyBpbiBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKSAmJiBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLnN1Ym1pdHRlZCkge1xuICAgICAgc3RhdGUgPSAnc2tpcHBlZCdcbiAgICB9IGVsc2UgaWYgKCEoJ2NyZWF0ZWRBdCcgaW4gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSkgJiYgIWdlbmVyYXRlZFRvcGljRXhlcmNpc2Uuc3VibWl0dGVkKSB7XG4gICAgICBzdGF0ZSA9ICdwZW5kaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnVW5leHBlY3RlZCBzdGF0ZSEnIH1cbiAgICB9XG4gICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBzdGF0ZSB9XG4gIH1cblxuICAvKlxuICAgIE5DUmVzcG9uc2UgY29udmVudGlvbjpcbiAgICB0cnVlOiB0aGUgZ2VuZXJhdGVkIGV4ZXJjaXNlIGlzIGZvdW5kXG4gICAgZmFsc2U6IHRoZSBnZW5lcmF0ZWQgZXhlcmNpc2UgaXMgbm90IGZvdW5kIG9yIGZvdW5kIGJ1dCB3aXRoIGludmFsaWQgc3RhdGVcbiAgICovXG4gIGdldEV4ZXJjaXNlU3RhdGUgKGdlbmVyYXRlZEV4ZXJjaXNlOiBHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UpOiBOQ1Jlc3BvbnNlPEV4ZXJjaXNlU3RhdGU+IHtcbiAgICBsZXQgc3RhdGU6IEV4ZXJjaXNlU3RhdGVcbiAgICBjb25zdCB0b3BpY3MgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEV4ZXJjaXNlLmV4ZXJjaXNlRGV0YWlsIHx8ICcnKSBhcyBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlW11cbiAgICBsb2cudmVyYm9zZShUQUcsICdnZXRFeGVyY2lzZVN0YXRlOiB0b3BpY3M9JyArIEpTT04uc3RyaW5naWZ5KHRvcGljcywgbnVsbCwgMikpXG4gICAgaWYgKGdlbmVyYXRlZEV4ZXJjaXNlLnN1Ym1pdHRlZCkge1xuICAgICAgc3RhdGUgPSAnc3VibWl0dGVkJ1xuICAgIH0gZWxzZSBpZiAoZ2VuZXJhdGVkRXhlcmNpc2UuYWJhbmRvbmVkKSB7XG4gICAgICBzdGF0ZSA9ICdhYmFuZG9uZWQnXG4gICAgfSBlbHNlIGlmICh0aGlzLmdldFRvcGljRXhlcmNpc2VCeVN0YXRlKCdleGVyY2lzaW5nJywgdG9waWNzKS5zdGF0dXMpIHtcbiAgICAgIHN0YXRlID0gJ2V4ZXJjaXNpbmcnXG4gICAgfSBlbHNlIGlmICh0aGlzLmdldFRvcGljRXhlcmNpc2VCeVN0YXRlKCdwZW5kaW5nRXhlcmNpc2UnLCB0b3BpY3MpLnN0YXR1cykge1xuICAgICAgc3RhdGUgPSAncGVuZGluZ0V4ZXJjaXNlJ1xuICAgIH0gZWxzZSBpZiAodG9waWNzLmZpbmQodG9waWMgPT4gIXRvcGljLnN1Ym1pdHRlZCkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgc3RhdGUgPSAnZmluaXNoZWQnXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdnZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UgaGFzIGFuIGludmFsaWQgc3RhdGUhJyB9XG4gICAgfVxuICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogc3RhdGUgfVxuICB9XG5cbiAgZ2V0RXhlcmNpc2VTdGF0ZUJ5SWQgKGNvbXBldGVuY3lFeGVyY2lzZUlkOiBudW1iZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8RXhlcmNpc2VTdGF0ZT4+IHtcbiAgICByZXR1cm4gc3VwZXIucmVhZE9uZTxHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2U+KHtcbiAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZScsXG4gICAgICBzZWFyY2hDbGF1c2U6IHtcbiAgICAgICAgaWQ6IGNvbXBldGVuY3lFeGVyY2lzZUlkXG4gICAgICB9fVxuICAgICkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VTdGF0ZShyZXNwLmRhdGEpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnZ2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlIGNvdWxkIG5vdCBiZSBmb3VuZDogJyArIHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFN1Ym1pdHRlZEV4ZXJjaXNlSW5mb3JtYXRpb24gKGdlbmVyYXRlZEV4ZXJjaXNlOiBHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UpOiBQcm9taXNlPE5DUmVzcG9uc2U8VG9waWNSZXN1bHRbXT4+IHtcbiAgICBmdW5jdGlvbiBjb21wdXRlVGltZVNjb3JlIChpZGVhbFRpbWUsIHRpbWVGaW5pc2gpIHtcbiAgICAgIGlmICh0aW1lRmluaXNoIDw9IGlkZWFsVGltZSkge1xuICAgICAgICByZXR1cm4gMTAwXG4gICAgICB9IGVsc2UgaWYgKHRpbWVGaW5pc2ggPiBpZGVhbFRpbWUgJiYgdGltZUZpbmlzaCA8PSBpZGVhbFRpbWUgKiAyKSB7XG4gICAgICAgIHJldHVybiA3NVxuICAgICAgfSBlbHNlIGlmICh0aW1lRmluaXNoID4gaWRlYWxUaW1lICogMiAmJiB0aW1lRmluaXNoIDw9IGlkZWFsVGltZSAqIDMpIHtcbiAgICAgICAgcmV0dXJuIDUwXG4gICAgICB9IGVsc2UgaWYgKHRpbWVGaW5pc2ggPiBpZGVhbFRpbWUgKiAzICYmIHRpbWVGaW5pc2ggPD0gaWRlYWxUaW1lICogNCkge1xuICAgICAgICByZXR1cm4gMjVcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgcmVzcDIgPSB0aGlzLmdldEV4ZXJjaXNlU3RhdGUoZ2VuZXJhdGVkRXhlcmNpc2UpXG4gICAgaWYgKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhKSB7XG4gICAgICBpZiAocmVzcDIuZGF0YSA9PT0gJ3N1Ym1pdHRlZCcpIHtcbiAgICAgICAgY29uc3QgdG9waWNzID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS5leGVyY2lzZURldGFpbCB8fCAnJykgYXMgR2VuZXJhdGVkVG9waWNFeGVyY2lzZVtdXG4gICAgICAgIHJldHVybiBQcm9taXNlLm1hcCh0b3BpY3MsIHRvcGljID0+IHtcbiAgICAgICAgICBjb25zdCByZXNwID0gdGhpcy5nZXRUb3BpY1N0YXRlKHRvcGljKVxuICAgICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgICAgcmV0dXJuIENvdXJzZVNlcnZpY2UuZ2V0VG9waWModG9waWMudG9waWNJZCkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICB0b3BpY05hbWU6IHJlc3AyLmRhdGEudG9waWMsXG4gICAgICAgICAgICAgICAgICBza2lwcGVkOiByZXNwLmRhdGEgPT09ICdza2lwcGVkJyxcbiAgICAgICAgICAgICAgICAgIHNjb3JlOiBwYXJzZUludCgnJyArIHRvcGljLnNjb3JlLCAxMCksXG4gICAgICAgICAgICAgICAgICBpZGVhbFRpbWU6IHBhcnNlSW50KCcnICsgdG9waWMuaWRlYWxUaW1lLCAxMCksXG4gICAgICAgICAgICAgICAgICB0aW1lRmluaXNoOiAnJyArIHBhcnNlSW50KCcnICsgdG9waWMudGltZUZpbmlzaCwgMTApLFxuICAgICAgICAgICAgICAgICAgdGltZVNjb3JlOiBjb21wdXRlVGltZVNjb3JlKHRvcGljLmlkZWFsVGltZSwgdG9waWMudGltZUZpbmlzaClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZ2V0IHRvcGljIGluZm9ybWF0aW9uOiAke3Jlc3AyLmVyck1lc3NhZ2V9YClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZ2V0IHRvcGljIHN0YXRlOiAnICsgcmVzcC5lcnJNZXNzYWdlKVxuICAgICAgICAgIH1cbiAgICAgICAgfSkudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3VsdHMgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBPbmx5ICdzdWJtaXR0ZWQnIGV4ZXJjaXNlIGNhbiBiZSBwcm9jZXNzZWQhYCB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byBnZXQgZXhlcmNpc2Ugc3RhdGU6ICR7cmVzcDIuZXJyTWVzc2FnZX1gIH0pXG4gICAgfVxuICB9XG5cbiAgLy8gR2l2ZW4gYW4gZXhlcmNpc2Ugd2l0aCBzdGF0ZSAncGVuZGluZ0V4ZXJjaXNlJywgcmV0dXJuIFwiYnJlYWsgcGFnZVwiIGFzc29jaWF0ZWQgd2l0aCBpdFxuICBnZXRQZW5kaW5nVG9waWNJbmZvcm1hdGlvbiAoZ2VuZXJhdGVkRXhlcmNpc2U6IEdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZSk6IFByb21pc2U8TkNSZXNwb25zZTxUb3BpY0luZm9ybWF0aW9uPj4ge1xuICAgIGNvbnN0IHJlc3AyID0gdGhpcy5nZXRFeGVyY2lzZVN0YXRlKGdlbmVyYXRlZEV4ZXJjaXNlKVxuICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgaWYgKHJlc3AyLmRhdGEgPT09ICdwZW5kaW5nRXhlcmNpc2UnKSB7XG4gICAgICAgIGNvbnN0IHRvcGljcyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VEZXRhaWwgfHwgJycpIGFzIEdlbmVyYXRlZFRvcGljRXhlcmNpc2VbXVxuICAgICAgICBsZXQgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZTogUGFydGlhbDxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPiB8IG51bGwgPSBudWxsXG4gICAgICAgIC8vIFRPRE86IENhbiB3ZSB1c2UgdGhpcy5nZXRUb3BpY0V4ZXJjaXNlQnlTdGF0ZSBpbnN0ZWFkP1xuICAgICAgICBsZXQgaWR4XG4gICAgICAgIGZvciAoaWR4ID0gMDsgaWR4IDwgdG9waWNzLmxlbmd0aDsgaWR4KyspIHtcbiAgICAgICAgICBjb25zdCB0b3BpYyA9IHRvcGljc1tpZHhdXG4gICAgICAgICAgaWYgKCF0b3BpYy5zdWJtaXR0ZWQgJiYgdG9waWMuY3JlYXRlZEF0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGdlbmVyYXRlZFRvcGljRXhlcmNpc2UgPSB0b3BpY3NbaWR4XVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gY29uc3QgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSA9IHRvcGljcy5maW5kKHRvcGljID0+ICF0b3BpYy5zdWJtaXR0ZWQgJiYgdG9waWMuY3JlYXRlZEF0ID09PSB1bmRlZmluZWQpXG4gICAgICAgIGlmIChnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlICE9PSBudWxsKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlcyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5leGVyY2lzZURldGFpbCB8fCAnJykgYXMgR2VuZXJhdGVkRXhlcmNpc2VbXVxuICAgICAgICAgICAgY29uc3QgeyBxdWVzdGlvblF1YW50aXR5LCBpZGVhbFRpbWUgfSA9IGdlbmVyYXRlZEV4ZXJjaXNlcy5yZWR1Y2UoKHsgcXVlc3Rpb25RdWFudGl0eSwgaWRlYWxUaW1lIH0sIGdlbkV4ZXJjaXNlKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcXVlc3Rpb25RdWFudGl0eTogcXVlc3Rpb25RdWFudGl0eSArIEpTT04ucGFyc2UoZ2VuRXhlcmNpc2Uua25vd25zKS5sZW5ndGgsXG4gICAgICAgICAgICAgICAgaWRlYWxUaW1lOiBpZGVhbFRpbWUgKyBnZW5FeGVyY2lzZS5pZGVhbFRpbWVcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgeyBxdWVzdGlvblF1YW50aXR5OiAwLCBpZGVhbFRpbWU6IDAgfSlcbiAgICAgICAgICAgIC8vIGNvbnN0IHF1ZXN0aW9uUXVhbnRpdHkgPSBnZW5lcmF0ZWRFeGVyY2lzZXMubGVuZ3RoXG4gICAgICAgICAgICByZXR1cm4gQ291cnNlU2VydmljZS5nZXRUb3BpYyhnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLnRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICB0b3BpY05hbWU6IHJlc3AuZGF0YS50b3BpYyxcbiAgICAgICAgICAgICAgICAgICAgdG9waWNObzogaWR4ICsgMSxcbiAgICAgICAgICAgICAgICAgICAgdG9waWNRdWFudGl0eTogdG9waWNzLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb25RdWFudGl0eSxcbiAgICAgICAgICAgICAgICAgICAgaWRlYWxUaW1lXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBhcyBOQ1Jlc3BvbnNlPFRvcGljSW5mb3JtYXRpb24+XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byByZXRyaWV2ZSB0b3BpYzogJHtyZXNwLmVyck1lc3NhZ2V9YCB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYENvdWxkbid0IHJldHJpZXZlIHBlbmRpbmcgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSFgIH0pXG4gICAgICAgIH1cblxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBPbmx5IGluZm9ybWF0aW9uIGFib3V0ICdwZW5kaW5nRXhlcmNpc2UnIGNhbiBiZSByZXRyaWV2ZWQhYCB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byBnZXQgZXhlcmNpc2Ugc3RhdGU6ICR7cmVzcDIuZXJyTWVzc2FnZX1gIH0pXG4gICAgfVxuICB9XG5cbiAgLy8gR2l2ZW4gYW4gZXhlcmNpc2Ugd2l0aCAncGVuZGluZ0V4ZXJjaXNlJyBzdGF0ZSwgdHVybiBpdCB0byAnZXhlcmNpc2luZycgYW5kIHJldHVyblxuICAvLyBmb3JtYXR0ZWQgZXhlcmNpc2VcbiAgc3RhcnRFeGVyY2lzZSAoZ2VuZXJhdGVkRXhlcmNpc2U6IEdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZSk6IFByb21pc2U8TkNSZXNwb25zZTxGb3JtYXR0ZWRUb3BpY0V4ZXJjaXNlPj4ge1xuICAgIGNvbnN0IHJlc3AyID0gdGhpcy5nZXRFeGVyY2lzZVN0YXRlKGdlbmVyYXRlZEV4ZXJjaXNlKVxuICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgaWYgKHJlc3AyLmRhdGEgPT09ICdwZW5kaW5nRXhlcmNpc2UnKSB7XG4gICAgICAgIC8vIFVwZGF0ZSBzdGF0dXMgZnJvbSAncGVuZGluZ0V4ZXJjaXNlJyB0byAnZXhlcmNpc2luZydcbiAgICAgICAgLy8gVGhpcyBpcyBlc3NlbnRpYWxseSBkb25lIGJ5IGFkZGluZyAnY3JlYXRlZEF0JyBpbnRvIHRoZSBmaXJzdCB1bnN1Ym1pdHRlZCBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlXG4gICAgICAgIC8vIEV4aXN0ZW5jZSBvZiAnY3JlYXRlZEF0JyBmaWVsZCBpZGVudGlmaWVzIHRoYXQgdXNlciBpcyBjdXJyZW50bHkgZXhlcmNpc2luZyBvbiB0aGF0IHRvcGljXG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzOiBQYXJ0aWFsPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+W10gPSBKU09OLnBhcnNlKGdlbmVyYXRlZEV4ZXJjaXNlLmV4ZXJjaXNlRGV0YWlsKVxuICAgICAgICBjb25zdCBleGVyY2lzZUluZGV4ID0gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMuZmluZEluZGV4KGdlbmVyYXRlZFRvcGljRXhlcmNpc2UgPT4ge1xuICAgICAgICAgIC8vIGNvbnNvbGUuZGlyKGdlbmVyYXRlZFRvcGljRXhlcmNpc2UpXG4gICAgICAgICAgcmV0dXJuICFnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLnN1Ym1pdHRlZCAmJiAhKCdjcmVhdGVkQXQnIGluIGdlbmVyYXRlZFRvcGljRXhlcmNpc2UpXG4gICAgICAgIH0pXG4gICAgICAgIGlmIChleGVyY2lzZUluZGV4ICE9PSAtMSkge1xuICAgICAgICAgIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzW2V4ZXJjaXNlSW5kZXhdLmNyZWF0ZWRBdCA9IG1vbWVudCgpLmxvY2FsKCkuZm9ybWF0KCdZWVlZLU1NLUREIEhIOm1tOnNzJylcbiAgICAgICAgICBjb25zb2xlLmRpcignVXBkYXRlaW5nIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzIHRvIGJlOiAnICsgSlNPTi5zdHJpbmdpZnkoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMsIG51bGwsIDIpKVxuICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8R2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlPih7XG4gICAgICAgICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UnLFxuICAgICAgICAgICAgZGF0YTogeyBpZDogZ2VuZXJhdGVkRXhlcmNpc2UuaWQsIGV4ZXJjaXNlRGV0YWlsOiBKU09OLnN0cmluZ2lmeShnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlcykgfVxuICAgICAgICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgLy8gV2UgY2FuIGp1c3QgcGFzcyBnZW5lcmF0ZWRFeGVyY2lzZSB3aXRoIGV4ZXJjaXNlRGV0YWlsIHVwZGF0ZWQgbWFudWFsbHksIGJ1dFxuICAgICAgICAgICAgICAvLyB3ZSB3YW5uYSBtYWtlIHRoYXQgdGhlIHVwZGF0ZSByZWFsbHkgd2VudCB0aHJvdWdoLCBzbyB3ZSByZS1yZWFkIGl0LlxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRHZW5lcmF0ZWRFeGVyY2lzZShnZW5lcmF0ZWRFeGVyY2lzZS5pZCkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb250aW51ZUV4ZXJjaXNlKHJlc3AuZGF0YSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0ZhaWxlZCB0byBnZXQgZ2VuZXJhdGVkRXhlcmNpc2UhJyB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0ZhaWxlZCB0byB1cGRhdGUgZ2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlIScgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdUaGVyZSBpcyBubyB0b3BpYyBleGVyY2lzZSB0byBzdGFydCEnIH0pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgT25seSAncGVuZGluZ0V4ZXJjaXNlJyBjYW4gYmUgc3RhcnRlZCFgIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIGdldCBleGVyY2lzZSBzdGF0ZTogJHtyZXNwMi5lcnJNZXNzYWdlfWAgfSlcbiAgICB9XG4gIH1cblxuICAvLyBHaXZlbiBhbiBleGVyY2lzZSB3aXRoICdleGVyY2lzaW5nJyBzdGF0ZSwgcmV0dXJuIGZvcm1hdHRlZCB2ZXJzaW9uIG9mIGl0XG4gIGNvbnRpbnVlRXhlcmNpc2UgKGdlbmVyYXRlZEV4ZXJjaXNlOiBHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UpOiBQcm9taXNlPE5DUmVzcG9uc2U8Rm9ybWF0dGVkVG9waWNFeGVyY2lzZT4+IHtcbiAgICBjb25zdCByZXNwMiA9IHRoaXMuZ2V0RXhlcmNpc2VTdGF0ZShnZW5lcmF0ZWRFeGVyY2lzZSlcbiAgICBpZiAocmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEpIHtcbiAgICAgIGlmIChyZXNwMi5kYXRhID09PSAnZXhlcmNpc2luZycpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0RXhlcmNpc2UoZ2VuZXJhdGVkRXhlcmNpc2UpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYE9ubHkgJ2V4ZXJjaXNpbmcnIGNhbiBiZSBjb250aW51ZWQhIEV4ZXJjaXNlIHN0YXRlPSR7cmVzcDIuZGF0YX1gIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIGdldCBleGVyY2lzZSBzdGF0ZTogJHtyZXNwMi5lcnJNZXNzYWdlfWAgfSlcbiAgICB9XG4gIH1cblxuICAvLyBHaXZlbiBhbiBleGVyY2lzZSB3aXRoICdmaW5pc2hlZCcgc3RhdGUsIHN1Ym1pdCBpdFxuICBzdWJtaXRFeGVyY2lzZSAoY29tcGV0ZW5jeUV4ZXJjaXNlSWQ6IG51bWJlciwgeyBuYW1lLCBwaG9uZSwgZW1haWwgfSk6IFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0R2VuZXJhdGVkRXhlcmNpc2UoY29tcGV0ZW5jeUV4ZXJjaXNlSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICAgIGNvbnN0IHJlc3AyID0gdGhpcy5nZXRFeGVyY2lzZVN0YXRlKGdlbmVyYXRlZEV4ZXJjaXNlKVxuICAgICAgICBpZiAocmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEpIHtcbiAgICAgICAgICBpZiAocmVzcDIuZGF0YSA9PT0gJ2ZpbmlzaGVkJykge1xuICAgICAgICAgICAgY29uc3QgdG9waWNzID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS5leGVyY2lzZURldGFpbCkgYXMgUGFydGlhbDxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPltdXG4gICAgICAgICAgICBjb25zdCBzY29yZSA9IHRvcGljcy5yZWR1Y2UoKGFjYywgdG9waWMpID0+IGFjYyArICh0b3BpYy5zY29yZSB8fCAwKSwgMClcbiAgICAgICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8R2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlPih7XG4gICAgICAgICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZScsXG4gICAgICAgICAgICAgIGRhdGE6IHsgaWQ6IGdlbmVyYXRlZEV4ZXJjaXNlLmlkLCBzY29yZSwgc3VibWl0dGVkOiB0cnVlLCBuYW1lLCBwaG9uZSwgZW1haWwgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBVbmV4cGVjdGVkIGV4ZXJjaXNlIHN0YXRlOiAncmVzcDIuZGF0YSdgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIGdldCBleGVyY2lzZSBzdGF0ZTogJyArIHJlc3AyLmVyck1lc3NhZ2UgfSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byBnZXRHZW5lcmF0ZWRFeGVyY2lzZTogJHtjb21wZXRlbmN5RXhlcmNpc2VJZH1gIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gR2l2ZW4gYW4gZXhlcmNpc2Ugd2l0aCAnZmluaXNoZWQnIHN0YXRlLCBhYmFuZG9uIGl0XG4gIGFiYW5kb25FeGVyY2lzZSAoZ2VuZXJhdGVkRXhlcmNpc2U6IEdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZSwgdXNlcklkPzogbnVtYmVyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICBjb25zdCByZXNwMiA9IHRoaXMuZ2V0RXhlcmNpc2VTdGF0ZShnZW5lcmF0ZWRFeGVyY2lzZSlcbiAgICBpZiAocmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEpIHtcbiAgICAgIGlmIChyZXNwMi5kYXRhICE9PSAnZmluaXNoZWQnKSB7XG4gICAgICAgIHJldHVybiBzdXBlci51cGRhdGU8R2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlPih7XG4gICAgICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlJyxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBpZDogZ2VuZXJhdGVkRXhlcmNpc2UuaWQsXG4gICAgICAgICAgICBhYmFuZG9uZWQ6IHRydWUsXG4gICAgICAgICAgICBzdWJtaXR0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgdXNlcklkXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGAnZmluaXNoZWQnIGV4ZXJjaXNlIGNhbid0IGJlIGFiYW5kb25lZCFgIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIGdldCBleGVyY2lzZSBzdGF0ZTogJHtyZXNwMi5lcnJNZXNzYWdlfWAgfSlcbiAgICB9XG4gIH1cblxuICBza2lwVG9waWMgKGdlbmVyYXRlZEV4ZXJjaXNlOiBHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UpOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIGNvbnN0IHJlc3AyID0gdGhpcy5nZXRFeGVyY2lzZVN0YXRlKGdlbmVyYXRlZEV4ZXJjaXNlKVxuICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgaWYgKHJlc3AyLmRhdGEgPT09ICdwZW5kaW5nRXhlcmNpc2UnKSB7XG4gICAgICAgIGNvbnN0IHRvcGljcyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VEZXRhaWwpIGFzIFBhcnRpYWw8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT5bXVxuICAgICAgICBjb25zdCByZXNwMyA9IHRoaXMuZ2V0VG9waWNFeGVyY2lzZUJ5U3RhdGUoJ3BlbmRpbmdFeGVyY2lzZScsIHRvcGljcylcbiAgICAgICAgaWYgKHJlc3AzLnN0YXR1cyAmJiByZXNwMy5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgcGVuZGluZ0dlbmVyYXRlZEV4ZXJjaXNlID0gcmVzcDMuZGF0YVxuICAgICAgICAgIHBlbmRpbmdHZW5lcmF0ZWRFeGVyY2lzZS5zdWJtaXR0ZWQgPSB0cnVlXG4gICAgICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2U+KHtcbiAgICAgICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZScsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5pZCxcbiAgICAgICAgICAgICAgZXhlcmNpc2VEZXRhaWw6IEpTT04uc3RyaW5naWZ5KHRvcGljcylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC8vIGNvbnNvbGUuZGlyKHRvcGljcylcbiAgICAgICAgICAvLyByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiAxIH0pIGFzIFByb21pc2U8TkNSZXNwb25zZTxudW1iZXI+PlxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIGdldCBwZW5kaW5nIGV4ZXJjaXNlOiAke3Jlc3AzLmVyck1lc3NhZ2V9YCB9KVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYE9ubHkgZXhlcmNpZSB3aXRoICdwZW5kaW5nRXhlcmNpc2UnIHN0YXRlIGNhbiBiZSBza2lwcGVkIWAgfSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBGYWlsZWQgdG8gZ2V0IGV4ZXJjaXNlIHN0YXRlOiAke3Jlc3AyLmVyck1lc3NhZ2V9YCB9KVxuICAgIH1cbiAgfVxuXG4gIC8vIEZvciBDb21wZXRlbmN5RXhlcmNpc2UsIGZvcm1hdHRpbmcgaXMgZG9uZSBwZXIgdG9waWMsIHRoZSBmaXJzdCB0aGF0IGhhc24ndCBiZWVuIHN1Ym1pdHRlZFxuICAvLyBXZSdyZSBub3QgcmVuZGVyaW5nIGV2ZXJ5dGhpbmcgb25lLXNob3QgbGlrZSBUb3BpY0V4ZXJjaXNlIG9yIEV4ZXJjaXNlXG4gIHByaXZhdGUgZm9ybWF0RXhlcmNpc2UgKGdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZTogR2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEZvcm1hdHRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgY29uc3QgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMgPSBKU09OLnBhcnNlKGdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZS5leGVyY2lzZURldGFpbCkgYXMgUGFydGlhbDxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPltdXG4gICAgY29uc3QgcmVzcCA9IHRoaXMuZ2V0VG9waWNFeGVyY2lzZUJ5U3RhdGUoJ2V4ZXJjaXNpbmcnLCBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlcylcbiAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICBjb25zdCBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICByZXR1cm4gVG9waWNFeGVyY2lzZVNlcnZpY2UuZm9ybWF0RXhlcmNpc2UoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIHJldHVybiByZXNwXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byBmb3JtYXQgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZTogJHtyZXNwLmVyck1lc3NhZ2V9YCB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgVW5hYmxlIHRvIGZpbmQgdG9waWMgZXhlcmNpc2Ugd2l0aCAnZXhlcmNpc2luZycgc3RhdGUhYCB9KVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAgMS4gQ2hlY2sgdGhhdCBpdCdzIG5vdCBhYmFuZG9uZWQgb3IgYWxyZWFkeSBzdWJtaXR0ZWRcbiAgICAyLiBGaW5kIHRoZSBmaXJzdCB1bnN1Ym1pdHRlZCB0b3BpY1xuICAgIDMuIEFuc3dlcnMgYXJlIGFzc3VtZWQgdG8gYmUgZm9yICgyKVxuICAgKi9cbiAgc3VibWl0VG9waWNBbnN3ZXIgKGdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZTogR2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlLCBhbnN3ZXJzOiBDb21wZXRlbmN5RXhlcmNpc2VBbnN3ZXJbXSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkIHlldCEnKVxuICB9XG5cbiAgLy8gR2V0IGFsbCBleGVyY2lzZXMsIGhhc2ggZWFjaCBvZiB0aGVtIGluZGVwZW5kZW50bHksXG4gIC8vIGNvbWJpbmVkIHRoZW0gYWx0b2dldGhlciwgYW5kIGhhc2ggdGhlIGZpbmFsIHJlc3VsdFxuICAvLyBUT0RPOiBNb2RpZnkgcXVhbnRpdHkgb2YgcXVlc3Rpb24gZ2VuZXJhdGVkIHBlciBleGVyY2lzZSB0byB1c2UgbmV3IHZhcmlhYmxlXG4gIHByaXZhdGUgZ2V0RXhlcmNpc2VIYXNoICgpOiBQcm9taXNlPE5DUmVzcG9uc2U8c3RyaW5nPj4ge1xuICAgIHJldHVybiBDb3Vyc2VTZXJ2aWNlLmdldE9yZGVyZWRUb3BpY3MoKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCB0b3BpY3MgPSByZXNwLmRhdGFcbiAgICAgICAgcmV0dXJuIFByb21pc2UubWFwKHRvcGljcywgdG9waWMgPT4ge1xuICAgICAgICAgIHJldHVybiBUb3BpY0V4ZXJjaXNlU2VydmljZS5nZXRFeGVyY2lzZXNIYXNoKHRvcGljLmlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzcC5kYXRhXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBnZXQgaGFzaCBmb3IgdG9waWMgd2l0aCBpZD0ke3RvcGljLmlkfTogJHtyZXNwLmVyck1lc3NhZ2V9YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9KS50aGVuKGhhc2hlcyA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHRoaXMuZ2V0SGFzaEZyb21Ub3BpY0hhc2hlcyhoYXNoZXMpXG4gICAgICAgICAgfSBhcyBOQ1Jlc3BvbnNlPHN0cmluZz5cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBGYWlsZWQgdG8gcmV0cmlldmVkIHRvcGljczogJHtyZXNwLmVyck1lc3NhZ2V9YCB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SGFzaEZyb21Ub3BpY0hhc2hlcyAodG9waWNFeGVyY2lzZUhhc2hlczogc3RyaW5nW10pIHtcbiAgICAvLyBFYWNoIG9mIHRoZSB0b3BpYyBleGVyY2lzZSBoYXNoIGFwcGVuZGVkXG4gICAgY29uc3QgYWxsSGFzaGVzID0gdG9waWNFeGVyY2lzZUhhc2hlcy5yZWR1Y2UoKGFjYywgaGFzaCkgPT4gYWNjICsgaGFzaCwgJycpXG4gICAgcmV0dXJuIEV4ZXJjaXNlR2VuZXJhdG9yLmdldEhhc2goYWxsSGFzaGVzKVxuICB9XG5cbiAgZ2VuZXJhdGVBbmRTYXZlRXhlcmNpc2UgKHVzZXJJZD86IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVFeGVyY2lzZSgpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZTxHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2U+KHtcbiAgICAgICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2UnLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICAgICAgICBhYmFuZG9uZWQ6IGZhbHNlLFxuICAgICAgICAgICAgaGFzaDogZ2VuZXJhdGVkRXhlcmNpc2UuaGFzaCxcbiAgICAgICAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVIsXG4gICAgICAgICAgICBleGVyY2lzZURldGFpbDogZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VEZXRhaWwsXG4gICAgICAgICAgICB1c2VySWRcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIGdlbmVyYXRlIGV4ZXJjaXNlOiAke3Jlc3AuZXJyTWVzc2FnZX1gIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2VuZXJhdGVFeGVyY2lzZSAoKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFBhcnRpYWw8R2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlPj4+IHtcbiAgICByZXR1cm4gQ291cnNlU2VydmljZS5nZXRPcmRlcmVkVG9waWNzKCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3QgdG9waWNzID0gcmVzcC5kYXRhXG4gICAgICAgIHJldHVybiBQcm9taXNlLm1hcCh0b3BpY3MsIHRvcGljID0+IHtcbiAgICAgICAgICByZXR1cm4gVG9waWNFeGVyY2lzZVNlcnZpY2UuZ2VuZXJhdGVFeGVyY2lzZSh0b3BpYy5pZCwgJ2NvbXBldGVuY3lRdWFudGl0eScpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcC5kYXRhICYmIHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0b3BpY0lkOiB0b3BpYy5pZCxcbiAgICAgICAgICAgICAgICB0b3BpY0V4ZXJjaXNlSGFzaDogZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS50b3BpY0V4ZXJjaXNlSGFzaCxcbiAgICAgICAgICAgICAgICBpZGVhbFRpbWU6IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UuaWRlYWxUaW1lLFxuICAgICAgICAgICAgICAgIGV4ZXJjaXNlRGV0YWlsOiBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLmV4ZXJjaXNlRGV0YWlsXG4gICAgICAgICAgICAgIH0gYXMgUGFydGlhbDxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPlxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZ2VuZXJhdGUgZXhlcmNpc2UgZm9yIHRvcGljOiAke3RvcGljLmlkfTogJHtyZXNwLmVyck1lc3NhZ2V9YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9KS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICAgIC8vIFdlIHdhbnQgdG8gc2tpcCBvdmVyIHRvcGljcyB0aGF0IGRvbid0IGhhdmUgZXhlcmNpc2VcbiAgICAgICAgICBjb25zdCBmaWx0ZXJlZFJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgY29uc3QgdG9waWNFeGVyY2lzZURldGFpbCA9IEpTT04ucGFyc2UocmVzdWx0LmV4ZXJjaXNlRGV0YWlsIHx8ICcnKVxuICAgICAgICAgICAgcmV0dXJuIHRvcGljRXhlcmNpc2VEZXRhaWwubGVuZ3RoID4gMFxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgaGFzaDogdGhpcy5nZXRIYXNoRnJvbVRvcGljSGFzaGVzKHJlc3VsdHMubWFwKHJlc3VsdCA9PiByZXN1bHQudG9waWNFeGVyY2lzZUhhc2ggfHwgJycpKSxcbiAgICAgICAgICAgICAgdG9waWNzOiByZXN1bHRzLFxuICAgICAgICAgICAgICBleGVyY2lzZURldGFpbDogSlNPTi5zdHJpbmdpZnkoZmlsdGVyZWRSZXN1bHRzKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gYXMgTkNSZXNwb25zZTxQYXJ0aWFsPEdlbmVyYXRlZENvbXBldGVuY3lFeGVyY2lzZT4+XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIHJldHJpZXZlIHRvcGljczogJHtyZXNwLmVyck1lc3NhZ2V9YCB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHN1Ym1pdFRvcGljRXhlcmNpc2UgKGNvbXBldGVuY3lFeGVyY2lzZUlkOiBudW1iZXIsIGFuc3dlcnM6IFRvcGljRXhlcmNpc2VBbnN3ZXIpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRHZW5lcmF0ZWRFeGVyY2lzZShjb21wZXRlbmN5RXhlcmNpc2VJZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVkRXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgY29uc3QgcmVzcDIgPSB0aGlzLmdldEV4ZXJjaXNlU3RhdGUoZ2VuZXJhdGVkRXhlcmNpc2UpXG4gICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IHN0YXRlID0gcmVzcDIuZGF0YVxuICAgICAgICAgIGNvbnNvbGUubG9nKCdFeGVyY2lzZSBzdGF0ZT0nICsgc3RhdGUpXG4gICAgICAgICAgaWYgKHN0YXRlID09PSAnZXhlcmNpc2luZycpIHtcbiAgICAgICAgICAgIGNvbnN0IHRvcGljcyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VEZXRhaWwpXG4gICAgICAgICAgICBjb25zdCByZXNwMyA9IHRoaXMuZ2V0VG9waWNFeGVyY2lzZUJ5U3RhdGUoJ2V4ZXJjaXNpbmcnLCB0b3BpY3MpXG4gICAgICAgICAgICBpZiAocmVzcDMuc3RhdHVzICYmIHJlc3AzLmRhdGEpIHtcbiAgICAgICAgICAgICAgY29uc3QgdG9waWMgPSByZXNwMy5kYXRhXG4gICAgICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWwgPSBKU09OLnBhcnNlKHRvcGljLmV4ZXJjaXNlRGV0YWlsKSBhcyBQYXJ0aWFsPEdlbmVyYXRlZEV4ZXJjaXNlPltdXG4gICAgICAgICAgICAgIHJldHVybiBUb3BpY0V4ZXJjaXNlU2VydmljZS5ncmFkZUV4ZXJjaXNlKGdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWwsIGFuc3dlcnMpLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgdG9waWMuc3VibWl0dGVkID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgdG9waWMuc3VibWl0dGVkQXQgPSBtb21lbnQoKS5sb2NhbCgpLmZvcm1hdCgnWVlZWS1NTS1ERCBISDptbTpzcycpXG4gICAgICAgICAgICAgICAgICB0b3BpYy5zY29yZSA9IHJlc3AyLmRhdGEuc2NvcmVcbiAgICAgICAgICAgICAgICAgIHRvcGljLnRpbWVGaW5pc2ggPSBFeGVyY2lzZUhlbHBlci5jb3VudFRpbWVGaW5pc2godG9waWMuY3JlYXRlZEF0KVxuICAgICAgICAgICAgICAgICAgdG9waWMuZXhlcmNpc2VEZXRhaWwgPSBKU09OLnN0cmluZ2lmeShUb3BpY0V4ZXJjaXNlU2VydmljZS5pbnNlcnRBbnN3ZXJzKGdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWwsIGFuc3dlcnMpKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1cGVyLnVwZGF0ZTxHZW5lcmF0ZWRDb21wZXRlbmN5RXhlcmNpc2U+KHtcbiAgICAgICAgICAgICAgICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkQ29tcGV0ZW5jeUV4ZXJjaXNlJyxcbiAgICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICAgIGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICBleGVyY2lzZURldGFpbDogSlNPTi5zdHJpbmdpZnkodG9waWNzKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBgRmFpbGVkIHRvIGdyYWRlIGV4ZXJjaXNlOiAke3Jlc3AyLmVyck1lc3NhZ2V9YCB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byBnZXQgJ2V4ZXJjaXNpbmcnIGV4ZXJjaXNlOiAke3Jlc3AzLmVyck1lc3NhZ2V9YCB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBFeHBlY3RpbmcgJ2V4ZXJjaXNpbmcnIHN0YXRlLCBidXQgZ2V0ICcke3N0YXRlfScgaW5zdGVhZCFgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogYEZhaWxlZCB0byBnZXRFeGVyY2lzZVN0YXRlOiAke3Jlc3AyLmVyck1lc3NhZ2V9YCB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IGBGYWlsZWQgdG8gZ2V0R2VuZXJhdGVkRXhlcmNpc2U6ICR7cmVzcC5lcnJNZXNzYWdlfWAgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IENvbXBldGVuY3lFeGVyY2lzZVNlcnZpY2UoKVxuIl19
