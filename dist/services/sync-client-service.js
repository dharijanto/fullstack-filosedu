const path=require("path"),zlib=require("zlib"),axios=require("axios"),md5=require("md5"),Sequelize=require("sequelize"),AppConfig=require(path.join(__dirname,"../app-config")),CRUDService=require(path.join(__dirname,"crud-service")),TAG="SyncService";class SyncService extends CRUDService{constructor(e,t){super(e,t),this.schoolIdentifier=AppConfig.LOCAL_SCHOOL_INFORMATION.identifier}findAllUser(){return this.readOne({modelName:"School",searchClause:{identifier:this.schoolIdentifier}}).then(e=>e.status?this.read({modelName:"User",searchClause:{schoolId:e.data.id}}):e)}findAnalytics(e,t,r){return this.read({modelName:"Analytics",searchClause:{userId:e,updatedAt:{[Sequelize.Op.and]:{[Sequelize.Op.gte]:t,[Sequelize.Op.lte]:r}},onCloud:!1},order:[["updatedAt","DESC"]]})}findSubmittedGeneratedExercises(e,t,r){return this.read({modelName:"GeneratedExercise",searchClause:{userId:e,updatedAt:{[Sequelize.Op.and]:{[Sequelize.Op.gte]:t,[Sequelize.Op.lte]:r}},submitted:!0,onCloud:!1}})}findSubmittedGeneratedTopicExercises(e,t,r){return this.read({modelName:"GeneratedTopicExercise",searchClause:{userId:e,updatedAt:{[Sequelize.Op.and]:{[Sequelize.Op.gte]:t,[Sequelize.Op.lte]:r}},submitted:!0,onCloud:!1}})}findWatchedVideos(e,t,r){return this.read({modelName:"WatchedVideo",searchClause:{userId:e,updatedAt:{[Sequelize.Op.and]:{[Sequelize.Op.gte]:t,[Sequelize.Op.lte]:r}},onCloud:!1}})}sendData(e,t){return new Promise((r,i)=>{this.getServerHash().then(a=>{if(a.status){const s=new Buffer(JSON.stringify({data:{school:{identifier:this.schoolIdentifier,serverHash:a.data.serverHash},users:e,syncTime:t}}),"utf-8");zlib.gzip(s,function(e,t){e?i(e):axios.post(`${AppConfig.CLOUD_INFORMATION.HOST}/synchronization/start`,t,{headers:{"Content-Type":"application/json","Content-Encoding":"gzip"}}).then(e=>{r(e.data)}).catch(i)})}else r(a)}).catch(e=>{i(e)})})}getSyncHistories(){return axios.get(`${AppConfig.CLOUD_INFORMATION.HOST}/synchronization/histories?schoolIdentifier=${this.schoolIdentifier}`).then(e=>{return e.data})}isServerReadyToSync(){return axios.get(`${AppConfig.CLOUD_INFORMATION.HOST}/synchronization/readyToSync?schoolIdentifier=${this.schoolIdentifier}`).then(e=>{const t=e.data;if(t.status){const e=t.data.lastSync;return e?{status:!0,data:{lastSync:e}}:{status:!1,errMessage:"Server does not return lastSync date!"}}return t})}getServerHash(){return this.readOne({modelName:"LocalMetaData",searchClause:{key:"SERVER_HASH"}}).then(e=>e.status?e:this.create({modelName:"LocalMetaData",data:{key:"SERVER_HASH",value:md5(""+new Date)}})).then(e=>{if(e.status){const t=e.data.value;if(t)return{status:!0,data:{serverHash:t}};throw new Error("Server hash is expected but not found!")}return e})}}module.exports=SyncService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9zeW5jLWNsaWVudC1zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiemxpYiIsImF4aW9zIiwibWQ1IiwiU2VxdWVsaXplIiwiQXBwQ29uZmlnIiwiam9pbiIsIl9fZGlybmFtZSIsIkNSVURTZXJ2aWNlIiwiVEFHIiwiU3luY1NlcnZpY2UiLCJbb2JqZWN0IE9iamVjdF0iLCJzZXF1ZWxpemUiLCJtb2RlbHMiLCJzdXBlciIsInRoaXMiLCJzY2hvb2xJZGVudGlmaWVyIiwiTE9DQUxfU0NIT09MX0lORk9STUFUSU9OIiwiaWRlbnRpZmllciIsInJlYWRPbmUiLCJtb2RlbE5hbWUiLCJzZWFyY2hDbGF1c2UiLCJ0aGVuIiwicmVzcCIsInN0YXR1cyIsInJlYWQiLCJzY2hvb2xJZCIsImRhdGEiLCJpZCIsInVzZXJJZCIsInN0YXJ0VGltZSIsImVuZFRpbWUiLCJ1cGRhdGVkQXQiLCJPcCIsImFuZCIsImd0ZSIsImx0ZSIsIm9uQ2xvdWQiLCJvcmRlciIsInN1Ym1pdHRlZCIsInVzZXJzIiwic3luY1RpbWUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImdldFNlcnZlckhhc2giLCJidWZmZXIiLCJCdWZmZXIiLCJKU09OIiwic3RyaW5naWZ5Iiwic2Nob29sIiwic2VydmVySGFzaCIsImd6aXAiLCJlcnIiLCJyZXN1bHQiLCJwb3N0IiwiQ0xPVURfSU5GT1JNQVRJT04iLCJIT1NUIiwiaGVhZGVycyIsIkNvbnRlbnQtVHlwZSIsIkNvbnRlbnQtRW5jb2RpbmciLCJjYXRjaCIsImdldCIsInJhd1Jlc3AiLCJsYXN0U3luYyIsImVyck1lc3NhZ2UiLCJrZXkiLCJjcmVhdGUiLCJ2YWx1ZSIsIkRhdGUiLCJFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLEtBQU9DLFFBQVEsUUFDZkMsS0FBT0QsUUFBUSxRQUVmRSxNQUFRRixRQUFRLFNBQ2hCRyxJQUFNSCxR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RWYsTUFBTXdDLEVBQVd6QyxFQUFLSSxLQUFLcUMsU0FDM0IsT0FBS0EsR0FHS3hDLFFBQVEsRUFBTUcsTUFBT3FDLFNBQUFBLEtBRnJCeEMsUUFBUSxFQUFPeUMsV0FBWSx5Q0FLckMsT0FBTzFDLElBVWJaLGdCQUNFLE9BQU9JLEtBQUtJLFNBQ1ZDLFVBQVcsZ0JBQ1hDLGNBQ0U2QyxJQUFLLGlCQUVONUMsS0FBS0MsR0FDRkEsRUFBS0MsT0FDQUQsRUFFQVIsS0FBS29ELFFBQ1YvQyxVQUFXLGdCQUNYTyxNQUNFdUMsSUFBSyxjQUNMRSxNQUFPakUsSUFBSSxHQUFLLElBQUlrRSxVQUl6Qi9DLEtBQUtDLElBQ04sR0FBSUEsRUFBS0MsT0FBUSxDQUNmLE1BQU0yQixFQUFhNUIsRUFBS0ksS0FBS3lDLE1BQzdCLEdBQUtqQixFQUdILE9BQVEzQixRQUFRLEVBQU1HLE1BQU93QixXQUFBQSxJQUY3QixNQUFNLElBQUltQixNQUFNLDBDQUtsQixPQUFPL0MsS0FNZmdELE9BQU9DLFFBQVU5RCIsImZpbGUiOiJzZXJ2aWNlcy9zeW5jLWNsaWVudC1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuY29uc3QgemxpYiA9IHJlcXVpcmUoJ3psaWInKVxuXG5jb25zdCBheGlvcyA9IHJlcXVpcmUoJ2F4aW9zJylcbmNvbnN0IG1kNSA9IHJlcXVpcmUoJ21kNScpXG5jb25zdCBTZXF1ZWxpemUgPSByZXF1aXJlKCdzZXF1ZWxpemUnKVxuXG5jb25zdCBBcHBDb25maWcgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAtY29uZmlnJykpXG5jb25zdCBDUlVEU2VydmljZSA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2NydWQtc2VydmljZScpKVxuXG5jb25zdCBUQUcgPSAnU3luY1NlcnZpY2UnXG5jbGFzcyBTeW5jU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IgKHNlcXVlbGl6ZSwgbW9kZWxzKSB7XG4gICAgc3VwZXIoc2VxdWVsaXplLCBtb2RlbHMpXG4gICAgdGhpcy5zY2hvb2xJZGVudGlmaWVyID0gQXBwQ29uZmlnLkxPQ0FMX1NDSE9PTF9JTkZPUk1BVElPTi5pZGVudGlmaWVyXG4gIH1cblxuICBmaW5kQWxsVXNlciAoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZSh7XG4gICAgICBtb2RlbE5hbWU6ICdTY2hvb2wnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7XG4gICAgICAgIGlkZW50aWZpZXI6IHRoaXMuc2Nob29sSWRlbnRpZmllclxuICAgICAgfVxuICAgIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVhZCh7XG4gICAgICAgICAgbW9kZWxOYW1lOiAnVXNlcicsXG4gICAgICAgICAgc2VhcmNoQ2xhdXNlOiB7XG4gICAgICAgICAgICBzY2hvb2xJZDogcmVzcC5kYXRhLmlkXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3BcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gdXNlcklkOiBbbnVtYmVyXVxuICAvLyBsYXN0VXBkYXRlZEF0OiAnMjAxOC0wNy0wNCBoaDptbTpzcydcbiAgZmluZEFuYWx5dGljcyAodXNlcklkLCBzdGFydFRpbWUsIGVuZFRpbWUpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkKHtcbiAgICAgIG1vZGVsTmFtZTogJ0FuYWx5dGljcycsXG4gICAgICBzZWFyY2hDbGF1c2U6IHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB1cGRhdGVkQXQ6IHtcbiAgICAgICAgICBbU2VxdWVsaXplLk9wLmFuZF06IHtcbiAgICAgICAgICAgIFtTZXF1ZWxpemUuT3AuZ3RlXTogc3RhcnRUaW1lLFxuICAgICAgICAgICAgW1NlcXVlbGl6ZS5PcC5sdGVdOiBlbmRUaW1lXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBvbkNsb3VkOiBmYWxzZVxuICAgICAgfSxcbiAgICAgIG9yZGVyOiBbWyd1cGRhdGVkQXQnLCAnREVTQyddXVxuICAgIH0pXG4gIH1cblxuICBmaW5kU3VibWl0dGVkR2VuZXJhdGVkRXhlcmNpc2VzICh1c2VySWQsIHN0YXJ0VGltZSwgZW5kVGltZSkge1xuICAgIHJldHVybiB0aGlzLnJlYWQoe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkRXhlcmNpc2UnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgdXBkYXRlZEF0OiB7XG4gICAgICAgICAgW1NlcXVlbGl6ZS5PcC5hbmRdOiB7XG4gICAgICAgICAgICBbU2VxdWVsaXplLk9wLmd0ZV06IHN0YXJ0VGltZSxcbiAgICAgICAgICAgIFtTZXF1ZWxpemUuT3AubHRlXTogZW5kVGltZVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgc3VibWl0dGVkOiB0cnVlLFxuICAgICAgICBvbkNsb3VkOiBmYWxzZVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBmaW5kU3VibWl0dGVkR2VuZXJhdGVkVG9waWNFeGVyY2lzZXMgKHVzZXJJZCwgc3RhcnRUaW1lLCBlbmRUaW1lKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZCh7XG4gICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlJyxcbiAgICAgIHNlYXJjaENsYXVzZToge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHVwZGF0ZWRBdDoge1xuICAgICAgICAgIFtTZXF1ZWxpemUuT3AuYW5kXToge1xuICAgICAgICAgICAgW1NlcXVlbGl6ZS5PcC5ndGVdOiBzdGFydFRpbWUsXG4gICAgICAgICAgICBbU2VxdWVsaXplLk9wLmx0ZV06IGVuZFRpbWVcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHN1Ym1pdHRlZDogdHJ1ZSxcbiAgICAgICAgb25DbG91ZDogZmFsc2VcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZmluZFdhdGNoZWRWaWRlb3MgKHVzZXJJZCwgc3RhcnRUaW1lLCBlbmRUaW1lKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZCh7XG4gICAgICBtb2RlbE5hbWU6ICdXYXRjaGVkVmlkZW8nLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgdXBkYXRlZEF0OiB7XG4gICAgICAgICAgW1NlcXVlbGl6ZS5PcC5hbmRdOiB7XG4gICAgICAgICAgICBbU2VxdWVsaXplLk9wLmd0ZV06IHN0YXJ0VGltZSxcbiAgICAgICAgICAgIFtTZXF1ZWxpemUuT3AubHRlXTogZW5kVGltZVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgb25DbG91ZDogZmFsc2VcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgc2VuZERhdGEgKHVzZXJzLCBzeW5jVGltZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldFNlcnZlckhhc2goKS50aGVuIChyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEJ1ZmZlcihKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIHNjaG9vbDoge1xuICAgICAgICAgICAgICAgIGlkZW50aWZpZXI6IHRoaXMuc2Nob29sSWRlbnRpZmllcixcbiAgICAgICAgICAgICAgICBzZXJ2ZXJIYXNoOiByZXNwLmRhdGEuc2VydmVySGFzaFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB1c2VycyxcbiAgICAgICAgICAgICAgc3luY1RpbWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KSwgJ3V0Zi04JylcblxuICAgICAgICAgIHpsaWIuZ3ppcChidWZmZXIsIGZ1bmN0aW9uKGVyciwgcmVzdWx0KSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBheGlvcy5wb3N0KGAke0FwcENvbmZpZy5DTE9VRF9JTkZPUk1BVElPTi5IT1NUfS9zeW5jaHJvbml6YXRpb24vc3RhcnRgLCByZXN1bHQgLCB7XG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgICAgICAgICdDb250ZW50LUVuY29kaW5nJzogJ2d6aXAnXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcC5kYXRhKVxuICAgICAgICAgICAgICB9KS5jYXRjaChyZWplY3QpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKHJlc3ApXG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJlamVjdChlcnIpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBnZXRTeW5jSGlzdG9yaWVzICgpIHtcbiAgICByZXR1cm4gYXhpb3MuZ2V0KGAke0FwcENvbmZpZy5DTE9VRF9JTkZPUk1BVElPTi5IT1NUfS9zeW5jaHJvbml6YXRpb24vaGlzdG9yaWVzP3NjaG9vbElkZW50aWZpZXI9JHt0aGlzLnNjaG9vbElkZW50aWZpZXJ9YCkudGhlbihyYXdSZXNwID0+IHtcbiAgICAgIGNvbnN0IHJlc3AgPSByYXdSZXNwLmRhdGFcbiAgICAgIHJldHVybiByZXNwXG4gICAgfSlcbiAgfVxuXG5cbiAgaXNTZXJ2ZXJSZWFkeVRvU3luYyAoKSB7XG4gICAgcmV0dXJuIGF4aW9zLmdldChgJHtBcHBDb25maWcuQ0xPVURfSU5GT1JNQVRJT04uSE9TVH0vc3luY2hyb25pemF0aW9uL3JlYWR5VG9TeW5jP3NjaG9vbElkZW50aWZpZXI9JHt0aGlzLnNjaG9vbElkZW50aWZpZXJ9YCkudGhlbihyYXdSZXNwID0+IHtcbiAgICAgIGNvbnN0IHJlc3AgPSByYXdSZXNwLmRhdGFcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAvLyBEYXRlIHdoZW4gc2VydmVyIGxhc3Qgc3luY2VkIHdpdGggdGhpcyBzY2hvb2xcbiAgICAgICAgY29uc3QgbGFzdFN5bmMgPSByZXNwLmRhdGEubGFzdFN5bmNcbiAgICAgICAgaWYgKCFsYXN0U3luYykge1xuICAgICAgICAgIHJldHVybiB7c3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ1NlcnZlciBkb2VzIG5vdCByZXR1cm4gbGFzdFN5bmMgZGF0ZSEnfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7c3RhdHVzOiB0cnVlLCBkYXRhOiB7bGFzdFN5bmN9fVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcmVzcFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvKlxuICAgIEdldCBhIHBlcnNpc3RlbnQgaGFzaCB0aGF0IGlzIGRlc3Ryb3llZCBvbmx5IHdoZW4gdGhlcmUncyBhIGNsb3VkLXRvLWxvY2FsIHN5bmMgdXNpbmdcbiAgICBteXNxbGR1bXAuIFRoaXMgcGVyc2lzdGVudCBoYXNoIGlzIHNlbmQgdG8gc2VydmVyIHNvIHRoYXQgc2VydmVyIGtub3dzIHdoaWNoIHN5bmMgbWFwcGluZ1xuICAgIHRvIHVzZSB3aGVuIHByb2Nlc3NpbmcgdGhlIGRhdGEuXG4gICovXG4gIGdldFNlcnZlckhhc2ggKCkge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmUoe1xuICAgICAgbW9kZWxOYW1lOiAnTG9jYWxNZXRhRGF0YScsXG4gICAgICBzZWFyY2hDbGF1c2U6IHtcbiAgICAgICAga2V5OiAnU0VSVkVSX0hBU0gnXG4gICAgICB9XG4gICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICByZXR1cm4gcmVzcFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHtcbiAgICAgICAgICBtb2RlbE5hbWU6ICdMb2NhbE1ldGFEYXRhJyxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBrZXk6ICdTRVJWRVJfSEFTSCcsXG4gICAgICAgICAgICB2YWx1ZTogbWQ1KCcnICsgbmV3IERhdGUoKSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICBjb25zdCBzZXJ2ZXJIYXNoID0gcmVzcC5kYXRhLnZhbHVlXG4gICAgICAgIGlmICghc2VydmVySGFzaCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2VydmVyIGhhc2ggaXMgZXhwZWN0ZWQgYnV0IG5vdCBmb3VuZCEnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7c3RhdHVzOiB0cnVlLCBkYXRhOiB7c2VydmVySGFzaH19XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFN5bmNTZXJ2aWNlXG4iXX0=
