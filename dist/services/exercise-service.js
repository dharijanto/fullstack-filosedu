"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),exercise_generator_1=require("../lib/exercise_generator/exercise-generator"),crud_service_neo_1=require("./crud-service-neo"),exercise_helper_1=require("../app/utils/exercise-helper");let path=require("path"),log=require("npmlog"),pug=require("pug"),moment=require("moment"),Sequelize=require("sequelize");const AppConfig=require(path.join(__dirname,"../app-config")),Utils=require(path.join(__dirname,"../lib/utils")),TAG="ExerciseService";class ExerciseService extends crud_service_neo_1.default{getFormattedExercise(e,r){return Promise.join(this.getExercise(e),this.getGeneratedExercise(r,e)).spread((e,t)=>{if(e.status&&e.data){const s=e.data,i=exercise_generator_1.default.getHash(s.data);if(t.status&&t.data&&t.data.exerciseHash===i){const e=t.data;return this.formatExercise(s,e)}if(t.status&&t.data&&t.data.exerciseHash!==i||!t.status)return this.generateAndSaveExercise(s,r).then(e=>e.status&&e.data?this.formatExercise(s,e.data):{status:!1,errMessage:e.errMessage});throw new Error(`Unexpected error: resp1=${JSON.stringify(e)} resp2=${JSON.stringify(t)}`)}throw new Error("Failed to retrieve exercise: "+e.errMessage)})}getExercise(e){return this.readOne({modelName:"Exercise",searchClause:{id:e},include:[{model:this.getModels("Subtopic"),include:[{model:this.getModels("Topic")}]}]})}generateAndSaveExercise(e,r){return this.generateExercise(e,"quantity").then(t=>{if(t.status&&t.data){const s=t.data;return this.getModels("GeneratedExercise").destroy({where:{userId:r,exerciseId:e.id,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}}).then(()=>this.create({modelName:"GeneratedExercise",data:{exerciseHash:s.exerciseHash,knowns:s.knowns,unknowns:s.unknowns,exerciseId:s.exerciseId,userId:r,idealTime:s.idealTime,onCloud:AppConfig.CLOUD_SERVER}}))}return{status:!1,errMessage:t.errMessage}})}formatExercise(e,r){const t=exercise_generator_1.default.getExerciseSolver(e.data),s=JSON.parse(r.knowns),i=JSON.parse(r.unknowns);return Promise.join(Promise.map(s,e=>t.formatQuestion(e)),Promise.map(i,e=>Object.keys(e))).spread((t,s)=>({status:!0,data:{exerciseId:e.id,idealTime:r.idealTime,elapsedTime:Utils.getElapsedTime(r.createdAt),formattedExercise:{renderedQuestions:t,unknowns:s}}}))}generateExercise(e,r){try{let t=exercise_generator_1.default.getExerciseSolver(e.data),s=t.generateQuestions(r),i=[],a=[],n=[],u=[];return s.forEach(e=>{i.push(e.knowns),a.push(e.unknowns),n.push(Object.keys(e.unknowns))}),Promise.all(u).then(r=>({status:!0,data:{exerciseHash:exercise_generator_1.default.getHash(e.data),knowns:JSON.stringify(i),unknowns:JSON.stringify(a),submitted:!1,idealTime:t.getExerciseIdealTime(s.length),exerciseId:e.id}}))}catch(e){return Promise.reject(e)}}updateGeneratedExercise(e){return this.update({modelName:"GeneratedExercise",data:e})}getGeneratedExercise(e,r){return this.readOne({modelName:"GeneratedExercise",searchClause:{userId:e,exerciseId:r,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}})}getExerciseStars(e,r){return this.getSequelize().query(`\nSELECT score FROM generatedExercises\nWHERE submitted = 1 AND userId = ${e} AND exerciseId = ${r}\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{stars:e.reduce((e,r)=>parseInt(r.score,10)>=80?e+1:e,0)}}})}getRenderedExerciseStars(e,r){return this.getExerciseStars(e,r).then(e=>{if(e.status){const r=e.data.stars;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/stars.pug"),{stars:r})}}return e})}getSubtopicStar(e,r){return this.read({modelName:"Exercise",searchClause:{subtopicId:r}}).then(r=>Promise.map(r.data||[],r=>this.getExerciseStars(e,r.id)).then(e=>{return{status:!0,data:{stars:e.reduce((e,r)=>e+r.data.stars,0)/(e.length||1)}}}))}getExerciseTimers(e,r){return this.getSequelize().query(`\nSELECT score FROM generatedExercises\nWHERE submitted = 1 AND userId = ${e} AND exerciseId = ${r}\nAND timeFinish < idealTime AND score = 100\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{timers:e.reduce((e,r)=>parseInt(r.score,10)>=100?e+1:e,0)}}})}getRenderedExerciseTimers(e,r){return this.getExerciseTimers(e,r).then(e=>{if(e.status){const r=e.data.timers;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/timers.pug"),{timers:r})}}return e})}getSubtopicExerciseTimers(e,r){return this.read({modelName:"Exercise",searchClause:{subtopicId:r}}).then(r=>Promise.map(r.data||[],r=>this.getExerciseTimers(e,r.id)).then(e=>{return{status:!0,data:{timers:e.reduce((e,r)=>e+r.data.timers,0)/(e.length||1)}}}))}getExerciseRanking(e){return this.getSequelize().query(`SELECT MIN(timeFinish) AS timeFinish, userId, users.fullName AS fullName, users.grade AS grade, schools.name AS schoolName\nFROM generatedExercises INNER JOIN users ON users.id = generatedExercises.userId INNER JOIN schools ON schools.id = users.schoolId\nWHERE submitted = TRUE AND exerciseId = ${e} AND score = 100 AND timeFinish IS NOT NULL GROUP BY userId ORDER BY MIN(timeFinish) LIMIT 10;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getExerciseLeaderboard(e){return this.getExerciseRanking(e).then(e=>{if(e.status){const r=e.data;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ranking.pug"),{exerciseData:r})}}return e})}getCurrentRanking(e,r){return new Promise((t,s)=>{let i=`SELECT COUNT(*) AS total\n  FROM (SELECT COUNT(*) FROM generatedExercises\n  WHERE submitted = TRUE AND timeFinish < ${e} AND\n        exerciseId = ${r} AND score = 100 AND timeFinish IS NOT NULL\n  GROUP BY userId\n  ORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(i,{type:Sequelize.QueryTypes.SELECT}).then(e=>{t({status:!0,data:{count:e[0].total}})}).catch(e=>{s(e)})})}getTotalRanking(e){return new Promise((r,t)=>{let s=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedExercises WHERE submitted = TRUE AND exerciseId = ${e}\n                      AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(s,{type:Sequelize.QueryTypes.SELECT}).then(e=>{r({status:!0,data:{count:e[0].total}})}).catch(e=>{t(e)})})}finishExercise(e,r,t){return this.getGeneratedExercise(r,e).then(e=>{if(e.status&&e.data){const r=e.data;return this.gradeExercise(r,t).then(e=>{if(e.status&&e.data){const s=e.data;return this.updateGeneratedExercise({id:r.id,score:s.score,userAnswer:JSON.stringify(t),submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),timeFinish:s.timeFinish}).then(e=>e.status?{status:!0,data:s}:{status:!1,errMessage:"Failed to update generatedExercise: "+e.errMessage})}return{status:!1,errMessage:"Failed to grade exercise: "+e.errMessage}})}return{status:!1,errMessage:"Failed to get generatedExercise: "+e.errMessage}})}gradeExercise(e,r){return this.getExercise(e.exerciseId).then(t=>{if(t.status&&t.data){const s=t.data,i=JSON.parse(e.knowns),a=JSON.parse(e.unknowns),n=exercise_generator_1.default.getExerciseSolver(s.data);if(i.length!==r.length)return{status:!1,errMessage:"Unexpected number of answers!"};{const{numCorrectAnswers:t,correctAnswers:s,isCorrect:u}=i.reduce((e,t,s)=>{const i=n.isAnswer(t,r[s]);return e.isCorrect.push(i),e.numCorrectAnswers+=i?1:0,e.correctAnswers.push(a[s]),e},{numCorrectAnswers:0,correctAnswers:[],isCorrect:[]}),d=i.length;return{status:!0,data:{numQuestions:d,numCorrectAnswers:t,correctAnswers:s,isCorrect:u,timeFinish:exercise_helper_1.default.countTimeFinish(e.createdAt),score:parseFloat(t)/d*100}}}}return{status:!1,errMessage:"Faile to get exercise: "+t.errMessage}})}}exports.default=new ExerciseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9leGVyY2lzZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJjcnVkX3NlcnZpY2VfbmVvXzEiLCJleGVyY2lzZV9oZWxwZXJfMSIsInBhdGgiLCJsb2ciLCJwdWciLCJtb21lbnQiLCJTZXF1ZWxpemUiLCJBcHBDb25maWciLCJqb2luIiwiX19kaXJuYW1lIiwiVXRpbHMiLCJUQUciLCJFeGVyY2lzZVNlcnZpY2UiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwiZXhlcmNpc2VJZCIsInVzZXJJZCIsInRoaXMiLCJnZXRFeGVyY2lzZSIsImdldEdlbmVyYXRlZEV4ZXJjaXNlIiwic3ByZWFkIiwicmVzcDEiLCJyZXNwMiIsInN0YXR1cyIsImRhdGEiLCJleGVyY2lzZSIsImV4ZXJjaXNlSGFzaCIsImdldEhhc2giLCJnZW5lcmF0ZWRFeGVyY2lzZSIsImZvcm1hdEV4ZXJjaXNlIiwiZ2VuZXJhdGVBbmRTYXZlRXhlcmNpc2UiLCJ0aGVuIiwicmVzcCIsImVyck1lc3NhZ2UiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZWFkT25lIiwibW9kZWxOYW1lIiwic2VhcmNoQ2xhdXNlIiwiaWQiLCJpbmNsdWRlIiwibW9kZWwiLCJnZXRNb2RlbHMiLCJnZW5lcmF0ZUV4ZXJjaXNlIiwidW5zYXZlZEdlbmVyYXRlZEV4ZXJjaXNlIiwiZGVzdHJveSIsIndoZXJlIiwic3VibWl0dGVkIiwib25DbG91ZCIsIkNMT1VEX1NFUlZFUiIsImNyZWF0ZSIsImtub3ducyIsInVua25vd25zIiwiaWRlYWxUaW1lIiwic29sdmVyIiwiZ2V0RXhlcmNpc2VTb2x2ZXIiLCJwYXJzZSIsIm1hcCIsImtub3duIiwiZm9ybWF0UXVlc3Rpb24iLCJ1bmtub3duIiwiT2JqZWN0Iiwia2V5cyIsInJlbmRlcmVkUXVlc3Rpb25zIiwiZWxhcHNlZFRpbWUiLCJnZXRFbGFwc2VkVGltZSIsImNyZWF0ZWRBdCIsImZvcm1hdHRlZEV4ZXJjaXNlIiwicXVhbnRpdHlWYXJpYWJsZU5hbWUiLCJleGVyY2lzZVNvbHZlciIsInF1ZXN0aW9ucyIsImdlbmVyYXRlUXVlc3Rpb25zIiwidW5rbm93bnNWYXJpYWJsZXMiLCJmb3JtYXR0ZWRRdWVzdGlvbnNQcm9taXNlcyIsImZvckVhY2giLCJxdWVzdGlvbiIsInB1c2giLCJhbGwiLCJnZXRFeGVyY2lzZUlkZWFsVGltZSIsImxlbmd0aCIsImVyciIsInJlamVjdCIsInVwZGF0ZSIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJkYXRhcyIsInN0YXJzIiwicmVkdWNlIiwiYWNjIiwicGFyc2VJbnQiLCJzY29yZSIsImdldEV4ZXJjaXNlU3RhcnMiLCJyZW5kZXJGaWxlIiwic3VidG9waWNJZCIsInJlYWQiLCJ0aW1lcnMiLCJnZXRFeGVyY2lzZVRpbWVycyIsImdldEV4ZXJjaXNlUmFua2luZyIsImV4ZXJjaXNlRGF0YSIsInRpbWVGaW5pc2giLCJyZXNvbHZlIiwicXVlcnlEQiIsImNvdW50IiwidG90YWwiLCJjYXRjaCIsImFuc3dlcnMiLCJncmFkZUV4ZXJjaXNlIiwiZ3JhZGUiLCJ1cGRhdGVHZW5lcmF0ZWRFeGVyY2lzZSIsInVzZXJBbnN3ZXIiLCJzdWJtaXR0ZWRBdCIsImxvY2FsIiwiZm9ybWF0IiwibnVtQ29ycmVjdEFuc3dlcnMiLCJjb3JyZWN0QW5zd2VycyIsImlzQ29ycmVjdCIsImluZGV4IiwiaXNDb3JyZWN0QW5zd2VyIiwiaXNBbnN3ZXIiLCJudW1RdWVzdGlvbnMiLCJjb3VudFRpbWVGaW5pc2giLCJwYXJzZUZsb2F0IiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFDQUMscUJBQUFELFFBQUEsZ0RBQ0FFLG1CQUFBRixRQUFBLHNCQUVBRyxrQkFBQUgsUUFBQSxnQ0FHQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFB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Q3RDQyxFQUFXbEIsS0FBS3NCLE1BQU03QixFQUFrQnlCLFVBQ3hDRSxFQUFTeEQscUJBQUFjLFFBQWtCMkMsa0JBQWtCL0IsRUFBU0QsTUFFNUQsR0FBSTRCLEVBQU80QixTQUFXNkIsRUFBUTdCLE9BQzVCLE9BQVN6RCxRQUFRLEVBQU9VLFdBQVksaUNBQy9CLENBQ0wsTUFBTW9GLGtCQUFFQSxFQUFpQkMsZUFBRUEsRUFBY0MsVUFBRUEsR0FBY25FLEVBQU91QyxPQUFPLENBQUNDLEVBQUtqQyxFQUFPNkQsS0FDbEYsTUFBTUMsRUFBa0JsRSxFQUFPbUUsU0FBUy9ELEVBQU9rRCxFQUFRVyxJQUl2RCxPQUhBNUIsRUFBSTJCLFVBQVUxQyxLQUFLNEMsR0FDbkI3QixFQUFJeUIsbUJBQXFCSSxFQUFrQixFQUFJLEVBQy9DN0IsRUFBSTBCLGVBQWV6QyxLQUFLeEIsRUFBU21FLElBQzFCNUIsSUFDSnlCLGtCQUFtQixFQUFHQyxrQkFBb0JDLGVBQ3pDSSxFQUFldkUsRUFBTzRCLE9BVTVCLE9BQVN6RCxRQUFRLEVBQU1DLE1BUnJCbUcsYUFBQUEsRUFDQU4sa0JBQUFBLEVBQ0FDLGVBQUFBLEVBQ0FDLFVBQUFBLEVBQ0FoQixXQUFZdEcsa0JBQUFZLFFBQWUrRyxnQkFBZ0JoRyxFQUFrQnVDLFdBQzdEMkIsTUFBTytCLFdBQVdSLEdBQXFCTSxFQUFlLE9BTTFELE9BQVNwRyxRQUFRLEVBQU9VLFdBQVksMEJBQTRCRCxFQUFLQyxlQU03RTZGLFFBQUFqSCxRQUFlLElBQUlEIiwiZmlsZSI6InNlcnZpY2VzL2V4ZXJjaXNlLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IENSVURTZXJ2aWNlIGZyb20gJy4vY3J1ZC1zZXJ2aWNlLW5lbydcbmltcG9ydCBCcnV0ZWZvcmNlU29sdmVyLCB7IEdlbmVyYXRlZFF1ZXN0aW9uRGF0YSB9IGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2Vfc29sdmVycy9icnV0ZWZvcmNlLXNvbHZlcidcbmltcG9ydCBFeGVyY2lzZUhlbHBlciBmcm9tICcuLi9hcHAvdXRpbHMvZXhlcmNpc2UtaGVscGVyJ1xuaW1wb3J0IHsgUXVhbnRpdHlWYXJpYWJsZU5hbWUgfSBmcm9tICcuLi9saWIvZXhlcmNpc2VfZ2VuZXJhdG9yL2V4ZXJjaXNlX3NvbHZlcnMvZXhlcmNpc2Utc29sdmVyJztcblxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxubGV0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5sZXQgcHVnID0gcmVxdWlyZSgncHVnJylcbmxldCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKVxubGV0IFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpXG5cbmNvbnN0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC1jb25maWcnKSlcbmNvbnN0IFV0aWxzID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbGliL3V0aWxzJykpXG5jb25zdCBUQUcgPSAnRXhlcmNpc2VTZXJ2aWNlJ1xuXG5leHBvcnQgdHlwZSBFeGVyY2lzZUFuc3dlciA9IEFycmF5PHtba2V5OiBzdHJpbmddOiBzdHJpbmd9PlxuZXhwb3J0IGludGVyZmFjZSBFeGVyY2lzZUdyYWRlIHtcbiAgbnVtUXVlc3Rpb25zOiBudW1iZXJcbiAgbnVtQ29ycmVjdEFuc3dlcnM6IG51bWJlclxuICBjb3JyZWN0QW5zd2VyczogQXJyYXk8e1trZXk6IHN0cmluZ106IGFueX0+XG4gIGlzQ29ycmVjdDogQXJyYXk8Ym9vbGVhbj5cbiAgc2NvcmU6IG51bWJlclxuICB0aW1lRmluaXNoOiBzdHJpbmdcbn1cblxuLypcbiAgSW1wb3J0YW50IE5vdGU6XG4gICAgZ2VuZXJhdGVkRXhlcmNpc2VzIGFuZCBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlcyBoYXMgJ29uQ2xvdWQnIGNvbHVtblxuICAgIHdoaWNoIGluZGljYXRlIHRoYXQgdGhlIGRhdGEgaXMgYWxyZWFkeSBvbiB0aGUgY2xvdWQgYW5kIHdlIGRvbid0IG5lZWQgdG9cbiAgICBzZW5kIHRoZW0gYWdhaW4gd2hlbiBzeW5jaW5nLiBTaW5jZSBhbGwgcm93cyB3aXRoIG9uQ2xvdWQgPT09IHRydWVcbiAgICB3b3VsZG4ndCBiZSBzeW5jZWQgdG8gdGhlIHNlcnZlciwgd2Ugc2hvdWxkbid0IHJlc3RvcmUgZ2VuZXJhdGVkRXhlcmNpc2VzXG4gICAgb3IgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMgd2hvc2Ugb25DbG91ZCAhPSBBcHBDb25maWcuQ0xPVURfU0VSVkVSLlxuICAgIFJlbWVtYmVyIHRvIHNldCB0aGUgdmFsdWUgcHJvcGVybHkhXG4qL1xuY2xhc3MgRXhlcmNpc2VTZXJ2aWNlIGV4dGVuZHMgQ1JVRFNlcnZpY2Uge1xuICAvLyBHZXQgYSBHZW5lcmF0ZWRFeGVyY2lzZSBpbiBhIGZvcm1hdCByZWFkeSBmb3IgdXNlLiBJZiB0aGVyZSdzIHByZXZpb3VzbHkgZ2VuZXJhdGVkXG4gIC8vIHRoYXQgaGFzbid0IGJlZW4gc3VibWl0dGVkLCB0aGlzIHdpbGwgcmVzdG9yZSBpdC4gT3RoZXJ3aXNlLCBpdCdsbCBnZW5lcmF0ZSBvbmUuXG4gIGdldEZvcm1hdHRlZEV4ZXJjaXNlIChleGVyY2lzZUlkLCB1c2VySWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8Rm9ybWF0dGVkU3VidG9waWNFeGVyY2lzZT4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5qb2luPGFueT4oXG4gICAgICB0aGlzLmdldEV4ZXJjaXNlKGV4ZXJjaXNlSWQpLFxuICAgICAgdGhpcy5nZXRHZW5lcmF0ZWRFeGVyY2lzZSh1c2VySWQsIGV4ZXJjaXNlSWQpXG4gICAgKS5zcHJlYWQoKHJlc3AxOiBOQ1Jlc3BvbnNlPEV4ZXJjaXNlPiAsIHJlc3AyOiBOQ1Jlc3BvbnNlPEdlbmVyYXRlZEV4ZXJjaXNlPikgPT4ge1xuICAgICAgaWYgKHJlc3AxLnN0YXR1cyAmJiByZXNwMS5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGV4ZXJjaXNlID0gcmVzcDEuZGF0YVxuICAgICAgICBjb25zdCBleGVyY2lzZUhhc2ggPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRIYXNoKGV4ZXJjaXNlLmRhdGEpXG4gICAgICAgIC8vIFRoZXJlJ3MgdW5zdWJtaXR0ZWQgR2VuZXJhdGVkRXhlcmNpc2UgdGhhdCBjYW4gYmUgcmVzdG9yZWRcbiAgICAgICAgaWYgKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmIHJlc3AyLmRhdGEuZXhlcmNpc2VIYXNoID09PSBleGVyY2lzZUhhc2gpIHtcbiAgICAgICAgICBjb25zdCBnZW5lcmF0ZWRFeGVyY2lzZSA9IHJlc3AyLmRhdGFcbiAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRFeGVyY2lzZShleGVyY2lzZSwgZ2VuZXJhdGVkRXhlcmNpc2UpXG4gICAgICAgICAgLy8gVW5zdWJtaXR0ZWQgR2VuZXJhdGVkRXhlcmNpc2UgY2FuIG5vIGxvbmdlciBiZSB1c2VkIG9yIHRoZXJlJ3Mgbm9uZVxuICAgICAgICB9IGVsc2UgaWYgKChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJiByZXNwMi5kYXRhLmV4ZXJjaXNlSGFzaCAhPT0gZXhlcmNpc2VIYXNoKSB8fCAhcmVzcDIuc3RhdHVzKSB7XG4gICAgICAgICAgLy8gVE9ETzogV2Ugd2FubmEgY29tYmluZSBnZW5lcmF0ZUV4ZXJjaXNlIGFuZCBzYXZlR2VuZXJhdGVkRXhlcmNpc2UgYWx0b2dldGhlclxuICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYXRlQW5kU2F2ZUV4ZXJjaXNlKGV4ZXJjaXNlLCB1c2VySWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEV4ZXJjaXNlKGV4ZXJjaXNlLCByZXNwLmRhdGEpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGVycm9yOiByZXNwMT0ke0pTT04uc3RyaW5naWZ5KHJlc3AxKX0gcmVzcDI9JHtKU09OLnN0cmluZ2lmeShyZXNwMil9YClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgZXhlcmNpc2U6ICcgKyByZXNwMS5lcnJNZXNzYWdlKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBFTkQgT0YgTkVXIENPREVcbiAgZ2V0RXhlcmNpc2UgKGV4ZXJjaXNlSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8RXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnRXhlcmNpc2UnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7IGlkOiBleGVyY2lzZUlkIH0sXG4gICAgICBpbmNsdWRlOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1N1YnRvcGljJyksXG4gICAgICAgICAgaW5jbHVkZTogW1xuICAgICAgICAgICAgeyBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1RvcGljJykgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pXG4gIH1cblxuICAvLyBDcmVhdGUgYSBuZXcgR2VuZXJhdGVkRXhlcmNpc2UgYW5kIHNhdmUgaXQgdG8gZGF0YWJhc2VcbiAgZ2VuZXJhdGVBbmRTYXZlRXhlcmNpc2UgKGV4ZXJjaXNlLCB1c2VySWQ6IG51bWJlcik6IFByb21pc2U8TkNSZXNwb25zZTxHZW5lcmF0ZWRFeGVyY2lzZT4+IHtcbiAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZUV4ZXJjaXNlKGV4ZXJjaXNlLCAncXVhbnRpdHknKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCB1bnNhdmVkR2VuZXJhdGVkRXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdHZW5lcmF0ZWRFeGVyY2lzZScpLmRlc3Ryb3koe3doZXJlOiB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGV4ZXJjaXNlSWQ6IGV4ZXJjaXNlLmlkLFxuICAgICAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICB9fSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlPEdlbmVyYXRlZEV4ZXJjaXNlPih7XG4gICAgICAgICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRFeGVyY2lzZScsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIGV4ZXJjaXNlSGFzaDogdW5zYXZlZEdlbmVyYXRlZEV4ZXJjaXNlLmV4ZXJjaXNlSGFzaCxcbiAgICAgICAgICAgICAga25vd25zOiB1bnNhdmVkR2VuZXJhdGVkRXhlcmNpc2Uua25vd25zLFxuICAgICAgICAgICAgICB1bmtub3duczogdW5zYXZlZEdlbmVyYXRlZEV4ZXJjaXNlLnVua25vd25zLFxuICAgICAgICAgICAgICBleGVyY2lzZUlkOiB1bnNhdmVkR2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VJZCxcbiAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICBpZGVhbFRpbWU6IHVuc2F2ZWRHZW5lcmF0ZWRFeGVyY2lzZS5pZGVhbFRpbWUsXG4gICAgICAgICAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVJcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogcmVzcC5lcnJNZXNzYWdlIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gRm9ybWF0IGEgR2VuZXJhdGVkRXhlcmNpc2UgdG8gYSBmb3JtIHJlYWR5IHRvIHVzZVxuICBmb3JtYXRFeGVyY2lzZSAoZXhlcmNpc2U6IEV4ZXJjaXNlLCBnZW5lcmF0ZWRFeGVyY2lzZTogR2VuZXJhdGVkRXhlcmNpc2UpOiBQcm9taXNlPE5DUmVzcG9uc2U8Rm9ybWF0dGVkU3VidG9waWNFeGVyY2lzZT4+IHtcbiAgICBjb25zdCBzb2x2ZXIgPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRFeGVyY2lzZVNvbHZlcihleGVyY2lzZS5kYXRhKVxuICAgIGNvbnN0IGtub3ducyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2Uua25vd25zKVxuICAgIGNvbnN0IHVua25vd25zID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS51bmtub3ducylcblxuICAgIHJldHVybiBQcm9taXNlLmpvaW48YW55PihcbiAgICAgIFByb21pc2UubWFwKGtub3ducywga25vd24gPT4ge1xuICAgICAgICByZXR1cm4gc29sdmVyLmZvcm1hdFF1ZXN0aW9uKGtub3duKVxuICAgICAgfSksXG4gICAgICBQcm9taXNlLm1hcCh1bmtub3ducywgdW5rbm93biA9PiB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh1bmtub3duKVxuICAgICAgfSlcbiAgICApLnNwcmVhZCgocmVuZGVyZWRRdWVzdGlvbnM6IHN0cmluZ1tdLCB1bmtub3duczogc3RyaW5nW11bXSkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgZXhlcmNpc2VJZDogZXhlcmNpc2UuaWQsXG4gICAgICAgICAgaWRlYWxUaW1lOiBnZW5lcmF0ZWRFeGVyY2lzZS5pZGVhbFRpbWUsXG4gICAgICAgICAgZWxhcHNlZFRpbWU6IFV0aWxzLmdldEVsYXBzZWRUaW1lKGdlbmVyYXRlZEV4ZXJjaXNlLmNyZWF0ZWRBdCksXG4gICAgICAgICAgZm9ybWF0dGVkRXhlcmNpc2U6IHtcbiAgICAgICAgICAgIHJlbmRlcmVkUXVlc3Rpb25zLFxuICAgICAgICAgICAgdW5rbm93bnNcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gQ3JlYXRlZCBHZW5lcmF0ZWRFeGVyY2lzZSByZWFkeSB0byBiZSBzYXZlZFxuICBnZW5lcmF0ZUV4ZXJjaXNlIChleGVyY2lzZTogRXhlcmNpc2UsIHF1YW50aXR5VmFyaWFibGVOYW1lOiBRdWFudGl0eVZhcmlhYmxlTmFtZSk6IFByb21pc2U8TkNSZXNwb25zZTxQYXJ0aWFsPEdlbmVyYXRlZEV4ZXJjaXNlPj4+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGV4ZXJjaXNlU29sdmVyID0gRXhlcmNpc2VHZW5lcmF0b3IuZ2V0RXhlcmNpc2VTb2x2ZXIoZXhlcmNpc2UuZGF0YSkgYXMgQnJ1dGVmb3JjZVNvbHZlclxuICAgICAgLy8gR2VuZXJhdGUgWCBudW1iZXIgb2YgcXVlc3Rpb25zLCB3aGljaCBkZXBlbmRzIHdoZXRoZXIgaXQncyB0b3BpYyBvciBzdWJUb3BpY1xuICAgICAgbGV0IHF1ZXN0aW9uczogR2VuZXJhdGVkUXVlc3Rpb25EYXRhW10gPSBleGVyY2lzZVNvbHZlci5nZW5lcmF0ZVF1ZXN0aW9ucyhxdWFudGl0eVZhcmlhYmxlTmFtZSlcbiAgICAgIGxldCBrbm93bnM6IEFycmF5PHt9PiA9IFtdXG4gICAgICBsZXQgdW5rbm93bnM6IEFycmF5PHt9PiA9IFtdXG4gICAgICBsZXQgdW5rbm93bnNWYXJpYWJsZXM6IEFycmF5PHt9PiA9IFtdXG4gICAgICBsZXQgZm9ybWF0dGVkUXVlc3Rpb25zUHJvbWlzZXM6IEFycmF5PFByb21pc2U8c3RyaW5nPj4gPSBbXVxuXG4gICAgICBxdWVzdGlvbnMuZm9yRWFjaChxdWVzdGlvbiA9PiB7XG4gICAgICAgIGtub3ducy5wdXNoKHF1ZXN0aW9uLmtub3ducylcbiAgICAgICAgdW5rbm93bnMucHVzaChxdWVzdGlvbi51bmtub3ducylcbiAgICAgICAgdW5rbm93bnNWYXJpYWJsZXMucHVzaChPYmplY3Qua2V5cyhxdWVzdGlvbi51bmtub3ducykpXG4gICAgICB9KVxuXG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZm9ybWF0dGVkUXVlc3Rpb25zUHJvbWlzZXMpLnRoZW4ocmVuZGVyZWRRdWVzdGlvbnMgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBleGVyY2lzZUhhc2g6IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEhhc2goZXhlcmNpc2UuZGF0YSksXG4gICAgICAgICAgICBrbm93bnM6IEpTT04uc3RyaW5naWZ5KGtub3ducyksIC8vIFN0cmluZ2lmaWVkIEpTT05cbiAgICAgICAgICAgIHVua25vd25zOiBKU09OLnN0cmluZ2lmeSh1bmtub3ducyksIC8vIFN0cmluZ2lmaWVkIEpTT05cbiAgICAgICAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICAgICAgICBpZGVhbFRpbWU6IGV4ZXJjaXNlU29sdmVyLmdldEV4ZXJjaXNlSWRlYWxUaW1lKHF1ZXN0aW9ucy5sZW5ndGgpLFxuICAgICAgICAgICAgZXhlcmNpc2VJZDogZXhlcmNpc2UuaWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAgSW5wdXQ6XG4gICAgICBpZDogMSxcbiAgICAgIHNjb3JlOiAyLFxuICAgICAgdXNlckFuc3dlcjogJ1t7eDogXCIzXCJ9XScsXG4gICAgICBzdWJtaXR0ZWQ6IHRydWUsXG4gICAgICB0aW1lRmluaXNoOiAyMy4wOVxuICAqL1xuICB1cGRhdGVHZW5lcmF0ZWRFeGVyY2lzZSAoZGF0YSkge1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZTxHZW5lcmF0ZWRFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkRXhlcmNpc2UnLFxuICAgICAgZGF0YVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgZXhlcmNpc2UgdGhhdCBpcyBjdXJlbnRseSBhY3RpdmVcbiAgZ2V0R2VuZXJhdGVkRXhlcmNpc2UgKHVzZXJJZDogbnVtYmVyLCBleGVyY2lzZUlkOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPEdlbmVyYXRlZEV4ZXJjaXNlPih7XG4gICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRFeGVyY2lzZScsXG4gICAgICBzZWFyY2hDbGF1c2U6IHsgdXNlcklkLCBleGVyY2lzZUlkLCBzdWJtaXR0ZWQ6IGZhbHNlLCBvbkNsb3VkOiBBcHBDb25maWcuQ0xPVURfU0VSVkVSIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gR2V0IHVzZXIgc2NvcmUgb2YgYW4gZXhlcmNpc2VcbiAgLy9cbiAgLy8gUmV0dXJuOlxuICAvLyAwIC0gNDogSG93IG1hbnkgb2YgdGhlIHN1Ym1pdHRlZCBzY29yZXMgYXJlID4gODAlXG4gIGdldEV4ZXJjaXNlU3RhcnMgKHVzZXJJZCwgaWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShgXG5TRUxFQ1Qgc2NvcmUgRlJPTSBnZW5lcmF0ZWRFeGVyY2lzZXNcbldIRVJFIHN1Ym1pdHRlZCA9IDEgQU5EIHVzZXJJZCA9ICR7dXNlcklkfSBBTkQgZXhlcmNpc2VJZCA9ICR7aWR9XG5PUkRFUiBCWSBzY29yZSBERVNDIExJTUlUIDQ7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKGRhdGFzID0+IHtcbiAgICAgIGNvbnN0IHN0YXJzID0gZGF0YXMucmVkdWNlKChhY2MsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHBhcnNlSW50KGRhdGEuc2NvcmUsIDEwKSA+PSA4MCkge1xuICAgICAgICAgIHJldHVybiBhY2MgKyAxXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgICB9XG4gICAgICB9LCAwKVxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHN0YXJzIH0gfVxuICAgIH0pXG4gIH1cblxuICAvKlxuICAgIGlmIHJlbmRlclN0YXIgaXMgdHJ1ZVxuICAgICAgd2lsbCByZXR1cm4ge1xuICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBodG1sOiAnIDxzcGFuPjxpbWcgLz48L3NwYW4+J1xuICAgICAgICAgIHN0YXJzOiAwLTRcbiAgICAgICAgfVxuICAgICAgfVxuICAgIGVsc2VcbiAgICAgIHtcbiAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgc3RhcnM6IDAtNFxuICAgICAgICB9XG4gICAgICB9XG4gICovXG4gIGdldFJlbmRlcmVkRXhlcmNpc2VTdGFycyAodXNlcklkLCBpZCk6IFByb21pc2U8TkNSZXNwb25zZTxzdHJpbmc+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VTdGFycyh1c2VySWQsIGlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IHN0YXJzID0gcmVzcC5kYXRhLnN0YXJzXG4gICAgICAgIGNvbnN0IGh0bWwgPSBwdWcucmVuZGVyRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwL3ZpZXdzL25vbi1wYWdlcy9zdGFycy5wdWcnKSwgeyBzdGFycyB9KVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGh0bWwgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3BcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gU3BlY2lhbGx5IGNhbGxlZCBmcm9tIGNvdXJzZSBjb250cm9sbGVyXG4gIGdldFN1YnRvcGljU3RhciAodXNlcklkLCBzdWJ0b3BpY0lkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPGFueT4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkPEV4ZXJjaXNlPih7XG4gICAgICBtb2RlbE5hbWU6ICdFeGVyY2lzZScsIHNlYXJjaENsYXVzZTogeyBzdWJ0b3BpY0lkIH1cbiAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UubWFwKHJlc3AuZGF0YSB8fCBbXSwgKGV4ZXJjaXNlOiBFeGVyY2lzZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRFeGVyY2lzZVN0YXJzKHVzZXJJZCwgZXhlcmNpc2UuaWQpXG4gICAgICB9KS50aGVuKGRhdGFzID0+IHtcbiAgICAgICAgY29uc3Qgc3RhcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgcmVzcCkgPT4ge1xuICAgICAgICAgIHJldHVybiBhY2MgKyByZXNwLmRhdGEuc3RhcnNcbiAgICAgICAgfSwgMCkgLyAoZGF0YXMubGVuZ3RoIHx8IDEpXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBzdGFycyB9IH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIC8vIEdldCB1c2VyIHNjb3JlIG9mIGFuIGV4ZXJjaXNlXG4gIC8vXG4gIC8vIFJldHVybjpcbiAgLy8gMCAtIDQ6IEhvdyBtYW55IG9mIHRoZSBzdWJtaXR0ZWQgc2NvcmVzIGFyZSA+IDgwJVxuICBnZXRFeGVyY2lzZVRpbWVycyAodXNlcklkLCBleGVyY2lzZUlkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFxuU0VMRUNUIHNjb3JlIEZST00gZ2VuZXJhdGVkRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSAxIEFORCB1c2VySWQgPSAke3VzZXJJZH0gQU5EIGV4ZXJjaXNlSWQgPSAke2V4ZXJjaXNlSWR9XG5BTkQgdGltZUZpbmlzaCA8IGlkZWFsVGltZSBBTkQgc2NvcmUgPSAxMDBcbk9SREVSIEJZIHNjb3JlIERFU0MgTElNSVQgNDtgLFxuICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4oZGF0YXMgPT4ge1xuICAgICAgY29uc3QgdGltZXJzID0gZGF0YXMucmVkdWNlKChhY2MsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHBhcnNlSW50KGRhdGEuc2NvcmUsIDEwKSA+PSAxMDApIHtcbiAgICAgICAgICByZXR1cm4gYWNjICsgMVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBhY2NcbiAgICAgICAgfVxuICAgICAgfSwgMClcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB0aW1lcnMgfSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFJlbmRlcmVkRXhlcmNpc2VUaW1lcnMgKHVzZXJJZCwgaWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8c3RyaW5nPj4ge1xuICAgIHJldHVybiB0aGlzLmdldEV4ZXJjaXNlVGltZXJzKHVzZXJJZCwgaWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgY29uc3QgdGltZXJzID0gcmVzcC5kYXRhLnRpbWVyc1xuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvdGltZXJzLnB1ZycpLCB7IHRpbWVycyB9KVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGh0bWwgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIChyZXNwKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRTdWJ0b3BpY0V4ZXJjaXNlVGltZXJzICh1c2VySWQsIHN1YnRvcGljSWQpIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkPEV4ZXJjaXNlPih7XG4gICAgICBtb2RlbE5hbWU6ICdFeGVyY2lzZScsIHNlYXJjaENsYXVzZTogeyBzdWJ0b3BpY0lkIH1cbiAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UubWFwKHJlc3AuZGF0YSB8fCBbXSwgKGV4ZXJjaXNlOiBFeGVyY2lzZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRFeGVyY2lzZVRpbWVycyh1c2VySWQsIGV4ZXJjaXNlLmlkKVxuICAgICAgfSkudGhlbihkYXRhcyA9PiB7XG4gICAgICAgIGNvbnN0IHRpbWVycyA9IGRhdGFzLnJlZHVjZSgoYWNjLCByZXNwKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGFjYyArIHJlc3AuZGF0YS50aW1lcnNcbiAgICAgICAgfSwgMCkgLyAoZGF0YXMubGVuZ3RoIHx8IDEpXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB0aW1lcnMgfSB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgbGVhZGVyYm9hcmQgZGF0YVxuICBnZXRFeGVyY2lzZVJhbmtpbmcgKGV4ZXJjaXNlSWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShcbmBTRUxFQ1QgTUlOKHRpbWVGaW5pc2gpIEFTIHRpbWVGaW5pc2gsIHVzZXJJZCwgdXNlcnMuZnVsbE5hbWUgQVMgZnVsbE5hbWUsIHVzZXJzLmdyYWRlIEFTIGdyYWRlLCBzY2hvb2xzLm5hbWUgQVMgc2Nob29sTmFtZVxuRlJPTSBnZW5lcmF0ZWRFeGVyY2lzZXMgSU5ORVIgSk9JTiB1c2VycyBPTiB1c2Vycy5pZCA9IGdlbmVyYXRlZEV4ZXJjaXNlcy51c2VySWQgSU5ORVIgSk9JTiBzY2hvb2xzIE9OIHNjaG9vbHMuaWQgPSB1c2Vycy5zY2hvb2xJZFxuV0hFUkUgc3VibWl0dGVkID0gVFJVRSBBTkQgZXhlcmNpc2VJZCA9ICR7ZXhlcmNpc2VJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMIEdST1VQIEJZIHVzZXJJZCBPUkRFUiBCWSBNSU4odGltZUZpbmlzaCkgTElNSVQgMTA7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0RXhlcmNpc2VMZWFkZXJib2FyZCAoZXhlcmNpc2VJZCkge1xuICAgIHJldHVybiB0aGlzLmdldEV4ZXJjaXNlUmFua2luZyhleGVyY2lzZUlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IGV4ZXJjaXNlRGF0YSA9IHJlc3AuZGF0YVxuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvcmFua2luZy5wdWcnKSwgeyBleGVyY2lzZURhdGEgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBodG1sIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAocmVzcClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gR2V0IHRoZSBudW1iZXIgb2YgcmFuayBpbiBsZWFkZXJib2FyZFxuICBnZXRDdXJyZW50UmFua2luZyAodGltZUZpbmlzaCwgZXhlcmNpc2VJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgcXVlcnlEQiA9IGBTRUxFQ1QgQ09VTlQoKikgQVMgdG90YWxcbiAgRlJPTSAoU0VMRUNUIENPVU5UKCopIEZST00gZ2VuZXJhdGVkRXhlcmNpc2VzXG4gIFdIRVJFIHN1Ym1pdHRlZCA9IFRSVUUgQU5EIHRpbWVGaW5pc2ggPCAke3RpbWVGaW5pc2h9IEFORFxuICAgICAgICBleGVyY2lzZUlkID0gJHtleGVyY2lzZUlkfSBBTkQgc2NvcmUgPSAxMDAgQU5EIHRpbWVGaW5pc2ggSVMgTk9UIE5VTExcbiAgR1JPVVAgQlkgdXNlcklkXG4gIE9SREVSIEJZIE1JTih0aW1lRmluaXNoKSkgQVMgdG90YWxyb3c7YFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnlEQixcbiAgICAgICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGNvdW50OiByZXNwWzBdLnRvdGFsIH0gfSlcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9KVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgdGhlIG51bWJlciBvZiBzdWJtaXNzaW9ucyBpbiB0aGUgbGVhZGVyYm9hcmRcbiAgZ2V0VG90YWxSYW5raW5nIChleGVyY2lzZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBxdWVyeURCID0gYFNFTEVDVCBDT1VOVCgqKSBBUyB0b3RhbFxuRlJPTSAoU0VMRUNUIENPVU5UKCopIEZST00gZ2VuZXJhdGVkRXhlcmNpc2VzIFdIRVJFIHN1Ym1pdHRlZCA9IFRSVUUgQU5EIGV4ZXJjaXNlSWQgPSAke2V4ZXJjaXNlSWR9XG4gICAgICAgICAgICAgICAgICAgICAgQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMXG5HUk9VUCBCWSB1c2VySWRcbk9SREVSIEJZIE1JTih0aW1lRmluaXNoKSkgQVMgdG90YWxyb3c7YFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnlEQixcbiAgICAgICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGNvdW50OiByZXNwWzBdLnRvdGFsIH0gfSlcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBmaW5pc2hFeGVyY2lzZSAoZXhlcmNpc2VJZDogbnVtYmVyLCB1c2VySWQ6IG51bWJlciwgYW5zd2VyczogRXhlcmNpc2VBbnN3ZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8RXhlcmNpc2VHcmFkZT4+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRHZW5lcmF0ZWRFeGVyY2lzZSh1c2VySWQsIGV4ZXJjaXNlSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICAgIHJldHVybiB0aGlzLmdyYWRlRXhlcmNpc2UoZ2VuZXJhdGVkRXhlcmNpc2UsIGFuc3dlcnMpLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgICAgY29uc3QgZ3JhZGU6IEV4ZXJjaXNlR3JhZGUgPSByZXNwMi5kYXRhXG4gICAgICAgICAgICAvLyBTYXZlIHRvIGRhdGFiYXNlXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVHZW5lcmF0ZWRFeGVyY2lzZSh7XG4gICAgICAgICAgICAgIGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5pZCxcbiAgICAgICAgICAgICAgc2NvcmU6IGdyYWRlLnNjb3JlLFxuICAgICAgICAgICAgICB1c2VyQW5zd2VyOiBKU09OLnN0cmluZ2lmeShhbnN3ZXJzKSxcbiAgICAgICAgICAgICAgc3VibWl0dGVkOiB0cnVlLFxuICAgICAgICAgICAgICBzdWJtaXR0ZWRBdDogbW9tZW50KCkubG9jYWwoKS5mb3JtYXQoJ1lZWVktTU0tREQgSEg6bW06c3MnKSxcbiAgICAgICAgICAgICAgdGltZUZpbmlzaDogZ3JhZGUudGltZUZpbmlzaFxuICAgICAgICAgICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBncmFkZSB9IGFzIE5DUmVzcG9uc2U8RXhlcmNpc2VHcmFkZT5cbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIHVwZGF0ZSBnZW5lcmF0ZWRFeGVyY2lzZTogJyArIHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdGYWlsZWQgdG8gZ3JhZGUgZXhlcmNpc2U6ICcgKyByZXNwMi5lcnJNZXNzYWdlIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIGdldCBnZW5lcmF0ZWRFeGVyY2lzZTogJyArIHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgZ3JhZGVFeGVyY2lzZSAoZ2VuZXJhdGVkRXhlcmNpc2U6IEdlbmVyYXRlZEV4ZXJjaXNlLCBhbnN3ZXJzOiBFeGVyY2lzZUFuc3dlcik6IFByb21pc2U8TkNSZXNwb25zZTxFeGVyY2lzZUdyYWRlPj4ge1xuICAgIHJldHVybiB0aGlzLmdldEV4ZXJjaXNlKGdlbmVyYXRlZEV4ZXJjaXNlLmV4ZXJjaXNlSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGV4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICAgIGNvbnN0IGtub3ducyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2Uua25vd25zKVxuICAgICAgICBjb25zdCB1bmtub3ducyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UudW5rbm93bnMpXG4gICAgICAgIGNvbnN0IHNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKGV4ZXJjaXNlLmRhdGEpXG5cbiAgICAgICAgaWYgKGtub3ducy5sZW5ndGggIT09IGFuc3dlcnMubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ1VuZXhwZWN0ZWQgbnVtYmVyIG9mIGFuc3dlcnMhJyB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgeyBudW1Db3JyZWN0QW5zd2VycywgY29ycmVjdEFuc3dlcnMsIGlzQ29ycmVjdCB9ID0ga25vd25zLnJlZHVjZSgoYWNjLCBrbm93biwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlzQ29ycmVjdEFuc3dlciA9IHNvbHZlci5pc0Fuc3dlcihrbm93biwgYW5zd2Vyc1tpbmRleF0pXG4gICAgICAgICAgICBhY2MuaXNDb3JyZWN0LnB1c2goaXNDb3JyZWN0QW5zd2VyKVxuICAgICAgICAgICAgYWNjLm51bUNvcnJlY3RBbnN3ZXJzICs9IGlzQ29ycmVjdEFuc3dlciA/IDEgOiAwXG4gICAgICAgICAgICBhY2MuY29ycmVjdEFuc3dlcnMucHVzaCh1bmtub3duc1tpbmRleF0pXG4gICAgICAgICAgICByZXR1cm4gYWNjXG4gICAgICAgICAgfSwgeyBudW1Db3JyZWN0QW5zd2VyczogMCwgY29ycmVjdEFuc3dlcnM6IFtdLCBpc0NvcnJlY3Q6IFtdIH0pXG4gICAgICAgICAgY29uc3QgbnVtUXVlc3Rpb25zID0ga25vd25zLmxlbmd0aFxuICAgICAgICAgIGNvbnN0IGdyYWRlOiBFeGVyY2lzZUdyYWRlID0ge1xuICAgICAgICAgICAgbnVtUXVlc3Rpb25zLFxuICAgICAgICAgICAgbnVtQ29ycmVjdEFuc3dlcnMsXG4gICAgICAgICAgICBjb3JyZWN0QW5zd2VycyxcbiAgICAgICAgICAgIGlzQ29ycmVjdCxcbiAgICAgICAgICAgIHRpbWVGaW5pc2g6IEV4ZXJjaXNlSGVscGVyLmNvdW50VGltZUZpbmlzaChnZW5lcmF0ZWRFeGVyY2lzZS5jcmVhdGVkQXQpLFxuICAgICAgICAgICAgc2NvcmU6IHBhcnNlRmxvYXQobnVtQ29ycmVjdEFuc3dlcnMpIC8gbnVtUXVlc3Rpb25zICogMTAwXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBncmFkZSB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICdGYWlsZSB0byBnZXQgZXhlcmNpc2U6ICcgKyByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IEV4ZXJjaXNlU2VydmljZSgpXG4iXX0=
