"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),exercise_generator_1=require("../lib/exercise_generator/exercise-generator"),crud_service_neo_1=require("./crud-service-neo");let path=require("path"),log=require("npmlog"),pug=require("pug"),moment=require("moment"),Sequelize=require("sequelize");const AppConfig=require(path.join(__dirname,"../app-config")),TAG="ExerciseService";class ExerciseService extends crud_service_neo_1.default{getExercise(e){return this.readOne({modelName:"Exercise",searchClause:{id:e},include:[{model:this.getModels("Subtopic"),include:[{model:this.getModels("Topic")}]}]})}generateExercise(e,r=!1){let s=exercise_generator_1.default.getExerciseSolver(e.data),t=[];t=r?s.generateTopicQuestions():s.generateQuestions();let i=[],n=[],a=[],u=[];return t.forEach(e=>{u.push(s.formatQuestion(e.knowns)),i.push(e.knowns),n.push(e.unknowns),a.push(Object.keys(e.unknowns))}),Promise.all(u).then(r=>({status:!0,data:{exerciseData:{knowns:JSON.stringify(i),unknowns:JSON.stringify(n),userAnswer:[],exerciseId:e.id,idealTime:s.getExerciseIdealTime()},formatted:{renderedQuestions:r,unknowns:a}}}))}formatExercise(e,r){let s=JSON.parse(e.knowns),t=JSON.parse(e.unknowns);return Promise.join(Promise.map(s,e=>r.formatQuestion(e)),Promise.map(t,e=>Object.keys(e))).spread((r,s)=>{return{formatted:{renderedQuestions:r,unknowns:s},exerciseId:e.exerciseId,idealTime:e.idealTime}})}saveGeneratedExercise(e,r,s){return this.getModels("GeneratedExercise").destroy({where:{userId:e,exerciseId:r.exerciseId,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}}).then(()=>this.create({modelName:"GeneratedExercise",data:{exerciseHash:s,knowns:r.knowns,unknowns:r.unknowns,exerciseId:r.exerciseId,userId:e,idealTime:r.idealTime,onCloud:AppConfig.CLOUD_SERVER}}))}updateGeneratedExercise(e){return this.update({modelName:"GeneratedExercise",data:e})}getGeneratedExercise({userId:e,exerciseId:r}){return this.readOne({modelName:"GeneratedExercise",searchClause:{userId:e,exerciseId:r,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}})}getSubmittedExercises({userId:e,exerciseId:r}){return this.read({modelName:"GeneratedExercise",searchClause:{userId:e,exerciseId:r,submitted:!0}})}getExerciseStars(e,r){return this.getSequelize().query(`\nSELECT score FROM generatedExercises\nWHERE submitted = 1 AND userId = ${e} AND exerciseId = ${r}\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{stars:e.reduce((e,r)=>parseInt(r.score,10)>=80?e+1:e,0)}}})}getRenderedExerciseStars(e,r){return this.getExerciseStars(e,r).then(e=>{if(e.status){const r=e.data.stars;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/stars.pug"),{stars:r})}}return e})}getSubtopicStar(e,r){return this.read({modelName:"Exercise",searchClause:{subtopicId:r}}).then(r=>Promise.map(r.data||[],r=>this.getExerciseStars(e,r.id)).then(e=>{return{status:!0,data:{stars:e.reduce((e,r)=>e+r.data.stars,0)/(e.length||1)}}}))}getExerciseTimers(e,r){return this.getSequelize().query(`\nSELECT score FROM generatedExercises\nWHERE submitted = 1 AND userId = ${e} AND exerciseId = ${r}\nAND timeFinish < idealTime AND score = 100\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{timers:e.reduce((e,r)=>parseInt(r.score,10)>=100?e+1:e,0)}}})}getRenderedExerciseTimers(e,r){return this.getExerciseTimers(e,r).then(e=>{if(e.status){const r=e.data.timers;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/timers.pug"),{timers:r})}}return e})}getSubtopicExerciseTimers(e,r){return this.read({modelName:"Exercise",searchClause:{subtopicId:r}}).then(r=>Promise.map(r.data||[],r=>this.getExerciseTimers(e,r.id)).then(e=>{return{status:!0,data:{timers:e.reduce((e,r)=>e+r.data.timers,0)/(e.length||1)}}}))}getExerciseRanking(e){return this.getSequelize().query(`SELECT MIN(timeFinish) AS timeFinish, userId, users.fullName AS fullName, users.grade AS grade, schools.name AS schoolName\nFROM generatedExercises INNER JOIN users ON users.id = generatedExercises.userId INNER JOIN schools ON schools.id = users.schoolId\nWHERE submitted = TRUE AND exerciseId = ${e} AND score = 100 AND timeFinish IS NOT NULL GROUP BY userId ORDER BY MIN(timeFinish) LIMIT 10;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getExerciseLeaderboard(e){return this.getExerciseRanking(e).then(e=>{if(e.status){const r=e.data;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ranking.pug"),{exerciseData:r})}}return e})}getCurrentRanking(e,r){return new Promise((s,t)=>{let i=`SELECT COUNT(*) AS total\n  FROM (SELECT COUNT(*) FROM generatedExercises\n  WHERE submitted = TRUE AND timeFinish < ${e} AND\n        exerciseId = ${r} AND score = 100 AND timeFinish IS NOT NULL\n  GROUP BY userId\n  ORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(i,{type:Sequelize.QueryTypes.SELECT}).then(e=>{s({status:!0,data:{count:e[0].total}})}).catch(e=>{t(e)})})}getTotalRanking(e){return new Promise((r,s)=>{let t=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedExercises WHERE submitted = TRUE AND exerciseId = ${e}\n                      AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(t,{type:Sequelize.QueryTypes.SELECT}).then(e=>{r({status:!0,data:{count:e[0].total}})}).catch(e=>{s(e)})})}}exports.default=new ExerciseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy9leGVyY2lzZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJjcnVkX3NlcnZpY2VfbmVvXzEiLCJwYXRoIiwibG9nIiwicHVnIiwibW9tZW50IiwiU2VxdWVsaXplIiwiQXBwQ29uZmlnIiwiam9pbiIsIl9fZGlybmFtZSIsIlRBRyIsIkV4ZXJjaXNlU2VydmljZSIsImRlZmF1bHQiLCJbb2JqZWN0IE9iamVjdF0iLCJleGVyY2lzZUlkIiwidGhpcyIsInJlYWRPbmUiLCJtb2RlbE5hbWUiLCJzZWFyY2hDbGF1c2UiLCJpZCIsImluY2x1ZGUiLCJtb2RlbCIsImdldE1vZGVscyIsImV4ZXJjaXNlIiwic3VidG9waWNPclRvcGljIiwiZXhlcmNpc2VTb2x2ZXIiLCJnZXRFeGVyY2lzZVNvbHZlciIsImRhdGEiLCJxdWVzdGlvbnMiLCJnZW5lcmF0ZVRvcGljUXVlc3Rpb25zIiwiZ2VuZXJhdGVRdWVzdGlvbnMiLCJrbm93bnMiLCJ1bmtub3ducyIsInVua25vd25zVmFyaWFibGVzIiwiZm9ybWF0dGVkUXVlc3Rpb25zUHJvbWlzZXMiLCJmb3JFYWNoIiwicXVlc3Rpb24iLCJwdXNoIiwiZm9ybWF0UXVlc3Rpb24iLCJPYmplY3QiLCJrZXlzIiwiYWxsIiwidGhlbiIsInJlbmRlcmVkUXVlc3Rpb25zIiwic3RhdHVzIiwiZXhlcmNpc2VEYXRhIiwiSlNPTiIsInN0cmluZ2lmeSIsInVzZXJBbnN3ZXIiLCJpZGVhbFRpbWUiLCJnZXRFeGVyY2lzZUlkZWFsVGltZSIsImZvcm1hdHRlZCIsImdlbmVyYXRlZEV4ZXJjaXNlIiwicGFyc2UiLCJtYXAiLCJrbm93biIsInVua25vd24iLCJzcHJlYWQiLCJmb3JtYXR0ZWRRdWVzdGlvbnMiLCJ1c2VySWQiLCJleGVyY2lzZUhhc2giLCJkZXN0cm95Iiwid2hlcmUiLCJzdWJtaXR0ZWQiLCJvbkNsb3VkIiwiQ0xPVURfU0VSVkVSIiwiY3JlYXRlIiwidXBkYXRlIiwicmVhZCIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJkYXRhcyIsInN0YXJzIiwicmVkdWNlIiwiYWNjIiwicGFyc2VJbnQiLCJzY29yZSIsImdldEV4ZXJjaXNlU3RhcnMiLCJyZXNwIiwicmVuZGVyRmlsZSIsInN1YnRvcGljSWQiLCJsZW5ndGgiLCJ0aW1lcnMiLCJnZXRFeGVyY2lzZVRpbWVycyIsImdldEV4ZXJjaXNlUmFua2luZyIsInRpbWVGaW5pc2giLCJyZXNvbHZlIiwicmVqZWN0IiwicXVlcnlEQiIsImNvdW50IiwidG90YWwiLCJjYXRjaCIsImVyciIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFBQSxNQUFBQSxRQUFBQyxRQUFBLFlBQ0FDLHFCQUFBRCxRQUFBLGdEQUNBRSxtQkFBQUYsUUFBQSxzQkFHQSxJQUFJRyxLQUFPSCxRQUFRLFFBRWZJLElBQU1KLFFBQVEsVUFDZEssSUFBTUwsUUFBUSxPQUNkTSxPQUFTTixRQUFRLFVBQ2pCTyxVQUFZUCxRQUFRLGFBRXhCLE1BQU1RLFVBQVlSLFFBQVFHLEtBQUtNLEtBQUtDLFVBQVcsa0JBQ3pDQyxJQUFNLHdCQVdaQyx3QkFBOEJWLG1CQUFBVyxRQUM1QkMsWUFBYUMsR0FDWCxPQUFPQyxLQUFLQyxTQUNWQyxVQUFXLFdBQ1hDLGNBQWdCQyxHQUFJTCxHQUNwQk0sVUFFSUMsTUFBT04sS0FBS08sVUFBVSxZQUN0QkYsVUFDSUMsTUFBT04sS0FBS08sVUFBVSxlQXlDbENULGlCQUFrQlUsRUFBb0JDLEdBQWtCLEdBQ3RELElBQUlDLEVBQWlCekIscUJBQUFZLFFBQWtCYyxrQkFBa0JILEVBQVNJLE1BQzlEQyxLQUdGQSxFQURFSixFQUNVQyxFQUFlSSx5QkFFZkosRUFBZUssb0JBRzdCLElBQUlDLEtBQ0FDLEtBQ0FDLEtBQ0FDLEtBYUosT0FQQU4sRUFBVU8sUUFBUUMsSUFDaEJGLEVBQTJCRyxLQUFLWixFQUFlYSxlQUFlRixFQUFT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LEdBQ2xCLE9BQU9DLEtBQUtzRCxlQUFlQyxpVEFHV3hELG1HQUNwQ3lELEtBQU1qRSxVQUFVa0UsV0FBV0MsU0FBVS9CLEtBQUt1QyxLQUNqQ3JDLFFBQVEsRUFBTWpCLEtBQU1zRCxLQUlqQ3BFLHVCQUF3QkMsR0FDdEIsT0FBT0MsS0FBS3dFLG1CQUFtQnpFLEdBQVk0QixLQUFLdUMsSUFDOUMsR0FBSUEsRUFBS3JDLE9BQVEsQ0FDZixNQUFNQyxFQUFlb0MsRUFBS3RELEtBRTFCLE9BQVNpQixRQUFRLEVBQU1qQixLQURWdkIsSUFBSThFLFdBQVdoRixLQUFLTSxLQUFLQyxVQUFXLHVDQUF5Q29DLGFBQUFBLEtBRzFGLE9BQU8sSUFNYmhDLGtCQUFtQjJFLEVBQVkxRSxHQUM3QixPQUFPLElBQUloQixRQUFRLENBQUMyRixFQUFTQyxLQUMzQixJQUFJQywwSEFFa0NILCtCQUNyQjFFLDRHQUdqQixPQUFPQyxLQUFLc0QsZUFBZUMsTUFBTXFCLEdBQzdCcEIsS0FBTWpFLFVBQVVrRSxXQUFXQyxTQUFVL0IsS0FBS3VDLElBQzFDUSxHQUFVN0MsUUFBUSxFQUFNakIsTUFBUWlFLE1BQU9YLEVBQUssR0FBR1ksV0FDOUNDLE1BQU1DLElBQ1BMLEVBQU9LLE9BTWZsRixnQkFBaUJDLEdBQ2YsT0FBTyxJQUFJaEIsUUFBUSxDQUFDMkYsRUFBU0MsS0FDM0IsSUFBSUMscUhBQzhFN0UsK0hBSWxGLE9BQU9DLEtBQUtzRCxlQUFlQyxNQUFNcUIsR0FDN0JwQixLQUFNakUsVUFBVWtFLFdBQVdDLFNBQVUvQixLQUFLdUMsSUFDMUNRLEdBQVU3QyxRQUFRLEVBQU1qQixNQUFRaUUsTUFBT1gsRUFBSyxHQUFHWSxXQUM5Q0MsTUFBTUMsSUFDUEwsRUFBT0ssUUFNakJDLFFBQUFwRixRQUFlLElBQUlEIiwiZmlsZSI6InNlcnZpY2VzL2V4ZXJjaXNlLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IENSVURTZXJ2aWNlIGZyb20gJy4vY3J1ZC1zZXJ2aWNlLW5lbydcbmltcG9ydCBCcnV0ZWZvcmNlU29sdmVyLCB7IEdlbmVyYXRlZFF1ZXN0aW9uRGF0YSB9IGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2Vfc29sdmVycy9icnV0ZWZvcmNlLXNvbHZlcidcblxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxubGV0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5sZXQgcHVnID0gcmVxdWlyZSgncHVnJylcbmxldCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKVxubGV0IFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpXG5cbmNvbnN0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC1jb25maWcnKSlcbmNvbnN0IFRBRyA9ICdFeGVyY2lzZVNlcnZpY2UnXG5cbi8qXG4gIEltcG9ydGFudCBOb3RlOlxuICAgIGdlbmVyYXRlZEV4ZXJjaXNlcyBhbmQgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMgaGFzICdvbkNsb3VkJyBjb2x1bW5cbiAgICB3aGljaCBpbmRpY2F0ZSB0aGF0IHRoZSBkYXRhIGlzIGFscmVhZHkgb24gdGhlIGNsb3VkIGFuZCB3ZSBkb24ndCBuZWVkIHRvXG4gICAgc2VuZCB0aGVtIGFnYWluIHdoZW4gc3luY2luZy4gU2luY2UgYWxsIHJvd3Mgd2l0aCBvbkNsb3VkID09PSB0cnVlXG4gICAgd291bGRuJ3QgYmUgc3luY2VkIHRvIHRoZSBzZXJ2ZXIsIHdlIHNob3VsZG4ndCByZXN0b3JlIGdlbmVyYXRlZEV4ZXJjaXNlc1xuICAgIG9yIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzIHdob3NlIG9uQ2xvdWQgIT0gQXBwQ29uZmlnLkNMT1VEX1NFUlZFUi5cbiAgICBSZW1lbWJlciB0byBzZXQgdGhlIHZhbHVlIHByb3Blcmx5IVxuKi9cbmNsYXNzIEV4ZXJjaXNlU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgZ2V0RXhlcmNpc2UgKGV4ZXJjaXNlSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8RXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnRXhlcmNpc2UnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7IGlkOiBleGVyY2lzZUlkIH0sXG4gICAgICBpbmNsdWRlOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1N1YnRvcGljJyksXG4gICAgICAgICAgaW5jbHVkZTogW1xuICAgICAgICAgICAgeyBtb2RlbDogdGhpcy5nZXRNb2RlbHMoJ1RvcGljJykgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pXG4gIH1cblxuICAvLyBUT0RPOiBTaG91bGQgY2FsbCBmb3JtYXRFeGVyY2lzZSgpXG4gIC8qXG4gICAgZXhlcmNpc2U6IHtcbiAgICAgIGlkOiAxMyxcbiAgICAgIGRhdGE6IC8vIE5vZGVKUyBDb2RlIGRlc2NyaWJpbmcgdGhlIGV4ZXJjaXNlXG4gICAgICBjcmVhdGVkQXQ6IDIwMTgtMDItMjFUMDg6NTA6MjguMDAwWixcbiAgICAgIHVwZGF0ZWRBdDogMjAxOC0wMy0wNFQxMzozODo0OC4wMDBaLFxuICAgICAgc3VidG9waWNJZDogMTMsXG4gICAgICBzdWJ0b3BpYzogJ1BlbmdlbmFsYW4gQmlsYW5nYW4gMSAtIDUnLFxuICAgICAgZGVzY3JpcHRpb246ICcnLFxuICAgICAgc3VidG9waWNEYXRhOiAne1wiZGV0YWlsXCI6XCJcIn0nLFxuICAgICAgc3VidG9waWNObzogMTAxLFxuICAgICAgdG9waWNJZDogMTJcbiAgICB9XG5cbiAgICByZXR1cm46IHtcbiAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgIGRhdGEgOntcbiAgICAgICAgZXhlcmNpc2VEYXRhOiB7XG4gICAgICAgICAga25vd25zLCAgLy8gQWxyZWFkeSBzdHJpbmdpZmllZFxuICAgICAgICAgIHVua25vd25zLCAvLyBBbHJlYWR5IHN0cmluZ2lmaWVkXG4gICAgICAgICAgdXNlckFuc3dlciwgLy8gRE9ORVxuICAgICAgICAgIGV4ZXJjaXNlSWQ6IDQwLFxuICAgICAgICAgIGlkZWFsVGltZTogNjAsXG4gICAgICAgICAgc3VidG9waWNOYW1lOiAnUGVuZ2VuYWxhbiBIYXNpbCBCaWxhbmdhbiAxLTUnXG4gICAgICAgIH1cbiAgICAgICAgZm9ybWF0dGVkOiB7XG4gICAgICAgICAgcmVuZGVyZWRRdWVzdGlvbnMsIC8vIEhUTUwtcmVuZGVyZWQgcXVlc3Rpb24gYXJyYXlcbiAgICAgICAgICB1bmtub3ducywgLy8gVmFyaWFibGUgZm9yIGlucHV0c1xuICAgICAgICAgIHN1YnRvcGljTmFtZTogJ1Blbmp1bWxhaGFuIEhhc2lsIEJpbGFuZ2FuIDEtNSdcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgKi9cbiAgZ2VuZXJhdGVFeGVyY2lzZSAoZXhlcmNpc2U6IEV4ZXJjaXNlLCBzdWJ0b3BpY09yVG9waWMgPSBmYWxzZSk6IFByb21pc2U8TkNSZXNwb25zZTxhbnk+PiB7XG4gICAgbGV0IGV4ZXJjaXNlU29sdmVyID0gRXhlcmNpc2VHZW5lcmF0b3IuZ2V0RXhlcmNpc2VTb2x2ZXIoZXhlcmNpc2UuZGF0YSkgYXMgQnJ1dGVmb3JjZVNvbHZlclxuICAgIGxldCBxdWVzdGlvbnM6IEdlbmVyYXRlZFF1ZXN0aW9uRGF0YVtdID0gW11cblxuICAgIGlmIChzdWJ0b3BpY09yVG9waWMpIHtcbiAgICAgIHF1ZXN0aW9ucyA9IGV4ZXJjaXNlU29sdmVyLmdlbmVyYXRlVG9waWNRdWVzdGlvbnMoKVxuICAgIH0gZWxzZSB7XG4gICAgICBxdWVzdGlvbnMgPSBleGVyY2lzZVNvbHZlci5nZW5lcmF0ZVF1ZXN0aW9ucygpXG4gICAgfVxuXG4gICAgbGV0IGtub3duczogQXJyYXk8e30+ID0gW11cbiAgICBsZXQgdW5rbm93bnM6IEFycmF5PHt9PiA9IFtdXG4gICAgbGV0IHVua25vd25zVmFyaWFibGVzOiBBcnJheTx7fT4gPSBbXVxuICAgIGxldCBmb3JtYXR0ZWRRdWVzdGlvbnNQcm9taXNlczogQXJyYXk8UHJvbWlzZTxzdHJpbmc+PiA9IFtdXG4gICAgLypcbiAgICAgIHF1ZXN0aW9ucyBjb250ZW50OlxuICAgICAgWyB7IGtub3duczogeyBhOiAyMywgYjogMTMgfSwgdW5rbm93bnM6IHsgeDogMzYgfSB9LFxuICAgICAgICB7IGtub3duczogeyBhOiAxMCwgYjogMTIgfSwgdW5rbm93bnM6IHsgeDogMjIgfSB9IF1cbiAgICAqL1xuICAgIHF1ZXN0aW9ucy5mb3JFYWNoKHF1ZXN0aW9uID0+IHtcbiAgICAgIGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzLnB1c2goZXhlcmNpc2VTb2x2ZXIuZm9ybWF0UXVlc3Rpb24ocXVlc3Rpb24ua25vd25zKSlcbiAgICAgIGtub3ducy5wdXNoKHF1ZXN0aW9uLmtub3ducylcbiAgICAgIHVua25vd25zLnB1c2gocXVlc3Rpb24udW5rbm93bnMpXG4gICAgICB1bmtub3duc1ZhcmlhYmxlcy5wdXNoKE9iamVjdC5rZXlzKHF1ZXN0aW9uLnVua25vd25zKSlcbiAgICB9KVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzKS50aGVuKHJlbmRlcmVkUXVlc3Rpb25zID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGV4ZXJjaXNlRGF0YToge1xuICAgICAgICAgICAga25vd25zOiBKU09OLnN0cmluZ2lmeShrbm93bnMpLFxuICAgICAgICAgICAgdW5rbm93bnM6IEpTT04uc3RyaW5naWZ5KHVua25vd25zKSxcbiAgICAgICAgICAgIHVzZXJBbnN3ZXI6IFtdLFxuICAgICAgICAgICAgZXhlcmNpc2VJZDogZXhlcmNpc2UuaWQsXG4gICAgICAgICAgICBpZGVhbFRpbWU6IGV4ZXJjaXNlU29sdmVyLmdldEV4ZXJjaXNlSWRlYWxUaW1lKClcbiAgICAgICAgICB9LFxuICAgICAgICAgIGZvcm1hdHRlZDoge1xuICAgICAgICAgICAgcmVuZGVyZWRRdWVzdGlvbnMsXG4gICAgICAgICAgICB1bmtub3duczogdW5rbm93bnNWYXJpYWJsZXNcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLypcbiAgICBnZW5lcmF0ZWRFeGVyY2lzZTpcbiAgICB7XG4gICAgICBpZDogMTQwLFxuICAgICAgZXhlcmNpc2VIYXNoOiAnMzA2ZTc1YTU2MDE4NWMwOGZhOTkzN2UxMDk1ZDlhZjMnLFxuICAgICAga25vd25zOiAnW3tcImFcIjoxMCxcImJcIjozfSx7XCJhXCI6MTAsXCJiXCI6MX0se1wiYVwiOjEwLFwiYlwiOjV9LHtcImFcIjoxMCxcImJcIjo5fSx7XCJhXCI6MTAsXCJiXCI6Nn0se1wiYVwiOjEwLFwiYlwiOjJ9XScsXG4gICAgICB1bmtub3duczogJ1t7XCJ4XCI6MTN9LHtcInhcIjoxMX0se1wieFwiOjE1fSx7XCJ4XCI6MTl9LHtcInhcIjoxNn0se1wieFwiOjEyfV0nLFxuICAgICAgdXNlckFuc3dlcjogbnVsbCxcbiAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICBzY29yZTogbnVsbCxcbiAgICAgIHRpbWVGaW5pc2g6IG51bGwsXG4gICAgICBjcmVhdGVkQXQ6IDIwMTgtMDQtMTBUMDI6MjY6NTEuMDAwWixcbiAgICAgIHVwZGF0ZWRBdDogMjAxOC0wNC0xMFQwMjoyNjo1MS4wMDBaLFxuICAgICAgaWRlYWxUaW1lOiAxNSxcbiAgICAgIGV4ZXJjaXNlSWQ6IDM0LFxuICAgICAgdXNlcklkOiA5OVxuICAgIH1cblxuICAgIHJldHVybjpcbiAgICB7XG4gICAgICBcImZvcm1hdHRlZFwiOiB7XG4gICAgICAgIFwicmVuZGVyZWRRdWVzdGlvbnNcIjogW1xuICAgICAgICAgICAgXCJcXG48c3Bhbj48aW1nIHNyYz0naHR0cDovL2FwcC1maWxvc2VkdS5udXNhbnRhcmEtbG9jYWwuY29tL2ltYWdlcy8xNTE5Mzc5NTE5NzgyX3RlbnMuanBlZycgd2lkdGg9JzUlJyAvPjwvc3Bhbj5cXG48c3Bhbj48dGFibGUgY2xhc3M9XFxcImltYWdlLXJlcGVhdFxcXCIgc3R5bGU9XFxcIndpZHRoOiAyMy4zMzMzMzMzMzMzMzMzMzIlO1xcXCI+PHRib2R5Pjx0cj48dGQgc3R5bGU9XFxcInBhZGRpbmc6NXB4O1xcXCI+PGltZyBzcmM9XFxcImh0dHA6Ly9hcHAtZmlsb3NlZHUubnVzYW50YXJhLWxvY2FsLmNvbS9pbWFnZXMvMTUxOTM3OTUyNDkzMV91bml0LmpwZWdcXFwiIHdpZHRoPVxcXCIxMDAlXFxcIi8+PC90ZD48dGQgc3R5bGU9XFxcInBhZGRpbmc6NXB4O1xcXCI+PGltZyBzcmM9XFxcImh0dHA6Ly9hcHAtZmlsb3NlZHUubnVzYW50YXJhLWxvY2FsLmNvbS9pbWFnZXMvMTUxOTM3OTUyNDkzMV91bml0LmpwZWdcXFwiIHdpZHRoPVxcXCIxMDAlXFxcIi8+PC90ZD48dGQgc3R5bGU9XFxcInBhZGRpbmc6NXB4O1xcXCI+PGltZyBzcmM9XFxcImh0dHA6Ly9hcHAtZmlsb3NlZHUubnVzYW50YXJhLWxvY2FsLmNvbS9pbWFnZXMvMTUxOTM3OTUyNDkzMV91bml0LmpwZWdcXFwiIHdpZHRoPVxcXCIxMDAlXFxcIi8+PC90ZD48L3RyPjwvdGJvZHk+PC90YWJsZT48L3NwYW4+XFxuXFxuQmVyYXBhIGp1bWxhaCBiYWxvayBkaWF0YXM/IChkYWxhbSBhbmdrYSlcXG5cIixcbiAgICAgICAgXSxcbiAgICAgICAgXCJ1bmtub3duc1wiOiBbXG4gICAgICAgICAgICBbXCJ4XCJdLFxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgXCJleGVyY2lzZUlkXCI6IDM0XG4gICAgICBcImlkZWFsVGltZVwiOiA1XG4gICAgfVxuICAqL1xuICBmb3JtYXRFeGVyY2lzZSAoZ2VuZXJhdGVkRXhlcmNpc2UsIGV4ZXJjaXNlU29sdmVyKSB7XG4gICAgbGV0IGtub3ducyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2Uua25vd25zKVxuICAgIGxldCB1bmtub3ducyA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UudW5rbm93bnMpXG5cbiAgICByZXR1cm4gUHJvbWlzZS5qb2luKFxuICAgICAgUHJvbWlzZS5tYXAoa25vd25zLCBrbm93biA9PiB7XG4gICAgICAgIHJldHVybiBleGVyY2lzZVNvbHZlci5mb3JtYXRRdWVzdGlvbihrbm93bilcbiAgICAgIH0pLFxuICAgICAgUHJvbWlzZS5tYXAodW5rbm93bnMsIHVua25vd24gPT4ge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModW5rbm93bilcbiAgICAgIH0pXG4gICAgKS5zcHJlYWQoKGZvcm1hdHRlZFF1ZXN0aW9ucywgdW5rbm93bnMpID0+IHtcbiAgICAgIGxldCBkYXRhID0ge1xuICAgICAgICBmb3JtYXR0ZWQ6IHtcbiAgICAgICAgICByZW5kZXJlZFF1ZXN0aW9uczogZm9ybWF0dGVkUXVlc3Rpb25zLFxuICAgICAgICAgIHVua25vd25zXG4gICAgICAgIH0sXG4gICAgICAgIGV4ZXJjaXNlSWQ6IGdlbmVyYXRlZEV4ZXJjaXNlLmV4ZXJjaXNlSWQsXG4gICAgICAgIGlkZWFsVGltZTogZ2VuZXJhdGVkRXhlcmNpc2UuaWRlYWxUaW1lXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkYXRhXG4gICAgfSlcbiAgfVxuXG4gIC8vIEdpdmVuIGEgZ2VuZXJhdGVkIGV4ZXJjaXNlIGRhdGEsIGNyZWF0ZSBhbiBlbnRyeSBpbiBnZW5lcmF0ZWRFeGVyY2lzZSB0YWJsZVxuICAvLyBJZiB0aGUgdXNlciBhbHJlYWR5IGhhcyBhIGdlbmVyYXRlZEV4ZXJjaXNlLCBkZWxldGUgaXQgZmlyc3QgYmVmb3JlIGFkZGluZyBhIG5ldyBlbnRyeVxuICBzYXZlR2VuZXJhdGVkRXhlcmNpc2UgKHVzZXJJZCwgZ2VuZXJhdGVkRXhlcmNpc2UsIGV4ZXJjaXNlSGFzaCkge1xuICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnR2VuZXJhdGVkRXhlcmNpc2UnKS5kZXN0cm95KHt3aGVyZToge1xuICAgICAgdXNlcklkLFxuICAgICAgZXhlcmNpc2VJZDogZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VJZCxcbiAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICBvbkNsb3VkOiBBcHBDb25maWcuQ0xPVURfU0VSVkVSXG4gICAgfX0pLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlPEdlbmVyYXRlZEV4ZXJjaXNlPih7XG4gICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZEV4ZXJjaXNlJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGV4ZXJjaXNlSGFzaCxcbiAgICAgICAgICBrbm93bnM6IGdlbmVyYXRlZEV4ZXJjaXNlLmtub3ducyxcbiAgICAgICAgICB1bmtub3duczogZ2VuZXJhdGVkRXhlcmNpc2UudW5rbm93bnMsXG4gICAgICAgICAgZXhlcmNpc2VJZDogZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VJZCxcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgaWRlYWxUaW1lOiBnZW5lcmF0ZWRFeGVyY2lzZS5pZGVhbFRpbWUsXG4gICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICAvKlxuICAgIElucHV0OlxuICAgICAgaWQ6IDEsXG4gICAgICBzY29yZTogMixcbiAgICAgIHVzZXJBbnN3ZXI6ICdbe3g6IFwiM1wifV0nLFxuICAgICAgc3VibWl0dGVkOiB0cnVlLFxuICAgICAgdGltZUZpbmlzaDogMjMuMDlcbiAgKi9cbiAgdXBkYXRlR2VuZXJhdGVkRXhlcmNpc2UgKGRhdGEpIHtcbiAgICByZXR1cm4gdGhpcy51cGRhdGU8R2VuZXJhdGVkRXhlcmNpc2U+KHtcbiAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZEV4ZXJjaXNlJyxcbiAgICAgIGRhdGFcbiAgICB9KVxuICB9XG5cbiAgLy8gR2V0IGV4ZXJjaXNlIHRoYXQgaXMgY3VyZW50bHkgYWN0aXZlXG4gIGdldEdlbmVyYXRlZEV4ZXJjaXNlICh7IHVzZXJJZCwgZXhlcmNpc2VJZCB9KSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxHZW5lcmF0ZWRFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkRXhlcmNpc2UnLFxuICAgICAgc2VhcmNoQ2xhdXNlOiB7IHVzZXJJZCwgZXhlcmNpc2VJZCwgc3VibWl0dGVkOiBmYWxzZSwgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUiB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEdldCBhbGwgZXhlcmNpc2VzIHRoYXQgaGF2ZSBiZWVuIHN1Ym1pdHRlZFxuICBnZXRTdWJtaXR0ZWRFeGVyY2lzZXMgKHsgdXNlcklkLCBleGVyY2lzZUlkIH0pIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkPEdlbmVyYXRlZEV4ZXJjaXNlPih7XG4gICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRFeGVyY2lzZScsXG4gICAgICBzZWFyY2hDbGF1c2U6IHsgdXNlcklkLCBleGVyY2lzZUlkLCBzdWJtaXR0ZWQ6IHRydWUgfVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgdXNlciBzY29yZSBvZiBhbiBleGVyY2lzZVxuICAvL1xuICAvLyBSZXR1cm46XG4gIC8vIDAgLSA0OiBIb3cgbWFueSBvZiB0aGUgc3VibWl0dGVkIHNjb3JlcyBhcmUgPiA4MCVcbiAgZ2V0RXhlcmNpc2VTdGFycyAodXNlcklkLCBpZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBcblNFTEVDVCBzY29yZSBGUk9NIGdlbmVyYXRlZEV4ZXJjaXNlc1xuV0hFUkUgc3VibWl0dGVkID0gMSBBTkQgdXNlcklkID0gJHt1c2VySWR9IEFORCBleGVyY2lzZUlkID0gJHtpZH1cbk9SREVSIEJZIHNjb3JlIERFU0MgTElNSVQgNDtgLFxuICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4oZGF0YXMgPT4ge1xuICAgICAgY29uc3Qgc3RhcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgZGF0YSkgPT4ge1xuICAgICAgICBpZiAocGFyc2VJbnQoZGF0YS5zY29yZSwgMTApID49IDgwKSB7XG4gICAgICAgICAgcmV0dXJuIGFjYyArIDFcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gYWNjXG4gICAgICAgIH1cbiAgICAgIH0sIDApXG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgc3RhcnMgfSB9XG4gICAgfSlcbiAgfVxuXG4gIC8qXG4gICAgaWYgcmVuZGVyU3RhciBpcyB0cnVlXG4gICAgICB3aWxsIHJldHVybiB7XG4gICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGh0bWw6ICcgPHNwYW4+PGltZyAvPjwvc3Bhbj4nXG4gICAgICAgICAgc3RhcnM6IDAtNFxuICAgICAgICB9XG4gICAgICB9XG4gICAgZWxzZVxuICAgICAge1xuICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBzdGFyczogMC00XG4gICAgICAgIH1cbiAgICAgIH1cbiAgKi9cbiAgZ2V0UmVuZGVyZWRFeGVyY2lzZVN0YXJzICh1c2VySWQsIGlkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VTdGFycyh1c2VySWQsIGlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IHN0YXJzID0gcmVzcC5kYXRhLnN0YXJzXG4gICAgICAgIGNvbnN0IGh0bWwgPSBwdWcucmVuZGVyRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwL3ZpZXdzL25vbi1wYWdlcy9zdGFycy5wdWcnKSwgeyBzdGFycyB9KVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGh0bWwgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3BcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gU3BlY2lhbGx5IGNhbGxlZCBmcm9tIGNvdXJzZSBjb250cm9sbGVyXG4gIGdldFN1YnRvcGljU3RhciAodXNlcklkLCBzdWJ0b3BpY0lkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPGFueT4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkPEV4ZXJjaXNlPih7XG4gICAgICBtb2RlbE5hbWU6ICdFeGVyY2lzZScsIHNlYXJjaENsYXVzZTogeyBzdWJ0b3BpY0lkIH1cbiAgICB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UubWFwKHJlc3AuZGF0YSB8fCBbXSwgKGV4ZXJjaXNlOiBFeGVyY2lzZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRFeGVyY2lzZVN0YXJzKHVzZXJJZCwgZXhlcmNpc2UuaWQpXG4gICAgICB9KS50aGVuKGRhdGFzID0+IHtcbiAgICAgICAgY29uc3Qgc3RhcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgcmVzcCkgPT4ge1xuICAgICAgICAgIHJldHVybiBhY2MgKyByZXNwLmRhdGEuc3RhcnNcbiAgICAgICAgfSwgMCkgLyAoZGF0YXMubGVuZ3RoIHx8IDEpXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBzdGFycyB9IH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIC8vIEdldCB1c2VyIHNjb3JlIG9mIGFuIGV4ZXJjaXNlXG4gIC8vXG4gIC8vIFJldHVybjpcbiAgLy8gMCAtIDQ6IEhvdyBtYW55IG9mIHRoZSBzdWJtaXR0ZWQgc2NvcmVzIGFyZSA+IDgwJVxuICBnZXRFeGVyY2lzZVRpbWVycyAodXNlcklkLCBleGVyY2lzZUlkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFxuU0VMRUNUIHNjb3JlIEZST00gZ2VuZXJhdGVkRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSAxIEFORCB1c2VySWQgPSAke3VzZXJJZH0gQU5EIGV4ZXJjaXNlSWQgPSAke2V4ZXJjaXNlSWR9XG5BTkQgdGltZUZpbmlzaCA8IGlkZWFsVGltZSBBTkQgc2NvcmUgPSAxMDBcbk9SREVSIEJZIHNjb3JlIERFU0MgTElNSVQgNDtgLFxuICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4oZGF0YXMgPT4ge1xuICAgICAgY29uc3QgdGltZXJzID0gZGF0YXMucmVkdWNlKChhY2MsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHBhcnNlSW50KGRhdGEuc2NvcmUsIDEwKSA+PSAxMDApIHtcbiAgICAgICAgICByZXR1cm4gYWNjICsgMVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBhY2NcbiAgICAgICAgfVxuICAgICAgfSwgMClcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB0aW1lcnMgfSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFJlbmRlcmVkRXhlcmNpc2VUaW1lcnMgKHVzZXJJZCwgaWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRFeGVyY2lzZVRpbWVycyh1c2VySWQsIGlkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IHRpbWVycyA9IHJlc3AuZGF0YS50aW1lcnNcbiAgICAgICAgY29uc3QgaHRtbCA9IHB1Zy5yZW5kZXJGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAvdmlld3Mvbm9uLXBhZ2VzL3RpbWVycy5wdWcnKSwgeyB0aW1lcnMgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBodG1sIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAocmVzcClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0U3VidG9waWNFeGVyY2lzZVRpbWVycyAodXNlcklkLCBzdWJ0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZDxFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnRXhlcmNpc2UnLCBzZWFyY2hDbGF1c2U6IHsgc3VidG9waWNJZCB9XG4gICAgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLm1hcChyZXNwLmRhdGEgfHwgW10sIChleGVyY2lzZTogRXhlcmNpc2UpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VUaW1lcnModXNlcklkLCBleGVyY2lzZS5pZClcbiAgICAgIH0pLnRoZW4oZGF0YXMgPT4ge1xuICAgICAgICBjb25zdCB0aW1lcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgcmVzcCkgPT4ge1xuICAgICAgICAgIHJldHVybiBhY2MgKyByZXNwLmRhdGEudGltZXJzXG4gICAgICAgIH0sIDApIC8gKGRhdGFzLmxlbmd0aCB8fCAxKVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgdGltZXJzIH0gfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLy8gR2V0IGxlYWRlcmJvYXJkIGRhdGFcbiAgZ2V0RXhlcmNpc2VSYW5raW5nIChleGVyY2lzZUlkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoXG5gU0VMRUNUIE1JTih0aW1lRmluaXNoKSBBUyB0aW1lRmluaXNoLCB1c2VySWQsIHVzZXJzLmZ1bGxOYW1lIEFTIGZ1bGxOYW1lLCB1c2Vycy5ncmFkZSBBUyBncmFkZSwgc2Nob29scy5uYW1lIEFTIHNjaG9vbE5hbWVcbkZST00gZ2VuZXJhdGVkRXhlcmNpc2VzIElOTkVSIEpPSU4gdXNlcnMgT04gdXNlcnMuaWQgPSBnZW5lcmF0ZWRFeGVyY2lzZXMudXNlcklkIElOTkVSIEpPSU4gc2Nob29scyBPTiBzY2hvb2xzLmlkID0gdXNlcnMuc2Nob29sSWRcbldIRVJFIHN1Ym1pdHRlZCA9IFRSVUUgQU5EIGV4ZXJjaXNlSWQgPSAke2V4ZXJjaXNlSWR9IEFORCBzY29yZSA9IDEwMCBBTkQgdGltZUZpbmlzaCBJUyBOT1QgTlVMTCBHUk9VUCBCWSB1c2VySWQgT1JERVIgQlkgTUlOKHRpbWVGaW5pc2gpIExJTUlUIDEwO2AsXG4gICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXNwID0+IHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcCB9XG4gICAgfSlcbiAgfVxuXG4gIGdldEV4ZXJjaXNlTGVhZGVyYm9hcmQgKGV4ZXJjaXNlSWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRFeGVyY2lzZVJhbmtpbmcoZXhlcmNpc2VJZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICBjb25zdCBleGVyY2lzZURhdGEgPSByZXNwLmRhdGFcbiAgICAgICAgY29uc3QgaHRtbCA9IHB1Zy5yZW5kZXJGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAvdmlld3Mvbm9uLXBhZ2VzL3JhbmtpbmcucHVnJyksIHsgZXhlcmNpc2VEYXRhIH0pXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogaHRtbCB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gKHJlc3ApXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEdldCB0aGUgbnVtYmVyIG9mIHJhbmsgaW4gbGVhZGVyYm9hcmRcbiAgZ2V0Q3VycmVudFJhbmtpbmcgKHRpbWVGaW5pc2gsIGV4ZXJjaXNlSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IHF1ZXJ5REIgPSBgU0VMRUNUIENPVU5UKCopIEFTIHRvdGFsXG4gIEZST00gKFNFTEVDVCBDT1VOVCgqKSBGUk9NIGdlbmVyYXRlZEV4ZXJjaXNlc1xuICBXSEVSRSBzdWJtaXR0ZWQgPSBUUlVFIEFORCB0aW1lRmluaXNoIDwgJHt0aW1lRmluaXNofSBBTkRcbiAgICAgICAgZXhlcmNpc2VJZCA9ICR7ZXhlcmNpc2VJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMXG4gIEdST1VQIEJZIHVzZXJJZFxuICBPUkRFUiBCWSBNSU4odGltZUZpbmlzaCkpIEFTIHRvdGFscm93O2BcbiAgICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KHF1ZXJ5REIsXG4gICAgICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBjb3VudDogcmVzcFswXS50b3RhbCB9IH0pXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLy8gR2V0IHRoZSBudW1iZXIgb2Ygc3VibWlzc2lvbnMgaW4gdGhlIGxlYWRlcmJvYXJkXG4gIGdldFRvdGFsUmFua2luZyAoZXhlcmNpc2VJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgcXVlcnlEQiA9IGBTRUxFQ1QgQ09VTlQoKikgQVMgdG90YWxcbkZST00gKFNFTEVDVCBDT1VOVCgqKSBGUk9NIGdlbmVyYXRlZEV4ZXJjaXNlcyBXSEVSRSBzdWJtaXR0ZWQgPSBUUlVFIEFORCBleGVyY2lzZUlkID0gJHtleGVyY2lzZUlkfVxuICAgICAgICAgICAgICAgICAgICAgIEFORCBzY29yZSA9IDEwMCBBTkQgdGltZUZpbmlzaCBJUyBOT1QgTlVMTFxuR1JPVVAgQlkgdXNlcklkXG5PUkRFUiBCWSBNSU4odGltZUZpbmlzaCkpIEFTIHRvdGFscm93O2BcbiAgICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KHF1ZXJ5REIsXG4gICAgICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBjb3VudDogcmVzcFswXS50b3RhbCB9IH0pXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgfSlcbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBFeGVyY2lzZVNlcnZpY2UoKVxuIl19
