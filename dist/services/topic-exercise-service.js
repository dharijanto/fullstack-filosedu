"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),crud_service_neo_1=require("./crud-service-neo"),exercise_generator_1=require("../lib/exercise_generator/exercise-generator"),exercise_service_1=require("./exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),moment=require("moment"),Sequelize=require("sequelize");const AppConfig=require(path.join(__dirname,"../app-config")),Utils=require(path.join(__dirname,"../lib/utils")),TAG="TopicExerciseService";class TopicExerciseService extends crud_service_neo_1.default{getTopic(e){return this.readOne({modelName:"Topic",searchClause:{id:e}})}getFormattedExercise(e,t){return e&&t?Promise.join(this.getExercises(e),this.getGeneratedTopicExercise(t,e),this.getExercisesHash(e),this.getTopic(e)).spread((r,s,i,a)=>{if(i.status&&a.status){const a=i.data;if(s.status&&s.data&&s.data.topicExerciseHash===a)return this.formatGeneratedTopicExercise(s.data);if(r.status&&r.data&&(s.status&&s.data&&s.data.topicExerciseHash!==a||!s.status))return this.generateExercise(e,t,r.data).then(e=>e.status&&e.data?this.formatGeneratedTopicExercise(e.data):{status:!1,errMessage:e.errMessage});throw new Error("Unexpected error!")}throw new Error(`Failed to retrieve topic or topicExerciseHash: ${i.errMessage||a.errMessage}`)}):Promise.resolve({status:!1,errMessage:"topicId and userId are required!"})}getExercises(e){return this.getSequelize().query(`\nSELECT exercises.id, exercises.data, exercises.createdAt, exercises.updatedAt, exercises.subtopicId\nFROM exercises AS exercises\nINNER JOIN subtopics AS subtopic ON exercises.subtopicId = subtopic.id AND subtopic.topicId = ${e}\nORDER BY subtopic.subtopicNo ASC, exercises.id ASC;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getExercisesHash(e){return this.getExercises(e).then(e=>{if(e.status&&e.data){const t=e.data.reduce((e,t)=>e+exercise_generator_1.default.getHash(t),"");return{status:!0,data:exercise_generator_1.default.getHash(t)}}return{status:!1,errMessage:e.errMessage}})}generateExercise(e,t,r){return this.getExercisesHash(e).then(s=>{if(s.status&&s.data){const i=s.data;return Promise.map(r,e=>exercise_service_1.default.generateExercise(e,!0).then(e=>{if(e.status){return JSON.parse(e.data.exerciseData.knowns).length>0?{exerciseData:e.data.exerciseData}:null}return null})).then(r=>{const s=[];let a=0;return r.filter(function(e){return null!=e}).forEach(e=>{a+=e.exerciseData.idealTime,s.push(e.exerciseData)}),this.getModels("GeneratedTopicExercise").destroy({where:{topicId:e,userId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}}).then(()=>this.create({modelName:"GeneratedTopicExercise",data:{topicId:e,userId:t,exerciseDetail:JSON.stringify(s),topicExerciseHash:i,idealTime:a,onCloud:AppConfig.CLOUD_SERVER}}))})}return{status:!1,errMessage:"Failed to retrieve exercise hash!"}})}formatGeneratedTopicExercise(e){const t=e.topicId,r=JSON.parse(e.exerciseDetail);return Promise.map(r,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){let r=exercise_generator_1.default.getExerciseSolver(t.data.data),s=[],i=[];return JSON.parse(e.knowns).forEach(e=>{i.push(r.formatQuestion(e))}),JSON.parse(e.unknowns).forEach(e=>{s.push(Object.keys(e))}),Promise.all(i).then(e=>({renderedQuestions:e,unknowns:s}))}throw new Error(t.errMessage)})).then(r=>this.readOne({modelName:"Topic",searchClause:{id:t}}).then(t=>t.status&&t.data?{status:!0,data:{topicName:t.data.topic,formattedExercises:r,idealTime:e.idealTime,elapsedTime:Utils.getElapsedTime(e.createdAt)}}:{status:!1,errMessage:""}))}gradeExercise(e,t){return Promise.map(e,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){const r=t.data,s=exercise_generator_1.default.getExerciseSolver(r.data),i=JSON.parse(e.knowns),a=JSON.parse(e.unknowns);return i.map((e,t)=>({known:e,correctAnswer:a[t],isAnswerFn:s.isAnswer.bind(s)}))}throw new Error("Exercise with id="+e.exerciseId+" could not be found!")})).then(e=>e.reduce((e,t)=>e.concat(t),[]).reduce((e,t)=>e.concat(t),[])).then(e=>{console.dir(e);const{numCorrectAnswers:r,correctAnswers:s,isCorrect:i}=e.reduce((e,r,s)=>{const i=r.isAnswerFn(r.known,t[s]);return e.numCorrectAnswers+=i?1:0,e.correctAnswers.push(r.correctAnswer),e.isCorrect.push(i),e},{numCorrectAnswers:0,correctAnswers:[],isCorrect:[]}),a=e.length;return{status:!0,data:{numQuestions:a,numCorrectAnswers:r,correctAnswers:s,isCorrect:i,score:parseFloat(r)/a*100}}})}finishExercise(e,t,r,s,i){let a=0;const n=JSON.stringify(s.map(e=>{console.dir(e);const t=[];return JSON.parse(e.knowns).forEach(e=>{t.push(i[a]),a++}),e.userAnswer=JSON.stringify(t),e}));return this.update({modelName:"GeneratedTopicExercise",data:{id:e,submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),onCloud:AppConfig.CLOUD_SERVER,score:t,timeFinish:r,exerciseDetail:n}})}getGeneratedTopicExercise(e,t){return this.readOne({modelName:"GeneratedTopicExercise",searchClause:{userId:e,topicId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}})}getStarBadges(e,t){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e}\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{stars:e.reduce((e,t)=>parseInt(t.score,10)>=80?e+1:e,0)}}})}getRenderedStarBadges(e,t){return this.getStarBadges(e,t).then(e=>{if(e.status){const t=e.data.stars;return{status:!0,data:{html:pug.renderFile(path.join(__dirname,"../app/views/non-pages/stars.pug"),{stars:t}),stars:t}}}return e})}getCheckmarkBadge(e,t,r=!1){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e} AND score > 80\nORDER BY score DESC LIMIT 1;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{const t=e.length>0;if(r){return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ceckmark.pug"),{isChecked:t})}}return{status:!0,data:{isChecked:t}}})}getTimerBadges(e,t){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e}\nAND timeFinish < idealTime AND score = 100\nORDER BY score DESC LIMIT 1;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{timers:e.reduce((e,t)=>parseInt(t.score,10)>=80?e+1:e,0)}}})}getRenderedTimerBadges(e,t){return this.getTimerBadges(e,t).then(e=>{if(e.status){const t=e.data.timers;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/timers.pug"),{timers:t})}}return e})}getRanking(e){return this.getSequelize().query(`SELECT MIN(timeFinish) AS timeFinish, userId, users.fullName AS fullName, users.grade AS grade, schools.name AS schoolName\nFROM generatedTopicExercises INNER JOIN users ON users.id = generatedTopicExercises.userId INNER JOIN schools ON schools.id = users.schoolId\nWHERE submitted = TRUE AND topicId = ${e} AND score = 100 AND timeFinish IS NOT NULL GROUP BY userId ORDER BY MIN(timeFinish) LIMIT 10;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getRenderedLeaderboard(e){return this.getRanking(e).then(e=>{if(e.status){const t=e.data;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ranking.pug"),{exerciseData:t})}}return e})}getCurrentRanking(e,t){return new Promise((r,s)=>{const i=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedTopicExercises\nWHERE submitted = TRUE AND timeFinish < ${e} AND topicId = ${t} AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(i,{type:Sequelize.QueryTypes.SELECT}).then(e=>{r({status:!0,data:{count:e[0].total}})}).catch(e=>{s(e)})})}getTotalRanking(e){return new Promise((t,r)=>{let s=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedTopicExercises WHERE submitted = TRUE AND topicId = ${e} AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(s,{type:Sequelize.QueryTypes.SELECT}).then(e=>{t({status:!0,data:{count:e[0].total}})}).catch(e=>{r(e)})})}}exports.default=new TopicExerciseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy90b3BpYy1leGVyY2lzZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwiY3J1ZF9zZXJ2aWNlX25lb18xIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwibW9tZW50IiwiU2VxdWVsaXplIiwiQXBwQ29uZmlnIiwiam9pbiIsIl9fZGlybmFtZSIsIlV0aWxzIiwiVEFHIiwiVG9waWNFeGVyY2lzZVNlcnZpY2UiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwidG9waWNJZCIsInRoaXMiLCJyZWFkT25lIiwibW9kZWxOYW1lIiwic2VhcmNoQ2xhdXNlIiwiaWQiLCJ1c2VySWQiLCJnZXRFeGVyY2lzZXMiLCJnZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIiwiZ2V0RXhlcmNpc2VzSGFzaCIsImdldFRvcGljIiwic3ByZWFkIiwicmVzcCIsInJlc3AyIiwicmVzcDMiLCJyZXNwNCIsInN0YXR1cyIsInRvcGljRXhlcmNpc2VIYXNoIiwiZGF0YSIsImZvcm1hdEdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZUV4ZXJjaXNlIiwidGhlbiIsInJlc3A1IiwiZXJyTWVzc2FnZSIsIkVycm9yIiwicmVzb2x2ZSIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJjb21iaW5lZEhhc2giLCJyZWR1Y2UiLCJhY2MiLCJoYXNoIiwiZ2V0SGFzaCIsImV4ZXJjaXNlcyIsIm1hcCIsImV4ZXJjaXNlIiwiSlNPTiIsInBhcnNlIiwiZXhlcmNpc2VEYXRhIiwia25vd25zIiwibGVuZ3RoIiwicmVzdWx0cyIsImV4ZXJjaXNlRGV0YWlsIiwiaWRlYWxUaW1lIiwiZmlsdGVyIiwidmFsdWUiLCJmb3JFYWNoIiwicmVzdWx0IiwicHVzaCIsImdldE1vZGVscyIsImRlc3Ryb3kiLCJ3aGVyZSIsInN1Ym1pdHRlZCIsIm9uQ2xvdWQiLCJDTE9VRF9TRVJWRVIiLCJjcmVhdGUiLCJzdHJpbmdpZnkiLCJnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIiwiZ2VuZXJhdGVkRXhlcmNpc2VzIiwiZ2VuZXJhdGVkRXhlcmNpc2UiLCJleGVyY2lzZUlkIiwiZXhlcmNpc2VTb2x2ZXIiLCJnZXRFeGVyY2lzZVNvbHZlciIsInVua25vd25zIiwiZm9ybWF0dGVkUXVlc3Rpb25zUHJvbWlzZXMiLCJmb3JtYXRRdWVzdGlvbiIsIl91bmtub3ducyIsIk9iamVjdCIsImtleXMiLCJhbGwiLCJyZW5kZXJlZFF1ZXN0aW9ucyIsImZvcm1hdHRlZEV4ZXJjaXNlcyIsInRvcGljTmFtZSIsInRvcGljIiwiZWxhcHNlZFRpbWUiLCJnZXRFbGFwc2VkVGltZSIsImNyZWF0ZWRBdCIsImdlbmVyYXRlZEV4ZXJjaXNlRGV0YWlscyIsImFuc3dlcnMiLCJrbm93biIsImluZGV4IiwiY29ycmVjdEFuc3dlciIsImlzQW5zd2VyRm4iLCJpc0Fuc3dlciIsImJpbmQiLCJ0b3BpY0V4ZXJjaXNlQXJyYXkiLCJleGVyY2lzZUFycmF5IiwiY29uY2F0IiwicXVlc3Rpb25BcnJheSIsImNvbnNvbGUiLCJkaXIiLCJudW1Db3JyZWN0QW5zd2VycyIsImNvcnJlY3RBbnN3ZXJzIiwiaXNDb3JyZWN0IiwibnVtUXVlc3Rpb25zIiwic2NvcmUiLCJwYXJzZUZsb2F0IiwiZ2VuZXJhdGVkVG9waWNFeGVyY2lzZUlkIiwidGltZUZpbmlzaCIsImV4ZXJjaXNlRGV0YWlscyIsImFuc3dlckluZGV4IiwiZXhlcmNpc2VEZXRhaWxBbnN3ZXJzIiwiXyIsInVzZXJBbnN3ZXIiLCJ1cGRhdGUiLCJzdWJtaXR0ZWRBdCIsImxvY2FsIiwiZm9ybWF0IiwiZGF0YXMiLCJzdGFycyIsInBhcnNlSW50IiwiZ2V0U3RhckJhZGdlcyIsImh0bWwiLCJyZW5kZXJGaWxlIiwicmVuZGVyIiwiaXNDaGVja2VkIiwidGltZXJzIiwiZ2V0VGltZXJCYWRnZXMiLCJnZXRSYW5raW5nIiwicmVqZWN0IiwicXVlcnlEQiIsImNvdW50IiwidG90YWwiLCJjYXRjaCIsImVyciIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJvRUFBQSxNQUFBQSxRQUFBQyxRQUFBLFlBRUFDLG1CQUFBRCxRQUFBLHNCQUNBRSxxQkFBQUYsUUFBQSxnREFDQUcsbUJBQUFILFFBQUEsc0JBRUEsSUFBSUksS0FBT0osUUFBUSxRQUVmSyxJQUFNTCxRQUFRLFVBQ2RNLElBQU1OLFFBQVEsT0FDZE8sT0FBU1AsUUFBUSxVQUNqQlEsVUFBWVIsUUFBUSxhQUV4QixNQUFNUyxVQUFZVCxRQUFRSSxLQUFLTSxLQUFLQyxVQUFXLGtCQUN6Q0MsTUFBUVosUUFBUUksS0FBS00sS0FBS0MsVUFBVyxpQkFFckNFLElBQU0sNkJBb0JaQyw2QkFBbUNiLG1CQUFBYyxRQUV6QkMsU0FBVUMsR0FDaEIsT0FBT0MsS0FBS0MsU0FBaUJDLFVBQVcsUUFBU0MsY0FBZ0JDLEdBQUlMLEtBS3ZFRCxxQkFBc0JDLEVBQVNNLEdBQzdCLE9BQUlOLEdBQVdNLEVBQ054QixRQUFRVyxLQUNiUSxLQUFLTSxhQUFhUCxHQUNsQkMsS0FBS08sMEJBQTBCRixFQUFRTixHQUN2Q0MsS0FBS1EsaUJBQWlCVCxHQUN0QkMsS0FBS1MsU0FBU1YsSUFDZFcsT0FBTyxDQUFDQyxFQUE4QkMsRUFDOUJDLEVBQTJCQyxLQUNuQyxHQUFJRCxFQUFNRSxRQUFVRCxFQUFNQyxPQUFRLENBQ2hDLE1BQU1DLEVBQW9CSCxFQUFNSSxLQUVoQyxHQUFJTCxFQUFNRyxRQUFVSCxFQUFNSyxNQUFRTCxFQUFNSyxLQUFLRCxvQkFBc0JBLEVBQ2pFLE9BQU9oQixLQUFLa0IsNkJBQTZCTixFQUFNSyxNQUUxQyxHQUFJTixFQUFLSSxRQUFVSixFQUFLTSxPQUNuQkwsRUFBTUcsUUFBVUgsRUFBTUssTUFBUUwsRUFBTUssS0FBS0Qsb0JBQXNCQSxJQUNoRUosRUFBTUcsUUFDZixPQUFPZixLQUFLbUIsaUJBQWlCcEIsRUFBU00sRUFBUU0sRUFBS00sTUFBTUcsS0FB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QyxLQUFLeUIsZUFBZUMsTUFBTWdHLEdBQzdCL0YsS0FBTXJDLFVBQVVzQyxXQUFXQyxTQUFVVCxLQUFLVCxJQUMxQ2EsR0FBVVQsUUFBUSxFQUFNRSxNQUFRMEcsTUFBT2hILEVBQUssR0FBR2lILFdBQzlDQyxNQUFNQyxJQUNQTCxFQUFPSyxRQU1qQkMsUUFBQWxJLFFBQWUsSUFBSUQiLCJmaWxlIjoic2VydmljZXMvdG9waWMtZXhlcmNpc2Utc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgQnJ1dGVmb3JjZVNvbHZlciwgeyBHZW5lcmF0ZWRRdWVzdGlvbkRhdGEgfSBmcm9tICcuLi9saWIvZXhlcmNpc2VfZ2VuZXJhdG9yL2V4ZXJjaXNlX3NvbHZlcnMvYnJ1dGVmb3JjZS1zb2x2ZXInXG5pbXBvcnQgQ1JVRFNlcnZpY2UgZnJvbSAnLi9jcnVkLXNlcnZpY2UtbmVvJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IEV4ZXJjaXNlU2VydmljZSBmcm9tICcuL2V4ZXJjaXNlLXNlcnZpY2UnXG5cbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxubGV0IHB1ZyA9IHJlcXVpcmUoJ3B1ZycpXG5sZXQgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50JylcbmxldCBTZXF1ZWxpemUgPSByZXF1aXJlKCdzZXF1ZWxpemUnKVxuXG5jb25zdCBBcHBDb25maWcgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAtY29uZmlnJykpXG5jb25zdCBVdGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xpYi91dGlscycpKVxuXG5jb25zdCBUQUcgPSAnVG9waWNFeGVyY2lzZVNlcnZpY2UnXG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbCB7XG4gIGtub3duczogc3RyaW5nLCAvLyBzdHJpbmdpZmllZCBKU09OXG4gIHVua25vd25zOiBzdHJpbmcsIC8vIHN0cmluZ2lmaWVkIEpTT05cbiAgdXNlckFuc3dlcjogc3RyaW5nLCAvLyBzdHJpbmdpZmllZCBKU09OXG4gIGV4ZXJjaXNlSGFzaDogc3RyaW5nXG4gIGV4ZXJjaXNlSWQ6IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRvcGljRXhlcmNpc2VHcmFkZSB7XG4gIG51bVF1ZXN0aW9uczogbnVtYmVyXG4gIG51bUNvcnJlY3RBbnN3ZXJzOiBudW1iZXJcbiAgY29ycmVjdEFuc3dlcnM6IEFycmF5PHtba2V5OiBzdHJpbmddOiBhbnl9PlxuICBpc0NvcnJlY3Q6IEFycmF5PGJvb2xlYW4+XG4gIHNjb3JlOiBudW1iZXJcbn1cblxuZXhwb3J0IHR5cGUgVG9waWNFeGVyY2lzZUFuc3dlciA9IEFycmF5PHtba2V5OiBzdHJpbmddOiBhbnl9PlxuXG5jbGFzcyBUb3BpY0V4ZXJjaXNlU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgLy8gVE9ETzogV2Ugc2hvdWxkIHVzZSB2ZXJzaW9uIG9uIGNvdXJzZVNlcnZpY2UgaW5zdGVhZCBvZiB0aGlzXG4gIHByaXZhdGUgZ2V0VG9waWMgKHRvcGljSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8VG9waWM+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxUb3BpYz4oeyBtb2RlbE5hbWU6ICdUb3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogdG9waWNJZCB9IH0pXG4gIH1cblxuICAvLyBHZXQgYSBmb3JtYXR0ZWQgVG9waWNFeGVyY2lzZSByZWFkeSBmb3IgdXNlLiBJZiB0aGVyZSdzIHByZXZpb3VzbHkgZ2VuZXJhdGVkXG4gIC8vIHRoYXQgaGFzbid0IGJlZW4gc3VibWl0dGVkLCB0aGlzIHdpbGwgcmVzdG9yZSBpdC4gT3RoZXJ3aXNlLCBpdCdsbCBnZW5lcmF0ZSBvbmUuXG4gIGdldEZvcm1hdHRlZEV4ZXJjaXNlICh0b3BpY0lkLCB1c2VySWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8Rm9ybWF0dGVkVG9waWNFeGVyY2lzZT4+IHtcbiAgICBpZiAodG9waWNJZCAmJiB1c2VySWQpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLmpvaW48YW55PihcbiAgICAgICAgdGhpcy5nZXRFeGVyY2lzZXModG9waWNJZCksXG4gICAgICAgIHRoaXMuZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSh1c2VySWQsIHRvcGljSWQpLFxuICAgICAgICB0aGlzLmdldEV4ZXJjaXNlc0hhc2godG9waWNJZCksXG4gICAgICAgIHRoaXMuZ2V0VG9waWModG9waWNJZClcbiAgICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPEV4ZXJjaXNlW10+LCByZXNwMjogTkNSZXNwb25zZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPixcbiAgICAgICAgICAgICAgICByZXNwMzogTkNSZXNwb25zZTxzdHJpbmc+LCByZXNwNDogTkNSZXNwb25zZTxUb3BpYz4pID0+IHtcbiAgICAgICAgaWYgKHJlc3AzLnN0YXR1cyAmJiByZXNwNC5zdGF0dXMpIHtcbiAgICAgICAgICBjb25zdCB0b3BpY0V4ZXJjaXNlSGFzaCA9IHJlc3AzLmRhdGFcbiAgICAgICAgICAvLyBJZiB0aGVyZSdzIHZhbGlkIGV4ZXJjaXNlIHRvIGJlIHJlc3RvcmVkXG4gICAgICAgICAgaWYgKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmIHJlc3AyLmRhdGEudG9waWNFeGVyY2lzZUhhc2ggPT09IHRvcGljRXhlcmNpc2VIYXNoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKHJlc3AyLmRhdGEpXG4gICAgICAgICAgLy8gSWYgdGhlcmUncyBleHBpcmVkIGdlbmVyYXRlZCBleGVyY2lzZSBvciBubyBnZW5lcmF0ZWQgZXhlcmNpc2UgdG8gYmUgcmVzdG9yZWRcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSAmJlxuICAgICAgICAgICAgICAgICAgICAoKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmIHJlc3AyLmRhdGEudG9waWNFeGVyY2lzZUhhc2ggIT09IHRvcGljRXhlcmNpc2VIYXNoKSB8fFxuICAgICAgICAgICAgICAgICAgICAhcmVzcDIuc3RhdHVzKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVFeGVyY2lzZSh0b3BpY0lkLCB1c2VySWQsIHJlc3AuZGF0YSkudGhlbihyZXNwNSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXNwNS5zdGF0dXMgJiYgcmVzcDUuZGF0YSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEdlbmVyYXRlZFRvcGljRXhlcmNpc2UocmVzcDUuZGF0YSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwNS5lcnJNZXNzYWdlIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gV2Ugc2hvdWxkIG5ldmVyIGdldCBoZXJlLi5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBlcnJvciEnKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSB0b3BpYyBvciB0b3BpY0V4ZXJjaXNlSGFzaDogJHtyZXNwMy5lcnJNZXNzYWdlIHx8IHJlc3A0LmVyck1lc3NhZ2V9YClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICd0b3BpY0lkIGFuZCB1c2VySWQgYXJlIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEV4ZXJjaXNlcyAodG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxFeGVyY2lzZVtdPj4ge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBcblNFTEVDVCBleGVyY2lzZXMuaWQsIGV4ZXJjaXNlcy5kYXRhLCBleGVyY2lzZXMuY3JlYXRlZEF0LCBleGVyY2lzZXMudXBkYXRlZEF0LCBleGVyY2lzZXMuc3VidG9waWNJZFxuRlJPTSBleGVyY2lzZXMgQVMgZXhlcmNpc2VzXG5JTk5FUiBKT0lOIHN1YnRvcGljcyBBUyBzdWJ0b3BpYyBPTiBleGVyY2lzZXMuc3VidG9waWNJZCA9IHN1YnRvcGljLmlkIEFORCBzdWJ0b3BpYy50b3BpY0lkID0gJHt0b3BpY0lkfVxuT1JERVIgQlkgc3VidG9waWMuc3VidG9waWNObyBBU0MsIGV4ZXJjaXNlcy5pZCBBU0M7YCwgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfVxuICAgICkudGhlbihyZXNwID0+IHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcCB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEdpdmVuIHRvcGljSWQsIGNvbXB1dGVzIGhhc2ggdmFsdWUgb2YgdGhlIGFzc29jaWF0ZWQgVG9waWNFeGVyY2lzZS5cbiAgLy8gVGhlIGhhc2ggaXMgY29tcHV0ZWQgZnJvbSBlYWNoIG9mIHRoZSBidWlsZGluZyBzdWJ0b3BpYyBFeGVyY2lzZXMuXG4gIC8vIEluIG90aGVyIHdvcmRzLCBpZiBhbnkgc3VidG9waWMgRXhlcmNpc2UgY2hhbmdlcywgaGFzaCBmb3IgcmVzcGVjdGl2ZVxuICAvLyBUb3BpY0V4ZXJjaXNlIHRoYXQgZGVwZW5kcyBvbiBpdCBhbHNvIGNoYW5nZXMuXG4gIHByaXZhdGUgZ2V0RXhlcmNpc2VzSGFzaCAodG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxzdHJpbmc+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VzKHRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGNvbWJpbmVkSGFzaCA9IHJlc3AuZGF0YS5yZWR1Y2UoKGFjYywgaGFzaCkgPT4ge1xuICAgICAgICAgIHJldHVybiBhY2MgKyBFeGVyY2lzZUdlbmVyYXRvci5nZXRIYXNoKGhhc2gpXG4gICAgICAgIH0sICcnKVxuICAgICAgICBsZXQgdG9waWNFeGVyY2lzZUhhc2ggPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRIYXNoKGNvbWJpbmVkSGFzaClcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB0b3BpY0V4ZXJjaXNlSGFzaCB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlRXhlcmNpc2UgKHRvcGljSWQsIHVzZXJJZCwgZXhlcmNpc2VzOiBFeGVyY2lzZVtdKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VzSGFzaCh0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCB0b3BpY0V4ZXJjaXNlSGFzaCA9IHJlc3AuZGF0YVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5tYXAoZXhlcmNpc2VzLCBleGVyY2lzZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIEV4ZXJjaXNlU2VydmljZS5nZW5lcmF0ZUV4ZXJjaXNlKGV4ZXJjaXNlLCB0cnVlKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICAgIC8vIENoZWNrIHRoaXMgaGFzIHF1ZXN0aW9uc1xuICAgICAgICAgICAgICBjb25zdCBwYXJzZWRLbm93bnMgPSBKU09OLnBhcnNlKHJlc3AuZGF0YS5leGVyY2lzZURhdGEua25vd25zKVxuICAgICAgICAgICAgICBpZiAocGFyc2VkS25vd25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgZXhlcmNpc2VEYXRhOiByZXNwLmRhdGEuZXhlcmNpc2VEYXRhXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFNraXAgb3ZlciBlbXB0eSBxdWVzdGlvbnNcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgY29uc3QgZXhlcmNpc2VEZXRhaWw6IGFueVtdID0gW11cbiAgICAgICAgICBsZXQgaWRlYWxUaW1lID0gMFxuXG4gICAgICAgICAgLy8gTmVlZGVkIGZvciBUUyB0byB0eXBlY2hlY2tcbiAgICAgICAgICBmdW5jdGlvbiBub3RFbXB0eTxUVmFsdWU+ICh2YWx1ZTogVFZhbHVlIHwgbnVsbCB8IHVuZGVmaW5lZCk6IHZhbHVlIGlzIFRWYWx1ZSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJlc3VsdHMuZmlsdGVyKG5vdEVtcHR5KS5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZGVhbFRpbWUgKz0gcmVzdWx0LmV4ZXJjaXNlRGF0YS5pZGVhbFRpbWVcbiAgICAgICAgICAgIGV4ZXJjaXNlRGV0YWlsLnB1c2gocmVzdWx0LmV4ZXJjaXNlRGF0YSlcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgLy8gSW4gY2FzZSB0aGF0IHRoZSBleGVyY2lzZSBpcyBubyBsb25nZXIgdXAtdG8tZGF0ZSwgd2UgaGF2ZSB0byBkZWxldGUgc3RhbGUgZ2VuZXJhdGVkIGV4ZXJjaXNlXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlJykuZGVzdHJveSh7d2hlcmU6IHtcbiAgICAgICAgICAgIHRvcGljSWQsXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBzdWJtaXR0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICAgIH19KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPih7XG4gICAgICAgICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZFRvcGljRXhlcmNpc2UnLFxuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgdG9waWNJZCxcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgZXhlcmNpc2VEZXRhaWw6IEpTT04uc3RyaW5naWZ5KGV4ZXJjaXNlRGV0YWlsKSxcbiAgICAgICAgICAgICAgICB0b3BpY0V4ZXJjaXNlSGFzaCxcbiAgICAgICAgICAgICAgICBpZGVhbFRpbWUsXG4gICAgICAgICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIHJldHJpZXZlIGV4ZXJjaXNlIGhhc2ghJyB9XG4gICAgICB9XG4gICAgfSlcblxuICB9XG5cbiAgLy8gRm9ybWF0IEdlbmVyYXRlZFRvcGljRXhlcmNpc2UgZm9yIGNvbnRyb2xsZXIgdXNlcy5cbiAgcHJpdmF0ZSBmb3JtYXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIChnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlOiBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEZvcm1hdHRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgY29uc3QgdG9waWNJZCA9IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UudG9waWNJZFxuICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlczogR2VuZXJhdGVkRXhlcmNpc2VbXSA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5leGVyY2lzZURldGFpbClcbiAgICByZXR1cm4gUHJvbWlzZS5tYXAoZ2VuZXJhdGVkRXhlcmNpc2VzLCBnZW5lcmF0ZWRFeGVyY2lzZSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5yZWFkT25lPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5leGVyY2lzZUlkIH0gfSkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgIGxldCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKHJlc3AyLmRhdGEuZGF0YSlcbiAgICAgICAgICBsZXQgdW5rbm93bnM6IEFycmF5PHN0cmluZ1tdPiA9IFtdXG4gICAgICAgICAgbGV0IGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzOiBBcnJheTxQcm9taXNlPHN0cmluZz4+ID0gW11cbiAgICAgICAgICBKU09OLnBhcnNlKGdlbmVyYXRlZEV4ZXJjaXNlLmtub3ducykuZm9yRWFjaChrbm93bnMgPT4ge1xuICAgICAgICAgICAgZm9ybWF0dGVkUXVlc3Rpb25zUHJvbWlzZXMucHVzaChleGVyY2lzZVNvbHZlci5mb3JtYXRRdWVzdGlvbihrbm93bnMpKVxuICAgICAgICAgIH0pXG4gICAgICAgICAgSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS51bmtub3ducykuZm9yRWFjaChfdW5rbm93bnMgPT4ge1xuICAgICAgICAgICAgdW5rbm93bnMucHVzaChPYmplY3Qua2V5cyhfdW5rbm93bnMpKVxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzKS50aGVuKHJlbmRlcmVkUXVlc3Rpb25zID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHJlbmRlcmVkUXVlc3Rpb25zLFxuICAgICAgICAgICAgICB1bmtub3duc1xuICAgICAgICAgICAgfSBhcyBGb3JtYXR0ZWRFeGVyY2lzZVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3AyLmVyck1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSkudGhlbihmb3JtYXR0ZWRFeGVyY2lzZXMgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMucmVhZE9uZTxUb3BpYz4oeyBtb2RlbE5hbWU6ICdUb3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogdG9waWNJZCB9IH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICB0b3BpY05hbWU6IHJlc3AuZGF0YS50b3BpYyxcbiAgICAgICAgICAgICAgZm9ybWF0dGVkRXhlcmNpc2VzLFxuICAgICAgICAgICAgICBpZGVhbFRpbWU6IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UuaWRlYWxUaW1lLFxuICAgICAgICAgICAgICBlbGFwc2VkVGltZTogVXRpbHMuZ2V0RWxhcHNlZFRpbWUoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5jcmVhdGVkQXQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICcnIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLy8gR3JhZGUgYSBUb3BpY0V4ZXJjaXNlXG4gIGdyYWRlRXhlcmNpc2UgKGdlbmVyYXRlZEV4ZXJjaXNlRGV0YWlsczogR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbFtdLCBhbnN3ZXJzOiBUb3BpY0V4ZXJjaXNlQW5zd2VyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFRvcGljRXhlcmNpc2VHcmFkZT4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5tYXAoZ2VuZXJhdGVkRXhlcmNpc2VEZXRhaWxzLCBleGVyY2lzZURldGFpbCA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5yZWFkT25lPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBleGVyY2lzZURldGFpbC5leGVyY2lzZUlkIH0gfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGV4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICAgICAgY29uc3QgZXhlcmNpc2VTb2x2ZXIgPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRFeGVyY2lzZVNvbHZlcihleGVyY2lzZS5kYXRhKVxuICAgICAgICAgIGNvbnN0IGtub3ducyA9IEpTT04ucGFyc2UoZXhlcmNpc2VEZXRhaWwua25vd25zKVxuICAgICAgICAgIGNvbnN0IHVua25vd25zID0gSlNPTi5wYXJzZShleGVyY2lzZURldGFpbC51bmtub3ducylcbiAgICAgICAgICByZXR1cm4ga25vd25zLm1hcCgoa25vd24sIGluZGV4KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4geyBrbm93biwgY29ycmVjdEFuc3dlcjogdW5rbm93bnNbaW5kZXhdLCBpc0Fuc3dlckZuOiBleGVyY2lzZVNvbHZlci5pc0Fuc3dlci5iaW5kKGV4ZXJjaXNlU29sdmVyKSB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4ZXJjaXNlIHdpdGggaWQ9JyArIGV4ZXJjaXNlRGV0YWlsLmV4ZXJjaXNlSWQgKyAnIGNvdWxkIG5vdCBiZSBmb3VuZCEnKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pLnRoZW4odG9waWNFeGVyY2lzZUFycmF5ID0+IHtcbiAgICAgIC8vIE5vdywgd2UgaGF2ZSAzIGxldmVsIGFycmF5czpcbiAgICAgIC8vIDEgLT4gVG9waWMgRXhlcmNpc2UuIDIgLT4gRXhlcmNpc2UuIDMgLT4gUXVlc3Rpb25cbiAgICAgIC8vIEJ1dCBzaW5jZSB1c2VyQW5zd2VyIGlzIGEgMS1sZXZlbCBhcnJheSBvZiBxdWVzdGlvbiwgd2UgbmVlZCB0byBmbGF0dGVuIHdoYXQgd2UgaGF2ZSB0byBiZSBlYXNpbHkgdXNlZFxuICAgICAgcmV0dXJuIHRvcGljRXhlcmNpc2VBcnJheS5yZWR1Y2UoKGFjYywgZXhlcmNpc2VBcnJheSkgPT4ge1xuICAgICAgICByZXR1cm4gYWNjLmNvbmNhdChleGVyY2lzZUFycmF5KVxuICAgICAgfSwgW10pLnJlZHVjZSgoYWNjLCBxdWVzdGlvbkFycmF5KSA9PiB7XG4gICAgICAgIHJldHVybiBhY2MuY29uY2F0KHF1ZXN0aW9uQXJyYXkpXG4gICAgICB9LCBbXSlcbiAgICB9KS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgY29uc29sZS5kaXIocmVzdWx0cylcbiAgICAgIGNvbnN0IHsgbnVtQ29ycmVjdEFuc3dlcnMsIGNvcnJlY3RBbnN3ZXJzLCBpc0NvcnJlY3QgfSA9IHJlc3VsdHMucmVkdWNlKChhY2MsIHJlc3VsdCwgaW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgaXNDb3JyZWN0ID0gcmVzdWx0LmlzQW5zd2VyRm4ocmVzdWx0Lmtub3duLCBhbnN3ZXJzW2luZGV4XSlcbiAgICAgICAgYWNjLm51bUNvcnJlY3RBbnN3ZXJzICs9IGlzQ29ycmVjdCA/IDEgOiAwXG4gICAgICAgIGFjYy5jb3JyZWN0QW5zd2Vycy5wdXNoKHJlc3VsdC5jb3JyZWN0QW5zd2VyKVxuICAgICAgICBhY2MuaXNDb3JyZWN0LnB1c2goaXNDb3JyZWN0KVxuICAgICAgICByZXR1cm4gYWNjXG4gICAgICB9LCB7IG51bUNvcnJlY3RBbnN3ZXJzOiAwLCBjb3JyZWN0QW5zd2VyczogW10sIGlzQ29ycmVjdDogW10gfSlcbiAgICAgIGNvbnN0IG51bVF1ZXN0aW9ucyA9IHJlc3VsdHMubGVuZ3RoXG4gICAgICBjb25zdCBncmFkZTogVG9waWNFeGVyY2lzZUdyYWRlID0ge1xuICAgICAgICBudW1RdWVzdGlvbnMsXG4gICAgICAgIG51bUNvcnJlY3RBbnN3ZXJzLFxuICAgICAgICBjb3JyZWN0QW5zd2VycyxcbiAgICAgICAgaXNDb3JyZWN0LFxuICAgICAgICBzY29yZTogcGFyc2VGbG9hdChudW1Db3JyZWN0QW5zd2VycykgLyBudW1RdWVzdGlvbnMgKiAxMDBcbiAgICAgIH1cbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogZ3JhZGUgfVxuICAgIH0pXG4gIH1cblxuICAvLyBVcGRhdGUgR2VuZXJhdGVkVG9waWNFeGVyY2lzZSBhcyBzdWJtaXR0ZWRcbiAgZmluaXNoRXhlcmNpc2UgKGdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZDogbnVtYmVyLCBzY29yZTogbnVtYmVyLCB0aW1lRmluaXNoOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICBleGVyY2lzZURldGFpbHM6IEdlbmVyYXRlZFRvcGljRXhlcmNpc2VEZXRhaWxbXSwgYW5zd2VyczogVG9waWNFeGVyY2lzZUFuc3dlcltdKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPG51bWJlcj4+IHtcbiAgICAvLyBUaGlzIGlzIGEgYml0IGFubm95aW5nLi5cbiAgICAvLyBTbyBhbnN3ZXIgaXMgd2hhdCBhIHN0dWRlbnQgd291bGQgc3VibWl0LiBJdCdzIGEgb25lIGRpbWVuc2lvbmFsIGFycmF5IG9mIGFuc3dlcnMgZm9yIGVhY2ggb2YgdGhlIGV4ZXJjaXNlc1xuICAgIC8vIFdlIHdhbnQgdG8gc2F2ZSB1c2VyIGFuc3dlciBpbnRvIGV4ZXJjaXNlRGV0YWlsIHNvIHRoYXQgd2UgY2FuIGRlYnVnIHByb2JsZW1zLiAoaS5lLiB3cm9uZyBzY29yaW5nKVxuICAgIC8vIEluIG9yZGVyIHRvIG1ha2Ugc3VyZSBlYWNoIGFuc3dlciBnb2VzIHRvIGNvcnJlY3QgZXhlcmNpc2UgZGV0YWlsLCB3ZSBoYXZlIHdpbmQgdGhlbSB1cFxuICAgIC8vIGluIHRoZSBzYW1lIG9yZGVyIHdoZW4gd2UgdW53aW5kLiBJZiB5b3UncmUgY29uZnVzZWQgYWJvdXQgdGhpcyBjb2RlOlxuICAgIC8vIDEuIFRyeSB0byBsb29rIGF0IE15U1FMIHRhYmxlIHN0cnVjdHVyZSBmb3IgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXNcbiAgICAvLyAyLiBSZW1lbWJlciB0aGF0IGV4ZXJjaXNlRGV0YWlsIHRoZXJlIGlzIHN0cmluZ2lmaWVkIHZlcnNpb24gb2YgZWFjaCBvZiBnZW5lcmF0ZWRFeGVyY2lzZXMgdGhhdCBtYWtlcyB1cFxuICAgIC8vICAgIGEgdG9waWMgZXhlcmNpc2UuXG4gICAgbGV0IGFuc3dlckluZGV4ID0gMFxuICAgIGNvbnN0IGV4ZXJjaXNlRGV0YWlsID0gSlNPTi5zdHJpbmdpZnkoZXhlcmNpc2VEZXRhaWxzLm1hcChleGVyY2lzZURldGFpbCA9PiB7XG4gICAgICBjb25zb2xlLmRpcihleGVyY2lzZURldGFpbClcbiAgICAgIGNvbnN0IGV4ZXJjaXNlRGV0YWlsQW5zd2VyczogQXJyYXk8YW55PiA9IFtdXG4gICAgICBKU09OLnBhcnNlKGV4ZXJjaXNlRGV0YWlsLmtub3ducykuZm9yRWFjaChfID0+IHtcbiAgICAgICAgZXhlcmNpc2VEZXRhaWxBbnN3ZXJzLnB1c2goYW5zd2Vyc1thbnN3ZXJJbmRleF0pXG4gICAgICAgIGFuc3dlckluZGV4KytcbiAgICAgIH0pXG4gICAgICBleGVyY2lzZURldGFpbC51c2VyQW5zd2VyID0gSlNPTi5zdHJpbmdpZnkoZXhlcmNpc2VEZXRhaWxBbnN3ZXJzKVxuICAgICAgcmV0dXJuIGV4ZXJjaXNlRGV0YWlsXG4gICAgfSkpXG4gICAgcmV0dXJuIHRoaXMudXBkYXRlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+KHtcbiAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZFRvcGljRXhlcmNpc2UnLFxuICAgICAgZGF0YToge1xuICAgICAgICBpZDogZ2VuZXJhdGVkVG9waWNFeGVyY2lzZUlkLFxuICAgICAgICBzdWJtaXR0ZWQ6IHRydWUsXG4gICAgICAgIHN1Ym1pdHRlZEF0OiBtb21lbnQoKS5sb2NhbCgpLmZvcm1hdCgnWVlZWS1NTS1ERCBISDptbTpzcycpLFxuICAgICAgICBvbkNsb3VkOiBBcHBDb25maWcuQ0xPVURfU0VSVkVSLFxuICAgICAgICBzY29yZSxcbiAgICAgICAgdGltZUZpbmlzaCxcbiAgICAgICAgZXhlcmNpc2VEZXRhaWxcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gV2hlbiB1c2VyIHdhbnRzIHRvIGRvIFRvcGljRXhlcmNpc2UsIGEgR2VuZXJhdGVkVG9waWNFeGVyY2lzZSBtZXRhIGluZm9ybWF0aW9uIGlzIGNyZWF0ZWRcbiAgLy8gdG8gc3RvcmUgbG9jYWwgaW5mb3JtYXRpb24gYWJvdXQgdGhhdCBwYXJ0aWN1bGFyIGV4ZXJjaXNlIChpLmUuIHJhbmRvbSBxdWVzdGlvbnMpXG4gIC8vIEZvciBlYWNoIHVzZXIsIHRoZXJlJ3MgZXhhY3RseSBvbmUgR2VuZXJhdGVkVG9waWNFeGVyY2lzZSB3aXRoIHN1Ym1pdHRlZCA9IGZhbHNlIGZvciBlYWNoXG4gIC8vIFRvcGljRXhlcmNpc2VzXG4gIGdldEdlbmVyYXRlZFRvcGljRXhlcmNpc2UgKHVzZXJJZCwgdG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPj4ge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmU8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkVG9waWNFeGVyY2lzZScsXG4gICAgICBzZWFyY2hDbGF1c2U6IHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB0b3BpY0lkLFxuICAgICAgICBzdWJtaXR0ZWQ6IGZhbHNlLFxuICAgICAgICBvbkNsb3VkOiBBcHBDb25maWcuQ0xPVURfU0VSVkVSXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFN0YXJCYWRnZXMgKHVzZXJJZCwgdG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBcblNFTEVDVCBzY29yZSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSAxIEFORCB0b3BpY0lkID0gJHt0b3BpY0lkfSBBTkQgdXNlcklkID0gJHt1c2VySWR9XG5PUkRFUiBCWSBzY29yZSBERVNDIExJTUlUIDQ7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKGRhdGFzID0+IHtcbiAgICAgIGNvbnN0IHN0YXJzID0gZGF0YXMucmVkdWNlKChhY2MsIGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHBhcnNlSW50KGRhdGEuc2NvcmUsIDEwKSA+PSA4MCkge1xuICAgICAgICAgIHJldHVybiBhY2MgKyAxXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgICB9XG4gICAgICB9LCAwKVxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHN0YXJzIH0gfVxuICAgIH0pXG4gIH1cblxuICBnZXRSZW5kZXJlZFN0YXJCYWRnZXMgKHVzZXJJZCwgdG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFN0YXJCYWRnZXModXNlcklkLCB0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IHN0YXJzID0gcmVzcC5kYXRhLnN0YXJzXG4gICAgICAgIGNvbnN0IGh0bWwgPSBwdWcucmVuZGVyRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwL3ZpZXdzL25vbi1wYWdlcy9zdGFycy5wdWcnKSwgeyBzdGFycyB9KVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgaHRtbCwgc3RhcnMgfSB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcmVzcFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGdldENoZWNrbWFya0JhZGdlICh1c2VySWQsIHRvcGljSWQsIHJlbmRlciA9IGZhbHNlKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFxuU0VMRUNUIHNjb3JlIEZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXNcbldIRVJFIHN1Ym1pdHRlZCA9IDEgQU5EIHRvcGljSWQgPSAke3RvcGljSWR9IEFORCB1c2VySWQgPSAke3VzZXJJZH0gQU5EIHNjb3JlID4gODBcbk9SREVSIEJZIHNjb3JlIERFU0MgTElNSVQgMTtgLFxuICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4oZGF0YXMgPT4ge1xuICAgICAgY29uc3QgaXNDaGVja2VkID0gZGF0YXMubGVuZ3RoID4gMFxuICAgICAgaWYgKHJlbmRlcikge1xuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvY2Vja21hcmsucHVnJyksIHsgaXNDaGVja2VkIH0pXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogaHRtbCB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgaXNDaGVja2VkIH0gfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZXRUaW1lckJhZGdlcyAodXNlcklkLCB0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFxuU0VMRUNUIHNjb3JlIEZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXNcbldIRVJFIHN1Ym1pdHRlZCA9IDEgQU5EIHRvcGljSWQgPSAke3RvcGljSWR9IEFORCB1c2VySWQgPSAke3VzZXJJZH1cbkFORCB0aW1lRmluaXNoIDwgaWRlYWxUaW1lIEFORCBzY29yZSA9IDEwMFxuT1JERVIgQlkgc2NvcmUgREVTQyBMSU1JVCAxO2AsXG4gICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihkYXRhcyA9PiB7XG4gICAgICBjb25zdCB0aW1lcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgZGF0YSkgPT4ge1xuICAgICAgICBpZiAocGFyc2VJbnQoZGF0YS5zY29yZSwgMTApID49IDgwKSB7XG4gICAgICAgICAgcmV0dXJuIGFjYyArIDFcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gYWNjXG4gICAgICAgIH1cbiAgICAgIH0sIDApXG5cbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB0aW1lcnMgfSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFJlbmRlcmVkVGltZXJCYWRnZXMgKHVzZXJJZCwgdG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFRpbWVyQmFkZ2VzKHVzZXJJZCwgdG9waWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICBjb25zdCB0aW1lcnMgPSByZXNwLmRhdGEudGltZXJzXG4gICAgICAgIGNvbnN0IGh0bWwgPSBwdWcucmVuZGVyRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwL3ZpZXdzL25vbi1wYWdlcy90aW1lcnMucHVnJyksIHsgdGltZXJzIH0pXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogaHRtbCB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gKHJlc3ApXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gICAgLy8gR2V0IGxlYWRlcmJvYXJkIGRhdGFcbiAgZ2V0UmFua2luZyAodG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuYFNFTEVDVCBNSU4odGltZUZpbmlzaCkgQVMgdGltZUZpbmlzaCwgdXNlcklkLCB1c2Vycy5mdWxsTmFtZSBBUyBmdWxsTmFtZSwgdXNlcnMuZ3JhZGUgQVMgZ3JhZGUsIHNjaG9vbHMubmFtZSBBUyBzY2hvb2xOYW1lXG5GUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzIElOTkVSIEpPSU4gdXNlcnMgT04gdXNlcnMuaWQgPSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlcy51c2VySWQgSU5ORVIgSk9JTiBzY2hvb2xzIE9OIHNjaG9vbHMuaWQgPSB1c2Vycy5zY2hvb2xJZFxuV0hFUkUgc3VibWl0dGVkID0gVFJVRSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMIEdST1VQIEJZIHVzZXJJZCBPUkRFUiBCWSBNSU4odGltZUZpbmlzaCkgTElNSVQgMTA7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UmVuZGVyZWRMZWFkZXJib2FyZCAodG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFJhbmtpbmcodG9waWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICBjb25zdCBleGVyY2lzZURhdGEgPSByZXNwLmRhdGFcbiAgICAgICAgY29uc3QgaHRtbCA9IHB1Zy5yZW5kZXJGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAvdmlld3Mvbm9uLXBhZ2VzL3JhbmtpbmcucHVnJyksIHsgZXhlcmNpc2VEYXRhIH0pXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogaHRtbCB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcmVzcFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgdGhlIG51bWJlciBvZiByYW5rIGluIGxlYWRlcmJvYXJkXG4gIGdldEN1cnJlbnRSYW5raW5nICh0aW1lRmluaXNoLCB0b3BpY0lkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHF1ZXJ5REIgPSBgU0VMRUNUIENPVU5UKCopIEFTIHRvdGFsXG5GUk9NIChTRUxFQ1QgQ09VTlQoKikgRlJPTSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlc1xuV0hFUkUgc3VibWl0dGVkID0gVFJVRSBBTkQgdGltZUZpbmlzaCA8ICR7dGltZUZpbmlzaH0gQU5EIHRvcGljSWQgPSAke3RvcGljSWR9IEFORCBzY29yZSA9IDEwMCBBTkQgdGltZUZpbmlzaCBJUyBOT1QgTlVMTFxuR1JPVVAgQlkgdXNlcklkXG5PUkRFUiBCWSBNSU4odGltZUZpbmlzaCkpIEFTIHRvdGFscm93O2BcbiAgICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KHF1ZXJ5REIsXG4gICAgICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBjb3VudDogcmVzcFswXS50b3RhbCB9IH0pXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLy8gR2V0IHRoZSBudW1iZXIgb2Ygc3VibWlzc2lvbnMgaW4gdGhlIGxlYWRlcmJvYXJkXG4gIGdldFRvdGFsUmFua2luZyAodG9waWNJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgcXVlcnlEQiA9IGBTRUxFQ1QgQ09VTlQoKikgQVMgdG90YWxcbkZST00gKFNFTEVDVCBDT1VOVCgqKSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzIFdIRVJFIHN1Ym1pdHRlZCA9IFRSVUUgQU5EIHRvcGljSWQgPSAke3RvcGljSWR9IEFORCBzY29yZSA9IDEwMCBBTkQgdGltZUZpbmlzaCBJUyBOT1QgTlVMTFxuR1JPVVAgQlkgdXNlcklkXG5PUkRFUiBCWSBNSU4odGltZUZpbmlzaCkpIEFTIHRvdGFscm93O2BcbiAgICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KHF1ZXJ5REIsXG4gICAgICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBjb3VudDogcmVzcFswXS50b3RhbCB9IH0pXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgfSlcbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBUb3BpY0V4ZXJjaXNlU2VydmljZSgpXG4iXX0=
