"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),crud_service_neo_1=require("./crud-service-neo"),exercise_generator_1=require("../lib/exercise_generator/exercise-generator"),exercise_service_1=require("./exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),moment=require("moment"),Sequelize=require("sequelize");const AppConfig=require(path.join(__dirname,"../app-config")),Utils=require(path.join(__dirname,"../lib/utils")),TAG="TopicExerciseService";class TopicExerciseService extends crud_service_neo_1.default{getTopic(e){return this.readOne({modelName:"Topic",searchClause:{id:e}})}getFormattedExercise(e,t){return e&&t?Promise.join(this.getExercises(e),this.getGeneratedTopicExercise(t,e),this.getExercisesHash(e),this.getTopic(e)).spread((r,s,i,a)=>{if(i.status&&a.status){const a=i.data;if(s.status&&s.data&&s.data.topicExerciseHash===a)return this.formatGeneratedTopicExercise(s.data);if(r.status&&r.data&&(s.status&&s.data&&s.data.topicExerciseHash!==a||!s.status))return this.generateTopicExercise(e,t,r.data).then(e=>e.status&&e.data?this.formatGeneratedTopicExercise(e.data):{status:!1,errMessage:e.errMessage});throw new Error("Unexpected error!")}throw new Error(`Failed to retrieve topic or topicExerciseHash: ${i.errMessage||a.errMessage}`)}):Promise.resolve({status:!1,errMessage:"topicId and userId are required!"})}getExercises(e){return log.verbose(TAG,`course.service.getExerciseRelatedWithTopicId.GET (topicId): ${e}`),this.getSequelize().query(`\n  SELECT exercises.id, exercises.data, exercises.createdAt, exercises.updatedAt, exercises.subtopicId\n  FROM exercises AS exercises\n  INNER JOIN subtopics AS subtopic ON exercises.subtopicId = subtopic.id AND subtopic.topicId = ${e}\n  ORDER BY subtopic.subtopicNo ASC, exercises.id ASC;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getExercisesHash(e){return this.getExercises(e).then(e=>{if(e.status&&e.data){const t=e.data.reduce((e,t)=>e+exercise_generator_1.default.getHash(t),"");return{status:!0,data:exercise_generator_1.default.getHash(t)}}return{status:!1,errMessage:e.errMessage}})}generateTopicExercise(e,t,r){return this.getExercisesHash(e).then(s=>{if(s.status&&s.data){const i=s.data;return Promise.map(r,e=>exercise_service_1.default.generateExercise(e,!0).then(e=>{if(e.status){return JSON.parse(e.data.exerciseData.knowns).length>0?{exerciseData:e.data.exerciseData}:null}return null})).then(r=>{const s=[];let a=0;return r.filter(function(e){return null!=e}).forEach(e=>{a+=e.exerciseData.idealTime,s.push(e.exerciseData)}),this.getModels("GeneratedTopicExercise").destroy({where:{topicId:e,userId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}}).then(()=>this.create({modelName:"GeneratedTopicExercise",data:{topicId:e,userId:t,exerciseDetail:JSON.stringify(s),topicExerciseHash:i,idealTime:a,onCloud:AppConfig.CLOUD_SERVER}}))})}return{status:!1,errMessage:"Failed to retrieve exercise hash!"}})}generateExercises(e){return Promise.map(e,e=>exercise_service_1.default.generateExercise(e,!0).then(e=>{if(e.status){return JSON.parse(e.data.exerciseData.knowns).length>0?{exerciseData:e.data.exerciseData,formatted:e.data.formatted}:null}return null})).then(e=>{const t=[],r=[];let s=0;return e.filter(function(e){return null!=e}).forEach(e=>{s+=e.exerciseData.idealTime,t.push(e.exerciseData),r.push(e.formatted)}),{status:!0,data:{exerciseData:t,formatted:r,idealTime:s}}})}formatGeneratedTopicExercise(e){const t=e.topicId,r=JSON.parse(e.exerciseDetail);return Promise.map(r,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){let r=exercise_generator_1.default.getExerciseSolver(t.data.data),s=[],i=[];return JSON.parse(e.knowns).forEach(e=>{i.push(r.formatQuestion(e))}),JSON.parse(e.unknowns).forEach(e=>{s.push(Object.keys(e))}),Promise.all(i).then(e=>({renderedQuestions:e,unknowns:s}))}throw new Error(t.errMessage)})).then(r=>this.readOne({modelName:"Topic",searchClause:{id:t}}).then(t=>t.status&&t.data?{status:!0,data:{topicName:t.data.topic,formattedExercises:r,idealTime:e.idealTime,elapsedTime:Utils.getElapsedTime(e.createdAt)}}:{status:!1,errMessage:""}))}formatExercises(e){return Promise.map(e,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){let r=exercise_generator_1.default.getExerciseSolver(t.data.data),s=[],i=[];return JSON.parse(e.knowns).forEach(e=>{i.push(r.formatQuestion(e))}),JSON.parse(e.unknowns).forEach(e=>{s.push(Object.keys(e))}),Promise.all(i).then(e=>({renderedQuestions:e,unknowns:s}))}throw new Error(t.errMessage)})).then(e=>({status:!0,data:e}))}checkAnswer(e,t){return Promise.map(e,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){const r=t.data,s=exercise_generator_1.default.getExerciseSolver(r.data),i=JSON.parse(e.knowns),a=JSON.parse(e.unknowns);return i.map((e,t)=>({known:e,unknown:a[t],isAnswerFn:s.isAnswer.bind(s)}))}throw new Error("Exercise with id="+e.exerciseId+" could not be found!")})).then(e=>{return{status:!0,data:e.reduce((e,t)=>e.concat(t),[]).map((e,r)=>({isCorrect:e.isAnswerFn(e.known,t[r]),unknown:e.unknown}))}})}gradeExercise(e,t){return Promise.map(e,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){const r=t.data,s=exercise_generator_1.default.getExerciseSolver(r.data),i=JSON.parse(e.knowns),a=JSON.parse(e.unknowns);return i.map((e,t)=>({known:e,correctAnswer:a[t],isAnswerFn:s.isAnswer.bind(s)}))}throw new Error("Exercise with id="+e.exerciseId+" could not be found!")})).then(e=>e.reduce((e,t)=>e.concat(t),[]).reduce((e,t)=>e.concat(t),[])).then(e=>{console.dir(e);const{numCorrectAnswers:r,correctAnswers:s,isCorrect:i}=e.reduce((e,r,s)=>{const i=r.isAnswerFn(r.known,t[s]);return e.numCorrectAnswers+=i?1:0,e.correctAnswers.push(r.correctAnswer),e.isCorrect.push(i),e},{numCorrectAnswers:0,correctAnswers:[],isCorrect:[]}),a=e.length;return{status:!0,data:{numQuestions:a,numCorrectAnswers:r,correctAnswers:s,isCorrect:i,score:parseFloat(r)/a*100}}})}finishExercise(e,t,r,s,i){let a=0;const n=JSON.stringify(s.map(e=>{console.dir(e);const t=[];return JSON.parse(e.knowns).forEach(e=>{t.push(i[a]),a++}),e.userAnswer=JSON.stringify(t),e}));return this.update({modelName:"GeneratedTopicExercise",data:{id:e,submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),onCloud:AppConfig.CLOUD_SERVER,score:t,timeFinish:r,exerciseDetail:n}})}getGeneratedTopicExercise(e,t){return this.readOne({modelName:"GeneratedTopicExercise",searchClause:{userId:e,topicId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}})}saveGeneratedTopicExercise(e,t,r,s,i){return this.getModels("GeneratedTopicExercise").destroy({where:{topicId:e,userId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}}).then(()=>this.create({modelName:"GeneratedTopicExercise",data:{topicId:e,userId:t,exerciseDetail:JSON.stringify(r),topicExerciseHash:s,idealTime:i,onCloud:AppConfig.CLOUD_SERVER}}))}updateGeneratedTopicAnswer(e,t,r,s){return this.update({modelName:"GeneratedTopicExercise",data:{id:e,submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),onCloud:AppConfig.CLOUD_SERVER,score:t,timeFinish:r,exerciseDetail:s}})}getExerciseStars(e,t){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e}\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{stars:e.reduce((e,t)=>parseInt(t.score,10)>=80?e+1:e,0)}}})}getRenderedExerciseStars(e,t,r=!0){return this.getExerciseStars(e,t).then(e=>{if(e.status){const t=e.data.stars;return{status:!0,data:{html:pug.renderFile(path.join(__dirname,"../app/views/non-pages/stars.pug"),{stars:t}),stars:t}}}return e})}getTopicExerciseCheckmark(e,t,r=!1){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e} AND score > 80\nORDER BY score DESC LIMIT 1;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{const t=e.length>0;if(r){return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ceckmark.pug"),{isChecked:t})}}return{status:!0,data:{isChecked:t}}})}getExerciseTimers(e,t){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e}\nAND timeFinish < idealTime AND score = 100\nORDER BY score DESC LIMIT 1;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{timers:e.reduce((e,t)=>parseInt(t.score,10)>=80?e+1:e,0)}}})}getRenderedExerciseTimers(e,t,r){return this.getExerciseTimers(e,t).then(e=>{if(e.status){const t=e.data.timers;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/timers.pug"),{timers:t})}}return e})}getExerciseRanking(e){return this.getSequelize().query(`SELECT MIN(timeFinish) AS timeFinish, userId, users.fullName AS fullName, users.grade AS grade, schools.name AS schoolName\nFROM generatedTopicExercises INNER JOIN users ON users.id = generatedTopicExercises.userId INNER JOIN schools ON schools.id = users.schoolId\nWHERE submitted = TRUE AND topicId = ${e} AND score = 100 AND timeFinish IS NOT NULL GROUP BY userId ORDER BY MIN(timeFinish) LIMIT 10;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getExerciseLeaderboard(e){return this.getExerciseRanking(e).then(e=>{if(e.status){const t=e.data;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ranking.pug"),{exerciseData:t})}}return e})}getCurrentRanking(e,t){return new Promise((r,s)=>{const i=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedTopicExercises\nWHERE submitted = TRUE AND timeFinish < ${e} AND topicId = ${t} AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(i,{type:Sequelize.QueryTypes.SELECT}).then(e=>{r({status:!0,data:{count:e[0].total}})}).catch(e=>{s(e)})})}getTotalRanking(e){return new Promise((t,r)=>{let s=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedTopicExercises WHERE submitted = TRUE AND topicId = ${e} AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(s,{type:Sequelize.QueryTypes.SELECT}).then(e=>{t({status:!0,data:{count:e[0].total}})}).catch(e=>{r(e)})})}}exports.default=new TopicExerciseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy90b3BpYy1leGVyY2lzZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwiY3J1ZF9zZXJ2aWNlX25lb18xIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwibW9tZW50IiwiU2VxdWVsaXplIiwiQXBwQ29uZmlnIiwiam9pbiIsIl9fZGlybmFtZSIsIlV0aWxzIiwiVEFHIiwiVG9waWNFeGVyY2lzZVNlcnZpY2UiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwidG9waWNJZCIsInRoaXMiLCJyZWFkT25lIiwibW9kZWxOYW1lIiwic2VhcmNoQ2xhdXNlIiwiaWQiLCJ1c2VySWQiLCJnZXRFeGVyY2lzZXMiLCJnZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIiwiZ2V0RXhlcmNpc2VzSGFzaCIsImdldFRvcGljIiwic3ByZWFkIiwicmVzcCIsInJlc3AyIiwicmVzcDMiLCJyZXNwNCIsInN0YXR1cyIsInRvcGljRXhlcmNpc2VIYXNoIiwiZGF0YSIsImZvcm1hdEdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZVRvcGljRXhlcmNpc2UiLCJ0aGVuIiwicmVzcDUiLCJlcnJNZXNzYWdlIiwiRXJyb3IiLCJyZXNvbHZlIiwidmVyYm9zZSIsImdldFNlcXVlbGl6ZSIsInF1ZXJ5IiwidHlwZSIsIlF1ZXJ5VHlwZXMiLCJTRUxFQ1QiLCJjb21iaW5lZEhhc2giLCJyZWR1Y2UiLCJhY2MiLCJoYXNoIiwiZ2V0SGFzaCIsImV4ZXJjaXNlcyIsIm1hcCIsImV4ZXJjaXNlIiwiZ2VuZXJhdGVFeGVyY2lzZSIsIkpTT04iLCJwYXJzZSIsImV4ZXJjaXNlRGF0YSIsImtub3ducyIsImxlbmd0aCIsInJlc3VsdHMiLCJleGVyY2lzZURldGFpbCIsImlkZWFsVGltZSIsImZpbHRlciIsInZhbHVlIiwiZm9yRWFjaCIsInJlc3VsdCIsInB1c2giLCJnZXRNb2RlbHMiLCJkZXN0cm95Iiwid2hlcmUiLCJzdWJtaXR0ZWQiLCJvbkNsb3VkIiwiQ0xPVURfU0VSVkVSIiwiY3JlYXRlIiwic3RyaW5naWZ5IiwiZm9ybWF0dGVkIiwiZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSIsImdlbmVyYXRlZEV4ZXJjaXNlcyIsImdlbmVyYXRlZEV4ZXJjaXNlIiwiZXhlcmNpc2VJZCIsImV4ZXJjaXNlU29sdmVyIiwiZ2V0RXhlcmNpc2VTb2x2ZXIiLCJ1bmtub3ducyIsImZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzIiwiZm9ybWF0UXVlc3Rpb24iLCJfdW5rbm93bnMiLCJPYmplY3QiLCJrZXlzIiwiYWxsIiwicmVuZGVyZWRRdWVzdGlvbnMiLCJmb3JtYXR0ZWRFeGVyY2lzZXMiLCJ0b3BpY05hbWUiLCJ0b3BpYyIsImVsYXBzZWRUaW1lIiwiZ2V0RWxhcHNlZFRpbWUiLCJjcmVhdGVkQXQiLCJleGVyY2lzZURldGFpbHMiLCJ1c2VyQW5zd2VycyIsImtub3duIiwiaW5kZXgiLCJ1bmtub3duIiwiaXNBbnN3ZXJGbiIsImlzQW5zd2VyIiwiYmluZCIsInJlc3VsdEFyciIsImNvbmNhdCIsImlzQ29ycmVjdCIsImdlbmVyYXRlZEV4ZXJjaXNlRGV0YWlscyIsImFuc3dlcnMiLCJjb3JyZWN0QW5zd2VyIiwidG9waWNFeGVyY2lzZUFycmF5IiwiZXhlcmNpc2VBcnJheSIsInF1ZXN0aW9uQXJyYXkiLCJjb25zb2xlIiwiZGlyIiwibnVtQ29ycmVjdEFuc3dlcnMiLCJjb3JyZWN0QW5zd2VycyIsIm51bVF1ZXN0aW9ucyIsInNjb3JlIiwicGFyc2VGbG9hdCIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZCIsInRpbWVGaW5pc2giLCJhbnN3ZXJJbmRleCIsImV4ZXJjaXNlRGV0YWlsQW5zd2VycyIsIl8iLCJ1c2VyQW5zd2VyIiwidXBkYXRlIiwic3VibWl0dGVkQXQiLCJsb2NhbCIsImZvcm1hdCIsImdlbmVyYXRlZFRvcGljSWQiLCJkYXRhcyIsInN0YXJzIiwicGFyc2VJbnQiLCJyZW5kZXJTdGFyIiwiZ2V0RXhlcmNpc2VTdGFycyIsImh0bWwiLCJyZW5kZXJGaWxlIiwicmVuZGVyIiwiaXNDaGVja2VkIiwidGltZXJzIiwidGFibGVOYW1lIiwiZ2V0RXhlcmNpc2VUaW1lcnMiLCJnZXRFeGVyY2lzZVJhbmtpbmciLCJyZWplY3QiLCJxdWVyeURCIiwiY291bnQiLCJ0b3RhbCIsImNhdGNoIiwiZXJyIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsbUJBQUFELFFBQUEsc0JBQ0FFLHFCQUFBRixRQUFBLGdEQUNBRyxtQkFBQUgsUUFBQSxzQkFFQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFBQVEsVUFDZE0sSUFBTU4sUUFBUSxPQUNkTyxPQUFTUCxRQUFRLFVBQ2pCUSxVQUFZUixRQUFRLGFBRXhCLE1BQU1TLFVBQVlULFFBQVFJLEtBQUtNLEtBQUtDLFVBQVcsa0JBQ3pDQyxNQUFRWixRQUFRSSxLQUFLTSxLQUFLQyxVQUFXLGlCQUVyQ0UsSUFBTSw2QkFvQlpDLDZCQUFtQ2IsbUJBQUFjLFFBRXpCQyxTQUFVQyxHQUNoQixPQUFPQyxLQUFLQyxTQUFpQkMsVUFBVyxRQUFTQyxjQUFnQkMsR0FBSUwsS0FxQ3ZFRCxxQkFBc0JDLEVBQVNNLEdBQzdCLE9BQUlOLEdBQVdNLEVBQ054QixRQUFRVyxLQUNiUSxLQUFLTSxhQUFhUCxHQUNsQkMsS0FBS08sMEJBQTBCRixFQUFRTixHQUN2Q0MsS0FBS1EsaUJBQWlCVCxHQUN0QkMsS0FBS1MsU0FBU1YsSUFDZFcsT0FBTyxDQUFDQyxFQUE4QkMsRUFDOUJDLEVBQTJCQyxLQUNuQyxHQUFJRCxFQUFNRSxRQUFVRCxFQUFNQyxPQUFRLENBQ2hDLE1BQU1DLEVBQW9CSCxFQUFNSSxLQUVoQyxHQUFJTCxFQUFNRyxRQUFVSCxFQUFNSyxNQUFRTCxFQUFNSyxLQUFLRCxvQkFBc0JBLEVBQ2pFLE9BQU9oQixLQUFLa0IsNkJBQTZCTixFQUFNSyxNQUMxQyxH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S0FBTU4sS0FJakNiLHVCQUF3QkMsR0FDdEIsT0FBT0MsS0FBS2lJLG1CQUFtQmxJLEdBQVNxQixLQUFLVCxJQUMzQyxHQUFJQSxFQUFLSSxPQUFRLENBQ2YsTUFBTTJCLEVBQWUvQixFQUFLTSxLQUUxQixPQUFTRixRQUFRLEVBQU1FLEtBRFY3QixJQUFJdUksV0FBV3pJLEtBQUtNLEtBQUtDLFVBQVcsdUNBQXlDaUQsYUFBQUEsS0FHMUYsT0FBTy9CLElBTWJiLGtCQUFtQjZHLEVBQVk1RyxHQUM3QixPQUFPLElBQUlsQixRQUFRLENBQUMyQyxFQUFTMEcsS0FDM0IsTUFBTUMsMkhBRThCeEIsbUJBQTRCNUcsd0dBR2hFLE9BQU9DLEtBQUswQixlQUFlQyxNQUFNd0csR0FDN0J2RyxLQUFNdEMsVUFBVXVDLFdBQVdDLFNBQVVWLEtBQUtULElBQzFDYSxHQUFVVCxRQUFRLEVBQU1FLE1BQVFtSCxNQUFPekgsRUFBSyxHQUFHMEgsV0FDOUNDLE1BQU1DLElBQ1BMLEVBQU9LLE9BTWZ6SSxnQkFBaUJNLEdBQ2YsT0FBTyxJQUFJdkIsUUFBUSxDQUFDMkMsRUFBUzBHLEtBQzNCLElBQUlDLHVIQUNnRi9ILHdHQUdwRixPQUFPSixLQUFLMEIsZUFBZUMsTUFBTXdHLEdBQzdCdkcsS0FBTXRDLFVBQVV1QyxXQUFXQyxTQUFVVixLQUFLVCxJQUMxQ2EsR0FBVVQsUUFBUSxFQUFNRSxNQUFRbUgsTUFBT3pILEVBQUssR0FBRzBILFdBQzlDQyxNQUFNQyxJQUNQTCxFQUFPSyxRQU1qQkMsUUFBQTNJLFFBQWUsSUFBSUQiLCJmaWxlIjoic2VydmljZXMvdG9waWMtZXhlcmNpc2Utc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgQnJ1dGVmb3JjZVNvbHZlciwgeyBHZW5lcmF0ZWRRdWVzdGlvbkRhdGEgfSBmcm9tICcuLi9saWIvZXhlcmNpc2VfZ2VuZXJhdG9yL2V4ZXJjaXNlX3NvbHZlcnMvYnJ1dGVmb3JjZS1zb2x2ZXInXG5pbXBvcnQgQ1JVRFNlcnZpY2UgZnJvbSAnLi9jcnVkLXNlcnZpY2UtbmVvJ1xuaW1wb3J0IEV4ZXJjaXNlR2VuZXJhdG9yIGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2UtZ2VuZXJhdG9yJ1xuaW1wb3J0IEV4ZXJjaXNlU2VydmljZSBmcm9tICcuL2V4ZXJjaXNlLXNlcnZpY2UnXG5cbmxldCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbmxldCBsb2cgPSByZXF1aXJlKCducG1sb2cnKVxubGV0IHB1ZyA9IHJlcXVpcmUoJ3B1ZycpXG5sZXQgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50JylcbmxldCBTZXF1ZWxpemUgPSByZXF1aXJlKCdzZXF1ZWxpemUnKVxuXG5jb25zdCBBcHBDb25maWcgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAtY29uZmlnJykpXG5jb25zdCBVdGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xpYi91dGlscycpKVxuXG5jb25zdCBUQUcgPSAnVG9waWNFeGVyY2lzZVNlcnZpY2UnXG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbCB7XG4gIGtub3duczogc3RyaW5nLCAvLyBzdHJpbmdpZmllZCBKU09OXG4gIHVua25vd25zOiBzdHJpbmcsIC8vIHN0cmluZ2lmaWVkIEpTT05cbiAgdXNlckFuc3dlcjogc3RyaW5nLCAvLyBzdHJpbmdpZmllZCBKU09OXG4gIGV4ZXJjaXNlSGFzaDogc3RyaW5nXG4gIGV4ZXJjaXNlSWQ6IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRvcGljRXhlcmNpc2VHcmFkZSB7XG4gIG51bVF1ZXN0aW9uczogbnVtYmVyXG4gIG51bUNvcnJlY3RBbnN3ZXJzOiBudW1iZXJcbiAgY29ycmVjdEFuc3dlcnM6IEFycmF5PHtba2V5OiBzdHJpbmddOiBhbnl9PlxuICBpc0NvcnJlY3Q6IEFycmF5PGJvb2xlYW4+XG4gIHNjb3JlOiBudW1iZXJcbn1cblxuZXhwb3J0IHR5cGUgVG9waWNFeGVyY2lzZUFuc3dlciA9IEFycmF5PHtba2V5OiBzdHJpbmddOiBhbnl9PlxuXG5jbGFzcyBUb3BpY0V4ZXJjaXNlU2VydmljZSBleHRlbmRzIENSVURTZXJ2aWNlIHtcbiAgLy8gVE9ETzogV2Ugc2hvdWxkIHVzZSB2ZXJzaW9uIG9uIGNvdXJzZVNlcnZpY2UgaW5zdGVhZCBvZiB0aGlzXG4gIHByaXZhdGUgZ2V0VG9waWMgKHRvcGljSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8VG9waWM+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxUb3BpYz4oeyBtb2RlbE5hbWU6ICdUb3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogdG9waWNJZCB9IH0pXG4gIH1cblxuICAvLyBUT0RPOiBTaG91bGQgY2FsbCBmb3JtYXRFeGVyY2lzZSgpXG4gIC8qXG4gICAgZXhlcmNpc2U6IHtcbiAgICAgIGlkOiAxMyxcbiAgICAgIGRhdGE6IC8vIE5vZGVKUyBDb2RlIGRlc2NyaWJpbmcgdGhlIGV4ZXJjaXNlXG4gICAgICBjcmVhdGVkQXQ6IDIwMTgtMDItMjFUMDg6NTA6MjguMDAwWixcbiAgICAgIHVwZGF0ZWRBdDogMjAxOC0wMy0wNFQxMzozODo0OC4wMDBaLFxuICAgICAgc3VidG9waWNJZDogMTMsXG4gICAgICBzdWJ0b3BpYzogJ1BlbmdlbmFsYW4gQmlsYW5nYW4gMSAtIDUnLFxuICAgICAgZGVzY3JpcHRpb246ICcnLFxuICAgICAgc3VidG9waWNEYXRhOiAne1wiZGV0YWlsXCI6XCJcIn0nLFxuICAgICAgc3VidG9waWNObzogMTAxLFxuICAgICAgdG9waWNJZDogMTJcbiAgICB9XG5cbiAgICByZXR1cm46IHtcbiAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgIGRhdGEgOntcbiAgICAgICAgZXhlcmNpc2VEYXRhOiB7XG4gICAgICAgICAga25vd25zLCAgLy8gQWxyZWFkeSBzdHJpbmdpZmllZFxuICAgICAgICAgIHVua25vd25zLCAvLyBBbHJlYWR5IHN0cmluZ2lmaWVkXG4gICAgICAgICAgdXNlckFuc3dlciwgLy8gRE9ORVxuICAgICAgICAgIGV4ZXJjaXNlSWQ6IDQwLFxuICAgICAgICAgIGlkZWFsVGltZTogNjAsXG4gICAgICAgICAgc3VidG9waWNOYW1lOiAnUGVuZ2VuYWxhbiBIYXNpbCBCaWxhbmdhbiAxLTUnXG4gICAgICAgIH1cbiAgICAgICAgZm9ybWF0dGVkOiB7XG4gICAgICAgICAgcmVuZGVyZWRRdWVzdGlvbnMsIC8vIEhUTUwtcmVuZGVyZWQgcXVlc3Rpb24gYXJyYXlcbiAgICAgICAgICB1bmtub3ducywgLy8gVmFyaWFibGUgZm9yIGlucHV0c1xuICAgICAgICAgIHN1YnRvcGljTmFtZTogJ1Blbmp1bWxhaGFuIEhhc2lsIEJpbGFuZ2FuIDEtNSdcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgKi9cbiAgZ2V0Rm9ybWF0dGVkRXhlcmNpc2UgKHRvcGljSWQsIHVzZXJJZCk6IFByb21pc2U8TkNSZXNwb25zZTxGb3JtYXR0ZWRUb3BpY0V4ZXJjaXNlPj4ge1xuICAgIGlmICh0b3BpY0lkICYmIHVzZXJJZCkge1xuICAgICAgcmV0dXJuIFByb21pc2Uuam9pbjxhbnk+KFxuICAgICAgICB0aGlzLmdldEV4ZXJjaXNlcyh0b3BpY0lkKSxcbiAgICAgICAgdGhpcy5nZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKHVzZXJJZCwgdG9waWNJZCksXG4gICAgICAgIHRoaXMuZ2V0RXhlcmNpc2VzSGFzaCh0b3BpY0lkKSxcbiAgICAgICAgdGhpcy5nZXRUb3BpYyh0b3BpY0lkKVxuICAgICAgKS5zcHJlYWQoKHJlc3A6IE5DUmVzcG9uc2U8RXhlcmNpc2VbXT4sIHJlc3AyOiBOQ1Jlc3BvbnNlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+LFxuICAgICAgICAgICAgICAgIHJlc3AzOiBOQ1Jlc3BvbnNlPHN0cmluZz4sIHJlc3A0OiBOQ1Jlc3BvbnNlPFRvcGljPikgPT4ge1xuICAgICAgICBpZiAocmVzcDMuc3RhdHVzICYmIHJlc3A0LnN0YXR1cykge1xuICAgICAgICAgIGNvbnN0IHRvcGljRXhlcmNpc2VIYXNoID0gcmVzcDMuZGF0YVxuICAgICAgICAgIC8vIElmIHRoZXJlJ3MgdmFsaWQgZXhlcmNpc2UgdG8gYmUgcmVzdG9yZWRcbiAgICAgICAgICBpZiAocmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEgJiYgcmVzcDIuZGF0YS50b3BpY0V4ZXJjaXNlSGFzaCA9PT0gdG9waWNFeGVyY2lzZUhhc2gpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEdlbmVyYXRlZFRvcGljRXhlcmNpc2UocmVzcDIuZGF0YSlcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSAmJlxuICAgICAgICAgICAgICAgICAgICAoKHJlc3AyLnN0YXR1cyAmJiByZXNwMi5kYXRhICYmIHJlc3AyLmRhdGEudG9waWNFeGVyY2lzZUhhc2ggIT09IHRvcGljRXhlcmNpc2VIYXNoKSB8fFxuICAgICAgICAgICAgICAgICAgICAhcmVzcDIuc3RhdHVzKSkge1xuICAgICAgICAgICAgLy8gSWYgdGhlcmUncyBleHBpcmVkIGdlbmVyYXRlZCBleGVyY2lzZSBvciBubyBnZW5lcmF0ZWQgZXhlcmNpc2UgdG8gYmUgcmVzdG9yZWRcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYXRlVG9waWNFeGVyY2lzZSh0b3BpY0lkLCB1c2VySWQsIHJlc3AuZGF0YSkudGhlbihyZXNwNSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXNwNS5zdGF0dXMgJiYgcmVzcDUuZGF0YSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEdlbmVyYXRlZFRvcGljRXhlcmNpc2UocmVzcDUuZGF0YSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwNS5lcnJNZXNzYWdlIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gV2Ugc2hvdWxkIG5ldmVyIGdldCBoZXJlLi5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBlcnJvciEnKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSB0b3BpYyBvciB0b3BpY0V4ZXJjaXNlSGFzaDogJHtyZXNwMy5lcnJNZXNzYWdlIHx8IHJlc3A0LmVyck1lc3NhZ2V9YClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICd0b3BpY0lkIGFuZCB1c2VySWQgYXJlIHJlcXVpcmVkIScgfSlcbiAgICB9XG4gIH1cbiAgLypcbiAgICAgIHJldHVybjpcbiAgICAgICAgeyBzdGF0dXM6IHRydWUsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBkYXRhOiBbbm9kZUpzQ29kZUZvckV4ZXJjaXNlMSwgbm9kZUpzQ29kZUZvckV4ZXJjaXNlMl1cbiAgICAgICAgICB9XG4gICAgKi9cbiAgcHJpdmF0ZSBnZXRFeGVyY2lzZXMgKHRvcGljSWQpOiBQcm9taXNlPE5DUmVzcG9uc2U8RXhlcmNpc2VbXT4+IHtcbiAgICBsb2cudmVyYm9zZShUQUcsIGBjb3Vyc2Uuc2VydmljZS5nZXRFeGVyY2lzZVJlbGF0ZWRXaXRoVG9waWNJZC5HRVQgKHRvcGljSWQpOiAke3RvcGljSWR9YClcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShgXG4gIFNFTEVDVCBleGVyY2lzZXMuaWQsIGV4ZXJjaXNlcy5kYXRhLCBleGVyY2lzZXMuY3JlYXRlZEF0LCBleGVyY2lzZXMudXBkYXRlZEF0LCBleGVyY2lzZXMuc3VidG9waWNJZFxuICBGUk9NIGV4ZXJjaXNlcyBBUyBleGVyY2lzZXNcbiAgSU5ORVIgSk9JTiBzdWJ0b3BpY3MgQVMgc3VidG9waWMgT04gZXhlcmNpc2VzLnN1YnRvcGljSWQgPSBzdWJ0b3BpYy5pZCBBTkQgc3VidG9waWMudG9waWNJZCA9ICR7dG9waWNJZH1cbiAgT1JERVIgQlkgc3VidG9waWMuc3VidG9waWNObyBBU0MsIGV4ZXJjaXNlcy5pZCBBU0M7YCwgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfVxuICAgICkudGhlbihyZXNwID0+IHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogcmVzcCB9XG4gICAgfSlcbiAgfVxuXG4gICAgLypcbiAgICBJbnB1dDpcbiAgICAgIHRvcGljSWQ6IDVcbiAgICBPdXRwdXQ6XG4gICAgICB7XG4gICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHRvcGljRXhlcmNpc2VIYXNoOiAna2VrZWtla2VrJ1xuICAgICAgICB9XG4gICAgICB9XG4gICovXG4gIHByaXZhdGUgZ2V0RXhlcmNpc2VzSGFzaCAodG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxzdHJpbmc+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VzKHRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgIGNvbnN0IGNvbWJpbmVkSGFzaCA9IHJlc3AuZGF0YS5yZWR1Y2UoKGFjYywgaGFzaCkgPT4ge1xuICAgICAgICAgIHJldHVybiBhY2MgKyBFeGVyY2lzZUdlbmVyYXRvci5nZXRIYXNoKGhhc2gpXG4gICAgICAgIH0sICcnKVxuICAgICAgICBsZXQgdG9waWNFeGVyY2lzZUhhc2ggPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRIYXNoKGNvbWJpbmVkSGFzaClcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB0b3BpY0V4ZXJjaXNlSGFzaCB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiByZXNwLmVyck1lc3NhZ2UgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBnZW5lcmF0ZVRvcGljRXhlcmNpc2UgKHRvcGljSWQsIHVzZXJJZCwgZXhlcmNpc2VzOiBFeGVyY2lzZVtdKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VzSGFzaCh0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCB0b3BpY0V4ZXJjaXNlSGFzaCA9IHJlc3AuZGF0YVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5tYXAoZXhlcmNpc2VzLCBleGVyY2lzZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIEV4ZXJjaXNlU2VydmljZS5nZW5lcmF0ZUV4ZXJjaXNlKGV4ZXJjaXNlLCB0cnVlKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgICAgICAgIC8vIENoZWNrIHRoaXMgaGFzIHF1ZXN0aW9uc1xuICAgICAgICAgICAgICBjb25zdCBwYXJzZWRLbm93bnMgPSBKU09OLnBhcnNlKHJlc3AuZGF0YS5leGVyY2lzZURhdGEua25vd25zKVxuICAgICAgICAgICAgICBpZiAocGFyc2VkS25vd25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgZXhlcmNpc2VEYXRhOiByZXNwLmRhdGEuZXhlcmNpc2VEYXRhXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFNraXAgb3ZlciBlbXB0eSBxdWVzdGlvbnNcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgY29uc3QgZXhlcmNpc2VEZXRhaWw6IGFueVtdID0gW11cbiAgICAgICAgICBsZXQgaWRlYWxUaW1lID0gMFxuXG4gICAgICAgICAgLy8gTmVlZGVkIGZvciBUUyB0byB0eXBlY2hlY2tcbiAgICAgICAgICBmdW5jdGlvbiBub3RFbXB0eTxUVmFsdWU+ICh2YWx1ZTogVFZhbHVlIHwgbnVsbCB8IHVuZGVmaW5lZCk6IHZhbHVlIGlzIFRWYWx1ZSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJlc3VsdHMuZmlsdGVyKG5vdEVtcHR5KS5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZGVhbFRpbWUgKz0gcmVzdWx0LmV4ZXJjaXNlRGF0YS5pZGVhbFRpbWVcbiAgICAgICAgICAgIGV4ZXJjaXNlRGV0YWlsLnB1c2gocmVzdWx0LmV4ZXJjaXNlRGF0YSlcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgLy8gSW4gY2FzZSB0aGF0IHRoZSBleGVyY2lzZSBpcyBubyBsb25nZXIgdXAtdG8tZGF0ZSwgd2UgaGF2ZSB0byBkZWxldGUgc3RhbGUgZ2VuZXJhdGVkIGV4ZXJjaXNlXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlJykuZGVzdHJveSh7d2hlcmU6IHtcbiAgICAgICAgICAgIHRvcGljSWQsXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBzdWJtaXR0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICAgIH19KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPih7XG4gICAgICAgICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZFRvcGljRXhlcmNpc2UnLFxuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgdG9waWNJZCxcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgZXhlcmNpc2VEZXRhaWw6IEpTT04uc3RyaW5naWZ5KGV4ZXJjaXNlRGV0YWlsKSxcbiAgICAgICAgICAgICAgICB0b3BpY0V4ZXJjaXNlSGFzaCxcbiAgICAgICAgICAgICAgICBpZGVhbFRpbWUsXG4gICAgICAgICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIHJldHJpZXZlIGV4ZXJjaXNlIGhhc2ghJyB9XG4gICAgICB9XG4gICAgfSlcblxuICB9XG5cbiAgICAvLyBUT0RPOiBTaG91bGQgY2FsbCBmb3JtYXRFeGVyY2lzZSgpXG4gIC8qXG4gICAgVGhpcyBpcyBsaWtlIGdlbmVyYXRlRXhlcmNpc2UsIGJ1dCBza2lwcyBleGVyY2lzZSB0aGF0IGRvZXNuJ3QgaGF2ZSBhbnkgcXVlc3Rpb25zXG5cbiAgICBleGVyY2lzZURhdGFzOiBbe1xuICAgICAgaWQ6IDEzLFxuICAgICAgZGF0YTogLy8gTm9kZUpTIENvZGUgZGVzY3JpYmluZyB0aGUgZXhlcmNpc2VcbiAgICAgIGNyZWF0ZWRBdDogMjAxOC0wMi0yMVQwODo1MDoyOC4wMDBaLFxuICAgICAgdXBkYXRlZEF0OiAyMDE4LTAzLTA0VDEzOjM4OjQ4LjAwMFosXG4gICAgICBzdWJ0b3BpY0lkOiAxMyxcbiAgICAgIHN1YnRvcGljOiAnUGVuZ2VuYWxhbiBCaWxhbmdhbiAxIC0gNScsXG4gICAgICBzdWJ0b3BpYy5kZXNjcmlwdGlvbjogJycsXG4gICAgICBzdWJ0b3BpYy5kYXRhOiAne1wiZGV0YWlsXCI6XCJcIn0nLFxuICAgICAgc3VidG9waWMuc3VidG9waWNObzogMTAxLFxuICAgICAgc3VidG9waWMudG9waWNJZDogMTJcbiAgICB9XSxcbiAgICByZXR1cm46IHtcbiAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgIGRhdGEgOntcbiAgICAgICAgZXhlcmNpc2VEYXRhOiBbe1xuICAgICAgICAgIGtub3ducywgIC8vIEFscmVhZHkgc3RyaW5naWZpZWRcbiAgICAgICAgICB1bmtub3ducywgLy8gQWxyZWFkeSBzdHJpbmdpZmllZFxuICAgICAgICAgIHVzZXJBbnN3ZXIsIC8vIERPTkVcbiAgICAgICAgICBleGVyY2lzZUlkXG4gICAgICAgIH1dXG4gICAgICAgIGZvcm1hdHRlZDogW3tcbiAgICAgICAgICByZW5kZXJlZFF1ZXN0aW9uczogW1wiXFxuMiArIDMgPSA/XFxuXCIsIFwiXFxuMSArIDIgPSA/XFxuXCJdLCAvLyBIVE1MLXJlbmRlcmVkIHF1ZXN0aW9uIGFycmF5XG4gICAgICAgICAgdW5rbm93bnM6IFtbXCJ4XCJdLCBbXCJ4XCJdXSwgLy8gVmFyaWFibGUgZm9yIGlucHV0c1xuICAgICAgICAgIHVzZXJBbnN3ZXJcbiAgICAgICAgfV0sXG4gICAgICAgIGlkZWFsVGltZTogNTBcbiAgICAgIH1cbiAgICB9XG4gICovXG4gIGdlbmVyYXRlRXhlcmNpc2VzIChleGVyY2lzZXM6IEV4ZXJjaXNlW10pIHtcbiAgICByZXR1cm4gUHJvbWlzZS5tYXAoZXhlcmNpc2VzLCBleGVyY2lzZSA9PiB7XG4gICAgICByZXR1cm4gRXhlcmNpc2VTZXJ2aWNlLmdlbmVyYXRlRXhlcmNpc2UoZXhlcmNpc2UsIHRydWUpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICAgIC8vIENoZWNrIHRoaXMgaGFzIHF1ZXN0aW9uc1xuICAgICAgICAgIGNvbnN0IHBhcnNlZEtub3ducyA9IEpTT04ucGFyc2UocmVzcC5kYXRhLmV4ZXJjaXNlRGF0YS5rbm93bnMpXG4gICAgICAgICAgaWYgKHBhcnNlZEtub3ducy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBleGVyY2lzZURhdGE6IHJlc3AuZGF0YS5leGVyY2lzZURhdGEsXG4gICAgICAgICAgICAgIGZvcm1hdHRlZDogcmVzcC5kYXRhLmZvcm1hdHRlZFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBTa2lwIG92ZXIgZW1wdHkgcXVlc3Rpb25zXG4gICAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbnVsbFxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICBjb25zdCBleGVyY2lzZURhdGE6IGFueVtdID0gW11cbiAgICAgIGNvbnN0IGZvcm1hdHRlZDogYW55W10gPSBbXVxuICAgICAgbGV0IGlkZWFsVGltZSA9IDBcblxuICAgICAgLy8gTmVlZGVkIGZvciBUUyB0byB0eXBlY2hlY2tcbiAgICAgIGZ1bmN0aW9uIG5vdEVtcHR5PFRWYWx1ZT4gKHZhbHVlOiBUVmFsdWUgfCBudWxsIHwgdW5kZWZpbmVkKTogdmFsdWUgaXMgVFZhbHVlIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWRcbiAgICAgIH1cblxuICAgICAgcmVzdWx0cy5maWx0ZXIobm90RW1wdHkpLmZvckVhY2gocmVzdWx0ID0+IHtcbiAgICAgICAgaWRlYWxUaW1lICs9IHJlc3VsdC5leGVyY2lzZURhdGEuaWRlYWxUaW1lXG4gICAgICAgIGV4ZXJjaXNlRGF0YS5wdXNoKHJlc3VsdC5leGVyY2lzZURhdGEpXG4gICAgICAgIGZvcm1hdHRlZC5wdXNoKHJlc3VsdC5mb3JtYXR0ZWQpXG4gICAgICB9KVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBleGVyY2lzZURhdGEsXG4gICAgICAgICAgZm9ybWF0dGVkLFxuICAgICAgICAgIGlkZWFsVGltZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8qXG4gICAgUHJvbWlzZS5qb2luPGFueT4oXG4gICAgICB0aGlzLmdldEV4ZXJjaXNlcyh0b3BpY0lkKSxcbiAgICAgIHRoaXMuZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSh1c2VySWQsIHRvcGljSWQpLFxuICAgICAgdGhpcy5nZXRFeGVyY2lzZXNIYXNoKHRvcGljSWQpLFxuICAgICAgdGhpcy5nZXRUb3BpYyh0b3BpY0lkKVxuICAgICkuc3ByZWFkKChyZXNwOiBOQ1Jlc3BvbnNlPEV4ZXJjaXNlW10+LCByZXNwMjogTkNSZXNwb25zZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPixcbiAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8c3RyaW5nPiwgcmVzcDQ6IE5DUmVzcG9uc2U8VG9waWM+KSA9PiB7XG4gICAgICAvLyBsb2cudmVyYm9zZShUQUcsICdleGVyY2lzZS5yZXZpZXcuR0VUOiByZXNwPScgKyBKU09OLnN0cmluZ2lmeShyZXNwKSlcbiAgICAgIC8vIGxvZy52ZXJib3NlKFRBRywgJ2V4ZXJjaXNlLnJldmlldy5HRVQ6IHJlc3AyPScgKyBKU09OLnN0cmluZ2lmeShyZXNwMikpXG4gICAgICBpZiAocmVzcDMuc3RhdHVzICYmIHJlc3A0LnN0YXR1cykge1xuICAgICAgICBjb25zdCB0b3BpY05hbWUgPSByZXNwNC5kYXRhXG4gICAgICAgIGNvbnN0IHRvcGljRXhlcmNpc2VIYXNoID0gcmVzcDMuZGF0YVxuICAgICAgICAvLyBJZiB0aGVyZSdzIHZhbGlkIGV4ZXJjaXNlIHRvIGJlIHJlc3RvcmVkXG4gICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJiByZXNwMi5kYXRhLnRvcGljRXhlcmNpc2VIYXNoID09PSB0b3BpY0V4ZXJjaXNlSGFzaCkge1xuICAgICAgICAgIGNvbnN0IGdlbmVyYXRlZFRvcGljRXhlcmNpc2U6IEdlbmVyYXRlZEV4ZXJjaXNlW10gPSBKU09OLnBhcnNlKHJlc3AyLmRhdGEuZXhlcmNpc2VEZXRhaWwpXG4gICAgICAgICAgY29uc3QgaWRlYWxUaW1lID0gcmVzcDIuZGF0YS5pZGVhbFRpbWVcbiAgICAgICAgICBjb25zdCBlbGFwc2VkVGltZSA9IFV0aWxzLmdldEVsYXBzZWRUaW1lKHJlc3AyLmRhdGEuY3JlYXRlZEF0KVxuICAgICAgICAgIHJldHVybiB0aGlzLmZvcm1hdEV4ZXJjaXNlcyhnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLCB0b3BpY0lkLCBpZGVhbFRpbWUsIGVsYXBzZWRUaW1lKS50aGVuKHJlc3A1ID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwNS5zdGF0dXMgJiYgcmVzcDUuZGF0YSkge1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGZvcm1hdHRlZDogcmVzcDUuZGF0YSxcbiAgICAgICAgICAgICAgICB0b3BpY05hbWUsXG4gICAgICAgICAgICAgICAgaWRlYWxUaW1lLFxuICAgICAgICAgICAgICAgIGVsYXBzZWRUaW1lXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZvcm1hdEV4ZXJjaXNlOiAnICsgcmVzcDUuZXJyTWVzc2FnZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAqL1xuXG4gIHByaXZhdGUgZm9ybWF0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSAoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZTogR2VuZXJhdGVkVG9waWNFeGVyY2lzZSk6IFByb21pc2U8TkNSZXNwb25zZTxGb3JtYXR0ZWRUb3BpY0V4ZXJjaXNlPj4ge1xuICAgIGNvbnN0IHRvcGljSWQgPSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLnRvcGljSWRcbiAgICBjb25zdCBnZW5lcmF0ZWRFeGVyY2lzZXM6IEdlbmVyYXRlZEV4ZXJjaXNlW10gPSBKU09OLnBhcnNlKGdlbmVyYXRlZFRvcGljRXhlcmNpc2UuZXhlcmNpc2VEZXRhaWwpXG4gICAgcmV0dXJuIFByb21pc2UubWFwKGdlbmVyYXRlZEV4ZXJjaXNlcywgZ2VuZXJhdGVkRXhlcmNpc2UgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMucmVhZE9uZTxFeGVyY2lzZT4oeyBtb2RlbE5hbWU6ICdFeGVyY2lzZScsIHNlYXJjaENsYXVzZTogeyBpZDogZ2VuZXJhdGVkRXhlcmNpc2UuZXhlcmNpc2VJZCB9IH0pLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICBpZiAocmVzcDIuc3RhdHVzICYmIHJlc3AyLmRhdGEpIHtcbiAgICAgICAgICBsZXQgZXhlcmNpc2VTb2x2ZXIgPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRFeGVyY2lzZVNvbHZlcihyZXNwMi5kYXRhLmRhdGEpXG4gICAgICAgICAgbGV0IHVua25vd25zOiBBcnJheTxzdHJpbmdbXT4gPSBbXVxuICAgICAgICAgIGxldCBmb3JtYXR0ZWRRdWVzdGlvbnNQcm9taXNlczogQXJyYXk8UHJvbWlzZTxzdHJpbmc+PiA9IFtdXG4gICAgICAgICAgSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS5rbm93bnMpLmZvckVhY2goa25vd25zID0+IHtcbiAgICAgICAgICAgIGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzLnB1c2goZXhlcmNpc2VTb2x2ZXIuZm9ybWF0UXVlc3Rpb24oa25vd25zKSlcbiAgICAgICAgICB9KVxuICAgICAgICAgIEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UudW5rbm93bnMpLmZvckVhY2goX3Vua25vd25zID0+IHtcbiAgICAgICAgICAgIHVua25vd25zLnB1c2goT2JqZWN0LmtleXMoX3Vua25vd25zKSlcbiAgICAgICAgICB9KVxuICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChmb3JtYXR0ZWRRdWVzdGlvbnNQcm9taXNlcykudGhlbihyZW5kZXJlZFF1ZXN0aW9ucyA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICByZW5kZXJlZFF1ZXN0aW9ucyxcbiAgICAgICAgICAgICAgdW5rbm93bnNcbiAgICAgICAgICAgIH0gYXMgRm9ybWF0dGVkRXhlcmNpc2VcbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZXNwMi5lcnJNZXNzYWdlKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pLnRoZW4oZm9ybWF0dGVkRXhlcmNpc2VzID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnJlYWRPbmU8VG9waWM+KHsgbW9kZWxOYW1lOiAnVG9waWMnLCBzZWFyY2hDbGF1c2U6IHsgaWQ6IHRvcGljSWQgfSB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1czogdHJ1ZSxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgdG9waWNOYW1lOiByZXNwLmRhdGEudG9waWMsXG4gICAgICAgICAgICAgIGZvcm1hdHRlZEV4ZXJjaXNlcyxcbiAgICAgICAgICAgICAgaWRlYWxUaW1lOiBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlLmlkZWFsVGltZSxcbiAgICAgICAgICAgICAgZWxhcHNlZFRpbWU6IFV0aWxzLmdldEVsYXBzZWRUaW1lKGdlbmVyYXRlZFRvcGljRXhlcmNpc2UuY3JlYXRlZEF0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnJyB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIC8qXG4gIElucHV0OlxuICAgIGdlbmVyYXRlZEV4ZXJjaXNlczogW3tcbiAgICAgIGtub3duczogJ1t7XCJhXCI6MixcImJcIjoyfSx7XCJhXCI6MixcImJcIjoxfV0nLFxuICAgICAgdW5rbm93bnM6ICdbe1wieFwiOlwiRW1wYXRcIn0se1wieFwiOlwiVGlnYVwifV0nLFxuICAgICAgdXNlckFuc3dlcjogW10sXG4gICAgICBleGVyY2lzZUlkOiAxNCxcbiAgICAgIHN1YnRvcGljTmFtZTogJ1Blbmp1bWxhaGFuIEhhc2lsIEJpbGFuZ2FuIDEtNScsXG4gICAgICBpZGVhbFRpbWU6IDQwXG4gICAgfV1cblxuICBPdXRwdXQ6XG4gICAgW3tcbiAgICAgIFwic3RhdHVzXCI6IHRydWUsXG4gICAgICBcImRhdGFcIjoge1xuICAgICAgICByZW5kZXJlZFF1ZXN0aW9uczogW1wiXFxuMiArIDMgPSA/XFxuXCIsIFwiXFxuMSArIDIgPSA/XFxuXCJdLCAvLyBIVE1MLXJlbmRlcmVkIHF1ZXN0aW9uIGFycmF5XG4gICAgICAgIHVua25vd25zOiBbW1wieFwiXSwgW1wieFwiXV0sIC8vIFZhcmlhYmxlIGZvciBpbnB1dHNcbiAgICAgIH1cbiAgICB9XVxuICAqL1xuICAvLyBUT0RPOiBSZS11c2UgLmZvcm1hdEV4ZXJjaXNlKCkgZnJvbSBleGVyY2lzZS1zZXJ2aWNlXG4gIHByaXZhdGUgZm9ybWF0RXhlcmNpc2VzIChnZW5lcmF0ZWRFeGVyY2lzZXM6IEdlbmVyYXRlZEV4ZXJjaXNlW10pOiBQcm9taXNlPE5DUmVzcG9uc2U8Rm9ybWF0dGVkRXhlcmNpc2VbXT4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5tYXAoZ2VuZXJhdGVkRXhlcmNpc2VzLCBnZW5lcmF0ZWRFeGVyY2lzZSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5yZWFkT25lPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5leGVyY2lzZUlkIH0gfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGxldCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKHJlc3AuZGF0YS5kYXRhKVxuICAgICAgICAgIGxldCB1bmtub3duczogYW55W10gPSBbXVxuICAgICAgICAgIGxldCBmb3JtYXR0ZWRRdWVzdGlvbnNQcm9taXNlczogQXJyYXk8UHJvbWlzZTxzdHJpbmc+PiA9IFtdXG4gICAgICAgICAgSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS5rbm93bnMpLmZvckVhY2goa25vd25zID0+IHtcbiAgICAgICAgICAgIGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzLnB1c2goZXhlcmNpc2VTb2x2ZXIuZm9ybWF0UXVlc3Rpb24oa25vd25zKSlcbiAgICAgICAgICB9KVxuICAgICAgICAgIEpTT04ucGFyc2UoZ2VuZXJhdGVkRXhlcmNpc2UudW5rbm93bnMpLmZvckVhY2goX3Vua25vd25zID0+IHtcbiAgICAgICAgICAgIHVua25vd25zLnB1c2goT2JqZWN0LmtleXMoX3Vua25vd25zKSlcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzKS50aGVuKHJlbmRlcmVkUXVlc3Rpb25zID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHJlbmRlcmVkUXVlc3Rpb25zLFxuICAgICAgICAgICAgICB1bmtub3duc1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3AuZXJyTWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KS50aGVuKGZvcm1hdHRlZEV4ZXJjaXNlcyA9PiB7XG4gICAgICAvKlxuICAgICAgICBmb3JtYXR0ZWRFeGVyY2lzZToge1xuICAgICAgICAgIHJlbmRlcmVkUXVlc3Rpb25zOiBbJycsICcnXSxcbiAgICAgICAgICB1bmtub3duczogW1sneCcsICd5J10sIFsneCcsICd5J11dXG4gICAgICAgIH1cbiAgICAgICovXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXM6IHRydWUsXG4gICAgICAgIGRhdGE6IGZvcm1hdHRlZEV4ZXJjaXNlc1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvKlxuICBleGVyY2lzZURldGFpbHM6XG4gIFsgeyBrbm93bnM6ICdbe1wiYVwiOjN9LHtcImFcIjo1fSx7XCJhXCI6NH0se1wiYVwiOjJ9XScsXG4gICAgICB1bmtub3duczogJ1t7XCJ4XCI6M30se1wieFwiOjV9LHtcInhcIjo0fSx7XCJ4XCI6Mn1dJyxcbiAgICAgIHVzZXJBbnN3ZXI6IFtdLFxuICAgICAgZXhlcmNpc2VJZDogMjMgfSxcbiAgICB7IGtub3duczogJ1t7XCJhXCI6NCxcImJcIjoxfV0nLFxuICAgICAgdW5rbm93bnM6ICdbe1wieFwiOjV9XScsXG4gICAgICB1c2VyQW5zd2VyOiBbXSxcbiAgICAgIGV4ZXJjaXNlSWQ6IDI1IH0sXG4gICAgeyBrbm93bnM6ICdbe1wiYVwiOjQsXCJiXCI6MX0se1wiYVwiOjMsXCJiXCI6Mn0se1wiYVwiOjMsXCJiXCI6MX1dJyxcbiAgICAgIHVua25vd25zOiAnW3tcInhcIjpcIkxpbWFcIn0se1wieFwiOlwiTGltYVwifSx7XCJ4XCI6XCJFbXBhdFwifV0nLFxuICAgICAgdXNlckFuc3dlcjogW10sXG4gICAgICBleGVyY2lzZUlkOiAzMSB9IF1cbiAgdXNlckFuc3dlcnM6IFt7eDogM30sIHt4OiA1fSwge3g6IDR9LCB7eDogMn0sIHt4OiA1fSwge3g6ICdsaW1hJ30sIHt4OiAnbGltYSd9LCB7eDogJ2VtcGF0J31dXG4gIHJldHVybjoge1xuICAgIHN0YXR1czogdHJ1ZS9mYWxzZVxuICAgIGRhdGE6IFtcbiAgICAgIHtpc0NvcnJlY3Q6IGZhbHNlLCB1bmtub3duOiB7XCJ4XCI6M319LFxuICAgICAge2lzQ29ycmVjdDogZmFsc2UsIHVua25vd246IHtcInhcIjo1fX0sXG4gICAgICB7aXNDb3JyZWN0OiB0cnVlLCB1bmtub3duOiB7XCJ4XCI6XCJMaW1hXCJ9fSxcblxuICAgIF1cbiAgfVxuICAqL1xuICBjaGVja0Fuc3dlciAoZXhlcmNpc2VEZXRhaWxzOiBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlRGV0YWlsW10sIHVzZXJBbnN3ZXJzOiBBcnJheTx7W2tleTogc3RyaW5nXTogYW55fT4pOiBQcm9taXNlPE5DUmVzcG9uc2U8YW55Pj4ge1xuICAgIHJldHVybiBQcm9taXNlLm1hcChleGVyY2lzZURldGFpbHMsIGV4ZXJjaXNlRGV0YWlsID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnJlYWRPbmU8RXhlcmNpc2U+KHsgbW9kZWxOYW1lOiAnRXhlcmNpc2UnLCBzZWFyY2hDbGF1c2U6IHsgaWQ6IGV4ZXJjaXNlRGV0YWlsLmV4ZXJjaXNlSWQgfSB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgZXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgICBjb25zdCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKGV4ZXJjaXNlLmRhdGEpXG4gICAgICAgICAgY29uc3Qga25vd25zID0gSlNPTi5wYXJzZShleGVyY2lzZURldGFpbC5rbm93bnMpXG4gICAgICAgICAgY29uc3QgdW5rbm93bnMgPSBKU09OLnBhcnNlKGV4ZXJjaXNlRGV0YWlsLnVua25vd25zKVxuICAgICAgICAgIHJldHVybiBrbm93bnMubWFwKChrbm93biwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7IGtub3duLCB1bmtub3duOiB1bmtub3duc1tpbmRleF0sIGlzQW5zd2VyRm46IGV4ZXJjaXNlU29sdmVyLmlzQW5zd2VyLmJpbmQoZXhlcmNpc2VTb2x2ZXIpIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhlcmNpc2Ugd2l0aCBpZD0nICsgZXhlcmNpc2VEZXRhaWwuZXhlcmNpc2VJZCArICcgY291bGQgbm90IGJlIGZvdW5kIScpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSkudGhlbihyZXN1bHRzID0+IHtcbiAgICAgIC8vIFtbe2tub3duOiB7YTogM30sIHVua25vd24sIGlzQW5zd2VyRm59LCB7a25vd246IHthOiA1fSwgdW5rbm93biwgaXNBbnN3ZXJGbjogW09iamVjdF19XSwgW1t7fSwge31dLiBbe30sIHt9XV0gLT4gW3t9LCB7fSwge30sIHt9XV1cbiAgICAgIC8vIFt7a25vd246IHthOiAzfSwgdW5rbm93biwgaXNBbnN3ZXJGbjogW09iamVjdF19LCB7a25vd246IHthOiA1fSwgdW5rbm93biwgaXNBbnN3ZXJGbjogW09iamVjdF19XVxuICAgICAgY29uc3QgZmxhdHRlbmVkUmVzdWx0cyA9IHJlc3VsdHMucmVkdWNlKChhY2MsIHJlc3VsdEFycikgPT4ge1xuICAgICAgICByZXR1cm4gYWNjLmNvbmNhdChyZXN1bHRBcnIpXG4gICAgICB9LCBbXSlcbiAgICAgIGNvbnN0IGRhdGEgPSBmbGF0dGVuZWRSZXN1bHRzLm1hcCgocmVzdWx0LCBpbmRleCkgPT4ge1xuICAgICAgICByZXR1cm4geyBpc0NvcnJlY3Q6IHJlc3VsdC5pc0Fuc3dlckZuKHJlc3VsdC5rbm93biwgdXNlckFuc3dlcnNbaW5kZXhdKSwgdW5rbm93bjogcmVzdWx0LnVua25vd24gfVxuICAgICAgfSlcblxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhIH1cbiAgICB9KVxuICB9XG5cbiAgZ3JhZGVFeGVyY2lzZSAoZ2VuZXJhdGVkRXhlcmNpc2VEZXRhaWxzOiBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlRGV0YWlsW10sIGFuc3dlcnM6IFRvcGljRXhlcmNpc2VBbnN3ZXIpOiBQcm9taXNlPE5DUmVzcG9uc2U8VG9waWNFeGVyY2lzZUdyYWRlPj4ge1xuICAgIHJldHVybiBQcm9taXNlLm1hcChnZW5lcmF0ZWRFeGVyY2lzZURldGFpbHMsIGV4ZXJjaXNlRGV0YWlsID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnJlYWRPbmU8RXhlcmNpc2U+KHsgbW9kZWxOYW1lOiAnRXhlcmNpc2UnLCBzZWFyY2hDbGF1c2U6IHsgaWQ6IGV4ZXJjaXNlRGV0YWlsLmV4ZXJjaXNlSWQgfSB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICBpZiAocmVzcC5zdGF0dXMgJiYgcmVzcC5kYXRhKSB7XG4gICAgICAgICAgY29uc3QgZXhlcmNpc2UgPSByZXNwLmRhdGFcbiAgICAgICAgICBjb25zdCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKGV4ZXJjaXNlLmRhdGEpXG4gICAgICAgICAgY29uc3Qga25vd25zID0gSlNPTi5wYXJzZShleGVyY2lzZURldGFpbC5rbm93bnMpXG4gICAgICAgICAgY29uc3QgdW5rbm93bnMgPSBKU09OLnBhcnNlKGV4ZXJjaXNlRGV0YWlsLnVua25vd25zKVxuICAgICAgICAgIHJldHVybiBrbm93bnMubWFwKChrbm93biwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7IGtub3duLCBjb3JyZWN0QW5zd2VyOiB1bmtub3duc1tpbmRleF0sIGlzQW5zd2VyRm46IGV4ZXJjaXNlU29sdmVyLmlzQW5zd2VyLmJpbmQoZXhlcmNpc2VTb2x2ZXIpIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhlcmNpc2Ugd2l0aCBpZD0nICsgZXhlcmNpc2VEZXRhaWwuZXhlcmNpc2VJZCArICcgY291bGQgbm90IGJlIGZvdW5kIScpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSkudGhlbih0b3BpY0V4ZXJjaXNlQXJyYXkgPT4ge1xuICAgICAgLy8gTm93LCB3ZSBoYXZlIDMgbGV2ZWwgYXJyYXlzOlxuICAgICAgLy8gMSAtPiBUb3BpYyBFeGVyY2lzZS4gMiAtPiBFeGVyY2lzZS4gMyAtPiBRdWVzdGlvblxuICAgICAgLy8gQnV0IHNpbmNlIHVzZXJBbnN3ZXIgaXMgYSAxLWxldmVsIGFycmF5IG9mIHF1ZXN0aW9uLCB3ZSBuZWVkIHRvIGZsYXR0ZW4gd2hhdCB3ZSBoYXZlIHRvIGJlIGVhc2lseSB1c2VkXG4gICAgICByZXR1cm4gdG9waWNFeGVyY2lzZUFycmF5LnJlZHVjZSgoYWNjLCBleGVyY2lzZUFycmF5KSA9PiB7XG4gICAgICAgIHJldHVybiBhY2MuY29uY2F0KGV4ZXJjaXNlQXJyYXkpXG4gICAgICB9LCBbXSkucmVkdWNlKChhY2MsIHF1ZXN0aW9uQXJyYXkpID0+IHtcbiAgICAgICAgcmV0dXJuIGFjYy5jb25jYXQocXVlc3Rpb25BcnJheSlcbiAgICAgIH0sIFtdKVxuICAgIH0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICBjb25zb2xlLmRpcihyZXN1bHRzKVxuICAgICAgY29uc3QgeyBudW1Db3JyZWN0QW5zd2VycywgY29ycmVjdEFuc3dlcnMsIGlzQ29ycmVjdCB9ID0gcmVzdWx0cy5yZWR1Y2UoKGFjYywgcmVzdWx0LCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCBpc0NvcnJlY3QgPSByZXN1bHQuaXNBbnN3ZXJGbihyZXN1bHQua25vd24sIGFuc3dlcnNbaW5kZXhdKVxuICAgICAgICBhY2MubnVtQ29ycmVjdEFuc3dlcnMgKz0gaXNDb3JyZWN0ID8gMSA6IDBcbiAgICAgICAgYWNjLmNvcnJlY3RBbnN3ZXJzLnB1c2gocmVzdWx0LmNvcnJlY3RBbnN3ZXIpXG4gICAgICAgIGFjYy5pc0NvcnJlY3QucHVzaChpc0NvcnJlY3QpXG4gICAgICAgIHJldHVybiBhY2NcbiAgICAgIH0sIHsgbnVtQ29ycmVjdEFuc3dlcnM6IDAsIGNvcnJlY3RBbnN3ZXJzOiBbXSwgaXNDb3JyZWN0OiBbXSB9KVxuICAgICAgY29uc3QgbnVtUXVlc3Rpb25zID0gcmVzdWx0cy5sZW5ndGhcbiAgICAgIGNvbnN0IGdyYWRlOiBUb3BpY0V4ZXJjaXNlR3JhZGUgPSB7XG4gICAgICAgIG51bVF1ZXN0aW9ucyxcbiAgICAgICAgbnVtQ29ycmVjdEFuc3dlcnMsXG4gICAgICAgIGNvcnJlY3RBbnN3ZXJzLFxuICAgICAgICBpc0NvcnJlY3QsXG4gICAgICAgIHNjb3JlOiBwYXJzZUZsb2F0KG51bUNvcnJlY3RBbnN3ZXJzKSAvIG51bVF1ZXN0aW9ucyAqIDEwMFxuICAgICAgfVxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBncmFkZSB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIFVwZGF0ZSBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIGFzIHN1Ym1pdHRlZFxuICBmaW5pc2hFeGVyY2lzZSAoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZUlkOiBudW1iZXIsIHNjb3JlOiBudW1iZXIsIHRpbWVGaW5pc2g6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgIGV4ZXJjaXNlRGV0YWlsczogR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbFtdLCBhbnN3ZXJzOiBUb3BpY0V4ZXJjaXNlQW5zd2VyW10pOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIC8vIFRoaXMgaXMgYSBiaXQgYW5ub3lpbmcuLlxuICAgIC8vIFNvIGFuc3dlciBpcyB3aGF0IGEgc3R1ZGVudCB3b3VsZCBzdWJtaXQuIEl0J3MgYSBvbmUgZGltZW5zaW9uYWwgYXJyYXkgb2YgYW5zd2VycyBmb3IgZWFjaCBvZiB0aGUgZXhlcmNpc2VzXG4gICAgLy8gV2Ugd2FudCB0byBzYXZlIHVzZXIgYW5zd2VyIGludG8gZXhlcmNpc2VEZXRhaWwgc28gdGhhdCB3ZSBjYW4gZGVidWcgcHJvYmxlbXMuIChpLmUuIHdyb25nIHNjb3JpbmcpXG4gICAgLy8gSW4gb3JkZXIgdG8gbWFrZSBzdXJlIGVhY2ggYW5zd2VyIGdvZXMgdG8gY29ycmVjdCBleGVyY2lzZSBkZXRhaWwsIHdlIGhhdmUgd2luZCB0aGVtIHVwXG4gICAgLy8gaW4gdGhlIHNhbWUgb3JkZXIgd2hlbiB3ZSB1bndpbmQuIElmIHlvdSdyZSBjb25mdXNlZCBhYm91dCB0aGlzIGNvZGU6XG4gICAgLy8gMS4gVHJ5IHRvIGxvb2sgYXQgTXlTUUwgdGFibGUgc3RydWN0dXJlIGZvciBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlc1xuICAgIC8vIDIuIFJlbWVtYmVyIHRoYXQgZXhlcmNpc2VEZXRhaWwgdGhlcmUgaXMgc3RyaW5naWZpZWQgdmVyc2lvbiBvZiBlYWNoIG9mIGdlbmVyYXRlZEV4ZXJjaXNlcyB0aGF0IG1ha2VzIHVwXG4gICAgLy8gICAgYSB0b3BpYyBleGVyY2lzZS5cbiAgICBsZXQgYW5zd2VySW5kZXggPSAwXG4gICAgY29uc3QgZXhlcmNpc2VEZXRhaWwgPSBKU09OLnN0cmluZ2lmeShleGVyY2lzZURldGFpbHMubWFwKGV4ZXJjaXNlRGV0YWlsID0+IHtcbiAgICAgIGNvbnNvbGUuZGlyKGV4ZXJjaXNlRGV0YWlsKVxuICAgICAgY29uc3QgZXhlcmNpc2VEZXRhaWxBbnN3ZXJzOiBBcnJheTxhbnk+ID0gW11cbiAgICAgIEpTT04ucGFyc2UoZXhlcmNpc2VEZXRhaWwua25vd25zKS5mb3JFYWNoKF8gPT4ge1xuICAgICAgICBleGVyY2lzZURldGFpbEFuc3dlcnMucHVzaChhbnN3ZXJzW2Fuc3dlckluZGV4XSlcbiAgICAgICAgYW5zd2VySW5kZXgrK1xuICAgICAgfSlcbiAgICAgIGV4ZXJjaXNlRGV0YWlsLnVzZXJBbnN3ZXIgPSBKU09OLnN0cmluZ2lmeShleGVyY2lzZURldGFpbEFuc3dlcnMpXG4gICAgICByZXR1cm4gZXhlcmNpc2VEZXRhaWxcbiAgICB9KSlcbiAgICByZXR1cm4gdGhpcy51cGRhdGU8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkVG9waWNFeGVyY2lzZScsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGlkOiBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQsXG4gICAgICAgIHN1Ym1pdHRlZDogdHJ1ZSxcbiAgICAgICAgc3VibWl0dGVkQXQ6IG1vbWVudCgpLmxvY2FsKCkuZm9ybWF0KCdZWVlZLU1NLUREIEhIOm1tOnNzJyksXG4gICAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVIsXG4gICAgICAgIHNjb3JlLFxuICAgICAgICB0aW1lRmluaXNoLFxuICAgICAgICBleGVyY2lzZURldGFpbFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvKlxuICB7XG4gICAgc3RhdHVzOiB0cnVlLFxuICAgIGRhdGE6XG4gICAgIFsgeyBpZDogMyxcbiAgICAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICAgICBzY29yZTogbnVsbCxcbiAgICAgICAgIHRpbWVGaW5pc2g6IG51bGwsXG4gICAgICAgICBleGVyY2lzZURldGFpbDpcbiAgICAgICAgICAgIFsgeyBrbm93bnM6ICdbe1wiYVwiOjIsXCJiXCI6Mn0se1wiYVwiOjIsXCJiXCI6MX1dJyxcbiAgICAgICAgICAgICAgICB1bmtub3duczogJ1t7XCJ4XCI6XCJFbXBhdFwifSx7XCJ4XCI6XCJUaWdhXCJ9XScsXG4gICAgICAgICAgICAgICAgdXNlckFuc3dlcjogW10sXG4gICAgICAgICAgICAgICAgZXhlcmNpc2VIYXNoOiAnMGM5YTYxMGEyNmQ2MTM5NGJmZGU5ZTg3NzUzM2U5YjknLFxuICAgICAgICAgICAgICAgIGV4ZXJjaXNlSWQ6IDE0IH0gXSxcbiAgICAgICAgIGNyZWF0ZWRBdDogMjAxOC0wMy0yM1QwNzo1MTozNC4wMDBaLFxuICAgICAgICAgdXBkYXRlZEF0OiAyMDE4LTAzLTIzVDA3OjUxOjM0LjAwMFosXG4gICAgICAgICB0b3BpY0lkOiAxMixcbiAgICAgICAgIHVzZXJJZDogMTQgfSBdXG4gICB9XG4gICovXG4gIGdldEdlbmVyYXRlZFRvcGljRXhlcmNpc2UgKHVzZXJJZCwgdG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPj4ge1xuICAgIHJldHVybiB0aGlzLnJlYWRPbmU8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkVG9waWNFeGVyY2lzZScsXG4gICAgICBzZWFyY2hDbGF1c2U6IHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICB0b3BpY0lkLFxuICAgICAgICBzdWJtaXR0ZWQ6IGZhbHNlLFxuICAgICAgICBvbkNsb3VkOiBBcHBDb25maWcuQ0xPVURfU0VSVkVSXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8qXG4gIElucHV0OlxuICAgIHRvcGljSWQ6IDNcbiAgICB1c2VySWQ7IDUsXG4gICAgZXhlcmNpc2VEZXRhaWw6XG4gICAgWyB7IGtub3duczogJ1t7XCJhXCI6MixcImJcIjoyfSx7XCJhXCI6MixcImJcIjoxfV0nLFxuICAgICAgICB1bmtub3duczogJ1t7XCJ4XCI6XCJFbXBhdFwifSx7XCJ4XCI6XCJUaWdhXCJ9XScsXG4gICAgICAgIHVzZXJBbnN3ZXI6IFtdLFxuICAgICAgICBleGVyY2lzZUlkOiAxNCB9IF0sXG4gICAgdG9waWNFeGVyY2lzZUhhc2g6ICdrZGtka2RrJyxcbiAgICBpZGVhbFRpbWU6IDUwXG5cbiAgICBJZiB0aGVyZSdzIGFscmVhZHkgdW5zdWJtaXR0ZWQgZ2VuZXJhdGVkVG9waWNFeGVyY2lzZSwgcmVtb3ZlIGl0IGZpcnN0LiBUaGVuXG4gICAgc2F2ZSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIG9mIGEgdXNlciB0byBkYXRhYmFzZVxuICAqL1xuICBzYXZlR2VuZXJhdGVkVG9waWNFeGVyY2lzZSAodG9waWNJZCwgdXNlcklkLCBleGVyY2lzZURldGFpbCwgdG9waWNFeGVyY2lzZUhhc2gsIGlkZWFsVGltZSkge1xuICAgIHJldHVybiB0aGlzLmdldE1vZGVscygnR2VuZXJhdGVkVG9waWNFeGVyY2lzZScpLmRlc3Ryb3koe3doZXJlOiB7XG4gICAgICB0b3BpY0lkLFxuICAgICAgdXNlcklkLFxuICAgICAgc3VibWl0dGVkOiBmYWxzZSxcbiAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVJcbiAgICB9fSkudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5jcmVhdGU8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4oe1xuICAgICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHRvcGljSWQsXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIGV4ZXJjaXNlRGV0YWlsOiBKU09OLnN0cmluZ2lmeShleGVyY2lzZURldGFpbCksXG4gICAgICAgICAgdG9waWNFeGVyY2lzZUhhc2gsXG4gICAgICAgICAgaWRlYWxUaW1lLFxuICAgICAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVJcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLypcbiAgICBJbnB1dDpcbiAgICAgIGdlbmVyYXRlZFRvcGljSWQ6IDEsXG4gICAgICBzY29yZTogMTAwXG4gICAgICB0aW1lRmluaXNoOiAyMy4yM1xuICAgICAgZXhlcmNpc2VEZXRhaWw6ICdbe2tub3duczoge2E6IDEsIGI6Mn0sIHVua25vd25zOiBbe3g6M31dfV0nXG4gICovXG4gIHVwZGF0ZUdlbmVyYXRlZFRvcGljQW5zd2VyIChnZW5lcmF0ZWRUb3BpY0lkLCBzY29yZSwgdGltZUZpbmlzaCwgZXhlcmNpc2VEZXRhaWwpIHtcbiAgICByZXR1cm4gdGhpcy51cGRhdGU8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkVG9waWNFeGVyY2lzZScsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGlkOiBnZW5lcmF0ZWRUb3BpY0lkLFxuICAgICAgICBzdWJtaXR0ZWQ6IHRydWUsXG4gICAgICAgIHN1Ym1pdHRlZEF0OiBtb21lbnQoKS5sb2NhbCgpLmZvcm1hdCgnWVlZWS1NTS1ERCBISDptbTpzcycpLFxuICAgICAgICBvbkNsb3VkOiBBcHBDb25maWcuQ0xPVURfU0VSVkVSLFxuICAgICAgICBzY29yZSxcbiAgICAgICAgdGltZUZpbmlzaCxcbiAgICAgICAgZXhlcmNpc2VEZXRhaWxcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0RXhlcmNpc2VTdGFycyAodXNlcklkLCBpZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBcblNFTEVDVCBzY29yZSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSAxIEFORCB0b3BpY0lkID0gJHtpZH0gQU5EIHVzZXJJZCA9ICR7dXNlcklkfVxuT1JERVIgQlkgc2NvcmUgREVTQyBMSU1JVCA0O2AsXG4gICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihkYXRhcyA9PiB7XG4gICAgICBjb25zdCBzdGFycyA9IGRhdGFzLnJlZHVjZSgoYWNjLCBkYXRhKSA9PiB7XG4gICAgICAgIGlmIChwYXJzZUludChkYXRhLnNjb3JlLCAxMCkgPj0gODApIHtcbiAgICAgICAgICByZXR1cm4gYWNjICsgMVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBhY2NcbiAgICAgICAgfVxuICAgICAgfSwgMClcbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBzdGFycyB9IH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UmVuZGVyZWRFeGVyY2lzZVN0YXJzICh1c2VySWQsIGlkLCByZW5kZXJTdGFyID0gdHJ1ZSkge1xuICAgIHJldHVybiB0aGlzLmdldEV4ZXJjaXNlU3RhcnModXNlcklkLCBpZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICBjb25zdCBzdGFycyA9IHJlc3AuZGF0YS5zdGFyc1xuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvc3RhcnMucHVnJyksIHsgc3RhcnMgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGh0bWwsIHN0YXJzIH0gfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3BcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0VG9waWNFeGVyY2lzZUNoZWNrbWFyayAodXNlcklkLCB0b3BpY0lkLCByZW5kZXIgPSBmYWxzZSkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KGBcblNFTEVDVCBzY29yZSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSAxIEFORCB0b3BpY0lkID0gJHt0b3BpY0lkfSBBTkQgdXNlcklkID0gJHt1c2VySWR9IEFORCBzY29yZSA+IDgwXG5PUkRFUiBCWSBzY29yZSBERVNDIExJTUlUIDE7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKGRhdGFzID0+IHtcbiAgICAgIGNvbnN0IGlzQ2hlY2tlZCA9IGRhdGFzLmxlbmd0aCA+IDBcbiAgICAgIGlmIChyZW5kZXIpIHtcbiAgICAgICAgY29uc3QgaHRtbCA9IHB1Zy5yZW5kZXJGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAvdmlld3Mvbm9uLXBhZ2VzL2NlY2ttYXJrLnB1ZycpLCB7IGlzQ2hlY2tlZCB9KVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGh0bWwgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGlzQ2hlY2tlZCB9IH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0RXhlcmNpc2VUaW1lcnMgKHVzZXJJZCwgaWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShgXG5TRUxFQ1Qgc2NvcmUgRlJPTSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlc1xuV0hFUkUgc3VibWl0dGVkID0gMSBBTkQgdG9waWNJZCA9ICR7aWR9IEFORCB1c2VySWQgPSAke3VzZXJJZH1cbkFORCB0aW1lRmluaXNoIDwgaWRlYWxUaW1lIEFORCBzY29yZSA9IDEwMFxuT1JERVIgQlkgc2NvcmUgREVTQyBMSU1JVCAxO2AsXG4gICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihkYXRhcyA9PiB7XG4gICAgICBjb25zdCB0aW1lcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgZGF0YSkgPT4ge1xuICAgICAgICBpZiAocGFyc2VJbnQoZGF0YS5zY29yZSwgMTApID49IDgwKSB7XG4gICAgICAgICAgcmV0dXJuIGFjYyArIDFcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gYWNjXG4gICAgICAgIH1cbiAgICAgIH0sIDApXG5cbiAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyB0aW1lcnMgfSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFJlbmRlcmVkRXhlcmNpc2VUaW1lcnMgKHVzZXJJZCwgaWQsIHRhYmxlTmFtZSkge1xuICAgIHJldHVybiB0aGlzLmdldEV4ZXJjaXNlVGltZXJzKHVzZXJJZCwgaWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgY29uc3QgdGltZXJzID0gcmVzcC5kYXRhLnRpbWVyc1xuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvdGltZXJzLnB1ZycpLCB7IHRpbWVycyB9KVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IGh0bWwgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIChyZXNwKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAgIC8vIEdldCBsZWFkZXJib2FyZCBkYXRhXG4gIGdldEV4ZXJjaXNlUmFua2luZyAodG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldFNlcXVlbGl6ZSgpLnF1ZXJ5KFxuYFNFTEVDVCBNSU4odGltZUZpbmlzaCkgQVMgdGltZUZpbmlzaCwgdXNlcklkLCB1c2Vycy5mdWxsTmFtZSBBUyBmdWxsTmFtZSwgdXNlcnMuZ3JhZGUgQVMgZ3JhZGUsIHNjaG9vbHMubmFtZSBBUyBzY2hvb2xOYW1lXG5GUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzIElOTkVSIEpPSU4gdXNlcnMgT04gdXNlcnMuaWQgPSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlcy51c2VySWQgSU5ORVIgSk9JTiBzY2hvb2xzIE9OIHNjaG9vbHMuaWQgPSB1c2Vycy5zY2hvb2xJZFxuV0hFUkUgc3VibWl0dGVkID0gVFJVRSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMIEdST1VQIEJZIHVzZXJJZCBPUkRFUiBCWSBNSU4odGltZUZpbmlzaCkgTElNSVQgMTA7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0RXhlcmNpc2VMZWFkZXJib2FyZCAodG9waWNJZCkge1xuICAgIHJldHVybiB0aGlzLmdldEV4ZXJjaXNlUmFua2luZyh0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IGV4ZXJjaXNlRGF0YSA9IHJlc3AuZGF0YVxuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvcmFua2luZy5wdWcnKSwgeyBleGVyY2lzZURhdGEgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBodG1sIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEdldCB0aGUgbnVtYmVyIG9mIHJhbmsgaW4gbGVhZGVyYm9hcmRcbiAgZ2V0Q3VycmVudFJhbmtpbmcgKHRpbWVGaW5pc2gsIHRvcGljSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnlEQiA9IGBTRUxFQ1QgQ09VTlQoKikgQVMgdG90YWxcbkZST00gKFNFTEVDVCBDT1VOVCgqKSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSBUUlVFIEFORCB0aW1lRmluaXNoIDwgJHt0aW1lRmluaXNofSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMXG5HUk9VUCBCWSB1c2VySWRcbk9SREVSIEJZIE1JTih0aW1lRmluaXNoKSkgQVMgdG90YWxyb3c7YFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnlEQixcbiAgICAgICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGNvdW50OiByZXNwWzBdLnRvdGFsIH0gfSlcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9KVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgdGhlIG51bWJlciBvZiBzdWJtaXNzaW9ucyBpbiB0aGUgbGVhZGVyYm9hcmRcbiAgZ2V0VG90YWxSYW5raW5nIChpZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgcXVlcnlEQiA9IGBTRUxFQ1QgQ09VTlQoKikgQVMgdG90YWxcbkZST00gKFNFTEVDVCBDT1VOVCgqKSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzIFdIRVJFIHN1Ym1pdHRlZCA9IFRSVUUgQU5EIHRvcGljSWQgPSAke2lkfSBBTkQgc2NvcmUgPSAxMDAgQU5EIHRpbWVGaW5pc2ggSVMgTk9UIE5VTExcbkdST1VQIEJZIHVzZXJJZFxuT1JERVIgQlkgTUlOKHRpbWVGaW5pc2gpKSBBUyB0b3RhbHJvdztgXG4gICAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShxdWVyeURCLFxuICAgICAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgIHJlc29sdmUoeyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgY291bnQ6IHJlc3BbMF0udG90YWwgfSB9KVxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgVG9waWNFeGVyY2lzZVNlcnZpY2UoKVxuIl19
