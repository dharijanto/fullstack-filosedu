"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Promise=require("bluebird"),crud_service_neo_1=require("./crud-service-neo"),exercise_generator_1=require("../lib/exercise_generator/exercise-generator"),exercise_service_1=require("./exercise-service");let path=require("path"),log=require("npmlog"),pug=require("pug"),moment=require("moment"),Sequelize=require("sequelize");const AppConfig=require(path.join(__dirname,"../app-config")),Utils=require(path.join(__dirname,"../lib/utils")),TAG="TopicExerciseService";class TopicExerciseService extends crud_service_neo_1.default{getTopic(e){return this.readOne({modelName:"Topic",searchClause:{id:e}})}getFormattedExercise(e,t){return e&&t?Promise.join(this.getExercises(e),this.getGeneratedTopicExercise(t,e),this.getExercisesHash(e),this.getTopic(e)).spread((r,s,i,a)=>{if(i.status&&a.status){const a=i.data;if(s.status&&s.data&&s.data.topicExerciseHash===a)return this.formatGeneratedTopicExercise(s.data);if(r.status&&r.data&&(s.status&&s.data&&s.data.topicExerciseHash!==a||!s.status))return this.generateAndSaveExercise(e,t,r.data).then(e=>e.status&&e.data?this.formatGeneratedTopicExercise(e.data):{status:!1,errMessage:e.errMessage});throw new Error("Unexpected error!")}throw new Error(`Failed to retrieve topic or topicExerciseHash: ${i.errMessage||a.errMessage}`)}):Promise.resolve({status:!1,errMessage:"topicId and userId are required!"})}getExercises(e){return this.getSequelize().query(`\nSELECT exercises.id, exercises.data, exercises.createdAt, exercises.updatedAt, exercises.subtopicId\nFROM exercises AS exercises\nINNER JOIN subtopics AS subtopic ON exercises.subtopicId = subtopic.id AND subtopic.topicId = ${e}\nORDER BY subtopic.subtopicNo ASC, exercises.id ASC;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getExercisesHash(e){return this.getExercises(e).then(e=>{if(e.status&&e.data){const t=e.data.reduce((e,t)=>e+exercise_generator_1.default.getHash(t),"");return{status:!0,data:exercise_generator_1.default.getHash(t)}}return{status:!1,errMessage:e.errMessage}})}generateAndSaveExercise(e,t,r){return this.getExercisesHash(e).then(s=>{if(s.status&&s.data){const i=s.data;return Promise.map(r,e=>exercise_service_1.default.generateExercise(e,!0).then(e=>{if(e.status&&e.data){return JSON.parse(e.data.knowns||"[]").length>0?e.data:null}return null})).then(r=>{const s=[];let a=0;return r.filter(function(e){return null!=e}).forEach(e=>{a+=e.idealTime||0,s.push(e)}),this.getModels("GeneratedTopicExercise").destroy({where:{topicId:e,userId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}}).then(()=>this.create({modelName:"GeneratedTopicExercise",data:{topicId:e,userId:t,exerciseDetail:JSON.stringify(s),topicExerciseHash:i,idealTime:a,onCloud:AppConfig.CLOUD_SERVER}}))})}return{status:!1,errMessage:"Failed to retrieve exercise hash!"}})}formatGeneratedTopicExercise(e){const t=e.topicId,r=JSON.parse(e.exerciseDetail);return Promise.map(r,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){let r=exercise_generator_1.default.getExerciseSolver(t.data.data),s=[],i=[];return JSON.parse(e.knowns).forEach(e=>{i.push(r.formatQuestion(e))}),JSON.parse(e.unknowns).forEach(e=>{s.push(Object.keys(e))}),Promise.all(i).then(e=>({renderedQuestions:e,unknowns:s}))}throw new Error(t.errMessage)})).then(r=>this.readOne({modelName:"Topic",searchClause:{id:t}}).then(t=>t.status&&t.data?{status:!0,data:{topicName:t.data.topic,formattedExercises:r,idealTime:e.idealTime,elapsedTime:Utils.getElapsedTime(e.createdAt)}}:{status:!1,errMessage:""}))}gradeExercise(e,t){return Promise.map(e,e=>this.readOne({modelName:"Exercise",searchClause:{id:e.exerciseId}}).then(t=>{if(t.status&&t.data){const r=t.data,s=exercise_generator_1.default.getExerciseSolver(r.data),i=JSON.parse(e.knowns),a=JSON.parse(e.unknowns);return i.map((e,t)=>({known:e,correctAnswer:a[t],isAnswerFn:s.isAnswer.bind(s)}))}throw new Error("Exercise with id="+e.exerciseId+" could not be found!")})).then(e=>e.reduce((e,t)=>e.concat(t),[]).reduce((e,t)=>e.concat(t),[])).then(e=>{const{numCorrectAnswers:r,correctAnswers:s,isCorrect:i}=e.reduce((e,r,s)=>{const i=r.isAnswerFn(r.known,t[s]);return e.numCorrectAnswers+=i?1:0,e.correctAnswers.push(r.correctAnswer),e.isCorrect.push(i),e},{numCorrectAnswers:0,correctAnswers:[],isCorrect:[]}),a=e.length;return{status:!0,data:{numQuestions:a,numCorrectAnswers:r,correctAnswers:s,isCorrect:i,score:parseFloat(r)/a*100}}})}finishExercise(e,t,r,s,i){let a=0;const n=JSON.stringify(s.map(e=>{console.dir(e);const t=[];return JSON.parse(e.knowns).forEach(e=>{t.push(i[a]),a++}),e.userAnswer=JSON.stringify(t),e}));return this.update({modelName:"GeneratedTopicExercise",data:{id:e,submitted:!0,submittedAt:moment().local().format("YYYY-MM-DD HH:mm:ss"),onCloud:AppConfig.CLOUD_SERVER,score:t,timeFinish:r,exerciseDetail:n}})}getGeneratedTopicExercise(e,t){return this.readOne({modelName:"GeneratedTopicExercise",searchClause:{userId:e,topicId:t,submitted:!1,onCloud:AppConfig.CLOUD_SERVER}})}getStarBadges(e,t){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e}\nORDER BY score DESC LIMIT 4;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{stars:e.reduce((e,t)=>parseInt(t.score,10)>=80?e+1:e,0)}}})}getRenderedStarBadges(e,t){return this.getStarBadges(e,t).then(e=>{if(e.status){const t=e.data.stars;return{status:!0,data:{html:pug.renderFile(path.join(__dirname,"../app/views/non-pages/stars.pug"),{stars:t}),stars:t}}}return e})}getCheckmarkBadge(e,t,r=!1){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e} AND score > 80\nORDER BY score DESC LIMIT 1;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{const t=e.length>0;if(r){return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ceckmark.pug"),{isChecked:t})}}return{status:!0,data:{isChecked:t}}})}getTimerBadges(e,t){return this.getSequelize().query(`\nSELECT score FROM generatedTopicExercises\nWHERE submitted = 1 AND topicId = ${t} AND userId = ${e}\nAND timeFinish < idealTime AND score = 100\nORDER BY score DESC LIMIT 1;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>{return{status:!0,data:{timers:e.reduce((e,t)=>parseInt(t.score,10)>=80?e+1:e,0)}}})}getRenderedTimerBadges(e,t){return this.getTimerBadges(e,t).then(e=>{if(e.status){const t=e.data.timers;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/timers.pug"),{timers:t})}}return e})}getRanking(e){return this.getSequelize().query(`SELECT MIN(timeFinish) AS timeFinish, userId, users.fullName AS fullName, users.grade AS grade, schools.name AS schoolName\nFROM generatedTopicExercises INNER JOIN users ON users.id = generatedTopicExercises.userId INNER JOIN schools ON schools.id = users.schoolId\nWHERE submitted = TRUE AND topicId = ${e} AND score = 100 AND timeFinish IS NOT NULL GROUP BY userId ORDER BY MIN(timeFinish) LIMIT 10;`,{type:Sequelize.QueryTypes.SELECT}).then(e=>({status:!0,data:e}))}getRenderedLeaderboard(e){return this.getRanking(e).then(e=>{if(e.status){const t=e.data;return{status:!0,data:pug.renderFile(path.join(__dirname,"../app/views/non-pages/ranking.pug"),{exerciseData:t})}}return e})}getCurrentRanking(e,t){return new Promise((r,s)=>{const i=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedTopicExercises\nWHERE submitted = TRUE AND timeFinish < ${e} AND topicId = ${t} AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(i,{type:Sequelize.QueryTypes.SELECT}).then(e=>{r({status:!0,data:{count:e[0].total}})}).catch(e=>{s(e)})})}getTotalRanking(e){return new Promise((t,r)=>{let s=`SELECT COUNT(*) AS total\nFROM (SELECT COUNT(*) FROM generatedTopicExercises WHERE submitted = TRUE AND topicId = ${e} AND score = 100 AND timeFinish IS NOT NULL\nGROUP BY userId\nORDER BY MIN(timeFinish)) AS totalrow;`;return this.getSequelize().query(s,{type:Sequelize.QueryTypes.SELECT}).then(e=>{t({status:!0,data:{count:e[0].total}})}).catch(e=>{r(e)})})}}exports.default=new TopicExerciseService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy90b3BpYy1leGVyY2lzZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwiY3J1ZF9zZXJ2aWNlX25lb18xIiwiZXhlcmNpc2VfZ2VuZXJhdG9yXzEiLCJleGVyY2lzZV9zZXJ2aWNlXzEiLCJwYXRoIiwibG9nIiwicHVnIiwibW9tZW50IiwiU2VxdWVsaXplIiwiQXBwQ29uZmlnIiwiam9pbiIsIl9fZGlybmFtZSIsIlV0aWxzIiwiVEFHIiwiVG9waWNFeGVyY2lzZVNlcnZpY2UiLCJkZWZhdWx0IiwiW29iamVjdCBPYmplY3RdIiwidG9waWNJZCIsInRoaXMiLCJyZWFkT25lIiwibW9kZWxOYW1lIiwic2VhcmNoQ2xhdXNlIiwiaWQiLCJ1c2VySWQiLCJnZXRFeGVyY2lzZXMiLCJnZXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIiwiZ2V0RXhlcmNpc2VzSGFzaCIsImdldFRvcGljIiwic3ByZWFkIiwicmVzcCIsInJlc3AyIiwicmVzcDMiLCJyZXNwNCIsInN0YXR1cyIsInRvcGljRXhlcmNpc2VIYXNoIiwiZGF0YSIsImZvcm1hdEdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZUFuZFNhdmVFeGVyY2lzZSIsInRoZW4iLCJyZXNwNSIsImVyck1lc3NhZ2UiLCJFcnJvciIsInJlc29sdmUiLCJnZXRTZXF1ZWxpemUiLCJxdWVyeSIsInR5cGUiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwiY29tYmluZWRIYXNoIiwicmVkdWNlIiwiYWNjIiwiaGFzaCIsImdldEhhc2giLCJleGVyY2lzZXMiLCJtYXAiLCJleGVyY2lzZSIsImdlbmVyYXRlRXhlcmNpc2UiLCJKU09OIiwicGFyc2UiLCJrbm93bnMiLCJsZW5ndGgiLCJyZXN1bHRzIiwiZXhlcmNpc2VEZXRhaWwiLCJpZGVhbFRpbWUiLCJmaWx0ZXIiLCJ2YWx1ZSIsImZvckVhY2giLCJyZXN1bHQiLCJwdXNoIiwiZ2V0TW9kZWxzIiwiZGVzdHJveSIsIndoZXJlIiwic3VibWl0dGVkIiwib25DbG91ZCIsIkNMT1VEX1NFUlZFUiIsImNyZWF0ZSIsInN0cmluZ2lmeSIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2UiLCJnZW5lcmF0ZWRFeGVyY2lzZXMiLCJnZW5lcmF0ZWRFeGVyY2lzZSIsImV4ZXJjaXNlSWQiLCJleGVyY2lzZVNvbHZlciIsImdldEV4ZXJjaXNlU29sdmVyIiwidW5rbm93bnMiLCJmb3JtYXR0ZWRRdWVzdGlvbnNQcm9taXNlcyIsImZvcm1hdFF1ZXN0aW9uIiwiX3Vua25vd25zIiwiT2JqZWN0Iiwia2V5cyIsImFsbCIsInJlbmRlcmVkUXVlc3Rpb25zIiwiZm9ybWF0dGVkRXhlcmNpc2VzIiwidG9waWNOYW1lIiwidG9waWMiLCJlbGFwc2VkVGltZSIsImdldEVsYXBzZWRUaW1lIiwiY3JlYXRlZEF0IiwiZ2VuZXJhdGVkRXhlcmNpc2VEZXRhaWxzIiwiYW5zd2VycyIsImtub3duIiwiaW5kZXgiLCJjb3JyZWN0QW5zd2VyIiwiaXNBbnN3ZXJGbiIsImlzQW5zd2VyIiwiYmluZCIsInRvcGljRXhlcmNpc2VBcnJheSIsImV4ZXJjaXNlQXJyYXkiLCJjb25jYXQiLCJxdWVzdGlvbkFycmF5IiwibnVtQ29ycmVjdEFuc3dlcnMiLCJjb3JyZWN0QW5zd2VycyIsImlzQ29ycmVjdCIsIm51bVF1ZXN0aW9ucyIsInNjb3JlIiwicGFyc2VGbG9hdCIsImdlbmVyYXRlZFRvcGljRXhlcmNpc2VJZCIsInRpbWVGaW5pc2giLCJleGVyY2lzZURldGFpbHMiLCJhbnN3ZXJJbmRleCIsImNvbnNvbGUiLCJkaXIiLCJleGVyY2lzZURldGFpbEFuc3dlcnMiLCJfIiwidXNlckFuc3dlciIsInVwZGF0ZSIsInN1Ym1pdHRlZEF0IiwibG9jYWwiLCJmb3JtYXQiLCJkYXRhcyIsInN0YXJzIiwicGFyc2VJbnQiLCJnZXRTdGFyQmFkZ2VzIiwiaHRtbCIsInJlbmRlckZpbGUiLCJyZW5kZXIiLCJpc0NoZWNrZWQiLCJ0aW1lcnMiLCJnZXRUaW1lckJhZGdlcyIsImdldFJhbmtpbmciLCJleGVyY2lzZURhdGEiLCJyZWplY3QiLCJxdWVyeURCIiwiY291bnQiLCJ0b3RhbCIsImNhdGNoIiwiZXJyIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Im9FQUFBLE1BQUFBLFFBQUFDLFFBQUEsWUFFQUMsbUJBQUFELFFBQUEsc0JBQ0FFLHFCQUFBRixRQUFBLGdEQUNBRyxtQkFBQUgsUUFBQSxzQkFFQSxJQUFJSSxLQUFPSixRQUFRLFFBRWZLLElBQU1MLFFBQVEsVUFDZE0sSUFBTU4sUUFBUSxPQUNkTyxPQUFTUCxRQUFRLFVBQ2pCUSxVQUFZUixRQUFRLGFBRXhCLE1BQU1TLFVBQVlULFFBQVFJLEtBQUtNLEtBQUtDLFVBQVcsa0JBQ3pDQyxNQUFRWixRQUFRSSxLQUFLTSxLQUFLQyxVQUFXLGlCQUVyQ0UsSUFBTSw2QkFvQlpDLDZCQUFtQ2IsbUJBQUFjLFFBRXpCQyxTQUFVQyxHQUNoQixPQUFPQyxLQUFLQyxTQUFpQkMsVUFBVyxRQUFTQyxjQUFnQkMsR0FBSUwsS0FLdkVELHFCQUFzQkMsRUFBU00sR0FDN0IsT0FBSU4sR0FBV00sRUFDTnhCLFFBQVFXLEtBQ2JRLEtBQUtNLGFBQWFQLEdBQ2xCQyxLQUFLTywwQkFBMEJGLEVBQVFOLEdBQ3ZDQyxLQUFLUSxpQkFBaUJULEdBQ3RCQyxLQUFLUyxTQUFTVixJQUNkVyxPQUFPLENBQUNDLEVBQThCQyxFQUM5QkMsRUFBMkJDLEtBQ25DLEdBQUlELEVBQU1FLFFBQVVELEVBQU1DLE9BQVEsQ0FDaEMsTUFBTUMsRUFBb0JILEVBQU1JLEtBRWhDLEdBQUlMLEVBQU1HLFFBQVVILEVBQU1LLE1BQVFMLEVBQU1LLEtBQUtELG9CQUFzQkEsRUFDakUsT0FBT2hCLEtBQUtrQiw2QkFBNkJOLEVBQU1LLE1BRTFDLEdBQUlOLEVBQUtJLFFBQVVKLEVBQUtNLE9BQ25CTCxFQUFNRyxRQUFVSCxFQUFNSyxNQUFRTCxFQUFNSyxLQUFLRCxvQkFBc0JBLElBQ2hFSixFQUFNRyxRQUNmLE9BQU9mLEtBQUttQix3QkFBd0JwQixF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QixlQUFlQyxNQUFNaUcsR0FDN0JoRyxLQUFNckMsVUFBVXNDLFdBQVdDLFNBQVVULEtBQUtULElBQzFDYSxHQUFVVCxRQUFRLEVBQU1FLE1BQVEyRyxNQUFPakgsRUFBSyxHQUFHa0gsV0FDOUNDLE1BQU1DLElBQ1BMLEVBQU9LLFFBTWpCQyxRQUFBbkksUUFBZSxJQUFJRCIsImZpbGUiOiJzZXJ2aWNlcy90b3BpYy1leGVyY2lzZS1zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBCcnV0ZWZvcmNlU29sdmVyLCB7IEdlbmVyYXRlZFF1ZXN0aW9uRGF0YSB9IGZyb20gJy4uL2xpYi9leGVyY2lzZV9nZW5lcmF0b3IvZXhlcmNpc2Vfc29sdmVycy9icnV0ZWZvcmNlLXNvbHZlcidcbmltcG9ydCBDUlVEU2VydmljZSBmcm9tICcuL2NydWQtc2VydmljZS1uZW8nXG5pbXBvcnQgRXhlcmNpc2VHZW5lcmF0b3IgZnJvbSAnLi4vbGliL2V4ZXJjaXNlX2dlbmVyYXRvci9leGVyY2lzZS1nZW5lcmF0b3InXG5pbXBvcnQgRXhlcmNpc2VTZXJ2aWNlIGZyb20gJy4vZXhlcmNpc2Utc2VydmljZSdcblxubGV0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxubGV0IGxvZyA9IHJlcXVpcmUoJ25wbWxvZycpXG5sZXQgcHVnID0gcmVxdWlyZSgncHVnJylcbmxldCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKVxubGV0IFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpXG5cbmNvbnN0IEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC1jb25maWcnKSlcbmNvbnN0IFV0aWxzID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbGliL3V0aWxzJykpXG5cbmNvbnN0IFRBRyA9ICdUb3BpY0V4ZXJjaXNlU2VydmljZSdcblxuZXhwb3J0IGludGVyZmFjZSBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlRGV0YWlsIHtcbiAga25vd25zOiBzdHJpbmcsIC8vIHN0cmluZ2lmaWVkIEpTT05cbiAgdW5rbm93bnM6IHN0cmluZywgLy8gc3RyaW5naWZpZWQgSlNPTlxuICB1c2VyQW5zd2VyOiBzdHJpbmcsIC8vIHN0cmluZ2lmaWVkIEpTT05cbiAgZXhlcmNpc2VIYXNoOiBzdHJpbmdcbiAgZXhlcmNpc2VJZDogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9waWNFeGVyY2lzZUdyYWRlIHtcbiAgbnVtUXVlc3Rpb25zOiBudW1iZXJcbiAgbnVtQ29ycmVjdEFuc3dlcnM6IG51bWJlclxuICBjb3JyZWN0QW5zd2VyczogQXJyYXk8e1trZXk6IHN0cmluZ106IGFueX0+XG4gIGlzQ29ycmVjdDogQXJyYXk8Ym9vbGVhbj5cbiAgc2NvcmU6IG51bWJlclxufVxuXG5leHBvcnQgdHlwZSBUb3BpY0V4ZXJjaXNlQW5zd2VyID0gQXJyYXk8e1trZXk6IHN0cmluZ106IGFueX0+XG5cbmNsYXNzIFRvcGljRXhlcmNpc2VTZXJ2aWNlIGV4dGVuZHMgQ1JVRFNlcnZpY2Uge1xuICAvLyBUT0RPOiBXZSBzaG91bGQgdXNlIHZlcnNpb24gb24gY291cnNlU2VydmljZSBpbnN0ZWFkIG9mIHRoaXNcbiAgcHJpdmF0ZSBnZXRUb3BpYyAodG9waWNJZCk6IFByb21pc2U8TkNSZXNwb25zZTxUb3BpYz4+IHtcbiAgICByZXR1cm4gdGhpcy5yZWFkT25lPFRvcGljPih7IG1vZGVsTmFtZTogJ1RvcGljJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiB0b3BpY0lkIH0gfSlcbiAgfVxuXG4gIC8vIEdldCBhIEdlbmVyYXRlZFRvcGljRXhlcmNpc2UgaW4gYSBmb3JtYXQgcmVhZHkgZm9yIHVzZS4gSWYgdGhlcmUncyBwcmV2aW91c2x5IGdlbmVyYXRlZFxuICAvLyB0aGF0IGhhc24ndCBiZWVuIHN1Ym1pdHRlZCwgdGhpcyB3aWxsIHJlc3RvcmUgaXQuIE90aGVyd2lzZSwgaXQnbGwgZ2VuZXJhdGUgb25lLlxuICBnZXRGb3JtYXR0ZWRFeGVyY2lzZSAodG9waWNJZCwgdXNlcklkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEZvcm1hdHRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgaWYgKHRvcGljSWQgJiYgdXNlcklkKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5qb2luPGFueT4oXG4gICAgICAgIHRoaXMuZ2V0RXhlcmNpc2VzKHRvcGljSWQpLFxuICAgICAgICB0aGlzLmdldEdlbmVyYXRlZFRvcGljRXhlcmNpc2UodXNlcklkLCB0b3BpY0lkKSxcbiAgICAgICAgdGhpcy5nZXRFeGVyY2lzZXNIYXNoKHRvcGljSWQpLFxuICAgICAgICB0aGlzLmdldFRvcGljKHRvcGljSWQpXG4gICAgICApLnNwcmVhZCgocmVzcDogTkNSZXNwb25zZTxFeGVyY2lzZVtdPiwgcmVzcDI6IE5DUmVzcG9uc2U8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4sXG4gICAgICAgICAgICAgICAgcmVzcDM6IE5DUmVzcG9uc2U8c3RyaW5nPiwgcmVzcDQ6IE5DUmVzcG9uc2U8VG9waWM+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwMy5zdGF0dXMgJiYgcmVzcDQuc3RhdHVzKSB7XG4gICAgICAgICAgY29uc3QgdG9waWNFeGVyY2lzZUhhc2ggPSByZXNwMy5kYXRhXG4gICAgICAgICAgLy8gSWYgdGhlcmUncyB2YWxpZCBleGVyY2lzZSB0byBiZSByZXN0b3JlZFxuICAgICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJiByZXNwMi5kYXRhLnRvcGljRXhlcmNpc2VIYXNoID09PSB0b3BpY0V4ZXJjaXNlSGFzaCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0R2VuZXJhdGVkVG9waWNFeGVyY2lzZShyZXNwMi5kYXRhKVxuICAgICAgICAgIC8vIElmIHRoZXJlJ3MgZXhwaXJlZCBnZW5lcmF0ZWQgZXhlcmNpc2Ugb3Igbm8gZ2VuZXJhdGVkIGV4ZXJjaXNlIHRvIGJlIHJlc3RvcmVkXG4gICAgICAgICAgfSBlbHNlIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEgJiZcbiAgICAgICAgICAgICAgICAgICAgKChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSAmJiByZXNwMi5kYXRhLnRvcGljRXhlcmNpc2VIYXNoICE9PSB0b3BpY0V4ZXJjaXNlSGFzaCkgfHxcbiAgICAgICAgICAgICAgICAgICAgIXJlc3AyLnN0YXR1cykpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdlbmVyYXRlQW5kU2F2ZUV4ZXJjaXNlKHRvcGljSWQsIHVzZXJJZCwgcmVzcC5kYXRhKS50aGVuKHJlc3A1ID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3A1LnN0YXR1cyAmJiByZXNwNS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0R2VuZXJhdGVkVG9waWNFeGVyY2lzZShyZXNwNS5kYXRhKVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3A1LmVyck1lc3NhZ2UgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBXZSBzaG91bGQgbmV2ZXIgZ2V0IGhlcmUuLlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIGVycm9yIScpXG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHJldHJpZXZlIHRvcGljIG9yIHRvcGljRXhlcmNpc2VIYXNoOiAke3Jlc3AzLmVyck1lc3NhZ2UgfHwgcmVzcDQuZXJyTWVzc2FnZX1gKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgc3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ3RvcGljSWQgYW5kIHVzZXJJZCBhcmUgcmVxdWlyZWQhJyB9KVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RXhlcmNpc2VzICh0b3BpY0lkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEV4ZXJjaXNlW10+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFxuU0VMRUNUIGV4ZXJjaXNlcy5pZCwgZXhlcmNpc2VzLmRhdGEsIGV4ZXJjaXNlcy5jcmVhdGVkQXQsIGV4ZXJjaXNlcy51cGRhdGVkQXQsIGV4ZXJjaXNlcy5zdWJ0b3BpY0lkXG5GUk9NIGV4ZXJjaXNlcyBBUyBleGVyY2lzZXNcbklOTkVSIEpPSU4gc3VidG9waWNzIEFTIHN1YnRvcGljIE9OIGV4ZXJjaXNlcy5zdWJ0b3BpY0lkID0gc3VidG9waWMuaWQgQU5EIHN1YnRvcGljLnRvcGljSWQgPSAke3RvcGljSWR9XG5PUkRFUiBCWSBzdWJ0b3BpYy5zdWJ0b3BpY05vIEFTQywgZXhlcmNpc2VzLmlkIEFTQztgLCB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9XG4gICAgKS50aGVuKHJlc3AgPT4ge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiByZXNwIH1cbiAgICB9KVxuICB9XG5cbiAgLy8gR2l2ZW4gdG9waWNJZCwgY29tcHV0ZXMgaGFzaCB2YWx1ZSBvZiB0aGUgYXNzb2NpYXRlZCBUb3BpY0V4ZXJjaXNlLlxuICAvLyBUaGUgaGFzaCBpcyBjb21wdXRlZCBmcm9tIGVhY2ggb2YgdGhlIGJ1aWxkaW5nIHN1YnRvcGljIEV4ZXJjaXNlcy5cbiAgLy8gSW4gb3RoZXIgd29yZHMsIGlmIGFueSBzdWJ0b3BpYyBFeGVyY2lzZSBjaGFuZ2VzLCBoYXNoIGZvciByZXNwZWN0aXZlXG4gIC8vIFRvcGljRXhlcmNpc2UgdGhhdCBkZXBlbmRzIG9uIGl0IGFsc28gY2hhbmdlcy5cbiAgcHJpdmF0ZSBnZXRFeGVyY2lzZXNIYXNoICh0b3BpY0lkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPHN0cmluZz4+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRFeGVyY2lzZXModG9waWNJZCkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgY29uc3QgY29tYmluZWRIYXNoID0gcmVzcC5kYXRhLnJlZHVjZSgoYWNjLCBoYXNoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGFjYyArIEV4ZXJjaXNlR2VuZXJhdG9yLmdldEhhc2goaGFzaClcbiAgICAgICAgfSwgJycpXG4gICAgICAgIGxldCB0b3BpY0V4ZXJjaXNlSGFzaCA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEhhc2goY29tYmluZWRIYXNoKVxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHRvcGljRXhlcmNpc2VIYXNoIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6IHJlc3AuZXJyTWVzc2FnZSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVBbmRTYXZlRXhlcmNpc2UgKHRvcGljSWQsIHVzZXJJZCwgZXhlcmNpc2VzOiBFeGVyY2lzZVtdKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RXhlcmNpc2VzSGFzaCh0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICBjb25zdCB0b3BpY0V4ZXJjaXNlSGFzaCA9IHJlc3AuZGF0YVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5tYXAoZXhlcmNpc2VzLCBleGVyY2lzZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIEV4ZXJjaXNlU2VydmljZS5nZW5lcmF0ZUV4ZXJjaXNlKGV4ZXJjaXNlLCB0cnVlKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgICAgICAvLyBDaGVjayB0aGlzIGhhcyBxdWVzdGlvbnNcbiAgICAgICAgICAgICAgY29uc3QgcGFyc2VkS25vd25zID0gSlNPTi5wYXJzZShyZXNwLmRhdGEua25vd25zIHx8ICdbXScpXG4gICAgICAgICAgICAgIGlmIChwYXJzZWRLbm93bnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwLmRhdGFcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBTa2lwIG92ZXIgZW1wdHkgcXVlc3Rpb25zXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9KS50aGVuKChyZXN1bHRzOiBBcnJheTxQYXJ0aWFsPEdlbmVyYXRlZEV4ZXJjaXNlIHwgbnVsbD4+KSA9PiB7XG4gICAgICAgICAgY29uc3QgZXhlcmNpc2VEZXRhaWw6IGFueVtdID0gW11cbiAgICAgICAgICBsZXQgaWRlYWxUaW1lID0gMFxuXG4gICAgICAgICAgLy8gTmVlZGVkIGZvciBUUyB0byB0eXBlY2hlY2tcbiAgICAgICAgICBmdW5jdGlvbiBub3RFbXB0eTxUVmFsdWU+ICh2YWx1ZTogVFZhbHVlIHwgbnVsbCB8IHVuZGVmaW5lZCk6IHZhbHVlIGlzIFRWYWx1ZSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJlc3VsdHMuZmlsdGVyKG5vdEVtcHR5KS5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZGVhbFRpbWUgKz0gcmVzdWx0LmlkZWFsVGltZSB8fCAwXG4gICAgICAgICAgICBleGVyY2lzZURldGFpbC5wdXNoKHJlc3VsdClcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgLy8gSW4gY2FzZSB0aGF0IHRoZSBleGVyY2lzZSBpcyBubyBsb25nZXIgdXAtdG8tZGF0ZSwgd2UgaGF2ZSB0byBkZWxldGUgc3RhbGUgZ2VuZXJhdGVkIGV4ZXJjaXNlXG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWxzKCdHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlJykuZGVzdHJveSh7d2hlcmU6IHtcbiAgICAgICAgICAgIHRvcGljSWQsXG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICBzdWJtaXR0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICAgIH19KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPih7XG4gICAgICAgICAgICAgIG1vZGVsTmFtZTogJ0dlbmVyYXRlZFRvcGljRXhlcmNpc2UnLFxuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgdG9waWNJZCxcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgZXhlcmNpc2VEZXRhaWw6IEpTT04uc3RyaW5naWZ5KGV4ZXJjaXNlRGV0YWlsKSxcbiAgICAgICAgICAgICAgICB0b3BpY0V4ZXJjaXNlSGFzaCxcbiAgICAgICAgICAgICAgICBpZGVhbFRpbWUsXG4gICAgICAgICAgICAgICAgb25DbG91ZDogQXBwQ29uZmlnLkNMT1VEX1NFUlZFUlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnRmFpbGVkIHRvIHJldHJpZXZlIGV4ZXJjaXNlIGhhc2ghJyB9XG4gICAgICB9XG4gICAgfSlcblxuICB9XG5cbiAgLy8gRm9ybWF0IEdlbmVyYXRlZFRvcGljRXhlcmNpc2UgZm9yIGNvbnRyb2xsZXIgdXNlcy5cbiAgcHJpdmF0ZSBmb3JtYXRHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIChnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlOiBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEZvcm1hdHRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgY29uc3QgdG9waWNJZCA9IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UudG9waWNJZFxuICAgIGNvbnN0IGdlbmVyYXRlZEV4ZXJjaXNlczogR2VuZXJhdGVkRXhlcmNpc2VbXSA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5leGVyY2lzZURldGFpbClcbiAgICByZXR1cm4gUHJvbWlzZS5tYXAoZ2VuZXJhdGVkRXhlcmNpc2VzLCBnZW5lcmF0ZWRFeGVyY2lzZSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5yZWFkT25lPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBnZW5lcmF0ZWRFeGVyY2lzZS5leGVyY2lzZUlkIH0gfSkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgIGlmIChyZXNwMi5zdGF0dXMgJiYgcmVzcDIuZGF0YSkge1xuICAgICAgICAgIGxldCBleGVyY2lzZVNvbHZlciA9IEV4ZXJjaXNlR2VuZXJhdG9yLmdldEV4ZXJjaXNlU29sdmVyKHJlc3AyLmRhdGEuZGF0YSlcbiAgICAgICAgICBsZXQgdW5rbm93bnM6IEFycmF5PHN0cmluZ1tdPiA9IFtdXG4gICAgICAgICAgbGV0IGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzOiBBcnJheTxQcm9taXNlPHN0cmluZz4+ID0gW11cbiAgICAgICAgICBKU09OLnBhcnNlKGdlbmVyYXRlZEV4ZXJjaXNlLmtub3ducykuZm9yRWFjaChrbm93bnMgPT4ge1xuICAgICAgICAgICAgZm9ybWF0dGVkUXVlc3Rpb25zUHJvbWlzZXMucHVzaChleGVyY2lzZVNvbHZlci5mb3JtYXRRdWVzdGlvbihrbm93bnMpKVxuICAgICAgICAgIH0pXG4gICAgICAgICAgSlNPTi5wYXJzZShnZW5lcmF0ZWRFeGVyY2lzZS51bmtub3ducykuZm9yRWFjaChfdW5rbm93bnMgPT4ge1xuICAgICAgICAgICAgdW5rbm93bnMucHVzaChPYmplY3Qua2V5cyhfdW5rbm93bnMpKVxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGZvcm1hdHRlZFF1ZXN0aW9uc1Byb21pc2VzKS50aGVuKHJlbmRlcmVkUXVlc3Rpb25zID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHJlbmRlcmVkUXVlc3Rpb25zLFxuICAgICAgICAgICAgICB1bmtub3duc1xuICAgICAgICAgICAgfSBhcyBGb3JtYXR0ZWRFeGVyY2lzZVxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3AyLmVyck1lc3NhZ2UpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSkudGhlbihmb3JtYXR0ZWRFeGVyY2lzZXMgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMucmVhZE9uZTxUb3BpYz4oeyBtb2RlbE5hbWU6ICdUb3BpYycsIHNlYXJjaENsYXVzZTogeyBpZDogdG9waWNJZCB9IH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIGlmIChyZXNwLnN0YXR1cyAmJiByZXNwLmRhdGEpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3RhdHVzOiB0cnVlLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICB0b3BpY05hbWU6IHJlc3AuZGF0YS50b3BpYyxcbiAgICAgICAgICAgICAgZm9ybWF0dGVkRXhlcmNpc2VzLFxuICAgICAgICAgICAgICBpZGVhbFRpbWU6IGdlbmVyYXRlZFRvcGljRXhlcmNpc2UuaWRlYWxUaW1lLFxuICAgICAgICAgICAgICBlbGFwc2VkVGltZTogVXRpbHMuZ2V0RWxhcHNlZFRpbWUoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZS5jcmVhdGVkQXQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7IHN0YXR1czogZmFsc2UsIGVyck1lc3NhZ2U6ICcnIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgLy8gR3JhZGUgYSBUb3BpY0V4ZXJjaXNlXG4gIGdyYWRlRXhlcmNpc2UgKGdlbmVyYXRlZEV4ZXJjaXNlRGV0YWlsczogR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbFtdLCBhbnN3ZXJzOiBUb3BpY0V4ZXJjaXNlQW5zd2VyKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPFRvcGljRXhlcmNpc2VHcmFkZT4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5tYXAoZ2VuZXJhdGVkRXhlcmNpc2VEZXRhaWxzLCBleGVyY2lzZURldGFpbCA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5yZWFkT25lPEV4ZXJjaXNlPih7IG1vZGVsTmFtZTogJ0V4ZXJjaXNlJywgc2VhcmNoQ2xhdXNlOiB7IGlkOiBleGVyY2lzZURldGFpbC5leGVyY2lzZUlkIH0gfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgaWYgKHJlc3Auc3RhdHVzICYmIHJlc3AuZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGV4ZXJjaXNlID0gcmVzcC5kYXRhXG4gICAgICAgICAgY29uc3QgZXhlcmNpc2VTb2x2ZXIgPSBFeGVyY2lzZUdlbmVyYXRvci5nZXRFeGVyY2lzZVNvbHZlcihleGVyY2lzZS5kYXRhKVxuICAgICAgICAgIGNvbnN0IGtub3ducyA9IEpTT04ucGFyc2UoZXhlcmNpc2VEZXRhaWwua25vd25zKVxuICAgICAgICAgIGNvbnN0IHVua25vd25zID0gSlNPTi5wYXJzZShleGVyY2lzZURldGFpbC51bmtub3ducylcbiAgICAgICAgICByZXR1cm4ga25vd25zLm1hcCgoa25vd24sIGluZGV4KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4geyBrbm93biwgY29ycmVjdEFuc3dlcjogdW5rbm93bnNbaW5kZXhdLCBpc0Fuc3dlckZuOiBleGVyY2lzZVNvbHZlci5pc0Fuc3dlci5iaW5kKGV4ZXJjaXNlU29sdmVyKSB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4ZXJjaXNlIHdpdGggaWQ9JyArIGV4ZXJjaXNlRGV0YWlsLmV4ZXJjaXNlSWQgKyAnIGNvdWxkIG5vdCBiZSBmb3VuZCEnKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pLnRoZW4odG9waWNFeGVyY2lzZUFycmF5ID0+IHtcbiAgICAgIC8vIE5vdywgd2UgaGF2ZSAzIGxldmVsIGFycmF5czpcbiAgICAgIC8vIDEgLT4gVG9waWMgRXhlcmNpc2UuIDIgLT4gRXhlcmNpc2UuIDMgLT4gUXVlc3Rpb25cbiAgICAgIC8vIEJ1dCBzaW5jZSB1c2VyQW5zd2VyIGlzIGEgMS1sZXZlbCBhcnJheSBvZiBxdWVzdGlvbiwgd2UgbmVlZCB0byBmbGF0dGVuIHdoYXQgd2UgaGF2ZSB0byBiZSBlYXNpbHkgdXNlZFxuICAgICAgcmV0dXJuIHRvcGljRXhlcmNpc2VBcnJheS5yZWR1Y2UoKGFjYywgZXhlcmNpc2VBcnJheSkgPT4ge1xuICAgICAgICByZXR1cm4gYWNjLmNvbmNhdChleGVyY2lzZUFycmF5KVxuICAgICAgfSwgW10pLnJlZHVjZSgoYWNjLCBxdWVzdGlvbkFycmF5KSA9PiB7XG4gICAgICAgIHJldHVybiBhY2MuY29uY2F0KHF1ZXN0aW9uQXJyYXkpXG4gICAgICB9LCBbXSlcbiAgICB9KS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgY29uc3QgeyBudW1Db3JyZWN0QW5zd2VycywgY29ycmVjdEFuc3dlcnMsIGlzQ29ycmVjdCB9ID0gcmVzdWx0cy5yZWR1Y2UoKGFjYywgcmVzdWx0LCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCBpc0NvcnJlY3QgPSByZXN1bHQuaXNBbnN3ZXJGbihyZXN1bHQua25vd24sIGFuc3dlcnNbaW5kZXhdKVxuICAgICAgICBhY2MubnVtQ29ycmVjdEFuc3dlcnMgKz0gaXNDb3JyZWN0ID8gMSA6IDBcbiAgICAgICAgYWNjLmNvcnJlY3RBbnN3ZXJzLnB1c2gocmVzdWx0LmNvcnJlY3RBbnN3ZXIpXG4gICAgICAgIGFjYy5pc0NvcnJlY3QucHVzaChpc0NvcnJlY3QpXG4gICAgICAgIHJldHVybiBhY2NcbiAgICAgIH0sIHsgbnVtQ29ycmVjdEFuc3dlcnM6IDAsIGNvcnJlY3RBbnN3ZXJzOiBbXSwgaXNDb3JyZWN0OiBbXSB9KVxuICAgICAgY29uc3QgbnVtUXVlc3Rpb25zID0gcmVzdWx0cy5sZW5ndGhcbiAgICAgIGNvbnN0IGdyYWRlOiBUb3BpY0V4ZXJjaXNlR3JhZGUgPSB7XG4gICAgICAgIG51bVF1ZXN0aW9ucyxcbiAgICAgICAgbnVtQ29ycmVjdEFuc3dlcnMsXG4gICAgICAgIGNvcnJlY3RBbnN3ZXJzLFxuICAgICAgICBpc0NvcnJlY3QsXG4gICAgICAgIHNjb3JlOiBwYXJzZUZsb2F0KG51bUNvcnJlY3RBbnN3ZXJzKSAvIG51bVF1ZXN0aW9ucyAqIDEwMFxuICAgICAgfVxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBncmFkZSB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIFVwZGF0ZSBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIGFzIHN1Ym1pdHRlZFxuICBmaW5pc2hFeGVyY2lzZSAoZ2VuZXJhdGVkVG9waWNFeGVyY2lzZUlkOiBudW1iZXIsIHNjb3JlOiBudW1iZXIsIHRpbWVGaW5pc2g6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgIGV4ZXJjaXNlRGV0YWlsczogR2VuZXJhdGVkVG9waWNFeGVyY2lzZURldGFpbFtdLCBhbnN3ZXJzOiBUb3BpY0V4ZXJjaXNlQW5zd2VyW10pOiBQcm9taXNlPE5DUmVzcG9uc2U8bnVtYmVyPj4ge1xuICAgIC8vIFRoaXMgaXMgYSBiaXQgYW5ub3lpbmcuLlxuICAgIC8vIFNvIGFuc3dlciBpcyB3aGF0IGEgc3R1ZGVudCB3b3VsZCBzdWJtaXQuIEl0J3MgYSBvbmUgZGltZW5zaW9uYWwgYXJyYXkgb2YgYW5zd2VycyBmb3IgZWFjaCBvZiB0aGUgZXhlcmNpc2VzXG4gICAgLy8gV2Ugd2FudCB0byBzYXZlIHVzZXIgYW5zd2VyIGludG8gZXhlcmNpc2VEZXRhaWwgc28gdGhhdCB3ZSBjYW4gZGVidWcgcHJvYmxlbXMuIChpLmUuIHdyb25nIHNjb3JpbmcpXG4gICAgLy8gSW4gb3JkZXIgdG8gbWFrZSBzdXJlIGVhY2ggYW5zd2VyIGdvZXMgdG8gY29ycmVjdCBleGVyY2lzZSBkZXRhaWwsIHdlIGhhdmUgd2luZCB0aGVtIHVwXG4gICAgLy8gaW4gdGhlIHNhbWUgb3JkZXIgd2hlbiB3ZSB1bndpbmQuIElmIHlvdSdyZSBjb25mdXNlZCBhYm91dCB0aGlzIGNvZGU6XG4gICAgLy8gMS4gVHJ5IHRvIGxvb2sgYXQgTXlTUUwgdGFibGUgc3RydWN0dXJlIGZvciBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlc1xuICAgIC8vIDIuIFJlbWVtYmVyIHRoYXQgZXhlcmNpc2VEZXRhaWwgdGhlcmUgaXMgc3RyaW5naWZpZWQgdmVyc2lvbiBvZiBlYWNoIG9mIGdlbmVyYXRlZEV4ZXJjaXNlcyB0aGF0IG1ha2VzIHVwXG4gICAgLy8gICAgYSB0b3BpYyBleGVyY2lzZS5cbiAgICBsZXQgYW5zd2VySW5kZXggPSAwXG4gICAgY29uc3QgZXhlcmNpc2VEZXRhaWwgPSBKU09OLnN0cmluZ2lmeShleGVyY2lzZURldGFpbHMubWFwKGV4ZXJjaXNlRGV0YWlsID0+IHtcbiAgICAgIGNvbnNvbGUuZGlyKGV4ZXJjaXNlRGV0YWlsKVxuICAgICAgY29uc3QgZXhlcmNpc2VEZXRhaWxBbnN3ZXJzOiBBcnJheTxhbnk+ID0gW11cbiAgICAgIEpTT04ucGFyc2UoZXhlcmNpc2VEZXRhaWwua25vd25zKS5mb3JFYWNoKF8gPT4ge1xuICAgICAgICBleGVyY2lzZURldGFpbEFuc3dlcnMucHVzaChhbnN3ZXJzW2Fuc3dlckluZGV4XSlcbiAgICAgICAgYW5zd2VySW5kZXgrK1xuICAgICAgfSlcbiAgICAgIGV4ZXJjaXNlRGV0YWlsLnVzZXJBbnN3ZXIgPSBKU09OLnN0cmluZ2lmeShleGVyY2lzZURldGFpbEFuc3dlcnMpXG4gICAgICByZXR1cm4gZXhlcmNpc2VEZXRhaWxcbiAgICB9KSlcbiAgICByZXR1cm4gdGhpcy51cGRhdGU8R2VuZXJhdGVkVG9waWNFeGVyY2lzZT4oe1xuICAgICAgbW9kZWxOYW1lOiAnR2VuZXJhdGVkVG9waWNFeGVyY2lzZScsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGlkOiBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlSWQsXG4gICAgICAgIHN1Ym1pdHRlZDogdHJ1ZSxcbiAgICAgICAgc3VibWl0dGVkQXQ6IG1vbWVudCgpLmxvY2FsKCkuZm9ybWF0KCdZWVlZLU1NLUREIEhIOm1tOnNzJyksXG4gICAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVIsXG4gICAgICAgIHNjb3JlLFxuICAgICAgICB0aW1lRmluaXNoLFxuICAgICAgICBleGVyY2lzZURldGFpbFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBXaGVuIHVzZXIgd2FudHMgdG8gZG8gVG9waWNFeGVyY2lzZSwgYSBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIG1ldGEgaW5mb3JtYXRpb24gaXMgY3JlYXRlZFxuICAvLyB0byBzdG9yZSBsb2NhbCBpbmZvcm1hdGlvbiBhYm91dCB0aGF0IHBhcnRpY3VsYXIgZXhlcmNpc2UgKGkuZS4gcmFuZG9tIHF1ZXN0aW9ucylcbiAgLy8gRm9yIGVhY2ggdXNlciwgdGhlcmUncyBleGFjdGx5IG9uZSBHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlIHdpdGggc3VibWl0dGVkID0gZmFsc2UgZm9yIGVhY2hcbiAgLy8gVG9waWNFeGVyY2lzZXNcbiAgZ2V0R2VuZXJhdGVkVG9waWNFeGVyY2lzZSAodXNlcklkLCB0b3BpY0lkKTogUHJvbWlzZTxOQ1Jlc3BvbnNlPEdlbmVyYXRlZFRvcGljRXhlcmNpc2U+PiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZE9uZTxHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlPih7XG4gICAgICBtb2RlbE5hbWU6ICdHZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlJyxcbiAgICAgIHNlYXJjaENsYXVzZToge1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHRvcGljSWQsXG4gICAgICAgIHN1Ym1pdHRlZDogZmFsc2UsXG4gICAgICAgIG9uQ2xvdWQ6IEFwcENvbmZpZy5DTE9VRF9TRVJWRVJcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0U3RhckJhZGdlcyAodXNlcklkLCB0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoYFxuU0VMRUNUIHNjb3JlIEZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXNcbldIRVJFIHN1Ym1pdHRlZCA9IDEgQU5EIHRvcGljSWQgPSAke3RvcGljSWR9IEFORCB1c2VySWQgPSAke3VzZXJJZH1cbk9SREVSIEJZIHNjb3JlIERFU0MgTElNSVQgNDtgLFxuICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4oZGF0YXMgPT4ge1xuICAgICAgY29uc3Qgc3RhcnMgPSBkYXRhcy5yZWR1Y2UoKGFjYywgZGF0YSkgPT4ge1xuICAgICAgICBpZiAocGFyc2VJbnQoZGF0YS5zY29yZSwgMTApID49IDgwKSB7XG4gICAgICAgICAgcmV0dXJuIGFjYyArIDFcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gYWNjXG4gICAgICAgIH1cbiAgICAgIH0sIDApXG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHsgc3RhcnMgfSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFJlbmRlcmVkU3RhckJhZGdlcyAodXNlcklkLCB0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U3RhckJhZGdlcyh1c2VySWQsIHRvcGljSWQpLnRoZW4ocmVzcCA9PiB7XG4gICAgICBpZiAocmVzcC5zdGF0dXMpIHtcbiAgICAgICAgY29uc3Qgc3RhcnMgPSByZXNwLmRhdGEuc3RhcnNcbiAgICAgICAgY29uc3QgaHRtbCA9IHB1Zy5yZW5kZXJGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAvdmlld3Mvbm9uLXBhZ2VzL3N0YXJzLnB1ZycpLCB7IHN0YXJzIH0pXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBodG1sLCBzdGFycyB9IH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2hlY2ttYXJrQmFkZ2UgKHVzZXJJZCwgdG9waWNJZCwgcmVuZGVyID0gZmFsc2UpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShgXG5TRUxFQ1Qgc2NvcmUgRlJPTSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlc1xuV0hFUkUgc3VibWl0dGVkID0gMSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHVzZXJJZCA9ICR7dXNlcklkfSBBTkQgc2NvcmUgPiA4MFxuT1JERVIgQlkgc2NvcmUgREVTQyBMSU1JVCAxO2AsXG4gICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihkYXRhcyA9PiB7XG4gICAgICBjb25zdCBpc0NoZWNrZWQgPSBkYXRhcy5sZW5ndGggPiAwXG4gICAgICBpZiAocmVuZGVyKSB7XG4gICAgICAgIGNvbnN0IGh0bWwgPSBwdWcucmVuZGVyRmlsZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vYXBwL3ZpZXdzL25vbi1wYWdlcy9jZWNrbWFyay5wdWcnKSwgeyBpc0NoZWNrZWQgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBodG1sIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogdHJ1ZSwgZGF0YTogeyBpc0NoZWNrZWQgfSB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFRpbWVyQmFkZ2VzICh1c2VySWQsIHRvcGljSWQpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZXF1ZWxpemUoKS5xdWVyeShgXG5TRUxFQ1Qgc2NvcmUgRlJPTSBnZW5lcmF0ZWRUb3BpY0V4ZXJjaXNlc1xuV0hFUkUgc3VibWl0dGVkID0gMSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHVzZXJJZCA9ICR7dXNlcklkfVxuQU5EIHRpbWVGaW5pc2ggPCBpZGVhbFRpbWUgQU5EIHNjb3JlID0gMTAwXG5PUkRFUiBCWSBzY29yZSBERVNDIExJTUlUIDE7YCxcbiAgICB7IHR5cGU6IFNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9KS50aGVuKGRhdGFzID0+IHtcbiAgICAgIGNvbnN0IHRpbWVycyA9IGRhdGFzLnJlZHVjZSgoYWNjLCBkYXRhKSA9PiB7XG4gICAgICAgIGlmIChwYXJzZUludChkYXRhLnNjb3JlLCAxMCkgPj0gODApIHtcbiAgICAgICAgICByZXR1cm4gYWNjICsgMVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBhY2NcbiAgICAgICAgfVxuICAgICAgfSwgMClcblxuICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IHRpbWVycyB9IH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0UmVuZGVyZWRUaW1lckJhZGdlcyAodXNlcklkLCB0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0VGltZXJCYWRnZXModXNlcklkLCB0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IHRpbWVycyA9IHJlc3AuZGF0YS50aW1lcnNcbiAgICAgICAgY29uc3QgaHRtbCA9IHB1Zy5yZW5kZXJGaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9hcHAvdmlld3Mvbm9uLXBhZ2VzL3RpbWVycy5wdWcnKSwgeyB0aW1lcnMgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBodG1sIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAocmVzcClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgICAvLyBHZXQgbGVhZGVyYm9hcmQgZGF0YVxuICBnZXRSYW5raW5nICh0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkoXG5gU0VMRUNUIE1JTih0aW1lRmluaXNoKSBBUyB0aW1lRmluaXNoLCB1c2VySWQsIHVzZXJzLmZ1bGxOYW1lIEFTIGZ1bGxOYW1lLCB1c2Vycy5ncmFkZSBBUyBncmFkZSwgc2Nob29scy5uYW1lIEFTIHNjaG9vbE5hbWVcbkZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMgSU5ORVIgSk9JTiB1c2VycyBPTiB1c2Vycy5pZCA9IGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzLnVzZXJJZCBJTk5FUiBKT0lOIHNjaG9vbHMgT04gc2Nob29scy5pZCA9IHVzZXJzLnNjaG9vbElkXG5XSEVSRSBzdWJtaXR0ZWQgPSBUUlVFIEFORCB0b3BpY0lkID0gJHt0b3BpY0lkfSBBTkQgc2NvcmUgPSAxMDAgQU5EIHRpbWVGaW5pc2ggSVMgTk9UIE5VTEwgR1JPVVAgQlkgdXNlcklkIE9SREVSIEJZIE1JTih0aW1lRmluaXNoKSBMSU1JVCAxMDtgLFxuICAgIHsgdHlwZTogU2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH0pLnRoZW4ocmVzcCA9PiB7XG4gICAgICByZXR1cm4geyBzdGF0dXM6IHRydWUsIGRhdGE6IHJlc3AgfVxuICAgIH0pXG4gIH1cblxuICBnZXRSZW5kZXJlZExlYWRlcmJvYXJkICh0b3BpY0lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmFua2luZyh0b3BpY0lkKS50aGVuKHJlc3AgPT4ge1xuICAgICAgaWYgKHJlc3Auc3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IGV4ZXJjaXNlRGF0YSA9IHJlc3AuZGF0YVxuICAgICAgICBjb25zdCBodG1sID0gcHVnLnJlbmRlckZpbGUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2FwcC92aWV3cy9ub24tcGFnZXMvcmFua2luZy5wdWcnKSwgeyBleGVyY2lzZURhdGEgfSlcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiB0cnVlLCBkYXRhOiBodG1sIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEdldCB0aGUgbnVtYmVyIG9mIHJhbmsgaW4gbGVhZGVyYm9hcmRcbiAgZ2V0Q3VycmVudFJhbmtpbmcgKHRpbWVGaW5pc2gsIHRvcGljSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgcXVlcnlEQiA9IGBTRUxFQ1QgQ09VTlQoKikgQVMgdG90YWxcbkZST00gKFNFTEVDVCBDT1VOVCgqKSBGUk9NIGdlbmVyYXRlZFRvcGljRXhlcmNpc2VzXG5XSEVSRSBzdWJtaXR0ZWQgPSBUUlVFIEFORCB0aW1lRmluaXNoIDwgJHt0aW1lRmluaXNofSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMXG5HUk9VUCBCWSB1c2VySWRcbk9SREVSIEJZIE1JTih0aW1lRmluaXNoKSkgQVMgdG90YWxyb3c7YFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnlEQixcbiAgICAgICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGNvdW50OiByZXNwWzBdLnRvdGFsIH0gfSlcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9KVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXQgdGhlIG51bWJlciBvZiBzdWJtaXNzaW9ucyBpbiB0aGUgbGVhZGVyYm9hcmRcbiAgZ2V0VG90YWxSYW5raW5nICh0b3BpY0lkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBxdWVyeURCID0gYFNFTEVDVCBDT1VOVCgqKSBBUyB0b3RhbFxuRlJPTSAoU0VMRUNUIENPVU5UKCopIEZST00gZ2VuZXJhdGVkVG9waWNFeGVyY2lzZXMgV0hFUkUgc3VibWl0dGVkID0gVFJVRSBBTkQgdG9waWNJZCA9ICR7dG9waWNJZH0gQU5EIHNjb3JlID0gMTAwIEFORCB0aW1lRmluaXNoIElTIE5PVCBOVUxMXG5HUk9VUCBCWSB1c2VySWRcbk9SREVSIEJZIE1JTih0aW1lRmluaXNoKSkgQVMgdG90YWxyb3c7YFxuICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VxdWVsaXplKCkucXVlcnkocXVlcnlEQixcbiAgICAgICAgeyB0eXBlOiBTZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXNvbHZlKHsgc3RhdHVzOiB0cnVlLCBkYXRhOiB7IGNvdW50OiByZXNwWzBdLnRvdGFsIH0gfSlcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9KVxuICAgIH0pXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbmV3IFRvcGljRXhlcmNpc2VTZXJ2aWNlKClcbiJdfQ==
