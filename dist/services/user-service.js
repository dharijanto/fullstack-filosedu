"use strict";const Sequelize=require("sequelize"),Promise=Sequelize.Promise,log=require("npmlog"),path=require("path"),Crypto=require(path.join(__dirname,"../lib/utils/crypto")),Formatter=require(path.join(__dirname,"../lib/formatter")),TAG="UserService";class UserService{constructor(e,s){this._sequelize=e,this._models=s,null==this._models.User&&log.error(TAG,"constructor(): models doesn't have UserAccount defined!")}login(e){const s=e.username,r=e.password,t=e.schoolId;return this._models.User.findOne({where:{username:s,schoolId:t}}).then(e=>{if(e){if("active"in e&&!e.active)return{status:!1,errMessage:"Account is not activated yet. Check your email to activate.",errCode:2,errData:{userId:e.id}};return Crypto.saltPass(r,e.salt)===e.saltedPass?{status:!0,user:e}:{status:!1,errMessage:"Invalid username or password.",errCode:1}}return{status:!1,errMessage:"Invalid username or password.",errCode:1}})}validateRegistrationCredential(e,s=!1,r=!1){const t=e.username,a=e.password,i=e.passwordConfirm,o=e.email,n=e.fullName,l=e.schoolId,d=e.grade;return log.verbose(TAG,"validateRegistrationCredential(): credential="+JSON.stringify(e)),new Promise((u,h)=>{const m=[],c={};if(Formatter.validateUsername(t)?c.username=t.toLowerCase():m.push("Username harus dimulai dengan huruf antara 5-16 karakter"),!s)if(a!==i)m.push("Password tidak sama!");else if(a.length<4)m.push("Password minimal 4 karakter!");else{const e=Crypto.genSaltedPass(a);c.saltedPass=e.passwordHash,c.salt=e.salt}o&&(Formatter.validateEmail(o)?c.email=o:m.push("Format email salah")),n?c.fullName=n:m.push("Nama lengkap harus diisi"),l?c.schoolId=l:m.push("Sekolah harus dipilih"),d?c.grade=d:m.push("Kelas harus dipilih");const p=r?{id:e.id}:Sequelize.and({username:t},{schoolId:l});return this._models.User.findOne({where:p}).then(e=>{r&&!e?m.push("Username tidak ditemukan"):!r&&e&&m.push("Username sudah terdaftar"),m.length?u({status:!1,errMessage:m.join(", ")}):u({status:!0,data:c})})})}register(e,s=!0){return this.validateRegistrationCredential(e,!1).then(e=>e.status?this._models.User.create(e.data).then(e=>({status:!0,user:e})):e)}getAll(){return this._models.User.findAll({include:[{model:this._models.School}]}).then(e=>({status:!0,data:e})).catch(e=>e)}deleteById(e){return this._models.User.destroy({where:{id:e}})}updateCredential(e){const s=!("password"in e&&e.password.length>0);return this.validateRegistrationCredential(e,s,!0).then(s=>s.status?this._models.User.update(s.data,{where:{id:e.id}}).then(e=>({status:!0,data:e})).catch(e=>{if(console.error(e),"SequelizeUniqueConstraintError"===e.name)resolve({status:!1,errMessage:e.message});else{if("SequelizeForeignKeyConstraintError"!==e.name)throw e;resolve({status:!1,errMessage:e.message})}}):s)}}module.exports=UserService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlcy91c2VyLXNlcnZpY2UuanMiXSwibmFtZXMiOlsiU2VxdWVsaXplIiwicmVxdWlyZSIsIlByb21pc2UiLCJsb2ciLCJwYXRoIiwiQ3J5cHRvIiwiam9pbiIsIl9fZGlybmFtZSIsIkZvcm1hdHRlciIsIlRBRyIsIlVzZXJTZXJ2aWNlIiwiW29iamVjdCBPYmplY3RdIiwic2VxdWVsaXplIiwibW9kZWxzIiwidGhpcyIsIl9zZXF1ZWxpemUiLCJfbW9kZWxzIiwiVXNlciIsImVycm9yIiwiY3JlZGVudGlhbCIsInVzZXJuYW1lIiwicGFzcyIsInBhc3N3b3JkIiwic2Nob29sSWQiLCJmaW5kT25lIiwid2hlcmUiLCJ0aGVuIiwidXNlciIsImFjdGl2ZSIsInN0YXR1cyIsImVyck1lc3NhZ2UiLCJlcnJDb2RlIiwiZXJyRGF0YSIsInVzZXJJZCIsImlkIiwic2FsdFBhc3MiLCJzYWx0Iiwic2FsdGVkUGFzcyIsImlzUGFzc3dvcmRPcHRpb25hbCIsImlzRXhpc3RpbmdVc2VyIiwicGFzc3dvcmRDb25maXJtIiwiZW1haWwiLCJmdWxsTmFtZSIsImdyYWRlIiwidmVyYm9zZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyTWVzc2FnZXMiLCJkYXRhIiwidmFsaWRhdGVVc2VybmFtZSIsInRvTG93ZXJDYXNlIiwicHVzaCIsImxlbmd0aCIsInNhbHRlZCIsImdlblNhbHRlZFBhc3MiLCJwYXNzd29yZEhhc2giLCJ2YWxpZGF0ZUVtYWlsIiwid2hlcmVDbGF1c2UiLCJhbmQiLCJ2YWxpZGF0ZVJlZ2lzdHJhdGlvbkNyZWRlbnRpYWwiLCJyZXNwIiwiY3JlYXRlIiwiZmluZEFsbCIsImluY2x1ZGUiLCJtb2RlbCIsIlNjaG9vbCIsInVzZXJzIiwiY2F0Y2giLCJlcnIiLCJkZXN0cm95IiwidXBkYXRlIiwiY29uc29sZSIsIm5hbWUiLCJtZXNzYWdlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6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S2pDLE9BQ0FmLEtBQUtFLFFBQVFDLEtBQUs4QyxPQUFPRCxFQUFLWixNQUFNeEIsS0FBS0MsS0FDdENFLFFBQVEsRUFBTUYsS0FBQUEsS0FHakJtQyxHQUtibkQsU0FDRSxPQUFPRyxLQUFLRSxRQUFRQyxLQUFLK0MsU0FBU0MsVUFBV0MsTUFBT3BELEtBQUtFLFFBQVFtRCxXQUFXekMsS0FBSzBDLEtBQ3RFdkMsUUFBUSxFQUFNcUIsS0FBTWtCLEtBQzVCQyxNQUFNQyxHQUNBLEdBSVgzRCxXQUFZdUIsR0FDVixPQUFPcEIsS0FBS0UsUUFBUUMsS0FBS3NELFNBQ3ZCOUMsT0FDRVMsR0FBQUEsS0FPTnZCLGlCQUFrQlEsR0FDaEIsTUFBTW1CLElBQXVCLGFBQWNuQixHQUFlQSxFQUFXRyxTQUFTZ0MsT0FBUyxHQUN2RixPQUFPeEMsS0FBSytDLCtCQUErQjFDLEVBQVltQixHQUFvQixHQUFNWixLQUFLb0MsR0FDaEZBLEVBQUtqQyxPQUNBZixLQUFLRSxRQUFRQyxLQUFLdUQsT0FBT1YsRUFBS1osTUFBT3pCLE9BQVFTLEdBQUlmLEVBQVdlLE1BQU1SLEtBQUtvQyxLQUNwRWpDLFFBQVEsRUFBTXFCLEtBQU1ZLEtBQzNCTyxNQUFNQyxJQUVQLEdBREFHLFFBQVF2RCxNQUFNb0QsR0FDRyxtQ0FBYkEsRUFBSUksS0FDTjNCLFNBQVNsQixRQUFRLEVBQU9DLFdBQVl3QyxFQUFJSyxjQUNuQyxDQUFBLEdBQWlCLHVDQUFiTCxFQUFJSSxLQUdiLE1BQU1KLEVBRk52QixTQUFTbEIsUUFBUSxFQUFPQyxXQUFZd0MsRUFBSUssYUFNckNiLElBTWZjLE9BQU9DLFFBQVVuRSIsImZpbGUiOiJzZXJ2aWNlcy91c2VyLXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuY29uc3QgU2VxdWVsaXplID0gcmVxdWlyZSgnc2VxdWVsaXplJylcbmNvbnN0IFByb21pc2UgPSBTZXF1ZWxpemUuUHJvbWlzZVxuY29uc3QgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmNvbnN0IENyeXB0byA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xpYi91dGlscy9jcnlwdG8nKSlcbmNvbnN0IEZvcm1hdHRlciA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xpYi9mb3JtYXR0ZXInKSlcblxuY29uc3QgVEFHID0gJ1VzZXJTZXJ2aWNlJ1xuLypcbiAgSW52YXJpYW50OlxuICAgIFRoaXMgY2xhc3MgYXNzdW1lcyB0aGF0IHRoZSBtb2RlbHMgcGFzc2VkIGhhcyB0YWJsZSBVc2VyIHRoYXQgaXNcbiAgICBmb3JtYXRlZCBqdXN0IGxpa2Ugb25lIHVuZGVyIHNpdGVzL3Jvb3QvZGItc3RydWN0dXJlLmpzXG4qL1xuY2xhc3MgVXNlclNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvciAoc2VxdWVsaXplLCBtb2RlbHMpIHtcbiAgICB0aGlzLl9zZXF1ZWxpemUgPSBzZXF1ZWxpemVcbiAgICB0aGlzLl9tb2RlbHMgPSBtb2RlbHNcbiAgICBpZiAodGhpcy5fbW9kZWxzLlVzZXIgPT0gbnVsbCkge1xuICAgICAgbG9nLmVycm9yKFRBRywgXCJjb25zdHJ1Y3RvcigpOiBtb2RlbHMgZG9lc24ndCBoYXZlIFVzZXJBY2NvdW50IGRlZmluZWQhXCIpXG4gICAgfVxuICB9XG5cbiAgbG9naW4gKGNyZWRlbnRpYWwpIHtcbiAgICBjb25zdCB1c2VybmFtZSA9IGNyZWRlbnRpYWwudXNlcm5hbWVcbiAgICBjb25zdCBwYXNzID0gY3JlZGVudGlhbC5wYXNzd29yZFxuICAgIGNvbnN0IHNjaG9vbElkID0gY3JlZGVudGlhbC5zY2hvb2xJZFxuXG4gICAgcmV0dXJuIHRoaXMuX21vZGVscy5Vc2VyLmZpbmRPbmUoe3doZXJlOiB7dXNlcm5hbWUsIHNjaG9vbElkfX0pLnRoZW4odXNlciA9PiB7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHtzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiAnSW52YWxpZCB1c2VybmFtZSBvciBwYXNzd29yZC4nLCBlcnJDb2RlOiAxfVxuICAgICAgfSBlbHNlIGlmICgoJ2FjdGl2ZScgaW4gdXNlcikgJiYgIXVzZXIuYWN0aXZlKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzOiBmYWxzZSxcbiAgICAgICAgICBlcnJNZXNzYWdlOiAnQWNjb3VudCBpcyBub3QgYWN0aXZhdGVkIHlldC4gQ2hlY2sgeW91ciBlbWFpbCB0byBhY3RpdmF0ZS4nLFxuICAgICAgICAgIGVyckNvZGU6IDIsXG4gICAgICAgICAgZXJyRGF0YToge1xuICAgICAgICAgICAgdXNlcklkOiB1c2VyLmlkXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzYWx0ZWRQYXNzID0gQ3J5cHRvLnNhbHRQYXNzKHBhc3MsIHVzZXIuc2FsdClcbiAgICAgICAgaWYgKHNhbHRlZFBhc3MgPT09IHVzZXIuc2FsdGVkUGFzcykge1xuICAgICAgICAgIHJldHVybiB7c3RhdHVzOiB0cnVlLCB1c2VyfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7c3RhdHVzOiBmYWxzZSwgZXJyTWVzc2FnZTogJ0ludmFsaWQgdXNlcm5hbWUgb3IgcGFzc3dvcmQuJywgZXJyQ29kZTogMX1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICB2YWxpZGF0ZVJlZ2lzdHJhdGlvbkNyZWRlbnRpYWwgKGNyZWRlbnRpYWwsIGlzUGFzc3dvcmRPcHRpb25hbCA9IGZhbHNlLCBpc0V4aXN0aW5nVXNlciA9IGZhbHNlKSB7XG4gICAgY29uc3QgdXNlcm5hbWUgPSBjcmVkZW50aWFsLnVzZXJuYW1lXG4gICAgY29uc3QgcGFzc3dvcmQgPSBjcmVkZW50aWFsLnBhc3N3b3JkXG4gICAgY29uc3QgcGFzc3dvcmRDb25maXJtID0gY3JlZGVudGlhbC5wYXNzd29yZENvbmZpcm1cbiAgICBjb25zdCBlbWFpbCA9IGNyZWRlbnRpYWwuZW1haWxcbiAgICBjb25zdCBmdWxsTmFtZSA9IGNyZWRlbnRpYWwuZnVsbE5hbWVcbiAgICBjb25zdCBzY2hvb2xJZCA9IGNyZWRlbnRpYWwuc2Nob29sSWRcbiAgICBjb25zdCBncmFkZSA9IGNyZWRlbnRpYWwuZ3JhZGVcblxuICAgIGxvZy52ZXJib3NlKFRBRywgJ3ZhbGlkYXRlUmVnaXN0cmF0aW9uQ3JlZGVudGlhbCgpOiBjcmVkZW50aWFsPScgKyBKU09OLnN0cmluZ2lmeShjcmVkZW50aWFsKSlcbiAgICAvLyBJZiBlaXRoZXIgcGFzc3dvcmQgb3IgY29uZmlybSBwYXNzd29yZCBpcyBlbnRlcmVkLCB0aGV5IGhhdmUgdG8gbWF0Y2ggaW4gb3JkZXJcbiAgICAvLyBmb3IgYW55dGhpbmcgdG8gYmUgdXBkYXRlZFxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBlcnJNZXNzYWdlcyA9IFtdXG4gICAgICBjb25zdCBkYXRhID0ge31cbiAgICAgIGlmICghRm9ybWF0dGVyLnZhbGlkYXRlVXNlcm5hbWUodXNlcm5hbWUpKSB7XG4gICAgICAgIGVyck1lc3NhZ2VzLnB1c2goJ1VzZXJuYW1lIGhhcnVzIGRpbXVsYWkgZGVuZ2FuIGh1cnVmIGFudGFyYSA1LTE2IGthcmFrdGVyJylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEudXNlcm5hbWUgPSB1c2VybmFtZS50b0xvd2VyQ2FzZSgpXG4gICAgICB9XG5cbiAgICAgIGlmICghaXNQYXNzd29yZE9wdGlvbmFsKSB7XG4gICAgICAgIGlmIChwYXNzd29yZCAhPT0gcGFzc3dvcmRDb25maXJtKSB7XG4gICAgICAgICAgZXJyTWVzc2FnZXMucHVzaCgnUGFzc3dvcmQgdGlkYWsgc2FtYSEnKVxuICAgICAgICB9IGVsc2UgaWYgKHBhc3N3b3JkLmxlbmd0aCA8IDQpIHtcbiAgICAgICAgICBlcnJNZXNzYWdlcy5wdXNoKCdQYXNzd29yZCBtaW5pbWFsIDQga2FyYWt0ZXIhJylcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBzYWx0ZWQgPSBDcnlwdG8uZ2VuU2FsdGVkUGFzcyhwYXNzd29yZClcbiAgICAgICAgICBkYXRhLnNhbHRlZFBhc3MgPSBzYWx0ZWQucGFzc3dvcmRIYXNoXG4gICAgICAgICAgZGF0YS5zYWx0ID0gc2FsdGVkLnNhbHRcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZW1haWwpIHtcbiAgICAgICAgaWYgKCFGb3JtYXR0ZXIudmFsaWRhdGVFbWFpbChlbWFpbCkpIHtcbiAgICAgICAgICBlcnJNZXNzYWdlcy5wdXNoKCdGb3JtYXQgZW1haWwgc2FsYWgnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRhdGEuZW1haWwgPSBlbWFpbFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICghZnVsbE5hbWUpIHtcbiAgICAgICAgZXJyTWVzc2FnZXMucHVzaCgnTmFtYSBsZW5na2FwIGhhcnVzIGRpaXNpJylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEuZnVsbE5hbWUgPSBmdWxsTmFtZVxuICAgICAgfVxuXG4gICAgICBpZiAoIXNjaG9vbElkKSB7XG4gICAgICAgIGVyck1lc3NhZ2VzLnB1c2goJ1Nla29sYWggaGFydXMgZGlwaWxpaCcpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkYXRhLnNjaG9vbElkID0gc2Nob29sSWRcbiAgICAgIH1cblxuICAgICAgaWYgKCFncmFkZSkge1xuICAgICAgICBlcnJNZXNzYWdlcy5wdXNoKCdLZWxhcyBoYXJ1cyBkaXBpbGloJylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEuZ3JhZGUgPSBncmFkZVxuICAgICAgfVxuXG4gICAgICBjb25zdCB3aGVyZUNsYXVzZSA9IGlzRXhpc3RpbmdVc2VyID8ge2lkOiBjcmVkZW50aWFsLmlkfSA6IFNlcXVlbGl6ZS5hbmQoe3VzZXJuYW1lfSwge3NjaG9vbElkfSlcbiAgICAgIHJldHVybiB0aGlzLl9tb2RlbHMuVXNlci5maW5kT25lKHt3aGVyZTogd2hlcmVDbGF1c2V9KS50aGVuKHVzZXIgPT4ge1xuICAgICAgICBpZiAoaXNFeGlzdGluZ1VzZXIgJiYgIXVzZXIpIHtcbiAgICAgICAgICBlcnJNZXNzYWdlcy5wdXNoKCdVc2VybmFtZSB0aWRhayBkaXRlbXVrYW4nKVxuICAgICAgICB9IGVsc2UgaWYgKCFpc0V4aXN0aW5nVXNlciAmJiB1c2VyKXtcbiAgICAgICAgICBlcnJNZXNzYWdlcy5wdXNoKCdVc2VybmFtZSBzdWRhaCB0ZXJkYWZ0YXInKVxuICAgICAgICB9XG4gICAgICAgIGlmIChlcnJNZXNzYWdlcy5sZW5ndGgpIHtcbiAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBlcnJNZXNzYWdlcy5qb2luKCcsICcpfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6IHRydWUsIGRhdGF9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICByZWdpc3RlciAoY3JlZGVudGlhbCwgYWN0aXZlID0gdHJ1ZSkge1xuICAgIHJldHVybiB0aGlzLnZhbGlkYXRlUmVnaXN0cmF0aW9uQ3JlZGVudGlhbChjcmVkZW50aWFsLCBmYWxzZSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxzLlVzZXIuY3JlYXRlKHJlc3AuZGF0YSkudGhlbih1c2VyID0+IHtcbiAgICAgICAgICByZXR1cm4ge3N0YXR1czogdHJ1ZSwgdXNlcn1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldEFsbCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vZGVscy5Vc2VyLmZpbmRBbGwoe2luY2x1ZGU6IFt7bW9kZWw6IHRoaXMuX21vZGVscy5TY2hvb2x9XX0pLnRoZW4odXNlcnMgPT4ge1xuICAgICAgcmV0dXJuICh7c3RhdHVzOiB0cnVlLCBkYXRhOiB1c2Vyc30pXG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIHJldHVybiAoZXJyKVxuICAgIH0pXG4gIH1cblxuICBkZWxldGVCeUlkIChpZCkge1xuICAgIHJldHVybiB0aGlzLl9tb2RlbHMuVXNlci5kZXN0cm95KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIGlkXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIFRPRE86IFdlIHNob3VsZG4ndCBhbGxvdyBlZGl0IHNvIHRoYXQgdGhlIHVzZXJcbiAgLy8gaGF2ZSB0aGUgc2FtZSB1c2VybmFtZSBhbmQgc2Nob29sSWQgYXMgYW4gZXhpc3RpbmcgdXNlci4gU2hvdWxkIHVzZSBTUUwgY29tcG9zaXRlIGtleVxuICB1cGRhdGVDcmVkZW50aWFsIChjcmVkZW50aWFsKSB7XG4gICAgY29uc3QgaXNQYXNzd29yZE9wdGlvbmFsID0gISgncGFzc3dvcmQnIGluIGNyZWRlbnRpYWwgJiYgKGNyZWRlbnRpYWwucGFzc3dvcmQubGVuZ3RoID4gMCkpXG4gICAgcmV0dXJuIHRoaXMudmFsaWRhdGVSZWdpc3RyYXRpb25DcmVkZW50aWFsKGNyZWRlbnRpYWwsIGlzUGFzc3dvcmRPcHRpb25hbCwgdHJ1ZSkudGhlbihyZXNwID0+IHtcbiAgICAgIGlmIChyZXNwLnN0YXR1cykge1xuICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxzLlVzZXIudXBkYXRlKHJlc3AuZGF0YSwge3doZXJlOiB7aWQ6IGNyZWRlbnRpYWwuaWR9fSkudGhlbihyZXNwID0+IHtcbiAgICAgICAgICByZXR1cm4ge3N0YXR1czogdHJ1ZSwgZGF0YTogcmVzcH1cbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdTZXF1ZWxpemVVbmlxdWVDb25zdHJhaW50RXJyb3InKSB7XG4gICAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBlcnIubWVzc2FnZX0pXG4gICAgICAgICAgfSBlbHNlIGlmIChlcnIubmFtZSA9PT0gJ1NlcXVlbGl6ZUZvcmVpZ25LZXlDb25zdHJhaW50RXJyb3InKSB7XG4gICAgICAgICAgICByZXNvbHZlKHtzdGF0dXM6IGZhbHNlLCBlcnJNZXNzYWdlOiBlcnIubWVzc2FnZX0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IGVyclxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNwXG4gICAgICB9XG4gICAgfSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFVzZXJTZXJ2aWNlXG4iXX0=
