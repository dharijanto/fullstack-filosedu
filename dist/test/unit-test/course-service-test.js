var path=require("path"),_=require("lodash"),chai=require("chai"),expect=chai.expect,log=require("npmlog");log.level="verbose";var Sequelize=require("sequelize"),Promise=require("bluebird"),AppConfig=require(path.join(__dirname,"../../app-config")),createSequelizeModel=require(path.join(__dirname,"../../db-structure")),CourseService=require(path.join(__dirname,"../../services/course-service"));describe("Course Service",function(){var e,t,a={};function o(e){return t.create({modelName:"Subject",data:{id:`${e}`,subject:`Test Subject ${e}`,description:`Test Description ${e}`}})}beforeEach(function(o){this.timeout(1e4),e=new Sequelize(AppConfig.testDbPath,{logging:!1}),a=createSequelizeModel(e,a),e.sync({force:!0}).then(()=>{t=new CourseService(e,a),o()})}),afterEach(function(){e.close().catch(e=>{console.error(e)})}),it("create() should work",function(e){o(1).then(e=>{expect(e.status).to.be.ok,expect(e.data.id).to.exist,expect(e.data.subject).to.equal("Test Subject 1"),expect(e.data.description).to.equal("Test Description 1")}),e()}),it("parallel create() should work",function(e){Promise.join(o(1),o(2),o(3),o(4)).then(t=>{t.forEach((e,t)=>{expect(e.status).to.be.ok,expect(e.data.id).to.exist,expect(e.data.subject).to.equal(`Test Subject ${t+1}`),expect(e.data.description).to.equal(`Test Description ${t+1}`)}),e()})}),it("read() should work",function(e){o(1).then(a=>{const o=[{id:a.data.id},{subject:a.data.subject},{description:a.data.description}];Promise.map(o,e=>t.read({modelName:"Subject",searchClause:e})).then(t=>{expect(t.length).to.equal(o.length),t.forEach(e=>{expect(e.status).to.be.ok,expect(e.data).to.exist,expect(e.data).to.have.length(1);const t=e.data[0];expect(t.id).to.equal(a.data.id),expect(t.subject).to.equal(a.data.subject),expect(t.description).to.equal(a.data.description)}),e()})})}),it("parallel read() should work",function(e){const a=[1,2,3,4];Promise.map(a,e=>o(e)).then(o=>{expect(o).to.have.length(a.length),Promise.map(a,e=>t.read({modelName:"Subject",searchClause:{subject:`Test Subject ${e}`}})).then(t=>{t.forEach((e,t)=>{expect(e.status).to.be.ok,expect(e.data).to.have.length(1),expect(e.data[0].subject).to.equal(`Test Subject ${t+1}`)}),e()})})}),it("update() should work",function(e){o(1).then(a=>{const o=a.data;t.update({modelName:"Subject",data:{id:o.id,subject:"Updated Subject",description:"Updated Description"}}).then(o=>{expect(o.status).to.be.ok,t.read({modelName:"Subject",searchClause:{id:a.data.id}}).then(t=>{expect(t.status).to.be.ok,expect(t.data[0].subject).to.equal("Updated Subject"),expect(t.data[0].description).to.equal("Updated Description"),e()})})})}),it("parallel update() should work",function(e){const a=[1,2,3,4];Promise.map(a,e=>o(e)).then(o=>{expect(o).to.have.length(a.length),Promise.map(a,e=>(function(e){return t.update({modelName:"Subject",data:{id:`${e}`,subject:`Updated Subject ${e}`,description:`Updated Description ${e}`}})})(e)).then(o=>{expect(o).to.have.length(a.length),a.map(e=>{t.read({modelName:"Subject",searchClause:{id:e}}).then(t=>{expect(t.status).to.be.ok,expect(t.data[0].subject).to.equal(`Updated Subject ${e}`),expect(t.data[0].description).to.equal(`Updated Description ${e}`)})}),e()})})}),it("delete() should work",function(e){o(1).then(a=>{const o=a.data;t.delete({modelName:"Subject",data:{id:o.id}}).then(a=>{expect(a.status).to.be.ok,t.read({modelName:"Subject",searchClause:{id:1}}).then(t=>{expect(t.status).to.be.false,e()})})})}),it("parallel delete() should work",function(e){const a=[1,2,3,4];Promise.map(a,e=>o(e)).then(o=>{expect(o).to.have.length(a.length),Promise.map(a,e=>t.delete({modelName:"Subject",data:{id:e}})).then(o=>{o.forEach(e=>{expect(e.status).to.be.ok}),a.map(e=>{t.read({modelName:"Subject",searchClause:{id:e}}).then(e=>{expect(e.status).to.be.false})}),e()})})})});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90ZXN0L3VuaXQtdGVzdC9jb3Vyc2Utc2VydmljZS10ZXN0LmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwiXyIsImNoYWkiLCJleHBlY3QiLCJsb2ciLCJsZXZlbCIsIlNlcXVlbGl6ZSIsIlByb21pc2UiLCJBcHBDb25maWciLCJqb2luIiwiX19kaXJuYW1lIiwiY3JlYXRlU2VxdWVsaXplTW9kZWwiLCJDb3Vyc2VTZXJ2aWNlIiwiZGVzY3JpYmUiLCJzZXF1ZWxpemUiLCJjb3Vyc2VTZXJ2aWNlIiwibW9kZWxzIiwiY3JlYXRlIiwiaWQiLCJtb2RlbE5hbWUiLCJkYXRhIiwic3ViamVjdCIsImRlc2NyaXB0aW9uIiwiYmVmb3JlRWFjaCIsImRvbmUiLCJ0aGlzIiwidGltZW91dCIsInRlc3REYlBhdGgiLCJsb2dnaW5nIiwic3luYyIsImZvcmNlIiwidGhlbiIsImFmdGVyRWFjaCIsImNsb3NlIiwiY2F0Y2giLCJlcnIiLCJjb25zb2xlIiwiZXJyb3IiLCJpdCIsInJlc3AiLCJzdGF0dXMiLCJ0byIsImJlIiwib2siLCJleGlzdCIsImVxdWFsIiwicmVzdWx0cyIsImZvckVhY2giLCJpbmRleCIsInNlYXJjaENsYXVzZXMiLCJtYXAiLCJzZWFyY2hDbGF1c2UiLCJyZWFkIiwicmVzcDIiLCJsZW5ndGgiLCJyZXNwMyIsImhhdmUiLCJpZHMiLCJyZXN1bHQiLCJ1cGRhdGUiLCJkZWxldGUiLCJmYWxzZSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSUEsS0FBT0MsUUFBUSxRQUVmQyxFQUFJRCxRQUFRLFVBQ1pFLEtBQU9GLFFBQVEsUUFDZkcsT0FBU0QsS0FBS0MsT0FDZEMsSUFBTUosUUFBUSxVQUNsQkksSUFBSUMsTUFBUSxVQUNaLElBQUlDLFVBQVlOLFFBQVEsYUFDcEJPLFFBQVVQLFFBQVEsWUFFbEJRLFVBQVlSLFFBQVFELEtBQUtVLEtBQUtDLFVBQVcscUJBQ3pDQyxxQkFBdUJYLFFBQVFELEtBQUtVLEtBQUtDLFVBQVcsdUJB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QU1qQyxVQUFXLFVBQVdnQyxjQUFlakMsR0FBQUEsS0FBTWEsS0FBS3dCLElBQ2xFcEQsT0FBT29ELEVBQU1mLFFBQVFDLEdBQUdDLEdBQUdtQixVQUcvQnJDIiwiZmlsZSI6InRlc3QvdW5pdC10ZXN0L2NvdXJzZS1zZXJ2aWNlLXRlc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG52YXIgY2hhaSA9IHJlcXVpcmUoJ2NoYWknKVxudmFyIGV4cGVjdCA9IGNoYWkuZXhwZWN0XG52YXIgbG9nID0gcmVxdWlyZSgnbnBtbG9nJylcbmxvZy5sZXZlbCA9ICd2ZXJib3NlJ1xudmFyIFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpXG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJylcblxudmFyIEFwcENvbmZpZyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2FwcC1jb25maWcnKSlcbnZhciBjcmVhdGVTZXF1ZWxpemVNb2RlbCA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2RiLXN0cnVjdHVyZScpKVxudmFyIENvdXJzZVNlcnZpY2UgPSByZXF1aXJlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zZXJ2aWNlcy9jb3Vyc2Utc2VydmljZScpKVxuXG5kZXNjcmliZSgnQ291cnNlIFNlcnZpY2UnLCBmdW5jdGlvbiAoKSB7XG4gIHZhciBzZXF1ZWxpemVcbiAgdmFyIG1vZGVscyA9IHt9XG4gIHZhciBjb3Vyc2VTZXJ2aWNlXG5cbiAgYmVmb3JlRWFjaChmdW5jdGlvbiAoZG9uZSkge1xuICAgIHRoaXMudGltZW91dCgxMDAwMClcbiAgICAvLyBjb25zb2xlLmxvZygnQmVnaW4gaW5pdGlhbGl6YXRpb24uLi4uJylcbiAgICBzZXF1ZWxpemUgPSBuZXcgU2VxdWVsaXplKEFwcENvbmZpZy50ZXN0RGJQYXRoLCB7bG9nZ2luZzogZmFsc2V9KVxuICAgIG1vZGVscyA9IGNyZWF0ZVNlcXVlbGl6ZU1vZGVsKHNlcXVlbGl6ZSwgbW9kZWxzKVxuICAgIHNlcXVlbGl6ZS5zeW5jKHtmb3JjZTogdHJ1ZX0pLnRoZW4oKCkgPT4ge1xuICAgICAgY291cnNlU2VydmljZSA9IG5ldyBDb3Vyc2VTZXJ2aWNlKHNlcXVlbGl6ZSwgbW9kZWxzKVxuICAgICAgLy8gY29uc29sZS5sb2coJ0NvbXBsZXRlZCBpbml0aWFsaXphdGlvbiEnKVxuICAgICAgZG9uZSgpXG4gICAgfSlcbiAgfSlcblxuICBhZnRlckVhY2goZnVuY3Rpb24gKCkge1xuICAgIHNlcXVlbGl6ZS5jbG9zZSgpLmNhdGNoKGVyciA9PiB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICB9KVxuICB9KVxuXG4gIGZ1bmN0aW9uIGNyZWF0ZSAoaWQpIHtcbiAgICByZXR1cm4gY291cnNlU2VydmljZS5jcmVhdGUoe1xuICAgICAgbW9kZWxOYW1lOiAnU3ViamVjdCcsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGlkOiBgJHtpZH1gLFxuICAgICAgICBzdWJqZWN0OiBgVGVzdCBTdWJqZWN0ICR7aWR9YCxcbiAgICAgICAgZGVzY3JpcHRpb246IGBUZXN0IERlc2NyaXB0aW9uICR7aWR9YFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGUgKGlkKSB7XG4gICAgcmV0dXJuIGNvdXJzZVNlcnZpY2UudXBkYXRlKHtcbiAgICAgIG1vZGVsTmFtZTogJ1N1YmplY3QnLFxuICAgICAgZGF0YToge1xuICAgICAgICBpZDogYCR7aWR9YCxcbiAgICAgICAgc3ViamVjdDogYFVwZGF0ZWQgU3ViamVjdCAke2lkfWAsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgVXBkYXRlZCBEZXNjcmlwdGlvbiAke2lkfWBcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgaXQoJ2NyZWF0ZSgpIHNob3VsZCB3b3JrJywgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICBjcmVhdGUoMSkudGhlbihyZXNwID0+IHtcbiAgICAgIGV4cGVjdChyZXNwLnN0YXR1cykudG8uYmUub2tcbiAgICAgIGV4cGVjdChyZXNwLmRhdGEuaWQpLnRvLmV4aXN0XG4gICAgICBleHBlY3QocmVzcC5kYXRhLnN1YmplY3QpLnRvLmVxdWFsKCdUZXN0IFN1YmplY3QgMScpXG4gICAgICBleHBlY3QocmVzcC5kYXRhLmRlc2NyaXB0aW9uKS50by5lcXVhbCgnVGVzdCBEZXNjcmlwdGlvbiAxJylcbiAgICB9KVxuICAgIGRvbmUoKVxuICB9KVxuXG4gIGl0ICgncGFyYWxsZWwgY3JlYXRlKCkgc2hvdWxkIHdvcmsnLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgIFByb21pc2Uuam9pbihcbiAgICAgIGNyZWF0ZSgxKSxcbiAgICAgIGNyZWF0ZSgyKSxcbiAgICAgIGNyZWF0ZSgzKSxcbiAgICAgIGNyZWF0ZSg0KSkudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXNwLCBpbmRleCkgPT4ge1xuICAgICAgICAgIGV4cGVjdChyZXNwLnN0YXR1cykudG8uYmUub2tcbiAgICAgICAgICBleHBlY3QocmVzcC5kYXRhLmlkKS50by5leGlzdFxuICAgICAgICAgIGV4cGVjdChyZXNwLmRhdGEuc3ViamVjdCkudG8uZXF1YWwoYFRlc3QgU3ViamVjdCAke2luZGV4ICsgMX1gKVxuICAgICAgICAgIGV4cGVjdChyZXNwLmRhdGEuZGVzY3JpcHRpb24pLnRvLmVxdWFsKGBUZXN0IERlc2NyaXB0aW9uICR7aW5kZXggKyAxfWApXG4gICAgICAgIH0pXG4gICAgICAgIGRvbmUoKVxuICAgICAgfSlcbiAgfSlcblxuICBpdCgncmVhZCgpIHNob3VsZCB3b3JrJywgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICBjcmVhdGUoMSkudGhlbihyZXNwID0+IHtcbiAgICAgIC8vIFNlYXJjaGluZyBieSBhbnkgb2YgdGhpcyBjbGF1c2Ugc2hvdWxkIGJlIHN1Y2Nlc3NmdWxcbiAgICAgIGNvbnN0IHNlYXJjaENsYXVzZXMgPSBbXG4gICAgICAgIHtpZDogcmVzcC5kYXRhLmlkfSxcbiAgICAgICAge3N1YmplY3Q6IHJlc3AuZGF0YS5zdWJqZWN0fSxcbiAgICAgICAge2Rlc2NyaXB0aW9uOiByZXNwLmRhdGEuZGVzY3JpcHRpb259XG4gICAgICBdXG4gICAgICBQcm9taXNlLm1hcChzZWFyY2hDbGF1c2VzLCBzZWFyY2hDbGF1c2UgPT4ge1xuICAgICAgICByZXR1cm4gY291cnNlU2VydmljZS5yZWFkKHttb2RlbE5hbWU6ICdTdWJqZWN0Jywgc2VhcmNoQ2xhdXNlfSlcbiAgICAgIH0pLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICBleHBlY3QocmVzcDIubGVuZ3RoKS50by5lcXVhbChzZWFyY2hDbGF1c2VzLmxlbmd0aClcbiAgICAgICAgcmVzcDIuZm9yRWFjaChyZXNwMyA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3AzLnN0YXR1cykudG8uYmUub2tcbiAgICAgICAgICBleHBlY3QocmVzcDMuZGF0YSkudG8uZXhpc3RcbiAgICAgICAgICBleHBlY3QocmVzcDMuZGF0YSkudG8uaGF2ZS5sZW5ndGgoMSlcbiAgICAgICAgICBjb25zdCBkYXRhID0gcmVzcDMuZGF0YVswXVxuICAgICAgICAgIGV4cGVjdChkYXRhLmlkKS50by5lcXVhbChyZXNwLmRhdGEuaWQpXG4gICAgICAgICAgZXhwZWN0KGRhdGEuc3ViamVjdCkudG8uZXF1YWwocmVzcC5kYXRhLnN1YmplY3QpXG4gICAgICAgICAgZXhwZWN0KGRhdGEuZGVzY3JpcHRpb24pLnRvLmVxdWFsKHJlc3AuZGF0YS5kZXNjcmlwdGlvbilcbiAgICAgICAgfSlcbiAgICAgICAgZG9uZSgpXG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG5cbiAgaXQoJ3BhcmFsbGVsIHJlYWQoKSBzaG91bGQgd29yaycsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgY29uc3QgaWRzID0gWzEsIDIsIDMsIDRdXG4gICAgUHJvbWlzZS5tYXAoaWRzLCBpZCA9PiBjcmVhdGUoaWQpKS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgZXhwZWN0KHJlc3VsdHMpLnRvLmhhdmUubGVuZ3RoKGlkcy5sZW5ndGgpXG4gICAgICBQcm9taXNlLm1hcChpZHMsIGlkID0+IHtcbiAgICAgICAgcmV0dXJuIGNvdXJzZVNlcnZpY2UucmVhZCh7bW9kZWxOYW1lOiAnU3ViamVjdCcsIHNlYXJjaENsYXVzZToge3N1YmplY3Q6IGBUZXN0IFN1YmplY3QgJHtpZH1gfX0pXG4gICAgICB9KS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICByZXN1bHRzLmZvckVhY2goKHJlc3VsdCwgaW5kZXgpID0+IHtcbiAgICAgICAgICBleHBlY3QocmVzdWx0LnN0YXR1cykudG8uYmUub2tcbiAgICAgICAgICBleHBlY3QocmVzdWx0LmRhdGEpLnRvLmhhdmUubGVuZ3RoKDEpXG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhWzBdLnN1YmplY3QpLnRvLmVxdWFsKGBUZXN0IFN1YmplY3QgJHtpbmRleCArIDF9YClcbiAgICAgICAgfSlcbiAgICAgICAgZG9uZSgpXG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG5cbiAgaXQoJ3VwZGF0ZSgpIHNob3VsZCB3b3JrJywgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICBjcmVhdGUoMSkudGhlbihyZXNwID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSByZXNwLmRhdGFcbiAgICAgIGNvdXJzZVNlcnZpY2UudXBkYXRlKHttb2RlbE5hbWU6ICdTdWJqZWN0JyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIGlkOiBkYXRhLmlkLFxuICAgICAgICAgIHN1YmplY3Q6ICdVcGRhdGVkIFN1YmplY3QnLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVXBkYXRlZCBEZXNjcmlwdGlvbid9XG4gICAgICB9KS50aGVuKHJlc3AyID0+IHtcbiAgICAgICAgZXhwZWN0KHJlc3AyLnN0YXR1cykudG8uYmUub2tcbiAgICAgICAgY291cnNlU2VydmljZS5yZWFkKHttb2RlbE5hbWU6ICdTdWJqZWN0Jywgc2VhcmNoQ2xhdXNlOiB7aWQ6IHJlc3AuZGF0YS5pZH19KS50aGVuKHJlc3AzID0+IHtcbiAgICAgICAgICBleHBlY3QocmVzcDMuc3RhdHVzKS50by5iZS5va1xuICAgICAgICAgIGV4cGVjdChyZXNwMy5kYXRhWzBdLnN1YmplY3QpLnRvLmVxdWFsKCdVcGRhdGVkIFN1YmplY3QnKVxuICAgICAgICAgIGV4cGVjdChyZXNwMy5kYXRhWzBdLmRlc2NyaXB0aW9uKS50by5lcXVhbCgnVXBkYXRlZCBEZXNjcmlwdGlvbicpXG4gICAgICAgICAgZG9uZSgpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG5cbiAgaXQgKCdwYXJhbGxlbCB1cGRhdGUoKSBzaG91bGQgd29yaycsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgY29uc3QgaWRzID0gWzEsIDIsIDMsIDRdXG4gICAgUHJvbWlzZS5tYXAoaWRzLCBpZCA9PiBjcmVhdGUoaWQpKS50aGVuKHJlc3AgPT4ge1xuICAgICAgZXhwZWN0KHJlc3ApLnRvLmhhdmUubGVuZ3RoKGlkcy5sZW5ndGgpXG4gICAgICBQcm9taXNlLm1hcChpZHMsIGlkID0+IHVwZGF0ZShpZCkpLnRoZW4ocmVzcDIgPT4ge1xuICAgICAgICBleHBlY3QocmVzcDIpLnRvLmhhdmUubGVuZ3RoKGlkcy5sZW5ndGgpXG4gICAgICAgIGlkcy5tYXAoaWQgPT4ge1xuICAgICAgICAgIGNvdXJzZVNlcnZpY2UucmVhZCh7bW9kZWxOYW1lOiAnU3ViamVjdCcsIHNlYXJjaENsYXVzZToge2lkfX0pLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHJlc3AzLnN0YXR1cykudG8uYmUub2tcbiAgICAgICAgICAgIGV4cGVjdChyZXNwMy5kYXRhWzBdLnN1YmplY3QpLnRvLmVxdWFsKGBVcGRhdGVkIFN1YmplY3QgJHtpZH1gKVxuICAgICAgICAgICAgZXhwZWN0KHJlc3AzLmRhdGFbMF0uZGVzY3JpcHRpb24pLnRvLmVxdWFsKGBVcGRhdGVkIERlc2NyaXB0aW9uICR7aWR9YClcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgICBkb25lKClcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcblxuICBpdCgnZGVsZXRlKCkgc2hvdWxkIHdvcmsnLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgIGNyZWF0ZSgxKS50aGVuKHJlc3AgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IHJlc3AuZGF0YVxuICAgICAgY291cnNlU2VydmljZS5kZWxldGUoe21vZGVsTmFtZTogJ1N1YmplY3QnLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgaWQ6IGRhdGEuaWRcbiAgICAgICAgfVxuICAgICAgfSkudGhlbihyZXNwMiA9PiB7XG4gICAgICAgIGV4cGVjdChyZXNwMi5zdGF0dXMpLnRvLmJlLm9rXG4gICAgICAgIGNvdXJzZVNlcnZpY2UucmVhZCh7bW9kZWxOYW1lOiAnU3ViamVjdCcsIHNlYXJjaENsYXVzZToge2lkOiAxfX0pLnRoZW4ocmVzcDMgPT4ge1xuICAgICAgICAgIC8vIEZhbHNlIG1lYW4gdGhlIGRhdGEgaGFzIGJlZW4gZGVsZXRlZC5cbiAgICAgICAgICBleHBlY3QocmVzcDMuc3RhdHVzKS50by5iZS5mYWxzZVxuICAgICAgICAgIGRvbmUoKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KVxuICB9KVxuXG4gIGl0ICgncGFyYWxsZWwgZGVsZXRlKCkgc2hvdWxkIHdvcmsnLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgIGNvbnN0IGlkcyA9IFsxLCAyLCAzLCA0XVxuICAgIFByb21pc2UubWFwKGlkcywgaWQgPT4gY3JlYXRlKGlkKSkudGhlbihyZXNwID0+IHtcbiAgICAgIGV4cGVjdChyZXNwKS50by5oYXZlLmxlbmd0aChpZHMubGVuZ3RoKVxuICAgICAgUHJvbWlzZS5tYXAoaWRzLCBpZCA9PiB7XG4gICAgICAgIHJldHVybiBjb3Vyc2VTZXJ2aWNlLmRlbGV0ZSh7bW9kZWxOYW1lOiAnU3ViamVjdCcsIGRhdGE6IHtpZH19KVxuICAgICAgfSkudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgcmVzdWx0cy5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXMpLnRvLmJlLm9rXG4gICAgICAgIH0pXG5cbiAgICAgICAgaWRzLm1hcChpZCA9PiB7XG4gICAgICAgICAgY291cnNlU2VydmljZS5yZWFkKHttb2RlbE5hbWU6ICdTdWJqZWN0Jywgc2VhcmNoQ2xhdXNlOiB7aWR9fSkudGhlbihyZXNwMyA9PiB7XG4gICAgICAgICAgICBleHBlY3QocmVzcDMuc3RhdHVzKS50by5iZS5mYWxzZVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICAgIGRvbmUoKVxuICAgICAgfSlcbiAgICB9KVxuICB9KVxufSlcbiJdfQ==
