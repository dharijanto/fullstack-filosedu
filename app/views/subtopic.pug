extends layout/index.pug
append head
  link(href='/assets/vendor/video.js/css/video-js.min.css' rel="stylesheet")
  link(href='/assets/vendor/video.js/css/videojs.endcapCTA.css' rel="stylesheet")

include includes/utils.pug

block contents
  div.container
    h1.text-center #{topic.topic} - #{subtopic.subtopic}
    h4.text-center #{subtopic.description}
    h4.text-center
      a(href='/') Back to Modules
    hr
    p !{subtopicData.detail}
    //- #ytPlayerContainer
    //- video.video-js.vjs-fluid#video-player(controls)
      //- source(src=videoSource)
    | !{videoSource}
    div.text-center(style="margin-top:50px;margin-bottom:50px;")
      each exercise, index in exercises
        - var exerciseUrl = `/${topic.id}/${getSlug(topic.topic)}/${subtopic.id}/${getSlug(subtopic.subtopic)}/${exercise.id}/latihan-${index+1}`
        // There's no elegant way of having a button with href. If we use a however, it can't be disabled easily
        // TODO: Use 'a' with css to disable
        if (!isAuthenticated)
          input.btn.btn-primary(type="button" value=`Latihan ${index+1}` href=exerciseUrl style="margin-top:10px;" disabled="disabled")
        else
          a.btn.btn-primary(type="button" href=exerciseUrl style="margin-top:10px;")= `Latihan ${index+1}`
          + renderExerciseStars(exercise.stars)
        br
      if !isAuthenticated
        br
        | Please #[a(href='/login') login] or #[a(href='/register') register] to access exercises.

block footer
  script(src="/assets/vendor/video.js/js/video.min.js")
  script(src="/assets/vendor/videojs-youtube/Youtube.min.js")
  script(src="/assets/vendor/video.js/js/videojs.endcapCTA.js")
  script.
    $(document).ready(function() {

      var video = videojs('#video-player')
      video.on('pause', function() {
      })

      // Add Feedback After Video Ends
      // TODO: Change width and height to use @media in CSS
      video.endcapCTA({
        html:`<section class="endcapCallToActionContent" style="top:33%; left:35%; position: absolute;"><button id="cta_good"><img src="/assets/img/good_smiley.jpg" width="100" height="100"/></button><button id="cta_bad"><img src="/assets/img/bad_smiley.jpg" width="100" height="100"/></button></section>`,
        run: function() {
          // This runs upon creation of endcapCTA, just after video starts playing

          // Avoid the callback from getting hook multiple time
          $('#cta_good').off('click')
          $('#cta_bad').off('click')

          var videoId = $('#video-player').data('id')
          $('#cta_good').on('click', function(e) {
            submitFeedback(true, videoId)
            $(this).parent().parent().removeClass('is-active')
          })
          $('#cta_bad').on('click', function(e) {
            submitFeedback(false, videoId)
            $(this).parent().parent().removeClass('is-active')
          })
        }
      })

      function submitFeedback(positive, videoId) {
        $.ajax({
          method: 'POST',
          url: '/video/feedback',
          data: {
            videoId,
            value: positive ? 1 : 0
          }
        }).done(function(data) {
          if (!data.status) {
            console.error(JSON.stringify(data))
          }
        }).fail(function (jqXHR, textStatus) {
          console.error(textStatus)
        })
      }
    })
